<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>å¾®æœåŠ¡æ¶æ„ä¸­æ•´åˆç½‘å…³ã€æƒé™æœåŠ¡ | Aoho&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="å‰è¨€ï¼šä¹‹å‰çš„æ–‡ç« æœ‰è®²è¿‡å¾®æœåŠ¡çš„æƒé™ç³»åˆ—å’Œç½‘å…³å®ç°ï¼Œéƒ½æ˜¯å­¤ç«‹å­˜åœ¨ï¼Œæœ¬æ–‡å°†æ•´åˆåç«¯æœåŠ¡ä¸ç½‘å…³ã€æƒé™ç³»ç»Ÿã€‚å®‰å…¨æƒé™éƒ¨åˆ†çš„å®ç°è¿˜è®²è§£äº†åŸºäºå‰ç½®éªŒè¯çš„æ–¹å¼å®ç°ï¼Œä½†æ˜¯ç”±äºä¸ä¸šåŠ¡è”ç³»æ¯”è¾ƒç´§å¯†ï¼Œæ²¡æœ‰å…·ä½“çš„ç¤ºä¾‹ã€‚ä¸šåŠ¡æƒé™ä¸ä¸šåŠ¡è”ç³»éå¸¸å¯†åˆ‡ï¼Œæœ¬æ¬¡çš„æ•´åˆé¡¹ç›®å°†ä¼šæŠŠè¿™éƒ¨åˆ†çš„æ“ä½œæƒé™æ ¡éªŒå®ç°åŸºäºå…·ä½“çš„ä¸šåŠ¡æœåŠ¡ã€‚ 1. å‰æ–‡å›é¡¾ä¸æ•´åˆè®¾è®¡åœ¨è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ç³»åˆ—æ–‡ç« ä¸­ï¼Œè®²è§£äº†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­Au">
<meta name="keywords" content="zuul,gateway,Spring Security,OAuth2">
<meta property="og:type" content="article">
<meta property="og:title" content="å¾®æœåŠ¡æ¶æ„ä¸­æ•´åˆç½‘å…³ã€æƒé™æœåŠ¡">
<meta property="og:url" content="http://blueskykong.com/2017/12/10/integration/index.html">
<meta property="og:site_name" content="Aoho&#39;s Blog">
<meta property="og:description" content="å‰è¨€ï¼šä¹‹å‰çš„æ–‡ç« æœ‰è®²è¿‡å¾®æœåŠ¡çš„æƒé™ç³»åˆ—å’Œç½‘å…³å®ç°ï¼Œéƒ½æ˜¯å­¤ç«‹å­˜åœ¨ï¼Œæœ¬æ–‡å°†æ•´åˆåç«¯æœåŠ¡ä¸ç½‘å…³ã€æƒé™ç³»ç»Ÿã€‚å®‰å…¨æƒé™éƒ¨åˆ†çš„å®ç°è¿˜è®²è§£äº†åŸºäºå‰ç½®éªŒè¯çš„æ–¹å¼å®ç°ï¼Œä½†æ˜¯ç”±äºä¸ä¸šåŠ¡è”ç³»æ¯”è¾ƒç´§å¯†ï¼Œæ²¡æœ‰å…·ä½“çš„ç¤ºä¾‹ã€‚ä¸šåŠ¡æƒé™ä¸ä¸šåŠ¡è”ç³»éå¸¸å¯†åˆ‡ï¼Œæœ¬æ¬¡çš„æ•´åˆé¡¹ç›®å°†ä¼šæŠŠè¿™éƒ¨åˆ†çš„æ“ä½œæƒé™æ ¡éªŒå®ç°åŸºäºå…·ä½“çš„ä¸šåŠ¡æœåŠ¡ã€‚ 1. å‰æ–‡å›é¡¾ä¸æ•´åˆè®¾è®¡åœ¨è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ç³»åˆ—æ–‡ç« ä¸­ï¼Œè®²è§£äº†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­Au">
<meta property="og:image" content="http://ovcjgn2x0.bkt.clouddn.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%9D%83%E9%99%90%20%281%29.png">
<meta property="og:image" content="http://ovcjgn2x0.bkt.clouddn.com/gwflow.jpg">
<meta property="og:image" content="http://ovcjgn2x0.bkt.clouddn.com/backend%E6%B5%81%E7%A8%8B.png">
<meta property="og:updated_time" content="2017-12-12T04:56:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="å¾®æœåŠ¡æ¶æ„ä¸­æ•´åˆç½‘å…³ã€æƒé™æœåŠ¡">
<meta name="twitter:description" content="å‰è¨€ï¼šä¹‹å‰çš„æ–‡ç« æœ‰è®²è¿‡å¾®æœåŠ¡çš„æƒé™ç³»åˆ—å’Œç½‘å…³å®ç°ï¼Œéƒ½æ˜¯å­¤ç«‹å­˜åœ¨ï¼Œæœ¬æ–‡å°†æ•´åˆåç«¯æœåŠ¡ä¸ç½‘å…³ã€æƒé™ç³»ç»Ÿã€‚å®‰å…¨æƒé™éƒ¨åˆ†çš„å®ç°è¿˜è®²è§£äº†åŸºäºå‰ç½®éªŒè¯çš„æ–¹å¼å®ç°ï¼Œä½†æ˜¯ç”±äºä¸ä¸šåŠ¡è”ç³»æ¯”è¾ƒç´§å¯†ï¼Œæ²¡æœ‰å…·ä½“çš„ç¤ºä¾‹ã€‚ä¸šåŠ¡æƒé™ä¸ä¸šåŠ¡è”ç³»éå¸¸å¯†åˆ‡ï¼Œæœ¬æ¬¡çš„æ•´åˆé¡¹ç›®å°†ä¼šæŠŠè¿™éƒ¨åˆ†çš„æ“ä½œæƒé™æ ¡éªŒå®ç°åŸºäºå…·ä½“çš„ä¸šåŠ¡æœåŠ¡ã€‚ 1. å‰æ–‡å›é¡¾ä¸æ•´åˆè®¾è®¡åœ¨è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ç³»åˆ—æ–‡ç« ä¸­ï¼Œè®²è§£äº†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­Au">
<meta name="twitter:image" content="http://ovcjgn2x0.bkt.clouddn.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%9D%83%E9%99%90%20%281%29.png">
    

    
        <link rel="alternate" href="/" title="Aoho&#39;s Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Aoho&#39;s Blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/uploads/avatar.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/uploads/avatar.jpg" />
            <h2 id="name">aoho</h2>
            <h3 id="title">Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>China</span>
            <a id="follow" target="_blank" href="https://github.com/keets2012">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                32
                <span>posts</span>
            </div>
            <div class="article-info-block">
                37
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-integration" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            å¾®æœåŠ¡æ¶æ„ä¸­æ•´åˆç½‘å…³ã€æƒé™æœåŠ¡
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/10/integration/">
            <time datetime="2017-12-09T16:00:00.000Z" itemprop="datePublished">2017-12-10</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OAuth2/">OAuth2</a>, <a class="tag-link" href="/tags/Spring-Security/">Spring Security</a>, <a class="tag-link" href="/tags/gateway/">gateway</a>, <a class="tag-link" href="/tags/zuul/">zuul</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>å‰è¨€ï¼šä¹‹å‰çš„æ–‡ç« æœ‰è®²è¿‡å¾®æœåŠ¡çš„æƒé™ç³»åˆ—å’Œç½‘å…³å®ç°ï¼Œéƒ½æ˜¯å­¤ç«‹å­˜åœ¨ï¼Œæœ¬æ–‡å°†æ•´åˆåç«¯æœåŠ¡ä¸ç½‘å…³ã€æƒé™ç³»ç»Ÿã€‚å®‰å…¨æƒé™éƒ¨åˆ†çš„å®ç°è¿˜è®²è§£äº†åŸºäºå‰ç½®éªŒè¯çš„æ–¹å¼å®ç°ï¼Œä½†æ˜¯ç”±äºä¸ä¸šåŠ¡è”ç³»æ¯”è¾ƒç´§å¯†ï¼Œæ²¡æœ‰å…·ä½“çš„ç¤ºä¾‹ã€‚ä¸šåŠ¡æƒé™ä¸ä¸šåŠ¡è”ç³»éå¸¸å¯†åˆ‡ï¼Œæœ¬æ¬¡çš„æ•´åˆé¡¹ç›®å°†ä¼šæŠŠè¿™éƒ¨åˆ†çš„æ“ä½œæƒé™æ ¡éªŒå®ç°åŸºäºå…·ä½“çš„ä¸šåŠ¡æœåŠ¡ã€‚</p>
<h2 id="1-å‰æ–‡å›é¡¾ä¸æ•´åˆè®¾è®¡"><a href="#1-å‰æ–‡å›é¡¾ä¸æ•´åˆè®¾è®¡" class="headerlink" title="1. å‰æ–‡å›é¡¾ä¸æ•´åˆè®¾è®¡"></a>1. å‰æ–‡å›é¡¾ä¸æ•´åˆè®¾è®¡</h2><p>åœ¨<a href="http://blueskykong.com/2017/10/19/security1/">è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°</a>ç³»åˆ—æ–‡ç« ä¸­ï¼Œè®²è§£äº†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­Authç³»ç»Ÿçš„æˆæƒè®¤è¯å’Œé‰´æƒã€‚åœ¨<a href="http://blueskykong.com/2017/11/13/gateway/">å¾®æœåŠ¡ç½‘å…³</a>ä¸­ï¼Œè®²è§£äº†åŸºäºnetflix-zuulç»„ä»¶å®ç°çš„å¾®æœåŠ¡ç½‘å…³ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™æ¬¡æ•´åˆçš„æ¶æ„å›¾ã€‚</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%9D%83%E9%99%90%20%281%29.png" alt="ms" title="å¾®æœåŠ¡æ¶æ„æƒé™"></p>
<p>æ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>ç”¨æˆ·å°šæœªç™»å½•ã€‚å®¢æˆ·ç«¯ï¼ˆwebå’Œç§»åŠ¨ç«¯ï¼‰å‘èµ·ç™»å½•è¯·æ±‚ï¼Œç½‘å…³å¯¹äºç™»å½•è¯·æ±‚ç›´æ¥è½¬å‘åˆ°authæœåŠ¡ï¼ŒauthæœåŠ¡å¯¹ç”¨æˆ·èº«ä»½ä¿¡æ¯è¿›è¡Œæ ¡éªŒï¼ˆæ•´åˆé¡¹ç›®çœç•¥ç”¨æˆ·ç³»ç»Ÿï¼Œè¯»è€…å¯è‡ªè¡Œå®ç°ï¼Œç›´æ¥ç¡¬ç¼–ç è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œæœ€ç»ˆå°†èº«ä»½åˆæ³•çš„tokenè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>ç”¨æˆ·å·²ç™»å½•ï¼Œè¯·æ±‚å…¶ä»–æœåŠ¡ã€‚è¿™ç§æƒ…å†µï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°è¾¾ç½‘å…³ï¼Œç½‘å…³ä¼šè°ƒç”¨authç³»ç»Ÿè¿›è¡Œè¯·æ±‚èº«ä»½åˆæ³•æ€§çš„éªŒè¯ï¼ŒéªŒè¯ä¸é€šåˆ™ç›´æ¥æ‹’ç»ï¼Œå¹¶è¿”å›401ï¼›å¦‚æœé€šè¿‡éªŒè¯ï¼Œåˆ™è½¬å‘åˆ°å…·ä½“æœåŠ¡ï¼ŒæœåŠ¡ç»è¿‡è¿‡æ»¤å™¨ï¼Œæ ¹æ®è¯·æ±‚å¤´éƒ¨ä¸­çš„userIdï¼Œè·å–è¯¥userçš„å®‰å…¨æƒé™ä¿¡æ¯ã€‚åˆ©ç”¨åˆ‡é¢ï¼Œå¯¹è¯¥æ¥å£éœ€è¦çš„æƒé™è¿›è¡Œæ ¡éªŒï¼Œé€šè¿‡åˆ™proceedï¼Œå¦åˆ™è¿”å›403ã€‚</li>
</ul>
<p>ç¬¬ä¸€ç±»å…¶å®æ¯”è¾ƒç®€å•ï¼Œåœ¨è®²è§£<a href="http://blueskykong.com/2017/10/19/security1/">è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°</a>å°±åŸºæœ¬å®ç°ï¼Œç°åœ¨è¦åšçš„æ˜¯ä¸ç½‘å…³è¿›è¡Œç»“åˆï¼›ç¬¬äºŒç±»ä¸­ï¼Œæˆ‘ä»¬æ–°å»ºäº†ä¸€ä¸ªåç«¯æœåŠ¡ï¼Œä¸ç½‘å…³ã€authç³»ç»Ÿæ•´åˆã€‚</p>
<p>ä¸‹é¢å¯¹æ•´åˆé¡¹ç›®æ¶‰åŠåˆ°çš„ä¸‰ä¸ªæœåŠ¡åˆ†åˆ«ä»‹ç»ã€‚ç½‘å…³å’ŒauthæœåŠ¡çš„å®ç°å·²ç»è®²è¿‡ï¼Œæœ¬æ–‡ä¸»è¦è®²ä¸‹è¿™ä¸¤ä¸ªæœåŠ¡è¿›è¡Œæ•´åˆéœ€è¦çš„æ”¹åŠ¨ï¼Œè¿˜æœ‰å°±æ˜¯å¯¹äºåç«¯æœåŠ¡çš„ä¸»è¦å®ç°è¿›è¡Œè®²è§£ã€‚</p>
<h2 id="2-gatewayå®ç°"><a href="#2-gatewayå®ç°" class="headerlink" title="2. gatewayå®ç°"></a>2. gatewayå®ç°</h2><p><a href="http://blueskykong.com/2017/11/13/gateway/">å¾®æœåŠ¡ç½‘å…³</a>å·²ç»åŸºæœ¬ä»‹ç»å®Œäº†ç½‘å…³çš„å®ç°ï¼ŒåŒ…æ‹¬æœåŠ¡è·¯ç”±ã€å‡ ç§è¿‡æ»¤æ–¹å¼ç­‰ã€‚è¿™ä¸€èŠ‚å°†é‡ç‚¹ä»‹ç»å®é™…åº”ç”¨æ—¶çš„æ•´åˆã€‚å¯¹äºéœ€è¦ä¿®æ”¹å¢å¼ºçš„åœ°æ–¹å¦‚ä¸‹ï¼š</p>
<ul>
<li>åŒºåˆ†æš´éœ²æ¥å£ï¼ˆå³å¯¹å¤–ç›´æ¥è®¿é—®ï¼‰å’Œéœ€è¦åˆæ³•èº«ä»½ç™»å½•ä¹‹åæ‰èƒ½è®¿é—®çš„æ¥å£</li>
<li>æš´éœ²æ¥å£ç›´æ¥æ”¾è¡Œï¼Œè½¬å‘åˆ°å…·ä½“æœåŠ¡ï¼Œå¦‚ç™»å½•ã€åˆ·æ–°tokenç­‰</li>
<li>éœ€è¦åˆæ³•èº«ä»½ç™»å½•ä¹‹åæ‰èƒ½è®¿é—®çš„æ¥å£ï¼Œæ ¹æ®ä¼ å…¥çš„Access tokenè¿›è¡Œæ„é€ å¤´éƒ¨ï¼Œå¤´éƒ¨ä¸»è¦åŒ…æ‹¬userIdç­‰ä¿¡æ¯ï¼Œå¯æ ¹æ®è‡ªå·±çš„å®é™…ä¸šåŠ¡åœ¨authæœåŠ¡ä¸­è¿›è¡Œè®¾ç½®ã€‚</li>
<li>æœ€åï¼Œæ¯”è¾ƒé‡è¦çš„ä¸€ç‚¹ï¼Œå¼•å…¥Spring Securityçš„èµ„æºæœåŠ¡å™¨é…ç½®ï¼Œå¯¹äºæš´éœ²æ¥å£è®¾ç½®permitAll()ï¼Œå…¶ä½™æ¥å£è¿›å…¥èº«ä»½åˆæ³•æ€§æ ¡éªŒçš„æµç¨‹ï¼Œè°ƒç”¨authæœåŠ¡ï¼Œå¦‚æœé€šè¿‡åˆ™æ­£å¸¸ç»§ç»­è½¬å‘ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œè¿”å›401ã€‚</li>
</ul>
<p>ç»˜åˆ¶çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/gwflow.jpg" alt="gwflow" title="ç½‘å…³è·¯ç”±æµç¨‹å›¾"></p>
<h3 id="2-1-permitAllå®ç°"><a href="#2-1-permitAllå®ç°" class="headerlink" title="2.1 permitAllå®ç°"></a>2.1 permitAllå®ç°</h3><p>å¯¹å¤–æš´éœ²çš„æ¥å£å¯ä»¥ç›´æ¥è®¿é—®ï¼Œè¿™å¯ä»¥ä¾èµ–é…ç½®æ–‡ä»¶ï¼Œè€Œé…ç½®æ–‡ä»¶åˆå¯ä»¥é€šè¿‡é…ç½®ä¸­å¿ƒè¿›è¡ŒåŠ¨æ€æ›´æ–°ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒæœ‰hard-codeçš„é—®é¢˜ã€‚<br>åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰éœ€è¦permitallçš„è·¯å¾„ã€‚</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">auth:</span></div><div class="line"><span class="attr">  permitall:</span></div><div class="line"><span class="bullet">    -</span></div><div class="line"><span class="attr">      pattern:</span> <span class="string">/login/**</span></div><div class="line"><span class="bullet">    -</span></div><div class="line"><span class="attr">      pattern:</span> <span class="string">/web/public/**</span></div></pre></td></tr></table></figure>
<p>æœåŠ¡å¯åŠ¨æ—¶ï¼Œè¯»å…¥ç›¸åº”çš„Configurationï¼Œä¸‹é¢çš„é…ç½®å±æ€§è¯»å–ä»¥authå¼€å¤´çš„é…ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"auth"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> PermitAllUrlProperties <span class="title">getPermitAllUrlProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PermitAllUrlProperties();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ç„¶è¿˜éœ€è¦æœ‰PermitAllUrlPropertieså¯¹åº”çš„å®ä½“ç±»ï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸åˆ—å‡ºæ¥äº†ã€‚</p>
<h3 id="2-2-åŠ å¼ºå¤´éƒ¨"><a href="#2-2-åŠ å¼ºå¤´éƒ¨" class="headerlink" title="2.2 åŠ å¼ºå¤´éƒ¨"></a>2.2 åŠ å¼ºå¤´éƒ¨</h3><p>Filterè¿‡æ»¤å™¨ï¼Œå®ƒæ˜¯ServletæŠ€æœ¯ä¸­æœ€å®ç”¨çš„æŠ€æœ¯ï¼ŒWebå¼€å‘äººå‘˜é€šè¿‡FilteræŠ€æœ¯ï¼Œå¯¹webæœåŠ¡å™¨ç®¡ç†çš„æ‰€æœ‰webèµ„æºè¿›è¡Œæ‹¦æˆªã€‚è¿™è¾¹ä½¿ç”¨Filterè¿›è¡Œå¤´éƒ¨å¢å¼ºï¼Œè§£æè¯·æ±‚ä¸­çš„tokenï¼Œæ„é€ ç»Ÿä¸€çš„å¤´éƒ¨ä¿¡æ¯ï¼Œåˆ°äº†å…·ä½“æœåŠ¡ï¼Œå¯ä»¥åˆ©ç”¨å¤´éƒ¨ä¸­çš„userIdè¿›è¡Œæ“ä½œæƒé™è·å–ä¸åˆ¤æ–­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderEnhanceFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> PermitAllUrlProperties permitAllUrlProperties;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//ä¸»è¦çš„è¿‡æ»¤æ–¹æ³•</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        String authorization = ((HttpServletRequest) servletRequest).getHeader(<span class="string">"Authorization"</span>);</div><div class="line">        String requestURI = ((HttpServletRequest) servletRequest).getRequestURI();</div><div class="line">        <span class="comment">// test if request url is permit all , then remove authorization from header</span></div><div class="line">        LOGGER.info(String.format(<span class="string">"Enhance request URI : %s."</span>, requestURI));</div><div class="line">        <span class="comment">//å°†isPermitAllUrlçš„è¯·æ±‚è¿›è¡Œä¼ é€’</span></div><div class="line">        <span class="keyword">if</span>(isPermitAllUrl(requestURI) &amp;&amp; isNotOAuthEndpoint(requestURI)) &#123;</div><div class="line">        	<span class="comment">//ç§»é™¤å¤´éƒ¨ï¼Œä½†ä¸åŒ…æ‹¬ç™»å½•ç«¯ç‚¹çš„å¤´éƒ¨</span></div><div class="line">            HttpServletRequest resetRequest = removeValueFromRequestHeader((HttpServletRequest) servletRequest);</div><div class="line">            filterChain.doFilter(resetRequest, servletResponse);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯ç¬¦åˆè§„èŒƒçš„å¤´éƒ¨</span></div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(authorization)) &#123;</div><div class="line">            <span class="keyword">if</span> (isJwtBearerToken(authorization)) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    authorization = StringUtils.substringBetween(authorization, <span class="string">"."</span>);</div><div class="line">                    String decoded = <span class="keyword">new</span> String(Base64.decodeBase64(authorization));</div><div class="line"></div><div class="line">                    Map properties = <span class="keyword">new</span> ObjectMapper().readValue(decoded, Map.class);</div><div class="line">					<span class="comment">//è§£æauthorizationä¸­çš„tokenï¼Œæ„é€ USER_ID_IN_HEADER</span></div><div class="line">                    String userId = (String) properties.get(SecurityConstants.USER_ID_IN_HEADER);</div><div class="line"></div><div class="line">                    RequestContext.getCurrentContext().addZuulRequestHeader(SecurityConstants.USER_ID_IN_HEADER, userId);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    LOGGER.error(<span class="string">"Failed to customize header for the request"</span>, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//ä¸ºäº†é€‚é…ï¼Œè®¾ç½®åŒ¿åå¤´éƒ¨</span></div><div class="line">            RequestContext.getCurrentContext().addZuulRequestHeader(SecurityConstants.USER_ID_IN_HEADER, ANONYMOUS_USER_ID);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        filterChain.doFilter(servletRequest, servletResponse);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç åˆ—å‡ºäº†å¤´éƒ¨å¢å¼ºçš„åŸºæœ¬å¤„ç†æµç¨‹ï¼Œå°†isPermitAllUrlçš„è¯·æ±‚è¿›è¡Œç›´æ¥ä¼ é€’ï¼Œå¦åˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯ç¬¦åˆè§„èŒƒçš„å¤´éƒ¨ï¼Œç„¶åè§£æauthorizationä¸­çš„tokenï¼Œæ„é€ USER_ID_IN_HEADERã€‚æœ€åä¸ºäº†é€‚é…ï¼Œè®¾ç½®åŒ¿åå¤´éƒ¨ã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒHeaderEnhanceFilterä¹Ÿè¦è¿›è¡Œæ³¨å†Œã€‚Spring æä¾›äº†FilterRegistrationBeanç±»ï¼Œæ­¤ç±»æä¾›setOrderæ–¹æ³•ï¼Œå¯ä»¥ä¸ºfilterè®¾ç½®æ’åºå€¼ï¼Œè®©springåœ¨æ³¨å†Œweb filterä¹‹å‰æ’åºåå†ä¾æ¬¡æ³¨å†Œã€‚</p>
<h3 id="2-3-èµ„æºæœåŠ¡å™¨é…ç½®"><a href="#2-3-èµ„æºæœåŠ¡å™¨é…ç½®" class="headerlink" title="2.3 èµ„æºæœåŠ¡å™¨é…ç½®"></a>2.3 èµ„æºæœåŠ¡å™¨é…ç½®</h3><p>åˆ©ç”¨èµ„æºæœåŠ¡å™¨çš„é…ç½®ï¼Œæ§åˆ¶å“ªäº›æ˜¯æš´éœ²ç«¯ç‚¹ä¸éœ€è¦è¿›è¡Œèº«ä»½åˆæ³•æ€§çš„æ ¡éªŒï¼Œç›´æ¥è·¯ç”±è½¬å‘ï¼Œå“ªäº›æ˜¯éœ€è¦è¿›è¡Œèº«ä»½loadAuthenticationï¼Œè°ƒç”¨authæœåŠ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableResourceServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//... </span></div><div class="line">	<span class="comment">//é…ç½®permitAllçš„è¯·æ±‚patternï¼Œä¾èµ–äºpermitAllUrlPropertieså¯¹è±¡</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        http.csrf().disable()</div><div class="line">                .requestMatchers().antMatchers(<span class="string">"/**"</span>)</div><div class="line">                .and()</div><div class="line">                .authorizeRequests()</div><div class="line">                .antMatchers(permitAllUrlProperties.getPermitallPatterns()).permitAll()</div><div class="line">                .anyRequest().authenticated();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//é€šè¿‡è‡ªå®šä¹‰çš„CustomRemoteTokenServicesï¼Œæ¤å…¥èº«ä»½åˆæ³•æ€§çš„ç›¸å…³éªŒè¯</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        CustomRemoteTokenServices resourceServerTokenServices = <span class="keyword">new</span> CustomRemoteTokenServices();</div><div class="line">        <span class="comment">//...</span></div><div class="line">        resources.tokenServices(resourceServerTokenServices);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>èµ„æºæœåŠ¡å™¨çš„é…ç½®å¤§å®¶çœ‹äº†ç¬”è€…ä¹‹å‰çš„æ–‡ç« åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œæ­¤å¤„ä¸è¿‡å¤šé‡å¤è®²äº†ã€‚å…³äº<code>ResourceServerSecurityConfigurer</code>é…ç½®ç±»ï¼Œä¹‹å‰çš„å®‰å…¨ç³»åˆ—æ–‡ç« å·²ç»è®²è¿‡ï¼Œ<code>ResourceServerTokenServices</code>æ¥å£ï¼Œå½“æ—¶æˆ‘ä»¬ä¹Ÿç”¨åˆ°äº†ï¼Œåªä¸è¿‡ç”¨çš„æ˜¯é»˜è®¤çš„<code>DefaultTokenServices</code>ã€‚è¿™è¾¹é€šè¿‡è‡ªå®šä¹‰çš„<code>CustomRemoteTokenServices</code>ï¼Œæ¤å…¥èº«ä»½åˆæ³•æ€§çš„ç›¸å…³éªŒè¯ã€‚</p>
<p>å½“ç„¶è¿™ä¸ªé…ç½®è¿˜è¦å¼•å…¥Spring Cloud Security oauth2çš„ç›¸åº”ä¾èµ–ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="2-4-è‡ªå®šä¹‰RemoteTokenServiceså®ç°"><a href="#2-4-è‡ªå®šä¹‰RemoteTokenServiceså®ç°" class="headerlink" title="2.4 è‡ªå®šä¹‰RemoteTokenServiceså®ç°"></a>2.4 è‡ªå®šä¹‰RemoteTokenServiceså®ç°</h3><p><code>ResourceServerTokenServices</code>æ¥å£å…¶ä¸­çš„ä¸€ä¸ªå®ç°æ˜¯<code>RemoteTokenServices</code>ã€‚</p>
<blockquote>
<p> Queries the /check_token endpoint to obtain the contents of an access token.<br>If the endpoint returns a 400 response, this indicates that the token is invalid.</p>
</blockquote>
<p><code>RemoteTokenServices</code>ä¸»è¦æ˜¯æŸ¥è¯¢authæœåŠ¡çš„<code>/check_token</code>ç«¯ç‚¹ä»¥è·å–ä¸€ä¸ªtokençš„æ ¡éªŒç»“æœã€‚å¦‚æœæœ‰é”™è¯¯ï¼Œåˆ™è¯´æ˜tokenæ˜¯ä¸åˆæ³•çš„ã€‚ç¬”è€…è¿™è¾¹çš„çš„<code>CustomRemoteTokenServices</code>å®ç°å°±æ˜¯æ²¿ç”¨è¯¥æ€è·¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬”è€…çš„é¡¹ç›®åŸºäºSpring cloudï¼ŒauthæœåŠ¡æ˜¯å¤šå®ä¾‹çš„ï¼Œæ‰€ä»¥è¿™è¾¹ä½¿ç”¨äº†Netflix Ribbonè·å–authæœåŠ¡è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚Spring Cloud Securityæ·»åŠ å¦‚ä¸‹é»˜è®¤é…ç½®ï¼Œå¯¹åº”authæœåŠ¡ä¸­çš„ç›¸åº”ç«¯ç‚¹ã€‚</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attr">security:</span></div><div class="line"><span class="attr">  oauth2:</span></div><div class="line"><span class="attr">    client:</span></div><div class="line"><span class="attr">      accessTokenUri:</span> <span class="string">/oauth/token</span></div><div class="line"><span class="attr">      clientId:</span> <span class="string">gateway</span></div><div class="line"><span class="attr">      clientSecret:</span> <span class="string">gateway</span></div><div class="line"><span class="attr">    resource:</span></div><div class="line"><span class="attr">      userInfoUri:</span> <span class="string">/user</span></div><div class="line"><span class="attr">      token-info-uri:</span> <span class="string">/oauth/check_token</span></div></pre></td></tr></table></figure>
<p>è‡³äºå…·ä½“çš„<code>CustomRemoteTokenServices</code>å®ç°ï¼Œå¯ä»¥å‚è€ƒä¸Šé¢è®²çš„æ€è·¯ä»¥åŠ<code>RemoteTokenServices</code>ï¼Œå¾ˆç®€å•ï¼Œæ­¤å¤„ç•¥å»ã€‚</p>
<p>è‡³æ­¤ï¼Œç½‘å…³æœåŠ¡çš„å¢å¼ºå®Œæˆï¼Œä¸‹é¢çœ‹ä¸€ä¸‹æˆ‘ä»¬å¯¹authæœåŠ¡å’Œåç«¯backendæœåŠ¡çš„å®ç°ã€‚<br><strong>å¼ºè°ƒä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆå¤´éƒ¨ä¼ é€’çš„userIdç­‰ä¿¡æ¯éœ€è¦åœ¨ç½‘å…³æ„é€ ï¼Ÿè¯»è€…å¯ä»¥è‡ªå·±æ€è€ƒä¸€ä¸‹ï¼Œç»“åˆå®‰å…¨ç­‰æ–¹é¢ï¼ŒğŸ˜†ç¬”è€…æš‚æ—¶ä¸ç»™å‡ºç­”æ¡ˆã€‚</strong></p>
<h2 id="3-authæ•´åˆ"><a href="#3-authæ•´åˆ" class="headerlink" title="3. authæ•´åˆ"></a>3. authæ•´åˆ</h2><p>authæœåŠ¡çš„æ•´åˆä¿®æ”¹ï¼Œå…¶å®æ²¡é‚£ä¹ˆå¤šï¼Œä¹‹å‰å¯¹äºuserã€roleä»¥åŠpermissionä¹‹é—´çš„å®šä¹‰å’Œå…³ç³»æ²¡æœ‰ç»™å‡ºå®ç°ï¼Œè¿™éƒ¨åˆ†çš„sqlè¯­å¥å·²ç»åœ¨auth.sqlä¸­ã€‚æ‰€ä»¥ä¸ºäº†èƒ½ç»™å‡ºä¸€ä¸ªå®Œæ•´çš„å®ä¾‹ï¼Œç¬”è€…æŠŠè¿™éƒ¨åˆ†å®ç°ç»™è¡¥å……äº†ï¼Œä¸»è¦å°±æ˜¯user-roleï¼Œroleã€role-permissionçš„ç›¸åº”æ¥å£å®šä¹‰ä¸å®ç°ï¼Œå®ç°å¢åˆ æ”¹æŸ¥ã€‚   </p>
<p>è¯»è€…è¦æ˜¯æƒ³å‚è€ƒæ•´åˆé¡¹ç›®è¿›è¡Œå®é™…åº”ç”¨ï¼Œè¿™éƒ¨åˆ†å®Œå…¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡è¿›è¡Œå¢å¼ºï¼ŒåŒ…æ‹¬tokençš„åˆ›å»ºï¼Œå…¶è‡ªå®šä¹‰çš„ä¿¡æ¯è¿˜å¯ä»¥åœ¨ç½‘å…³ä¸­è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œæ„é€ å¥½ä¹‹åä¼ é€’ç»™åç«¯æœåŠ¡ã€‚</p>
<p>è¿™è¾¹çš„æ¥å£åªæ˜¯åˆ—å‡ºäº†éœ€è¦çš„å‡ ä¸ªï¼Œå…¶ä»–æ¥å£æ²¡å†™ï¼ˆå› ä¸ºæ‡’ã€‚ã€‚ï¼‰</p>
<p>è¿™ä¸¤ä¸ªæ¥å£ä¹Ÿæ˜¯ç»™backendé¡¹ç›®ç”¨æ¥è·å–ç›¸åº”çš„userIdæƒé™ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æ ¹æ®userIdè·å–ç”¨æˆ·å¯¹åº”çš„æƒé™</span></div><div class="line"> <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/api/userPermissions?userId=&#123;userId&#125;"</span>,</div><div class="line">            consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class="line">    <span class="function">List&lt;Permission&gt; <span class="title">getUserPermissions</span><span class="params">(@RequestParam(<span class="string">"userId"</span>)</span> String userId)</span>;</div><div class="line"></div><div class="line"><span class="comment">//æ ¹æ®userIdè·å–ç”¨æˆ·å¯¹åº”çš„accessLevelï¼ˆå¥½åƒæš‚æ—¶æ²¡ç”¨åˆ°ã€‚ã€‚ï¼‰</span></div><div class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/api/userAccesses?userId=&#123;userId&#125;"</span>,</div><div class="line">            consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class="line">    <span class="function">List&lt;UserAccess&gt; <span class="title">getUserAccessList</span><span class="params">(@RequestParam(<span class="string">"userId"</span>)</span> String userId)</span>;</div></pre></td></tr></table></figure>
<p>å¥½äº†ï¼Œè¿™è¾¹çš„å®ç°å·²ç»è®²å®Œäº†ï¼Œå…·ä½“è§é¡¹ç›®ä¸­çš„å®ç°ã€‚</p>
<h2 id="4-backendé¡¹ç›®å®ç°"><a href="#4-backendé¡¹ç›®å®ç°" class="headerlink" title="4. backendé¡¹ç›®å®ç°"></a>4. backendé¡¹ç›®å®ç°</h2><p>æœ¬èŠ‚æ˜¯è¿›è¡Œå®ç°ä¸€ä¸ªbackendçš„å®ä¾‹ï¼Œåç«¯é¡¹ç›®ä¸»è¦å®ç°å“ªäº›åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ï¼Œä¹‹å‰ç½‘å…³æœåŠ¡å’ŒauthæœåŠ¡æ‰€åšçš„å‡†å¤‡ï¼š</p>
<ul>
<li>ç½‘å…³æ„é€ çš„å¤´éƒ¨userIdï¼ˆå¯èƒ½è¿˜æœ‰å…¶ä»–ä¿¡æ¯ï¼Œè¿™è¾¹åªæ˜¯ç¤ºä¾‹ï¼‰ï¼Œå¯ä»¥åœ¨backendè·å¾—</li>
<li>è½¬å‘åˆ°backendæœåŠ¡çš„è¯·æ±‚ï¼Œéƒ½æ˜¯ç»è¿‡èº«ä»½åˆæ³•æ€§æ ¡éªŒï¼Œæˆ–è€…æ˜¯ç›´æ¥å¯¹å¤–æš´éœ²çš„æ¥å£</li>
<li>authæœåŠ¡ï¼Œæä¾›æ ¹æ®userIdè¿›è¡Œè·å–ç›¸åº”çš„æƒé™çš„æ¥å£</li>
</ul>
<p>æ ¹æ®è¿™äº›ï¼Œç¬”è€…ç»˜åˆ¶äº†ä¸€ä¸ªbackendçš„é€šç”¨æµç¨‹å›¾ï¼š</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/backend%E6%B5%81%E7%A8%8B.png" alt="bf" title="backendæµç¨‹å›¾"></p>
<p>ä¸Šé¢çš„æµç¨‹å›¾å…¶å®å·²ç»éå¸¸æ¸…æ™°äº†ï¼Œé¦–å…ˆç»è¿‡filterè¿‡æ»¤å™¨ï¼Œå¡«å……<code>SecurityContextHolder</code>çš„ä¸Šä¸‹æ–‡ã€‚å…¶æ¬¡ï¼Œé€šè¿‡åˆ‡é¢æ¥å®ç°æ³¨è§£ï¼Œæ˜¯å¦éœ€è¦è¿›å…¥åˆ‡é¢è¡¨è¾¾å¼å¤„ç†ã€‚ä¸éœ€è¦çš„è¯ï¼Œç›´æ¥æ‰§è¡Œæ¥å£å†…çš„æ–¹æ³•ï¼›å¦åˆ™è§£ææ³¨è§£ä¸­éœ€è¦çš„æƒé™ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æƒé™æ‰§è¡Œï¼Œæœ‰çš„è¯ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¿”å›403 forbiddenã€‚</p>
<h3 id="4-1-filterè¿‡æ»¤å™¨"><a href="#4-1-filterè¿‡æ»¤å™¨" class="headerlink" title="4.1 filterè¿‡æ»¤å™¨"></a>4.1 filterè¿‡æ»¤å™¨</h3><p>Filterè¿‡æ»¤å™¨ï¼Œå’Œä¸Šé¢ç½‘å…³ä½¿ç”¨ä¸€æ ·ï¼Œæ‹¦æˆªå®¢æˆ·çš„HttpServletRequestã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> FeignAuthClient feignAuthClient;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        logger.info(<span class="string">"è¿‡æ»¤å™¨æ­£åœ¨æ‰§è¡Œ..."</span>);</div><div class="line">        <span class="comment">// pass the request along the filter chain</span></div><div class="line">        String userId = ((HttpServletRequest) servletRequest).getHeader(SecurityConstants.USER_ID_IN_HEADER);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(userId)) &#123;</div><div class="line">            UserContext userContext = <span class="keyword">new</span> UserContext(UUID.fromString(userId));</div><div class="line">            userContext.setAccessType(AccessType.ACCESS_TYPE_NORMAL);</div><div class="line"></div><div class="line">            List&lt;Permission&gt; permissionList = feignAuthClient.getUserPermissions(userId);</div><div class="line">            List&lt;SimpleGrantedAuthority&gt; authorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            <span class="keyword">for</span> (Permission permission : permissionList) &#123;</div><div class="line">                SimpleGrantedAuthority authority = <span class="keyword">new</span> SimpleGrantedAuthority();</div><div class="line">                authority.setAuthority(permission.getPermission());</div><div class="line">                authorityList.add(authority);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            CustomAuthentication userAuth  = <span class="keyword">new</span> CustomAuthentication();</div><div class="line">            userAuth.setAuthorities(authorityList);</div><div class="line">            userContext.setAuthorities(authorityList);</div><div class="line">            userContext.setAuthentication(userAuth);</div><div class="line">            SecurityContextHolder.setContext(userContext);</div><div class="line">        &#125;</div><div class="line">        filterChain.doFilter(servletRequest, servletResponse);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	<span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°ä»£ç ä¸»è¦å®ç°äº†ï¼Œæ ¹æ®è¯·æ±‚å¤´ä¸­çš„userIdï¼Œåˆ©ç”¨feign clientè·å–authæœåŠ¡ä¸­çš„è¯¥useræ‰€å…·æœ‰çš„æƒé™é›†åˆã€‚ä¹‹åæ„é€ äº†ä¸€ä¸ªUserContextï¼ŒUserContextæ˜¯è‡ªå®šä¹‰çš„ï¼Œå®ç°äº†Spring Securityçš„<code>UserDetails, SecurityContext</code>æ¥å£ã€‚</p>
<h3 id="4-2-é€šè¿‡åˆ‡é¢æ¥å®ç°-PreAuthæ³¨è§£"><a href="#4-2-é€šè¿‡åˆ‡é¢æ¥å®ç°-PreAuthæ³¨è§£" class="headerlink" title="4.2 é€šè¿‡åˆ‡é¢æ¥å®ç°@PreAuthæ³¨è§£"></a>4.2 é€šè¿‡åˆ‡é¢æ¥å®ç°@PreAuthæ³¨è§£</h3><p>åŸºäºSpringçš„é¡¹ç›®ï¼Œä½¿ç”¨Springçš„AOPåˆ‡é¢å®ç°æ³¨è§£æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ä¸€ä»¶äº‹ï¼Œè¿™è¾¹æˆ‘ä»¬ä½¿ç”¨äº†è‡ªå®šä¹‰çš„æ³¨è§£<code>@PreAuth</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PreAuth &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Targetç”¨äºæè¿°æ³¨è§£çš„ä½¿ç”¨èŒƒå›´ï¼Œè¶…å‡ºèŒƒå›´æ—¶ç¼–è¯‘å¤±è´¥,å¯ä»¥ç”¨åœ¨æ–¹æ³•æˆ–è€…ç±»ä¸Šé¢ã€‚åœ¨è¿è¡Œæ—¶ç”Ÿæ•ˆã€‚ä¸äº†è§£æ³¨è§£ç›¸å…³çŸ¥è¯†çš„ï¼Œå¯ä»¥è‡ªè¡ŒGoogleã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthAspect</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.blueskykong.auth.demo.annotation.PreAuth)"</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * å®šåˆ¶ä¸€ä¸ªç¯ç»•é€šçŸ¥ï¼Œå½“æƒ³è·å¾—æ³¨è§£é‡Œé¢çš„å±æ€§ï¼Œå¯ä»¥ç›´æ¥æ³¨å…¥è¯¥æ³¨è§£</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> joinPoint</div><div class="line">     * <span class="doctag">@param</span> preAuth</div><div class="line">     */</div><div class="line">    <span class="meta">@Around</span>(<span class="string">"cut()&amp;&amp;@annotation(preAuth)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">record</span><span class="params">(ProceedingJoinPoint joinPoint, PreAuth preAuth)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		<span class="comment">//å–å‡ºæ³¨è§£ä¸­çš„è¡¨è¾¾å¼</span></div><div class="line">        String value = preAuth.value();</div><div class="line">        <span class="comment">//Spring EL å¯¹valueè¿›è¡Œè§£æ</span></div><div class="line">        SecurityExpressionOperations operations = <span class="keyword">new</span> CustomerSecurityExpressionRoot(SecurityContextHolder.getContext().getAuthentication());</div><div class="line">        StandardEvaluationContext operationContext = <span class="keyword">new</span> StandardEvaluationContext(operations);</div><div class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</div><div class="line">        Expression expression = parser.parseExpression(value);</div><div class="line">        <span class="comment">//è·å–è¡¨è¾¾å¼åˆ¤æ–­çš„ç»“æœ</span></div><div class="line">        <span class="keyword">boolean</span> result = expression.getValue(operationContext, <span class="keyword">boolean</span>.class);</div><div class="line">        <span class="keyword">if</span> (result) &#123;</div><div class="line">        	<span class="comment">//ç»§ç»­æ‰§è¡Œæ¥å£å†…çš„æ–¹æ³•</span></div><div class="line">            <span class="keyword">return</span> joinPoint.proceed();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Forbidden"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å› ä¸ºAspectä½œç”¨åœ¨beanä¸Šï¼Œæ‰€ä»¥å…ˆç”¨ComponentæŠŠè¿™ä¸ªç±»æ·»åŠ åˆ°å®¹å™¨ä¸­ã€‚<code>@Pointcut</code>å®šä¹‰è¦æ‹¦æˆªçš„æ³¨è§£ã€‚<code>@Around</code>å®šåˆ¶ä¸€ä¸ªç¯ç»•é€šçŸ¥ï¼Œå½“æƒ³è·å¾—æ³¨è§£é‡Œé¢çš„å±æ€§ï¼Œå¯ä»¥ç›´æ¥æ³¨å…¥è¯¥æ³¨è§£ã€‚åˆ‡é¢è¡¨è¾¾å¼å†…ä¸»è¦å®ç°äº†ï¼Œåˆ©ç”¨Spring ELå¯¹valueè¿›è¡Œè§£æï¼Œå°†<code>SecurityContextHolder.getContext()</code>è½¬æ¢æˆæ ‡å‡†çš„æ“ä½œä¸Šä¸‹æ–‡ï¼Œç„¶åè§£ææ³¨è§£ä¸­çš„è¡¨è¾¾å¼ï¼Œæœ€åè·å–å¯¹è¡¨è¾¾å¼åˆ¤æ–­çš„ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerSecurityExpressionRoot</span> <span class="keyword">extends</span> <span class="title">SecurityExpressionRoot</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomerSecurityExpressionRoot</span><span class="params">(Authentication authentication)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(authentication);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CustomerSecurityExpressionRoot</code>ç»§æ‰¿çš„æ˜¯æŠ½è±¡ç±»<code>SecurityExpressionRoot</code>ï¼Œè€Œæˆ‘ä»¬ç”¨åˆ°çš„å®é™…è¡¨è¾¾å¼æ˜¯å®šä¹‰åœ¨<code>SecurityExpressionOperations</code>æ¥å£ï¼Œ<code>SecurityExpressionRoot</code>åˆå®ç°äº†<code>SecurityExpressionOperations</code>æ¥å£ã€‚ä¸è¿‡è¿™é‡Œé¢çš„å…·ä½“åˆ¤æ–­å®ç°ï¼ŒSpring Security è°ƒç”¨çš„ä¹Ÿæ˜¯Spring ELã€‚</p>
<h3 id="4-3-controlleræ¥å£"><a href="#4-3-controlleræ¥å£" class="headerlink" title="4.3 controlleræ¥å£"></a>4.3 controlleræ¥å£</h3><p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹æœ€ç»ˆæ¥å£æ˜¯æ€ä¹ˆç”¨ä¸Šé¢å®ç°çš„æ³¨è§£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/test"</span>, method = RequestMethod.GET)</div><div class="line"><span class="meta">@PreAuth</span>(<span class="string">"hasAuthority('CREATE_COMPANY')"</span>) <span class="comment">// è¿˜å¯ä»¥å®šä¹‰å¾ˆå¤šè¡¨è¾¾å¼ï¼Œå¦‚hasRole('Admin')</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"ok"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@PreAuth</code>ä¸­ï¼Œå¯ä»¥å®šä¹‰çš„è¡¨è¾¾å¼å¾ˆå¤šï¼Œå¯ä»¥çœ‹<code>SecurityExpressionOperations</code>æ¥å£ä¸­çš„æ–¹æ³•ã€‚ç›®å‰ç¬”è€…åªæ˜¯å®ç°äº†<code>hasAuthority()</code>è¡¨è¾¾å¼ï¼Œå¦‚æœä½ æƒ³æ”¯æŒå…¶ä»–æ‰€æœ‰è¡¨è¾¾å¼ï¼Œåªéœ€è¦æ„é€ ç›¸åº”çš„<code>SecurityContextHolder</code>å³å¯ã€‚</p>
<h3 id="4-4-ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ"><a href="#4-4-ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ" class="headerlink" title="4.4 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ"></a>4.4 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</h3><p>æœ‰äº›è¯»è€…çœ‹äº†ä¸Šé¢çš„è®¾è®¡ï¼Œæ—¢ç„¶å¥½å¤šç”¨åˆ°äº†Spring Securityçš„å·¥å…·ç±»ï¼Œè‚¯å®šä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦å¼•å…¥è¿™ä¹ˆå¤æ‚çš„å·¥å…·ç±»ï¼Ÿ   </p>
<p>å…¶å®å¾ˆç®€å•ï¼Œé¦–å…ˆå› ä¸º<code>SecurityExpressionOperations</code>æ¥å£ä¸­å®šä¹‰çš„è¡¨è¾¾å¼è¶³å¤Ÿå¤šï¼Œä¸”è¾ƒä¸ºåˆç†ï¼Œèƒ½å¤Ÿè¦†ç›–æˆ‘ä»¬åœ¨å¹³æ—¶ç”¨åˆ°çš„å¤§éƒ¨åˆ†åœºæ™¯ï¼›å…¶æ¬¡ï¼Œç¬”è€…ä¹‹å‰çš„è®¾è®¡æ˜¯ç›´æ¥åœ¨æ³¨è§£ä¸­æŒ‡å®šæ‰€éœ€æƒé™ï¼Œæ²¡æœ‰æ‰©å±•æ€§ï¼Œä¸”å¯è¯»æ€§å·®ï¼›æœ€åï¼ŒSpring Security 4 ç¡®å®å¼•å…¥äº†<code>@PreAuthorize,@PostAuthorize</code>ç­‰æ³¨è§£ï¼Œæœ¬æ¥æƒ³ç”¨æ¥ç€ï¼Œè‡ªå·±å°è¯•äº†ä¸€ä¸‹ï¼Œå‘ç°å¯¹äºå¾®æœåŠ¡æ¶æ„è¿™æ ·çš„æ¥å£çº§åˆ«çš„æ“ä½œæƒé™æ ¡éªŒä¸æ˜¯å¾ˆé€‚åˆï¼Œåå¤šä¸ªè¿‡æ»¤å™¨å¤ªè¿‡å¤æ‚ï¼Œè€Œä¸”è¿˜æ¶‰åŠåˆ°çš„Principalã€Credentialsç­‰ä¿¡æ¯ï¼Œè¿™äº›å·²ç»åœ¨authç³»ç»Ÿå®ç°äº†èº«ä»½åˆæ³•æ€§æ ¡éªŒã€‚ç¬”è€…è®¤ä¸ºè¿™è¾¹çš„åŠŸèƒ½å®ç°å¹¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œéœ€è¦å¾ˆè½»é‡çš„å®ç°ï¼Œè¯»è€…æœ‰å…´è¶£å¯ä»¥è¯•ç€è¿™éƒ¨åˆ†çš„å®ç°å°è£…æˆjaråŒ…æˆ–è€…Spring Bootçš„starterã€‚</p>
<h3 id="4-5-åæœŸä¼˜åŒ–"><a href="#4-5-åæœŸä¼˜åŒ–" class="headerlink" title="4.5 åæœŸä¼˜åŒ–"></a>4.5 åæœŸä¼˜åŒ–</h3><p>ä¼˜åŒ–çš„åœ°æ–¹ä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ç°åœ¨çš„è®¾è®¡æ˜¯ï¼Œæ¯æ¬¡è¯·æ±‚è¿‡æ¥éƒ½ä¼šå»è°ƒç”¨authæœåŠ¡è·å–è¯¥userç›¸åº”çš„æƒé™ä¿¡æ¯ã€‚è€Œåç«¯å¾®æœåŠ¡æ•°é‡æœ‰å¾ˆå¤šï¼Œæ²¡å¿…è¦æ¯ä¸ªæœåŠ¡ï¼Œæˆ–è€…è¯´ä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œæ¯æ¬¡éƒ½å»è°ƒç”¨authæœåŠ¡ï¼Œç¬”è€…è®¤ä¸ºå®Œå…¨å¯ä»¥å¼•å…¥redisé›†ç¾¤çš„ç¼“å­˜æœºåˆ¶ï¼Œåœ¨è¯·æ±‚åˆ°è¾¾ä¸€ä¸ªæœåŠ¡çš„æŸä¸ªå®ä¾‹æ—¶ï¼Œé¦–å…ˆå»æŸ¥è¯¢å¯¹åº”çš„userçš„ç¼“å­˜ä¸­çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰å†è°ƒç”¨authæœåŠ¡ï¼Œæœ€åå†™å…¥redisç¼“å­˜ã€‚å½“ç„¶ï¼Œå¦‚æœæƒé™æ›´æ–°äº†ï¼Œåœ¨authæœåŠ¡è‚¯å®šè¦deleteç›¸åº”çš„useræƒé™ç¼“å­˜ã€‚</li>
<li>å…³äºè¢«æ‹’ç»çš„è¯·æ±‚ï¼Œåœ¨åˆ‡é¢è¡¨è¾¾å¼ä¸­ï¼Œç›´æ¥è¿”å›äº†å¯¹è±¡ï¼Œç¬”è€…è®¤ä¸ºå¯ä»¥å’Œresponse status 403è¿›è¡Œç»‘å®šï¼Œå®šåˆ¶è¿”å›å¯¹è±¡çš„å†…å®¹ï¼Œè¿”å›çš„responseæ›´åŠ å‹å¥½ã€‚</li>
</ul>
<h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. æ€»ç»“</h2><p>å¦‚ä¸Šï¼Œé¦–å…ˆè®²äº†æ•´åˆçš„è®¾è®¡æ€è·¯ï¼Œä¸»è¦åŒ…å«ä¸‰ä¸ªæœåŠ¡ï¼šgatewayã€authå’Œbackend demoã€‚æ•´åˆçš„é¡¹ç›®ï¼Œæ€»ä½“æ¯”è¾ƒå¤æ‚ï¼Œå…¶ä¸­gatewayæœåŠ¡æ‰©å……äº†å¥½å¤šå†…å®¹ï¼Œå¯¹äºæš´éœ²çš„æ¥å£è¿›è¡Œè·¯ç”±è½¬å‘ï¼Œè¿™è¾¹å¼•å…¥äº†Spring Security çš„starterï¼Œé…ç½®èµ„æºæœåŠ¡å™¨å¯¹æš´éœ²çš„è·¯å¾„è¿›è¡Œæ”¾è¡Œï¼›å¯¹äºå…¶ä»–æ¥å£éœ€è¦è°ƒç”¨authæœåŠ¡è¿›è¡Œèº«ä»½åˆæ³•æ€§æ ¡éªŒï¼Œä¿è¯åˆ°è¾¾backendçš„è¯·æ±‚éƒ½æ˜¯åˆæ³•çš„æˆ–è€…å…¬å¼€çš„æ¥å£ï¼›authæœåŠ¡åœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šï¼Œè¡¥å……äº†roleã€permissionã€userç›¸åº”çš„æ¥å£ï¼Œä¾›å¤–éƒ¨è°ƒç”¨ï¼›backend demoæ˜¯æ–°èµ·çš„æœåŠ¡ï¼Œå®ç°äº†æ¥å£çº§åˆ«çš„æ“ä½œæƒé™çš„æ ¡éªŒï¼Œä¸»è¦ç”¨åˆ°äº†è‡ªå®šä¹‰æ³¨è§£å’ŒSpring AOPåˆ‡é¢ã€‚</p>
<p>ç”±äºå®ç°çš„ç»†èŠ‚å®åœ¨æœ‰ç‚¹å¤šï¼Œæœ¬æ–‡é™äºç¯‡å¹…ï¼Œåªå¯¹éƒ¨åˆ†é‡è¦çš„å®ç°è¿›è¡Œåˆ—å‡ºä¸è®²è§£ã€‚å¦‚æœè¯»è€…æœ‰å…´è¶£å®é™…çš„åº”ç”¨ï¼Œå¯ä»¥æ ¹æ®å®é™…çš„ä¸šåŠ¡è¿›è¡Œæ‰©å¢ä¸€äº›ä¿¡æ¯ï¼Œå¦‚authæˆæƒçš„tokenã€ç½‘å…³æ‹¦æˆªè¯·æ±‚æ„é€ çš„å¤´éƒ¨ä¿¡æ¯ã€æ³¨è§£æ”¯æŒçš„è¡¨è¾¾å¼ç­‰ç­‰ã€‚</p>
<p>å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹å½“ç„¶è¿˜æœ‰å¾ˆå¤šï¼Œæ•´åˆé¡¹ç›®ä¸­è®¾è®¡ä¸åˆç†çš„åœ°æ–¹ï¼Œå„ä½åŒå­¦å¯ä»¥å¤šå¤šææ„è§ã€‚</p>
<h4 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h4><ol>
<li><a href="http://blueskykong.com/2017/11/13/gateway/">å¾®æœåŠ¡ç½‘å…³netflix-zuul</a></li>
<li><a href="http://blueskykong.com/2017/10/19/security1/">è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰</a></li>
<li><a href="http://blueskykong.com/2017/10/22/security2/">è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆäºŒï¼‰</a></li>
<li><a href="http://blueskykong.com/2017/10/24/security3/">è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸‰ï¼‰</a></li>
<li><a href="http://blueskykong.com/2017/10/26/security4/">è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆå››ï¼‰</a></li>
</ol>
<h4 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h4><p><strong>ç½‘å…³ã€authæƒé™æœåŠ¡å’ŒbackendæœåŠ¡çš„æ•´åˆé¡¹ç›®åœ°å€ä¸ºï¼š<br>GitHubï¼š<a href="https://github.com/keets2012/microservice-integration" target="_blank" rel="external">https://github.com/keets2012/microservice-integration</a><br>æˆ–è€… ç äº‘ï¼š<a href="https://gitee.com/keets/microservice-integration" target="_blank" rel="external">https://gitee.com/keets/microservice-integration</a></strong></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/12/10/integration/" data-id="cjb0vlzu80000v66q8wbetfnp" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2017/12/14/aop/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Newer</strong>
            <div class="article-nav-title">
                
                    æ·±å…¥ç†è§£Spring AOPçš„åŠ¨æ€ä»£ç†
                
            </div>
        </a>
    
    
        <a href="/2017/12/05/apm2/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">å‡ ç§åˆ†å¸ƒå¼è°ƒç”¨é“¾ç›‘æ§ç»„ä»¶çš„å®è·µä¸æ¯”è¾ƒï¼ˆäºŒï¼‰æ¯”è¾ƒ</div>
        </a>
    
</nav>


    
</article>


    
    

</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/14/aop/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/java/">java</a></p>
                            <p class="item-title"><a href="/2017/12/14/aop/" class="title">æ·±å…¥ç†è§£Spring AOPçš„åŠ¨æ€ä»£ç†</a></p>
                            <p class="item-date"><time datetime="2017-12-13T16:00:00.000Z" itemprop="datePublished">2017-12-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/10/integration/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a></p>
                            <p class="item-title"><a href="/2017/12/10/integration/" class="title">å¾®æœåŠ¡æ¶æ„ä¸­æ•´åˆç½‘å…³ã€æƒé™æœåŠ¡</a></p>
                            <p class="item-date"><time datetime="2017-12-09T16:00:00.000Z" itemprop="datePublished">2017-12-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/05/apm2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Ops/">Ops</a></p>
                            <p class="item-title"><a href="/2017/12/05/apm2/" class="title">å‡ ç§åˆ†å¸ƒå¼è°ƒç”¨é“¾ç›‘æ§ç»„ä»¶çš„å®è·µä¸æ¯”è¾ƒï¼ˆäºŒï¼‰æ¯”è¾ƒ</a></p>
                            <p class="item-date"><time datetime="2017-12-04T16:00:00.000Z" itemprop="datePublished">2017-12-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/11/20/config-server1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a></p>
                            <p class="item-title"><a href="/2017/11/20/config-server1/" class="title">å¾®æœåŠ¡ä¹‹åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒCloud Config</a></p>
                            <p class="item-date"><time datetime="2017-11-19T16:00:00.000Z" itemprop="datePublished">2017-11-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/11/18/first-timeout/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a></p>
                            <p class="item-title"><a href="/2017/11/18/first-timeout/" class="title">Spring Cloud æœåŠ¡ç¬¬ä¸€æ¬¡è¯·æ±‚è¶…æ—¶çš„ä¼˜åŒ–</a></p>
                            <p class="item-date"><time datetime="2017-11-17T16:00:00.000Z" itemprop="datePublished">2017-11-18</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Note/">Note</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ops/">Ops</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Utils/">Utils</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ä¸­é—´ä»¶/">ä¸­é—´ä»¶</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/å¾®æœåŠ¡/">å¾®æœåŠ¡</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ç®—æ³•/">ç®—æ³•</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/è®¾è®¡æ¨¡å¼/">è®¾è®¡æ¨¡å¼</a><span class="category-list-count">4</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/APM/" style="font-size: 12.5px;">APM</a> <a href="/tags/Cluster/" style="font-size: 15px;">Cluster</a> <a href="/tags/Consensus/" style="font-size: 10px;">Consensus</a> <a href="/tags/Docker/" style="font-size: 12.5px;">Docker</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/HTTP2/" style="font-size: 12.5px;">HTTP2</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jersey/" style="font-size: 12.5px;">Jersey</a> <a href="/tags/Lombok/" style="font-size: 10px;">Lombok</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/OAuth2/" style="font-size: 20px;">OAuth2</a> <a href="/tags/Ops/" style="font-size: 12.5px;">Ops</a> <a href="/tags/REST/" style="font-size: 12.5px;">REST</a> <a href="/tags/Ribbon/" style="font-size: 10px;">Ribbon</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/Spring-Cloud/" style="font-size: 17.5px;">Spring Cloud</a> <a href="/tags/Spring-Security/" style="font-size: 20px;">Spring Security</a> <a href="/tags/Thread/" style="font-size: 10px;">Thread</a> <a href="/tags/cluster/" style="font-size: 10px;">cluster</a> <a href="/tags/consul/" style="font-size: 12.5px;">consul</a> <a href="/tags/gateway/" style="font-size: 12.5px;">gateway</a> <a href="/tags/java/" style="font-size: 12.5px;">java</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/micro-service/" style="font-size: 12.5px;">micro-service</a> <a href="/tags/mq/" style="font-size: 12.5px;">mq</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/snowflake/" style="font-size: 10px;">snowflake</a> <a href="/tags/spring-boot/" style="font-size: 10px;">spring boot</a> <a href="/tags/starter/" style="font-size: 10px;">starter</a> <a href="/tags/swagger/" style="font-size: 10px;">swagger</a> <a href="/tags/utils/" style="font-size: 10px;">utils</a> <a href="/tags/zipkin/" style="font-size: 12.5px;">zipkin</a> <a href="/tags/zuul/" style="font-size: 12.5px;">zuul</a> <a href="/tags/è®¾è®¡æ¨¡å¼/" style="font-size: 17.5px;">è®¾è®¡æ¨¡å¼</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 aoho<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>