<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[å¾®æœåŠ¡ä¹‹åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒCloud Config]]></title>
    <url>%2F2017%2F11%2F20%2Fconfig-server1%2F</url>
    <content type="text"><![CDATA[1. åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ•°é‡å‰§å¢ï¼Œå…¶é…ç½®æ–‡ä»¶éœ€è¦å®ç°ç»Ÿä¸€ç®¡ç†å¹¶ä¸”èƒ½å¤Ÿå®æ—¶æ›´æ–°ï¼Œåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒç»„ä»¶å¿…ç„¶æ˜¯éœ€è¦çš„ã€‚Spring Cloudæä¾›äº†é…ç½®ä¸­å¿ƒç»„ä»¶Spring Cloud Config ï¼Œå®ƒæ”¯æŒé…ç½®æœåŠ¡æ”¾åœ¨è¿œç¨‹Gitä»“åº“å’Œæœ¬åœ°æ–‡ä»¶ä¸­ã€‚é»˜è®¤é‡‡ç”¨gitæ¥å­˜å‚¨é…ç½®ä¿¡æ¯ï¼Œç¬”è€…ç¤ºä¾‹ä¹Ÿæ˜¯é‡‡ç”¨é»˜è®¤çš„git repositoryï¼Œè¿™æ ·é€šè¿‡gitå®¢æˆ·ç«¯å·¥å…·æ¥æ–¹ä¾¿çš„ç®¡ç†å’Œè®¿é—®é…ç½®å†…å®¹ã€‚ åœ¨Spring Cloud Config ç»„ä»¶ä¸­ï¼Œæœ‰ä¸¤ä¸ªè§’è‰²ï¼Œä¸€æ˜¯Config Serveré…ç½®æœåŠ¡å™¨ï¼Œä¸ºå…¶ä»–æœåŠ¡æä¾›é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼›å¦ä¸€ä¸ªæ˜¯Config Clientå³å…¶ä»–æœåŠ¡ï¼Œå¯åŠ¨æ—¶ä»Config Serveræ‹‰å–é…ç½®ã€‚ä¸‹é¢åˆ†åˆ«ä»‹ç»ä¸‹Config Serverå’ŒConfig Clientçš„æ­å»ºå®ç°æ–¹æ³•ã€‚ 2. é…ç½®æœåŠ¡å™¨Config Server2.1 pomä¸­çš„jarsåªéœ€è¦æ·»åŠ å¦‚ä¸‹ä¸¤ä¸ªjaråŒ…çš„å¼•ç”¨ã€‚ 1234567891011121314151617&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;artifactId&gt;jsr311-api&lt;/artifactId&gt; &lt;groupId&gt;javax.ws.rs&lt;/groupId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt; &lt;/dependency&gt;&lt;/dependencies&gt; å› ä¸ºSpring Cloud ConfigæœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯æä¾›é…ç½®æ˜¯è¦é€šè¿‡æœåŠ¡å‘ç°ï¼Œæ‰€ä»¥è¿™è¾¹å¼•å…¥consulçš„starterï¼Œé…ç½®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æ³¨å†Œåˆ°consulé›†ç¾¤ä¸­ã€‚ 2.2 å…¥å£ç±»ç®€å•ï¼Œå› ä¸ºSpring Cloud æä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œé€šè¿‡spring-cloud-config-serverçš„æ³¨è§£æ¿€æ´»é…ç½®æœåŠ¡å™¨ã€‚ 12345678@SpringBootApplication@EnableDiscoveryClient@EnableConfigServerpublic class ConfigServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerApplication.class, args); &#125;&#125; @EnableConfigServeræ³¨è§£å¾ˆé‡è¦ï¼Œå°†è¯¥æœåŠ¡æ ‡æ³¨ä¸ºé…ç½®æœåŠ¡å™¨ï¼›@EnableDiscoveryClientæ³¨å†ŒæœåŠ¡ï¼Œä¾›å…¶ä»–æœåŠ¡å‘ç°è°ƒç”¨ã€‚ 2.3 bootstrap.yml1234567891011121314151617181920212223242526server: port: 8888spring: application: name: config-server cloud: consul: discovery: preferIpAddress: true enabled: true register: true service-name: config-service //... host: localhost port: 8500---spring: cloud: config: server: git: uri: https://gitee.com/keets/Config-Repo.git searchPaths: $&#123;APP_LOCATE:dev&#125; username: user password: pwd é…ç½®ç¬¬ä¸€æ®µæŒ‡å®šäº†æœåŠ¡çš„ç«¯å£ï¼›ç¬¬äºŒæ®µæ˜¯æœåŠ¡å‘ç°ç›¸å…³çš„é…ç½®ï¼›ç¬¬ä¸‰æ®µæ˜¯é…ç½®æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œè¿™é‡Œå°†é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨ç äº‘ä¸Šï¼Œé»˜è®¤çš„æœç´¢æ–‡ä»¶è·¯å¾„ä¸ºdevæ–‡ä»¶å¤¹ï¼Œå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æŒ‡å®šï¼Œå†ä¸‹é¢æ˜¯ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¬å¼€çš„é¡¹ç›®ä¸éœ€è¦è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ã€‚ è‡³æ­¤é…ç½®æœåŠ¡å™¨å·²ç»æ­å»ºå®Œæˆï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿ 3. é…ç½®çš„gitä»“åº“é…ç½®æœåŠ¡å™¨é…ç½®çš„ä»“åº“æ˜¯https://gitee.com/keets/Config-Repo.gitã€‚ç¬”è€…åœ¨è¿™ä¸ªä»“åº“ä¸­å»ºäº†ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼šdevå’Œprodã€‚å¹¶ä¸”åœ¨devæ–‡ä»¶å¤¹ä¸­æ–°å»ºäº†æ–‡ä»¶configclient-dev.ymlã€‚ä¸ºä»€ä¹ˆè¿™æ ·å‘½åï¼Œèƒ½éšä¾¿å‘½åå—ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹configæ–‡ä»¶çš„å‘½åè§„åˆ™ã€‚ URLä¸é…ç½®æ–‡ä»¶çš„æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼š /{application}/{profile}[/{label}] /{application}-{profile}.yml /{label}/{application}-{profile}.yml /{application}-{profile}.properties /{label}/{application}-{profile}.propertiesä¸Šé¢çš„urlä¼šæ˜ å°„{application}-{profile}.ymlå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œ{label}å¯¹åº”gitä¸Šä¸åŒçš„åˆ†æ”¯ï¼Œé»˜è®¤ä¸ºmasteræ¯”å¦‚Config Clientï¼Œ{application}å¯¹åº”spring.applicationï¼šconfigclientï¼Œexpå¯¹åº”{profile}ï¼Œ{label}ä¸æŒ‡å®šåˆ™é»˜è®¤ä¸ºmasterã€‚ æ–°å»ºçš„configclient-dev.ymlå¦‚ä¸‹ï¼š 12345spring: profiles: devcloud: version: Dalston.SR4 4. é…ç½®å®¢æˆ·ç«¯Config Client4.1 pomä¸­çš„jarsåªéœ€è¦æ·»åŠ å¦‚ä¸‹ä¸¤ä¸ªjaråŒ…çš„å¼•ç”¨ã€‚ 123456789101112131415161718192021 &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;artifactId&gt;jsr311-api&lt;/artifactId&gt; &lt;groupId&gt;javax.ws.rs&lt;/groupId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt; &lt;/dependencies&gt; æ–°å¢spring-boot-starter-actuatorç›‘æ§æ¨¡å—ï¼Œä¸ºäº†é…ç½®ä¿¡æ¯æ˜¯åŠ¨æ€åˆ·æ–°ï¼Œå…¶ä¸­åŒ…å«äº†/refreshåˆ·æ–°APIã€‚å…¶ä»–å’Œé…ç½®æœåŠ¡å™¨ä¸­æ·»åŠ çš„ç›¸åŒï¼Œæ²¡å•¥å¯è¯´ã€‚ 4.2 å…¥å£ç±»ç®€å•ï¼Œå› ä¸ºSpring Cloud æä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œé€šè¿‡spring-cloud-config-serverçš„æ³¨è§£æ¿€æ´»é…ç½®æœåŠ¡å™¨ã€‚ 1234567@SpringBootApplication@EnableDiscoveryClientpublic class ConfigServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ConfigServerApplication.class, args); &#125;&#125; é…ç½®å®¢æˆ·ç«¯ä¸éœ€è¦@EnableConfigServeræ³¨è§£ã€‚ 4.3 bootstrap.yml123456789101112131415161718192021222324252627282930313233343536373839404142server: port: 9901cloud: version: Brixton SR7spring: cloud: consul: discovery: preferIpAddress: true enabled: true register: true service-name: config-client //... host: localhost port: 8500---spring: profiles: active: dev application: #appåç§° name: configclient cloud: config: #æŒ‡å®šprofile profile: dev label: master discovery: enabled: true #serverå service-id: config-service enabled: true fail-fast: true---spring: profiles: default application: name: configclient ä»ä¸Šé¢é…ç½®å¯ä»¥çœ‹å‡ºæˆ‘ä»¬æ‰€æ¿€æ´»çš„profileæ˜¯devï¼Œé…ç½®çš„é…ç½®æœåŠ¡åä¸ºconfig-serviceï¼ŒæŒ‡å®šä»masteråˆ†æ”¯æ‹‰å–é…ç½®ã€‚æ‰€ä»¥configclientå¯åŠ¨æ—¶ä¼šå»é…ç½®æœåŠ¡å™¨ä¸­æ‹‰å–å¯¹åº”çš„configclient-devçš„é…ç½®æ–‡ä»¶ä¿¡æ¯ã€‚ 4.4 TestResourceç¬”è€…æ–°å»ºäº†ä¸€ä¸ªTestResourceï¼Œå¯¹åº”çš„APIç«¯ç‚¹ä¸º/api/testã€‚ 1234567@Value("$&#123;cloud.version&#125;")private String version;@GetMapping("/test")public String from() &#123; return version;&#125; cloud.versionå¯ä»¥åœ¨ä¸Šé¢çš„é…ç½®æ–‡ä»¶çœ‹åˆ°é»˜è®¤æŒ‡å®šçš„æ˜¯Brixton SR7ï¼Œè€Œç¬”è€…åœ¨é…ç½®ä¸­å¿ƒè®¾ç½®çš„å€¼ä¸ºDalston.SR4ã€‚ 5. æµ‹è¯•ç»“æœ5.1 è·å–é…ç½®é¦–å…ˆçœ‹ä¸€ä¸‹é…ç½®å®¢æˆ·ç«¯å¯åŠ¨æ—¶çš„æ—¥å¿—ä¿¡æ¯ï¼Œæ˜¯ä¸æ˜¯çœŸçš„æŒ‰ç…§æˆ‘ä»¬é…ç½®çš„ï¼Œä»é…ç½®æœåŠ¡å™¨æ‹‰å–configclient-devä¿¡æ¯ã€‚ ä»æ—¥å¿—çœ‹æ¥ï¼Œæ˜¯ç¬¦åˆçš„ä¸Šé¢çš„é…ç½®çŒœæƒ³çš„ã€‚æˆ‘ä»¬å†ä»é…ç½®å®¢æˆ·ç«¯æä¾›çš„APIæ¥å£è¿›ä¸€æ­¥éªŒè¯ã€‚ å¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯Dalston.SR4ï¼Œé…ç½®æœåŠ¡èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚ 5.2 åŠ¨æ€åˆ·æ–°é…ç½®Spring Cloud Configè¿˜å¯ä»¥å®ç°åŠ¨æ€æ›´æ–°é…ç½®çš„åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬ä¿®æ”¹ä¸‹Config Repoä¸­çš„cloud.versioné…ç½®ä¸ºCamden SR7ï¼Œå¹¶é€šè¿‡åˆ·æ–°config clientçš„/refreshç«¯ç‚¹æ¥åº”ç”¨é…ç½®ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ç»“æœæ˜¯é¢„æœŸæ‰€æƒ³ã€‚ è¿™è¾¹é…ç½®çš„åˆ·æ–°æ˜¯é€šè¿‡æ‰‹å·¥å®Œæˆäº†ï¼Œè¿˜å¯ä»¥åˆ©ç”¨githookè¿›è¡Œè§¦å‘ã€‚å½“æœ¬åœ°æäº¤ä»£ç åˆ°gitåï¼Œè°ƒç”¨äº†ä¸‹å›¾è®¾ç½®çš„urlã€‚æœ‰ä¸¤ä¸ªç«¯ç‚¹å¯ä»¥ä½¿ç”¨ï¼š refreshï¼šä»¥postæ–¹å¼æ‰§è¡Œ/refresh ä¼šåˆ·æ–°envä¸­çš„é…ç½® restartï¼šå¦‚æœé…ç½®ä¿¡æ¯å·²ç»æ³¨å…¥åˆ°beanä¸­ï¼Œç”±äºbeanæ˜¯å•ä¾‹çš„ï¼Œä¸ä¼šå»åŠ è½½ä¿®æ”¹åçš„é…ç½®éœ€è¦é€šè¿‡postæ–¹å¼å»æ‰§è¡Œ/restart, è¿˜éœ€è¦é…ç½®endpoints.restart.enabled: trueã€‚ ç¬¬äºŒç§æƒ…å†µæ¯”è¾ƒè€—æ—¶ï¼Œ@RefreshScopeæ˜¯spring cloudæä¾›çš„æ³¨è§£ï¼Œåœ¨æ‰§è¡Œrefreshæ—¶ä¼šåˆ·æ–°beanä¸­å˜é‡å€¼ã€‚ Convenience annotation to put a @Bean definition in RefreshScope. Beans annotated this way can be refreshed at runtime and any components that are using them will get a new instance on the next method call, fully initialized and injected with all dependencies. ä¸Šé¢è¯´äº†RefreshScopeæ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„beanæ³¨è§£ï¼ŒåŠ ä¸Šè¿™ä¸ªæ³¨è§£å¯ä»¥åœ¨è¿è¡Œæ€åˆ·æ–°beanã€‚å…¶ä»–ä½¿ç”¨è¯¥beançš„componentsä¸‹æ¬¡è°ƒç”¨æ—¶ä¼šè·å–ä¸€ä¸ªå·²ç»è¢«åˆå§‹åŒ–å¥½å’Œæ³¨å…¥çš„æ–°å®ä¾‹å¯¹è±¡ã€‚ githookè®¾ç½®é¡µé¢å¦‚ä¸‹ã€‚ 6. æ€»ç»“æœ¬æ–‡ä¸»è¦è®²äº†é…ç½®æœåŠ¡å™¨å’Œé…ç½®å®¢æˆ·ç«¯çš„æ­å»ºè¿‡ç¨‹ï¼Œæœ€åé€šè¿‡é…ç½®å®¢æˆ·ç«¯çš„æ—¥å¿—å’Œç«¯ç‚¹ä¿¡æ¯éªŒè¯æ˜¯å¦èƒ½æˆåŠŸä½¿ç”¨é…ç½®æœåŠ¡ä¸­å¿ƒã€‚æ€»ä½“æ¥è¯´ï¼Œéå¸¸ç®€å•ã€‚æ–‡ä¸­çš„éƒ¨åˆ†é…ç½®æ²¡æœ‰å†™å®Œæ•´ï¼Œè¯»è€…éœ€è¦å¯ä»¥çœ‹æ–‡æœ«çš„gité¡¹ç›®ã€‚ ä¸è¿‡å…³äºé…ç½®ä¸­å¿ƒï¼Œæœ¬æ–‡çš„è®²è§£å¹¶ä¸å®Œæ•´ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šè®²è§£é…ç½®æœåŠ¡å™¨ä¸æ¶ˆæ¯æ€»çº¿çš„ç»“åˆä½¿ç”¨ï¼Œå®ç°å¯¹é…ç½®å®¢æˆ·ç«¯çš„è‡ªåŠ¨æ›´æ–°åŠç°åº¦å‘å¸ƒç­‰åŠŸèƒ½ã€‚ æœ¬æ–‡æºç github: https://github.com/keets2012/Spring-Boot-Samples/gitee: https://gitee.com/keets/spring-boot-samples/ å‚è€ƒ Spring Cloud Config åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Cloud æœåŠ¡ç¬¬ä¸€æ¬¡è¯·æ±‚è¶…æ—¶çš„ä¼˜åŒ–]]></title>
    <url>%2F2017%2F11%2F18%2Ffirst-timeout%2F</url>
    <content type="text"><![CDATA[1. é—®é¢˜èƒŒæ™¯ä½¿ç”¨Spring Cloudç»„ä»¶æ„å»ºçš„æœåŠ¡é›†ç¾¤ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ç»å¸¸ä¼šå‡ºç°timeoutçš„æƒ…å†µï¼Œç„¶è€Œç¬¬äºŒæ¬¡å°±æ­£å¸¸äº†ã€‚Spring Cloudç‰ˆæœ¬ä¸ºDalston.SR4ã€‚ å¯åŠ¨æ¶‰åŠåˆ°çš„ç›¸å…³æœåŠ¡ï¼š gateway(zuulç½‘å…³) auth-Serviceï¼ˆé‰´æƒæœåŠ¡ï¼‰ user-Serviceï¼ˆç”¨æˆ·æœåŠ¡ï¼‰ æµ‹è¯•çš„ç«¯ç‚¹æ¥å£ä¸ºï¼šhttp:/login/oauth/tokenã€‚æœåŠ¡ä¹‹é—´çš„è°ƒç”¨é¡ºåºä¸ºï¼šgateway-&gt;auth-Service-&gt;user-Serviceã€‚ç½‘å…³æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè½¬å‘è¯·æ±‚åˆ°é‰´æƒæœåŠ¡ï¼Œé‰´æƒæœåŠ¡å¯¹ç”¨æˆ·èº«ä»½çš„æ ¸éªŒæ˜¯é€šè¿‡è°ƒç”¨ç”¨æˆ·æœï¼Œç”¨æˆ·æœåŠ¡ç»™é‰´æƒæœåŠ¡è¿”å›èº«ä»½æ ¡éªŒçš„ç»“æœï¼Œé‰´æƒæœåŠ¡å°†èº«ä»½æˆæƒä¿¡æ¯è¿”å›ç»™gatewayï¼Œgatewayå°†æœ€ç»ˆçš„ç»“æœresponseè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ä¸‰ä¸ªæœåŠ¡å¯åŠ¨åï¼Œé€šè¿‡zipkinç›‘æ§è°ƒç”¨é“¾è·¯ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡è°ƒç”¨æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é€šè¿‡ä¸Šé¢ä¸¤æ¬¡çš„é“¾è·¯ç›‘æ§ä¿¡æ¯æˆªå›¾ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡çš„è€—æ—¶æ˜¯ç¬¬äºŒæ¬¡çš„10å¤šå€ã€‚é‡åˆ°æŸäº›æƒ…å†µï¼Œå¾ˆå¯èƒ½ä¼šå‡ºç°ç¬¬ä¸€æ¬¡è¯·æ±‚çš„è¶…æ—¶ã€‚å»å®˜ç½‘çœ‹äº†ä¸‹ï¼Œä¸»è¦åŸå› æ˜¯zuulç½‘å…³å’Œå„ä¸ªè°ƒç”¨æœåŠ¡ä¹‹é—´çš„Ribbonè¿›è¡Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„Clientæ‡’åŠ è½½ï¼Œå¯¼è‡´ç¬¬ä¸€æ¬¡çš„è¯·æ±‚è°ƒç”¨åŒ…æ‹¬äº†åˆ›å»ºRibbon Clientçš„æ—¶é—´ã€‚é€šè¿‡å¯åŠ¨æ—¥å¿—ä¿¡æ¯å°±å¯ä»¥å‘ç°ï¼š ä¸‹é¢åˆ†ä¸¤éƒ¨åˆ†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€æ˜¯æœåŠ¡ä¹‹é—´è°ƒç”¨Ribbonçš„é¥¥é¥¿åŠ è½½ï¼Œå¯¹åº”ä¸Šé¢çš„æµ‹è¯•ä¸ºauth-Serviceè°ƒç”¨user-Serviceï¼›äºŒæ˜¯zuulç½‘å…³çš„é¥¥é¥¿åŠ è½½ã€‚ 2. ribbonçš„é¥¥é¥¿åŠ è½½ç»è¿‡è°ƒæŸ¥å‘ç°ï¼Œé€ æˆç¬¬ä¸€æ¬¡auth-Serviceè°ƒç”¨user-Serviceè€—æ—¶é•¿çš„åŸå› ä¸»è¦æ˜¯ï¼ŒRibbonè¿›è¡Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„æœåŠ¡å®ä¾‹å¹¶ä¸æ˜¯åœ¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™å°±åˆå§‹åŒ–å¥½çš„ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨çš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºç›¸åº”çš„æœåŠ¡å®ä¾‹ã€‚æ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨user-Serviceè€—æ—¶ä¸ä»…ä»…åŒ…å«å‘é€HTTPè¯·æ±‚çš„æ—¶é—´ï¼Œè¿˜åŒ…å«äº†åˆ›å»ºRibbon Clientçš„æ—¶é—´ï¼Œè¿™æ ·ä¸€æ¥å¦‚æœåˆ›å»ºæ—¶é—´é€Ÿåº¦è¾ƒæ…¢ï¼ŒåŒæ—¶è®¾ç½®çš„è¯·æ±‚è¶…æ—¶åˆæ¯”è¾ƒçŸ­çš„è¯ï¼Œå¾ˆå®¹æ˜“å°±ä¼šå‡ºç°è€—æ—¶å¾ˆé•¿ç”šè‡³è¶…æ—¶çš„æƒ…å†µã€‚åœ¨å®˜ç½‘å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„é…ç½®è¯´æ˜ï¼š Each Ribbon named client has a corresponding child Application Context that Spring Cloud maintains, this application context is lazily loaded up on the first request to the named client. This lazy loading behavior can be changed to instead eagerly load up these child Application contexts at startup by specifying the names of the Ribbon clients. æ„ä¸ºSpring Cloudä¸ºæ¯ä¸ªRibbonå®¢æˆ·ç«¯ç»´æŠ¤äº†ä¸€ä¸ªç›¸å¯¹çš„å­åº”ç”¨ç¯å¢ƒçš„ä¸Šä¸‹æ–‡ï¼Œåº”ç”¨çš„ä¸Šä¸‹æ–‡åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚åˆ°æŒ‡å®šå®¢æˆ·ç«¯çš„æ—¶å€™æ‡’åŠ è½½ã€‚ä¸è¿‡å¯ä»¥é€šè¿‡å¦‚ä¸‹é…ç½®è¿›è¡Œä¿®æ”¹ï¼š 1234ribbon: eager-load: enabled: true clients: client1, client2, client3 æŒ‰ç…§å¦‚ä¸Šçš„é…ç½®ä¹‹åï¼Œå‘ç°é‰´æƒæœåŠ¡å¯åŠ¨æ—¶å°±å°†useræœåŠ¡çš„Ribbonå®¢æˆ·ç«¯è¿›è¡Œäº†åŠ è½½ã€‚ 3. zuulç½‘å…³çš„é¥¥é¥¿åŠ è½½ä¸Šé¢å°èŠ‚è§£å†³äº†auth-Serviceè°ƒç”¨user-Serviceçš„Ribbonå®¢æˆ·ç«¯å¯åŠ¨æ—¶é¥¥é¥¿åŠ è½½ã€‚ç½‘å…³ä½œä¸ºå¯¹å¤–è¯·æ±‚çš„å…¥å£ï¼Œzuulå†…éƒ¨ä½¿ç”¨Ribbonè°ƒç”¨å…¶ä»–æœåŠ¡ï¼ŒSpring Cloudé»˜è®¤åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‡’åŠ è½½Ribbonå®¢æˆ·ç«¯ã€‚zuulåŒæ ·éœ€è¦ç»´æŠ¤ä¸€ä¸ªç›¸å¯¹çš„å­åº”ç”¨ç¯å¢ƒçš„ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å¯åŠ¨æ—¶é¥¥é¥¿åŠ è½½ã€‚ Zuul internally uses Ribbon for calling the remote urlâ€™s and Ribbon clients are by default lazily loaded up by Spring Cloud on first call. This behavior can be changed for Zuul using the following configuration and will result in the child Ribbon related Application contexts being eagerly loaded up at application startup time. å…·ä½“é…ç½®å¦‚ä¸‹ï¼š 1234zuul: ribbon: eager-load: enabled: true è‡³æ­¤ï¼Œä¼˜åŒ–å®Œæˆï¼Œå†æ¬¡é‡å¯æœåŠ¡è¿›è¡Œç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œå‘ç°æƒ…å†µå·²ç»å¥½å¤šäº†ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±åŠ¨æ‰‹å°è¯•æ”¹è¿›ä¸€ä¸‹ã€‚ 4. æ€»ç»“æœ¬æ–‡ä¸»è¦ä»‹ç»äº†Spring Cloudçš„æœåŠ¡ç¬¬ä¸€æ¬¡è¯·æ±‚è¶…æ—¶çš„ä¼˜åŒ–æ–¹æ³•ã€‚é¦–å…ˆä»‹ç»äº†é—®é¢˜çš„èƒŒæ™¯ï¼Œå¹¶æ’æŸ¥äº†é—®é¢˜é€ æˆçš„åŸå› ï¼Œä¸»è¦æ˜¯Ribbonå®¢æˆ·ç«¯çš„æ‡’åŠ è½½ï¼›ç„¶ååˆ†åˆ«é’ˆå¯¹zuulç½‘å…³å’ŒæœåŠ¡ä¹‹é—´è°ƒç”¨çš„Ribbonå®¢æˆ·ç«¯è¿›è¡Œé…ç½®ï¼Œä½¿å…¶å¯åŠ¨æ—¶ä¾¿åŠ è½½Ribbonå®¢æˆ·ç«¯çš„ç›¸å…³ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚æœ€åæƒ³è¯´çš„æ˜¯ï¼Œhttpè°ƒç”¨æ¯•ç«Ÿè¿˜æ˜¯æ€§èƒ½è¿œä½äºRPCã€‚ã€‚ğŸ™‚ å‚è€ƒ spring-cloud Dalston.SR4 Spring Cloudå®æˆ˜å°è´´å£«ï¼šRibbonçš„é¥¥é¥¿åŠ è½½(eager-load)æ¨¡å¼]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
        <tag>Ribbon</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¾®æœåŠ¡ä¹‹é…ç½®æœåŠ¡å™¨åˆ‡æ¢profile]]></title>
    <url>%2F2017%2F11%2F16%2Fprofile%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘é‡åˆ°Spring-bootçš„å¤šä¸ªprofileåˆ‡æ¢é—®é¢˜ï¼Œéœ€æ±‚æ˜¯è¿™æ ·çš„ï¼šå¾®æœåŠ¡ä¸­å¼•å…¥äº†Spring Cloud Configï¼ŒæœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œä»Config Serverä¸­è¯»å–è¯¥å®ä¾‹å¯¹åº”çš„é…ç½®ä¿¡æ¯ã€‚æœ¬åœ°å¼€å‘ç¯å¢ƒå¯èƒ½ä½¿ç”¨çš„profileæ˜¯defaultï¼Œåˆ°äº†é›†æˆæµ‹è¯•ç¯å¢ƒå°±éœ€è¦åˆ‡æ¢åˆ°jenkinsï¼Œåˆ°äº†é¢„å‘å¸ƒç¯å¢ƒåˆå˜æˆäº†prodã€‚å¤šä¸ªprofileéœ€è¦ä¹‹é—´å¯ä»¥åˆ‡æ¢ã€‚ è¿™è¾¹è®¾ç½®çš„æ—¶å€™è¿˜èµ°äº†ç‚¹å¼¯è·¯ï¼Œå…ˆæ˜¯æ¢ç´¢äº†ä¸€épomçš„profileï¼Œåæ¥æ‰åˆ°Spring-bootçš„é…ç½®æ–‡ä»¶ã€‚ è¿™ä¸¤éƒ¨åˆ†å®ç°çš„åŠŸèƒ½ä¸å¤ªä¸€æ ·ï¼Œæœ¬æ–‡å°†ä¼šå…·ä½“è®²ä¸‹è¿™ä¸¤éƒ¨åˆ†ã€‚ 1. profileä¹‹Maven mavenåˆ‡æ¢profileçš„å‘½ä»¤å¾ˆç®€å•ï¼ŒåŠ ä¸Š-På‚æ•°æŒ‡å®šä½ çš„profileï¼Œå¦‚æŒ‡å®šprodï¼š 1mvn clean package -P prod mavenä½¿ç”¨åå­—ä¸ºprodçš„profileæ¥æ‰“åŒ…ï¼Œå³æ‰€æœ‰çš„é…ç½®æ–‡ä»¶éƒ½ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒã€‚ ä¸‹é¢çœ‹ä¸‹pomä¸­çš„profilesï¼š 12345678910111213141516171819202122232425262728293031 &lt;profiles&gt; &lt;profile&gt; &lt;id&gt;dev&lt;/id&gt; &lt;activation&gt; &lt;activeByDefault&gt;true&lt;/activeByDefault&gt; &lt;/activation&gt; &lt;properties&gt; &lt;profileActive&gt;dev&lt;/profileActive&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt; &lt;optional&gt;true&lt;/optional&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/profile&gt; &lt;profile&gt; &lt;id&gt;prod&lt;/id&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-undertow&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;properties&gt; &lt;profileActive&gt;prod&lt;/profileActive&gt; &lt;/properties&gt; &lt;/profile&gt;&lt;/profiles&gt; å¯¹äºresourcesçš„é…ç½®å¦‚ä¸‹ï¼š 12345678910111213141516171819202122 &lt;build&gt; &lt;resources&gt; &lt;resource&gt; &lt;directory&gt;src/main/resources&lt;/directory&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;!-- è¿‡æ»¤æ‰æ‰€æœ‰é…ç½®æ–‡ä»¶--&gt; &lt;excludes&gt; &lt;exclude&gt;application-dev.yml&lt;/exclude&gt; &lt;exclude&gt;application-prod.yml&lt;/exclude&gt; &lt;/excludes&gt; &lt;/resource&gt; &lt;resource&gt; &lt;filtering&gt;true&lt;/filtering&gt; &lt;directory&gt;src/main/resources&lt;/directory&gt; &lt;!--æ ¹æ®profileä¸­çš„å˜é‡profileActiveæŒ‡å®šå¯¹åº”çš„é…ç½®æ–‡ä»¶--&gt; &lt;includes&gt; &lt;include&gt;application-$&#123;profileActive&#125;.yml&lt;/include&gt; &lt;/includes&gt; &lt;/resource&gt; &lt;/resources&gt; &lt;/build&gt; ä¸Šé¢çš„ä¸¤æ®µpomé…ç½®ç›¸ç»“åˆï¼Œå½“æŒ‡å®šprofileä¸ºprodæ—¶ï¼Œç¯å¢ƒå˜é‡profileActiveçš„å±æ€§å€¼å˜ä¸ºprodã€‚æŒ‡å®šæ‰“åŒ…æ—¶ï¼ŒåŒ…å«application-prod.ymlã€‚ æ‰€ä»¥å½“ä½ æœ‰å¤šå¥—é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åŠ¨æ€æ ¹æ®mvnå‘½ä»¤çš„å‚æ•°-PåŠ¨æ€æŒ‡å®šä½ æ‰€éœ€è¦åŠ è½½çš„é…ç½®æ–‡ä»¶ã€‚ 2. profileä¹‹Spring bootProfileæ˜¯Spring bootç”¨æ¥é’ˆå¯¹ä¸åŒç¯å¢ƒå¯¹ä¸åŒé…ç½®æä¾›æ”¯æŒçš„,å…¨å±€Profileé…ç½®ä½¿ç”¨ã€‚application-{profile}.yml å¦‚:application-ymlã€‚ springé€šè¿‡é…ç½®spring.profiles.activeæŒ‡å®šæ¿€æ´»æŸä¸ªå…·ä½“çš„profileã€‚é™¤äº†spring.profiles.activeæ¥æ¿€æ´»ä¸€ä¸ªæˆ–è€…å¤šä¸ªprofileä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨spring.profiles.includeæ¥å åŠ profileã€‚ 1spring.profiles.include: prod,dev ä¸‹é¢çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„application.ymlä¸­åŒ…å«çš„é…ç½®ï¼š 1234567891011121314151617181920212223spring: profiles: active: dev---#å¼€å‘ç¯å¢ƒé…ç½®spring: profiles: devserver: port: 8080---#æµ‹è¯•ç¯å¢ƒé…ç½®spring: profiles: testserver: port: 8081---#ç”Ÿäº§ç¯å¢ƒé…ç½®spring: profiles: prodserver: port: 8082 application.ymlæ–‡ä»¶åˆ†ä¸ºå››éƒ¨åˆ†ï¼Œä½¿ç”¨ä¸€ç»„(â€”)æ¥ä½œä¸ºåˆ†éš”ç¬¦ã€‚ç¬¬ä¸€éƒ¨åˆ†ï¼Œé€šç”¨é…ç½®éƒ¨åˆ†ï¼Œè¡¨ç¤ºä¸‰ä¸ªç¯å¢ƒéƒ½é€šç”¨çš„å±æ€§ï¼Œé»˜è®¤æ¿€æ´»äº†devçš„profileï¼›åé¢ä¸‰éƒ¨åˆ†åˆ†åˆ«è¡¨ç¤ºä¸åŒçš„ç¯å¢ƒï¼ŒæŒ‡å®šäº†ä¸åŒçš„portã€‚ éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„è¯ï¼Œæ­£å¸¸ä¼šæ‰“æˆjaråŒ…ï¼ŒåŠ ä¸Šå‚æ•°--spring.profiles.active=testæŒ‡å®šåŠ è½½å“ªä¸ªç¯å¢ƒçš„é…ç½®ã€‚ åœ¨IDEä¸­ä¹Ÿå¯ä»¥ç›´æ¥é…ç½®æ¿€æ´»çš„profileã€‚ 3. config serverçš„é…ç½®è¿™èŠ‚è®²ä¸‹ä¸Spring cloud configçš„ç»“åˆä½¿ç”¨ã€‚æ—¢ç„¶ä½¿ç”¨äº†config serverï¼ŒåŠ¨æ€é…ç½®è¿™å—åŸºæœ¬å°±ç”±é…ç½®æœåŠ¡å™¨å®Œæˆäº†ã€‚é…ç½®æœåŠ¡å™¨ä¸­å¯¹è¯¥æœåŠ¡æŒ‡å®šå¤šä¸ªprofileã€‚config Serverä¸­çš„é…ç½®ä¼˜å…ˆäºæœ¬åœ°é…ç½®ï¼Œå½“æœåŠ¡å¯åŠ¨æ—¶ï¼Œæ ¹æ®æ¿€æ´»çš„profileï¼Œå»é…ç½®æœåŠ¡å™¨æ‹‰å–å…¶å¯¹åº”çš„é…ç½®ã€‚ æ—¢ç„¶çŸ¥é“äº†ä¸Šé¢çš„ä¸»è¦æµç¨‹ï¼Œå°±å¯ä»¥æ˜ç™½æˆ‘ä»¬çš„éœ€æ±‚å…¶å®æ˜¯è¦åœ¨æœåŠ¡å¯åŠ¨æ—¶æŒ‡å®šæ¿€æ´»çš„profileã€‚æ‰€ä»¥ä¸Šé¢ä¸€èŠ‚å…³äºSpring bootçš„profileåŠ¨æ€é…ç½®ï¼Œæˆ‘ä»¬çš„é—®é¢˜å°±èƒ½è§£å†³äº†ã€‚ä½†ä¸Šé¢è®²åˆ°çš„æ˜¯jaråŒ…å¯åŠ¨æ—¶æŒ‡å®š--spring.profiles.activeï¼Œå®é™…éƒ½æ˜¯å¾®æœåŠ¡çš„å®¹å™¨åŒ–éƒ¨ç½²ï¼ŒæœåŠ¡é€šè¿‡å®¹å™¨ç›´æ¥å¯åŠ¨jaråŒ…ï¼Œè¿™æ ·å°±éœ€è¦å®¹å™¨å¯åŠ¨çš„æ—¶å€™èƒ½å¤ŸåŠ¨æ€æŒ‡å®šactive profileï¼Œæ‰€ä»¥ä¸Šé¢çš„é…ç½®æ”¹ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š 123spring: profiles: active: $&#123;ACTIVE_PROFILE:dev&#125; ä»å®¹å™¨çš„å¯åŠ¨æˆªå›¾æ¥çœ‹ï¼ŒæŒ‡å®šäº†docker run -d -e ACTIVE_PROFILE=exp ...åï¼Œactive profile å˜å‘³äº†expï¼Œå¹¶ä¸”ä»config serverä¸­æ‹‰å–å¯¹åº”çš„æ˜¯gatewayserverçš„expé…ç½®ã€‚ 4. æ€»ç»“æœ¬æ–‡ä¸»è¦å†™äº†Spring-booté…ç½®æœåŠ¡å™¨åˆ‡æ¢profileã€‚é¦–å…ˆæè¿°äº†éœ€æ±‚èƒŒæ™¯ï¼Œç„¶åæ˜¯å¯¹maven pomä¸­profileè¿›è¡Œäº†æ¢ç´¢ä¸è®²è§£ï¼Œå…¶æ¬¡æ˜¯è®²è§£äº†Spring-bootä¸­çš„profileåˆ‡æ¢ï¼Œæœ€åç»“åˆconfig serverå®ç°å®¹å™¨éƒ¨ç½²å¾®æœåŠ¡çš„profileã€‚ç¬”è€…æœ€å¼€å§‹ä¸€ç›´è®¤ä¸ºé€šè¿‡pomçš„profileåˆ‡æ¢å°±å¯ä»¥è®¾ç½®æœåŠ¡å¯åŠ¨çš„profileï¼Œç»è¿‡ä¸€ç•ªæ¢ç´¢ï¼Œå‘ç°ä¸é…ç½®æœåŠ¡å™¨ç»“åˆå¥½åƒå¹¶ä¸éœ€è¦pomçš„profileè¿™ä¹ˆç¹çï¼Œç»“åˆé…ç½®æœåŠ¡å™¨å¯ä»¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨Spring bootçš„profileã€‚ å‚è€ƒ è¯¦è§£Spring Boot Profiles é…ç½®å’Œä½¿ç”¨ [Spring Boot ç³»åˆ—] é›†æˆmavenå’ŒSpring bootçš„profileåŠŸèƒ½]]></content>
      <categories>
        <category>Ops</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
        <tag>Docker</tag>
        <tag>Ops</tag>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¾®æœåŠ¡ç½‘å…³netflix-zuul]]></title>
    <url>%2F2017%2F11%2F13%2Fgateway%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ï¼šå‰é¢ä¸€ä¸ªç³»åˆ—æ–‡ç« ä»‹ç»äº†è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç° ï¼Œå¥½å¤šåŒå­¦è¯¢é—®æœ‰æ²¡æœ‰å®Œæ•´çš„demoé¡¹ç›®ï¼Œç¬”è€…å›ç­”è‚¯å®šæœ‰çš„ã€‚ç”±äºä¹‹å‰ç³»åˆ—æ–‡ç« ä¾§é‡è®²è§£äº†æƒé™å‰ç½®ï¼Œæ‰€ä»¥è¿‘æœŸè¡¥ä¸Šå®Œæ•´çš„åç½®é¡¹ç›®ï¼Œä½†æ˜¯è¿™æœ€å¥½æœ‰ä¸€ä¸ªå®Œæ•´çš„å¾®æœåŠ¡è°ƒç”¨ã€‚æœ¬æ–‡ä¸»è¦è®²ä¸‹APIç½‘å…³çš„è®¾è®¡ä¸å®ç°ã€‚netflix-zuulæ˜¯ç”±netflixå¼€æºçš„APIç½‘å…³ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œç½‘å…³ä½œä¸ºå¯¹å¤–çš„é—¨æˆ·ï¼Œå®ç°åŠ¨æ€è·¯ç”±ã€ç›‘æ§ã€æˆæƒã€å®‰å…¨ã€è°ƒåº¦ç­‰åŠŸèƒ½ã€‚ 1. ç½‘å…³ä»‹ç»å½“ä½¿ç”¨å•ä½“åº”ç”¨ç¨‹åºæ¶æ„æ—¶ï¼Œå®¢æˆ·ç«¯ï¼ˆwebå’Œç§»åŠ¨ç«¯ï¼‰é€šè¿‡å‘åç«¯åº”ç”¨ç¨‹åºå‘èµ·ä¸€æ¬¡RESTè°ƒç”¨æ¥è·å–æ•°æ®ã€‚è´Ÿè½½å‡è¡¡å™¨å°†è¯·æ±‚è·¯ç”±ç»™Nä¸ªç›¸åŒçš„åº”ç”¨ç¨‹åºå®ä¾‹ä¸­çš„ä¸€ä¸ªã€‚ç„¶ååº”ç”¨ç¨‹åºä¼šæŸ¥è¯¢å„ç§æ•°æ®åº“è¡¨ï¼Œå¹¶å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œå•ä½“åº”ç”¨è¢«åˆ‡å‰²æˆå¤šä¸ªå¾®æœåŠ¡ï¼Œå¦‚æœå°†æ‰€æœ‰çš„å¾®æœåŠ¡ç›´æ¥å¯¹å¤–æš´éœ²ï¼ŒåŠ¿å¿…ä¼šå‡ºç°å®‰å…¨æ–¹é¢çš„å„ç§é—®é¢˜ã€‚å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥å‘æ¯ä¸ªå¾®æœåŠ¡å‘é€è¯·æ±‚ï¼Œå…¶é—®é¢˜ä¸»è¦å¦‚ä¸‹ï¼š å®¢æˆ·ç«¯éœ€æ±‚å’Œæ¯ä¸ªå¾®æœåŠ¡æš´éœ²çš„ç»†ç²’åº¦APIä¸åŒ¹é…ã€‚ éƒ¨åˆ†æœåŠ¡ä½¿ç”¨çš„åè®®ä¸æ˜¯Webå‹å¥½åè®®ã€‚å¯èƒ½ä½¿ç”¨ThriftäºŒè¿›åˆ¶RPCï¼Œä¹Ÿå¯èƒ½ä½¿ç”¨AMQPæ¶ˆæ¯ä¼ é€’åè®®ã€‚ å¾®æœåŠ¡éš¾ä»¥é‡æ„ã€‚å¦‚æœåˆå¹¶ä¸¤ä¸ªæœåŠ¡ï¼Œæˆ–è€…å°†ä¸€ä¸ªæœåŠ¡æ‹†åˆ†æˆä¸¤ä¸ªæˆ–æ›´å¤šæœåŠ¡ï¼Œè¿™ç±»é‡æ„å°±éå¸¸å›°éš¾äº†ã€‚ å¦‚ä¸Šé—®é¢˜ï¼Œè§£å†³çš„æ–¹æ³•æ˜¯ä½¿ç”¨APIç½‘å…³ã€‚APIç½‘å…³æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œæ˜¯ç³»ç»Ÿçš„å”¯ä¸€å…¥å£ã€‚ä»é¢å‘å¯¹è±¡è®¾è®¡çš„è§’åº¦çœ‹ï¼Œå®ƒä¸å¤–è§‚æ¨¡å¼ç±»ä¼¼ã€‚APIç½‘å…³å°è£…äº†ç³»ç»Ÿå†…éƒ¨æ¶æ„ï¼Œä¸ºæ¯ä¸ªå®¢æˆ·ç«¯æä¾›ä¸€ä¸ªå®šåˆ¶çš„APIã€‚å®ƒå¯èƒ½è¿˜å…·æœ‰å…¶å®ƒèŒè´£ï¼Œå¦‚èº«ä»½éªŒè¯ã€ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€é™æµã€é™çº§ä¸åº”ç”¨æ£€æµ‹ã€‚ 2. zuulç½‘å…³API Gatewayï¼Œå¸¸è§çš„é€‰å‹æœ‰åŸºäº Openresty çš„ Kongå’ŒåŸºäº JVM çš„ Zuulï¼Œå…¶ä»–è¿˜æœ‰åŸºäºGoçš„Tykã€‚æŠ€æœ¯é€‰å‹ä¸Šï¼Œä¹‹å‰ç¨å¾®è°ƒç ”äº†Kongï¼Œæ€§èƒ½è¿˜å¯ä»¥ã€‚è€ƒè™‘åˆ°å¿«é€Ÿåº”ç”¨å’ŒäºŒæ¬¡å¼€å‘ï¼Œnetflix-zuulä¹Ÿåœ¨Spring Cloudçš„å…¨å®¶æ¡¶ä¸­ï¼Œå’Œå…¶ä»–ç»„ä»¶é…åˆä½¿ç”¨è¿˜æŒºæ–¹ä¾¿ï¼ŒåæœŸå¯èƒ½è¿˜ä¼šå¯¹ç½‘å…³çš„åŠŸèƒ½è¿›è¡Œæ‰©å¢ï¼Œæœ€åé€‰äº†Zuulã€‚ 2.1 pomé…ç½®123456789101112&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-zuul&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-consul-discovery&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; åœ¨Spring Cloudçš„é¡¹ç›®ä¸­ï¼Œå¼•å…¥zuulçš„starterï¼Œconsul-discoveryæ˜¯ä¸ºäº†æœåŠ¡çš„åŠ¨æ€è·¯ç”±ï¼Œè¿™è¾¹æ²¡æœ‰ç”¨eurekaï¼Œæ˜¯é€šè¿‡æ³¨å†Œåˆ°consulä¸Šçš„æœåŠ¡å®ä¾‹è¿›è¡Œè·¯ç”±ã€‚ 2.2 å…¥å£ç±»12345678@SpringBootApplication@EnableZuulProxypublic class GatewayApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(GatewayApplication.class, args); &#125;&#125; Spring bootçš„å…¥å£ç±»éœ€è¦åŠ ä¸Š@EnableZuulProxyï¼Œä¸‹é¢çœ‹ä¸‹è¿™ä¸ªæ³¨è§£ã€‚ 1234567@EnableCircuitBreaker@EnableDiscoveryClient@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Import(&#123;ZuulProxyConfiguration.class&#125;)public @interface EnableZuulProxy &#123;&#125; å¯ä»¥çœ‹åˆ°è¯¥æ³¨è§£è¿˜åŒ…å«äº†@EnableCircuitBreaker å’Œ @EnableDiscoveryClientã€‚@EnableDiscoveryClientæ³¨è§£åœ¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œå¯ä»¥è§¦å‘æœåŠ¡æ³¨å†Œçš„è¿‡ç¨‹ï¼Œå‘é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼›@EnableCircuitBreakeråˆ™å¼€å¯äº†Hystrixçš„æ–­è·¯å™¨ã€‚ 2.3 bootstrap.yml12345678910111213141516171819202122232425262728293031323334server: port: 10101 #spring configspring: application: name: gateway-server cloud: consul: discovery: preferIpAddress: true enabled: true register: true service-name: api-getway ip-address: localhost port: $&#123;server.port&#125; lifecycle: enabled: true scheme: http prefer-agent-address: false host: localhost port: 8500#zuul config and routeszuul: host: maxTotalConnections: 500 maxPerRouteConnections: 50 routes: user: path: /user/** ignoredPatterns: /consul serviceId: user sensitiveHeaders: Cookie,Set-Cookie é…ç½®ä¸»è¦åŒ…æ‹¬ä¸‰å—ï¼ŒæœåŠ¡ç«¯å£ï¼ŒSpring CloudæœåŠ¡æ³¨å†Œï¼Œæœ€åæ˜¯zuulçš„è·¯ç”±é…ç½®ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒZuulåœ¨è¯·æ±‚è·¯ç”±æ—¶ï¼Œä¼šè¿‡æ»¤HTTPè¯·æ±‚å¤´ä¿¡æ¯ä¸­çš„ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œé»˜è®¤çš„æ•æ„Ÿå¤´ä¿¡æ¯é€šè¿‡zuul.sensitiveHeaderså®šä¹‰ï¼ŒåŒ…æ‹¬Cookieã€Set-Cookieã€Authorizationã€‚ zuul.host.maxTotalConnectionsé…ç½®äº†æ¯ä¸ªæœåŠ¡çš„httpå®¢æˆ·ç«¯è¿æ¥æ± æœ€å¤§è¿æ¥ï¼Œé»˜è®¤å€¼æ˜¯200ã€‚maxPerRouteConnectionsæ¯ä¸ªrouteå¯ç”¨çš„æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤å€¼æ˜¯20ã€‚ 2.3 æ”¯æŒhttpsä¸Šçº¿çš„é¡¹ç›®ä¸€èˆ¬åŸŸåéƒ½ä¼šæ”¹ä¸ºhttpsåè®®ï¼Œé¡ºæ‰‹å†™ä¸‹httpsçš„é…ç½®ã€‚ é¦–å…ˆç”³è¯·httpsçš„æ•°å­—è¯ä¹¦åœ¨é˜¿é‡Œäº‘ç”Ÿæˆçš„é’ˆå¯¹tomcatæœåŠ¡å™¨CAè¯ä¹¦åœ¨ç”³è¯·æˆåŠŸåï¼Œ ä¸‹è½½ç›¸åº”çš„tomcatè¯ä¹¦æ–‡ä»¶ã€‚ åŒ…å«å¦‚ä¸‹ï¼š1): .pfxä¸ºkeystoreæ–‡ä»¶ï¼ŒæœåŠ¡å™¨ç”¨çš„å°±æ˜¯è¿™ä¸ªæ–‡ä»¶2): pfx-password.txté‡ŒåŒ…å«æœ‰keystoreæ‰€ç”¨åˆ°çš„å¯†ç 3): .keyé‡Œé¢åŒ…å«çš„æ˜¯ç§é’¥ï¼Œæš‚æ—¶æ²¡ç”¨åˆ°æ­¤æ–‡ä»¶4): *.pemé‡Œé¢åŒ…å«çš„æ˜¯å…¬é’¥ï¼Œä¸»è¦ç»™å®¢æˆ·ç«¯ bootstrap.ymlå¢åŠ å¦‚ä¸‹é…ç½® 123456789# httpsserver: port: 5443 http: 10101 ssl: enabled: true key-store: classpath:214329585620980.pfx key-store-password: password keyStoreType: PKCS12 åŒæ—¶æ”¯æŒhttpå’Œhttps 1234567891011121314151617181920212223242526272829@Bean public EmbeddedServletContainerFactory servletContainer() &#123; TomcatEmbeddedServletContainerFactory tomcat = new TomcatEmbeddedServletContainerFactory() &#123; @Override protected void postProcessContext(Context context) &#123; SecurityConstraint constraint = new SecurityConstraint(); constraint.setUserConstraint("CONFIDENTIAL"); SecurityCollection collection = new SecurityCollection(); collection.addPattern(""); constraint.addCollection(collection); context.addConstraint(constraint); &#125; &#125;; tomcat.addAdditionalTomcatConnectors(httpConnector()); return tomcat; &#125; @Bean public Connector httpConnector() &#123; Connector connector = new Connector("org.apache.coyote.http11.Http11NioProtocol"); connector.setScheme("http"); //Connectorç›‘å¬çš„httpçš„ç«¯å£å· connector.setPort(httpPort); connector.setSecure(false); //ç›‘å¬åˆ°httpçš„ç«¯å£å·åè½¬å‘åˆ°çš„httpsçš„ç«¯å£å· connector.setRedirectPort(securePort); return connector; &#125; servletContainer()æŠŠEmbeddedServletContainerFactoryæ³¨å…¥åˆ°webå®¹å™¨ä¸­ï¼Œç”¨postProcessContextæ‹¦æˆªæ‰€æœ‰çš„/*è¯·æ±‚ï¼Œå¹¶æŠŠå…¶å…³è”åˆ°ä¸‹é¢çš„httpConnectorä¸­ã€‚æœ€åï¼Œåœ¨httpConnector()ä¸­ï¼ŒæŠŠhttpè®¾ä¸º10101ç«¯å£ï¼Œå¹¶æŠŠhttpçš„è¯·æ±‚è·³è½¬åˆ°5443çš„httpsç«¯å£ï¼Œè¿™è¾¹æ˜¯è¯»å–çš„é…ç½®æ–‡ä»¶ã€‚ è‡³æ­¤ï¼Œè‡³æ­¤åŒæ—¶æ”¯æŒhttpså’Œhttpçš„APIç½‘å…³å®Œæˆï¼Œå°†åŒ¹é…åˆ°/userçš„è¯·æ±‚ï¼Œè·¯ç”±åˆ°useræœåŠ¡ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿä¸‹é¢ä¸€èµ·æ·±å…¥äº†è§£ä¸‹Zuulã€‚ 3. ä¸€äº›internalsinternalså¯ä»¥ç†è§£ä¸ºå†…å¹•ã€‚ 3.1 è¿‡æ»¤å™¨filteræ˜¯Zuulçš„æ ¸å¿ƒï¼Œç”¨æ¥å®ç°å¯¹å¤–æœåŠ¡çš„æ§åˆ¶ã€‚filterçš„ç”Ÿå‘½å‘¨æœŸæœ‰4ä¸ªï¼Œåˆ†åˆ«æ˜¯preã€routeã€postã€errorï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥ç”¨ä¸‹å›¾æ¥è¡¨ç¤ºã€‚ ä¸€ä¸ªè¯·æ±‚ä¼šå…ˆæŒ‰é¡ºåºé€šè¿‡æ‰€æœ‰çš„å‰ç½®è¿‡æ»¤å™¨ï¼Œä¹‹ååœ¨è·¯ç”±è¿‡æ»¤å™¨ä¸­è½¬å‘ç»™åç«¯åº”ç”¨ï¼Œå¾—åˆ°å“åº”ååˆä¼šé€šè¿‡æ‰€æœ‰çš„åç½®è¿‡æ»¤å™¨ï¼Œæœ€åå“åº”ç»™å®¢æˆ·ç«¯ã€‚errorå¯ä»¥åœ¨æ‰€æœ‰é˜¶æ®µæ•è·å¼‚å¸¸åæ‰§è¡Œã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœéœ€è¦åœ¨è¯·æ±‚åˆ°è¾¾åç«¯åº”ç”¨å‰å°±è¿›è¡Œå¤„ç†çš„è¯ï¼Œä¼šé€‰æ‹©å‰ç½®è¿‡æ»¤å™¨ï¼Œä¾‹å¦‚é‰´æƒã€è¯·æ±‚è½¬å‘ã€å¢åŠ è¯·æ±‚å‚æ•°ç­‰è¡Œä¸ºã€‚åé¢è¡”æ¥authç³»ç»Ÿéƒ¨åˆ†ç»™å‡ºå…·ä½“å®ç°ï¼Œä¹Ÿæ˜¯åŸºäºpreè¿‡æ»¤ã€‚ åœ¨è¯·æ±‚å®Œæˆåéœ€è¦å¤„ç†çš„æ“ä½œæ”¾åœ¨åç½®è¿‡æ»¤å™¨ä¸­å®Œæˆï¼Œä¾‹å¦‚ç»Ÿè®¡è¿”å›å€¼å’Œè°ƒç”¨æ—¶é—´ã€è®°å½•æ—¥å¿—ã€å¢åŠ è·¨åŸŸå¤´ç­‰è¡Œä¸ºã€‚è·¯ç”±è¿‡æ»¤å™¨ä¸€èˆ¬åªéœ€è¦é€‰æ‹© Zuul ä¸­å†…ç½®çš„å³å¯ã€‚ é”™è¯¯è¿‡æ»¤å™¨ä¸€èˆ¬åªéœ€è¦ä¸€ä¸ªï¼Œè¿™æ ·å¯ä»¥åœ¨ Gateway é‡åˆ°é”™è¯¯é€»è¾‘æ—¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä¸­æ–­æµç¨‹ï¼Œå¹¶ç›´æ¥ç»Ÿä¸€å¤„ç†è¿”å›ç»“æœã€‚ 3.2 é…ç½®ç®¡ç†åç«¯æœåŠ¡ APIå¯èƒ½æ ¹æ®æƒ…å†µï¼Œæœ‰äº›ä¸éœ€è¦ç™»å½•æ ¡éªŒäº†ï¼Œè¿™ä¸ªé…ç½®ä¿¡æ¯æ€ä¹ˆåŠ¨æ€åŠ è½½åˆ°ç½‘å…³é…ç½®å½“ä¸­ï¼Ÿç¬”è€…è®¤ä¸ºæœ‰ä¸¤ç§æ–¹å¼ï¼šä¸€æ˜¯é…ç½®ä¿¡æ¯å­˜åˆ°åº“ä¸­ï¼Œå®šæœŸå®ç°å¯¹ç½‘å…³æœåŠ¡çš„é…ç½®åˆ·æ–°ï¼›å¦ä¸€ç§å°±æ˜¯åŸºäºé…ç½®ä¸­å¿ƒæœåŠ¡ï¼Œå½“é…ç½®æäº¤åˆ°é…ç½®ä¸­å¿ƒæ—¶ï¼Œè§¦å‘ç½‘å…³æœåŠ¡çš„çƒ­æ›´æ–°ã€‚ åç«¯åº”ç”¨æ— å…³çš„é…ç½®ï¼Œæœ‰äº›æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œä¾‹å¦‚æ¶æ„è¯·æ±‚æ‹¦æˆªï¼ŒGateway ä¼šå°†æ‰€æœ‰è¯·æ±‚çš„ä¿¡æ¯é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™ä¸€äº›å®æ—¶æ•°æ®åˆ†æçš„åº”ç”¨ï¼Œè¿™äº›åº”ç”¨ä¼šå¯¹è¯·æ±‚åˆ†æï¼Œå‘ç°æ¶æ„è¯·æ±‚çš„ç‰¹å¾ï¼Œå¹¶é€šè¿‡ Gateway æä¾›çš„æ¥å£å°†è¿™äº›ç‰¹å¾ä¸ŠæŠ¥ç»™ Gatewayï¼ŒGateway å°±å¯ä»¥å®æ—¶çš„å¯¹è¿™äº›æ¶æ„è¯·æ±‚è¿›è¡Œæ‹¦æˆªã€‚ 3.3 éš”ç¦»æœºåˆ¶åœ¨å¾®æœåŠ¡çš„æ¨¡å¼ä¸‹ï¼Œåº”ç”¨ä¹‹é—´çš„è”ç³»å˜å¾—æ²¡é‚£ä¹ˆå¼ºçƒˆï¼Œç†æƒ³ä¸­ä»»ä½•ä¸€ä¸ªåº”ç”¨è¶…è¿‡è´Ÿè½½æˆ–æ˜¯æŒ‚æ‰äº†ï¼Œéƒ½ä¸åº”è¯¥å»å½±å“åˆ°å…¶ä»–åº”ç”¨ã€‚ä½†æ˜¯åœ¨ Gateway è¿™ä¸ªå±‚é¢ï¼Œæœ‰æ²¡æœ‰å¯èƒ½å‡ºç°ä¸€ä¸ªåº”ç”¨è´Ÿè½½è¿‡é‡ï¼Œå¯¼è‡´å°†æ•´ä¸ª Gateway éƒ½å‹å®äº†ï¼Œå·²è‡´æ‰€æœ‰åº”ç”¨çš„æµé‡å…¥å£éƒ½è¢«åˆ‡æ–­ï¼Ÿ è¿™å½“ç„¶æ˜¯æœ‰å¯èƒ½çš„ï¼Œæƒ³è±¡ä¸€ä¸ªæ¯ç§’ä¼šæ¥å—å¾ˆå¤šè¯·æ±‚çš„åº”ç”¨ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹è¿™äº›è¯·æ±‚å¯èƒ½åœ¨ 10 æ¯«ç§’ä¹‹å†…å°±èƒ½æ­£å¸¸å“åº”ï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸€å¤©å®ƒå‡ºäº†é—®é¢˜ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼š Block åˆ° 30 ç§’è¶…æ—¶æ‰ä¼šæ–­å¼€ï¼ˆä¾‹å¦‚é¢‘ç¹ Full GC æ— æ³•æœ‰æ•ˆé‡Šæ”¾å†…å­˜ï¼‰ã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶å€™ï¼ŒGateway ä¸­ä¹Ÿä¼šæœ‰å¤§é‡çš„çº¿ç¨‹åœ¨ç­‰å¾…è¯·æ±‚çš„å“åº”ï¼Œæœ€ç»ˆä¼šåƒå…‰æ‰€æœ‰çº¿ç¨‹ï¼Œå¯¼è‡´å…¶ä»–æ­£å¸¸åº”ç”¨çš„è¯·æ±‚ä¹Ÿå—åˆ°å½±å“ã€‚ åœ¨ Zuul ä¸­ï¼Œæ¯ä¸€ä¸ªåç«¯åº”ç”¨éƒ½ç§°ä¸ºä¸€ä¸ª Routeï¼Œä¸ºäº†é¿å…ä¸€ä¸ª Route æŠ¢å äº†å¤ªå¤šèµ„æºå½±å“åˆ°å…¶ä»– Route çš„æƒ…å†µå‡ºç°ï¼ŒZuul ä½¿ç”¨ Hystrix å¯¹æ¯ä¸€ä¸ª Route éƒ½åšäº†éš”ç¦»å’Œé™æµã€‚ Hystrix çš„éš”ç¦»ç­–ç•¥æœ‰ä¸¤ç§ï¼ŒåŸºäºçº¿ç¨‹æˆ–æ˜¯åŸºäºä¿¡å·é‡ã€‚Zuul é»˜è®¤çš„æ˜¯åŸºäºçº¿ç¨‹çš„éš”ç¦»æœºåˆ¶ï¼Œä¹‹å‰ç« èŠ‚çš„é…ç½®å¯ä»¥å›é¡¾ä¸‹ï¼Œè¿™æ„å‘³ç€æ¯ä¸€ä¸ª Route çš„è¯·æ±‚éƒ½ä¼šåœ¨ä¸€ä¸ªå›ºå®šå¤§å°ä¸”ç‹¬ç«‹çš„çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œè¿™æ ·å³ä½¿å…¶ä¸­ä¸€ä¸ª Route å‡ºç°äº†é—®é¢˜ï¼Œä¹Ÿåªä¼šæ˜¯æŸä¸€ä¸ªçº¿ç¨‹æ± å‘ç”Ÿäº†é˜»å¡ï¼Œå…¶ä»– Route ä¸ä¼šå—åˆ°å½±å“ã€‚ ä¸€èˆ¬ä½¿ç”¨ Hystrix æ—¶ï¼Œåªæœ‰è°ƒç”¨é‡å·¨å¤§ä¼šå—åˆ°çº¿ç¨‹å¼€é”€å½±å“æ—¶æ‰ä¼šä½¿ç”¨ä¿¡å·é‡è¿›è¡Œéš”ç¦»ç­–ç•¥ï¼Œå¯¹äº Zuul è¿™ç§ç½‘ç»œè¯·æ±‚çš„ç”¨é€”ä½¿ç”¨çº¿ç¨‹éš”ç¦»æ›´åŠ ç¨³å¦¥ã€‚ 3.4 é‡è¯•æœºåˆ¶ä¸€èˆ¬æ¥è¯´ï¼Œåç«¯åº”ç”¨çš„å¥åº·çŠ¶æ€æ˜¯ä¸ç¨³å®šçš„ï¼Œåº”ç”¨åˆ—è¡¨éšæ—¶ä¼šæœ‰ä¿®æ”¹ï¼Œæ‰€ä»¥ Gateway å¿…é¡»æœ‰è¶³å¤Ÿå¥½çš„å®¹é”™æœºåˆ¶ï¼Œèƒ½å¤Ÿå‡å°‘åç«¯åº”ç”¨å˜æ›´æ—¶é€ æˆçš„å½±å“ã€‚ ç®€å•ä»‹ç»ä¸‹ Ribbon æ”¯æŒå“ªäº›å®¹é”™é…ç½®ã€‚é‡è¯•çš„åœºæ™¯åˆ†ä¸ºä¸‰ç§ï¼š okToRetryOnConnectErrorsï¼šåªé‡è¯•ç½‘ç»œé”™è¯¯ okToRetryOnAllErrorsï¼šé‡è¯•æ‰€æœ‰é”™è¯¯ OkToRetryOnAllOperationsï¼šé‡è¯•æ‰€æœ‰æ“ä½œ é‡è¯•çš„æ¬¡æ•°æœ‰ä¸¤ç§ï¼š MaxAutoRetriesï¼šæ¯ä¸ªèŠ‚ç‚¹çš„æœ€å¤§é‡è¯•æ¬¡æ•° MaxAutoRetriesNextServerï¼šæ›´æ¢èŠ‚ç‚¹é‡è¯•çš„æœ€å¤§æ¬¡æ•° ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬å¸Œæœ›åªåœ¨ç½‘ç»œè¿æ¥å¤±è´¥æ—¶è¿›è¡Œé‡è¯•ã€æˆ–æ˜¯å¯¹ 5XX çš„ GET è¯·æ±‚è¿›è¡Œé‡è¯•ï¼ˆä¸æ¨èå¯¹ POST è¯·æ±‚è¿›è¡Œé‡è¯•ï¼Œæ— æ³•ä¿è¯å¹‚ç­‰æ€§ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼‰ã€‚å•å°çš„é‡è¯•æ¬¡æ•°å¯ä»¥å°½é‡å°ä¸€äº›ï¼Œé‡è¯•çš„èŠ‚ç‚¹æ•°å°½é‡å¤šä¸€äº›ï¼Œæ•´ä½“æ•ˆæœä¼šæ›´å¥½ã€‚ å¦‚æœæœ‰æ›´åŠ å¤æ‚çš„é‡è¯•åœºæ™¯ï¼Œä¾‹å¦‚éœ€è¦å¯¹ç‰¹å®šçš„æŸäº› APIã€ç‰¹å®šçš„è¿”å›å€¼è¿›è¡Œé‡è¯•ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥é€šè¿‡å®ç° RequestSpecificRetryHandler å®šåˆ¶é€»è¾‘ï¼ˆä¸å»ºè®®ç›´æ¥ä½¿ç”¨ RetryHandlerï¼Œå› ä¸ºè¿™ä¸ªå­ç±»å¯ä»¥ä½¿ç”¨å¾ˆå¤šå·²æœ‰çš„åŠŸèƒ½ï¼‰ã€‚ 4. æ€»ç»“æœ¬æ–‡é¦–å…ˆä»‹ç»äº†APIç½‘å…³çš„ç›¸å…³çŸ¥è¯†ï¼›å…¶æ¬¡ä»‹ç»äº†zuulç½‘å…³çš„é…ç½®å®ç°ï¼ŒåŒæ—¶æ”¯æŒhttpsï¼›æœ€åä»‹ç»äº†zuulç½‘å…³çš„ä¸€äº›å†…å¹•åŸç†ï¼Œè¿™è¾¹å¤§éƒ¨åˆ†å‚è€ƒäº†ç½‘ä¸Šçš„æ–‡ç« ã€‚ç½‘å…³ä½œä¸ºå†…ç½‘ä¸å¤–ç½‘ä¹‹é—´çš„é—¨æˆ·ï¼Œæ‰€æœ‰è®¿é—®å†…ç½‘çš„è¯·æ±‚éƒ½ä¼šç»è¿‡ç½‘å…³ï¼Œç½‘å…³å¤„è¿›è¡Œåå‘ä»£ç†ã€‚åœ¨æ•´ä¸ªSpring Cloudå¾®æœåŠ¡æ¡†æ¶é‡Œï¼ŒZuulæ‰®æ¼”ç€â€æ™ºèƒ½ç½‘å…³â€œçš„è§’è‰²ã€‚ github: https://github.com/keets2012/Spring-Boot-Samples/tree/master/api-gatewaygitee: https://gitee.com/keets/spring-boot-samples/tree/master/api-gateway å‚è€ƒ èŠèŠ API Gateway å’Œ Netflix Zuul Spring CloudæŠ€æœ¯åˆ†æï¼ˆ4ï¼‰- spring cloud zuul netflix-zuul]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
      </categories>
      <tags>
        <tag>zuul</tag>
        <tag>gateway</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å‡ ç§åˆ†å¸ƒå¼è°ƒç”¨é“¾ç›‘æ§ç»„ä»¶çš„å®è·µä¸æ¯”è¾ƒï¼ˆä¸€ï¼‰å®è·µ]]></title>
    <url>%2F2017%2F11%2F10%2Fapm1%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ï¼šæœ€è¿‘åœ¨è°ƒç ”ä¸é€‰å‹åˆ†å¸ƒå¼è°ƒç”¨é“¾ç›‘æ§ç»„ä»¶ã€‚é€‰äº†ä¸»è¦çš„ä¸‰ç§APMç»„ä»¶è¿›è¡Œäº†å®è·µä¸æ¯”è¾ƒã€‚æœ¬æ¥æ‰“ç®—ä¸€ç¯‡æ–‡ç« å†™å®Œçš„ï¼Œç¯‡å¹…å¤ªé•¿ï¼Œæ‰“ç®—åˆ†ä¸¤ç¯‡ã€‚æœ¬æ–‡ä¸»è¦è®²ä¸‹é“¾è·¯traceingçš„åŸºæœ¬æ¦‚å¿µå’Œå‡ ç§APMç»„ä»¶çš„å®è·µï¼Œå®è·µéƒ¨åˆ†ä¹Ÿæ²¡ç»™å‡ºç‰¹åˆ«è¯¦ç»†çš„æ­¥éª¤ï¼Œå› ä¸ºæœ¬æ–‡é‡ç‚¹ä¸åœ¨å…·ä½“çš„æ­¥éª¤ã€‚ç¬¬äºŒç¯‡å°†ä¼šè®²ä¸‹å‡ ç§APMé€‰å‹çš„æ¯”è¾ƒä¸æ€§èƒ½æµ‹è¯•ã€‚ 1. é—®é¢˜èƒŒæ™¯å¾®æœåŠ¡æ¶æ„ä¸‹ï¼ŒæœåŠ¡æŒ‰ç…§ä¸åŒçš„ç»´åº¦è¿›è¡Œæ‹†åˆ†ï¼Œä¸€æ¬¡è¯·æ±‚è¯·æ±‚å¾€å¾€éœ€è¦æ¶‰åŠåˆ°å¤šä¸ªæœåŠ¡ã€‚äº’è”ç½‘åº”ç”¨æ„å»ºåœ¨ä¸åŒçš„è½¯ä»¶æ¨¡å—é›†ä¸Šï¼Œè¿™äº›è½¯ä»¶æ¨¡å—ï¼Œæœ‰å¯èƒ½æ˜¯ç”±ä¸åŒçš„å›¢é˜Ÿå¼€å‘ã€å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€æœ‰å¯èƒ½å¸ƒåœ¨äº†å‡ åƒå°æœåŠ¡å™¨ï¼Œæ¨ªè·¨å¤šä¸ªä¸åŒçš„æ•°æ®ä¸­å¿ƒã€‚å› æ­¤ï¼Œå°±éœ€è¦ä¸€äº›å¯ä»¥å¸®åŠ©ç†è§£ç³»ç»Ÿè¡Œä¸ºã€ç”¨äºåˆ†ææ€§èƒ½é—®é¢˜çš„å·¥å…·ï¼Œä»¥ä¾¿å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚ åˆ†å¸ƒå¼è°ƒç”¨é“¾ç›‘æ§ç»„ä»¶åœ¨è¿™æ ·çš„ç¯å¢ƒä¸‹äº§ç”Ÿäº†ã€‚æœ€å‡ºåçš„æ˜¯è°·æ­Œå…¬å¼€çš„è®ºæ–‡æåˆ°çš„Dapperã€‚å¼€å‘Dapperæ˜¯ä¸ºäº†æ”¶é›†æ›´å¤šçš„å¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¡Œä¸ºä¿¡æ¯ï¼Œç„¶åå‘ˆç°ç»™Googleçš„å¼€å‘è€…ä»¬ã€‚è¿™æ ·çš„åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸€ä¸ªç‰¹æ®Šçš„å¥½å¤„ï¼Œå› ä¸ºé‚£äº›å¤§è§„æ¨¡çš„ä½ç«¯æœåŠ¡å™¨ï¼Œä½œä¸ºäº’è”ç½‘æœåŠ¡çš„è½½ä½“ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç»æµåˆ’ç®—çš„å¹³å°ã€‚æƒ³è¦åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„è¡Œä¸ºï¼Œå°±éœ€è¦ç›‘æ§é‚£äº›æ¨ªè·¨äº†ä¸åŒçš„åº”ç”¨ã€ä¸åŒçš„æœåŠ¡å™¨ä¹‹é—´çš„å…³è”åŠ¨ä½œã€‚ å¸‚é¢ä¸Šçš„APMï¼ˆApplication Performance Managementï¼‰ç†è®ºæ¨¡å‹å¤§å¤šéƒ½æ˜¯å€Ÿé‰´ï¼ˆborrowï¼‰Google Dapperè®ºæ–‡ï¼Œæœ¬æ–‡é‡ç‚¹å…³æ³¨ä»¥ä¸‹å‡ ç§APMç»„ä»¶ï¼š Zipkin ç”±Twitterå…¬å¸å¼€æºï¼Œå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»ç»Ÿï¼Œç”¨äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚ PinpointPinpointæ˜¯ä¸€æ¬¾å¯¹Javaç¼–å†™çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„APMå·¥å…·ï¼Œç”±éŸ©å›½äººå¼€æºçš„åˆ†å¸ƒå¼è·Ÿè¸ªç»„ä»¶ã€‚ Skywalkingå›½äº§çš„ä¼˜ç§€APMç»„ä»¶ï¼Œæ˜¯ä¸€ä¸ªå¯¹JAVAåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºé›†ç¾¤çš„ä¸šåŠ¡è¿è¡Œæƒ…å†µè¿›è¡Œè¿½è¸ªã€å‘Šè­¦å’Œåˆ†æçš„ç³»ç»Ÿã€‚ å…¶ä»–ç±»ä¼¼çš„ç»„ä»¶è¿˜æœ‰ç¾å›¢ç‚¹è¯„çš„CATï¼Œæ·˜å®çš„é¹°çœ¼EgleEyeã€‚ å¦‚ä¸Šæ‰€è¿°ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€‰æ‹©é“¾è·¯ç›‘æ§ç»„ä»¶æœ‰å“ªäº›è¦æ±‚å‘¢ï¼ŸDapperä¸­ä¹Ÿæåˆ°äº†ï¼Œç¬”è€…æ€»ç»“å¦‚ä¸‹ï¼š æ¢é’ˆçš„æ€§èƒ½æ¶ˆè€—ã€‚APMç»„ä»¶æœåŠ¡çš„å½±å“åº”è¯¥åšåˆ°è¶³å¤Ÿå°ã€‚åœ¨ä¸€äº›é«˜åº¦ä¼˜åŒ–è¿‡çš„æœåŠ¡ï¼Œå³ä½¿ä¸€ç‚¹ç‚¹æŸè€—ä¹Ÿä¼šå¾ˆå®¹æ˜“å¯Ÿè§‰åˆ°ï¼Œè€Œä¸”æœ‰å¯èƒ½è¿«ä½¿åœ¨çº¿æœåŠ¡çš„éƒ¨ç½²å›¢é˜Ÿä¸å¾—ä¸å°†è·Ÿè¸ªç³»ç»Ÿå…³åœã€‚ ä»£ç çš„ä¾µå…¥æ€§å¯¹äºåº”ç”¨çš„ç¨‹åºå‘˜æ¥è¯´ï¼Œæ˜¯ä¸éœ€è¦çŸ¥é“æœ‰è·Ÿè¸ªç³»ç»Ÿè¿™å›äº‹çš„ã€‚å¦‚æœä¸€ä¸ªè·Ÿè¸ªç³»ç»Ÿæƒ³ç”Ÿæ•ˆï¼Œå°±å¿…é¡»éœ€è¦ä¾èµ–åº”ç”¨çš„å¼€å‘è€…ä¸»åŠ¨é…åˆï¼Œé‚£ä¹ˆè¿™ä¸ªè·Ÿè¸ªç³»ç»Ÿä¹Ÿå¤ªè„†å¼±äº†ï¼Œå¾€å¾€ç”±äºè·Ÿè¸ªç³»ç»Ÿåœ¨åº”ç”¨ä¸­æ¤å…¥ä»£ç çš„bugæˆ–ç–å¿½å¯¼è‡´åº”ç”¨å‡ºé—®é¢˜ï¼Œè¿™æ ·æ‰æ˜¯æ— æ³•æ»¡è¶³å¯¹è·Ÿè¸ªç³»ç»Ÿâ€œæ— æ‰€ä¸åœ¨çš„éƒ¨ç½²â€è¿™ä¸ªéœ€æ±‚ã€‚ å¯æ‰©å±•æ€§èƒ½å¤Ÿæ”¯æŒçš„ç»„ä»¶è¶Šå¤šå½“ç„¶è¶Šå¥½ã€‚æˆ–è€…æä¾›ä¾¿æ·çš„æ’ä»¶å¼€å‘APIï¼Œå¯¹äºä¸€äº›æ²¡æœ‰ç›‘æ§åˆ°çš„ç»„ä»¶ï¼Œåº”ç”¨å¼€å‘è€…ä¹Ÿå¯ä»¥è‡ªè¡Œæ‰©å±•ã€‚ æ•°æ®çš„åˆ†ææ•°æ®çš„åˆ†æè¦å¿« ï¼Œåˆ†æçš„ç»´åº¦å°½å¯èƒ½å¤šã€‚è·Ÿè¸ªç³»ç»Ÿèƒ½æä¾›è¶³å¤Ÿå¿«çš„ä¿¡æ¯åé¦ˆï¼Œå°±å¯ä»¥å¯¹ç”Ÿäº§ç¯å¢ƒä¸‹çš„å¼‚å¸¸çŠ¶å†µåšå‡ºå¿«é€Ÿååº”ã€‚åˆ†æçš„å…¨é¢ï¼Œèƒ½å¤Ÿé¿å…äºŒæ¬¡å¼€å‘ã€‚ 2. åŸºç¡€æ¦‚å¿µä¸Šé¢åˆ—å‡ºçš„å‡ ç§ç»„ä»¶ï¼Œå…¶ä¸­Zipkinæ˜¯ä¸¥æ ¼æŒ‰ç…§Google Dapperè®ºæ–‡å®ç°çš„ï¼Œä¸‹é¢ä»‹ç»ä¸‹å…¶ä¸­æ¶‰åŠçš„åŸºæœ¬æ¦‚å¿µã€‚ SpanåŸºæœ¬å·¥ä½œå•å…ƒï¼Œä¸€æ¬¡é“¾è·¯è°ƒç”¨(å¯ä»¥æ˜¯RPCï¼ŒDBç­‰æ²¡æœ‰ç‰¹å®šçš„é™åˆ¶)åˆ›å»ºä¸€ä¸ªspanï¼Œé€šè¿‡ä¸€ä¸ª64ä½IDæ ‡è¯†å®ƒï¼Œuuidè¾ƒä¸ºæ–¹ä¾¿ï¼Œspanä¸­è¿˜æœ‰å…¶ä»–çš„æ•°æ®ï¼Œä¾‹å¦‚æè¿°ä¿¡æ¯ï¼Œæ—¶é—´æˆ³ï¼Œkey-valueå¯¹çš„(Annotation)tagä¿¡æ¯ï¼Œparent-idç­‰,å…¶ä¸­parent-idå¯ä»¥è¡¨ç¤ºspanè°ƒç”¨é“¾è·¯æ¥æºã€‚ Trace:ç±»ä¼¼äºæ ‘ç»“æ„çš„Spané›†åˆï¼Œè¡¨ç¤ºä¸€æ¡è°ƒç”¨é“¾è·¯ï¼Œå­˜åœ¨å”¯ä¸€æ ‡è¯†ã€‚æ¯”å¦‚ä½ è¿è¡Œçš„åˆ†å¸ƒå¼å¤§æ•°æ®å­˜å‚¨ä¸€æ¬¡Traceå°±ç”±ä½ çš„ä¸€æ¬¡è¯·æ±‚ç»„æˆã€‚ Annotation: æ³¨è§£,ç”¨æ¥è®°å½•è¯·æ±‚ç‰¹å®šäº‹ä»¶ç›¸å…³ä¿¡æ¯(ä¾‹å¦‚æ—¶é—´)ï¼Œé€šå¸¸åŒ…å«å››ä¸ªæ³¨è§£ä¿¡æ¯ï¼š (1) csï¼šClient Start,è¡¨ç¤ºå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ (2) srï¼šServer Receive,è¡¨ç¤ºæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ (3) ssï¼šServer Send,è¡¨ç¤ºæœåŠ¡ç«¯å®Œæˆå¤„ç†ï¼Œå¹¶å°†ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ (4) crï¼šClient Received,è¡¨ç¤ºå®¢æˆ·ç«¯è·å–åˆ°æœåŠ¡ç«¯è¿”å›ä¿¡æ¯ 2.1 Traceä¸‹é¢çœ‹ä¸€ä¸‹ï¼Œåœ¨ç³»ç»Ÿä¸­Traceæ˜¯ä»€ä¹ˆæ ·å­ã€‚ æ¯ç§é¢œè‰²çš„noteæ ‡æ³¨äº†ä¸€ä¸ªspanï¼Œä¸€æ¡é“¾è·¯é€šè¿‡TraceIdå”¯ä¸€æ ‡è¯†ï¼ŒSpanæ ‡è¯†å‘èµ·çš„è¯·æ±‚ä¿¡æ¯ã€‚æ ‘èŠ‚ç‚¹æ˜¯æ•´ä¸ªæ¶æ„çš„åŸºæœ¬å•å…ƒï¼Œè€Œæ¯ä¸€ä¸ªèŠ‚ç‚¹åˆæ˜¯å¯¹spançš„å¼•ç”¨ã€‚èŠ‚ç‚¹ä¹‹é—´çš„è¿çº¿è¡¨ç¤ºçš„spanå’Œå®ƒçš„çˆ¶spanç›´æ¥çš„å…³ç³»ã€‚è™½ç„¶spanåœ¨æ—¥å¿—æ–‡ä»¶ä¸­åªæ˜¯ç®€å•çš„ä»£è¡¨spançš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œä»–ä»¬åœ¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸­å´æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚ 2.2 Span ä¸Šå›¾è¯´æ˜äº†spanåœ¨ä¸€æ¬¡å¤§çš„è·Ÿè¸ªè¿‡ç¨‹ä¸­æ˜¯ä»€ä¹ˆæ ·çš„ã€‚Dapperè®°å½•äº†spanåç§°ï¼Œä»¥åŠæ¯ä¸ªspançš„IDå’Œçˆ¶IDï¼Œä»¥é‡å»ºåœ¨ä¸€æ¬¡è¿½è¸ªè¿‡ç¨‹ä¸­ä¸åŒspanä¹‹é—´çš„å…³ç³»ã€‚å¦‚æœä¸€ä¸ªspanæ²¡æœ‰çˆ¶IDè¢«ç§°ä¸ºroot spanã€‚æ‰€æœ‰spanéƒ½æŒ‚åœ¨ä¸€ä¸ªç‰¹å®šçš„è·Ÿè¸ªä¸Šï¼Œä¹Ÿå…±ç”¨ä¸€ä¸ªè·Ÿè¸ªidã€‚ 2.3 Annotationè‡ªåŠ¨çš„æ¢é’ˆï¼Œä¸éœ€è¦ä¿®æ”¹åº”ç”¨ç¨‹åºæºä»£ç ï¼Œå¯¹åº”ç”¨å¼€å‘è€…è¿‘ä¹é›¶æµ¸å…¥çš„æˆæœ¬å¯¹åˆ†å¸ƒå¼æ§åˆ¶è·¯å¾„è¿›è¡Œè·Ÿè¸ªï¼Œå‡ ä¹å®Œå…¨ä¾èµ–äºåŸºäºå°‘é‡é€šç”¨ç»„ä»¶åº“çš„æ”¹é€ ã€‚Dapperè¿˜å…è®¸åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜åœ¨Dapperè·Ÿè¸ªçš„è¿‡ç¨‹ä¸­æ·»åŠ é¢å¤–çš„ä¿¡æ¯ï¼Œä»¥ç›‘æ§æ›´é«˜çº§åˆ«çš„ç³»ç»Ÿè¡Œä¸ºï¼Œæˆ–å¸®åŠ©è°ƒè¯•é—®é¢˜ã€‚ ä¸‹é¢ç« èŠ‚å°†ä¼šä»‹ç»ä¸‹ä¸Šè¿°ä¸‰ç§APMç»„ä»¶çš„ä½¿ç”¨ä¸å®è·µã€‚ 3. zipkinzipkinä¸»è¦æ¶‰åŠå‡ ä¸ªç»„ä»¶ï¼šcollectoræ”¶é›†agentçš„æ•°æ®ï¼Œstorageå­˜å‚¨ï¼Œweb UIå›¾å½¢åŒ–ç•Œé¢ï¼ŒsearchæŸ¥è¯¢Storageä¸­å­˜å‚¨çš„æ•°æ®,æä¾›ç®€å•çš„JSON APIè·å–æ•°æ®ã€‚ æˆ‘ä»¬çš„é¡¹ç›®åŸºäºå¾®æœåŠ¡æ¡†æ¶spring cloudæ„å»ºå¾®æœåŠ¡ã€‚spring cloudä¹Ÿæä¾›äº†spring-cloud-sleuthæ¥æ–¹ä¾¿é›†æˆzipkinå®ç°ã€‚æ‰€ä»¥ç¬”è€…å°±åœ¨é¡¹ç›®ä¸­è¯•äº†ä¸‹spring-cloud-sleuth-zipkinã€‚ èµ·äº†ä¸‰ä¸ªæœåŠ¡ï¼šzipkin-serverã€zipkin-client-backendã€zipkin-clientã€‚å…¶ä¸­serveræœåŠ¡è´Ÿè´£æ”¶é›†ä»¥åŠä¿¡æ¯å±•ç¤ºã€‚client-backendè°ƒç”¨clientï¼Œäº§ç”Ÿè°ƒç”¨é“¾è·¯ä¿¡æ¯ã€‚ 3.1 zipkin-serverå®ç°zipkin-serverå®ç°ä¸»è¦æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼Œå…¶ä¸€æ˜¯æ”¶é›†åˆ°æ•°æ®çš„å­˜å‚¨ï¼Œæ–¹å¼åŒ…æ‹¬å†…å­˜ã€æ•°æ®åº“ã€ESç­‰ï¼›å…¶äºŒæ˜¯é€šä¿¡æ–¹å¼ï¼ŒåŒ…æ‹¬httpé€šä¿¡å’Œmqå¼‚æ­¥æ–¹å¼é€šä¿¡ï¼Œhttpé€šä¿¡ä¼šå¯¹æ­£å¸¸çš„è®¿é—®é€ æˆå½±å“ï¼Œæ‰€ä»¥è¿˜æ˜¯æ¨èåŸºäºmqå¼‚æ­¥æ–¹å¼é€šä¿¡ã€‚ æœ¬æ–‡ä½¿ç”¨mysqlä½œä¸ºå­˜å‚¨ï¼Œä½¿ç”¨MQé€šä¿¡ï¼ŒMQé€šä¿¡åŸºäºSpring-cloud-Streamã€‚æœ¬æ–‡é‡ç‚¹ä¸åœ¨zipkin-serverçš„å…·ä½“å‡ ç§å®ç°æ–¹å¼ï¼Œå…¶ä»–æ–¹å¼ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»å®˜ç½‘æŸ¥çœ‹ã€‚ ï¼ˆ1ï¼‰poméœ€è¦æ·»åŠ çš„å¼•ç”¨å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!--zipkinä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-sleuth-zipkin-stream&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-stream-rabbit&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.zipkin.java&lt;/groupId&gt; &lt;artifactId&gt;zipkin-autoconfigure-ui&lt;/artifactId&gt; &lt;scope&gt;runtime&lt;/scope&gt; &lt;/dependency&gt; &lt;!--ä¿å­˜åˆ°æ•°æ®åº“éœ€è¦å¦‚ä¸‹ä¾èµ–--&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt; &lt;/dependency&gt; ï¼ˆ2ï¼‰å¯åŠ¨ç±»ï¼š 12345678// ä½¿ç”¨Streamæ–¹å¼å¯åŠ¨ZipkinServer@EnableZipkinStreamServer@SpringBootApplicationpublic class ZipkinStreamServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ZipkinStreamServerApplication.class,args); &#125;&#125; @EnableZipkinStreamServeræ³¨è§£å¼•å…¥äº†@EnableZipkinServeræ³¨è§£ï¼ŒåŒæ—¶è¿˜åˆ›å»ºäº†ä¸€ä¸ªrabbit-mqçš„SleuthSinkæ¶ˆæ¯é˜Ÿåˆ—ç›‘å¬å™¨ã€‚ ï¼ˆ3ï¼‰é…ç½®æ–‡ä»¶ 123456789101112131415161718192021222324252627server: port: 9411spring: datasource: username: root password: root123 schema[0]: classpath:/zipkin.sqlzipkin: storage: type: mysql---spring: application: name: microservice-zipkin-stream-server rabbitmq: host: $&#123;RABBIT_ADDR:localhost&#125; port: $&#123;RABBIT_PORT:5672&#125; username: guest password: guest sleuth: enabled: false profiles: default datasource: url: jdbc:mysql://localhost:3307/zipkin?autoReconnect=true&amp;useSSL=false zipkin.sqlå¯ä»¥å»å®˜ç½‘è·å–ï¼Œè®¾ç½®äº†zipkin-serverçš„ç«¯å£å·ä¸º9411ã€‚ 3.2 zipkin-clientä¸¤ä¸ªzipkin-clientçš„é…ç½®ä¸€æ ·ï¼Œæ‰€ä»¥æ”¾åœ¨ä¸€èµ·ã€‚ ï¼ˆ1ï¼‰pomä¾èµ– 12345678910111213&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-sleuth-zipkin-stream&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-stream-rabbit&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt; &lt;/dependency&gt; (2) é…ç½®æ–‡ä»¶ 123456spring: rabbitmq: host: 127.0.0.1 port : 5672 username: guest password: guest 3.3 ç»“æœæœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ç»è¿‡gatewayï¼Œè°ƒç”¨å†…ç½‘ä¸­çš„å„ä¸ªæœåŠ¡ï¼Œéƒ¨åˆ†è¿˜æ¶‰åŠåˆ°è°ƒç”¨noticeæœåŠ¡ã€‚ä»å›¾ä¸­å¯ä»¥æ¸…æ¥šçš„çœ‹å‡ºå®¢æˆ·ç«¯è¯·æ±‚æ‰€ç»è¿‡çš„æœåŠ¡ã€‚ä¸‹é¢çœ‹ä¸‹demo2-defaultæœåŠ¡å®ä¾‹ä¸­çš„http pathï¼š ä¸Šå›¾ä¸­demo2-defaultæœåŠ¡çš„å‡ ä¸ªhttp pathæŒ‰ç…§æ—¶é•¿æ’åºï¼Œæ˜¾ç¤ºäº†traceè°ƒç”¨æ—¶é•¿å’Œspanæ•°é‡ã€‚ç‚¹è¿›å»å¯ä»¥çœ‹åˆ°ï¼š å›¾ä¸­åˆ—å‡ºäº†ä»çˆ¶spanå¼€å§‹ï¼Œæ¯ä¸€ä¸ªspançš„è€—æ—¶ã€‚æœ¬æ¬¡traceä¸­ï¼Œæ¶‰åŠåˆ°ä¸¤ä¸ªæœåŠ¡demo1å’Œdemo2ã€‚demo2è°ƒç”¨demo1ï¼Œä»597mså¼€å§‹è°ƒç”¨demo1ï¼Œå®Œæˆæœ€ç»ˆçš„è¯·æ±‚æ€»å…±è€—æ—¶1265msã€‚ 4. pinpointå¯¹ä»£ç é›¶ä¾µå…¥ï¼Œè¿ç”¨JavaAgentå­—èŠ‚ç å¢å¼ºæŠ€æœ¯ï¼Œåªéœ€è¦åŠ å¯åŠ¨å‚æ•°å³å¯ã€‚pinpointçš„å‡ ä¸ªç»„ä»¶éƒ¨åˆ†å’Œzipkinå·®ä¸å¤šï¼Œæ¶æ„å›¾å¦‚ä¸‹ï¼š Pinpoint-Collectoræ”¶é›†å„ç§æ€§èƒ½æ•°æ®ã€Pinpoint-Agentå’Œè‡ªå·±è¿è¡Œçš„åº”ç”¨å…³è”èµ·æ¥çš„æ¢é’ˆã€Pinpoint-Webå°†æ”¶é›†åˆ°çš„æ•°æ®æ˜¾ç¤ºæˆWEBç½‘é¡µå½¢å¼ã€HBase Storageæ”¶é›†åˆ°çš„æ•°æ®å­˜åˆ°HBaseä¸­ã€‚ 4.1 pinpointå®‰è£…ä¸»è¦æ¶‰åŠä»¥ä¸‹è½¯ä»¶çš„å®‰è£…ï¼š jdk 1.8Javaç¯å¢ƒå¿…é¡»çš„ï¼Œæ²¡å•¥å¥½è§£é‡Šã€‚ Hbasepinpointæ”¶é›†æ¥çš„æµ‹è¯•æ•°æ®ï¼Œä¸»è¦æ˜¯å­˜åœ¨Hbaseæ•°æ®åº“çš„ã€‚æ‰€ä»¥å®ƒå¯ä»¥æ”¶é›†å¤§é‡çš„æ•°æ®ï¼Œå¯ä»¥è¿›è¡Œæ›´åŠ è¯¦ç»†çš„åˆ†æã€‚Hbaseå®‰è£…å®Œæˆåï¼Œéœ€è¦åˆå§‹åŒ–Hbaseçš„pinpointåº“ï¼Œç”±pinpointæä¾›ã€‚Hbaseå†…ç½®äº†zookeeperã€‚ pinpoint-collectorcollectoræ”¶é›†agentçš„æ•°æ®ï¼Œå°†æ•°æ®å­˜åˆ°hbaseé›†ç¾¤ï¼Œå¯¹å¤–æš´éœ²collectorçš„tcpå’Œudpçš„ç›‘å¬ç«¯å£9994ï¼Œ9995ï¼Œ9996ã€‚ pinpoint-webé¡µé¢å±•ç¤ºï¼Œé…ç½®æ–‡ä»¶ä¸­è®¾ç½®ç¯å¢ƒå˜é‡HBASE_HOSTã€HBASE_PORTç­‰ã€‚ pinpoint-agent åˆ°å®˜ç½‘releaseé¡µé¢ä¸‹è½½pinpoint-agent-x-SNAPSHOT.tar.gzï¼Œé…ç½®pinpoint.configä¸­ç›¸å…³collectorçš„ä¿¡æ¯ã€‚ å®‰è£…ç¡®å®è¿˜æ¯”è¾ƒéº»çƒ¦ï¼Œæœ¬æ–‡ç¯‡å¹…å¤ªé•¿äº†ï¼Œå…·ä½“æ­¥éª¤åé¢å†å•ç‹¬å†™æ–‡ç« è®²è§£ã€‚ 4.2 è¿è¡Œpinpoint-agentç¬”è€…ä½¿ç”¨çš„æ˜¯spring-booté¡¹ç›®ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨å¯åŠ¨jaråŒ…çš„å‘½ä»¤ä¸­åŠ å…¥-javaagentå‚æ•°ï¼Œå¹¶æŒ‡å®špinpoint-bootstrapåŒ…çš„ç»å¯¹è·¯å¾„ã€‚å®ä¾‹ä»£ç å¦‚ä¸‹ï¼š 1java -javaagent:/aoho/auth_compose/pinpoint-bootstrap-1.6.0.jar -Dpinpoint.agentId=aoho-consumer -Dpinpoint.applicationName=aoho-consumer -jar id_generator/snowflake-id-generate-1.0-SNAPSHOT.jar èµ·çš„idç”Ÿæˆå™¨æœåŠ¡æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰ç”¨åˆ°æ•°æ®åº“ç­‰å­˜å‚¨ä»‹è´¨ã€‚æœåŠ¡æ³¨å†Œåˆ°consulä¸Šï¼Œæœ¬åœ°å®¢æˆ·ç«¯è¯·æ±‚äº†id-serverè·å–idã€‚å…¶è°ƒç”¨é“¾å¦‚ä¸‹ï¼š pinpointæä¾›çš„åŠŸèƒ½æ¯”è¾ƒä¸°å¯Œï¼Œä¸‹å›¾æ˜¯è°ƒç”¨/api/idæ¥å£çš„è¯¦ç»†ä¿¡æ¯ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œpinpointè®°å½•äº†å®¢æˆ·ç«¯çš„ç›¸åº”æ—¶é—´ã€IPåœ°å€ç­‰ï¼Œè°ƒç”¨æ ‘åœ¨ä¸‹é¢ä¹Ÿæœ‰è¯¦ç»†åˆ—å‡ºï¼Œæ¯ä¸ªæ–¹æ³•çš„è€—æ—¶ç­‰ã€‚ serverMapä¸­è¿˜å±•ç¤ºäº†æœåŠ¡å™¨çš„å †ã€æ°¸ä¹…ä»£ã€CPUç­‰ä¿¡æ¯ï¼Œéå¸¸å¼ºå¤§ã€‚ 5. SkywalkingSkywalkingæ˜¯å›½å†…å¼€æºçš„APMç›‘æ§ç»„ä»¶ï¼Œå®˜ç½‘OpenSkywalkingï¼Œæ ¹æ®å®˜ç½‘ä»‹ç»ï¼Œå…¶ç€åŠ›äºæ€§èƒ½å’Œå®æ—¶æ€§ä¸¤æ–¹é¢ã€‚ç½‘ä¸Šæ‰¾åˆ°çš„Skywalkingçš„æ¶æ„å›¾ã€‚ å¯ä»¥çœ‹åˆ°Skywalkingä¹Ÿæ˜¯å››éƒ¨åˆ†ç»„æˆï¼Œcollectorã€agentã€webã€storageã€‚æ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé›†ç¾¤ä¹‹é—´è¿˜å¼•å…¥äº†grpcé€šä¿¡ã€‚å­˜å‚¨æ”¯æŒå†…ç½®çš„h2å’Œelasticsearchå­˜å‚¨ã€‚ 5.1 å®‰è£…å…·ä½“å®‰è£…å¯è§å®˜ç½‘ã€‚ collectorå®‰è£…æ­¤å¤„ç¬”è€…ä½¿ç”¨å•æœºç‰ˆçš„collectorï¼Œåœ¨releaseé¡µé¢ä¸‹è½½å¥½å‹ç¼©åŒ…ï¼Œè§£å‹åï¼Œå•æœºç‰ˆçš„collectoré»˜è®¤ä½¿ç”¨h2æ•°æ®åº“ï¼Œæ‰€ä»¥é…ç½®æ–‡ä»¶å¯ä»¥ä¸éœ€è¦ä¿®æ”¹ï¼Œå³å¯ä»¥è¿è¡Œbin/startup.shã€‚ ç›®å½•ç»“æ„å¦‚ä¸Šï¼Œlogsæ–‡ä»¶å¤¹ä¸­ï¼Œæœ‰å¯åŠ¨çš„æ—¥å¿—ï¼Œå¯ä»¥æŸ¥çœ‹å¯åŠ¨æƒ…å†µã€‚ webè§£å‹å¥½skywalking-uiï¼Œè®¾ç½®serverçš„config/collector_config.propertiesã€log4j2ä»¥åŠç›‘å¬ç«¯å£ç­‰ç›¸å…³ä¿¡æ¯ï¼Œ agentæ‹·è´skywalking-agentç›®å½•åˆ°æ‰€éœ€ä½ç½®ï¼Œæ¢é’ˆåŒ…å«æ•´ä¸ªç›®å½•ï¼Œè®¾ç½®/config/agent.configä¸­çš„collectorä¿¡æ¯ã€‚ 5.2 è¿è¡ŒagentSpring bootçš„é¡¹ç›®ï¼Œå¯åŠ¨å’Œä¸Šé¢pinpoint agentå¯åŠ¨æ–¹å¼ç›¸åŒã€‚å¢åŠ JVMå¯åŠ¨å‚æ•°ï¼Œ-javaagent:/path/to/skywalking-agent/skywalking-agent.jarã€‚ è¿™æ¬¡èµ·äº†useræœåŠ¡ï¼Œæ¶‰åŠåˆ°mysqlã€redisã€consulç­‰ç»„ä»¶ã€‚å¯ä»¥çœ‹åˆ°å…¶è°ƒç”¨é“¾è·¯å›¾å¦‚ä¸‹ï¼š å½“è®¿é—®/api/external/register-codeå’Œ/api/external/validate-codeæ¥å£æ—¶ï¼Œå½¢æˆäº†ä¸Šå›¾ä¸­çš„è°ƒç”¨é“¾ã€‚ ä¸Šå›¾TraceIdä¸º 2.59.15103021777910001çš„è¯·æ±‚/api/external/register-codeã€‚è¿™æ¬¡traceä¸­ï¼Œæ¯ä¸ªæ¶‰åŠçš„spançš„è€—æ—¶éƒ½æœ‰åœ¨å›¾ä¸­ç»Ÿè®¡ã€‚ ä¸Šé¢è¿™å¼ å›¾ï¼Œæ˜¯å¯¹userServiceä¸­çš„Entry Service Listæ¥å£è¿›è¡Œäº†ç»Ÿè®¡ï¼ŒåŒ…æ‹¬è°ƒç”¨æ•°ã€æˆåŠŸç‡ç­‰ä¿¡æ¯ã€‚ï¼ˆå› ä¸ºå†…ç½®çš„h2ï¼Œè¿™è¾¹åœ¨UIå“åº”å¾ˆä¹…ï¼‰ è¿˜æœ‰ä¸ªå¯¹instanceçš„ç»Ÿè®¡ï¼Œç»Ÿè®¡jvmçš„ç›¸å…³ä¿¡æ¯ï¼ŒAPIå“åº”ä¹Ÿå¾ˆæ…¢ï¼Œå¯èƒ½ä¸æˆ‘ç”¨çš„å­˜å‚¨æœ‰å…³å§ï¼Œå°±ä¸æˆªå›¾äº†ã€‚ 6. æ€»ç»“æœ¬æ–‡ä¸»è¦å†™äº†é“¾è·¯ç›‘æ§ç»„ä»¶çš„å®è·µã€‚é¦–å…ˆä»‹ç»äº†é“¾è·¯ç›‘æ§ç»„ä»¶äº§ç”Ÿä¸åº”ç”¨çš„èƒŒæ™¯ï¼Œä»¥åŠé€‰æ‹©çš„è¦æ±‚ï¼›å…¶æ¬¡ä»‹ç»äº†opentracingä¸­æ¶‰åŠçš„åŸºæœ¬æ¦‚å¿µï¼›æœ€åå¤§ç¯‡å¹…ä»‹ç»äº†ä¸‰ç§APMç»„ä»¶çš„å®‰è£…ä¸ä½¿ç”¨ï¼Œå¹¶å±•ç¤ºäº†æ¯ç§APMçš„UIæˆªå›¾ã€‚æœ¬æ–‡æ¯”è¾ƒç®€å•ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»å‡ ç§APMé€‰å‹çš„æ¯”è¾ƒä¸æ€§èƒ½æµ‹è¯•ã€‚ zipkin-server-streamçš„æºç github: https://github.com/keets2012/Spring-Boot-Samples/oschina: https://gitee.com/keets/spring-boot-samples å‚è€ƒ(ç–¯ç‹‚æ‰¾èµ„æ–™) OpenTracingå®˜æ–¹æ ‡å‡†-ä¸­æ–‡ç‰ˆ Skywalking Zipkin PinPoint Spring Cloud Sleuth Dapper pinpoint å®‰è£…éƒ¨ç½² javaå¼€æºAPMæ¦‚è¦ åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§ç³»ç»Ÿzipkinå…¥é—¨ è·Ÿç€å°ç¨‹å­¦å¾®æœåŠ¡-è‡ªå·±åŠ¨æ‰‹æ‰©å±•åˆ†å¸ƒå¼è°ƒç”¨é“¾]]></content>
      <categories>
        <category>Ops</category>
      </categories>
      <tags>
        <tag>APM</tag>
        <tag>zipkin</tag>
        <tag>micro-service</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¾®æœåŠ¡éƒ¨ç½²ä¹‹Mavenæ’ä»¶æ„å»ºDockeré•œåƒ]]></title>
    <url>%2F2017%2F11%2F02%2Fdockermaven%2F</url>
    <content type="text"><![CDATA[1.èƒŒæ™¯å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œå¾®æœåŠ¡åœ¨å¸¦æ¥è‰¯å¥½çš„è®¾è®¡å’Œæ¶æ„ç†å¿µçš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†è¿ç»´ä¸Šçš„é¢å¤–å¤æ‚æ€§ï¼Œå°¤å…¶æ˜¯åœ¨æœåŠ¡éƒ¨ç½²å’ŒæœåŠ¡ç›‘æ§ä¸Šã€‚å•ä½“åº”ç”¨æ˜¯é›†ä¸­å¼çš„ï¼Œå°±ä¸€ä¸ªå•ä½“è·‘åœ¨ä¸€èµ·ï¼Œéƒ¨ç½²å’Œç®¡ç†çš„æ—¶å€™éå¸¸ç®€å•ï¼Œè€Œå¾®æœåŠ¡æ˜¯ä¸€ä¸ªç½‘çŠ¶åˆ†å¸ƒçš„ï¼Œæœ‰å¾ˆå¤šæœåŠ¡éœ€è¦ç»´æŠ¤å’Œç®¡ç†ï¼Œå¯¹å®ƒè¿›è¡Œéƒ¨ç½²å’Œç»´æŠ¤çš„æ—¶å€™åˆ™æ¯”è¾ƒå¤æ‚ã€‚ ä¸‹é¢ä»Devçš„è§’åº¦æ¥çœ‹ä¸€ä¸‹Opsçš„å·¥ä½œã€‚ä»Devæäº¤ä»£ç ï¼Œåˆ°å®Œæˆé›†æˆæµ‹è¯•çš„ä¸€ç³»åˆ—æ­¥éª¤å¦‚ä¸‹ï¼š é¦–å…ˆæ˜¯å¼€å‘äººå‘˜æŠŠç¨‹åºä»£ç æ›´æ–°åä¸Šä¼ åˆ°Gitï¼Œç„¶åå…¶ä»–çš„äº‹æƒ…éƒ½å°†ç”±Jenkinsè‡ªåŠ¨å®Œæˆã€‚ ç„¶åGitåœ¨æ¥æ”¶åˆ°ç”¨æˆ·æ›´æ–°çš„ä»£ç åï¼Œä¼šæŠŠæ¶ˆæ¯å’Œä»»åŠ¡ä¼ é€’ç»™Jenkinsï¼Œç„¶åJenkinsä¼šè‡ªåŠ¨æ„å»ºä¸€ä¸ªä»»åŠ¡ï¼Œä¸‹è½½Mavenç›¸å…³çš„è½¯ä»¶åŒ…ã€‚ä¸‹è½½å®Œæˆåï¼Œå°±å¼€å§‹åˆ©ç”¨Maven Buildæ–°çš„é¡¹ç›®åŒ…ï¼Œç„¶åé‡å»ºMavenå®¹å™¨ï¼Œæ„å»ºæ–°çš„Imageå¹¶Pushåˆ°Dockerç§æœ‰åº“ä¸­ã€‚ æœ€ååˆ é™¤æ­£åœ¨è¿è¡Œçš„Dockerå®¹å™¨ï¼Œå†åŸºäºæ–°çš„é•œåƒé‡æ–°æŠŠDockerå®¹å™¨å¯åŠ¨ï¼Œè‡ªåŠ¨å®Œæˆé›†æˆæµ‹è¯•ã€‚ æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯è‡ªåŠ¨çš„ï¼Œè¿™æ ·å°±ç®€åŒ–äº†åŸæœ¬å¤æ‚çš„é›†æˆå·¥ä½œï¼Œä¸€å¤©å¯ä»¥é›†æˆä¸€æ¬¡ï¼Œç”šè‡³æ˜¯å¤šæ¬¡ã€‚ æœ¬æ–‡ä¸»è¦å…³æ³¨çš„ç¬¬äºŒæ­¥ï¼Œä½œä¸ºDevä½¿ç”¨Mavenæ’ä»¶æ„å»ºDockeré•œåƒã€‚ 2. è¿‡ç¨‹æ­¥éª¤2.1 ç¯å¢ƒç¬”è€…çš„ç”µè„‘ç³»ç»Ÿæ˜¯MacOSï¼Œåœ¨è¿›è¡Œä¸‹é¢çš„æ­¥éª¤ä¹‹å‰ï¼Œå…ˆå…·å¤‡ä¸€ä¸‹æ¡ä»¶ï¼š Docker Registry Mavenï¼ˆ3.5.0ï¼‰ JDK(1.8.0_131) Docker for Mac (17.09.0-ce-mac35) Maven å’ŒJDK å°±ä¸ç”¨è¿‡å¤šå¤šäº†ï¼Œå¿…é¡»å…·æœ‰çš„ã€‚Docker Registryæ˜¯ç§æœ‰çš„hubï¼Œmacä¸Šè£…å¥½dockerä¹‹åï¼Œé…ç½®ä¸€ä¸‹Docker Registryçš„åœ°å€ï¼Œé…ç½®å¦‚ä¸‹ï¼š 1234567&#123; "debug" : true, "experimental" : false, "insecure-registries" : [ "192.168.1.202" ]&#125; é…ç½®å¥½registryåœ°å€ä¹‹åï¼Œæœ¬åœ°pullé•œåƒï¼Œè¿˜éœ€è¦å‘½ä»¤è¡Œloginåˆ°registryï¼š 1docker login 192.168.1.202 --username admin --password 123456 2.2 pomæ–‡ä»¶pomæ–‡ä»¶ä¸­éœ€è¦å¼•å…¥ç›¸åº”çš„æ’ä»¶ã€‚docker-maven-pluginæœ‰ä¸‰æ¬¾ï¼šspotifyã€fabric8ioå’Œbibryamã€‚å…¶ä¸­ç¬¬ä¸€æ¬¾æœ€ä¸ºæµè¡Œï¼Œèµ„æ–™ä¹Ÿå¤šï¼Œæ‰€ä»¥æ¯«ä¸çŠ¹è±«é€‰æ‹©ç¬¬ä¸€æ¬¾ã€‚æ’ä»¶æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€ç§æ˜¯åœ¨ç›´æ¥åœ¨pomé…ç½®ä¸­æŒ‡å®šbaseImageå’ŒentryPointã€‚å¦ä¸€ç§é€‚åˆäºå¤æ‚çš„æ„å»ºï¼Œä½¿ç”¨dockerfileï¼Œåªéœ€è¦åœ¨é…ç½®ä¸­æŒ‡å®šdockerfileçš„ä½ç½®ã€‚å‰ä¸€ç§æ¯”è¾ƒç®€å•ï¼Œæ­¤å¤„ç•¥è¿‡ï¼Œä¸»è¦è®²ä¸‹ç¬¬äºŒç§çš„é…ç½®ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243&lt;plugin&gt; &lt;groupId&gt;com.spotify&lt;/groupId&gt; &lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt; &lt;version&gt;$&#123;maven.docker.version&#125;&lt;/version&gt; &lt;!--æ’ä»¶ç»‘å®šåˆ°phase--&gt; &lt;executions&gt; &lt;execution&gt; &lt;phase&gt;install&lt;/phase&gt; &lt;goals&gt; &lt;goal&gt;build&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;!--é…ç½®å˜é‡ï¼ŒåŒ…æ‹¬æ˜¯å¦buildã€imageNameã€imageTagï¼Œéå¸¸çµæ´»--&gt; &lt;skipDocker&gt;$&#123;docker.skip.build&#125;&lt;/skipDocker&gt; &lt;imageName&gt;$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;&lt;/imageName&gt; &lt;!--æœ€åé•œåƒäº§ç”Ÿäº†ä¸¤ä¸ªtagï¼Œç‰ˆæœ¬å’Œå’Œæœ€æ–°çš„--&gt; &lt;imageTags&gt; &lt;imageTag&gt;$&#123;project.version&#125;&lt;/imageTag&gt; &lt;imageTag&gt;latest&lt;/imageTag&gt; &lt;/imageTags&gt; &lt;forceTags&gt;true&lt;/forceTags&gt; &lt;env&gt; &lt;TZ&gt;Asia/Shanghai&lt;/TZ&gt; &lt;/env&gt; &lt;!--æ—¶åŒºé…ç½®--&gt; &lt;runs&gt; &lt;run&gt;ln -snf /usr/share/zoneinfo/$TZ /etc/localtime&lt;/run&gt; &lt;run&gt;echo $TZ &gt; /etc/timezone&lt;/run&gt; &lt;/runs&gt; &lt;dockerDirectory&gt;$&#123;project.basedir&#125;&lt;/dockerDirectory&gt; &lt;resources&gt; &lt;resource&gt; &lt;targetPath&gt;/&lt;/targetPath&gt; &lt;directory&gt;$&#123;project.build.directory&#125;&lt;/directory&gt; &lt;include&gt;$&#123;project.build.finalName&#125;.jar&lt;/include&gt; &lt;/resource&gt; &lt;/resources&gt; &lt;!--pushåˆ°ç§æœ‰çš„hub--&gt; &lt;serverId&gt;docker-registry&lt;/serverId&gt; &lt;/configuration&gt; &lt;/plugin&gt; ${maven.docker.version}ã€${docker.skip.build}ã€${docker.image.prefix}éƒ½æ˜¯å¯é…ç½®çš„å˜é‡ã€‚${project.basedir}ã€${project.build.directory}ã€${project.build.finalName}ã€${project.version}åˆ†åˆ«å¯¹åº”é¡¹ç›®æ ¹ç›®å½•ã€æ„å»ºç›®å½•ã€æ‰“åŒ…åç”Ÿæˆçš„ç»“æœåç§°ã€é¡¹ç›®ç‰ˆæœ¬å·ã€‚ä¸Šé¢çš„pomæ’ä»¶é…ç½®ï¼ŒæŒ‡å®šäº†dockerfileçš„ä½ç½®å’Œé•œåƒçš„å‘½åè§„åˆ™ã€‚å¹¶å°†dockerçš„buildç›®æ ‡ï¼Œç»‘å®šåœ¨installè¿™ä¸ªphaseä¸Šã€‚ 2.3 dockerfile12345FROM 192.168.1.202/library/basejavaVOLUME /tmpADD ./target/cloud-api-gateway-1.2.0.RELEASE.jar app.jarRUN bash -c 'touch /app.jar'ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom","-jar","/app.jar"] dockerfile å†™çš„å¾ˆç®€å•ï¼Œå°†jaråŒ…ADDè¿›å»ï¼Œæä¾›ENTRYPOINTã€‚ 2.4 setting.xmlåœ¨pomæ’ä»¶ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªserverIdçš„é…ç½®ã€‚è¿™ä¸ªé…ç½®æ˜¯å¿…è¦çš„ï¼Œå¯¹äºéœ€è¦å°†imageä¸Šä¼ åˆ°ç§æœ‰hubä¸Šï¼Œåœ¨å¦‚ä¸Šé…ç½®ä¹‹åï¼Œåªéœ€è¦åŠ ä¸Š-DpushImageå³å¯å®ç°ã€‚serverIdæ˜¯ä¸mavençš„é…ç½®æ–‡ä»¶setting.xmlç›¸å¯¹åº”ï¼Œsetting.xmlä¸­å¢åŠ çš„é…ç½®ï¼š 12345678&lt;server&gt; &lt;id&gt;docker-registry&lt;/id&gt; &lt;username&gt;ç”¨æˆ·å&lt;/username&gt; &lt;password&gt;å¯†ç &lt;/password&gt; &lt;configuration&gt; &lt;email&gt;é‚®ç®±&lt;/email&gt; &lt;/configuration&gt;&lt;/server&gt; 2.5 ç»“æœ ä¸Šå›¾æ˜¯æ‰§è¡Œmvn clean install -DpushImageæˆåŠŸçš„ç»“æœã€‚mvné¦–å…ˆæ˜¯æ‰“åŒ…ï¼Œå°†ç”Ÿäº§çš„æ–‡ä»¶æ‹·è´åˆ°targetä¸‹çš„dockerç›®å½•ï¼Œç„¶åæ‰§è¡Œdockerfileä¸­çš„æ­¥éª¤ï¼Œå°†æ‰“æˆçš„é•œåƒè¿›è¡Œtagï¼Œæœ€åä¸Šä¼ åˆ°ç§æœ‰hubä¸Šã€‚ ä¸Šå›¾æ˜¯VMware Harborä¸­çš„æˆªå›¾ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸå°†é•œåƒä¸Šä¼ ï¼Œå…¶tagæœ‰ä¸¤ä¸ªï¼š1.2.0.RELEASEå’Œlatestã€‚ 3. æ€»ç»“æœ¬æ–‡å±äºå·¥ç¨‹å®è·µç±»æ–‡ç« ï¼Œæ¯”è¾ƒç®€å•ã€‚å¼€å¤´ç”±èƒŒæ™¯ä»‹ç»äº†Devåˆ°ç»§æ‰¿æµ‹è¯•çš„ä¸€ç³»åˆ—æ­¥éª¤ï¼Œæœ¬æ–‡ä¸»è¦å…³æ³¨çš„æ˜¯ç¬¬äºŒæ­¥ï¼Œä½œä¸ºDevä½¿ç”¨Mavenæ’ä»¶æ„å»ºDockeré•œåƒã€‚æ­£æ–‡éƒ¨åˆ†ä¸»è¦è®²äº†å®è·µçš„ç¯å¢ƒï¼Œç„¶åè®²äº†docker-maven-pluginæ’ä»¶çš„ä½¿ç”¨æ–¹å¼ï¼Œé‡ç‚¹ä»‹ç»äº†ä½¿ç”¨dockerfileçš„æ–¹å¼ï¼Œå¯¹äºæ¶‰åŠåˆ°çš„é…ç½®è¿›è¡Œäº†è§£é‡Šã€‚ æœ¬æ–‡çš„æºç åœ°å€ï¼šGitHubï¼šhttps://github.com/keets2012/snowflake-id-generatorç äº‘ï¼š https://gitee.com/keets/snowflake-id-generator å‚è€ƒ ä»è¿ç»´çš„è§’åº¦çœ‹å¾®æœåŠ¡å’Œå®¹å™¨ Dockerä¸å¾®æœåŠ¡-ä½¿ç”¨Mavenæ’ä»¶æ„å»ºDockeré•œåƒ]]></content>
      <categories>
        <category>Ops</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Ops</tag>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆå››ï¼‰]]></title>
    <url>%2F2017%2F10%2F26%2Fsecurity4%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ï¼š æœ¬æ–‡ç³»ã€Šè®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ã€‹ç³»åˆ—çš„å®Œç»“ç¯‡ï¼Œå‰é¢ä¸‰ç¯‡å·²ç»å°†è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶çš„æµç¨‹å’Œä¸»è¦ç»†èŠ‚è®²è§£å®Œã€‚æœ¬æ–‡æ¯”è¾ƒé•¿ï¼Œå¯¹è¿™ä¸ªç³»åˆ—è¿›è¡Œæ”¶å°¾ï¼Œä¸»è¦å†…å®¹åŒ…æ‹¬å¯¹æˆæƒå’Œé‰´æƒæµç¨‹ä¹‹å¤–çš„endpointä»¥åŠSpring Securityè¿‡æ»¤å™¨éƒ¨åˆ†è¸©å‘çš„ç»å†ã€‚æ¬¢è¿é˜…è¯»æœ¬ç³»åˆ—æ–‡ç« ã€‚ 1. å‰æ–‡å›é¡¾é¦–å…ˆè¿˜æ˜¯ç…§ä¾‹å¯¹å‰æ–‡è¿›è¡Œå›é¡¾ã€‚åœ¨ç¬¬ä¸€ç¯‡ è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰ä»‹ç»äº†è¯¥é¡¹ç›®çš„èƒŒæ™¯ä»¥åŠæŠ€æœ¯è°ƒç ”ä¸æœ€åé€‰å‹ã€‚ç¬¬äºŒç¯‡è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆäºŒï¼‰ç”»å‡ºäº†ç®€è¦çš„ç™»å½•å’Œæ ¡éªŒçš„æµç¨‹å›¾ï¼Œå¹¶é‡ç‚¹è®²è§£äº†ç”¨æˆ·èº«ä»½çš„è®¤è¯ä¸tokenå‘æ”¾çš„å…·ä½“å®ç°ã€‚ç¬¬ä¸‰ç¯‡è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸‰ï¼‰å…ˆä»‹ç»äº†èµ„æºæœåŠ¡å™¨é…ç½®ï¼Œä»¥åŠå…¶ä¸­æ¶‰åŠçš„é…ç½®ç±»ï¼Œåé¢é‡ç‚¹è®²è§£äº†tokenä»¥åŠAPIçº§åˆ«çš„é‰´æƒã€‚ æœ¬æ–‡å°†ä¼šè®²è§£å‰©ä½™çš„ä¸¤ä¸ªå†…ç½®ç«¯ç‚¹ï¼šæ³¨é”€å’Œåˆ·æ–°tokenã€‚æ³¨é”€tokenç«¯ç‚¹çš„å¤„ç†ä¸Spring Securityé»˜è®¤æä¾›çš„æœ‰äº›â€™/logoutâ€™æœ‰äº›åŒºåˆ«ï¼Œä¸ä»…æ¸…ç©ºSpringSecurityContextHolderä¸­çš„ä¿¡æ¯ï¼Œè¿˜è¦å¢åŠ å¯¹å­˜å‚¨tokençš„æ¸…ç©ºã€‚å¦ä¸€ä¸ªåˆ·æ–°tokenç«¯ç‚¹å…¶å®å’Œä¹‹å‰çš„è¯·æ±‚æˆæƒæ˜¯ä¸€æ ·çš„APIï¼Œåªæ˜¯å‚æ•°ä¸­çš„grant_typeä¸ä¸€æ ·ã€‚ é™¤äº†ä»¥ä¸Šä¸¤ä¸ªå†…ç½®ç«¯ç‚¹ï¼Œåé¢å°†ä¼šé‡ç‚¹è®²ä¸‹å‡ ç§Spring Securityè¿‡æ»¤å™¨ã€‚APIçº§åˆ«çš„æ“ä½œæƒé™æ ¡éªŒæœ¬æ¥è®¾æƒ³æ˜¯é€šè¿‡Spring Securityçš„è¿‡æ»¤å™¨å®ç°ï¼Œç‰¹åœ°æŠŠè¿™è¾¹å­¦ä¹ äº†ä¸€éï¼Œè¸©äº†ä¸€éå‘ã€‚ æœ€åæ˜¯æœ¬ç³»åˆ—çš„æ€»ç»“ï¼Œå¹¶å¯¹äºå­˜åœ¨çš„ä¸è¶³å’Œåç»­å·¥ä½œè¿›è¡Œè®ºè¿°ã€‚ 2. å…¶ä»–ç«¯ç‚¹2.1 æ³¨é”€ç«¯ç‚¹åœ¨ç¬¬ä¸€ç¯‡ä¸­æåˆ°äº†Authç³»ç»Ÿå†…ç½®çš„æ³¨é”€ç«¯ç‚¹ /logoutï¼Œå¦‚æœè¿˜è®°å¾—ç¬¬ä¸‰ç¯‡èµ„æºæœåŠ¡å™¨çš„é…ç½®ï¼Œä¸‹é¢çš„å…³äº/logouté…ç½®ä¸€å®šä¸é™Œç”Ÿã€‚ 123456//... .and().logout() .logoutUrl("/logout") .clearAuthentication(true) .logoutSuccessHandler(new HttpStatusReturningLogoutSuccessHandler()) .addLogoutHandler(customLogoutHandler()); ä¸Šé¢é…ç½®çš„ä¸»è¦ä½œç”¨æ˜¯ï¼š è®¾ç½®æ³¨é”€çš„URL æ¸…ç©ºAuthenticationä¿¡æ¯ è®¾ç½®æ³¨é”€æˆåŠŸçš„å¤„ç†æ–¹å¼ è®¾ç½®è‡ªå®šä¹‰çš„æ³¨é”€å¤„ç†æ–¹å¼ å½“ç„¶åœ¨LogoutConfigurerä¸­è¿˜æœ‰æ›´å¤šçš„è®¾ç½®é€‰é¡¹ï¼Œç¬”è€…æ­¤å¤„åˆ—å‡ºé¡¹ç›®æ‰€éœ€è¦çš„é…ç½®é¡¹ã€‚è¿™äº›é…ç½®é¡¹å›´ç»•ç€LogoutFilterè¿‡æ»¤å™¨ã€‚é¡ºå¸¦è®²ä¸€ä¸‹Spring Securityçš„è¿‡æ»¤å™¨ã€‚å…¶ä½¿ç”¨äº†springSecurityFillterChianä½œä¸ºäº†å®‰å…¨è¿‡æ»¤çš„å…¥å£ï¼Œå„ç§è¿‡æ»¤å™¨æŒ‰é¡ºåºå…·ä½“å¦‚ä¸‹ï¼š SecurityContextPersistenceFilterï¼šä¸SecurityContextå®‰å…¨ä¸Šä¸‹æ–‡ä¿¡æ¯æœ‰å…³ HeaderWriterFilterï¼šç»™httpå“åº”æ·»åŠ ä¸€äº›Header CsrfFilterï¼šé˜²æ­¢csrfæ”»å‡»ï¼Œé»˜è®¤å¼€å¯ LogoutFilterï¼šå¤„ç†æ³¨é”€çš„è¿‡æ»¤å™¨ UsernamePasswordAuthenticationFilterï¼šè¡¨å•è®¤è¯è¿‡æ»¤å™¨ RequestCacheAwareFilterï¼šç¼“å­˜requestè¯·æ±‚ SecurityContextHolderAwareRequestFilterï¼šæ­¤è¿‡æ»¤å™¨å¯¹ServletRequestè¿›è¡Œäº†ä¸€æ¬¡åŒ…è£…ï¼Œä½¿å¾—requestå…·æœ‰æ›´åŠ ä¸°å¯Œçš„API AnonymousAuthenticationFilterï¼šåŒ¿åèº«ä»½è¿‡æ»¤å™¨ SessionManagementFilterï¼šsessionç›¸å…³çš„è¿‡æ»¤å™¨ï¼Œå¸¸ç”¨æ¥é˜²æ­¢session-fixation protection attackï¼Œä»¥åŠé™åˆ¶åŒä¸€ç”¨æˆ·å¼€å¯å¤šä¸ªä¼šè¯çš„æ•°é‡ ExceptionTranslationFilterï¼šå¼‚å¸¸å¤„ç†è¿‡æ»¤å™¨ FilterSecurityInterceptorï¼šwebåº”ç”¨å®‰å…¨çš„å…³é”®Filter å„ç§è¿‡æ»¤å™¨ç®€å•æ ‡æ³¨äº†ä½œç”¨ï¼Œåœ¨ä¸‹ä¸€èŠ‚é‡ç‚¹è®²å…¶ä¸­çš„å‡ ä¸ªè¿‡æ»¤å™¨ã€‚æ³¨é”€è¿‡æ»¤å™¨æ’åœ¨é å‰çš„ä½ç½®ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹LogoutFilterçš„UMLç±»å›¾ã€‚ ç±»å›¾å’Œæˆ‘ä»¬ä¹‹å‰é…ç½®æ—¶çš„æ€è·¯æ˜¯ä¸€è‡´çš„ï¼ŒHttpSecurityåˆ›å»ºäº†LogoutConfigurerï¼Œæˆ‘ä»¬åœ¨è¿™è¾¹é…ç½®äº†LogoutConfigurerçš„ä¸€äº›å±æ€§ã€‚åŒæ—¶LogoutConfigureræ ¹æ®è¿™äº›å±æ€§åˆ›å»ºäº†LogoutFilterã€‚ LogoutConfigurerçš„é…ç½®ï¼Œç¬¬ä¸€å’Œç¬¬äºŒç‚¹å°±ä¸ç”¨å†è¯¦ç»†è§£é‡Šäº†ï¼Œä¸€ä¸ªæ˜¯è®¾ç½®ç«¯ç‚¹ï¼Œå¦ä¸€ä¸ªæ˜¯æ¸…ç©ºè®¤è¯ä¿¡æ¯ã€‚å¯¹äºç¬¬ä¸‰ç‚¹ï¼Œé…ç½®æ³¨é”€æˆåŠŸçš„å¤„ç†æ–¹å¼ã€‚ç”±äºé¡¹ç›®æ˜¯å‰åç«¯åˆ†ç¦»ï¼Œå®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“æ‰§è¡ŒæˆåŠŸè¯¥APIæ¥å£çš„çŠ¶æ€ï¼Œå¹¶ä¸ç”¨è¿”å›å…·ä½“çš„é¡µé¢æˆ–è€…ç»§ç»­å‘ä¸‹ä¼ é€’è¯·æ±‚ã€‚å› æ­¤ï¼Œè¿™è¾¹é…ç½®äº†é»˜è®¤çš„HttpStatusReturningLogoutSuccessHandlerï¼ŒæˆåŠŸç›´æ¥è¿”å›çŠ¶æ€ç 200ã€‚å¯¹äºç¬¬å››ç‚¹é…ç½®ï¼Œè‡ªå®šä¹‰æ³¨é”€å¤„ç†çš„æ–¹æ³•ã€‚è¿™è¾¹éœ€è¦å€ŸåŠ©TokenStoreï¼Œå¯¹tokenè¿›è¡Œæ“ä½œã€‚TokenStoreåœ¨ä¹‹å‰æ–‡ç« çš„é…ç½®ä¸­å·²ç»è®²è¿‡ï¼Œä½¿ç”¨çš„æ˜¯JdbcTokenStoreã€‚é¦–å…ˆæ ¡éªŒè¯·æ±‚çš„åˆæ³•æ€§ï¼Œå¦‚æœåˆæ³•åˆ™å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œå…ˆåç§»é™¤refreshTokenå’ŒexistingAccessTokenã€‚ 12345678910111213141516171819202122232425262728293031323334public class CustomLogoutHandler implements LogoutHandler &#123; //... @Override public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) &#123; //ç¡®å®šæ³¨å…¥äº†tokenStore Assert.notNull(tokenStore, "tokenStore must be set"); //è·å–å¤´éƒ¨çš„è®¤è¯ä¿¡æ¯ String token = request.getHeader("Authorization"); Assert.hasText(token, "token must be set"); //æ ¡éªŒtokenæ˜¯å¦ç¬¦åˆJwtBeareræ ¼å¼ if (isJwtBearerToken(token)) &#123; token = token.substring(6); OAuth2AccessToken existingAccessToken = tokenStore.readAccessToken(token); OAuth2RefreshToken refreshToken; if (existingAccessToken != null) &#123; if (existingAccessToken.getRefreshToken() != null) &#123; LOGGER.info("remove refreshToken!", existingAccessToken.getRefreshToken()); refreshToken = existingAccessToken.getRefreshToken(); tokenStore.removeRefreshToken(refreshToken); &#125; LOGGER.info("remove existingAccessToken!", existingAccessToken); tokenStore.removeAccessToken(existingAccessToken); &#125; return; &#125; else &#123; throw new BadClientCredentialsException(); &#125; &#125; //...&#125; æ‰§è¡Œå¦‚ä¸‹è¯·æ±‚ï¼š 123456method: geturl: http://localhost:9000/logoutheader:&#123; Authorization: Basic ZnJvbnRlbmQ6ZnJvbnRlbmQ=&#125; æ³¨é”€æˆåŠŸåˆ™ä¼šè¿”å›200ï¼Œå°†tokenå’ŒSecurityContextHolderè¿›è¡Œæ¸…ç©ºã€‚ 2.2 åˆ·æ–°ç«¯ç‚¹åœ¨ç¬¬ä¸€ç¯‡å°±å·²ç»è®²è¿‡ï¼Œç”±äºtokençš„æ—¶æ•ˆä¸€èˆ¬ä¸ä¼šå¾ˆé•¿ï¼Œè€Œrefresh tokenä¸€èˆ¬å‘¨æœŸä¼šå¾ˆé•¿ï¼Œä¸ºäº†ä¸å½±å“ç”¨æˆ·çš„ä½“éªŒï¼Œå¯ä»¥ä½¿ç”¨refresh tokenå»åŠ¨æ€çš„åˆ·æ–°tokenã€‚åˆ·æ–°tokenä¸»è¦ä¸RefreshTokenGranteræœ‰å…³ï¼ŒCompositeTokenGranterç®¡ç†ä¸€ä¸ªListåˆ—è¡¨ï¼Œæ¯ä¸€ç§grantTypeå¯¹åº”ä¸€ä¸ªå…·ä½“çš„çœŸæ­£æˆæƒè€…ï¼Œrefresh_ tokenå¯¹åº”çš„granterå°±æ˜¯RefreshTokenGranterï¼Œè€Œgranterå†…éƒ¨åˆ™æ˜¯é€šè¿‡grantTypeæ¥åŒºåˆ†æ˜¯å¦æ˜¯å„è‡ªçš„æˆæƒç±»å‹ã€‚æ‰§è¡Œå¦‚ä¸‹è¯·æ±‚ï¼š 123456method: post url: http://localhost:12000/oauth/token?grant_type=refresh_token&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsInVzZXJfbmFtZSI6ImtlZXRzIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6ImJhZDcyYjE5LWQ5ZjMtNDkwMi1hZmZhLTA0MzBlN2RiNzllZCIsImV4cCI6MTUxMDk5NjU1NiwianRpIjoiYWE0MWY1MjctODE3YS00N2UyLWFhOTgtZjNlMDZmNmY0NTZlIiwiY2xpZW50X2lkIjoiZnJvbnRlbmQifQ.mICT1-lxOAqOU9M-Ud7wZBb4tTux6OQWouQJ2nn1DeEheader:&#123; Authorization: Basic ZnJvbnRlbmQ6ZnJvbnRlbmQ=&#125; åœ¨refresh_ tokenæ­£ç¡®çš„æƒ…å†µä¸‹ï¼Œå…¶è¿”å›çš„responseå’Œ/oauth/tokenå¾—åˆ°æ­£å¸¸çš„å“åº”æ˜¯ä¸€æ ·çš„ã€‚å…·ä½“çš„ä»£ç å¯ä»¥å‚é˜…ç¬¬äºŒç¯‡çš„è®²è§£ã€‚ 3. Spring Securityè¿‡æ»¤å™¨åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†å†…ç½®çš„ä¸¤ä¸ªç«¯ç‚¹çš„å®ç°ç»†èŠ‚ï¼Œè¿˜æåˆ°äº†HttpSecurityè¿‡æ»¤å™¨ï¼Œå› ä¸ºæ³¨é”€ç«¯ç‚¹çš„å®ç°å°±æ˜¯é€šè¿‡è¿‡æ»¤å™¨çš„ä½œç”¨ã€‚æ ¸å¿ƒçš„è¿‡æ»¤å™¨ä¸»è¦æœ‰ï¼š FilterSecurityInterceptor UsernamePasswordAuthenticationFilter SecurityContextPersistenceFilter ExceptionTranslationFilter è¿™ä¸€èŠ‚å°†é‡ç‚¹ä»‹ç»å…¶ä¸­çš„UsernamePasswordAuthenticationFilterå’ŒFilterSecurityInterceptorã€‚ 3.1 UsernamePasswordAuthenticationFilterç¬”è€…åœ¨åˆšå¼€å§‹çœ‹å…³äºè¿‡æ»¤å™¨çš„æ–‡ç« ï¼Œå¯¹äºUsernamePasswordAuthenticationFilteræœ‰ä¸å°‘çš„æ–‡ç« ä»‹ç»ã€‚å¦‚æœåªæ˜¯å¼•å…¥Spring-Securityï¼Œå¿…ç„¶ä¼šä¸/loginç«¯ç‚¹ç†Ÿæ‚‰ã€‚SpringSecurityå¼ºåˆ¶è¦æ±‚æˆ‘ä»¬çš„è¡¨å•ç™»å½•é¡µé¢å¿…é¡»æ˜¯ä»¥POSTæ–¹å¼å‘/login URLæäº¤è¯·æ±‚ï¼Œè€Œä¸”è¦æ±‚ç”¨æˆ·åå’Œå¯†ç çš„å‚æ•°åå¿…é¡»æ˜¯usernameå’Œpasswordã€‚å¦‚æœä¸ç¬¦åˆï¼Œåˆ™ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚åŸå› åœ¨äºï¼Œå½“æˆ‘ä»¬è°ƒç”¨äº†HttpSecurityå¯¹è±¡çš„formLoginæ–¹æ³•æ—¶ï¼Œå…¶æœ€ç»ˆä¼šç»™æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªè¿‡æ»¤å™¨UsernamePasswordAuthenticationFilterã€‚çœ‹ä¸€ä¸‹è¯¥è¿‡æ»¤å™¨çš„æºç ã€‚ 1234567891011121314151617181920212223242526272829303132333435public class UsernamePasswordAuthenticationFilter extends AbstractAuthenticationProcessingFilter &#123; //ç”¨æˆ·åã€å¯†ç  public static final String SPRING_SECURITY_FORM_USERNAME_KEY = "username"; public static final String SPRING_SECURITY_FORM_PASSWORD_KEY = "password"; private String usernameParameter = SPRING_SECURITY_FORM_USERNAME_KEY; private String passwordParameter = SPRING_SECURITY_FORM_PASSWORD_KEY; private boolean postOnly = true; //postè¯·æ±‚/login public UsernamePasswordAuthenticationFilter() &#123; super(new AntPathRequestMatcher("/login", "POST")); &#125; //å®ç°æŠ½è±¡ç±»AbstractAuthenticationProcessingFilterçš„æŠ½è±¡æ–¹æ³•ï¼Œå°è¯•éªŒè¯ public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException &#123; if (postOnly &amp;&amp; !request.getMethod().equals("POST")) &#123; throw new AuthenticationServiceException( "Authentication method not supported: " + request.getMethod()); &#125; String username = obtainUsername(request); String password = obtainPassword(request); //Â·Â·Â· username = username.trim(); UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken( username, password); //Â·Â·Â· return this.getAuthenticationManager().authenticate(authRequest); &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970public abstract class AbstractAuthenticationProcessingFilter extends GenericFilterBean implements ApplicationEventPublisherAware, MessageSourceAware &#123; //... //è°ƒç”¨requiresAuthenticationï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦éœ€è¦authenticationï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨attemptAuthentication //æœ‰ä¸‰ç§ç»“æœå¯èƒ½è¿”å›ï¼š //1.Authenticationå¯¹è±¡ //2. AuthenticationException //3. Authenticationå¯¹è±¡ä¸ºç©º public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException &#123; HttpServletRequest request = (HttpServletRequest) req; HttpServletResponse response = (HttpServletResponse) res; //ä¸éœ€è¦æ ¡éªŒï¼Œç»§ç»­ä¼ é€’ if (!requiresAuthentication(request, response)) &#123; chain.doFilter(request, response); return; &#125; Authentication authResult; try &#123; authResult = attemptAuthentication(request, response); if (authResult == null) &#123; // return immediately as subclass has indicated that it hasn't completed authentication return; &#125; sessionStrategy.onAuthentication(authResult, request, response); &#125; //... catch (AuthenticationException failed) &#123; // Authentication failed unsuccessfulAuthentication(request, response, failed); return; &#125; // Authentication success if (continueChainBeforeSuccessfulAuthentication) &#123; chain.doFilter(request, response); &#125; successfulAuthentication(request, response, chain, authResult); &#125; //å®é™…æ‰§è¡Œçš„authenticationï¼Œç»§æ‰¿ç±»å¿…é¡»å®ç°è¯¥æŠ½è±¡æ–¹æ³• public abstract Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException, IOException, ServletException; //æˆåŠŸauthenticationçš„é»˜è®¤è¡Œä¸º protected void successfulAuthentication(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult) throws IOException, ServletException &#123; //... &#125; //å¤±è´¥authenticationçš„é»˜è®¤è¡Œä¸º protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException failed) throws IOException, ServletException &#123; //... &#125; ... //è®¾ç½®AuthenticationManager public void setAuthenticationManager(AuthenticationManager authenticationManager) &#123; this.authenticationManager = authenticationManager; &#125; ...&#125; UsernamePasswordAuthenticationFilterå› ä¸ºç»§æ‰¿äº†AbstractAuthenticationProcessingFilteræ‰æ‹¥æœ‰è¿‡æ»¤å™¨çš„åŠŸèƒ½ã€‚AbstractAuthenticationProcessingFilterè¦æ±‚è®¾ç½®ä¸€ä¸ªauthenticationManagerï¼ŒauthenticationManagerçš„å®ç°ç±»å°†å®é™…å¤„ç†è¯·æ±‚çš„è®¤è¯ã€‚AbstractAuthenticationProcessingFilterå°†æ‹¦æˆªç¬¦åˆè¿‡æ»¤è§„åˆ™çš„requestï¼Œå¹¶è¯•å›¾æ‰§è¡Œè®¤è¯ã€‚å­ç±»å¿…é¡»å®ç° attemptAuthentication æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ‰§è¡Œå…·ä½“çš„è®¤è¯ã€‚è®¤è¯ä¹‹åçš„å¤„ç†å’Œä¸Šæ³¨é”€çš„å·®ä¸å¤šã€‚å¦‚æœè®¤è¯æˆåŠŸï¼Œå°†ä¼šæŠŠè¿”å›çš„Authenticationå¯¹è±¡å­˜æ”¾åœ¨SecurityContextï¼Œå¹¶è°ƒç”¨SuccessHandlerï¼Œä¹Ÿå¯ä»¥è®¾ç½®æŒ‡å®šçš„URLå’ŒæŒ‡å®šè‡ªå®šä¹‰çš„å¤„SuccessHandlerã€‚å¦‚æœè®¤è¯å¤±è´¥ï¼Œé»˜è®¤ä¼šè¿”å›401ä»£ç ç»™å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥è®¾ç½®URLï¼ŒæŒ‡å®šè‡ªå®šä¹‰çš„å¤„ç†FailureHandlerã€‚ åŸºäºUsernamePasswordAuthenticationFilterè‡ªå®šä¹‰çš„AuthenticationFilteè¿˜æ˜¯æŒºå¤šæ¡ˆä¾‹çš„ï¼Œè¿™è¾¹æ¨èä¸€ç¯‡åšæ–‡Spring Security(äº”)â€“åŠ¨æ‰‹å®ç°ä¸€ä¸ªIP_Loginï¼Œå†™å¾—æ¯”è¾ƒè¯¦ç»†ã€‚ 3.2 FilterSecurityInterceptorFilterSecurityInterceptoræ˜¯filterchainä¸­æ¯”è¾ƒå¤æ‚ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒæ ¸å¿ƒçš„è¿‡æ»¤å™¨ï¼Œä¸»è¦è´Ÿè´£webåº”ç”¨å®‰å…¨æˆæƒçš„å·¥ä½œã€‚é¦–å…ˆçœ‹ä¸‹å¯¹äºè‡ªå®šä¹‰çš„FilterSecurityInterceptoré…ç½®ã€‚ 12345678910111213@Override public void configure(HttpSecurity http) throws Exception &#123; ... //æ·»åŠ CustomSecurityFilterï¼Œè¿‡æ»¤å™¨çš„é¡ºåºæ”¾åœ¨FilterSecurityInterceptor http.antMatcher("/oauth/check_token").addFilterAt(customSecurityFilter(), FilterSecurityInterceptor.class); &#125; //æä¾›å®ä¾‹åŒ–çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨ @Bean public CustomSecurityFilter customSecurityFilter() &#123; return new CustomSecurityFilter(); &#125; ä»ä¸Šè¿°é…ç½®å¯ä»¥çœ‹åˆ°ï¼Œåœ¨FilterSecurityInterceptorçš„ä½ç½®æ³¨å†Œäº†CustomSecurityFilterï¼Œå¯¹äºåŒ¹é…åˆ°/oauth/check_tokenï¼Œåˆ™ä¼šè°ƒç”¨è¯¥è¿›å…¥è¯¥è¿‡æ»¤å™¨ã€‚ä¸‹å›¾ä¸ºFilterSecurityInterceptorçš„ç±»å›¾ï¼Œåœ¨å…¶ä¸­è¿˜æ·»åŠ äº†CustomSecurityFilterå’Œç›¸å…³å®ç°çš„æ¥å£çš„ç±»ï¼Œæ–¹ä¾¿è¯»è€…å¯¹æ¯”ç€çœ‹ã€‚ CustomSecurityFilteræ˜¯æ¨¡ä»¿FilterSecurityInterceptorå®ç°ï¼Œç»§æ‰¿AbstractSecurityInterceptorå’Œå®ç°Filteræ¥å£ã€‚æ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¾èµ–AuthenticationManagerã€AccessDecisionManagerå’ŒFilterInvocationSecurityMetadataSourceã€‚AuthenticationManageræ˜¯è®¤è¯ç®¡ç†å™¨ï¼Œå®ç°ç”¨æˆ·è®¤è¯çš„å…¥å£ï¼›AccessDecisionManageræ˜¯è®¿é—®å†³ç­–å™¨ï¼Œå†³å®šæŸä¸ªç”¨æˆ·å…·æœ‰çš„è§’è‰²ï¼Œæ˜¯å¦æœ‰è¶³å¤Ÿçš„æƒé™å»è®¿é—®æŸä¸ªèµ„æºï¼›FilterInvocationSecurityMetadataSourceæ˜¯èµ„æºæºæ•°æ®å®šä¹‰ï¼Œå³å®šä¹‰æŸä¸€èµ„æºå¯ä»¥è¢«å“ªäº›è§’è‰²è®¿é—®ã€‚ä»ä¸Šé¢çš„ç±»å›¾ä¸­å¯ä»¥çœ‹åˆ°è‡ªå®šä¹‰çš„CustomSecurityFilteråŒæ—¶åˆå®ç°äº†AccessDecisionManagerå’ŒFilterInvocationSecurityMetadataSourceã€‚åˆ†åˆ«ä¸ºSecureResourceFilterInvocationDefinitionSourceå’ŒSecurityAccessDecisionManagerã€‚ä¸‹é¢åˆ†æä¸‹ä¸»è¦çš„é…ç½®ã€‚ 12345678910111213//é€šè¿‡ä¸€ä¸ªå®ç°çš„filterï¼Œå¯¹HTTPèµ„æºè¿›è¡Œå®‰å…¨å¤„ç†public class FilterSecurityInterceptor extends AbstractSecurityInterceptor implements Filter &#123; //è¢«filter chainçœŸå®è°ƒç”¨çš„æ–¹æ³•ï¼Œé€šè¿‡invokeä»£ç† public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException &#123; FilterInvocation fi = new FilterInvocation(request, response, chain); invoke(fi); &#125; //ä»£ç†çš„æ–¹æ³• public void invoke(FilterInvocation fi) throws IOException, ServletException &#123; //...çœç•¥ &#125;&#125; ä¸Šè¿°ä»£ç æ˜¯FilterSecurityInterceptorä¸­çš„å®ç°ï¼Œå…·ä½“å®ç°ç»†èŠ‚å°±æ²¡åˆ—å‡ºäº†ï¼Œæˆ‘ä»¬è¿™è¾¹é‡ç‚¹åœ¨äºå¯¹è‡ªå®šä¹‰çš„å®ç°è¿›è¡Œè®²è§£ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142public class CustomSecurityFilter extends AbstractSecurityInterceptor implements Filter &#123; @Autowired SecureResourceFilterInvocationDefinitionSource invocationSource; @Autowired private AuthenticationManager authenticationManager; @Autowired private SecurityAccessDecisionManager decisionManager; //è®¾ç½®çˆ¶ç±»ä¸­çš„å±æ€§ @PostConstruct public void init() &#123; super.setAccessDecisionManager(decisionManager); super.setAuthenticationManager(authenticationManager); &#125; //ä¸»è¦çš„è¿‡æ»¤æ–¹æ³•ï¼Œä¸åŸæ¥çš„ä¸€è‡´ @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123; //logger.info("doFilter in Security "); //æ„é€ ä¸€ä¸ªFilterInvocationï¼Œå°è£…request, response, chain FilterInvocation fi = new FilterInvocation(servletRequest, servletResponse, filterChain); //beforeInvocationä¼šè°ƒç”¨SecureResourceDataSourceä¸­çš„é€»è¾‘ï¼Œç±»ä¼¼äºaopä¸­çš„before InterceptorStatusToken token = super.beforeInvocation(fi); try &#123; //æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ fi.getChain().doFilter(fi.getRequest(), fi.getResponse()); &#125; finally &#123; //å®Œæˆåç»­å·¥ä½œï¼Œç±»ä¼¼äºaopä¸­çš„after super.afterInvocation(token, null); &#125; &#125; //... //èµ„æºæºæ•°æ®å®šä¹‰ï¼Œè®¾ç½®ä¸ºè‡ªå®šä¹‰çš„SecureResourceFilterInvocationDefinitionSource @Override public SecurityMetadataSource obtainSecurityMetadataSource() &#123; return invocationSource; &#125;&#125; ä¸Šé¢è‡ªå®šä¹‰çš„CustomSecurityFilterï¼Œä¸æˆ‘ä»¬ä¹‹å‰çš„è®²è§£æ˜¯ä¸€æ ·çš„æµç¨‹ã€‚ä¸»è¦ä¾èµ–çš„ä¸‰ä¸ªæ¥å£éƒ½æœ‰åœ¨å®ç°ä¸­å®ä¾‹åŒ–æ³¨å…¥ã€‚çœ‹ä¸‹çˆ¶ç±»çš„beforeInvocationæ–¹æ³•ï¼Œå…¶ä¸­çœç•¥äº†ä¸€äº›ä¸é‡è¦çš„ä»£ç ç‰‡æ®µã€‚ 12345678910111213141516171819protected InterceptorStatusToken beforeInvocation(Object object) &#123; //æ ¹æ®SecurityMetadataSourceè·å–é…ç½®çš„æƒé™å±æ€§ Collection&lt;ConfigAttribute&gt; attributes = this.obtainSecurityMetadataSource().getAttributes(object); //... //åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹è®¤è¯å®ä½“é‡æ–°è®¤è¯ï¼Œé»˜è®¤ä¸ºå¦ Authentication authenticated = authenticateIfRequired(); // Attempt authorization try &#123; //å†³ç­–ç®¡ç†å™¨å¼€å§‹å†³å®šæ˜¯å¦æˆæƒï¼Œå¦‚æœæˆæƒå¤±è´¥ï¼Œç›´æ¥æŠ›å‡ºAccessDeniedException this.accessDecisionManager.decide(authenticated, object, attributes); &#125; catch (AccessDeniedException accessDeniedException) &#123; publishEvent(new AuthorizationFailureEvent(object, attributes, authenticated, accessDeniedException)); throw accessDeniedException; &#125; &#125; ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œç¬¬ä¸€æ­¥æ˜¯æ ¹æ®SecurityMetadataSourceè·å–é…ç½®çš„æƒé™å±æ€§ï¼ŒaccessDecisionManagerä¼šç”¨åˆ°æƒé™åˆ—è¡¨ä¿¡æ¯ã€‚ç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹è®¤è¯å®ä½“é‡æ–°è®¤è¯ï¼Œé»˜è®¤ä¸ºå¦ã€‚ç¬¬äºŒæ­¥æ˜¯æ¥ç€å†³ç­–ç®¡ç†å™¨å¼€å§‹å†³å®šæ˜¯å¦æˆæƒï¼Œå¦‚æœæˆæƒå¤±è´¥ï¼Œç›´æ¥æŠ›å‡ºAccessDeniedExceptionã€‚ (1). è·å–é…ç½®çš„æƒé™å±æ€§ 12345678910111213141516171819202122232425262728293031323334353637383940public class SecureResourceFilterInvocationDefinitionSource implements FilterInvocationSecurityMetadataSource, InitializingBean &#123; private PathMatcher matcher; //mapä¿å­˜é…ç½®çš„URLå¯¹åº”çš„æƒé™é›† private static Map&lt;String, Collection&lt;ConfigAttribute&gt;&gt; map = new HashMap&lt;&gt;(); //æ ¹æ®ä¼ å…¥çš„å¯¹è±¡URLè¿›è¡Œå¾ªç¯ @Override public Collection&lt;ConfigAttribute&gt; getAttributes(Object o) throws IllegalArgumentException &#123; logger.info("getAttributes"); //åº”è¯¥åšinstanceof FilterInvocation filterInvocation = (FilterInvocation) o; //String method = filterInvocation.getHttpRequest().getMethod(); String requestURI = filterInvocation.getRequestUrl(); //å¾ªç¯èµ„æºè·¯å¾„ï¼Œå½“è®¿é—®çš„Urlå’Œèµ„æºè·¯å¾„urlåŒ¹é…æ—¶ï¼Œè¿”å›è¯¥Urlæ‰€éœ€è¦çš„æƒé™ for (Iterator&lt;Map.Entry&lt;String, Collection&lt;ConfigAttribute&gt;&gt;&gt; iterator = map.entrySet().iterator(); iter.hasNext(); ) &#123; Map.Entry&lt;String, Collection&lt;ConfigAttribute&gt;&gt; entry = iterator.next(); String url = entry.getKey(); if (matcher.match(url, requestURI)) &#123; return map.get(requestURI); &#125; &#125; return null; &#125; //... //è®¾ç½®æƒé™é›†ï¼Œå³ä¸Šè¿°çš„map @Override public void afterPropertiesSet() throws Exception &#123; logger.info("afterPropertiesSet"); //ç”¨æ¥åŒ¹é…è®¿é—®èµ„æºè·¯å¾„ this.matcher = new AntPathMatcher(); //å¯ä»¥æœ‰å¤šä¸ªæƒé™ Collection&lt;ConfigAttribute&gt; atts = new ArrayList&lt;&gt;(); ConfigAttribute c1 = new SecurityConfig("ROLE_ADMIN"); atts.add(c1); map.put("/oauth/check_token", atts); &#125;&#125; ä¸Šé¢æ˜¯getAttributes()å®ç°çš„å…·ä½“ç»†èŠ‚ï¼Œå°†è¯·æ±‚çš„URLå–å‡ºè¿›è¡ŒåŒ¹é…äº‹å…ˆè®¾å®šçš„å—é™èµ„æºï¼Œæœ€åè¿”å›éœ€è¦çš„æƒé™ã€è§’è‰²ã€‚ç³»ç»Ÿåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè¯»å–åˆ°é…ç½®çš„mapé›†åˆï¼Œå¯¹äºæ‹¦æˆªåˆ°è¯·æ±‚è¿›è¡ŒåŒ¹é…ã€‚ä»£ç ä¸­æ³¨é‡Šæ¯”è¾ƒè¯¦ç»†ï¼Œè¿™è¾¹ä¸å¤šè¯´ã€‚ (2). å†³ç­–ç®¡ç†å™¨ 1234567891011121314151617181920212223242526272829public class SecurityAccessDecisionManager implements AccessDecisionManager &#123; //... @Override public void decide(Authentication authentication, Object o, Collection&lt;ConfigAttribute&gt; collection) throws AccessDeniedException, InsufficientAuthenticationException &#123; logger.info("decide url and permission"); //é›†åˆä¸ºç©º if (collection == null) &#123; return; &#125; Iterator&lt;ConfigAttribute&gt; ite = collection.iterator(); //åˆ¤æ–­ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™ï¼Œæ˜¯å¦ç¬¦åˆå¯¹åº”çš„Urlæƒé™ï¼Œå¦‚æœå®ç°äº†UserDetailsServiceï¼Œåˆ™ç”¨æˆ·æƒé™æ˜¯loadUserByUsernameè¿”å›ç”¨æˆ·æ‰€å¯¹åº”çš„æƒé™ while (ite.hasNext()) &#123; ConfigAttribute ca = ite.next(); String needRole = ca.getAttribute(); for (GrantedAuthority ga : authentication.getAuthorities()) &#123; logger.info("GrantedAuthority: &#123;&#125;", ga); if (needRole.equals(ga.getAuthority())) &#123; return; &#125; &#125; &#125; logger.error("AccessDecisionManager: no right!"); throw new AccessDeniedException("no right!"); &#125; //...&#125; ä¸Šé¢çš„ä»£ç æ˜¯å†³ç­–ç®¡ç†å™¨çš„å®ç°ï¼Œå…¶é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°†è¯·æ±‚æ‰€å…·æœ‰çš„æƒé™ä¸è®¾å®šçš„å—é™èµ„æºæ‰€éœ€çš„è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœå…·æœ‰åˆ™è¿”å›ï¼Œå¦åˆ™æŠ›å‡ºæ²¡æœ‰æ­£ç¡®çš„æƒé™å¼‚å¸¸ã€‚é»˜è®¤æä¾›çš„å†³ç­–ç®¡ç†å™¨æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«ä¸ºAffirmativeBasedã€ConsensusBasedã€UnanimousBasedï¼Œç¯‡å¹…æœ‰é™ï¼Œæˆ‘ä»¬è¿™è¾¹ä¸å†æ‰©å±•äº†ã€‚ è¡¥å……ä¸€ä¸‹ï¼Œæ‰€å…·æœ‰çš„æƒé™æ˜¯é€šè¿‡ä¹‹å‰é…ç½®çš„è®¤è¯æ–¹å¼ï¼Œæœ‰passwordè®¤è¯å’Œclientè®¤è¯ä¸¤ç§ã€‚æˆ‘ä»¬ä¹‹å‰åœ¨æˆæƒæœåŠ¡å™¨ä¸­é…ç½®äº†withClientDetailsï¼Œæ‰€ä»¥ç”¨frontendèº«ä»½éªŒè¯è·å¾—çš„æƒé™æ˜¯æˆ‘ä»¬é¢„å…ˆé…ç½®åœ¨æ•°æ®åº“ä¸­çš„authoritiesã€‚ 4. æ€»ç»“Authç³»ç»Ÿä¸»è¦åŠŸèƒ½æ˜¯æˆæƒè®¤è¯å’Œé‰´æƒã€‚é¡¹ç›®å¾®æœåŠ¡åŒ–åï¼ŒåŸæœ‰çš„å•ä½“åº”ç”¨åŸºäºHttpSessionè®¤è¯é‰´æƒä¸èƒ½æ»¡è¶³å¾®æœåŠ¡æ¶æ„ä¸‹çš„éœ€æ±‚ã€‚æ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦å¯¹è®¿é—®è¿›è¡Œé‰´æƒï¼Œæ¯ä¸ªå¾®åº”ç”¨éƒ½éœ€è¦æ˜ç¡®å½“å‰è®¿é—®ç”¨æˆ·ä»¥åŠå…¶æƒé™ï¼Œå°¤å…¶å½“æœ‰å¤šä¸ªå®¢æˆ·ç«¯ï¼ŒåŒ…æ‹¬webç«¯ã€ç§»åŠ¨ç«¯ç­‰ç­‰ï¼Œå•ä½“åº”ç”¨æ¶æ„ä¸‹çš„é‰´æƒæ–¹å¼å°±ä¸æ˜¯ç‰¹åˆ«åˆé€‚äº†ã€‚æƒé™æœåŠ¡ä½œä¸ºåŸºç¡€çš„å…¬å…±æœåŠ¡ï¼Œä¹Ÿéœ€è¦å¾®æœåŠ¡åŒ–ã€‚ ç¬”è€…çš„è®¾è®¡ä¸­ï¼ŒAuthæœåŠ¡ä¸€æ–¹é¢è¿›è¡Œæˆæƒè®¤è¯ï¼Œå¦ä¸€æ–¹é¢æ˜¯åŸºäºtokenè¿›è¡Œèº«ä»½åˆæ³•æ€§å’ŒAPIçº§åˆ«çš„æƒé™æ ¡éªŒã€‚å¯¹äºæŸä¸ªæœåŠ¡çš„è¯·æ±‚ï¼Œç»è¿‡ç½‘å…³ä¼šè°ƒç”¨AuthæœåŠ¡ï¼Œå¯¹tokenåˆæ³•æ€§è¿›è¡ŒéªŒè¯ã€‚åŒæ—¶ç¬”è€…æ ¹æ®å½“å‰é¡¹ç›®çš„æ•´ä½“æƒ…å†µï¼Œå­˜åœ¨éƒ¨åˆ†é—ç•™æœåŠ¡ï¼Œè¿™äº›é—ç•™æœåŠ¡åˆæ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´å’ŒäººåŠ›ç«‹é©¬è¿›è¡Œå¾®æœåŠ¡æ”¹é€ ï¼Œè€Œä¸”è¿˜éœ€è¦ç»§ç»­è¿è¡Œã€‚ä¸ºäº†é€‚é…å½“å‰æ–°çš„æ¶æ„ï¼Œé‡‡å–çš„æ–¹æ¡ˆå°±æ˜¯å¯¹è¿™äº›é—ç•™æœåŠ¡çš„æ“ä½œAPIï¼Œåœ¨AuthæœåŠ¡è¿›è¡ŒAPIçº§åˆ«çš„æ“ä½œæƒé™é‰´å®šã€‚APIçº§åˆ«çš„æ“ä½œæƒé™æ ¡éªŒéœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯éœ€è¦ç»“åˆä¸šåŠ¡ï¼Œä¸å®¢æˆ·ç«¯è¿›è¡Œå•†å®šï¼Œåº”è¯¥åœ¨tokenèƒ½å–åˆ°ç›¸åº”ä¿¡æ¯ï¼Œä¼ é€’ç»™AuthæœåŠ¡ï¼Œä¸è¿‡åº”å°½é‡å‡å°‘åœ¨headerå–ä¸Šä¸‹æ–‡æ ¡éªŒçš„ä¿¡æ¯ã€‚ ç¬”è€…å°†æœ¬æ¬¡å¼€å‘Authç³»ç»Ÿæ‰€æ¶‰åŠçš„å¤§éƒ¨åˆ†ä»£ç åŠæºç è¿›è¡Œäº†è§£æï¼Œè‡³äºæ²¡æœ‰è®²åˆ°çš„ä¸€äº›å†…å®¹å’Œç»†èŠ‚ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œæ‰©å±•ã€‚ 5. ä¸è¶³ä¸åç»­å·¥ä½œ5.1 å­˜åœ¨çš„ä¸è¶³ APIçº§åˆ«æ“ä½œæƒé™æ ¡éªŒçš„é€šç”¨æ€§ (1). å¯¹äºAPIçº§åˆ«æ“ä½œæƒé™æ ¡éªŒï¼Œéœ€è¦åœ¨ç½‘å…³å¤„è°ƒç”¨æ—¶æ„é€ ç›¸åº”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä¸Šä¸‹æ–‡ä¿¡æ¯åŸºæœ¬ä¾èµ–äº tokenä¸­çš„payloadï¼Œå¦‚æœä¿¡æ¯å¤ªå¤šå¼•èµ·tokenå¤ªé•¿ï¼Œå¯¼è‡´æ¯æ¬¡å®¢æˆ·ç«¯çš„è¯·æ±‚å¤´éƒ¨é•¿åº¦å˜é•¿ã€‚ (2). å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ“ä½œæ¥å£éƒ½èƒ½è¦†ç›–åˆ°ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯æ¯”è¾ƒä¸¥é‡çš„ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡é›†åˆå¾ˆå¯èƒ½å‡ºç°å¥½å¤šæ¥å£ çš„æƒé™æ²¡æ³•é‰´å®šï¼Œæœ€åçš„ç»“æœå°±æ˜¯APIçº§åˆ«æ“ä½œæƒé™æ ¡éªŒå¤±è´¥çš„æ˜¯ç»å¯¹æ²¡æœ‰æƒé™è®¿é—®è¯¥æ¥å£ï¼Œè€Œé€šè¿‡ä¸ä¸€å®šèƒ½è®¿é—®ï¼Œå› ä¸ºè¯¥æ¥å£æ¶‰åŠåˆ°çš„ä¸Šä¸‹æ–‡æ ¹æœ¬æ²¡æ³•å®Œå…¨å¾—åˆ°ã€‚æˆ‘ä»¬çš„é¡¹ç›®åœ¨ç°é˜¶æ®µï¼Œå®šä¹‰çš„æœ€å°ä¸Šä¸‹æ–‡é›†åˆèƒ½å‹‰å¼ºè¦†ç›–åˆ°ï¼Œä½†æ˜¯å¯¹äºåé¢æ‰©å¢çš„æœåŠ¡æ¥å£çœŸçš„æ˜¯ä¸ä¹è§‚ã€‚ (3). æ¯ä¸ªæœåŠ¡çš„æ¯ä¸ªæ¥å£éƒ½åœ¨AuthæœåŠ¡æ³¨å†Œå…¶æ‰€éœ€è¦çš„æƒé™ï¼Œå¤ªè¿‡éº»çƒ¦ï¼ŒAuthæœåŠ¡éœ€è¦é¢å¤–ç»´æŠ¤è¿™æ ·çš„ä¿¡æ¯ã€‚ ç½‘å…³å¤„è°ƒç”¨AuthæœåŠ¡å¸¦æ¥çš„ç³»ç»Ÿååé‡ç“¶é¢ˆ (1). è¿™ä¸ªå…¶å®å¾ˆå®¹æ˜“ç†è§£ï¼ŒAuthæœåŠ¡ä½œä¸ºå…¬å…±çš„åŸºç¡€æœåŠ¡ï¼Œå¤§å¤šæ•°æœåŠ¡æ¥å£éƒ½ä¼šéœ€è¦é‰´æƒï¼ŒAuthæœåŠ¡éœ€è¦ç»è¿‡å¤æ‚ã€‚ (2). ç½‘å…³è°ƒç”¨AuthæœåŠ¡ï¼Œé˜»å¡è°ƒç”¨ï¼Œåªæœ‰ç­‰AuthæœåŠ¡è¿”å›æ ¡éªŒç»“æœï¼Œæ‰ä¼šåšè¿›ä¸€æ­¥å¤„ç†ã€‚è™½è¯´AuthæœåŠ¡å¯ä»¥å¤šå®ä¾‹éƒ¨ç½²ï¼Œä½†æ˜¯å¹¶å‘é‡å¤§äº†ä¹‹åï¼Œå…¶ç“¶é¢ˆæ˜æ˜¾å¯è§ï¼Œä¸¥é‡å¯èƒ½ä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿçš„ä¸å¯ç”¨ã€‚ 5.2 åç»­å·¥ä½œ ä»æ•´ä¸ªç³»ç»Ÿè®¾è®¡è§’åº¦æ¥è®²ï¼ŒAPIçº§åˆ«æ“ä½œæƒé™åæœŸå°†ä¼šåˆ†æ•£åœ¨å„ä¸ªæœåŠ¡çš„æ¥å£ä¸Šï¼Œç”±å„ä¸ªæ¥å£è´Ÿè´£å…¶æ‰€éœ€è¦çš„æƒé™ã€èº«ä»½ç­‰ã€‚Spring Securityå¯¹äºæ¥å£çº§åˆ«çš„æƒé™æ ¡éªŒä¹Ÿæ˜¯æ”¯æŒçš„ï¼Œä¹‹æ‰€ä»¥é‡‡ç”¨è¿™æ ·çš„åšæ³•ï¼Œä¹Ÿæ˜¯ä¸ºäº†å…¼å®¹æ–°æœåŠ¡å’Œé—ç•™çš„æœåŠ¡ï¼Œä¸»è¦æ˜¯é’ˆå¯¹é—ç•™æœåŠ¡ï¼Œæ–°çš„æœåŠ¡é‡‡ç”¨çš„æ˜¯åˆ†æ•£åœ¨å„ä¸ªæ¥å£ä¹‹ä¸Šã€‚ å°†APIçº§åˆ«æ“ä½œæƒé™åˆ†æ•£åˆ°å„ä¸ªæœåŠ¡æ¥å£ä¹‹åï¼Œç›¸åº”çš„èƒ½æå‡AuthæœåŠ¡çš„å“åº”ã€‚ç½‘å…³èƒ½å¤ŸåŠæ—¶çš„å¯¹è¯·æ±‚è¿›è¡Œè½¬å‘æˆ–è€…æ‹’ç»ã€‚ APIçº§åˆ«æ“ä½œæƒé™æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å¯¹å„ä¸ªæ¥å£çœŸçš„è®¾è®¡çš„å¾ˆå¤æ‚ï¼Œè¿™è¾¹æˆ‘ä»¬ç¡®å®èŠ±äº†æ—¶é—´ï¼ŒåŒæ—¶ç®¡ç†ç§»åŠ¨æœåŠ¡çš„å¥½å‡ ç™¾æ“ä½œæ¥å£æ‰€å¯¹åº”çš„æƒé™ï¼Œéå¸¸çƒ¦ã€‚ï¼ æœ¬æ–‡çš„æºç åœ°å€ï¼šGitHubï¼šhttps://github.com/keets2012/Auth-serviceç äº‘ï¼š https://gitee.com/keets/Auth-Service å‚è€ƒ é…ç½®è¡¨å•ç™»å½• Spring Security3æºç åˆ†æ-FilterSecurityInterceptoråˆ†æ Core Security Filters Spring Security(å››)â€“æ ¸å¿ƒè¿‡æ»¤å™¨æºç åˆ†æ ç›¸å…³é˜…è¯»è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆäºŒï¼‰è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸‰ï¼‰]]></content>
      <categories>
        <category>Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
        <tag>OAuth2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸‰ï¼‰]]></title>
    <url>%2F2017%2F10%2F24%2Fsecurity3%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ï¼š æœ¬æ–‡ç³»ã€Šè®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ã€‹ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡ï¼Œæœ¬æ–‡é‡ç‚¹è®²è§£tokenä»¥åŠAPIçº§åˆ«çš„é‰´æƒã€‚æœ¬æ–‡å¯¹æ¶‰åŠåˆ°çš„å¤§éƒ¨åˆ†ä»£ç è¿›è¡Œäº†åˆ†æï¼Œæ¬¢è¿è®¢é˜…æœ¬ç³»åˆ—æ–‡ç« ã€‚ 1. å‰æ–‡å›é¡¾åœ¨å¼€å§‹è®²è§£è¿™ä¸€ç¯‡æ–‡ç« ä¹‹å‰ï¼Œå…ˆå¯¹ä¹‹å‰ä¸¤ç¯‡æ–‡ç« è¿›è¡Œå›å¿†ä¸‹ã€‚åœ¨ç¬¬ä¸€ç¯‡ è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰ä»‹ç»äº†è¯¥é¡¹ç›®çš„èƒŒæ™¯ä»¥åŠæŠ€æœ¯è°ƒç ”ä¸æœ€åé€‰å‹ã€‚ç¬¬äºŒç¯‡è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆäºŒï¼‰ç”»å‡ºäº†ç®€è¦çš„ç™»å½•å’Œæ ¡éªŒçš„æµç¨‹å›¾ï¼Œå¹¶é‡ç‚¹è®²è§£äº†ç”¨æˆ·èº«ä»½çš„è®¤è¯ä¸tokenå‘æ”¾çš„å…·ä½“å®ç°ã€‚ æœ¬æ–‡é‡ç‚¹è®²è§£é‰´æƒï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼štokenåˆæ³•æ€§ä»¥åŠAPIçº§åˆ«çš„æ“ä½œæƒé™ã€‚é¦–å…ˆtokenåˆæ³•æ€§å¾ˆå®¹æ˜“ç†è§£ï¼Œç¬¬äºŒç¯‡æ–‡ç« è®²è§£äº†è·å–æˆæƒtokençš„ä¸€ç³»åˆ—æµç¨‹ï¼Œtokenæ˜¯å¦æ˜¯è®¤è¯æœåŠ¡å™¨é¢å‘çš„ï¼Œå¿…ç„¶æ˜¯éœ€è¦éªŒè¯çš„ã€‚å…¶æ¬¡å¯¹äºAPIçº§åˆ«çš„æ“ä½œæƒé™ï¼Œå°†ä¸Šä¸‹æ–‡ä¿¡æ¯ä¸å…·å¤‡æ“ä½œæƒé™çš„è¯·æ±‚ç›´æ¥æ‹’ç»ï¼Œå½“ç„¶æ­¤å¤„æ˜¯è®¾è®¡tokenåˆæ³•æ€§æ ¡éªŒåœ¨å…ˆï¼Œå…¶æ¬¡å†å¯¹æ“ä½œæƒé™è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœå‰ä¸€ä¸ªéªŒè¯ç›´æ¥æ‹’ç»ï¼Œé€šè¿‡åˆ™è¿›å…¥æ“ä½œæƒé™éªŒè¯ã€‚ 2.èµ„æºæœåŠ¡å™¨é…ç½®ResourceServeré…ç½®åœ¨ç¬¬ä¸€ç¯‡å°±åˆ—å‡ºäº†ï¼Œåœ¨è¿›å…¥é‰´æƒä¹‹å‰ï¼ŒæŠŠè¿™è¾¹çš„é…ç½®ææ¸…ï¼Œå³ä½¿æœ‰äº›é…ç½®åœ¨æœ¬é¡¹ç›®ä¸­æ²¡æœ‰ç”¨åˆ°ï¼Œå¤§å®¶åœ¨è‡ªå·±çš„é¡¹ç›®æœ‰å¯èƒ½ç”¨åˆ°ã€‚ 1234567891011121314151617181920212223242526272829303132333435@Configuration@EnableResourceServerpublic class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123; //httpå®‰å…¨é…ç½® @Override public void configure(HttpSecurity http) throws Exception &#123; //ç¦æ‰csrfï¼Œè®¾ç½®sessionç­–ç•¥ http.csrf().disable() .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and()//é»˜è®¤å…è®¸è®¿é—® .requestMatchers().antMatchers("/**") .and().authorizeRequests() .antMatchers("/**").permitAll() .anyRequest().authenticated() .and().logout() //logoutæ³¨é”€ç«¯ç‚¹é…ç½® .logoutUrl("/logout") .clearAuthentication(true) .logoutSuccessHandler(new HttpStatusReturningLogoutSuccessHandler()) .addLogoutHandler(customLogoutHandler()); &#125; //æ·»åŠ è‡ªå®šä¹‰çš„CustomLogoutHandler @Bean public CustomLogoutHandler customLogoutHandler() &#123; return new CustomLogoutHandler(); &#125; //èµ„æºå®‰å…¨é…ç½®ç›¸å…³ @Override public void configure(ResourceServerSecurityConfigurer resources) throws Exception &#123; super.configure(resources); &#125;&#125; (1). @EnableResourceServerè¿™ä¸ªæ³¨è§£å¾ˆé‡è¦ï¼ŒOAuth2èµ„æºæœåŠ¡å™¨çš„ç®€ä¾¿æ³¨è§£ã€‚å…¶ä½¿å¾—Spring Security filteré€šè¿‡è¯·æ±‚ä¸­çš„OAuth2 tokenæ¥éªŒè¯è¯·æ±‚ã€‚é€šå¸¸ä¸EnableWebSecurityé…åˆä½¿ç”¨ï¼Œè¯¥æ³¨è§£è¿˜åˆ›å»ºäº†ç¡¬ç¼–ç çš„@Order(3) WebSecurityConfigurerAdapterï¼Œç”±äºå½“å‰springçš„æŠ€æœ¯ï¼Œorderçš„é¡ºåºä¸æ˜“ä¿®æ”¹ï¼Œæ‰€ä»¥åœ¨é¡¹ç›®ä¸­é¿å…è¿˜æœ‰å…¶ä»–order=3çš„é…ç½®ã€‚ (2). å…³è”çš„HttpSecurityï¼Œä¸ä¹‹å‰çš„ Spring Security XMLä¸­çš„ â€œhttpâ€å…ƒç´ é…ç½®ç±»ä¼¼ï¼Œå®ƒå…è®¸é…ç½®åŸºäºwebå®‰å…¨ä»¥é’ˆå¯¹ç‰¹å®šhttpè¯·æ±‚ã€‚é»˜è®¤æ˜¯åº”ç”¨åˆ°æ‰€æœ‰çš„è¯·æ±‚ï¼Œé€šè¿‡requestMatcherå¯ä»¥é™å®šå…·ä½“URLèŒƒå›´ã€‚HttpSecurityç±»å›¾å¦‚ä¸‹ã€‚ æ€»çš„æ¥è¯´ï¼šHttpSecurityæ˜¯SecurityBuilderæ¥å£çš„ä¸€ä¸ªå®ç°ç±»ï¼Œä»åå­—ä¸Šæˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªHTTPå®‰å…¨ç›¸å…³çš„æ„å»ºå™¨ã€‚å½“ç„¶æˆ‘ä»¬åœ¨æ„å»ºçš„æ—¶å€™å¯èƒ½éœ€è¦ä¸€äº›é…ç½®ï¼Œå½“æˆ‘ä»¬è°ƒç”¨HttpSecurityå¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨è¿›è¡Œé…ç½®ã€‚ authorizeRequests()ï¼ŒformLogin()ã€httpBasic()è¿™ä¸‰ä¸ªæ–¹æ³•è¿”å›çš„åˆ†åˆ«æ˜¯ExpressionUrlAuthorizationConfigurerã€FormLoginConfigurerã€HttpBasicConfigurerï¼Œä»–ä»¬éƒ½æ˜¯SecurityConfigureræ¥å£çš„å®ç°ç±»ï¼Œåˆ†åˆ«ä»£è¡¨çš„æ˜¯ä¸åŒç±»å‹çš„å®‰å…¨é…ç½®å™¨ã€‚å› æ­¤ï¼Œä»æ€»çš„æµç¨‹ä¸Šæ¥è¯´ï¼Œå½“æˆ‘ä»¬åœ¨è¿›è¡Œé…ç½®çš„æ—¶å€™ï¼Œéœ€è¦ä¸€ä¸ªå®‰å…¨æ„å»ºå™¨SecurityBuilder(ä¾‹å¦‚æˆ‘ä»¬è¿™é‡Œçš„HttpSecurity)ï¼ŒSecurityBuilderå®ä¾‹çš„åˆ›å»ºéœ€è¦æœ‰è‹¥å¹²å®‰å…¨é…ç½®å™¨SecurityConfigurerå®ä¾‹çš„é…åˆã€‚ (3).å…³è”çš„ResourceServerSecurityConfigurerï¼Œä¸ºèµ„æºæœåŠ¡å™¨æ·»åŠ ç‰¹æ®Šçš„é…ç½®ï¼Œé»˜è®¤çš„é€‚ç”¨äºå¾ˆå¤šåº”ç”¨ï¼Œä½†æ˜¯è¿™è¾¹çš„ä¿®æ”¹è‡³å°‘ä»¥resourceIdä¸ºå•ä½ã€‚ç±»å›¾å¦‚ä¸‹ã€‚ ResourceServerSecurityConfigureråˆ›å»ºäº†OAuth2æ ¸å¿ƒè¿‡æ»¤å™¨OAuth2AuthenticationProcessingFilterï¼Œå¹¶ä¸ºå…¶æä¾›å›ºå®šäº†OAuth2AuthenticationManagerã€‚åªæœ‰è¢«OAuth2AuthenticationProcessingFilteræ‹¦æˆªåˆ°çš„oauth2ç›¸å…³è¯·æ±‚æ‰è¢«ç‰¹æ®Šçš„èº«ä»½è®¤è¯å™¨å¤„ç†ã€‚åŒæ—¶è®¾ç½®äº†TokenExtractorã€å¼‚å¸¸å¤„ç†å®ç°ã€‚ OAuth2AuthenticationProcessingFilteræ˜¯OAuth2ä¿æŠ¤èµ„æºçš„é¢„å…ˆè®¤è¯è¿‡æ»¤å™¨ã€‚é…åˆOAuth2AuthenticationManagerä½¿ç”¨ï¼Œæ ¹æ®è¯·æ±‚è·å–åˆ°OAuth2 tokenï¼Œä¹‹åå°±ä¼šä½¿ç”¨OAuth2Authenticationæ¥å¡«å……Spring Securityä¸Šä¸‹æ–‡ã€‚OAuth2AuthenticationManageråœ¨å‰é¢çš„æ–‡ç« ç»™å‡ºçš„AuthenticationManagerç±»å›¾å°±å‡ºç°äº†ï¼Œä¸tokenè®¤è¯ç›¸å…³ã€‚è¿™è¾¹ç•¥è¿‡è´´å‡ºæºç è¿›è¡Œè®²è§£ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚ 3. é‰´æƒendpointé‰´æƒä¸»è¦æ˜¯ä½¿ç”¨å†…ç½®çš„endpoint /oauth/check_tokenï¼Œç¬”è€…å°†å¯¹ç«¯ç‚¹çš„åˆ†ææ”¾åœ¨å‰é¢ï¼Œå› ä¸ºè¿™æ˜¯é‰´æƒçš„å”¯ä¸€å…¥å£ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹è¯¥APIæ¥å£ä¸­çš„ä¸»è¦ä»£ç ã€‚ 123456789101112131415161718192021222324252627282930@RequestMapping(value = "/oauth/check_token") @ResponseBody public Map&lt;String, ?&gt; checkToken(CheckTokenEntity checkTokenEntity) &#123; //CheckTokenEntityä¸ºè‡ªå®šä¹‰çš„dto Assert.notNull(checkTokenEntity, "invalid token entity!"); //è¯†åˆ«token OAuth2AccessToken token = resourceServerTokenServices.readAccessToken(checkTokenEntity.getToken()); //åˆ¤æ–­tokenæ˜¯å¦ä¸ºç©º if (token == null) &#123; throw new InvalidTokenException("Token was not recognised"); &#125; //æœªè¿‡æœŸ if (token.isExpired()) &#123; throw new InvalidTokenException("Token has expired"); &#125; //åŠ è½½OAuth2Authentication OAuth2Authentication authentication = resourceServerTokenServices.loadAuthentication(token.getValue()); //è·å–responseï¼Œtokenåˆæ³•æ€§éªŒè¯å®Œæ¯• Map&lt;String, Object&gt; response = (Map&lt;String, Object&gt;) accessTokenConverter.convertAccessToken(token, authentication); //check for api permission if (response.containsKey("jti")) &#123; //ä¸Šä¸‹æ–‡æ“ä½œæƒé™æ ¡éªŒ Assert.isTrue(checkPermissions.checkPermission(checkTokenEntity)); &#125; response.put("active", true); // Always true if token exists and not expired return response; &#125; çœ‹è¿‡security-oauthæºç çš„åŒå­¦å¯èƒ½ç«‹é©¬å°±çœ‹å‡ºä¸Šè¿°ä»£ç ä¸æºç ä¸åŒï¼Œç†Ÿæ‚‰/oauth/check_tokenæ ¡éªŒæµç¨‹çš„ä¹Ÿä¼šçœ‹å‡ºæ¥ï¼Œè¿™è¾¹ç¬”è€…å¯¹security-oauth jarè¿›è¡Œäº†é‡æ–°ç¼–è¯‘ï¼Œä¿®æ”¹äº†éƒ¨åˆ†æºç ç”¨äºè¯¥é¡¹ç›®éœ€æ±‚çš„åœºæ™¯ã€‚ä¸»è¦æ˜¯åŠ å…¥äº†å‰ç½®çš„APIçº§åˆ«çš„æƒé™æ ¡éªŒã€‚ 4. token åˆæ³•æ€§éªŒè¯ä»ä¸Šé¢çš„CheckTokenEndpointä¸­å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºtokenåˆæ³•æ€§éªŒè¯é¦–å…ˆæ˜¯è¯†åˆ«è¯·æ±‚ä½“ä¸­çš„tokenã€‚ç”¨åˆ°çš„ä¸»è¦æ–¹æ³•æ˜¯ResourceServerTokenServicesæä¾›çš„readAccessToken()æ–¹æ³•ã€‚è¯¥æ¥å£çš„å®ç°ç±»ä¸ºDefaultTokenServicesï¼Œåœ¨ä¹‹å‰çš„é…ç½®ä¸­æœ‰è®²è¿‡è¿™è¾¹é…ç½®äº†jdbcçš„TokenStoreã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public class JdbcTokenStore implements TokenStore &#123; ... public OAuth2AccessToken readAccessToken(String tokenValue) &#123; OAuth2AccessToken accessToken = null; try &#123; //ä½¿ç”¨selectAccessTokenSqlè¯­å¥ï¼Œè°ƒç”¨äº†ç§æœ‰çš„extractTokenKey()æ–¹æ³• accessToken = jdbcTemplate.queryForObject(selectAccessTokenSql, new RowMapper&lt;OAuth2AccessToken&gt;() &#123; public OAuth2AccessToken mapRow(ResultSet rs, int rowNum) throws SQLException &#123; return deserializeAccessToken(rs.getBytes(2)); &#125; &#125;, extractTokenKey(tokenValue)); &#125; //å¼‚å¸¸æƒ…å†µ catch (EmptyResultDataAccessException e) &#123; if (LOG.isInfoEnabled()) &#123; LOG.info("Failed to find access token for token " + tokenValue); &#125; &#125; catch (IllegalArgumentException e) &#123; LOG.warn("Failed to deserialize access token for " + tokenValue, e); //ä¸åˆæ³•åˆ™ç§»é™¤ removeAccessToken(tokenValue); &#125; return accessToken; &#125; ... //æå–TokenKeyæ–¹æ³• protected String extractTokenKey(String value) &#123; if (value == null) &#123; return null; &#125; MessageDigest digest; try &#123; //MD5 digest = MessageDigest.getInstance("MD5"); &#125; catch (NoSuchAlgorithmException e) &#123; throw new IllegalStateException("MD5 algorithm not available. Fatal (should be in the JDK)."); &#125; try &#123; byte[] bytes = digest.digest(value.getBytes("UTF-8")); return String.format("%032x", new BigInteger(1, bytes)); &#125; catch (UnsupportedEncodingException e) &#123; throw new IllegalStateException("UTF-8 encoding not available. Fatal (should be in the JDK)."); &#125; &#125;&#125; readAccessToken()æ£€ç´¢å‡ºè¯¥tokenå€¼çš„å®Œæ•´ä¿¡æ¯ã€‚ä¸Šè¿°ä»£ç æ¯”è¾ƒç®€å•ï¼Œæ¶‰åŠåˆ°çš„é€»è¾‘ä¹Ÿä¸å¤æ‚ï¼Œæ­¤å¤„ç®€å•è®²è§£ã€‚ä¸‹å›¾ä¸ºdebug tokenæ ¡éªŒçš„å˜é‡ä¿¡æ¯ï¼Œè¯»è€…å¯ä»¥è‡ªå·±åŠ¨æ‰‹æ“ä½œä¸‹ï¼Œæˆªå›¾ä»…ä¾›å‚è€ƒã€‚ è‡³äºåé¢çš„æ­¥éª¤ï¼ŒloadAuthentication()ä¸ºç‰¹å®šçš„access token åŠ è½½credentialsã€‚å¾—åˆ°çš„credentials ä¸tokenä½œä¸ºconvertAccessToken()å‚æ•°ï¼Œå¾—åˆ°æ ¡éªŒtokençš„responseã€‚ 5. APIçº§åˆ«æƒé™æ ¡éªŒç¬”è€…é¡¹ç›®ç›®å‰éƒ½æ˜¯åŸºäºWebçš„æƒé™éªŒè¯ï¼Œä¹‹å‰é—ç•™çš„ä¸€ä¸ªå·¨å¤§çš„å•ä½“åº”ç”¨ç³»ç»Ÿæ­£åœ¨é€æ¸æ‹†åˆ†ï¼Œç„¶è€Œå½“å‰åˆä¸èƒ½å®Œå…¨æ‹†åˆ†å®Œå–„ã€‚ä¸ºäº†åŒæ—¶å…¼å®¹æ–°æ—§æœåŠ¡ï¼Œå°½é‡å‡å°‘å¯¹ä¸šåŠ¡ç³»ç»Ÿçš„å…¥ä¾µï¼Œå®ç°å¾®æœåŠ¡çš„ç»Ÿä¸€æ€§å’Œç‹¬ç«‹æ€§ã€‚ç¬”è€…æ ¹æ®ä¸šåŠ¡ä¸šåŠ¡åœºæ™¯ï¼Œå°è¯•åœ¨Authå¤„åšæ“ä½œæƒé™æ ¡éªŒã€‚é¦–å…ˆæƒ³åˆ°çš„æ˜¯èµ„æºæœåŠ¡å™¨é…ç½®ResourceServerï¼Œå¦‚ï¼š 12http.authorizeRequests().antMatchers(&quot;/order/**&quot;).access(&quot;#oauth2.hasScope(&apos;select&apos;) and hasRole(&apos;ROLE_USER&apos;)&quot;) è¿™æ ·åšéœ€è¦å°†æ¯ä¸ªæ“ä½œæ¥å£çš„APIæƒé™æ§åˆ¶æ”¾åœ¨å„ä¸ªä¸åŒçš„ä¸šåŠ¡æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡åœ¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œéœ€è¦å…ˆä»AuthæœåŠ¡å–å‡ºè¯¥token å¯¹åº”çš„roleå’Œscopeç­‰æƒé™ä¿¡æ¯ã€‚è¿™ä¸ªæ–¹æ³•è‚¯å®šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯ç”±äºé¡¹ç›®é‰´æƒçš„ç²’åº¦æ›´ç»†ï¼Œè€Œä¸”æš‚æ—¶ä¸æƒ³å¤§åŠ¨åŸæœ‰ç³»ç»Ÿï¼Œåœ¨åŠ ä¸Šä¹‹å‰ç½‘å…³è®¾è®¡ï¼Œç½‘å…³è°ƒç”¨AuthæœåŠ¡æ ¡éªŒtokenåˆæ³•æ€§ï¼Œæ‰€ä»¥æœ€åå†³å®šåœ¨Authç³»ç»Ÿè°ƒç”¨ä¸­ï¼ŒæŠŠè¿™äº›æ ¡éªŒä¸€èµ·è§£å†³å®Œã€‚ æ–‡ç« å¼€å¤´èµ„æºæœåŠ¡å™¨çš„é…ç½®ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå¯¹äºæ‰€æœ‰çš„èµ„æºå¹¶æ²¡æœ‰åšæ‹¦æˆªï¼Œå› ä¸ºç½‘å…³å¤„æ˜¯è°ƒç”¨Authç³»ç»Ÿçš„ç›¸å…³endpointï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„è¯·æ±‚urléƒ½ä¼šç»è¿‡ä¸€éAuthç³»ç»Ÿï¼Œæ‰€ä»¥å¯¹äºæ‰€æœ‰çš„èµ„æºï¼Œåœ¨Authç³»ç»Ÿä¸­ï¼Œå®šä¹‰éœ€è¦é‰´æƒæ¥å£æ‰€éœ€è¦çš„APIæƒé™ï¼Œç„¶åæ ¹æ®ä¸Šä¸‹æ–‡è¿›è¡ŒåŒ¹é…ã€‚è¿™æ˜¯é‡‡ç”¨çš„ç¬¬äºŒç§æ–¹å¼ï¼Œä¹Ÿæ˜¯ç¬”è€…ç›®å‰é‡‡ç”¨çš„æ–¹æ³•ã€‚å½“ç„¶è¿™ç§æ–¹å¼çš„å¼Šç«¯ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¸€æ—¦å¹¶å‘é‡å¤§ï¼Œç½‘å…³è¿˜è¦è€—æ—¶åœ¨è°ƒç”¨Authç³»ç»Ÿçš„é‰´æƒä¸Šï¼ŒTPSåŠ¿å¿…è¦ä¸‹é™å¾ˆå¤šï¼Œå¯¹äºä¸€äº›ä¸éœ€è¦é‰´æƒçš„æœåŠ¡æ¥å£ä¹Ÿä¼šå¼•èµ·ä¸å¯ç”¨ã€‚å¦å¤–ä¸€ç‚¹æ˜¯ï¼Œå¯¹äºæŸäº›ç‰¹æ®Šæƒé™çš„æ¥å£ï¼Œéœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å¾ˆå¤šï¼Œå¯èƒ½å¹¶ä¸èƒ½å®Œå…¨è¦†ç›–ï¼Œå¯¹äºæ­¤ï¼Œç¬”è€…çš„è§£å†³æ˜¯åˆ†ä¸¤æ–¹é¢ï¼šä¸€æ˜¯å°½é‡å°†è¿™äº›ç‰¹æ®Šæƒ…å†µè¿›è¡Œåˆ†ç±»ï¼ŒæŸä¸€ç±»çš„æƒ…å†µç»Ÿä¸€è§£å†³ï¼›äºŒæ˜¯å°†ä¸¥è‹›çš„æ ¡éªŒé™ä½ï¼Œå¯¹äºä¸Šä¸‹æ–‡æ ¡éªŒå¤±è´¥çš„ç›´æ¥æ‹’ç»ï¼Œè€Œé€šè¿‡çš„ï¼Œå¯¹äºæŸäº›æ¥å£ï¼Œåœ¨æ¥å£å†…è¿›è¡Œæ“ä½œä¹‹å‰ï¼Œå¯¹ç‰¹æ®Šçš„åœ°æ–¹è¿˜è¦å†æ¬¡è¿›è¡Œæ ¡éªŒã€‚ ä¸Šé¢åœ¨è®²endpointæœ‰æåˆ°è¿™è¾¹å¯¹æºç è¿›è¡Œäº†æ”¹å†™ã€‚CheckTokenEntityæ˜¯è‡ªå®šä¹‰çš„DTOï¼Œè¿™è¿™ä¸ªç±»ä¸­å®šä¹‰äº†é‰´æƒéœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œè¿™é‡Œæ˜¯æŒ‡èƒ½æ ¡éªŒæ“ä½œæƒé™çš„æœ€å°é›†åˆï¼Œå¦‚URIã€roleIdã€affairIdç­‰ç­‰ã€‚å¦å¤–å®šä¹‰äº†CheckPermissionsæ¥å£ï¼Œå…¶æ–¹æ³•checkPermission(CheckTokenEntity checkTokenEntity)è¿”å›äº†checkçš„ç»“æœã€‚è€Œå…¶å…·ä½“å®ç°ç±»åˆ™å®šä¹‰åœ¨Authç³»ç»Ÿä¸­ã€‚ç¬”è€…é¡¹ç›®ä¸­è°ƒç”¨çš„å®ä¾‹å¦‚ä¸‹ï¼š 12345678910111213141516171819@Componentpublic class CustomCheckPermission implements CheckPermissions &#123; @Autowired private PermissionService permissionService; @Override public boolean checkPermission(CheckTokenEntity checkTokenEntity) &#123; String url = checkTokenEntity.getUri(); Long affairId = checkTokenEntity.getAffairId(); Long roleId = checkTokenEntity.getRoleId(); //æ ¡éªŒ if (StringUtils.isEmpty(url) || affairId &lt;= 0 || roleId &lt;= 0) &#123; return true; &#125; else &#123; return permissionService.checkPermission(url, affairId, roleId); &#125; &#125;&#125; å…³äºjaråŒ…spring-cloud-starter-oauth2ä¸­çš„å…·ä½“ä¿®æ”¹å†…å®¹ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸‹æ–‡æœ«ç¬”è€…çš„GitHubé¡¹ç›®ã€‚é€šè¿‡è‡ªå®šä¹‰CustomCheckPermissionï¼Œè¦†å†™checkPermission()æ–¹æ³•ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å¯¹è‡ªå·±ä¸šåŠ¡çš„æ“ä½œæƒé™è¿›è¡Œæ ¡éªŒï¼Œéå¸¸çµæ´»ã€‚è¿™è¾¹æ¶‰åŠåˆ°å…·ä½“ä¸šåŠ¡ï¼Œç¬”è€…åœ¨é¡¹ç›®ä¸­åªæä¾›æ¥å£ï¼Œå…·ä½“çš„å®ç°éœ€è¦è¯»è€…è‡ªè¡Œå®Œæˆã€‚ 6. æ€»ç»“æœ¬æ–‡ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œä¸»è¦è®²è§£äº†tokenä»¥åŠAPIçº§åˆ«çš„é‰´æƒã€‚tokençš„åˆæ³•æ€§è®¤è¯å¾ˆå¸¸è§„ï¼ŒAuthç³»ç»Ÿå¯¹äºAPIçº§åˆ«çš„é‰´æƒæ˜¯ç»“åˆè‡ªèº«ä¸šåŠ¡éœ€è¦å’Œç°çŠ¶è¿›è¡Œçš„è®¾è®¡ã€‚è¿™ä¸¤å—çš„æ ¡éªŒéƒ½å‰ç½®åˆ°Authç³»ç»Ÿä¸­ï¼Œä¼˜ç¼ºç‚¹åœ¨ä¸Šé¢çš„å°èŠ‚ä¹Ÿæœ‰è®²è¿°ã€‚æœ€åï¼Œæ¶æ„è®¾è®¡æ ¹æ®è‡ªå·±çš„éœ€æ±‚å’Œç°çŠ¶ï¼Œç¬”è€…çš„è§£å†³æ€è·¯ä»…ä¾›å‚è€ƒã€‚ æœ¬æ–‡çš„æºç åœ°å€ï¼šGitHubï¼šhttps://github.com/keets2012/Auth-serviceç äº‘ï¼š https://gitee.com/keets/Auth-Service å‚è€ƒ å¾®æœåŠ¡APIçº§æƒé™çš„æŠ€æœ¯æ¶æ„ spring-security-oauth Spring-Security Docs ç›¸å…³é˜…è¯»è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆäºŒï¼‰]]></content>
      <categories>
        <category>Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
        <tag>OAuth2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆäºŒï¼‰]]></title>
    <url>%2F2017%2F10%2F22%2Fsecurity2%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ï¼š æœ¬æ–‡ç³»ã€Šè®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ã€‹ç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼Œæœ¬æ–‡é‡ç‚¹è®²è§£ç”¨æˆ·èº«ä»½çš„è®¤è¯ä¸tokenå‘æ”¾çš„å…·ä½“å®ç°ã€‚æœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œå¯¹æ¶‰åŠåˆ°çš„å¤§éƒ¨åˆ†ä»£ç è¿›è¡Œäº†åˆ†æï¼Œå¯æ”¶è—äºé—²æš‡æ—¶é—´é˜…è¯»ï¼Œæ¬¢è¿è®¢é˜…æœ¬ç³»åˆ—æ–‡ç« ã€‚ 1. ç³»ç»Ÿæ¦‚è§ˆåœ¨ä¸Šä¸€ç¯‡ è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰ä»‹ç»äº†è¯¥é¡¹ç›®çš„èƒŒæ™¯ä»¥åŠæŠ€æœ¯è°ƒç ”ä¸æœ€åé€‰å‹ï¼Œå¹¶ä¸”å¯¹äºæœ€ç»ˆå®ç°çš„endpointæ‰§è¡Œç»“æœè¿›è¡Œå±•ç¤ºã€‚å¯¹ç³»ç»Ÿæ¶æ„è™½ç„¶æœ‰æåˆ°ï¼Œä½†æ˜¯å¹¶æœªåˆ—å‡ºè¯¦ç»†æµç¨‹å›¾ã€‚åœ¨ç¬”è€…çš„åº”ç”¨åœºæ™¯ä¸­ï¼ŒAuthç³»ç»Ÿä¸ç½‘å…³è¿›è¡Œç»“åˆã€‚åœ¨ç½‘å…³å‡ºé…ç½®ç›¸åº”çš„ç«¯ç‚¹ä¿¡æ¯ï¼Œå¦‚ç™»å½•ç³»ç»Ÿç”³è¯·tokenæˆæƒï¼Œæ ¡éªŒcheck_tokenç­‰ç«¯ç‚¹ã€‚ ä¸‹å›¾ä¸ºç½‘å…³ä¸Authç³»ç»Ÿç»“åˆçš„æµç¨‹å›¾ï¼Œç½‘å…³ç³»ç»Ÿçš„å…·ä½“å®ç°ç»†èŠ‚åœ¨åé¢å¦å†™æ–‡ç« ä»‹ç»ã€‚ï¼ˆæ­¤å¤„æµç¨‹å›¾çš„ç»˜åˆ¶ä¸­ï¼Œç¬”è€…ä½¿ç”¨æç®€çš„è¯­è¨€æè¿°ï¼Œå„ä½åŒå­¦è½»å–·ğŸ˜†ï¼ï¼‰ ä¸Šå›¾å±•ç¤ºäº†ç³»ç»Ÿç™»å½•çš„ç®€å•æµç¨‹ï¼Œå…¶ä¸­çš„ç»†èŠ‚æœ‰çœç•¥ï¼Œç”¨æˆ·ä¿¡æ¯çš„åˆæ³•æ€§æ ¡éªŒå®é™…æ˜¯è°ƒç”¨ç”¨æˆ·ç³»ç»Ÿã€‚å¤§ä½“æµç¨‹æ˜¯è¿™æ ·ï¼Œå®¢æˆ·ç«¯è¯·æ±‚åˆ°è¾¾ç½‘å…³ä¹‹åï¼Œæ ¹æ®ç½‘å…³è¯†åˆ«çš„è¯·æ±‚ç™»å½•ç«¯ç‚¹ï¼Œè½¬å‘åˆ°Authç³»ç»Ÿï¼Œå°†ç”¨æˆ·çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒã€‚ å¦ä¸€æ–¹é¢æ˜¯å¯¹äºä¸€èˆ¬è¯·æ±‚çš„æ ¡éªŒã€‚ä¸€äº›ä¸éœ€è¦æƒé™çš„å…¬å¼€æ¥å£ï¼Œåœ¨ç½‘å…³å¤„é…ç½®å¥½ï¼Œè¯·æ±‚åˆ°è¾¾ç½‘å…³åï¼ŒåŒ¹é…äº†è·¯å¾„å°†ä¼šç›´æ¥æ”¾è¡Œã€‚å¦‚æœéœ€è¦å¯¹è¯¥è¯·æ±‚è¿›è¡Œæ ¡éªŒï¼Œä¼šå°†è¯¥è¯·æ±‚çš„ç›¸å…³éªŒè¯ä¿¡æ¯æˆªå–ï¼Œä»¥åŠAPIæƒé™æ ¡éªŒæ‰€éœ€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç¬”è€…é¡¹ç›®å¯¹äºä¸€äº›æ“ä½œè¿›è¡Œæƒé™å‰ç½®éªŒè¯ï¼Œä¸‹ä¸€ç¯‡ç« ä¼šè®²åˆ°ï¼‰ï¼Œè°ƒç”¨Authç³»ç»Ÿï¼Œæ ¡éªŒæˆåŠŸåè¿›è¡Œè·¯ç”±è½¬å‘ã€‚ è¿™ç¯‡æ–‡ç« å°±é‡ç‚¹è®²è§£æˆ‘ä»¬åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„ç”¨æˆ·èº«ä»½çš„è®¤è¯ä¸tokenå‘æ”¾ã€‚è¿™ä¸ªä¹Ÿä¸»è¦åŒ…å«ä¸¤ä¸ªæ–¹é¢ï¼š ç”¨æˆ·åˆæ³•æ€§çš„è®¤è¯ è·å–åˆ°æˆæƒçš„token 2. é…ç½®ä¸ç±»å›¾2.1 AuthorizationServerä¸»è¦é…ç½®å…³äºAuthorizationServerå’ŒResourceServerçš„é…ç½®åœ¨ä¸Šä¸€ç¯‡æ–‡ç« å·²ç»åˆ—å‡ºã€‚AuthorizationServerä¸»è¦æ˜¯ç»§æ‰¿äº†AuthorizationServerConfigurerAdapterï¼Œè¦†å†™äº†å…¶å®ç°æ¥å£çš„ä¸‰ä¸ªæ–¹æ³•ï¼š 1234567891011121314//å¯¹åº”äºé…ç½®AuthorizationServerå®‰å…¨è®¤è¯çš„ç›¸å…³ä¿¡æ¯ï¼Œåˆ›å»ºClientCredentialsTokenEndpointFilteræ ¸å¿ƒè¿‡æ»¤å™¨@Overridepublic void configure(AuthorizationServerSecurityConfigurer security) throws Exception &#123; &#125;//é…ç½®OAuth2çš„å®¢æˆ·ç«¯ç›¸å…³ä¿¡æ¯@Overridepublic void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;&#125;//é…ç½®èº«ä»½è®¤è¯å™¨ï¼Œé…ç½®è®¤è¯æ–¹å¼ï¼ŒTokenStoreï¼ŒTokenGranterï¼ŒOAuth2RequestFactory@Overridepublic void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;&#125; 2.2 ä¸»è¦Authenticationç±»çš„ç±»å›¾ ä¸»è¦çš„éªŒè¯æ–¹æ³•authenticate(Authentication authentication)åœ¨æ¥å£AuthenticationManagerä¸­ï¼Œå…¶å®ç°ç±»æœ‰ProviderManagerï¼Œæœ‰ä¸Šå›¾å¯ä»¥çœ‹å‡ºProviderManageråˆä¾èµ–äºAuthenticationProvideræ¥å£ï¼Œå…¶å®šä¹‰äº†ä¸€ä¸ªList&lt;AuthenticationProvider&gt;å…¨å±€å˜é‡ã€‚ç¬”è€…è¿™è¾¹å®ç°äº†è¯¥æ¥å£çš„å®ç°ç±»CustomAuthenticationProviderã€‚è‡ªå®šä¹‰ä¸€ä¸ªproviderï¼Œå¹¶åœ¨GlobalAuthenticationConfigurerAdapterä¸­é…ç½®å¥½æ”¹è‡ªå®šä¹‰çš„æ ¡éªŒproviderï¼Œè¦†å†™configure()æ–¹æ³•ã€‚ 123456789101112@Configurationpublic class AuthenticationManagerConfig extends GlobalAuthenticationConfigurerAdapter &#123; @Autowired CustomAuthenticationProvider customAuthenticationProvider; @Override public void configure(AuthenticationManagerBuilder auth) throws Exception &#123; auth.authenticationProvider(customAuthenticationProvider);//ä½¿ç”¨è‡ªå®šä¹‰çš„AuthenticationProvider &#125;&#125; AuthenticationManagerBuilderæ˜¯ç”¨æ¥åˆ›å»ºAuthenticationManagerï¼Œå…è®¸è‡ªå®šä¹‰æä¾›å¤šç§æ–¹å¼çš„AuthenticationProviderï¼Œæ¯”å¦‚LDAPã€åŸºäºJDBCç­‰ç­‰ã€‚ 3. è®¤è¯ä¸æˆæƒtokenä¸‹é¢è®²è§£è®¤è¯ä¸æˆæƒtokenä¸»è¦çš„ç±»ä¸æ¥å£ã€‚ 3.1 å†…ç½®ç«¯ç‚¹TokenEndpointSpring-Security-Oauth2çš„æä¾›çš„jaråŒ…ä¸­å†…ç½®äº†ä¸tokenç›¸å…³çš„åŸºç¡€ç«¯ç‚¹ã€‚æœ¬æ–‡è®¤è¯ä¸æˆæƒtokenä¸/oauth/tokenæœ‰å…³ï¼Œå…¶å¤„ç†çš„æ¥å£ç±»ä¸ºTokenEndpointã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¯¹äºè®¤è¯ä¸æˆæƒtokenæµç¨‹çš„å…·ä½“å¤„ç†è¿‡ç¨‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445@FrameworkEndpointpublic class TokenEndpoint extends AbstractEndpoint &#123; ... @RequestMapping(value = "/oauth/token", method=RequestMethod.POST) public ResponseEntity&lt;OAuth2AccessToken&gt; postAccessToken(Principal principal, @RequestParam Map&lt;String, String&gt; parameters) throws HttpRequestMethodNotSupportedException &#123; //é¦–å…ˆå¯¹clientä¿¡æ¯è¿›è¡Œæ ¡éªŒ if (!(principal instanceof Authentication)) &#123; throw new InsufficientAuthenticationException( "There is no client authentication. Try adding an appropriate authentication filter."); &#125; String clientId = getClientId(principal); //æ ¹æ®è¯·æ±‚ä¸­çš„clientIdï¼ŒåŠ è½½clientçš„å…·ä½“ä¿¡æ¯ ClientDetails authenticatedClient = getClientDetailsService().loadClientByClientId(clientId); TokenRequest tokenRequest = getOAuth2RequestFactory().createTokenRequest(parameters, authenticatedClient); ... //éªŒè¯scopeåŸŸèŒƒå›´ if (authenticatedClient != null) &#123; oAuth2RequestValidator.validateScope(tokenRequest, authenticatedClient); &#125; //æˆæƒæ–¹å¼ä¸èƒ½ä¸ºç©º if (!StringUtils.hasText(tokenRequest.getGrantType())) &#123; throw new InvalidRequestException("Missing grant type"); &#125; //token endpointä¸æ”¯æŒImplicitæ¨¡å¼ if (tokenRequest.getGrantType().equals("implicit")) &#123; throw new InvalidGrantException("Implicit grant type not supported from token endpoint"); &#125; ... //è¿›å…¥CompositeTokenGranterï¼ŒåŒ¹é…æˆæƒæ¨¡å¼ï¼Œç„¶åè¿›è¡Œpasswordæ¨¡å¼çš„èº«ä»½éªŒè¯å’Œtokençš„å‘æ”¾ OAuth2AccessToken token = getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest); if (token == null) &#123; throw new UnsupportedGrantTypeException("Unsupported grant type: " + tokenRequest.getGrantType()); &#125; return getResponse(token); &#125; ...&#125; ä¸Šé¢ç»™ä»£ç è¿›è¡Œäº†æ³¨é‡Šï¼Œè¯»è€…æ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹ã€‚æ¥å£å¤„ç†çš„ä¸»è¦æµç¨‹å°±æ˜¯å¯¹authenticationä¿¡æ¯è¿›è¡Œæ£€æŸ¥æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åå¯¹è¯·æ±‚çš„GrantTypeè¿›è¡Œå¤„ç†ï¼Œæ ¹æ®GrantTypeï¼Œè¿›è¡Œpasswordæ¨¡å¼çš„èº«ä»½éªŒè¯å’Œtokençš„å‘æ”¾ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹TokenGranterçš„ç±»å›¾ã€‚ å¯ä»¥çœ‹å‡ºTokenGranterçš„å®ç°ç±»CompositeTokenGranterä¸­æœ‰ä¸€ä¸ªList&lt;TokenGranter&gt;ï¼Œå¯¹åº”äº”ç§GrantTypeçš„å®é™…æˆæƒå®ç°ã€‚è¿™è¾¹æ¶‰åŠåˆ°çš„getTokenGranter()ï¼Œä»£ç ä¹Ÿåˆ—ä¸‹ï¼š 123456789101112131415161718192021public class CompositeTokenGranter implements TokenGranter &#123; //GrantTypeçš„é›†åˆï¼Œæœ‰äº”ç§ï¼Œä¹‹å‰æœ‰è®² private final List&lt;TokenGranter&gt; tokenGranters; public CompositeTokenGranter(List&lt;TokenGranter&gt; tokenGranters) &#123; this.tokenGranters = new ArrayList&lt;TokenGranter&gt;(tokenGranters); &#125; //éå†listï¼ŒåŒ¹é…åˆ°ç›¸åº”çš„grantTypeå°±è¿›è¡Œå¤„ç† public OAuth2AccessToken grant(String grantType, TokenRequest tokenRequest) &#123; for (TokenGranter granter : tokenGranters) &#123; OAuth2AccessToken grant = granter.grant(grantType, tokenRequest); if (grant!=null) &#123; return grant; &#125; &#125; return null; &#125; ...&#125; æœ¬æ¬¡è¯·æ±‚æ˜¯ä½¿ç”¨çš„passwordæ¨¡å¼ï¼Œéšåè¿›å…¥å…¶GrantTypeå…·ä½“çš„å¤„ç†æµç¨‹ï¼Œä¸‹é¢æ˜¯grant()æ–¹æ³•ã€‚ 1234567891011121314151617181920212223242526public OAuth2AccessToken grant(String grantType, TokenRequest tokenRequest) &#123; if (!this.grantType.equals(grantType)) &#123; return null; &#125; String clientId = tokenRequest.getClientId(); //åŠ è½½clientIdå¯¹åº”çš„ClientDetailsï¼Œä¸ºäº†ä¸‹ä¸€æ­¥çš„éªŒè¯ ClientDetails client = clientDetailsService.loadClientByClientId(clientId); //å†æ¬¡éªŒè¯clientIdæ˜¯å¦æ‹¥æœ‰è¯¥grantTypeæ¨¡å¼ï¼Œå®‰å…¨ validateGrantType(grantType, client); //è·å–token return getAccessToken(client, tokenRequest);&#125;protected OAuth2AccessToken getAccessToken(ClientDetails client, TokenRequest tokenRequest) &#123;//è¿›å…¥åˆ›å»ºtokenä¹‹å‰ï¼Œè¿›è¡Œèº«ä»½éªŒè¯ return tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));&#125;protected OAuth2Authentication getOAuth2Authentication(ClientDetails client, TokenRequest tokenRequest) &#123;//èº«ä»½éªŒè¯ OAuth2Request storedOAuth2Request = requestFactory.createOAuth2Request(client, tokenRequest); return new OAuth2Authentication(storedOAuth2Request, null);&#125; ä¸Šé¢ä¸€æ®µä»£ç æ˜¯grant()æ–¹æ³•å…·ä½“çš„å®ç°ç»†èŠ‚ã€‚GrantTypeåŒ¹é…åˆ°å…¶å¯¹åº”çš„grant()åï¼Œå…ˆè¿›è¡ŒåŸºæœ¬çš„éªŒè¯ç¡®ä¿å®‰å…¨ï¼Œç„¶åè¿›å…¥ä¸»æµç¨‹ï¼Œå°±æ˜¯ä¸‹é¢å°èŠ‚è¦è®²çš„éªŒè¯èº«ä»½å’Œå‘æ”¾tokenã€‚ 3.2 è‡ªå®šä¹‰çš„éªŒè¯ç±»CustomAuthenticationProviderCustomAuthenticationProviderä¸­å®šä¹‰äº†éªŒè¯æ–¹æ³•çš„å…·ä½“å®ç°ã€‚å…¶å…·ä½“å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚ 1234567891011121314151617181920212223242526//ä¸»è¦çš„è‡ªå®šä¹‰éªŒè¯æ–¹æ³•@Override public Authentication authenticate(Authentication authentication) throws AuthenticationException &#123; String username = authentication.getName(); String password = (String) authentication.getCredentials(); Map data = (Map) authentication.getDetails(); String clientId = (String) data.get("client"); Assert.hasText(clientId,"clientId must have value" ); String type = (String) data.get("type"); //é€šè¿‡è°ƒç”¨useræœåŠ¡ï¼Œæ ¡éªŒç”¨æˆ·ä¿¡æ¯ Map map = userClient.checkUsernameAndPassword(getUserServicePostObject(username, password, type)); //æ ¡éªŒè¿”å›çš„ä¿¡æ¯ï¼Œä¸æ­£ç¡®åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œæˆæƒå¤±è´¥ String userId = (String) map.get("userId"); if (StringUtils.isBlank(userId)) &#123; String errorCode = (String) map.get("code"); throw new BadCredentialsException(errorCode); &#125; CustomUserDetails customUserDetails = buildCustomUserDetails(username, password, userId, clientId); return new CustomAuthenticationToken(customUserDetails); &#125; //æ„é€ ä¸€ä¸ªCustomUserDetailsï¼Œç®€å•ï¼Œç•¥å» private CustomUserDetails buildCustomUserDetails(String username, String password, String userId, String clientId) &#123; &#125;//æ„é€ ä¸€ä¸ªè¯·æ±‚userServiceçš„mapï¼Œå†…å®¹ç•¥ private Map&lt;String, String&gt; getUserServicePostObject(String username, String password, String type) &#123; &#125; authenticate()æœ€åè¿”å›æ„é€ çš„è‡ªå®šä¹‰CustomAuthenticationTokenï¼Œåœ¨CustomAuthenticationTokenä¸­ï¼Œå°†boolean authenticatedè®¾ä¸ºtrueï¼Œuserä¿¡æ¯éªŒè¯æˆåŠŸã€‚è¿™è¾¹ä¼ å…¥çš„å‚æ•°CustomUserDetailsä¸tokenç”Ÿæˆæœ‰å…³ï¼Œä½œä¸ºpayloadä¸­çš„ä¿¡æ¯ï¼Œä¸‹é¢ä¼šè®²åˆ°ã€‚ 12345678910//ç»§æ‰¿æŠ½è±¡ç±»AbstractAuthenticationTokenpublic class CustomAuthenticationToken extends AbstractAuthenticationToken &#123; private CustomUserDetails userDetails; public CustomAuthenticationToken(CustomUserDetails userDetails) &#123; super(null); this.userDetails = userDetails; super.setAuthenticated(true); &#125; ...&#125; è€ŒAbstractAuthenticationTokenå®ç°äº†æ¥å£Authenticationå’ŒCredentialsContainerï¼Œé‡Œé¢çš„å…·ä½“ä¿¡æ¯è¯»è€…å¯ä»¥è‡ªå·±çœ‹ä¸‹æºç ã€‚ 3.3 å…³äºJWTç”¨æˆ·ä¿¡æ¯æ ¡éªŒå®Œæˆä¹‹åï¼Œä¸‹ä¸€æ­¥åˆ™æ˜¯è¦å¯¹è¯¥ç”¨æˆ·è¿›è¡Œæˆæƒã€‚åœ¨è®²å…·ä½“çš„æˆæƒä¹‹å‰ï¼Œå…ˆè¡¥å……ä¸‹å…³äºJWT Tokençš„ç›¸å…³çŸ¥è¯†ç‚¹ã€‚ Json web token (JWT), æ˜¯ä¸ºäº†åœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒé—´ä¼ é€’å£°æ˜è€Œæ‰§è¡Œçš„ä¸€ç§åŸºäºJSONçš„å¼€æ”¾æ ‡å‡†(RFC 7519)ã€‚è¯¥tokenè¢«è®¾è®¡ä¸ºç´§å‡‘ä¸”å®‰å…¨çš„ï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†å¸ƒå¼ç«™ç‚¹çš„å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰åœºæ™¯ã€‚JWTçš„å£°æ˜ä¸€èˆ¬è¢«ç”¨æ¥åœ¨èº«ä»½æä¾›è€…å’ŒæœåŠ¡æä¾›è€…é—´ä¼ é€’è¢«è®¤è¯çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»èµ„æºæœåŠ¡å™¨è·å–èµ„æºï¼Œä¹Ÿå¯ä»¥å¢åŠ ä¸€äº›é¢å¤–çš„å…¶å®ƒä¸šåŠ¡é€»è¾‘æ‰€å¿…é¡»çš„å£°æ˜ä¿¡æ¯ï¼Œè¯¥tokenä¹Ÿå¯ç›´æ¥è¢«ç”¨äºè®¤è¯ï¼Œä¹Ÿå¯è¢«åŠ å¯†ã€‚ ä»ä¸Šé¢çš„æè¿°å¯çŸ¥JWTçš„å®šä¹‰ï¼Œè¿™è¾¹è¯»è€…å¯ä»¥å¯¹æ¯”ä¸‹tokençš„è®¤è¯å’Œä¼ ç»Ÿçš„sessionè®¤è¯çš„åŒºåˆ«ã€‚æ¨èä¸€ç¯‡æ–‡ç« ä»€ä¹ˆæ˜¯ JWT â€“ JSON WEB TOKENï¼Œç¬”è€…è¿™è¾¹å°±ä¸è¯¦ç»†æ‰©å±•è®²äº†ï¼Œåªæ˜¯ç®€å•ä»‹ç»ä¸‹å…¶æ„æˆã€‚ JWTåŒ…å«ä¸‰éƒ¨åˆ†ï¼šheaderå¤´éƒ¨ã€payloadä¿¡æ¯ã€signatureç­¾åã€‚ä¸‹é¢ä»¥ä¸Šä¸€ç¯‡ç”Ÿæˆå¥½çš„access_tokenä¸ºä¾‹ä»‹ç»ã€‚ headerjwtçš„å¤´éƒ¨æ‰¿è½½ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼Œä¸€æ˜¯å£°æ˜ç±»å‹ï¼Œè¿™é‡Œæ˜¯jwtï¼›äºŒæ˜¯å£°æ˜åŠ å¯†çš„ç®—æ³• é€šå¸¸ç›´æ¥ä½¿ç”¨ HMAC SHA256ã€‚ç¬¬ä¸€éƒ¨åˆ†ä¸€èˆ¬å›ºå®šä¸ºï¼š 1eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9 playloadå­˜æ”¾çš„æœ‰æ•ˆä¿¡æ¯ï¼Œè¿™äº›æœ‰æ•ˆä¿¡æ¯åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ã€æ ‡å‡†ä¸­æ³¨å†Œçš„å£°æ˜ã€å…¬å…±çš„å£°æ˜ã€ç§æœ‰çš„å£°æ˜ã€‚è¿™è¾¹ç¬”è€…é¢å¤–æ·»åŠ çš„ä¿¡æ¯ä¸ºX-KEETS-UserIdå’ŒX-KEETS-ClientIdã€‚è¯»è€…å¯æ ¹æ®å®é™…é¡¹ç›®éœ€è¦è¿›è¡Œå®šåˆ¶ã€‚æœ€åplayloadç»è¿‡base64ç¼–ç åçš„ç»“æœä¸ºï¼š 1eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsImV4cCI6MTUwODQ0Nzc1NiwidXNlcl9uYW1lIjoia2VldHMiLCJqdGkiOiJiYWQ3MmIxOS1kOWYzLTQ5MDItYWZmYS0wNDMwZTdkYjc5ZWQiLCJjbGllbnRfaWQiOiJmcm9udGVuZCIsInNjb3BlIjpbImFsbCJdfQ signaturejwtçš„ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ä¸€ä¸ªç­¾è¯ä¿¡æ¯ï¼Œè¿™ä¸ªç­¾è¯ä¿¡æ¯ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šheader (base64åçš„)ã€payload (base64åçš„)ã€secretã€‚å…³äºsecretï¼Œç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šå‘ç°ä¹‹å‰çš„é…ç½®é‡Œé¢æœ‰å…·ä½“è®¾ç½®ã€‚å‰ä¸¤éƒ¨åˆ†è¿æ¥ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œé€šè¿‡headerä¸­å£°æ˜çš„åŠ å¯†æ–¹å¼è¿›è¡ŒåŠ ç›secretç»„åˆåŠ å¯†ï¼Œç„¶åå°±æ„æˆäº†jwtçš„ç¬¬ä¸‰éƒ¨åˆ†ã€‚ç¬¬ä¸‰éƒ¨åˆ†ç»“æœä¸ºï¼š 15ZNVN8TLavgpWy8KZQKArcbj7ItJLLaY1zBRaAgMjdo è‡³äºå…·ä½“åº”ç”¨æ–¹æ³•ï¼Œå¯ä»¥å‚è§ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æ„å»ºçš„/logoutç«¯ç‚¹ã€‚ 3.3 è‡ªå®šä¹‰çš„AuthorizationTokenServicesç°åœ¨åˆ°äº†ä¸ºç”¨æˆ·åˆ›å»ºtokenï¼Œè¿™è¾¹ä¸»è¦ä¸è‡ªå®šä¹‰çš„æ¥å£AuthorizationServerTokenServicesæœ‰å…³ã€‚AuthorizationServerTokenServicesä¸»è¦æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ–¹æ³•ï¼š 1234567//åˆ›å»ºtokenOAuth2AccessToken createAccessToken(OAuth2Authentication authentication) throws AuthenticationException;//åˆ·æ–°tokenOAuth2AccessToken refreshAccessToken(String refreshToken, TokenRequest tokenRequest) throws AuthenticationException;//è·å–tokenOAuth2AccessToken getAccessToken(OAuth2Authentication authentication); ç”±äºç¯‡å¹…é™åˆ¶ï¼Œç¬”è€…è¿™è¾¹ä»…å¯¹createAccessToken()çš„å®ç°æ–¹æ³•è¿›è¡Œåˆ†æï¼Œå…¶ä»–çš„æ–¹æ³•å®ç°ï¼Œè¯»è€…å¯ä»¥ä¸‹å…³æ³¨ç¬”è€…çš„GitHubé¡¹ç›®ã€‚ 1234567891011121314151617181920212223242526272829303132public class CustomAuthorizationTokenServices implements AuthorizationServerTokenServices, ConsumerTokenServices &#123; ... public OAuth2AccessToken createAccessToken(OAuth2Authentication authentication) throws AuthenticationException &#123; //é€šè¿‡TokenStoreï¼Œè·å–ç°å­˜çš„AccessToken OAuth2AccessToken existingAccessToken = tokenStore.getAccessToken(authentication); OAuth2RefreshToken refreshToken; //ç§»é™¤å·²æœ‰çš„AccessTokenå’ŒrefreshToken if (existingAccessToken != null) &#123; if (existingAccessToken.getRefreshToken() != null) &#123; refreshToken = existingAccessToken.getRefreshToken(); // The token store could remove the refresh token when the // access token is removed, but we want to be sure tokenStore.removeRefreshToken(refreshToken); &#125; tokenStore.removeAccessToken(existingAccessToken); &#125; //recreate a refreshToken refreshToken = createRefreshToken(authentication); OAuth2AccessToken accessToken = createAccessToken(authentication, refreshToken); if (accessToken != null) &#123; tokenStore.storeAccessToken(accessToken, authentication); &#125; refreshToken = accessToken.getRefreshToken(); if (refreshToken != null) &#123; tokenStore.storeRefreshToken(refreshToken, authentication); &#125; return accessToken; &#125; ...&#125; è¿™è¾¹å…·ä½“çš„å®ç°åœ¨ä¸Šé¢æœ‰æ³¨é‡Šï¼ŒåŸºæœ¬æ²¡æœ‰æ”¹å†™å¤šå°‘ï¼Œè¯»è€…æ­¤å¤„å¯ä»¥å‚é˜…æºç ã€‚createAccessToken()è¿˜è°ƒç”¨äº†ä¸¤ä¸ªç§æœ‰æ–¹æ³•ï¼Œåˆ†åˆ«åˆ›å»ºaccessTokenå’ŒrefreshTokenã€‚åˆ›å»ºaccessTokenï¼Œéœ€è¦åŸºäºrefreshTokenã€‚æ­¤å¤„å¯ä»¥è‡ªå®šä¹‰è®¾ç½®tokençš„æ—¶æ•ˆé•¿åº¦ï¼ŒaccessTokenåˆ›å»ºå®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617private int refreshTokenValiditySeconds = 60 * 60 * 24 * 30; // default 30 days. private int accessTokenValiditySeconds = 60 * 60 * 12; // default 12 hours. private OAuth2AccessToken createAccessToken(OAuth2Authentication authentication, OAuth2RefreshToken refreshToken) &#123; //å¯¹åº”tokenIdï¼Œå­˜å‚¨çš„æ ‡è¯† DefaultOAuth2AccessToken token = new DefaultOAuth2AccessToken(UUID.randomUUID().toString()); int validitySeconds = getAccessTokenValiditySeconds(authentication.getOAuth2Request()); if (validitySeconds &gt; 0) &#123; token.setExpiration(new Date(System.currentTimeMillis() + (validitySeconds * 1000L))); &#125; token.setRefreshToken(refreshToken); //scopeå¯¹åº”ä½œç”¨èŒƒå›´ token.setScope(authentication.getOAuth2Request().getScope());//ä¸Šä¸€èŠ‚ä»‹ç»çš„è‡ªå®šä¹‰TokenEnhancerï¼Œè¿™è¾¹ä½¿ç”¨ return accessTokenEnhancer != null ? accessTokenEnhancer.enhance(token, authentication) : token; &#125; æ—¢ç„¶æåˆ°TokenEnhancerï¼Œè¿™è¾¹ç®€å•è´´ä¸€ä¸‹ä»£ç ã€‚ 12345678910111213141516171819202122232425public class CustomTokenEnhancer extends JwtAccessTokenConverter &#123; private static final String TOKEN_SEG_USER_ID = "X-KEETS-UserId"; private static final String TOKEN_SEG_CLIENT = "X-KEETS-ClientId"; @Override public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) &#123; CustomUserDetails userDetails = (CustomUserDetails) authentication.getPrincipal(); Map&lt;String, Object&gt; info = new HashMap&lt;&gt;(); //ä»è‡ªå®šä¹‰çš„userDetailsä¸­å–å‡ºUserId info.put(TOKEN_SEG_USER_ID, userDetails.getUserId()); DefaultOAuth2AccessToken customAccessToken = new DefaultOAuth2AccessToken(accessToken); customAccessToken.setAdditionalInformation(info); OAuth2AccessToken enhancedToken = super.enhance(customAccessToken, authentication); //è®¾ç½®ClientId enhancedToken.getAdditionalInformation().put(TOKEN_SEG_CLIENT, userDetails.getClientId()); return enhancedToken; &#125;&#125; è‡ªæ­¤ï¼Œç”¨æˆ·èº«ä»½æ ¡éªŒä¸å‘æ”¾æˆæƒtokenç»“æŸã€‚æœ€ç»ˆæˆåŠŸè¿”å›çš„ç»“æœä¸º: 12345678910&#123; &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsImV4cCI6MTUwODQ0Nzc1NiwidXNlcl9uYW1lIjoia2VldHMiLCJqdGkiOiJiYWQ3MmIxOS1kOWYzLTQ5MDItYWZmYS0wNDMwZTdkYjc5ZWQiLCJjbGllbnRfaWQiOiJmcm9udGVuZCIsInNjb3BlIjpbImFsbCJdfQ.5ZNVN8TLavgpWy8KZQKArcbj7ItJLLaY1zBRaAgMjdo&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsInVzZXJfbmFtZSI6ImtlZXRzIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6ImJhZDcyYjE5LWQ5ZjMtNDkwMi1hZmZhLTA0MzBlN2RiNzllZCIsImV4cCI6MTUxMDk5NjU1NiwianRpIjoiYWE0MWY1MjctODE3YS00N2UyLWFhOTgtZjNlMDZmNmY0NTZlIiwiY2xpZW50X2lkIjoiZnJvbnRlbmQifQ.mICT1-lxOAqOU9M-Ud7wZBb4tTux6OQWouQJ2nn1DeE&quot;, &quot;expires_in&quot;: 43195, &quot;scope&quot;: &quot;all&quot;, &quot;X-KEETS-UserId&quot;: &quot;d6448c24-3c4c-4b80-8372-c2d61868f8c6&quot;, &quot;jti&quot;: &quot;bad72b19-d9f3-4902-affa-0430e7db79ed&quot;, &quot;X-KEETS-ClientId&quot;: &quot;frontend&quot;&#125; 4. æ€»ç»“æœ¬æ–‡å¼€å¤´ç»™å‡ºäº†Authç³»ç»Ÿæ¦‚è¿°ï¼Œç”»å‡ºäº†ç®€è¦çš„ç™»å½•å’Œæ ¡éªŒçš„æµç¨‹å›¾ï¼Œæ–¹ä¾¿è¯»è€…èƒ½å¯¹ç³»ç»Ÿçš„å®ç°æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ã€‚ç„¶åä¸»è¦è®²è§£äº†ç”¨æˆ·èº«ä»½çš„è®¤è¯ä¸tokenå‘æ”¾çš„å…·ä½“å®ç°ã€‚å¯¹äºå…¶ä¸­ä¸»è¦çš„ç±»å’Œæ¥å£è¿›è¡Œäº†åˆ†æä¸è®²è§£ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¸»è¦è®²è§£tokençš„é‰´å®šå’ŒAPIçº§åˆ«çš„ä¸Šä¸‹æ–‡æƒé™æ ¡éªŒã€‚ æœ¬æ–‡çš„æºç åœ°å€ï¼šGitHubï¼šhttps://github.com/keets2012/Auth-serviceç äº‘ï¼š https://gitee.com/keets/Auth-Service å‚è€ƒ ä»€ä¹ˆæ˜¯ JWT â€“ JSON WEB TOKEN Reï¼šä»é›¶å¼€å§‹çš„Spring Security OAuth2ï¼ˆäºŒï¼‰ spring-security-oauth ç›¸å…³é˜…è¯»è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰]]></content>
      <categories>
        <category>Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
        <tag>OAuth2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ï¼ˆä¸€ï¼‰]]></title>
    <url>%2F2017%2F10%2F19%2Fsecurity1%2F</url>
    <content type="text"><![CDATA[å¼•è¨€ï¼š æœ¬æ–‡ç³»ã€Šè®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ã€‹ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œæœ¬ç³»åˆ—é¢„è®¡å››ç¯‡æ–‡ç« è®²è§£å¾®æœåŠ¡ä¸‹çš„è®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶çš„å®ç°ã€‚ 1. èƒŒæ™¯æœ€è¿‘åœ¨åšæƒé™ç›¸å…³æœåŠ¡çš„å¼€å‘ï¼Œåœ¨ç³»ç»Ÿå¾®æœåŠ¡åŒ–åï¼ŒåŸæœ‰çš„å•ä½“åº”ç”¨æ˜¯åŸºäºsessionçš„å®‰å…¨æƒé™æ–¹å¼ï¼Œä¸èƒ½æ»¡è¶³ç°æœ‰çš„å¾®æœåŠ¡æ¶æ„çš„è®¤è¯ä¸é‰´æƒéœ€æ±‚ã€‚å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œä¸€ä¸ªåº”ç”¨ä¼šè¢«æ‹†åˆ†æˆè‹¥å¹²ä¸ªå¾®åº”ç”¨ï¼Œæ¯ä¸ªå¾®åº”ç”¨éƒ½éœ€è¦å¯¹è®¿é—®è¿›è¡Œé‰´æƒï¼Œæ¯ä¸ªå¾®åº”ç”¨éƒ½éœ€è¦æ˜ç¡®å½“å‰è®¿é—®ç”¨æˆ·ä»¥åŠå…¶æƒé™ã€‚å°¤å…¶å½“è®¿é—®æ¥æºä¸åªæ˜¯æµè§ˆå™¨ï¼Œè¿˜åŒ…æ‹¬å…¶ä»–æœåŠ¡çš„è°ƒç”¨æ—¶ï¼Œå•ä½“åº”ç”¨æ¶æ„ä¸‹çš„é‰´æƒæ–¹å¼å°±ä¸æ˜¯ç‰¹åˆ«åˆé€‚äº†ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œè¦è€ƒè™‘å¤–éƒ¨åº”ç”¨æ¥å…¥çš„åœºæ™¯ã€ç”¨æˆ·â€“æœåŠ¡çš„é‰´æƒã€æœåŠ¡â€“æœåŠ¡çš„é‰´æƒç­‰å¤šç§é‰´æƒåœºæ™¯ã€‚æ¯”å¦‚ç”¨æˆ·Aè®¿é—®User Serviceï¼ŒAå¦‚æœæœªç™»å½•ï¼Œåˆ™é¦–å…ˆéœ€è¦ç™»å½•ï¼Œè¯·æ±‚è·å–æˆæƒtokenã€‚è·å–tokenä¹‹åï¼ŒAå°†æºå¸¦ç€tokenå»è¯·æ±‚è®¿é—®æŸä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å°±éœ€è¦å¯¹Açš„èº«ä»½è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸”Aå¯ä»¥è®¿é—®è¯¥æ–‡ä»¶ã€‚ä¸ºäº†é€‚åº”æ¶æ„çš„å˜åŒ–ã€éœ€æ±‚çš„å˜åŒ–ï¼Œauthæƒé™æ¨¡å—è¢«å•ç‹¬å‡ºæ¥ä½œä¸ºä¸€ä¸ªåŸºç¡€çš„å¾®æœåŠ¡ç³»ç»Ÿï¼Œä¸ºå…¶ä»–ä¸šåŠ¡serviceæä¾›æœåŠ¡ã€‚ 2. ç³»ç»Ÿæ¶æ„çš„å˜æ›´å•ä½“åº”ç”¨æ¶æ„åˆ°åˆ†å¸ƒå¼æ¶æ„ï¼Œç®€åŒ–çš„æƒé™éƒ¨åˆ†å˜åŒ–å¦‚ä¸‹é¢ä¸¤å›¾æ‰€ç¤ºã€‚ï¼ˆ1ï¼‰å•ä½“åº”ç”¨ç®€åŒ–ç‰ˆæ¶æ„å›¾ï¼šï¼ˆ2ï¼‰åˆ†å¸ƒå¼åº”ç”¨ç®€åŒ–ç‰ˆæ¶æ„å›¾ï¼š åˆ†å¸ƒå¼æ¶æ„ï¼Œç‰¹åˆ«æ˜¯å¾®æœåŠ¡æ¶æ„çš„ä¼˜ç‚¹æ˜¯å¯ä»¥æ¸…æ™°çš„åˆ’åˆ†å‡ºä¸šåŠ¡é€»è¾‘æ¥ï¼Œè®©æ¯ä¸ªå¾®æœåŠ¡æ‰¿æ‹…èŒè´£å•ä¸€çš„åŠŸèƒ½ï¼Œæ¯•ç«Ÿè¶Šç®€å•çš„ä¸œè¥¿è¶Šç¨³å®šã€‚ ä½†æ˜¯ï¼Œå¾®æœåŠ¡ä¹Ÿå¸¦æ¥äº†å¾ˆå¤šçš„é—®é¢˜ã€‚æ¯”å¦‚å®Œæˆä¸€ä¸ªä¸šåŠ¡æ“ä½œï¼Œéœ€è¦è·¨å¾ˆå¤šä¸ªå¾®æœåŠ¡çš„è°ƒç”¨ï¼Œé‚£ä¹ˆå¦‚ä½•ç”¨æƒé™ç³»ç»Ÿå»æ§åˆ¶ç”¨æˆ·å¯¹ä¸åŒå¾®æœåŠ¡çš„è°ƒç”¨ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸ªæŒ‘æˆ˜ã€‚å½“ä¸šåŠ¡å¾®æœåŠ¡çš„è°ƒç”¨æ¥å…¥æƒé™ç³»ç»Ÿåï¼Œä¸èƒ½æ‹–ç´¯å®ƒä»¬çš„ååé‡ï¼Œå½“æƒé™ç³»ç»Ÿå‡ºç°é—®é¢˜åï¼Œä¸èƒ½é˜»å¡å®ƒä»¬çš„ä¸šåŠ¡è°ƒç”¨è¿›åº¦ï¼Œå½“ç„¶æ›´ä¸èƒ½æ”¹å˜ä¸šåŠ¡é€»è¾‘ã€‚æ–°çš„ä¸šåŠ¡å¾®æœåŠ¡å¿«é€Ÿæ¥å…¥æƒé™ç³»ç»Ÿç›¸å¯¹å®¹æ˜“æŠŠæ§ï¼Œé‚£ä¹ˆå¯¹äºå…¬å¸å·²æœ‰çš„å¾®æœåŠ¡ï¼Œå¦‚ä½•èƒ½ä¸æ”¹åŠ¨å®ƒä»¬çš„æ¶æ„æ–¹å¼çš„å‰æä¸‹ï¼Œå¿«é€Ÿæ¥å…¥ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€å¤§æŒ‘æˆ˜ã€‚ 3. æŠ€æœ¯æ–¹æ¡ˆè¿™ä¸»è¦åŒ…æ‹¬ä¸¤æ–¹é¢éœ€æ±‚ï¼šå…¶ä¸€æ˜¯è®¤è¯ä¸é‰´æƒï¼Œå¯¹äºè¯·æ±‚çš„ç”¨æˆ·èº«ä»½çš„æˆæƒä»¥åŠåˆæ³•æ€§é‰´æƒï¼›å…¶äºŒæ˜¯APIçº§åˆ«çš„æ“ä½œæƒé™æ§åˆ¶ï¼Œè¿™ä¸ªåœ¨ç¬¬ä¸€ç‚¹ä¹‹åï¼Œå½“é‰´å®šå®Œç”¨æˆ·èº«ä»½åˆæ³•ä¹‹åï¼Œå¯¹äºè¯¥ç”¨æˆ·çš„æŸä¸ªå…·ä½“è¯·æ±‚æ˜¯å¦å…·æœ‰è¯¥æ“ä½œæ‰§è¡Œæƒé™è¿›è¡Œæ ¡éªŒã€‚ 3.1 è®¤è¯ä¸é‰´æƒå¯¹äºç¬¬ä¸€ä¸ªéœ€æ±‚ï¼Œç¬”è€…è°ƒæŸ¥äº†ä¸€äº›å®ç°æ–¹æ¡ˆï¼š åˆ†å¸ƒå¼Sessionæ–¹æ¡ˆåˆ†å¸ƒå¼ä¼šè¯æ–¹æ¡ˆåŸç†ä¸»è¦æ˜¯å°†å…³äºç”¨æˆ·è®¤è¯çš„ä¿¡æ¯å­˜å‚¨åœ¨å…±äº«å­˜å‚¨ä¸­ï¼Œä¸”é€šå¸¸ç”±ç”¨æˆ·ä¼šè¯ä½œä¸º key æ¥å®ç°çš„ç®€å•åˆ†å¸ƒå¼å“ˆå¸Œæ˜ å°„ã€‚å½“ç”¨æˆ·è®¿é—®å¾®æœåŠ¡æ—¶ï¼Œç”¨æˆ·æ•°æ®å¯ä»¥ä»å…±äº«å­˜å‚¨ä¸­è·å–ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œè¿™ç§æ–¹æ¡ˆå¾ˆä¸é”™ï¼Œç”¨æˆ·ç™»å½•çŠ¶æ€æ˜¯ä¸é€æ˜çš„ã€‚åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªé«˜å¯ç”¨ä¸”å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆã€‚è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹åœ¨äºå…±äº«å­˜å‚¨éœ€è¦ä¸€å®šä¿æŠ¤æœºåˆ¶ï¼Œå› æ­¤éœ€è¦é€šè¿‡å®‰å…¨é“¾æ¥æ¥è®¿é—®ï¼Œè¿™æ—¶è§£å†³æ–¹æ¡ˆçš„å®ç°å°±é€šå¸¸å…·æœ‰ç›¸å½“é«˜çš„å¤æ‚æ€§äº†ã€‚ åŸºäºOAuth2 Tokenæ–¹æ¡ˆéšç€ Restful APIã€å¾®æœåŠ¡çš„å…´èµ·ï¼ŒåŸºäºTokençš„è®¤è¯ç°åœ¨å·²ç»è¶Šæ¥è¶Šæ™®éã€‚Tokenå’ŒSession ID ä¸åŒï¼Œå¹¶éåªæ˜¯ä¸€ä¸ª keyã€‚Token ä¸€èˆ¬ä¼šåŒ…å«ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œé€šè¿‡éªŒè¯ Token å°±å¯ä»¥å®Œæˆèº«ä»½æ ¡éªŒã€‚ç”¨æˆ·è¾“å…¥ç™»å½•ä¿¡æ¯ï¼Œå‘é€åˆ°èº«ä»½è®¤è¯æœåŠ¡è¿›è¡Œè®¤è¯ã€‚AuthorizationServeréªŒè¯ç™»å½•ä¿¡æ¯æ˜¯å¦æ­£ç¡®ï¼Œè¿”å›ç”¨æˆ·åŸºç¡€ä¿¡æ¯ã€æƒé™èŒƒå›´ã€æœ‰æ•ˆæ—¶é—´ç­‰ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å­˜å‚¨æ¥å£ã€‚ç”¨æˆ·å°† Token æ”¾åœ¨ HTTP è¯·æ±‚å¤´ä¸­ï¼Œå‘èµ·ç›¸å…³ API è°ƒç”¨ã€‚è¢«è°ƒç”¨çš„å¾®æœåŠ¡ï¼ŒéªŒè¯Tokenã€‚ResourceServerè¿”å›ç›¸å…³èµ„æºå’Œæ•°æ®ã€‚ è¿™è¾¹é€‰ç”¨äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼ŒåŸºäºOAuth2 Tokenè®¤è¯çš„å¥½å¤„å¦‚ä¸‹ï¼š æœåŠ¡ç«¯æ— çŠ¶æ€ï¼šToken æœºåˆ¶åœ¨æœåŠ¡ç«¯ä¸éœ€è¦å­˜å‚¨ session ä¿¡æ¯ï¼Œå› ä¸º Token è‡ªèº«åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ã€‚ æ€§èƒ½è¾ƒå¥½ï¼Œå› ä¸ºåœ¨éªŒè¯ Token æ—¶ä¸ç”¨å†å»è®¿é—®æ•°æ®åº“æˆ–è€…è¿œç¨‹æœåŠ¡è¿›è¡Œæƒé™æ ¡éªŒï¼Œè‡ªç„¶å¯ä»¥æå‡ä¸å°‘æ€§èƒ½ã€‚ ç°åœ¨å¾ˆå¤šåº”ç”¨éƒ½æ˜¯åŒæ—¶é¢å‘ç§»åŠ¨ç«¯å’Œwebç«¯ï¼ŒOAuth2 Tokenæœºåˆ¶å¯ä»¥æ”¯æŒç§»åŠ¨è®¾å¤‡ã€‚ OAuth2ä¸Spring Securityç»“åˆä½¿ç”¨ï¼Œæœ‰æä¾›å¾ˆå¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼Œå¤§å¤šç‰¹æ€§éƒ½å¯ä»¥é€šè¿‡é…ç½®çµæ´»çš„å˜æ›´ã€‚ æœ€åä¸€ç‚¹ï¼Œä¹Ÿå¾ˆé‡è¦ï¼ŒSpring Security OAuth2çš„æ–‡æ¡£å†™å¾—è¾ƒä¸ºè¯¦ç»†ã€‚ oauth2æ ¹æ®ä½¿ç”¨åœºæ™¯ä¸åŒï¼Œåˆ†æˆäº†4ç§æ¨¡å¼ï¼š æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰ ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰ å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰ å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰ å¯¹äºä¸Šè¿°oauth2å››ç§æ¨¡å¼ä¸ç†Ÿçš„åŒå­¦ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦oauth2ï¼Œé˜®ä¸€å³°çš„æ–‡ç« æœ‰è§£é‡Šã€‚å¸¸ä½¿ç”¨çš„æ˜¯passwordæ¨¡å¼å’Œclientæ¨¡å¼ã€‚ 3.2 æ“ä½œæƒé™æ§åˆ¶å¯¹äºç¬¬äºŒä¸ªéœ€æ±‚ï¼Œç¬”è€…ä¸»è¦çœ‹äº†Spring Securityå’ŒShiroã€‚ ShiroShiroæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„å¼€æºå®‰å…¨æ¡†æ¶ï¼Œèƒ½å¤Ÿéå¸¸æ¸…æ™°çš„å¤„ç†è®¤è¯ã€æˆæƒã€ç®¡ç†ä¼šè¯ä»¥åŠå¯†ç åŠ å¯†ã€‚Shiroå¾ˆå®¹æ˜“å…¥æ‰‹ï¼Œä¸Šæ‰‹å¿«æ§åˆ¶ç²’åº¦å¯ç³™å¯ç»†ã€‚è‡ªç”±åº¦é«˜ï¼ŒShiroæ—¢èƒ½é…åˆSpringä½¿ç”¨ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ã€‚ Spring SecuritySpringç¤¾åŒºç”Ÿæ€å¾ˆå¼ºå¤§ã€‚é™¤äº†ä¸èƒ½è„±ç¦»Springï¼ŒSpring Securityå…·æœ‰Shiroæ‰€æœ‰çš„åŠŸèƒ½ã€‚è€Œä¸”Spring Securityå¯¹Oauthã€OpenIDä¹Ÿæœ‰æ”¯æŒ,Shiroåˆ™éœ€è¦è‡ªå·±æ‰‹åŠ¨å®ç°ã€‚Spring Securityçš„æƒé™ç»†ç²’åº¦æ›´é«˜ã€‚ä½†æ˜¯Spring Securityå¤ªè¿‡å¤æ‚ã€‚ çœ‹äº†ä¸‹ç½‘ä¸Šçš„è¯„è®ºï¼Œè²Œä¼¼ä¸€è¾¹å€’å‘Shiroã€‚å¤§éƒ¨åˆ†äººæå‡ºçš„Spring Securityé—®é¢˜å°±æ˜¯æ¯”è¾ƒå¤æ‚éš¾æ‡‚ï¼Œæ–‡æ¡£å¤ªé•¿ã€‚ä¸ç®¡æ˜¯Shiroè¿˜æ˜¯Spring Securityï¼Œå…¶å®ç°éƒ½æ˜¯åŸºäºè¿‡æ»¤å™¨ï¼Œå¯¹äºè‡ªå®šä¹‰å®ç°è¿‡æ»¤å™¨ï¼Œæˆ‘æƒ³å¯¹äºå¾ˆå¤šå¼€å‘è€…å¹¶ä¸æ˜¯å¾ˆéš¾ï¼Œä½†æ˜¯è¿™éœ€è¦å›¢é˜ŸèŠ±è´¹æ—¶é—´ä¸å°è£…å¯ç”¨çš„jaråŒ…å‡ºæ¥ï¼Œå¯¹äºåæœŸç»´æŠ¤å’Œå‡çº§ï¼Œä»¥åŠåŠŸèƒ½çš„æ‰©å±•ã€‚å¾ˆå¤šä¸­å°å‹å…¬å¸å¹¶ä¸ä¸€å®šå…·æœ‰è¿™æ ·çš„æ—¶é—´å’ŒäººåŠ›æŠ•å…¥è¿™ä»¶äº‹ã€‚ç¬”è€…ç»¼åˆè¯„ä¼°äº†ä¸‹å¤æ‚æ€§ä¸æ‰€è¦å®ç°çš„æƒé™éœ€æ±‚ï¼Œä»¥åŠä¸Šä¸€ä¸ªéœ€æ±‚è°ƒç ”çš„ç»“æœï¼Œæ—¢ç„¶Spring SecurityåŠŸèƒ½è¶³å¤Ÿå¼ºå¤§ä¸”ç¨³å®šï¼Œæœ€ç»ˆé€‰æ‹©äº†Spring Securityã€‚ 4. ç³»ç»Ÿæ¶æ„4.1 ç»„ä»¶Authç³»ç»Ÿçš„æœ€ç»ˆä½¿ç”¨ç»„ä»¶å¦‚ä¸‹ï¼š 123OAuth2.0 JWT TokenSpring SecuritySpring boot 4.2 æ­¥éª¤ä¸»è¦æ­¥éª¤ä¸ºï¼š é…ç½®èµ„æºæœåŠ¡å™¨å’Œè®¤è¯æœåŠ¡å™¨ é…ç½®Spring Security ä¸Šè¿°æ­¥éª¤æ¯”è¾ƒç¬¼ç»Ÿï¼Œå¯¹äºå‰é¢å°èŠ‚æåˆ°çš„éœ€æ±‚ï¼Œå±äºAuthç³»ç»Ÿçš„ä¸»è¦å†…å®¹ï¼Œç¬”è€…åé¢ä¼šå¦å†™æ–‡ç« å¯¹åº”è®²è§£ã€‚ 4.3 endpointæä¾›çš„endpointï¼š 1234567/oauth/token?grant_type=password #è¯·æ±‚æˆæƒtoken/oauth/token?grant_type=refresh_token #åˆ·æ–°token/oauth/check_token #æ ¡éªŒtoken/logout #æ³¨é”€tokenåŠæƒé™ç›¸å…³ä¿¡æ¯ 4.4 mavenä¾èµ–ä¸»è¦çš„jaråŒ…ï¼Œpom.xmlæ–‡ä»¶å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334&lt;dependency&gt; &lt;groupId&gt;com.auth0&lt;/groupId&gt; &lt;artifactId&gt;java-jwt&lt;/artifactId&gt; &lt;version&gt;2.2.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-security&lt;/artifactId&gt; &lt;version&gt;1.2.1-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt; &lt;version&gt;1.2.1-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;exclusions&gt; &lt;exclusion&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt; &lt;/exclusion&gt; &lt;/exclusions&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jersey&lt;/artifactId&gt; &lt;version&gt;1.5.3.RELEASE&lt;/version&gt; &lt;/dependency&gt; 4.5 AuthorizationServeré…ç½®æ–‡ä»¶AuthorizationServeré…ç½®ä¸»è¦æ˜¯è¦†å†™å¦‚ä¸‹çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«é’ˆå¯¹endpointsã€clientsã€securityé…ç½®ã€‚ 1234567891011121314151617181920@Override public void configure(AuthorizationServerSecurityConfigurer security) throws Exception &#123; security.tokenKeyAccess("permitAll()").checkTokenAccess("isAuthenticated()"); &#125; @Override public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123; //é…ç½®å®¢æˆ·ç«¯è®¤è¯ clients.withClientDetails(clientDetailsService(dataSource)); &#125; @Override public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123; //é…ç½®tokençš„æ•°æ®æºã€è‡ªå®šä¹‰çš„tokenServicesç­‰ä¿¡æ¯ endpoints.authenticationManager(authenticationManager) .tokenStore(tokenStore(dataSource)) .tokenServices(authorizationServerTokenServices()) .accessTokenConverter(accessTokenConverter()) .exceptionTranslator(webResponseExceptionTranslator); &#125; 4.6 ResourceServeré…ç½®èµ„æºæœåŠ¡å™¨çš„é…ç½®ï¼Œè¦†å†™äº†é»˜è®¤çš„é…ç½®ã€‚ä¸ºäº†æ”¯æŒlogoutï¼Œè¿™è¾¹è‡ªå®šä¹‰äº†ä¸€ä¸ªCustomLogoutHandlerå¹¶ä¸”å°†logoutSuccessHandleræŒ‡å®šä¸ºè¿”å›httpçŠ¶æ€çš„HttpStatusReturningLogoutSuccessHandlerã€‚ 1234567891011121314@Override public void configure(HttpSecurity http) throws Exception &#123; http.csrf().disable() .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) .and() .requestMatchers().antMatchers("/**") .and().authorizeRequests() .antMatchers("/**").permitAll() .anyRequest().authenticated() .and().logout() .logoutUrl("/logout") .clearAuthentication(true) .logoutSuccessHandler(new HttpStatusReturningLogoutSuccessHandler()) .addLogoutHandler(customLogoutHandler()); 4.7 æ‰§è¡Œendpoint é¦–å…ˆæ‰§è¡Œè·å–æˆæƒçš„endpointã€‚ 123456789101112method: post url: http://localhost:12000/oauth/token?grant_type=passwordheader:&#123; Authorization: Basic ZnJvbnRlbmQ6ZnJvbnRlbmQ=, Content-Type: application/x-www-form-urlencoded&#125;body:&#123; username: keets, password: ***&#125; ä¸Šè¿°æ„é€ äº†ä¸€ä¸ªpostè¯·æ±‚ï¼Œå…·ä½“è¯·æ±‚å†™å¾—å¾ˆè¯¦ç»†ã€‚usernameå’Œpasswordæ˜¯å®¢æˆ·ç«¯æä¾›ç»™æœåŠ¡å™¨è¿›è¡Œæ ¡éªŒç”¨æˆ·èº«ä»½ä¿¡æ¯ã€‚headeré‡Œé¢çš„Authorizationæ˜¯å­˜æ”¾çš„clientIdå’ŒclientSecretç»è¿‡ç¼–ç çš„å­—ç¬¦ä¸²ã€‚è¿”å›ç»“æœå¦‚ä¸‹ï¼š 12345678910&#123; &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsImV4cCI6MTUwODQ0Nzc1NiwidXNlcl9uYW1lIjoia2VldHMiLCJqdGkiOiJiYWQ3MmIxOS1kOWYzLTQ5MDItYWZmYS0wNDMwZTdkYjc5ZWQiLCJjbGllbnRfaWQiOiJmcm9udGVuZCIsInNjb3BlIjpbImFsbCJdfQ.5ZNVN8TLavgpWy8KZQKArcbj7ItJLLaY1zBRaAgMjdo&quot;, &quot;token_type&quot;: &quot;bearer&quot;, &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsInVzZXJfbmFtZSI6ImtlZXRzIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6ImJhZDcyYjE5LWQ5ZjMtNDkwMi1hZmZhLTA0MzBlN2RiNzllZCIsImV4cCI6MTUxMDk5NjU1NiwianRpIjoiYWE0MWY1MjctODE3YS00N2UyLWFhOTgtZjNlMDZmNmY0NTZlIiwiY2xpZW50X2lkIjoiZnJvbnRlbmQifQ.mICT1-lxOAqOU9M-Ud7wZBb4tTux6OQWouQJ2nn1DeE&quot;, &quot;expires_in&quot;: 43195, &quot;scope&quot;: &quot;all&quot;, &quot;X-KEETS-UserId&quot;: &quot;d6448c24-3c4c-4b80-8372-c2d61868f8c6&quot;, &quot;jti&quot;: &quot;bad72b19-d9f3-4902-affa-0430e7db79ed&quot;, &quot;X-KEETS-ClientId&quot;: &quot;frontend&quot;&#125; å¯ä»¥çœ‹åˆ°åœ¨ç”¨æˆ·åå¯†ç é€šè¿‡æ ¡éªŒåï¼Œå®¢æˆ·ç«¯æ”¶åˆ°äº†æˆæƒæœåŠ¡å™¨çš„responseï¼Œä¸»è¦åŒ…æ‹¬access tokenã€refresh tokenã€‚å¹¶ä¸”è¡¨æ˜tokençš„ç±»å‹ä¸ºbearerï¼Œè¿‡æœŸæ—¶é—´expires_inã€‚ç¬”è€…åœ¨jwt tokenä¸­åŠ å…¥äº†è‡ªå®šä¹‰çš„infoä¸ºUserIdå’ŒClientIdã€‚ 2.é‰´æƒçš„endpoint 1234567891011method: post url: http://localhost:12000/oauth/check_tokenheader:&#123; Authorization: Basic ZnJvbnRlbmQ6ZnJvbnRlbmQ=, Content-Type: application/x-www-form-urlencoded&#125;body:&#123; token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsImV4cCI6MTUwODQ0Nzc1NiwidXNlcl9uYW1lIjoia2VldHMiLCJqdGkiOiJiYWQ3MmIxOS1kOWYzLTQ5MDItYWZmYS0wNDMwZTdkYjc5ZWQiLCJjbGllbnRfaWQiOiJmcm9udGVuZCIsInNjb3BlIjpbImFsbCJdfQ.5ZNVN8TLavgpWy8KZQKArcbj7ItJLLaY1zBRaAgMjdo&#125; ä¸Šé¢å³ä¸ºcheck_tokenè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬”è€…å°†åˆšåˆšæˆæƒçš„tokenæ”¾åœ¨äº†bodyé‡Œé¢ï¼Œè¿™è¾¹å¯ä»¥æœ‰å¤šç§æ–¹æ³•ï¼Œæ­¤å¤„ä¸æ‰©å±•ã€‚ 123456789101112&#123; &quot;X-KEETS-UserId&quot;: &quot;d6448c24-3c4c-4b80-8372-c2d61868f8c6&quot;, &quot;user_name&quot;: &quot;keets&quot;, &quot;scope&quot;: [ &quot;all&quot; ], &quot;active&quot;: true, &quot;exp&quot;: 1508447756, &quot;X-KEETS-ClientId&quot;: &quot;frontend&quot;, &quot;jti&quot;: &quot;bad72b19-d9f3-4902-affa-0430e7db79ed&quot;, &quot;client_id&quot;: &quot;frontend&quot;&#125; æ ¡éªŒtokenåˆæ³•åï¼Œè¿”å›çš„responseå¦‚ä¸Šæ‰€ç¤ºã€‚åœ¨responseä¸­ä¹Ÿæ˜¯å±•ç¤ºäº†ç›¸åº”çš„tokenä¸­çš„åŸºæœ¬ä¿¡æ¯ã€‚ 3.åˆ·æ–°tokenç”±äºtokençš„æ—¶æ•ˆä¸€èˆ¬ä¸ä¼šå¾ˆé•¿ï¼Œè€Œrefresh tokenä¸€èˆ¬å‘¨æœŸä¼šå¾ˆé•¿ï¼Œä¸ºäº†ä¸å½±å“ç”¨æˆ·çš„ä½“éªŒï¼Œå¯ä»¥ä½¿ç”¨refresh tokenå»åŠ¨æ€çš„åˆ·æ–°tokenã€‚ 123456method: post url: http://localhost:12000/oauth/token?grant_type=refresh_token&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsInVzZXJfbmFtZSI6ImtlZXRzIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6ImJhZDcyYjE5LWQ5ZjMtNDkwMi1hZmZhLTA0MzBlN2RiNzllZCIsImV4cCI6MTUxMDk5NjU1NiwianRpIjoiYWE0MWY1MjctODE3YS00N2UyLWFhOTgtZjNlMDZmNmY0NTZlIiwiY2xpZW50X2lkIjoiZnJvbnRlbmQifQ.mICT1-lxOAqOU9M-Ud7wZBb4tTux6OQWouQJ2nn1DeEheader:&#123; Authorization: Basic ZnJvbnRlbmQ6ZnJvbnRlbmQ=&#125; å…¶responseå’Œ/oauth/tokenå¾—åˆ°æ­£å¸¸çš„ç›¸åº”æ˜¯ä¸€æ ·çš„ï¼Œæ­¤å¤„ä¸å†åˆ—å‡ºã€‚ 4.æ³¨é”€token 123456method: geturl: http://localhost:9000/logoutheader:&#123; Authorization: bearereyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE1MDgzMzkwNTQsIlgtU0lNVS1Vc2VySWQiOiIwOGFhMTYxYi1lYjI3LTQ2NjAtYjA1MC1lMDc5YTJiODBhODMiLCJ1c2VyX25hbWUiOiJrZWV0cyIsImp0aSI6IjJhNTQ4NjY2LTRjNzEtNGEzNi1hZmY0LTMwZTI1Mjc0ZjQxZSIsImNsaWVudF9pZCI6ImZyb250ZW5kIiwic2NvcGUiOlsibWVua29yIl19.rA-U2iXnjH0AdPaGuvSEJH3bTth6AT3oQrGsKIams30&#125; æ³¨é”€æˆåŠŸåˆ™ä¼šè¿”å›200ï¼Œæ³¨é”€ç«¯ç‚¹ä¸»è¦æ˜¯å°†tokenå’ŒSecurityContextHolderè¿›è¡Œæ¸…ç©ºã€‚ 5. æ€»ç»“æœ¬æ–‡æ˜¯ã€Šè®¤è¯é‰´æƒä¸APIæƒé™æ§åˆ¶åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¾è®¡ä¸å®ç°ã€‹ç³»åˆ—æ–‡ç« çš„æ€»è¿°ï¼Œä»é‡åˆ°çš„é—®é¢˜ç€æ‰‹ï¼Œä»‹ç»äº†é¡¹ç›®çš„èƒŒæ™¯ã€‚é€šè¿‡è°ƒç ”ç°æœ‰çš„æŠ€æœ¯ï¼Œå¹¶ç»“åˆå½“å‰é¡¹ç›®çš„å®é™…ï¼Œç¡®å®šäº†æŠ€æœ¯é€‰å‹ã€‚æœ€åå¯¹äºç³»ç»Ÿçš„æœ€ç»ˆçš„å®ç°è¿›è¡Œå±•ç¤ºã€‚åé¢å°†ä»å®ç°çš„ç»†èŠ‚ï¼Œè®²è§£æœ¬ç³»ç»Ÿçš„å®ç°ã€‚æ•¬è¯·æœŸå¾…åç»­æ–‡ç« ã€‚ å‚è€ƒ ç†è§£OAuth 2.0 å¾®æœåŠ¡APIçº§æƒé™çš„æŠ€æœ¯æ¶æ„ å¾®æœåŠ¡æ¶æ„ä¸‹çš„å®‰å…¨è®¤è¯ä¸é‰´æƒ]]></content>
      <categories>
        <category>Security</category>
      </categories>
      <tags>
        <tag>Spring Security</tag>
        <tag>OAuth2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ¶ˆæ¯ä¸­é—´ä»¶NSQæ·±å…¥ä¸å®è·µ]]></title>
    <url>%2F2017%2F10%2F08%2Fnsq%2F</url>
    <content type="text"><![CDATA[1. ä»‹ç»æœ€è¿‘åœ¨ç ”ç©¶ä¸€äº›æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¸¸ç”¨çš„MQå¦‚RabbitMQ,ActiveMQ,Kafkaç­‰ã€‚NSQæ˜¯ä¸€ä¸ªåŸºäºGoè¯­è¨€çš„åˆ†å¸ƒå¼å®æ—¶æ¶ˆæ¯å¹³å°ï¼Œå®ƒåŸºäºMITå¼€æºåè®®å‘å¸ƒï¼Œç”±bitlyå…¬å¸å¼€æºå‡ºæ¥çš„ä¸€æ¬¾ç®€å•æ˜“ç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶ã€‚å®˜æ–¹å’Œç¬¬ä¸‰æ–¹è¿˜ä¸ºNSQå¼€å‘äº†ä¼—å¤šå®¢æˆ·ç«¯åŠŸèƒ½åº“ï¼Œå¦‚å®˜æ–¹æä¾›çš„åŸºäºHTTPçš„nsqdã€Goå®¢æˆ·ç«¯go-nsqã€Pythonå®¢æˆ·ç«¯pynsqã€åŸºäºNode.jsçš„JavaScriptå®¢æˆ·ç«¯nsqjsã€å¼‚æ­¥Cå®¢æˆ·ç«¯libnsqã€Javaå®¢æˆ·ç«¯nsq-javaä»¥åŠåŸºäºå„ç§è¯­è¨€çš„ä¼—å¤šç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯åŠŸèƒ½åº“ã€‚ 1.1 Features1). DistributedNSQæä¾›äº†åˆ†å¸ƒå¼çš„ï¼Œå»ä¸­å¿ƒåŒ–ï¼Œä¸”æ²¡æœ‰å•ç‚¹æ•…éšœçš„æ‹“æ‰‘ç»“æ„ï¼Œç¨³å®šçš„æ¶ˆæ¯ä¼ è¾“å‘å¸ƒä¿éšœï¼Œèƒ½å¤Ÿå…·æœ‰é«˜å®¹é”™å’ŒHAï¼ˆé«˜å¯ç”¨ï¼‰ç‰¹æ€§ã€‚2). Scalableæ˜“äºæ‰©å±•NSQæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œæ²¡æœ‰ä¸­å¿ƒåŒ–çš„brokersã€‚å†…ç½®çš„å‘ç°æœåŠ¡ç®€åŒ–äº†åœ¨é›†ç¾¤ä¸­å¢åŠ èŠ‚ç‚¹ã€‚åŒæ—¶æ”¯æŒpub-subå’Œload-balanced çš„æ¶ˆæ¯åˆ†å‘ã€‚3). Ops FriendlyNSQéå¸¸å®¹æ˜“é…ç½®å’Œéƒ¨ç½²ï¼Œç”Ÿæ¥å°±ç»‘å®šäº†ä¸€ä¸ªç®¡ç†ç•Œé¢ã€‚äºŒè¿›åˆ¶åŒ…æ²¡æœ‰è¿è¡Œæ—¶ä¾èµ–ã€‚å®˜æ–¹æœ‰Docker imageã€‚4.Integratedé«˜åº¦é›†æˆå®˜æ–¹çš„ Go å’Œ Pythonåº“éƒ½æœ‰æä¾›ã€‚è€Œä¸”ä¸ºå¤§å¤šæ•°è¯­è¨€æä¾›äº†åº“ã€‚ 1.2 ç»„ä»¶ Topic ï¼šä¸€ä¸ªtopicå°±æ˜¯ç¨‹åºå‘å¸ƒæ¶ˆæ¯çš„ä¸€ä¸ªé€»è¾‘é”®ï¼Œå½“ç¨‹åºç¬¬ä¸€æ¬¡å‘å¸ƒæ¶ˆæ¯æ—¶å°±ä¼šåˆ›å»ºtopicã€‚ Channels ï¼šchannelä¸æ¶ˆè´¹è€…ç›¸å…³ï¼Œæ˜¯æ¶ˆè´¹è€…ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œchannelåœ¨æŸç§æ„ä¹‰ä¸Šæ¥è¯´æ˜¯ä¸€ä¸ªâ€œé˜Ÿåˆ—â€ã€‚æ¯å½“ä¸€ä¸ªå‘å¸ƒè€…å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°ä¸€ä¸ªtopicï¼Œæ¶ˆæ¯ä¼šè¢«å¤åˆ¶åˆ°æ‰€æœ‰æ¶ˆè´¹è€…è¿æ¥çš„channelä¸Šï¼Œæ¶ˆè´¹è€…é€šè¿‡è¿™ä¸ªç‰¹æ®Šçš„channelè¯»å–æ¶ˆæ¯ï¼Œå®é™…ä¸Šï¼Œåœ¨æ¶ˆè´¹è€…ç¬¬ä¸€æ¬¡è®¢é˜…æ—¶å°±ä¼šåˆ›å»ºchannelã€‚Channelä¼šå°†æ¶ˆæ¯è¿›è¡Œæ’åˆ—ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯ï¼Œæ¶ˆæ¯é¦–å…ˆä¼šåœ¨å†…å­˜ä¸­æ’é˜Ÿï¼Œå½“é‡å¤ªå¤§æ—¶å°±ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚ Messagesï¼šæ¶ˆæ¯æ„æˆäº†æˆ‘ä»¬æ•°æ®æµçš„ä¸­åšåŠ›é‡ï¼Œæ¶ˆè´¹è€…å¯ä»¥é€‰æ‹©ç»“æŸæ¶ˆæ¯ï¼Œè¡¨æ˜å®ƒä»¬æ­£åœ¨è¢«æ­£å¸¸å¤„ç†ï¼Œæˆ–è€…é‡æ–°å°†ä»–ä»¬æ’é˜Ÿå¾…åˆ°åé¢å†è¿›è¡Œå¤„ç†ã€‚æ¯ä¸ªæ¶ˆæ¯åŒ…å«ä¼ é€’å°è¯•çš„æ¬¡æ•°ï¼Œå½“æ¶ˆæ¯ä¼ é€’è¶…è¿‡ä¸€å®šçš„é˜€å€¼æ¬¡æ•°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ”¾å¼ƒè¿™äº›æ¶ˆæ¯ï¼Œæˆ–è€…ä½œä¸ºé¢å¤–æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚ nsqdï¼šnsqd æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£æ¥æ”¶ï¼Œæ’é˜Ÿï¼ŒæŠ•é€’æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ã€‚å®ƒå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä¸è¿‡é€šå¸¸å®ƒæ˜¯ç”± nsqlookupd å®ä¾‹æ‰€åœ¨é›†ç¾¤é…ç½®çš„ï¼ˆå®ƒåœ¨è¿™èƒ½å£°æ˜ topics å’Œ channelsï¼Œä»¥ä¾¿å¤§å®¶èƒ½æ‰¾åˆ°ï¼‰ã€‚ nsqlookupdï¼šnsqlookupd æ˜¯å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ç®¡ç†æ‹“æ‰‘ä¿¡æ¯ã€‚å®¢æˆ·ç«¯é€šè¿‡æŸ¥è¯¢ nsqlookupd æ¥å‘ç°æŒ‡å®šè¯é¢˜ï¼ˆtopicï¼‰çš„ç”Ÿäº§è€…ï¼Œå¹¶ä¸” nsqd èŠ‚ç‚¹å¹¿æ’­è¯é¢˜ï¼ˆtopicï¼‰å’Œé€šé“ï¼ˆchannelï¼‰ä¿¡æ¯ã€‚æœ‰ä¸¤ä¸ªæ¥å£ï¼šTCP æ¥å£ï¼Œnsqd ç”¨å®ƒæ¥å¹¿æ’­ã€‚HTTP æ¥å£ï¼Œå®¢æˆ·ç«¯ç”¨å®ƒæ¥å‘ç°å’Œç®¡ç†ã€‚ nsqadminï¼šnsqadmin æ˜¯ä¸€å¥— WEB UIï¼Œç”¨æ¥æ±‡é›†é›†ç¾¤çš„å®æ—¶ç»Ÿè®¡ï¼Œå¹¶æ‰§è¡Œä¸åŒçš„ç®¡ç†ä»»åŠ¡ã€‚ å¸¸ç”¨å·¥å…·ç±»ï¼š nsq_to _fileï¼šæ¶ˆè´¹æŒ‡å®šçš„è¯é¢˜ï¼ˆtopicï¼‰/é€šé“ï¼ˆchannelï¼‰ï¼Œå¹¶å†™åˆ°æ–‡ä»¶ä¸­ï¼Œæœ‰é€‰æ‹©çš„æ»šåŠ¨å’Œ/æˆ–å‹ç¼©æ–‡ä»¶ã€‚ nsq_to _httpï¼šæ¶ˆè´¹æŒ‡å®šçš„è¯é¢˜ï¼ˆtopicï¼‰/é€šé“ï¼ˆchannelï¼‰å’Œæ‰§è¡Œ HTTP requests (GET/POST) åˆ°æŒ‡å®šçš„ç«¯ç‚¹ã€‚ nsq_to _nsqï¼šæ¶ˆè´¹è€…æŒ‡å®šçš„è¯é¢˜/é€šé“å’Œé‡å‘å¸ƒæ¶ˆæ¯åˆ°ç›®çš„åœ° nsqd é€šè¿‡ TCPã€‚ 1.3 æ‹“æ‰‘ç»“æ„NSQæ¨èé€šè¿‡ä»–ä»¬ç›¸åº”çš„nsqdå®ä¾‹ä½¿ç”¨ååŒå®šä½å‘å¸ƒè€…ï¼Œè¿™æ„å‘³ç€å³ä½¿é¢å¯¹ç½‘ç»œåˆ†åŒºï¼Œæ¶ˆæ¯ä¹Ÿä¼šè¢«ä¿å­˜åœ¨æœ¬åœ°ï¼Œç›´åˆ°å®ƒä»¬è¢«ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå‘å¸ƒè€…ä¸å¿…å»å‘ç°å…¶ä»–çš„nsqdèŠ‚ç‚¹ï¼Œä»–ä»¬æ€»æ˜¯å¯ä»¥å‘æœ¬åœ°å®ä¾‹å‘å¸ƒæ¶ˆæ¯ã€‚ é¦–å…ˆï¼Œä¸€ä¸ªå‘å¸ƒè€…å‘å®ƒçš„æœ¬åœ°nsqdå‘é€æ¶ˆæ¯ï¼Œè¦åšåˆ°è¿™ç‚¹ï¼Œé¦–å…ˆè¦å…ˆæ‰“å¼€ä¸€ä¸ªè¿æ¥ï¼Œç„¶åå‘é€ä¸€ä¸ªåŒ…å«topicå’Œæ¶ˆæ¯ä¸»ä½“çš„å‘å¸ƒå‘½ä»¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ¶ˆæ¯å‘å¸ƒåˆ°äº‹ä»¶topicä¸Šä»¥åˆ†æ•£åˆ°æˆ‘ä»¬ä¸åŒçš„workerä¸­ã€‚äº‹ä»¶topicä¼šå¤åˆ¶è¿™äº›æ¶ˆæ¯å¹¶ä¸”åœ¨æ¯ä¸€ä¸ªè¿æ¥topicçš„channelä¸Šè¿›è¡Œæ’é˜Ÿï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªchannelï¼Œå®ƒä»¬å…¶ä¸­ä¹‹ä¸€ä½œä¸ºæ¡£æ¡ˆchannelã€‚æ¶ˆè´¹è€…ä¼šè·å–è¿™äº›æ¶ˆæ¯å¹¶ä¸”ä¸Šä¼ åˆ°S3ã€‚ æ¯ä¸ªchannelçš„æ¶ˆæ¯éƒ½ä¼šè¿›è¡Œæ’é˜Ÿï¼Œç›´åˆ°ä¸€ä¸ªworkeræŠŠä»–ä»¬æ¶ˆè´¹ï¼Œå¦‚æœæ­¤é˜Ÿåˆ—è¶…å‡ºäº†å†…å­˜é™åˆ¶ï¼Œæ¶ˆæ¯å°†ä¼šè¢«å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚NsqdèŠ‚ç‚¹é¦–å…ˆä¼šå‘nsqlookupå¹¿æ’­ä»–ä»¬çš„ä½ç½®ä¿¡æ¯ï¼Œä¸€æ—¦å®ƒä»¬æ³¨å†ŒæˆåŠŸï¼Œworkerå°†ä¼šä»nsqlookupæœåŠ¡å™¨èŠ‚ç‚¹ä¸Šå‘ç°æ‰€æœ‰åŒ…å«äº‹ä»¶topicçš„nsqdèŠ‚ç‚¹ã€‚ ç„¶åæ¯ä¸ªworkerå‘æ¯ä¸ªnsqdä¸»æœºè¿›è¡Œè®¢é˜…æ“ä½œï¼Œç”¨äºè¡¨æ˜workerå·²ç»å‡†å¤‡å¥½æ¥å—æ¶ˆæ¯äº†ã€‚è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ä¸€ä¸ªå®Œæ•´çš„è¿é€šå›¾ï¼Œä½†æˆ‘ä»¬å¿…é¡»è¦ä¿è¯æ¯ä¸ªå•ç‹¬çš„nsqdå®ä¾‹æ‹¥æœ‰è¶³å¤Ÿçš„æ¶ˆè´¹è€…å»æ¶ˆè´¹å®ƒä»¬çš„æ¶ˆæ¯ï¼Œå¦åˆ™channelä¼šè¢«é˜Ÿåˆ—å †ç€ã€‚ 2. Internals2.1 æ¶ˆæ¯ä¼ é€’æ‹…ä¿NSQ ä¿è¯æ¶ˆæ¯å°†äº¤ä»˜è‡³å°‘ä¸€æ¬¡ï¼Œè™½ç„¶æ¶ˆæ¯å¯èƒ½æ˜¯é‡å¤çš„ã€‚æ¶ˆè´¹è€…åº”è¯¥å…³æ³¨åˆ°è¿™ä¸€ç‚¹ï¼Œåˆ é™¤é‡å¤æ•°æ®æˆ–æ‰§è¡Œidempotentç­‰æ“ä½œã€‚è¿™ä¸ªæ‹…ä¿æ˜¯ä½œä¸ºåè®®å’Œå·¥ä½œæµçš„ä¸€éƒ¨åˆ†ï¼Œå·¥ä½œåŸç†å¦‚ä¸‹ï¼ˆå‡è®¾å®¢æˆ·ç«¯æˆåŠŸè¿æ¥å¹¶è®¢é˜…ä¸€ä¸ªè¯é¢˜ï¼‰ï¼š1ï¼‰å®¢æˆ·è¡¨ç¤ºå·²ç»å‡†å¤‡å¥½æ¥æ”¶æ¶ˆæ¯2ï¼‰NSQ å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶æš‚æ—¶å°†æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼ˆåœ¨ re-queue æˆ– timeoutï¼‰3ï¼‰å®¢æˆ·ç«¯å›å¤ FINï¼ˆç»“æŸï¼‰æˆ– REQï¼ˆé‡æ–°æ’é˜Ÿï¼‰åˆ†åˆ«æŒ‡ç¤ºæˆåŠŸæˆ–å¤±è´¥ã€‚å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å›å¤, NSQ ä¼šåœ¨è®¾å®šçš„æ—¶é—´è¶…æ—¶ï¼Œè‡ªåŠ¨é‡æ–°æ’é˜Ÿæ¶ˆæ¯è¿™ç¡®ä¿äº†æ¶ˆæ¯ä¸¢å¤±å”¯ä¸€å¯èƒ½çš„æƒ…å†µæ˜¯ä¸æ­£å¸¸ç»“æŸ nsqd è¿›ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ˜¯åœ¨å†…å­˜ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼ˆæˆ–ä»»ä½•ç¼“å†²æœªåˆ·æ–°åˆ°ç£ç›˜ï¼‰éƒ½å°†ä¸¢å¤±ã€‚å¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±æ˜¯æœ€é‡è¦çš„ï¼Œå³ä½¿æ˜¯è¿™ä¸ªæ„å¤–æƒ…å†µå¯ä»¥å¾—åˆ°ç¼“è§£ã€‚ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯æ„æˆå†—ä½™ nsqdå¯¹ï¼ˆåœ¨ä¸åŒçš„ä¸»æœºä¸Šï¼‰æ¥æ”¶æ¶ˆæ¯çš„ç›¸åŒéƒ¨åˆ†çš„å‰¯æœ¬ã€‚å› ä¸ºä½ å®ç°çš„æ¶ˆè´¹è€…æ˜¯å¹‚ç­‰çš„ï¼Œä»¥ä¸¤å€æ—¶é—´å¤„ç†è¿™äº›æ¶ˆæ¯ä¸ä¼šå¯¹ä¸‹æ¸¸é€ æˆå½±å“ï¼Œå¹¶ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—ä»»ä½•å•ä¸€èŠ‚ç‚¹æ•…éšœè€Œä¸ä¼šä¸¢å¤±ä¿¡æ¯ã€‚ 2.2 ç®€åŒ–é…ç½®å’Œç®¡ç†å•ä¸ª nsqd å®ä¾‹è¢«è®¾è®¡æˆå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæ•°æ®æµã€‚æµè¢«ç§°ä¸ºâ€œè¯é¢˜â€å’Œè¯é¢˜æœ‰ 1 ä¸ªæˆ–å¤šä¸ªâ€œé€šé“â€ã€‚æ¯ä¸ªé€šé“éƒ½æ¥æ”¶åˆ°ä¸€ä¸ªè¯é¢˜ä¸­æ‰€æœ‰æ¶ˆæ¯çš„æ‹·è´ã€‚åœ¨å®è·µä¸­ï¼Œä¸€ä¸ªé€šé“æ˜ å°„åˆ°ä¸‹è¡ŒæœåŠ¡æ¶ˆè´¹ä¸€ä¸ªè¯é¢˜ã€‚è¯é¢˜å’Œé€šé“éƒ½æ²¡æœ‰é¢„å…ˆé…ç½®ã€‚è¯é¢˜ç”±ç¬¬ä¸€æ¬¡å‘å¸ƒæ¶ˆæ¯åˆ°å‘½åçš„è¯é¢˜æˆ–ç¬¬ä¸€æ¬¡é€šè¿‡è®¢é˜…ä¸€ä¸ªå‘½åè¯é¢˜æ¥åˆ›å»ºã€‚é€šé“è¢«ç¬¬ä¸€æ¬¡è®¢é˜…åˆ°æŒ‡å®šçš„é€šé“åˆ›å»ºã€‚è¯é¢˜å’Œé€šé“çš„æ‰€æœ‰ç¼“å†²çš„æ•°æ®ç›¸äº’ç‹¬ç«‹ï¼Œé˜²æ­¢ç¼“æ…¢æ¶ˆè´¹è€…é€ æˆå¯¹å…¶ä»–é€šé“çš„ç§¯å‹ï¼ˆåŒæ ·é€‚ç”¨äºè¯é¢˜çº§åˆ«ï¼‰ã€‚ä¸€ä¸ªé€šé“ä¸€èˆ¬ä¼šæœ‰å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å‡è®¾æ‰€æœ‰å·²è¿æ¥çš„å®¢æˆ·ç«¯å¤„äºå‡†å¤‡æ¥æ”¶æ¶ˆæ¯çš„çŠ¶æ€ï¼Œæ¯ä¸ªæ¶ˆæ¯å°†è¢«ä¼ é€’åˆ°ä¸€ä¸ªéšæœºçš„å®¢æˆ·ç«¯ã€‚nsqlookupdï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç›®å½•æœåŠ¡ï¼Œæ¶ˆè´¹è€…å¯ä»¥æŸ¥æ‰¾åˆ°æä¾›ä»–ä»¬æ„Ÿå…´è¶£è®¢é˜…è¯é¢˜çš„ nsqd åœ°å€ ã€‚åœ¨é…ç½®æ–¹é¢ï¼ŒæŠŠæ¶ˆè´¹è€…ä¸ç”Ÿäº§è€…è§£è€¦å¼€ï¼ˆå®ƒä»¬éƒ½åˆ†åˆ«åªéœ€è¦çŸ¥é“å“ªé‡Œå»è¿æ¥ nsqlookupd çš„å…±åŒå®ä¾‹ï¼Œè€Œä¸æ˜¯å¯¹æ–¹ï¼‰ï¼Œé™ä½å¤æ‚æ€§å’Œç»´æŠ¤ã€‚åœ¨æ›´åº•çš„å±‚é¢ï¼Œæ¯ä¸ª nsqd æœ‰ä¸€ä¸ªä¸ nsqlookupd çš„é•¿æœŸ TCP è¿æ¥ï¼Œå®šæœŸæ¨åŠ¨å…¶çŠ¶æ€ã€‚è¿™ä¸ªæ•°æ®è¢« nsqlookupd ç”¨äºç»™æ¶ˆè´¹è€…é€šçŸ¥ nsqd åœ°å€ã€‚å¯¹äºæ¶ˆè´¹è€…æ¥è¯´ï¼Œä¸€ä¸ªæš´éœ²çš„ HTTP /lookup æ¥å£ç”¨äºè½®è¯¢ã€‚ä¸ºè¯é¢˜å¼•å…¥ä¸€ä¸ªæ–°çš„æ¶ˆè´¹è€…ï¼Œåªéœ€å¯åŠ¨ä¸€ä¸ªé…ç½®äº† nsqlookup å®ä¾‹åœ°å€çš„ NSQ å®¢æˆ·ç«¯ã€‚æ— éœ€ä¸ºæ·»åŠ ä»»ä½•æ–°çš„æ¶ˆè´¹è€…æˆ–ç”Ÿäº§è€…æ›´æ”¹é…ç½®ï¼Œå¤§å¤§é™ä½äº†å¼€é”€å’Œå¤æ‚æ€§ã€‚ 2.3 æ¶ˆé™¤å•ç‚¹æ•…éšœNSQè¢«è®¾è®¡ä»¥åˆ†å¸ƒçš„æ–¹å¼è¢«ä½¿ç”¨ã€‚nsqd å®¢æˆ·ç«¯ï¼ˆé€šè¿‡ TCP ï¼‰è¿æ¥åˆ°æŒ‡å®šè¯é¢˜çš„æ‰€æœ‰ç”Ÿäº§è€…å®ä¾‹ã€‚æ²¡æœ‰ä¸­é—´äººï¼Œæ²¡æœ‰æ¶ˆæ¯ä»£ç†ï¼Œä¹Ÿæ²¡æœ‰å•ç‚¹æ•…éšœã€‚è¿™ç§æ‹“æ‰‘ç»“æ„æ¶ˆé™¤å•é“¾ï¼Œèšåˆï¼Œåé¦ˆã€‚ç›¸åï¼Œä½ çš„æ¶ˆè´¹è€…ç›´æ¥è®¿é—®æ‰€æœ‰ç”Ÿäº§è€…ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œå“ªä¸ªå®¢æˆ·ç«¯è¿æ¥åˆ°å“ªä¸ª NSQ ä¸é‡è¦ï¼Œåªè¦æœ‰è¶³å¤Ÿçš„æ¶ˆè´¹è€…è¿æ¥åˆ°æ‰€æœ‰ç”Ÿäº§è€…ï¼Œä»¥æ»¡è¶³å¤§é‡çš„æ¶ˆæ¯ï¼Œä¿è¯æ‰€æœ‰ä¸œè¥¿æœ€ç»ˆå°†è¢«å¤„ç†ã€‚å¯¹äº nsqlookupdï¼Œé«˜å¯ç”¨æ€§æ˜¯é€šè¿‡è¿è¡Œå¤šä¸ªå®ä¾‹æ¥å®ç°ã€‚ä»–ä»¬ä¸ç›´æ¥ç›¸äº’é€šä¿¡å’Œæ•°æ®è¢«è®¤ä¸ºæ˜¯æœ€ç»ˆä¸€è‡´ã€‚æ¶ˆè´¹è€…è½®è¯¢æ‰€æœ‰çš„é…ç½®çš„ nsqlookupd å®ä¾‹å’Œåˆå¹¶ responseã€‚å¤±è´¥çš„ï¼Œæ— æ³•è®¿é—®çš„ï¼Œæˆ–ä»¥å…¶ä»–æ–¹å¼æ•…éšœçš„èŠ‚ç‚¹ä¸ä¼šè®©ç³»ç»Ÿé™·äºåœé¡¿ã€‚ 2.4 æ•ˆç‡å¯¹äºæ•°æ®çš„åè®®ï¼Œé€šè¿‡æ¨é€æ•°æ®åˆ°å®¢æˆ·ç«¯æœ€å¤§é™åº¦åœ°æé«˜æ€§èƒ½å’Œååé‡çš„ï¼Œè€Œä¸æ˜¯ç­‰å¾…å®¢æˆ·ç«¯æ‹‰æ•°æ®ã€‚è¿™ä¸ªæ¦‚å¿µï¼Œç§°ä¹‹ä¸º RDY çŠ¶æ€ï¼ŒåŸºæœ¬ä¸Šæ˜¯å®¢æˆ·ç«¯æµé‡æ§åˆ¶çš„ä¸€ç§å½¢å¼ã€‚å½“å®¢æˆ·ç«¯è¿æ¥åˆ° nsqd å’Œå¹¶è®¢é˜…åˆ°ä¸€ä¸ªé€šé“æ—¶ï¼Œå®ƒè¢«æ”¾ç½®åœ¨ä¸€ä¸ª RDY ä¸º 0 çŠ¶æ€ã€‚è¿™æ„å‘³ç€ï¼Œè¿˜æ²¡æœ‰ä¿¡æ¯è¢«å‘é€åˆ°å®¢æˆ·ç«¯ã€‚å½“å®¢æˆ·ç«¯å·²å‡†å¤‡å¥½æ¥æ”¶æ¶ˆæ¯å‘é€ï¼Œæ›´æ–°å®ƒçš„å‘½ä»¤ RDY çŠ¶æ€åˆ°å®ƒå‡†å¤‡å¤„ç†çš„æ•°é‡ï¼Œæ¯”å¦‚ 100ã€‚æ— éœ€ä»»ä½•é¢å¤–çš„æŒ‡ä»¤ï¼Œå½“ 100 æ¡æ¶ˆæ¯å¯ç”¨æ—¶ï¼Œå°†è¢«ä¼ é€’åˆ°å®¢æˆ·ç«¯ï¼ˆæœåŠ¡å™¨ç«¯ä¸ºé‚£ä¸ªå®¢æˆ·ç«¯æ¯æ¬¡é€’å‡ RDY è®¡æ•°ï¼‰ã€‚å®¢æˆ·ç«¯åº“çš„è¢«è®¾è®¡æˆåœ¨ RDY æ•°è¾¾åˆ°é…ç½® max-in-flight çš„ 25% å‘é€ä¸€ä¸ªå‘½ä»¤æ¥æ›´æ–° RDY è®¡æ•°ï¼ˆå¹¶é€‚å½“è€ƒè™‘è¿æ¥åˆ°å¤šä¸ª nsqd æƒ…å†µä¸‹ï¼Œé€‚å½“åœ°åˆ†é…ï¼‰ã€‚ 2.5 å¿ƒè·³å’Œè¶…æ—¶NSQ çš„ TCP åè®®æ˜¯é¢å‘ push çš„ã€‚åœ¨å»ºç«‹è¿æ¥ï¼Œæ¡æ‰‹ï¼Œå’Œè®¢é˜…åï¼Œæ¶ˆè´¹è€…è¢«æ”¾ç½®åœ¨ä¸€ä¸ªä¸º 0 çš„ RDY çŠ¶æ€ã€‚å½“æ¶ˆè´¹è€…å‡†å¤‡å¥½æ¥æ”¶æ¶ˆæ¯ï¼Œå®ƒæ›´æ–°çš„ RDY çŠ¶æ€åˆ°å‡†å¤‡æ¥æ”¶æ¶ˆæ¯çš„æ•°é‡ã€‚NSQ å®¢æˆ·ç«¯åº“ä¸æ–­åœ¨å¹•åç®¡ç†ï¼Œæ¶ˆæ¯æ§åˆ¶æµçš„ç»“æœã€‚æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œnsqd å°†å‘é€ä¸€ä¸ªå¿ƒè·³çº¿è¿æ¥ã€‚å®¢æˆ·ç«¯å¯ä»¥é…ç½®å¿ƒè·³ä¹‹é—´çš„é—´éš”ï¼Œä½† nsqd ä¼šæœŸå¾…ä¸€ä¸ªå›åº”åœ¨å®ƒå‘é€ä¸‹ä¸€ä¸ªå¿ƒæ‰ä¹‹å‰ã€‚ç»„åˆåº”ç”¨çº§åˆ«çš„å¿ƒè·³å’Œ RDY çŠ¶æ€ï¼Œé¿å…å¤´é˜»å¡ç°è±¡ï¼Œä¹Ÿå¯èƒ½ä½¿å¿ƒè·³æ— ç”¨ï¼ˆå³ï¼Œå¦‚æœæ¶ˆè´¹è€…æ˜¯åœ¨åé¢çš„å¤„ç†æ¶ˆæ¯æµçš„æ¥æ”¶ç¼“å†²åŒºä¸­ï¼Œæ“ä½œç³»ç»Ÿå°†è¢«å¡«æ»¡ï¼Œå µå¿ƒè·³ï¼‰ä¸ºäº†ä¿è¯è¿›åº¦ï¼Œæ‰€æœ‰çš„ç½‘ç»œ IO æ—¶é—´ä¸Šé™åŠ¿å¿…ä¸é…ç½®çš„å¿ƒè·³é—´éš”ç›¸å…³è”ã€‚è¿™æ„å‘³ç€ï¼Œä½ å¯ä»¥ä»å­—é¢ä¸Šæ‹”æ‰ä¹‹é—´çš„ç½‘ç»œè¿æ¥ nsqd å’Œæ¶ˆè´¹è€…ï¼Œå®ƒä¼šæ£€æµ‹å¹¶æ­£ç¡®å¤„ç†é”™è¯¯ã€‚å½“æ£€æµ‹åˆ°ä¸€ä¸ªè‡´å‘½é”™è¯¯ï¼Œå®¢æˆ·ç«¯è¿æ¥è¢«å¼ºåˆ¶å…³é—­ã€‚åœ¨ä¼ è¾“ä¸­çš„æ¶ˆæ¯ä¼šè¶…æ—¶è€Œé‡æ–°æ’é˜Ÿç­‰å¾…ä¼ é€’åˆ°å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚æœ€åï¼Œé”™è¯¯ä¼šè¢«è®°å½•å¹¶ç´¯è®¡åˆ°å„ç§å†…éƒ¨æŒ‡æ ‡ã€‚ 2.6 åˆ†å¸ƒå¼å› ä¸ºNSQæ²¡æœ‰åœ¨å®ˆæŠ¤ç¨‹åºä¹‹é—´å…±äº«ä¿¡æ¯ï¼Œæ‰€ä»¥å®ƒä»ä¸€å¼€å§‹å°±æ˜¯ä¸ºäº†åˆ†å¸ƒå¼æ“ä½œè€Œç”Ÿã€‚ä¸ªåˆ«çš„æœºå™¨å¯ä»¥éšä¾¿å®•æœºéšä¾¿å¯åŠ¨è€Œä¸ä¼šå½±å“åˆ°ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†ï¼Œæ¶ˆæ¯å‘å¸ƒè€…å¯ä»¥åœ¨æœ¬åœ°å‘å¸ƒï¼Œå³ä½¿é¢å¯¹ç½‘ç»œåˆ†åŒºã€‚è¿™ç§â€œåˆ†å¸ƒå¼ä¼˜å…ˆâ€çš„è®¾è®¡ç†å¿µæ„å‘³ç€NSQåŸºæœ¬ä¸Šå¯ä»¥æ°¸è¿œä¸æ–­åœ°æ‰©å±•ï¼Œéœ€è¦æ›´é«˜çš„ååé‡ï¼Ÿé‚£å°±æ·»åŠ æ›´å¤šçš„nsqdå§ã€‚å”¯ä¸€çš„å…±äº«çŠ¶æ€å°±æ˜¯ä¿å­˜åœ¨lookupèŠ‚ç‚¹ä¸Šï¼Œç”šè‡³å®ƒä»¬ä¸éœ€è¦å…¨å±€è§†å›¾ï¼Œé…ç½®æŸäº›nsqdæ³¨å†Œåˆ°æŸäº›lookupèŠ‚ç‚¹ä¸Šè¿™æ˜¯å¾ˆç®€å•çš„é…ç½®ï¼Œå”¯ä¸€å…³é”®çš„åœ°æ–¹å°±æ˜¯æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡lookupèŠ‚ç‚¹è·å–æ‰€æœ‰å®Œæ•´çš„èŠ‚ç‚¹é›†ã€‚æ¸…æ™°çš„æ•…éšœäº‹ä»¶â€”â€”NSQåœ¨ç»„ä»¶å†…å»ºç«‹äº†ä¸€å¥—æ˜ç¡®å…³äºå¯èƒ½å¯¼è‡´æ•…éšœçš„çš„æ•…éšœæƒè¡¡æœºåˆ¶ï¼Œè¿™å¯¹æ¶ˆæ¯ä¼ é€’å’Œæ¢å¤éƒ½æœ‰æ„ä¹‰ã€‚è™½ç„¶å®ƒä»¬å¯èƒ½ä¸åƒKafkaç³»ç»Ÿé‚£æ ·æä¾›ä¸¥æ ¼çš„ä¿è¯çº§åˆ«ï¼Œä½†NSQç®€å•çš„æ“ä½œä½¿æ•…éšœæƒ…å†µéå¸¸æ˜æ˜¾ã€‚ 2.7 no replicationä¸åƒå…¶ä»–çš„é˜Ÿåˆ—ç»„ä»¶ï¼ŒNSQå¹¶æ²¡æœ‰æä¾›ä»»ä½•å½¢å¼çš„å¤åˆ¶å’Œé›†ç¾¤ï¼Œä¹Ÿæ­£æ˜¯è¿™ç‚¹è®©å®ƒèƒ½å¤Ÿå¦‚æ­¤ç®€å•åœ°è¿è¡Œï¼Œä½†å®ƒç¡®å®å¯¹äºä¸€äº›é«˜ä¿è¯æ€§é«˜å¯é æ€§çš„æ¶ˆæ¯å‘å¸ƒæ²¡æœ‰è¶³å¤Ÿçš„ä¿è¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é™ä½æ–‡ä»¶åŒæ­¥çš„æ—¶é—´æ¥éƒ¨åˆ†é¿å…ï¼Œåªéœ€é€šè¿‡ä¸€ä¸ªæ ‡å¿—é…ç½®ï¼Œé€šè¿‡EBSæ”¯æŒæˆ‘ä»¬çš„é˜Ÿåˆ—ã€‚ä½†æ˜¯è¿™æ ·ä»ç„¶å­˜åœ¨ä¸€ä¸ªæ¶ˆæ¯è¢«å‘å¸ƒåé©¬ä¸Šæ­»äº¡ï¼Œä¸¢å¤±äº†æœ‰æ•ˆçš„å†™å…¥çš„æƒ…å†µã€‚ 2.8 æ²¡æœ‰ä¸¥æ ¼çš„é¡ºåºè™½ç„¶Kafkaç”±ä¸€ä¸ªæœ‰åºçš„æ—¥å¿—æ„æˆï¼Œä½†NSQä¸æ˜¯ã€‚æ¶ˆæ¯å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ä»¥ä»»ä½•é¡ºåºè¿›å…¥é˜Ÿåˆ—ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨çš„æ¡ˆä¾‹ä¸­ï¼Œè¿™é€šå¸¸æ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæ‰€æœ‰çš„æ•°æ®éƒ½è¢«åŠ ä¸Šäº†æ—¶é—´æˆ³ï¼Œä½†å®ƒå¹¶ä¸é€‚åˆéœ€è¦ä¸¥æ ¼é¡ºåºçš„æƒ…å†µã€‚ 2.9 æ— æ•°æ®é‡å¤åˆ é™¤åŠŸèƒ½NSQå¯¹äºè¶…æ—¶ç³»ç»Ÿï¼Œå®ƒä½¿ç”¨äº†å¿ƒè·³æ£€æµ‹æœºåˆ¶å»æµ‹è¯•æ¶ˆè´¹è€…æ˜¯å¦å­˜æ´»è¿˜æ˜¯æ­»äº¡ã€‚å¾ˆå¤šåŸå› ä¼šå¯¼è‡´æˆ‘ä»¬çš„consumeræ— æ³•å®Œæˆå¿ƒè·³æ£€æµ‹ï¼Œæ‰€ä»¥åœ¨consumerä¸­å¿…é¡»æœ‰ä¸€ä¸ªå•ç‹¬çš„æ­¥éª¤ç¡®ä¿å¹‚ç­‰æ€§ã€‚ 3. å®è·µå®‰è£…è¿‡ç¨‹æœ¬æ–‡å°†nsqé›†ç¾¤å…·ä½“çš„å®‰è£…è¿‡ç¨‹ç•¥å»ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå‚è€ƒå®˜ç½‘ï¼Œæ¯”è¾ƒç®€å•ã€‚è¿™éƒ¨åˆ†ä»‹ç»ä¸‹ç¬”è€…å®éªŒçš„æ‹“æ‰‘ï¼Œä»¥åŠnsqadminçš„ç›¸å…³ä¿¡æ¯ã€‚ 3.1 æ‹“æ‰‘ç»“æ„ å®éªŒé‡‡ç”¨3å°NSQDæœåŠ¡ï¼Œ2å°LOOKUPDæœåŠ¡ã€‚é‡‡ç”¨å®˜æ–¹æ¨èçš„æ‹“æ‰‘ï¼Œæ¶ˆæ¯å‘å¸ƒçš„æœåŠ¡å’ŒNSQDåœ¨ä¸€å°ä¸»æœºã€‚ä¸€å…±5å°æœºå™¨ã€‚NSQåŸºæœ¬æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œé…ç½®é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå‚æ•°ã€‚ä¸»è¦å‘½ä»¤å¦‚ä¸‹:LOOKUPDå‘½ä»¤ 1bin/nsqlookupd NSQDå‘½ä»¤ 1bin/nsqd --lookupd-tcp-address=172.16.30.254:4160 -broadcast-address=172.16.30.254 1bin/nsqadmin --lookupd-http-address=172.16.30.254:4161 å·¥å…·ç±»ï¼Œæ¶ˆè´¹åå­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶ã€‚ 1bin/nsq_to_file --topic=newtest --channel=test --output-dir=/tmp --lookupd-http-address=172.16.30.254:4161 å‘å¸ƒä¸€æ¡æ¶ˆæ¯1curl -d 'hello world 5' 'http://172.16.30.254:4151/put?topic=test' 3.2 nsqadminå¯¹Streamsçš„è¯¦ç»†ä¿¡æ¯è¿›è¡ŒæŸ¥çœ‹ï¼ŒåŒ…æ‹¬NSQDèŠ‚ç‚¹ï¼Œå…·ä½“çš„channelï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°ï¼Œè¿æ¥æ•°ç­‰ä¿¡æ¯ã€‚ åˆ—å‡ºæ‰€æœ‰çš„NSQDèŠ‚ç‚¹: æ¶ˆæ¯çš„ç»Ÿè®¡: lookupä¸»æœºçš„åˆ—è¡¨: 4. æ€»ç»“NSQåŸºæœ¬æ ¸å¿ƒå°±æ˜¯ç®€å•æ€§ï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ï¼Œè¿™æ„å‘³ç€å®ƒå¾ˆå®¹æ˜“è¿›è¡Œæ•…éšœæ¨ç†å’Œå¾ˆå®¹æ˜“å‘ç°bugã€‚æ¶ˆè´¹è€…å¯ä»¥è‡ªè¡Œå¤„ç†æ•…éšœäº‹ä»¶è€Œä¸ä¼šå½±å“ç³»ç»Ÿå‰©ä¸‹çš„å…¶ä½™éƒ¨åˆ†ã€‚ äº‹å®ä¸Šï¼Œç®€å•æ€§æ˜¯æˆ‘ä»¬å†³å®šä½¿ç”¨NSQçš„é¦–è¦å› ç´ ï¼Œè¿™æ–¹ä¾¿ä¸æˆ‘ä»¬çš„è®¸å¤šå…¶ä»–è½¯ä»¶ä¸€èµ·ç»´æŠ¤ï¼Œé€šè¿‡å¼•å…¥é˜Ÿåˆ—ä½¿æˆ‘ä»¬å¾—åˆ°äº†å ªç§°å®Œç¾çš„è¡¨ç°ï¼Œé€šè¿‡é˜Ÿåˆ—ç”šè‡³è®©æˆ‘ä»¬å¢åŠ äº†å‡ ä¸ªæ•°é‡çº§çš„ååé‡ã€‚è¶Šæ¥è¶Šå¤šçš„consumeréœ€è¦ä¸€å¥—ä¸¥æ ¼å¯é æ€§å’Œé¡ºåºæ€§ä¿éšœï¼Œè¿™å·²ç»è¶…è¿‡äº†NSQæä¾›çš„ç®€å•åŠŸèƒ½ã€‚ ç»“åˆæˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿæ¥çœ‹ï¼Œå¯¹äºæˆ‘ä»¬æ‰€éœ€è¦ä¼ è¾“çš„å‘ç¥¨æ¶ˆæ¯ï¼Œç›¸å¯¹æ¯”è¾ƒæ•æ„Ÿï¼Œæ— æ³•å®¹å¿æŸä¸ªnsqdå®•æœºï¼Œæˆ–è€…ç£ç›˜æ— æ³•ä½¿ç”¨çš„æƒ…å†µï¼Œè¯¥èŠ‚ç‚¹å †ç§¯çš„æ¶ˆæ¯æ— æ³•æ‰¾å›ã€‚è¿™æ˜¯æˆ‘ä»¬æ²¡æœ‰é€‰æ‹©è¯¥æ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸»è¦åŸå› ã€‚ç®€å•æ€§å’Œå¯é æ€§ä¼¼ä¹å¹¶ä¸èƒ½å®Œå…¨æ»¡è¶³ã€‚ç›¸æ¯”Kafkaï¼Œopsè‚©è´Ÿèµ·æ›´å¤šè´Ÿè´£çš„è¿è¥ã€‚å¦ä¸€æ–¹é¢ï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªå¯å¤åˆ¶çš„ã€æœ‰åºçš„æ—¥å¿—å¯ä»¥æä¾›ç»™æˆ‘ä»¬æ›´å¥½çš„æœåŠ¡ã€‚ä½†å¯¹äºå…¶ä»–é€‚åˆNSQçš„consumerï¼Œå®ƒä¸ºæˆ‘ä»¬æœåŠ¡çš„ç›¸å½“å¥½ï¼Œæˆ‘ä»¬æœŸå¾…ç€ç»§ç»­å·©å›ºå®ƒçš„åšå®çš„åŸºç¡€ã€‚ ps: æœ¬æ–‡é¦–å‘äºç¬”è€…çš„csdnåšå®¢ï¼Œæ­¤å¤„å°†å…¶åŠ å…¥ä¸ªäººçš„åšå®¢ã€‚ å‚è€ƒ NSQï¼šåˆ†å¸ƒå¼çš„å®æ—¶æ¶ˆæ¯å¹³å° NSQ - NYC Golang Meetup NSQ Docs]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>Cluster</tag>
        <tag>mq</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Lombokä½¿ç”¨ä¸åŸç†]]></title>
    <url>%2F2017%2F10%2F06%2Flombok%2F</url>
    <content type="text"><![CDATA[1. Lombokç®€ä»‹é¦–å…ˆLombokæ˜¯ä¸€æ¬¾Java IDEçš„åº”ç”¨å·¥å…·æ’ä»¶ï¼Œä¸€ä¸ªå¯ä»¥é€šè¿‡ç®€å•çš„æ³¨è§£å½¢å¼æ¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–æ¶ˆé™¤ä¸€äº›å¿…é¡»æœ‰ä½†æ˜¾å¾—å¾ˆè‡ƒè‚¿çš„Javaä»£ç çš„å·¥å…·ï¼Œæ¯”å¦‚å±æ€§çš„æ„é€ å™¨ã€getterã€setterã€equalsã€hashcodeã€toStringæ–¹æ³•ã€‚ç»“åˆIDEï¼Œé€šè¿‡ä½¿ç”¨å¯¹åº”çš„æ³¨è§£ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æºç çš„æ—¶å€™ç”Ÿæˆå¯¹åº”çš„æ–¹æ³•ã€‚å®˜æ–¹åœ°å€ï¼šhttps://projectlombok.org/ã€‚ è™½ç„¶ä¸Šè¿°çš„é‚£äº›å¸¸ç”¨æ–¹æ³•IDEéƒ½èƒ½ç”Ÿæˆï¼Œä½†æ˜¯lombokæ›´åŠ ç®€æ´ä¸æ–¹ä¾¿ï¼Œèƒ½å¤Ÿè¾¾åˆ°çš„æ•ˆæœå°±æ˜¯åœ¨æºç ä¸­ä¸éœ€è¦å†™ä¸€äº›é€šç”¨çš„æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ä¸­ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆè¿™äº›æ–¹æ³•ï¼Œè¿™å°±æ˜¯lombokçš„ç¥å¥‡ä½œç”¨ã€‚ 2. å®‰è£…2.1 æ’ä»¶å®‰è£…ç¬”è€…ä¸»è¦ä½¿ç”¨çš„IDEæ˜¯Intellij ideaï¼Œç¼–è¯‘å™¨éœ€è¦åœ¨ 1preference-&gt;plugins-&gt;Browse repositories æœç´¢lombokï¼Œç„¶åå®‰è£…pluginsï¼Œéœ€è¦ç¨ç­‰ç‰‡åˆ»ã€‚ç¬”è€…æˆªå›¾å·²ç»å®‰è£…å¥½ã€‚ 2.2 æ·»åŠ jaråŒ…åœ¨é¡¹ç›®ä¸­æ·»åŠ lombokçš„jaråŒ…ï¼Œç¬”è€…ç”¨çš„æ˜¯mavenï¼Œæ‰€ä»¥åœ¨pomæ–‡ä»¶ä¸­æ·»åŠ äº†å¦‚ä¸‹çš„ä¾èµ–ã€‚gradleä½¿ç”¨è§å®˜ç½‘ã€‚ 123456&lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.16.16&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt;&lt;/dependency&gt; 3. ä½¿ç”¨lombokä¸»è¦é€šè¿‡æ³¨è§£èµ·ä½œç”¨ï¼Œè¯¦ç»†çš„æ³¨è§£è§Lombok featuresã€‚ With Lombok: 12345678910111213import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;import java.io.Serializable;@Data@AllArgsConstructorpublic class UserEntity implements Serializable &#123; private long userId; private String userName; private String sex;&#125; ç¼–è¯‘åï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697import java.beans.ConstructorProperties;import java.io.Serializable;public class UserEntity implements Serializable &#123; private long userId; private String userName; private String sex; public long getUserId() &#123; return this.userId; &#125; public String getUserName() &#123; return this.userName; &#125; public String getSex() &#123; return this.sex; &#125; public void setUserId(long userId) &#123; this.userId = userId; &#125; public void setUserName(String userName) &#123; this.userName = userName; &#125; public void setSex(String sex) &#123; this.sex = sex; &#125; public boolean equals(Object o) &#123; if(o == this) &#123; return true; &#125; else if(!(o instanceof UserEntity)) &#123; return false; &#125; else &#123; UserEntity other = (UserEntity)o; if(!other.canEqual(this)) &#123; return false; &#125; else if(this.getUserId() != other.getUserId()) &#123; return false; &#125; else &#123; Object this$userName = this.getUserName(); Object other$userName = other.getUserName(); if(this$userName == null) &#123; if(other$userName != null) &#123; return false; &#125; &#125; else if(!this$userName.equals(other$userName)) &#123; return false; &#125; Object this$sex = this.getSex(); Object other$sex = other.getSex(); if(this$sex == null) &#123; if(other$sex != null) &#123; return false; &#125; &#125; else if(!this$sex.equals(other$sex)) &#123; return false; &#125; return true; &#125; &#125; &#125; protected boolean canEqual(Object other) &#123; return other instanceof UserEntity; &#125; public int hashCode() &#123; int PRIME = true; int result = 1; long $userId = this.getUserId(); int result = result * 59 + (int)($userId &gt;&gt;&gt; 32 ^ $userId); Object $userName = this.getUserName(); result = result * 59 + ($userName == null?43:$userName.hashCode()); Object $sex = this.getSex(); result = result * 59 + ($sex == null?43:$sex.hashCode()); return result; &#125; public String toString() &#123; return "UserEntity(userId=" + this.getUserId() + ", userName=" + this.getUserName() + ", sex=" + this.getSex() + ")"; &#125; @ConstructorProperties(&#123;"userId", "userName", "sex"&#125;) public UserEntity(long userId, String userName, String sex) &#123; this.userId = userId; this.userName = userName; this.sex = sex; &#125;&#125; è¿™è¾¹ä»‹ç»ç¬”è€…ç»å¸¸ä½¿ç”¨åˆ°çš„æ³¨è§£ã€‚ valï¼Œç”¨åœ¨å±€éƒ¨å˜é‡å‰é¢ï¼Œç›¸å½“äºå°†å˜é‡å£°æ˜ä¸ºfinal @Valueç”¨åœ¨ç±»ä¸Šï¼Œæ˜¯@Dataçš„ä¸å¯å˜å½¢å¼ï¼Œç›¸å½“äºä¸ºå±æ€§æ·»åŠ finalå£°æ˜ï¼Œåªæä¾›getteræ–¹æ³•ï¼Œè€Œä¸æä¾›setteræ–¹æ³• @Data@ToString, @EqualsAndHashCode, æ‰€æœ‰å±æ€§çš„@Getter, æ‰€æœ‰non-finalå±æ€§çš„@Setterå’Œ@RequiredArgsConstructorçš„ç»„åˆï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ³¨è§£å°±è¶³å¤Ÿäº†ã€‚ @NoArgsConstructoræ— å‚æ„é€ å™¨ @AllArgsConstructorå…¨å‚æ„é€ å™¨ @ToString ç”ŸæˆtoStringæ–¹æ³•ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¾“å‡ºç±»åã€æ‰€æœ‰å±æ€§ï¼Œå±æ€§ä¼šæŒ‰ç…§é¡ºåºè¾“å‡ºï¼Œä»¥é€—å·åˆ†å‰²ã€‚ @EqualsAndHashCodeé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨æ‰€æœ‰éç¬æ€(non-transient)å’Œéé™æ€(non-static)å­—æ®µæ¥ç”Ÿæˆequalså’Œhascodeæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå…·ä½“ä½¿ç”¨å“ªäº›å±æ€§ã€‚ @Getter / @Setterä¸Šé¢å·²ç»è¯´è¿‡ï¼Œä¸€èˆ¬ç”¨@dataå°±ä¸ç”¨é¢å¤–åŠ è¿™ä¸ªæ³¨è§£äº†ã€‚å¯ä»¥ä½œç”¨åœ¨ç±»ä¸Šå’Œå±æ€§ä¸Šï¼Œæ”¾åœ¨ç±»ä¸Šï¼Œä¼šå¯¹æ‰€æœ‰çš„éé™æ€(non-static)å±æ€§ç”ŸæˆGetter/Setteræ–¹æ³•ï¼Œæ”¾åœ¨å±æ€§ä¸Šï¼Œä¼šå¯¹è¯¥å±æ€§ç”ŸæˆGetter/Setteræ–¹æ³•ã€‚å¹¶å¯ä»¥æŒ‡å®šGetter/Setteræ–¹æ³•çš„è®¿é—®çº§åˆ«ã€‚ @NonNullï¼Œç»™æ–¹æ³•å‚æ•°å¢åŠ è¿™ä¸ªæ³¨è§£ä¼šè‡ªåŠ¨åœ¨æ–¹æ³•å†…å¯¹è¯¥å‚æ•°è¿›è¡Œæ˜¯å¦ä¸ºç©ºçš„æ ¡éªŒï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™æŠ›å‡ºNPEï¼ˆNullPointerExceptionï¼‰ @Cleanupè‡ªåŠ¨ç®¡ç†èµ„æºï¼Œç”¨åœ¨å±€éƒ¨å˜é‡ä¹‹å‰ï¼Œåœ¨å½“å‰å˜é‡èŒƒå›´å†…å³å°†æ‰§è¡Œå®Œæ¯•é€€å‡ºä¹‹å‰ä¼šè‡ªåŠ¨æ¸…ç†èµ„æºï¼Œè‡ªåŠ¨ç”Ÿæˆtry-finallyè¿™æ ·çš„ä»£ç æ¥å…³é—­æµ @Logæ ¹æ®ä¸åŒçš„æ³¨è§£ç”Ÿæˆä¸åŒç±»å‹çš„logå¯¹è±¡ï¼Œä½†æ˜¯å®ä¾‹åç§°éƒ½æ˜¯logï¼Œæœ‰7ç§å¯é€‰å®ç°ç±»ï¼š 1). @Log4j 1private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(LogExample.class); 2). @Log4j2 1private static final org.apache.logging.log4j.Logger log = org.apache.logging.log4j.LogManager.getLogger(LogExample.class); 3). @Slf4j 1private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(LogExample.class); 4). @XSlf4j 1private static final org.slf4j.ext.XLogger log = org.slf4j.ext.XLoggerFactory.getXLogger(LogExample.class); 5). @CommonsLog 1private static final org.apache.commons.logging.Log log = org.apache.commons.logging.LogFactory.getLog(LogExample.class); 6). @JBossLog 1private static final org.jboss.logging.Logger log = org.jboss.logging.Logger.getLogger(LogExample.class); 7). @Log private static final java.util.logging.Logger log = java.util.logging.Logger.getLogger(LogExample.class.getName()); é»˜è®¤æƒ…å†µä¸‹ï¼Œloggerçš„åå­—å°†ä¼šæ˜¯è¢«@Logæ³¨è§£çš„é‚£ä¸ªç±»çš„åå­—ã€‚å½“ç„¶è¿™ä¹Ÿå¯ä»¥è¢«ä¸ªæ€§åŒ–å‘½åï¼Œé€šè¿‡topicå‚æ•°ï¼Œå¦‚@XSlf4j(topic=&quot;reporting&quot;)ã€‚ 4. åŸç†lombok ä¸»è¦é€šè¿‡æ³¨è§£ç”Ÿæ•ˆï¼Œè‡ªjdk5å¼•å…¥æ³¨è§£ï¼Œç”±ä¸¤ç§è§£ææ–¹å¼ã€‚ç¬¬ä¸€ç§æ˜¯è¿è¡Œæ—¶è§£æï¼Œ@Retention(RetentionPolicy.RUNTIME), å®šä¹‰æ³¨è§£çš„ä¿ç•™ç­–ç•¥ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°è¯¥æ³¨è§£ã€‚å¦ä¸€ç§æ˜¯ç¼–è¯‘æ—¶è§£æï¼Œæœ‰ä¸¤ç§æœºåˆ¶ã€‚ Annotation Processing Toolï¼Œaptè‡ªJDK5äº§ç”Ÿï¼ŒJDK7å·²æ ‡è®°ä¸ºè¿‡æœŸï¼Œä¸æ¨èä½¿ç”¨ï¼ŒJDK8ä¸­å·²å½»åº•åˆ é™¤ï¼Œè‡ªJDK6å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨Pluggable Annotation Processing APIæ¥æ›¿æ¢å®ƒï¼Œaptè¢«æ›¿æ¢ä¸»è¦æœ‰2ç‚¹åŸå› ã€‚apiéƒ½åœ¨com.sun.mirroréæ ‡å‡†åŒ…ä¸‹ï¼Œè¿˜æœ‰å°±æ˜¯æ²¡æœ‰é›†æˆåˆ°javacä¸­ï¼Œéœ€è¦é¢å¤–è¿è¡Œã€‚ Pluggable Annotation Processing APIlombokä½¿ç”¨è¿™ç§æ–¹å¼å®ç°ï¼ŒåŸºäºJSR 269ï¼Œè‡ªJDK6åŠ å…¥ï¼Œä½œä¸ºaptçš„æ›¿ä»£æ–¹æ¡ˆï¼Œå®ƒè§£å†³äº†aptçš„ä¸¤ä¸ªé—®é¢˜ï¼Œjavacåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè°ƒç”¨å®ç°äº†è¯¥APIçš„ç¨‹åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹ç¼–è¯‘å™¨åšä¸€äº›å¢å¼ºï¼Œè¿™æ—¶javacæ‰§è¡Œçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š 5. æ€»ç»“è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£äº†lombokçš„å…¥é—¨ä¸ä½¿ç”¨ã€‚ä»‹ç»äº†ä¸€äº›å¸¸ç”¨çš„lombokæ³¨è§£ï¼Œå¤§å¤§ç®€åŒ–äº†æˆ‘ä»¬çš„å¼€å‘å·¥ä½œå’Œä»£ç çš„ç®€æ´æ€§ã€‚å½“ç„¶ï¼Œlombokä¸æ”¯æŒå¤šç§å‚æ•°æ„é€ å™¨çš„é‡è½½ï¼Œå·¥å…·æ¯•ç«Ÿæ˜¯å·¥å…·ï¼Œæˆ‘æ„Ÿè§‰å¹¶ä¸ä¼šæœ‰éå¸¸å®Œç¾é€‚åˆæ¯ä¸ªäººçš„å·¥å…·ã€‚æœ€åï¼Œæˆ‘ä¸ªäººè¿˜æ˜¯å¾ˆæ¨èè¿™æ¬¾æ’ä»¶çš„ï¼Œæ¯•ç«Ÿæˆ‘å¾ˆæ‡’ï¼ŒğŸ˜†ã€‚ å‚è€ƒ Lombok Docs Javaå¥‡æ·«å·§æŠ€ä¹‹Lombok]]></content>
      <categories>
        <category>Utils</category>
      </categories>
      <tags>
        <tag>Lombok</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redis Clusteræ·±å…¥ä¸å®è·µ]]></title>
    <url>%2F2017%2F09%2F29%2Frediscluster%2F</url>
    <content type="text"><![CDATA[1. redisä»‹ç»www.redis.ioredisæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„K-Vå­˜å‚¨æ•°æ®åº“ã€‚æ”¯æŒå­˜å‚¨çš„ç±»å‹æœ‰string,list,set,zset(sorted set),hashç­‰ã€‚è¿™äº›æ•°æ®ç±»å‹éƒ½æ”¯æŒpush/popã€add/removeåŠå–äº¤é›†å¹¶é›†å’Œå·®é›†åŠæ›´ä¸°å¯Œçš„æ“ä½œï¼Œè€Œä¸”è¿™äº›æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚redisæ”¯æŒå„ç§ä¸åŒæ–¹å¼çš„æ’åºã€‚ä¿è¯æ•ˆç‡çš„æƒ…å†µä¸‹ï¼Œæ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚åŒæ—¶redisæä¾›äº†æŒä¹…åŒ–ç­–ç•¥ï¼Œä¸åŒçš„ç­–ç•¥è§¦å‘åŒæ­¥åˆ°ç£ç›˜æˆ–è€…æŠŠä¿®æ”¹æ“ä½œå†™å…¥è¿½åŠ çš„è®°å½•æ–‡ä»¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†master-slaveã€‚ å®ƒæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å­˜å‚¨ç³»ç»Ÿï¼Œèƒ½æ”¯æŒè¶…è¿‡ 100K+ æ¯ç§’çš„è¯»å†™é¢‘ç‡ã€‚åŒæ—¶è¿˜æ”¯æŒæ¶ˆæ¯çš„å‘å¸ƒ/è®¢é˜…ï¼Œä»è€Œè®©ä½ åœ¨æ„å»ºé«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿæ—¶å¤šäº†å¦ä¸€ç§é€‰æ‹©ã€‚ Redisæ”¯æŒä¸»ä»åŒæ­¥ã€‚æ•°æ®å¯ä»¥ä»ä¸»æœåŠ¡å™¨å‘ä»»æ„æ•°é‡çš„ä»æœåŠ¡å™¨ä¸ŠåŒæ­¥ï¼Œä»æœåŠ¡å™¨å¯ä»¥æ˜¯å…³è”å…¶ä»–ä»æœåŠ¡å™¨çš„ä¸»æœåŠ¡å™¨ã€‚è¿™ä½¿å¾—Rediså¯æ‰§è¡Œå•å±‚æ ‘å¤åˆ¶ã€‚å­˜ç›˜å¯ä»¥æœ‰æ„æ— æ„çš„å¯¹æ•°æ®è¿›è¡Œå†™æ“ä½œã€‚ç”±äºå®Œå…¨å®ç°äº†å‘å¸ƒ/è®¢é˜…æœºåˆ¶ï¼Œä½¿å¾—ä»æ•°æ®åº“åœ¨ä»»ä½•åœ°æ–¹åŒæ­¥æ ‘æ—¶ï¼Œå¯è®¢é˜…ä¸€ä¸ªé¢‘é“å¹¶æ¥æ”¶ä¸»æœåŠ¡å™¨å®Œæ•´çš„æ¶ˆæ¯å‘å¸ƒè®°å½•ã€‚åŒæ­¥å¯¹è¯»å–æ“ä½œçš„å¯æ‰©å±•æ€§å’Œæ•°æ®å†—ä½™å¾ˆæœ‰å¸®åŠ©ã€‚ 2. ä¸»ä»redisæ”¯æŒmaster-slaveæ¨¡å¼ï¼Œä¸€ä¸»å¤šä»ï¼Œredis serverå¯ä»¥è®¾ç½®å¦å¤–å¤šä¸ªredis serverä¸ºslaveï¼Œä»æœºåŒæ­¥ä¸»æœºçš„æ•°æ®ã€‚é…ç½®åï¼Œè¯»å†™åˆ†ç¦»ï¼Œä¸»æœºè´Ÿè´£è¯»å†™æœåŠ¡ï¼Œä»æœºåªè´Ÿè´£è¯»ã€‚å‡è½»ä¸»æœºçš„å‹åŠ›ã€‚rediså®ç°çš„æ˜¯æœ€ç»ˆä¼šä¸€è‡´æ€§ï¼Œå…·ä½“é€‰æ‹©å¼ºä¸€è‡´æ€§è¿˜æ˜¯å¼±ä¸€è‡´æ€§ï¼Œå–å†³äºä¸šåŠ¡åœºæ™¯ã€‚redis ä¸»ä»åŒæ­¥æœ‰ä¸¤ç§æ–¹å¼ï¼ˆæˆ–è€…æ‰€ä¸¤ä¸ªé˜¶æ®µï¼‰ï¼šå…¨åŒæ­¥å’Œéƒ¨åˆ†åŒæ­¥ã€‚ ä¸»ä»åˆšåˆšè¿æ¥çš„æ—¶å€™ï¼Œè¿›è¡Œå…¨åŒæ­¥ï¼›å…¨åŒæ­¥ç»“æŸåï¼Œè¿›è¡Œéƒ¨åˆ†åŒæ­¥ã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰éœ€è¦ï¼Œslave åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥å‘èµ·å…¨åŒæ­¥ã€‚redis ç­–ç•¥æ˜¯ï¼Œæ— è®ºå¦‚ä½•ï¼Œé¦–å…ˆä¼šå°è¯•è¿›è¡Œéƒ¨åˆ†åŒæ­¥ï¼Œå¦‚ä¸æˆåŠŸï¼Œè¦æ±‚ä»æœºè¿›è¡Œå…¨åŒæ­¥ï¼Œå¹¶å¯åŠ¨ BGSAVEâ€¦â€¦BGSAVE ç»“æŸåï¼Œä¼ è¾“ RDB æ–‡ä»¶ï¼›å¦‚æœæˆåŠŸï¼Œå…è®¸ä»æœºè¿›è¡Œéƒ¨åˆ†åŒæ­¥ï¼Œå¹¶ä¼ è¾“ç§¯å‹ç©ºé—´ä¸­çš„æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œä¸»ä»åŒæ­¥å°±æ˜¯ RDB æ–‡ä»¶çš„ä¸Šä¼ ä¸‹è½½ï¼›ä¸»æœºæœ‰å°éƒ¨åˆ†çš„æ•°æ®ä¿®æ”¹ï¼Œå°±æŠŠä¿®æ”¹è®°å½•ä¼ æ’­ç»™æ¯ä¸ªä»æœºã€‚ 3. redisé›†ç¾¤ä¸»ä»æ¨¡å¼å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œmasterå®•æœºä¹‹åï¼Œä»æœºåªèƒ½è¯»ï¼Œä¸å¯å†™ï¼Œä¸èƒ½ä¿è¯é«˜å¯ç”¨ã€‚redisé›†ç¾¤æŠ€æœ¯æ˜¯æ„å»ºé«˜æ€§èƒ½ç½‘ç«™æ¶æ„çš„é‡è¦æ‰‹æ®µï¼Œè¯•æƒ³åœ¨ç½‘ç«™æ‰¿å—é«˜å¹¶å‘è®¿é—®å‹åŠ›çš„åŒæ—¶ï¼Œè¿˜éœ€è¦ä»æµ·é‡æ•°æ®ä¸­æŸ¥è¯¢å‡ºæ»¡è¶³æ¡ä»¶çš„æ•°æ®ï¼Œå¹¶å¿«é€Ÿå“åº”ï¼Œæˆ‘ä»¬å¿…ç„¶æƒ³åˆ°çš„æ˜¯å°†æ•°æ®è¿›è¡Œåˆ‡ç‰‡ï¼ŒæŠŠæ•°æ®æ ¹æ®æŸç§è§„åˆ™æ”¾å…¥å¤šä¸ªä¸åŒçš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œæ¥é™ä½å•èŠ‚ç‚¹æœåŠ¡å™¨çš„å‹åŠ›ã€‚ Redis Clusteré‡‡ç”¨æ— ä¸­å¿ƒç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜æ•°æ®å’Œæ•´ä¸ªé›†ç¾¤çŠ¶æ€,æ¯ä¸ªèŠ‚ç‚¹éƒ½å’Œå…¶ä»–æ‰€æœ‰èŠ‚ç‚¹è¿æ¥ã€‚èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨gossipåè®®ä¼ æ’­ä¿¡æ¯ä»¥åŠå‘ç°æ–°èŠ‚ç‚¹ã€‚ Redis é›†ç¾¤æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ï¼ˆdistributedï¼‰ã€å®¹é”™ï¼ˆfault-tolerantï¼‰çš„ Redis å®ç°ï¼Œé›†ç¾¤å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½æ˜¯æ™®é€šå•æœº Redis æ‰€èƒ½ä½¿ç”¨çš„åŠŸèƒ½çš„ä¸€ä¸ªå­é›†ï¼ˆsubsetï¼‰ã€‚ Redis é›†ç¾¤ä¸­ä¸å­˜åœ¨ä¸­å¿ƒï¼ˆcentralï¼‰èŠ‚ç‚¹æˆ–è€…ä»£ç†ï¼ˆproxyï¼‰èŠ‚ç‚¹ï¼Œé›†ç¾¤çš„å…¶ä¸­ä¸€ä¸ªä¸»è¦è®¾è®¡ç›®æ ‡æ˜¯è¾¾åˆ°çº¿æ€§å¯æ‰©å±•æ€§ï¼ˆlinear scalabilityï¼‰ã€‚ Redis é›†ç¾¤ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰è€Œç‰ºç‰²äº†ä¸€éƒ¨åˆ†å®¹é”™æ€§ï¼šç³»ç»Ÿä¼šåœ¨ä¿è¯å¯¹ç½‘ç»œæ–­çº¿ï¼ˆnet splitï¼‰å’ŒèŠ‚ç‚¹å¤±æ•ˆï¼ˆnode failureï¼‰å…·æœ‰æœ‰é™ï¼ˆlimitedï¼‰æŠµæŠ—åŠ›çš„å‰æä¸‹ï¼Œå°½å¯èƒ½åœ°ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚ 4. å®‰è£…éƒ¨ç½²rediså®‰è£…è¾ƒä¸ºç®€å•ï¼Œå®˜ç½‘ä¸‹è½½å‹ç¼©åŒ…è§£å‹ã€‚é›†ç¾¤æ¨¡å¼éœ€è¦rubyçš„ç¼–è¯‘ç¯å¢ƒï¼Œé›†ç¾¤æœ€å°çš„é…ç½®ä¸º3å°masterï¼Œå°äº3åˆ™å¯åŠ¨é›†ç¾¤æŠ¥é”™ã€‚redisç‰ˆæœ¬ï¼š3.2.4 4.1 ä¸»ä»æ¨¡å¼æ‹“æ‰‘å›¾ ä¸»ä»æ¨¡å¼é‡‡ç”¨ä¸€ä¸»ä¸‰ä»ï¼Œä¸»ä»éƒ½é…ç½®authè®¤è¯ï¼Œè¯»å†™åˆ†ç¦»ã€‚ä¸»è¦å®éªŒçš„åŠ¨ä½œï¼š1ï¼‰å¤šä¸ªapp åŒæ—¶å†™ï¼Œæµ‹å®šå†™é€Ÿç‡ï¼›2ï¼‰å¤šä¸ªapp åŒæ—¶å†™ï¼ŒåŒæ—¶æœ‰è¯»çš„è¿›ç¨‹ï¼Œæµ‹å®šè¯»å†™é€Ÿç‡ï¼›3ï¼‰masterä¸»æœºå®•æœºï¼Œappä¾ç„¶è¿›è¡Œè¯»å†™ã€‚ 4.2 clusteræ‹“æ‰‘å›¾å¦‚ä¸‹ é›†ç¾¤æ¨¡å¼é‡‡ç”¨å››ä¸»å››ä»ï¼Œä¹Ÿæ˜¯é‡‡ç”¨è¯»å†™åˆ†ç¦»ã€‚ä¸»è¦å®éªŒçš„åŠ¨ä½œï¼š1ï¼‰æœ‰ä¸€ä¸ªmasterå®•æœºï¼Œè§‚å¯Ÿæ—¥å¿—ï¼Œæ–°çš„slaveæˆä¸ºmasterï¼›2ï¼‰masterå®•æœºåï¼Œé‡æ–°å¯åŠ¨ï¼Œmasteræˆä¸ºslaveï¼›3ï¼‰é›†ç¾¤å…¨éƒ¨å®•æœºï¼Œredisä¸»æœºé‡å¯ï¼Œæ•°æ®æœªä¸¢å¤±ã€‚ 5. åŸç†5.1 ä¸€è‡´æ€§filesnapshot:é»˜è®¤redisæ˜¯ä¼šä»¥å¿«ç…§çš„å½¢å¼å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜,åœ¨é…ç½®æ–‡ä»¶ä¸­çš„æ ¼å¼æ˜¯ï¼šsave N Mè¡¨ç¤ºåœ¨Nç§’ä¹‹å†…ï¼Œredisè‡³å°‘å‘ç”ŸMæ¬¡ä¿®æ”¹åˆ™redisæŠ“å¿«ç…§åˆ°ç£ç›˜ã€‚ å·¥ä½œåŸç†ï¼šå½“rediséœ€è¦åšæŒä¹…åŒ–æ—¶ï¼Œredisä¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼›å­è¿›ç¨‹å°†æ•°æ®å†™åˆ°ç£ç›˜ä¸Šä¸€ä¸ªä¸´æ—¶RDBæ–‡ä»¶ä¸­ï¼›å½“å­è¿›ç¨‹å®Œæˆå†™ä¸´æ—¶æ–‡ä»¶åï¼Œå°†åŸæ¥çš„RDBæ›¿æ¢æ‰ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯å¯ä»¥copy-on-writeã€‚ Append-onlyï¼šfilesnapshottingæ–¹æ³•åœ¨rediså¼‚å¸¸æ­»æ‰æ—¶ï¼Œ æœ€è¿‘çš„æ•°æ®ä¼šä¸¢å¤±ï¼ˆä¸¢å¤±æ•°æ®çš„å¤šå°‘è§†ä½ saveç­–ç•¥çš„é…ç½®ï¼‰ï¼Œæ‰€ä»¥è¿™æ˜¯å®ƒæœ€å¤§çš„ç¼ºç‚¹ï¼Œå½“ä¸šåŠ¡é‡å¾ˆå¤§æ—¶ï¼Œä¸¢å¤±çš„æ•°æ®æ˜¯å¾ˆå¤šçš„ã€‚Append-onlyæ–¹æ³•å¯ ä»¥åšåˆ°å…¨éƒ¨æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†redisçš„æ€§èƒ½å°±è¦å·®äº›ã€‚AOFå°±å¯ä»¥åšåˆ°å…¨ç¨‹æŒä¹…åŒ–ï¼Œåªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ï¼ˆé»˜è®¤æ˜¯noï¼‰ï¼Œappendonly yeså¼€å¯AOFä¹‹åï¼Œredisæ¯æ‰§è¡Œä¸€ä¸ªä¿®æ”¹æ•°æ®çš„å‘½ä»¤ï¼Œéƒ½ä¼šæŠŠå®ƒæ·»åŠ åˆ°aofæ–‡ä»¶ä¸­ï¼Œå½“redisé‡å¯æ—¶ï¼Œå°†ä¼šè¯»å–AOFæ–‡ä»¶è¿›è¡Œâ€œé‡æ”¾â€ä»¥æ¢å¤åˆ° rediså…³é—­å‰çš„æœ€åæ—¶åˆ»ã€‚ AOFæ–‡ä»¶åˆ·æ–°çš„æ–¹å¼ï¼Œæœ‰ä¸‰ç§ï¼Œå‚è€ƒé…ç½®å‚æ•°appendfsync ï¼š appendfsync alwaysæ¯æäº¤ä¸€ä¸ªä¿®æ”¹å‘½ä»¤éƒ½è°ƒç”¨fsyncåˆ·æ–°åˆ°AOFæ–‡ä»¶ï¼Œéå¸¸éå¸¸æ…¢ï¼Œä½†ä¹Ÿéå¸¸å®‰å…¨ï¼› appendfsync everysecæ¯ç§’é’Ÿéƒ½è°ƒç”¨fsyncåˆ·æ–°åˆ°AOFæ–‡ä»¶ï¼Œå¾ˆå¿«ï¼Œä½†å¯èƒ½ä¼šä¸¢å¤±ä¸€ç§’ä»¥å†…çš„æ•°æ®ï¼› appendfsync noä¾é OSè¿›è¡Œåˆ·æ–°ï¼Œredisä¸ä¸»åŠ¨åˆ·æ–°AOFï¼Œè¿™æ ·æœ€å¿«ï¼Œä½†å®‰å…¨æ€§å°±å·®ã€‚é»˜è®¤å¹¶æ¨èæ¯ç§’åˆ·æ–°ï¼Œè¿™æ ·åœ¨é€Ÿåº¦å’Œå®‰å…¨ä¸Šéƒ½åšåˆ°äº†å…¼é¡¾ã€‚ SlaveåŒæ ·å¯ä»¥æ¥å—å…¶å®ƒSlavesçš„è¿æ¥å’ŒåŒæ­¥è¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆçš„åˆ†è½½Masterçš„åŒæ­¥å‹åŠ›ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å°†Redisçš„Replicationæ¶æ„è§†ä¸ºå›¾ç»“æ„ã€‚ Master Serveræ˜¯ä»¥éé˜»å¡çš„æ–¹å¼ä¸ºSlavesæä¾›æœåŠ¡ã€‚æ‰€ä»¥åœ¨Master-SlaveåŒæ­¥æœŸé—´ï¼Œå®¢æˆ·ç«¯ä»ç„¶å¯ä»¥æäº¤æŸ¥è¯¢æˆ–ä¿®æ”¹è¯·æ±‚ã€‚ Slave ServeråŒæ ·æ˜¯ä»¥éé˜»å¡çš„æ–¹å¼å®Œæˆæ•°æ®åŒæ­¥ã€‚åœ¨åŒæ­¥æœŸé—´ï¼Œå¦‚æœæœ‰å®¢æˆ·ç«¯æäº¤æŸ¥è¯¢è¯·æ±‚ï¼ŒRedisåˆ™è¿”å›åŒæ­¥ä¹‹å‰çš„æ•°æ®ã€‚ ä¸ºäº†åˆ†è½½Masterçš„è¯»æ“ä½œå‹åŠ›ï¼ŒSlaveæœåŠ¡å™¨å¯ä»¥ä¸ºå®¢æˆ·ç«¯æä¾›åªè¯»æ“ä½œçš„æœåŠ¡ï¼Œå†™æœåŠ¡ä»ç„¶å¿…é¡»ç”±Masteræ¥å®Œæˆã€‚å³ä¾¿å¦‚æ­¤ï¼Œç³»ç»Ÿçš„ä¼¸ç¼©æ€§è¿˜æ˜¯å¾—åˆ°äº†å¾ˆå¤§çš„æé«˜ã€‚ Masterå¯ä»¥å°†æ•°æ®ä¿å­˜æ“ä½œäº¤ç»™Slaveså®Œæˆï¼Œä»è€Œé¿å…äº†åœ¨Masterä¸­è¦æœ‰ç‹¬ç«‹çš„è¿›ç¨‹æ¥å®Œæˆæ­¤æ“ä½œã€‚Redisåœ¨masteræ˜¯éé˜»å¡æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨slaveæ‰§è¡Œæ•°æ®åŒæ­¥çš„æ—¶å€™ï¼Œmasteræ˜¯å¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚çš„ï¼Œå¹¶ä¸å½±å“åŒæ­¥æ•°æ®çš„ä¸€è‡´æ€§ï¼Œç„¶è€Œåœ¨slaveç«¯æ˜¯é˜»å¡æ¨¡å¼çš„ï¼Œslaveåœ¨åŒæ­¥masteræ•°æ®æ—¶ï¼Œå¹¶ä¸èƒ½å¤Ÿå“åº”å®¢æˆ·ç«¯çš„æŸ¥è¯¢ã€‚ 5.2 Replicationçš„å·¥ä½œåŸç†(1)SlaveæœåŠ¡å™¨è¿æ¥åˆ°MasteræœåŠ¡å™¨ã€‚(2)SlaveæœåŠ¡å™¨å‘é€SYCNå‘½ä»¤ã€‚(3)MasteræœåŠ¡å™¨å¤‡ä»½æ•°æ®åº“åˆ°.rdbæ–‡ä»¶ã€‚(4)MasteræœåŠ¡å™¨æŠŠ.rdbæ–‡ä»¶ä¼ è¾“ç»™SlaveæœåŠ¡å™¨ã€‚(5)SlaveæœåŠ¡å™¨æŠŠ.rdbæ–‡ä»¶æ•°æ®å¯¼å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ åœ¨Slaveå¯åŠ¨å¹¶è¿æ¥åˆ°Masterä¹‹åï¼Œå®ƒå°†ä¸»åŠ¨å‘é€ä¸€ä¸ªSYNCå‘½ä»¤ã€‚æ­¤åMasterå°†å¯åŠ¨åå°å­˜ç›˜è¿›ç¨‹ï¼ŒåŒæ—¶æ”¶é›†æ‰€æœ‰æ¥æ”¶åˆ°çš„ç”¨äºä¿®æ”¹æ•°æ®é›† çš„å‘½ä»¤ï¼Œåœ¨åå°è¿›ç¨‹æ‰§è¡Œå®Œæ¯•åï¼ŒMasterå°†ä¼ é€æ•´ä¸ªæ•°æ®åº“æ–‡ä»¶åˆ°Slaveï¼Œä»¥å®Œæˆä¸€æ¬¡å®Œå…¨åŒæ­¥ã€‚è€ŒSlaveæœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°æ•°æ®åº“æ–‡ä»¶æ•°æ®ä¹‹åå°†å…¶ å­˜ç›˜å¹¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æ­¤åï¼ŒMasterç»§ç»­å°†æ‰€æœ‰å·²ç»æ”¶é›†åˆ°çš„ä¿®æ”¹å‘½ä»¤ï¼Œå’Œæ–°çš„ä¿®æ”¹å‘½ä»¤ä¾æ¬¡ä¼ é€ç»™Slavesï¼ŒSlaveå°†åœ¨æœ¬æ¬¡æ‰§è¡Œè¿™äº›æ•°æ®ä¿®æ”¹å‘½ä»¤ï¼Œä»è€Œè¾¾åˆ°æœ€ç»ˆçš„æ•°æ®åŒæ­¥ã€‚å¦‚æœMasterå’ŒSlaveä¹‹é—´çš„é“¾æ¥å‡ºç°æ–­è¿ç°è±¡ï¼ŒSlaveå¯ä»¥è‡ªåŠ¨é‡è¿Masterï¼Œä½†æ˜¯åœ¨è¿æ¥æˆåŠŸä¹‹åï¼Œä¸€æ¬¡å®Œå…¨åŒæ­¥å°†è¢«è‡ªåŠ¨æ‰§è¡Œã€‚ 5.3 ä¸€è‡´æ€§å“ˆå¸Œé›†ç¾¤è¦å®ç°çš„ç›®çš„æ˜¯è¦å°†ä¸åŒçš„ key åˆ†æ•£æ”¾ç½®åˆ°ä¸åŒçš„ redis èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè§„åˆ™æˆ–è€…ç®—æ³•ï¼Œé€šå¸¸çš„åšæ³•æ˜¯è·å– key çš„å“ˆå¸Œå€¼ï¼Œç„¶åæ ¹æ®èŠ‚ç‚¹æ•°æ¥æ±‚æ¨¡ï¼Œä½†è¿™ç§åšæ³•æœ‰å…¶æ˜æ˜¾çš„å¼Šç«¯ï¼Œå½“æˆ‘ä»¬éœ€è¦å¢åŠ æˆ–å‡å°‘ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šé€ æˆå¤§é‡çš„ key æ— æ³•å‘½ä¸­ï¼Œè¿™ç§æ¯”ä¾‹æ˜¯ç›¸å½“é«˜çš„ï¼Œæ‰€ä»¥å°±æœ‰äººæå‡ºäº†ä¸€è‡´æ€§å“ˆå¸Œçš„æ¦‚å¿µã€‚ä¸€è‡´æ€§å“ˆå¸Œæœ‰å››ä¸ªé‡è¦ç‰¹å¾ï¼š å‡è¡¡æ€§ï¼šä¹Ÿæœ‰äººæŠŠå®ƒå®šä¹‰ä¸ºå¹³è¡¡æ€§ï¼Œæ˜¯æŒ‡å“ˆå¸Œçš„ç»“æœèƒ½å¤Ÿå°½å¯èƒ½åˆ†å¸ƒåˆ°æ‰€æœ‰çš„èŠ‚ç‚¹ä¸­å»ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆçš„åˆ©ç”¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„èµ„æºã€‚ å•è°ƒæ€§ï¼šå¯¹äºå•è°ƒæ€§æœ‰å¾ˆå¤šç¿»è¯‘è®©æˆ‘éå¸¸çš„ä¸è§£ï¼Œè€Œæˆ‘æƒ³è¦çš„æ˜¯å½“èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶å“ˆå¸Œçš„ç»“æœåº”å°½å¯èƒ½çš„ä¿æŠ¤å·²åˆ†é…çš„å†…å®¹ä¸ä¼šè¢«é‡æ–°åˆ†æ´¾åˆ°æ–°çš„èŠ‚ç‚¹ã€‚ åˆ†æ•£æ€§å’Œè´Ÿè½½ï¼šè¿™ä¸¤ä¸ªå…¶å®æ˜¯å·®ä¸å¤šçš„æ„æ€ï¼Œå°±æ˜¯è¦æ±‚ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¯¹ key å“ˆå¸Œåº”å°½å¯èƒ½çš„é¿å…é‡å¤ã€‚ Redis é›†ç¾¤ä¸­å†…ç½®äº† 16384 ä¸ªå“ˆå¸Œæ§½ï¼Œå½“éœ€è¦åœ¨ Redis é›†ç¾¤ä¸­æ”¾ç½®ä¸€ä¸ª key-value æ—¶ï¼Œredis å…ˆå¯¹ key ä½¿ç”¨ crc16 ç®—æ³•ç®—å‡ºä¸€ä¸ªç»“æœï¼Œç„¶åæŠŠç»“æœå¯¹ 16384 æ±‚ä½™æ•°ï¼Œè¿™æ ·æ¯ä¸ª key éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç¼–å·åœ¨ 0-16383 ä¹‹é—´çš„å“ˆå¸Œæ§½ï¼Œredis ä¼šæ ¹æ®èŠ‚ç‚¹æ•°é‡å¤§è‡´å‡ç­‰çš„å°†å“ˆå¸Œæ§½æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚ ä½¿ç”¨å“ˆå¸Œæ§½çš„å¥½å¤„å°±åœ¨äºå¯ä»¥æ–¹ä¾¿çš„æ·»åŠ æˆ–ç§»é™¤èŠ‚ç‚¹ã€‚ å½“éœ€è¦å¢åŠ èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠå…¶ä»–èŠ‚ç‚¹çš„æŸäº›å“ˆå¸Œæ§½æŒªåˆ°æ–°èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼› å½“éœ€è¦ç§»é™¤èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠç§»é™¤èŠ‚ç‚¹ä¸Šçš„å“ˆå¸Œæ§½æŒªåˆ°å…¶ä»–èŠ‚ç‚¹å°±è¡Œäº†ï¼› å½“è®¾ç½®äº†ä¸»ä»å…³ç³»åï¼Œslave åœ¨ç¬¬ä¸€æ¬¡è¿æ¥æˆ–è€…é‡æ–°è¿æ¥ master æ—¶ï¼Œslave éƒ½ä¼šå‘é€ä¸€æ¡åŒæ­¥æŒ‡ä»¤ç»™ masterï¼› master æ¥åˆ°æŒ‡ä»¤åï¼Œå¼€å§‹å¯åŠ¨åå°ä¿å­˜è¿›ç¨‹ä¿å­˜æ•°æ®ï¼Œæ¥ç€æ”¶é›†æ‰€æœ‰çš„æ•°æ®ä¿®æ”¹æŒ‡ä»¤ã€‚åå°ä¿å­˜å®Œäº†ï¼Œmaster å°±æŠŠè¿™ä»½æ•°æ®å‘é€ç»™ slaveï¼Œslave å…ˆæŠŠæ•°æ®ä¿å­˜åˆ°ç£ç›˜ï¼Œç„¶åæŠŠå®ƒåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œmaster æ¥ç€å°±æŠŠæ”¶é›†çš„æ•°æ®ä¿®æ”¹æŒ‡ä»¤ä¸€è¡Œä¸€è¡Œçš„å‘ç»™ slaveï¼Œslave æ¥æ”¶åˆ°ä¹‹åé‡æ–°æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œè¿™æ ·å°±å®ç°äº†æ•°æ®åŒæ­¥ã€‚ slave åœ¨ä¸ master å¤±å»è”ç³»åï¼Œè‡ªåŠ¨çš„é‡æ–°è¿æ¥ã€‚å¦‚æœ master æ”¶åˆ°äº†å¤šä¸ª slave çš„åŒæ­¥è¯·æ±‚ï¼Œå®ƒä¼šæ‰§è¡Œå•ä¸ªåå°ä¿å­˜æ¥ä¸ºæ‰€æœ‰çš„ slave æœåŠ¡ã€‚ 5.4 èŠ‚ç‚¹å¤±æ•ˆæ£€æµ‹ä»¥ä¸‹æ˜¯èŠ‚ç‚¹å¤±æ•ˆæ£€æŸ¥çš„å®ç°æ–¹æ³•ï¼š å½“ä¸€ä¸ªèŠ‚ç‚¹å‘å¦ä¸€ä¸ªèŠ‚ç‚¹å‘é€ PING å‘½ä»¤ï¼Œä½†æ˜¯ç›®æ ‡èŠ‚ç‚¹æœªèƒ½åœ¨ç»™å®šçš„æ—¶é™å†…è¿”å› PING å‘½ä»¤çš„å›å¤æ—¶ï¼Œé‚£ä¹ˆå‘é€å‘½ä»¤çš„èŠ‚ç‚¹ä¼šå°†ç›®æ ‡èŠ‚ç‚¹æ ‡è®°ä¸ºPFAIL ï¼ˆpossible failureï¼Œå¯èƒ½å·²å¤±æ•ˆï¼‰ã€‚ ç­‰å¾… PING å‘½ä»¤å›å¤çš„æ—¶é™ç§°ä¸ºâ€œèŠ‚ç‚¹è¶…æ—¶æ—¶é™ï¼ˆnode timeoutï¼‰â€ï¼Œæ˜¯ä¸€ä¸ªèŠ‚ç‚¹é€‰é¡¹ï¼ˆnode-wise settingï¼‰ã€‚ æ¯æ¬¡å½“èŠ‚ç‚¹å¯¹å…¶ä»–èŠ‚ç‚¹å‘é€ PING å‘½ä»¤çš„æ—¶å€™ï¼Œå®ƒéƒ½ä¼šéšæœºåœ°å¹¿æ’­ä¸‰ä¸ªå®ƒæ‰€çŸ¥é“çš„èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é‡Œé¢çš„å…¶ä¸­ä¸€é¡¹å°±æ˜¯è¯´æ˜èŠ‚ç‚¹æ˜¯å¦å·²ç»è¢«æ ‡è®°ä¸º PFAIL æˆ–è€… FAIL ã€‚ å½“èŠ‚ç‚¹æ¥æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„ä¿¡æ¯æ—¶ï¼Œå®ƒä¼šè®°ä¸‹é‚£äº›è¢«å…¶ä»–èŠ‚ç‚¹æ ‡è®°ä¸ºå¤±æ•ˆçš„èŠ‚ç‚¹ã€‚è¿™ç§°ä¸ºå¤±æ•ˆæŠ¥å‘Šï¼ˆfailure reportï¼‰ã€‚ å¦‚æœèŠ‚ç‚¹å·²ç»å°†æŸä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º PFAIL ï¼Œå¹¶ä¸”æ ¹æ®èŠ‚ç‚¹æ‰€æ”¶åˆ°çš„å¤±æ•ˆæŠ¥å‘Šæ˜¾å¼ï¼Œé›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†å…¶ä»–ä¸»èŠ‚ç‚¹ä¹Ÿè®¤ä¸ºé‚£ä¸ªèŠ‚ç‚¹è¿›å…¥äº†å¤±æ•ˆçŠ¶æ€ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼šå°†é‚£ä¸ªå¤±æ•ˆèŠ‚ç‚¹çš„çŠ¶æ€æ ‡è®°ä¸º FAIL ã€‚ ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹è¢«æ ‡è®°ä¸º FAIL ï¼Œå…³äºè¿™ä¸ªèŠ‚ç‚¹å·²å¤±æ•ˆçš„ä¿¡æ¯å°±ä¼šè¢«å¹¿æ’­åˆ°æ•´ä¸ªé›†ç¾¤ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡ä¿¡æ¯çš„èŠ‚ç‚¹éƒ½ä¼šå°†å¤±æ•ˆèŠ‚ç‚¹æ ‡è®°ä¸º FAIL ã€‚ ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¦å°†å¦ä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸ºå¤±æ•ˆï¼Œå¿…é¡»å…ˆè¯¢é—®å…¶ä»–èŠ‚ç‚¹çš„æ„è§ï¼Œå¹¶ä¸”å¾—åˆ°å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹çš„åŒæ„æ‰è¡Œã€‚å› ä¸ºè¿‡æœŸçš„å¤±æ•ˆæŠ¥å‘Šä¼šè¢«ç§»é™¤ï¼Œæ‰€ä»¥ä¸»èŠ‚ç‚¹è¦å°†æŸä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º FAIL çš„è¯ï¼Œå¿…é¡»ä»¥æœ€è¿‘æ¥æ”¶åˆ°çš„å¤±æ•ˆæŠ¥å‘Šä½œä¸ºæ ¹æ®ã€‚åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸­ï¼ŒèŠ‚ç‚¹çš„ FAIL çŠ¶æ€ä¼šè¢«ç§»é™¤ï¼š å¦‚æœè¢«æ ‡è®°ä¸º FAIL çš„æ˜¯ä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªèŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œ FAIL æ ‡è®°å°±ä¼šè¢«ç§»é™¤ã€‚ä¿æŒï¼ˆretaningï¼‰ä»èŠ‚ç‚¹çš„ FAIL çŠ¶æ€æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå®ƒä¸å¤„ç†ä»»ä½•æ§½ï¼Œä¸€ä¸ªä»èŠ‚ç‚¹æ˜¯å¦å¤„äº FAIL çŠ¶æ€ï¼Œå†³å®šäº†è¿™ä¸ªä»èŠ‚ç‚¹åœ¨æœ‰éœ€è¦æ—¶èƒ½å¦è¢«æå‡ä¸ºä¸»èŠ‚ç‚¹ã€‚ å¦‚æœä¸€ä¸ªä¸»èŠ‚ç‚¹è¢«æ‰“ä¸Š FAIL æ ‡è®°ä¹‹åï¼Œç»è¿‡äº†èŠ‚ç‚¹è¶…æ—¶æ—¶é™çš„å››å€æ—¶é—´ï¼Œå†åŠ ä¸Šåç§’é’Ÿä¹‹åï¼Œé’ˆå¯¹è¿™ä¸ªä¸»èŠ‚ç‚¹çš„æ§½çš„æ•…éšœè½¬ç§»æ“ä½œä»æœªå®Œæˆï¼Œå¹¶ä¸”è¿™ä¸ªä¸»èŠ‚ç‚¹å·²ç»é‡æ–°ä¸Šçº¿çš„è¯ï¼Œé‚£ä¹ˆç§»é™¤å¯¹è¿™ä¸ªèŠ‚ç‚¹çš„ FAIL æ ‡è®°ã€‚ åœ¨ç¬¬äºŒç§æƒ…å†µä¸­ï¼Œå¦‚æœæ•…éšœè½¬ç§»æœªèƒ½é¡ºåˆ©å®Œæˆï¼Œå¹¶ä¸”ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿ï¼Œé‚£ä¹ˆé›†ç¾¤å°±ç»§ç»­ä½¿ç”¨åŸæ¥çš„ä¸»èŠ‚ç‚¹ï¼Œä»è€Œå…å»ç®¡ç†å‘˜ä»‹å…¥çš„å¿…è¦ã€‚ 5.5 ä»èŠ‚ç‚¹é€‰ä¸¾ä¸€æ—¦æŸä¸ªä¸»èŠ‚ç‚¹è¿›å…¥ FAIL çŠ¶æ€ï¼Œå¦‚æœè¿™ä¸ªä¸»èŠ‚ç‚¹æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»èŠ‚ç‚¹å­˜åœ¨ï¼Œé‚£ä¹ˆå…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹ä¼šè¢«å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè€Œå…¶ä»–ä»èŠ‚ç‚¹åˆ™ä¼šå¼€å§‹å¯¹è¿™ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ã€‚æ–°çš„ä¸»èŠ‚ç‚¹ç”±å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ä»èŠ‚ç‚¹ä¸­è‡ªè¡Œé€‰ä¸¾äº§ç”Ÿï¼Œä»¥ä¸‹æ˜¯é€‰ä¸¾çš„æ¡ä»¶ï¼š è¿™ä¸ªèŠ‚ç‚¹æ˜¯å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚ å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½æ•°é‡éç©ºã€‚ ä»èŠ‚ç‚¹çš„æ•°æ®è¢«è®¤ä¸ºæ˜¯å¯é çš„ï¼Œä¹Ÿå³æ˜¯ï¼Œä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„å¤åˆ¶è¿æ¥ï¼ˆreplication linkï¼‰çš„æ–­çº¿æ—¶é•¿ä¸èƒ½è¶…è¿‡èŠ‚ç‚¹è¶…æ—¶æ—¶é™ï¼ˆnode timeoutï¼‰ä¹˜ä»¥REDIS_CLUSTER_SLAVE_VALIDITY_MULT å¸¸é‡å¾—å‡ºçš„ç§¯ã€‚ å¦‚æœä¸€ä¸ªä»èŠ‚ç‚¹æ»¡è¶³äº†ä»¥ä¸Šçš„æ‰€æœ‰æ¡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªä»èŠ‚ç‚¹å°†å‘é›†ç¾¤ä¸­çš„å…¶ä»–ä¸»èŠ‚ç‚¹å‘é€æˆæƒè¯·æ±‚ï¼Œè¯¢é—®å®ƒä»¬ï¼Œæ˜¯å¦å…è®¸è‡ªå·±ï¼ˆä»èŠ‚ç‚¹ï¼‰å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚å¦‚æœå‘é€æˆæƒè¯·æ±‚çš„ä»èŠ‚ç‚¹æ»¡è¶³ä»¥ä¸‹å±æ€§ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å°†å‘ä»èŠ‚ç‚¹è¿”å› FAILOVER_AUTH_GRANTED æˆæƒï¼ŒåŒæ„ä»èŠ‚ç‚¹çš„å‡çº§è¦æ±‚ï¼š å‘é€æˆæƒè¯·æ±‚çš„æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶ä¸”å®ƒæ‰€å±çš„ä¸»èŠ‚ç‚¹å¤„äº FAIL çŠ¶æ€ã€‚ åœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰ä»èŠ‚ç‚¹ä¸­ï¼Œè¿™ä¸ªä»èŠ‚ç‚¹çš„èŠ‚ç‚¹ ID åœ¨æ’åºä¸­æ˜¯æœ€å°çš„ã€‚ ä»èŠ‚ç‚¹å¤„äºæ­£å¸¸çš„è¿è¡ŒçŠ¶æ€ï¼šå®ƒæ²¡æœ‰è¢«æ ‡è®°ä¸º FAIL çŠ¶æ€ï¼Œä¹Ÿæ²¡æœ‰è¢«æ ‡è®°ä¸º PFAIL çŠ¶æ€ã€‚ ä¸€æ—¦æŸä¸ªä»èŠ‚ç‚¹åœ¨ç»™å®šçš„æ—¶é™å†…å¾—åˆ°å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹çš„æˆæƒï¼Œå®ƒå°±ä¼šå¼€å§‹æ‰§è¡Œä»¥ä¸‹æ•…éšœè½¬ç§»æ“ä½œï¼š é€šè¿‡ PONG æ•°æ®åŒ…ï¼ˆpacketï¼‰å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ç°åœ¨æ˜¯ä¸»èŠ‚ç‚¹äº†ã€‚ é€šè¿‡ PONG æ•°æ®åŒ…å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªå·²å‡çº§çš„ä»èŠ‚ç‚¹ï¼ˆpromoted slaveï¼‰ã€‚ æ¥ç®¡ï¼ˆclaimingï¼‰æ‰€æœ‰ç”±å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„å“ˆå¸Œæ§½ã€‚ æ˜¾å¼åœ°å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ä¸€ä¸ª PONG æ•°æ®åŒ…ï¼ŒåŠ é€Ÿå…¶ä»–èŠ‚ç‚¹è¯†åˆ«è¿™ä¸ªèŠ‚ç‚¹çš„è¿›åº¦ï¼Œè€Œä¸æ˜¯ç­‰å¾…å®šæ—¶çš„ PING / PONG æ•°æ®åŒ…ã€‚ æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹éƒ½ä¼šæ ¹æ®æ–°çš„ä¸»èŠ‚ç‚¹å¯¹é…ç½®è¿›è¡Œç›¸åº”çš„æ›´æ–°ï¼Œç‰¹åˆ«åœ°ï¼š a. æ‰€æœ‰è¢«æ–°çš„ä¸»èŠ‚ç‚¹æ¥ç®¡çš„æ§½ä¼šè¢«æ›´æ–°ã€‚ b. å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰ä»èŠ‚ç‚¹ä¼šå¯Ÿè§‰åˆ° PROMOTED æ ‡å¿—ï¼Œå¹¶å¼€å§‹å¯¹æ–°çš„ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ã€‚ c.å¦‚æœå·²ä¸‹çº¿çš„ä¸»èŠ‚ç‚¹é‡æ–°å›åˆ°ä¸Šçº¿çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä¼šå¯Ÿè§‰åˆ° PROMOTED æ ‡å¿—ï¼Œå¹¶å°†è‡ªèº«è°ƒæ•´ä¸ºç°ä»»ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ã€‚ åœ¨é›†ç¾¤çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¦‚æœä¸€ä¸ªå¸¦æœ‰ PROMOTED æ ‡è¯†çš„ä¸»èŠ‚ç‚¹å› ä¸ºæŸäº›åŸå› è½¬å˜æˆäº†ä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹å°†ä¸¢å¤±å®ƒæ‰€å¸¦æœ‰çš„ PROMOTED æ ‡è¯†ã€‚ 6. æ€»ç»“Redisé›†ç¾¤å…·æœ‰é«˜å¯ç”¨ï¼Œæ˜“äºè¿ç§»ï¼Œå­˜å–é€Ÿåº¦å¿«ç­‰ç‰¹ç‚¹ã€‚ä¹Ÿå¯ä»¥ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œæ”¯æŒpub/subæ¨¡å¼ï¼Œå…·ä½“ä¼˜ç¼ºç‚¹æ€»ç»“å¦‚ä¸‹ï¼šé¦–å…ˆä¼˜ç‚¹: redis åœ¨ä¸»èŠ‚ç‚¹ä¸‹çº¿åï¼Œä»èŠ‚ç‚¹ä¼šè‡ªåŠ¨æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œæä¾›æœåŠ¡ redis å®•æœºèŠ‚ç‚¹æ¢å¤åï¼Œè‡ªåŠ¨ä¼šæ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œå˜æˆä»èŠ‚ç‚¹ åŠ¨æ€æ‰©å±•å’Œåˆ é™¤èŠ‚ç‚¹ï¼Œrehash slotçš„åˆ†é…ï¼ŒåŸºäºæ¡¶çš„æ•°æ®åˆ†å¸ƒæ–¹å¼å¤§å¤§é™ä½äº†è¿ç§»æˆæœ¬ï¼Œåªéœ€å°†æ•°æ®æ¡¶ä»ä¸€ä¸ªRedis Nodeè¿ç§»åˆ°å¦ä¸€ä¸ªRedis Nodeå³å¯å®Œæˆè¿ç§»ã€‚ Redis Clusterä½¿ç”¨å¼‚æ­¥å¤åˆ¶ã€‚ å…¶ç¼ºç‚¹ä¸º: ç”±äºredisçš„å¤åˆ¶ä½¿ç”¨å¼‚æ­¥æœºåˆ¶ï¼Œåœ¨è‡ªåŠ¨æ•…éšœè½¬ç§»çš„è¿‡ç¨‹ä¸­ï¼Œé›†ç¾¤å¯èƒ½ä¼šä¸¢å¤±å†™å‘½ä»¤ã€‚ç„¶è€Œ redis å‡ ä¹æ˜¯åŒæ—¶æ‰§è¡Œ(å°†å‘½ä»¤æ¢å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä»¥åŠå°†å‘½ä»¤å¤åˆ¶åˆ°ä»èŠ‚ç‚¹)è¿™ä¸¤ä¸ªæ“ä½œï¼Œæ‰€ä»¥å®é™…ä¸­ï¼Œå‘½ä»¤ä¸¢å¤±çš„çª—å£éå¸¸å°ã€‚ æ™®é€šçš„ä¸»ä»æ¨¡å¼æ”¯æŒauthåŠ å¯†è®¤è¯ï¼Œè™½ç„¶æ¯”è¾ƒå¼±ï¼Œä½†å†™æˆ–è€…è¯»éƒ½è¦é€šè¿‡å¯†ç éªŒè¯ï¼Œclusterå¯¹å¯†ç æ”¯æŒä¸å¤ªå‹å¥½ï¼Œå¦‚æœå¯¹é›†ç¾¤è®¾ç½®å¯†ç ï¼Œé‚£ä¹ˆrequirepasså’Œmasterauthéƒ½éœ€è¦è®¾ç½®ï¼Œå¦åˆ™å‘ç”Ÿä¸»ä»åˆ‡æ¢æ—¶ï¼Œå°±ä¼šé‡åˆ°æˆæƒé—®é¢˜ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¹¶è§‚å¯Ÿæ—¥å¿—ã€‚ å‚è€ƒèµ„æ–™ï¼š www.redis.io redis-clusterç ”ç©¶å’Œä½¿ç”¨ Redis Cluster 3.0æ­å»ºä¸ä½¿ç”¨]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>mq</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”±Consulè°ˆåˆ°Raft]]></title>
    <url>%2F2017%2F09%2F25%2Fraft%2F</url>
    <content type="text"><![CDATA[åœ¨å‰ä¸€ç¯‡æ–‡ç« consulé…ç½®ä¸å®æˆ˜ä¸­ï¼Œä»‹ç»äº†consulçš„ä¸€äº›å†…å¹•åŠconsulé…ç½®ç›¸å…³ï¼Œå¹¶å¯¹é¡¹ç›®ä¸­çš„ä¸€äº›å®é™…é…ç½®è¿›è¡Œå±•ç¤ºã€‚è¿™ç¯‡æ–‡ç« é‡ç‚¹ä»‹ç»consulä¸­æ‰€æ¶‰åŠåˆ°çš„ä¸€è‡´æ€§ç®—æ³•raftã€‚ 1. èƒŒæ™¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§æ˜¯ç›¸å½“é‡è¦çš„ï¼Œå³ä¸ºCAPç†è®ºä¸­çš„C(Consistency)ã€‚ä¸€è‡´æ€§åˆå¯ä»¥åˆ†ä¸ºå¼ºä¸€è‡´æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™ç¯‡æ–‡ç« é‡ç‚¹è®¨è®ºå¼ºä¸€è‡´æ€§ç®—æ³•raftã€‚ Lamportå‘è¡¨Paxosä¸€è‡´æ€§ç®—æ³•ä»90å¹´æå‡ºåˆ°ç°åœ¨å·²ç»æœ‰äºŒåå‡ å¹´äº†ï¼Œç›´åˆ°2006å¹´Googleçš„ä¸‰ç¯‡è®ºæ–‡åˆç°â€œäº‘â€çš„ç«¯å€ªï¼Œå…¶ä¸­çš„Chubby LockæœåŠ¡ä½¿ç”¨Paxosä½œä¸ºChubby Cellä¸­çš„ä¸€è‡´æ€§ç®—æ³•ï¼ŒPaxosçš„äººæ°”ä»æ­¤ä¸€è·¯ç‹‚é£™ã€‚è€ŒPaxosæµç¨‹å¤ªè¿‡äºç¹æ‚å®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œè™½ç„¶ç°åœ¨å¾ˆå¹¿æ³›ä½¿ç”¨çš„Zookeeperä¹Ÿæ˜¯åŸºäºPaxosç®—æ³•æ¥å®ç°ï¼Œä½†æ˜¯Zookeeperä½¿ç”¨çš„ZABï¼ˆZookeeper Atomic Broadcastï¼‰åè®®å¯¹Paxosè¿›è¡Œäº†å¾ˆå¤šçš„æ”¹è¿›ä¸ä¼˜åŒ–ï¼Œå¤æ‚æ€§æ˜¯åˆ¶çº¦ä»–å‘å±•çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚Raftçš„è®¾è®¡åˆè¡·å°±æ˜¯æ˜“äºç†è§£æ€§ã€‚ Raftæ˜¯æ–¯å¦ç¦çš„Diego Ongaroã€John Ousterhoutä¸¤ä¸ªäººä»¥æ˜“æ‡‚ï¼ˆUnderstandabilityï¼‰ä¸ºç›®æ ‡è®¾è®¡çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œåœ¨2013å¹´å‘å¸ƒäº†è®ºæ–‡ï¼šã€ŠIn Search of an Understandable Consensus Algorithmã€‹ ä»2013å¹´å‘å¸ƒåˆ°ç°åœ¨ä¸è¿‡åªæœ‰ä¸¤å¹´ï¼Œåˆ°ç°åœ¨å·²ç»æœ‰äº†åå¤šç§è¯­è¨€çš„Raftç®—æ³•å®ç°æ¡†æ¶ï¼Œè¾ƒä¸ºå‡ºåçš„æœ‰etcdã€‚ 2. Raftè¯¦è§£å¼ºè°ƒçš„æ˜¯æ˜“æ‡‚ï¼ˆUnderstandabilityï¼‰ï¼ŒRaftå’ŒPaxosä¸€æ ·åªè¦ä¿è¯n/2+1èŠ‚ç‚¹æ­£å¸¸å°±èƒ½å¤Ÿæä¾›æœåŠ¡ï¼›ä¼—æ‰€å‘¨çŸ¥ä½†é—®é¢˜è¾ƒä¸ºå¤æ‚æ—¶å¯ä»¥æŠŠé—®é¢˜åˆ†è§£ä¸ºå‡ ä¸ªå°é—®é¢˜æ¥å¤„ç†ï¼ŒRaftä¹Ÿä½¿ç”¨äº†åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³æŠŠç®—æ³•æµç¨‹åˆ†ä¸ºä¸‰ä¸ªå­é—®é¢˜ï¼šé€‰ä¸¾ï¼ˆLeader electionï¼‰ã€æ—¥å¿—å¤åˆ¶ï¼ˆLog replicationï¼‰ã€å®‰å…¨æ€§ï¼ˆSafetyï¼‰ä¸‰ä¸ªå­é—®é¢˜ã€‚ 2.1 raftåŸºæœ¬æ¦‚å¿µ states ä¸€ä¸ªrafté›†ç¾¤æ‹¥æœ‰å¤šä¸ªserverï¼Œé€šå¸¸ä¼šæœ‰5å°ï¼Œè¿™æ ·å¯ä»¥å…è®¸ç³»ç»Ÿä¸­ä¸¤å°serverå®•æœºã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„serveråªæœ‰å¦‚ä¸‹ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š Leaderï¼Œè´Ÿè´£Clientäº¤äº’å’Œlogå¤åˆ¶ï¼ŒåŒä¸€æ—¶åˆ»ç³»ç»Ÿä¸­æœ€å¤šå­˜åœ¨1ä¸ª Followerï¼Œè¢«åŠ¨å“åº”è¯·æ±‚RPCï¼Œä»ä¸ä¸»åŠ¨å‘èµ·è¯·æ±‚RPC Candidateï¼Œç”±Followerå‘Leaderè½¬æ¢çš„ä¸­é—´çŠ¶æ€ åœ¨æ­£å¸¸çš„æ“ä½œæµç¨‹ä¸­ï¼Œé›†ç¾¤ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªserverï¼Œå…¶ä»–æ‰€æœ‰çš„serveréƒ½æ˜¯followerã€‚followeræ˜¯è¢«åŠ¨çš„ï¼Œä»–ä»¬åªæ˜¯è¢«åŠ¨åœ°ç›¸åº”Candidateå’Œleaderçš„è¯·æ±‚ã€‚ã€‚leaderå¤„ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œfollowerè‡ªå·±ä¸å¤„ç†è€Œæ˜¯è½¬å‘ç»™leaderã€‚ç¬¬ä¸‰ç§çŠ¶æ€æ˜¯Candidateï¼Œç”¨æ¥é€‰ä¸¾ä¸€ä¸ªæ–°çš„leaderã€‚ Terms Raftå°†æ—¶é—´åˆ’åˆ†æˆä»»æ„çš„é•¿åº¦å‘¨æœŸã€‚Termså¯ä»¥ç†è§£ä¸ºé€»è¾‘å‘¨æœŸï¼Œç”¨è¿ç»­çš„æ•´æ•°è¡¨ç¤ºã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæ—¶é—´åŒæ­¥å¾ˆé‡è¦ï¼ŒåŒæ—¶æ˜¯ä¸€ä¸ªéš¾é¢˜ã€‚åœ¨Raftä¸­ä½¿ç”¨äº†ä¸€ä¸ªå¯ä»¥ç†è§£ä¸ºå‘¨æœŸï¼ˆä»»æœŸï¼‰çš„æ¦‚å¿µï¼Œç”¨Termä½œä¸ºä¸€ä¸ªå‘¨æœŸï¼Œæ¯ä¸ªTerméƒ½æ˜¯ä¸€ä¸ªè¿ç»­é€’å¢çš„ç¼–å·ï¼Œæ¯ä¸€è½®é€‰ä¸¾éƒ½æ˜¯ä¸€ä¸ªTermå‘¨æœŸï¼Œåœ¨ä¸€ä¸ªTermä¸­åªèƒ½äº§ç”Ÿä¸€ä¸ªLeaderã€‚ æ¯ä¸ªtermä¼´éšç€ä¸€æ¬¡electionï¼Œä¸€ä¸ªæˆ–å¤šä¸ªCandidateè¯•å›¾æˆä¸ºleaderï¼Œå¦‚ä¸Šå›¾çš„çŠ¶æ€è½¬æ¢ã€‚å¦‚æœæŸä¸ªCandidateèµ¢å¾—äº†è¿™æ¬¡electionï¼Œå®ƒå°†å‡çº§ä¸ºå‰©ä½™serverçš„leaderã€‚åœ¨æŸäº›electionçš„æƒ…å½¢ä¸­ï¼Œä¼šäº§ç”Ÿè€—ç¥¨ï¼ˆSplit Votesï¼‰çš„ç»“æœ ï¼Œå³æŠ•ç¥¨ç»“æœæ— æ•ˆï¼Œéšåä¸€æ¬¡æ–°çš„termå¼€å§‹ã€‚raftç¡®ä¿åœ¨æŸä¸ªtermè‡³å¤šæœ‰ä¸€ä¸ªleaderã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ—¶é—´è¢«åˆ’åˆ†æˆå¤šä¸ªtermsï¼Œæ¯ä¸ªterméšç€ä¸€æ¬¡electionã€‚electionå®Œæˆåï¼Œä¸€ä¸ªleaderèŠ‚ç‚¹ç®¡ç†æ•´ä¸ªé›†ç¾¤ï¼Œç›´è‡³è¿™ä¸ªtermç»“æŸã€‚æœ‰äº›electionå¤±è´¥äº†ï¼Œæœªèƒ½äº§ç”Ÿä¸€ä¸ªleaderã€‚ 2.2 Leader electionæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ä»¥followerå¯åŠ¨ã€‚ä¸€ä¸ªæœ€å°çš„ Raft é›†ç¾¤éœ€è¦ä¸‰ä¸ªå‚ä¸è€…ï¼Œè¿™æ ·æ‰å¯èƒ½æŠ•å‡ºå¤šæ•°ç¥¨ã€‚åˆå§‹çŠ¶æ€ éƒ½æ˜¯ Followerï¼Œç„¶åå‘èµ·é€‰ä¸¾è¿™æ—¶æœ‰ä¸‰ç§å¯èƒ½æƒ…å½¢å‘ç”Ÿã€‚å¦‚æœæ¯æ–¹éƒ½æŠ•ç»™äº†è‡ªå·±ï¼Œç»“æœæ²¡æœ‰ä»»ä½•ä¸€æ–¹è·å¾—å¤šæ•°ç¥¨ã€‚ä¹‹åæ¯ä¸ªå‚ä¸æ–¹éšæœºä¼‘æ¯ä¸€é˜µï¼ˆElection Timeoutï¼‰é‡æ–°å‘èµ·æŠ•ç¥¨ç›´åˆ°ä¸€æ–¹è·å¾—å¤šæ•°ç¥¨ã€‚è¿™é‡Œçš„å…³é”®å°±æ˜¯éšæœº timeoutï¼Œæœ€å…ˆä»timeoutä¸­æ¢å¤å‘èµ·æŠ•ç¥¨çš„ä¸€æ–¹å‘è¿˜åœ¨ timeout ä¸­çš„å¦å¤–ä¸¤æ–¹è¯·æ±‚æŠ•ç¥¨ï¼Œè¿™æ—¶å®ƒä»¬å°±åªèƒ½æŠ•ç»™å¯¹æ–¹äº†ï¼Œå¾ˆå¿«è¾¾æˆä¸€è‡´ã€‚Raftçš„é€‰ä¸¾ç”±å®šæ—¶å™¨æ¥è§¦å‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„é€‰ä¸¾å®šæ—¶å™¨æ—¶é—´éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¼€å§‹æ—¶çŠ¶æ€éƒ½ä¸ºFolloweræŸä¸ªèŠ‚ç‚¹å®šæ—¶å™¨è§¦å‘é€‰ä¸¾åTermé€’å¢ï¼ŒçŠ¶æ€ç”±Followerè½¬ä¸ºCandidateï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘èµ·RequestVote RPCè¯·æ±‚ï¼Œè¿™æ—¶å€™æœ‰ä¸‰ç§å¯èƒ½çš„æƒ…å†µå‘ç”Ÿï¼š 1.è¯¥RequestVoteè¯·æ±‚æ¥æ”¶åˆ°n/2+1ï¼ˆè¿‡åŠæ•°ï¼‰ä¸ªèŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œä»Candidateè½¬ä¸ºLeaderï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘é€heartBeatä»¥ä¿æŒLeaderçš„æ­£å¸¸è¿è½¬ã€‚ 2.åœ¨æ­¤æœŸé—´å¦‚æœæ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘é€è¿‡æ¥çš„AppendEntries RPCè¯·æ±‚ï¼Œå¦‚è¯¥èŠ‚ç‚¹çš„Termå¤§åˆ™å½“å‰èŠ‚ç‚¹è½¬ä¸ºFollowerï¼Œå¦åˆ™ä¿æŒCandidateæ‹’ç»è¯¥è¯·æ±‚ã€‚ 3.Election timeoutå‘ç”Ÿåˆ™Termé€’å¢ï¼Œé‡æ–°å‘èµ·é€‰ä¸¾ã€‚ åœ¨ä¸€ä¸ªTermæœŸé—´æ¯ä¸ªèŠ‚ç‚¹åªèƒ½æŠ•ç¥¨ä¸€æ¬¡ï¼Œæ‰€ä»¥å½“æœ‰å¤šä¸ªCandidateå­˜åœ¨æ—¶å°±ä¼šå‡ºç°æ¯ä¸ªCandidateå‘èµ·çš„é€‰ä¸¾éƒ½å­˜åœ¨æ¥æ”¶åˆ°çš„æŠ•ç¥¨æ•°éƒ½ä¸è¿‡åŠçš„é—®é¢˜ï¼Œè¿™æ—¶æ¯ä¸ªCandidateéƒ½å°†Termé€’å¢ã€é‡å¯å®šæ—¶å™¨å¹¶é‡æ–°å‘èµ·é€‰ä¸¾ï¼Œç”±äºæ¯ä¸ªèŠ‚ç‚¹ä¸­å®šæ—¶å™¨çš„æ—¶é—´éƒ½æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å°±ä¸ä¼šå¤šæ¬¡å­˜åœ¨æœ‰å¤šä¸ªCandidateåŒæ—¶å‘èµ·æŠ•ç¥¨çš„é—®é¢˜ã€‚ å¼•ç”¨ä¸€å¼ ç½‘ä¸Šçš„å›¾ç‰‡ï¼Œæ¯”è¾ƒå½¢è±¡ï¼Œå¦‚ä¸‹å›¾ã€‚ 2.3 Log replicationæ—¥å¿—å¤åˆ¶ä¸»è¦æ˜¯ç”¨äºä¿è¯èŠ‚ç‚¹çš„ä¸€è‡´æ€§ï¼Œè¿™é˜¶æ®µæ‰€åšçš„æ“ä½œä¹Ÿæ˜¯ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ä¸é«˜å¯ç”¨æ€§ï¼›å½“Leaderé€‰ä¸¾å‡ºæ¥åä¾¿å¼€å§‹è´Ÿè´£å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ‰€æœ‰äº‹åŠ¡ï¼ˆæ›´æ–°æ“ä½œï¼‰è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡Leaderå¤„ç†ï¼Œè¿™äº›äº‹åŠ¡è¯·æ±‚æˆ–è¯´æˆå‘½ä»¤ä¹Ÿå°±æ˜¯è¿™é‡Œè¯´çš„æ—¥å¿—ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“è¦ä¿è¯èŠ‚ç‚¹çš„ä¸€è‡´æ€§å°±è¦ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æŒ‰é¡ºåºæ‰§è¡Œç›¸åŒçš„æ“ä½œåºåˆ—ï¼Œæ—¥å¿—å¤åˆ¶ï¼ˆLog Replicationï¼‰å°±æ˜¯ä¸ºäº†ä¿è¯æ‰§è¡Œç›¸åŒçš„æ“ä½œåºåˆ—æ‰€åšçš„å·¥ä½œï¼›åœ¨Raftä¸­å½“æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ—¥å¿—ï¼ˆäº‹åŠ¡è¯·æ±‚ï¼‰åå…ˆæŠŠè¯¥æ—¥å¿—è¿½åŠ åˆ°æœ¬åœ°çš„Logä¸­ï¼Œç„¶åé€šè¿‡heartbeatæŠŠè¯¥EntryåŒæ­¥ç»™å…¶ä»–Followerï¼ŒFolloweræ¥æ”¶åˆ°æ—¥å¿—åè®°å½•æ—¥å¿—ç„¶åå‘Leaderå‘é€ACKï¼Œå½“Leaderæ”¶åˆ°å¤§å¤šæ•°ï¼ˆn/2+1ï¼‰Followerçš„ACKä¿¡æ¯åå°†è¯¥æ—¥å¿—è®¾ç½®ä¸ºå·²æäº¤å¹¶è¿½åŠ åˆ°æœ¬åœ°ç£ç›˜ä¸­ï¼Œé€šçŸ¥å®¢æˆ·ç«¯å¹¶åœ¨ä¸‹ä¸ªheartbeatä¸­Leaderå°†é€šçŸ¥æ‰€æœ‰çš„Followerå°†è¯¥æ—¥å¿—å­˜å‚¨åœ¨è‡ªå·±çš„æœ¬åœ°ç£ç›˜ä¸­ã€‚ ä¸Šå›¾ä¸­ï¼Œå½“leaderé€‰å‡ºæ¥ä¹‹åï¼Œfollowerçš„logsåœºæ™¯å¾ˆå¯èƒ½å‡ºç°åœ¨ä¸Šå›¾ä¸­ã€‚followeræœ‰å¯èƒ½ä¸¢å¤±entriesã€æœ‰æœªæäº¤çš„entriesã€æœ‰é¢å¤–çš„entriesç­‰ç­‰åœºæ™¯ã€‚Raftä¸­ï¼Œleaderé€šè¿‡å¼ºåˆ¶followerså¤åˆ¶è‡ªå·±çš„logsæ¥å¤„ç†ä¸ä¸€è‡´ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨followerä¸­logså†²çªçš„entrieså°†ä¼šè¢«leader logsä¸­çš„è¦†å†™ã€‚ 2.4 Safetyå®‰å…¨æ€§æ˜¯ç”¨äºä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æ‰§è¡Œç›¸åŒåºåˆ—çš„å®‰å…¨æœºåˆ¶ï¼Œå¦‚å½“æŸä¸ªFolloweråœ¨å½“å‰Leader commit Logæ—¶å˜å¾—ä¸å¯ç”¨äº†ï¼Œç¨åå¯èƒ½è¯¥Followeråˆä¼šå€é€‰ä¸¾ä¸ºLeaderï¼Œè¿™æ—¶æ–°Leaderå¯èƒ½ä¼šç”¨æ–°çš„Logè¦†ç›–å…ˆå‰å·²committedçš„Logï¼Œè¿™å°±æ˜¯å¯¼è‡´èŠ‚ç‚¹æ‰§è¡Œä¸åŒåºåˆ—ï¼›Safetyå°±æ˜¯ç”¨äºä¿è¯é€‰ä¸¾å‡ºæ¥çš„Leaderä¸€å®šåŒ…å«å…ˆå‰ commited Logçš„æœºåˆ¶ï¼› Election Safetyæ¯ä¸ªTermåªèƒ½é€‰ä¸¾å‡ºä¸€ä¸ªLeaderï¼Œå‡è®¾æŸä¸ªTermåŒæ—¶é€‰ä¸¾äº§ç”Ÿä¸¤ä¸ªLeaderAå’ŒLeaderBï¼Œæ ¹æ®é€‰ä¸¾è¿‡ç¨‹å®šä¹‰ï¼ŒAå’ŒBå¿…é¡»åŒæ—¶è·å¾—è¶…è¿‡åŠæ•°èŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œè‡³å°‘å­˜åœ¨èŠ‚ç‚¹NåŒæ—¶ç»™äºˆAå’ŒBæŠ•ç¥¨ï¼Œå› æ­¤çŸ›ç›¾ã€‚ Leader Completenessè¿™é‡Œæ‰€è¯´çš„å®Œæ•´æ€§æ˜¯æŒ‡Leaderæ—¥å¿—çš„å®Œæ•´æ€§ï¼Œå½“Logåœ¨Term1è¢«Commitåï¼Œé‚£ä¹ˆä»¥åTerm2ã€Term3â€¦ç­‰çš„Leaderå¿…é¡»åŒ…å«è¯¥Logï¼›Raftåœ¨é€‰ä¸¾é˜¶æ®µå°±ä½¿ç”¨Termçš„åˆ¤æ–­ç”¨äºä¿è¯å®Œæ•´æ€§ï¼šå½“è¯·æ±‚æŠ•ç¥¨çš„è¯¥Candidateçš„Termè¾ƒå¤§æˆ–Termç›¸åŒIndexæ›´å¤§åˆ™æŠ•ç¥¨ï¼Œå¦åˆ™æ‹’ç»è¯¥è¯·æ±‚ï¼› Leader Append-OnlyLeaderä»ä¸â€œé‡å†™â€æˆ–è€…â€œåˆ é™¤â€æœ¬åœ°Logï¼Œä»…ä»…â€œè¿½åŠ â€æœ¬åœ°Logã€‚Raftç®—æ³•ä¸­Leaderæƒå¨è‡³é«˜æ— ä¸Šï¼Œå½“Followerå’ŒLeaderäº§ç”Ÿåˆ†æ­§çš„æ—¶å€™ï¼Œæ°¸è¿œæ˜¯Leaderå»è¦†ç›–ä¿®æ­£Followerã€‚ Log Matchingå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ä¸Šçš„æ—¥å¿—é¡¹æ‹¥æœ‰ç›¸åŒçš„Indexå’ŒTermï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªèŠ‚ç‚¹[0, Index]èŒƒå›´å†…çš„Logå®Œå…¨ä¸€è‡´ã€‚ State Machine Safetyä¸€æ—¦æŸä¸ªserverå°†æŸä¸ªæ—¥å¿—é¡¹åº”ç”¨äºæœ¬åœ°çŠ¶æ€æœºï¼Œä»¥åæ‰€æœ‰serverå¯¹äºè¯¥åç§»éƒ½å°†åº”ç”¨ç›¸åŒæ—¥å¿—é¡¹ã€‚ 3. æ€»ç»“æœ¬æ–‡ä¸»è¦è®²è§£äº†Raftç®—æ³•çš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠç®—æ³•ä¸­æ¶‰åŠåˆ°çš„leaderé€‰ä¸¾ï¼Œæ—¥å¿—åŒæ­¥ï¼Œå®‰å…¨æ€§ã€‚Raftæ˜¯ä»¥æ˜“ç†è§£æ€§ä½œä¸ºå…¶è®¾è®¡çš„ä¸€ä¸ªç›®æ ‡ï¼Œå¯¹äºä¸€ä¸ªå­¦ä¹ çš„æ–°æ‰‹æ¥è¯´ï¼Œç¡®å®æ¯”Paxosæ˜“äºç†è§£å¾ˆå¤šã€‚è™½ç„¶ Raft çš„è®ºæ–‡æ¯” Paxos ç®€å•ç‰ˆè®ºæ–‡å®¹æ˜“è¯»ï¼Œè®ºæ–‡ä¾ç„¶æœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦æ·±åˆ»ä½“ä¼šä¸ç†è§£ï¼Œç¬”è€…ä¹Ÿè¿˜æ˜¯æäº†å¥½å‡ å¤©ã€‚ å‚è€ƒ Raft Animate Demo Raft Paper Raft Website Raft ä¸ºä»€ä¹ˆæ˜¯æ›´æ˜“ç†è§£çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³• Raftä¸€è‡´æ€§ç®—æ³•]]></content>
      <categories>
        <category>ç®—æ³•</category>
      </categories>
      <tags>
        <tag>consul</tag>
        <tag>Cluster</tag>
        <tag>Consensus</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[consulé…ç½®ä¸å®æˆ˜]]></title>
    <url>%2F2017%2F09%2F16%2Fconsul%2F</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡æåˆ°ï¼Œé¡¹ç›®ç”¨çš„åˆ†å¸ƒå¼æœåŠ¡å‘ç°ä¸æ³¨å†Œç»„ä»¶æ˜¯consulï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ¥è®²ä¸‹consulç»„ä»¶åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨ä»¥åŠç›¸å…³ä»‹ç»ã€‚æœ¬æ–‡ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºä¸»è¦å‚è€ƒconsulæ–‡æ¡£ã€‚ 1. consulä»‹ç»consulæ˜¯ä¸€ä¸ªæœåŠ¡ç®¡ç†è½¯ä»¶ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒä¸‹ï¼Œåˆ†å¸ƒå¼é«˜å¯ç”¨çš„ï¼ŒæœåŠ¡å‘ç°å’Œé…ç½®å…±äº«ã€‚ consulæ”¯æŒå¥åº·æ£€æŸ¥ï¼Œå…è®¸å­˜å‚¨é”®å€¼å¯¹ã€‚ ä¸€è‡´æ€§åè®®é‡‡ç”¨Raftç®—æ³•,ç”¨æ¥ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ã€‚ æˆå‘˜ç®¡ç†å’Œæ¶ˆæ¯å¹¿æ’­é‡‡ç”¨GOSSIPåè®®ï¼Œæ”¯æŒACLè®¿é—®æ§åˆ¶ã€‚ 1.1 æœåŠ¡æ³¨å†Œä¸å‘ç°æœåŠ¡æ³¨å†Œæ˜¯ä¸€ä¸ªæœåŠ¡å°†å…¶ä½ç½®ä¿¡æ¯åœ¨â€œä¸­å¿ƒæ³¨å†ŒèŠ‚ç‚¹â€æ³¨å†Œçš„è¿‡ç¨‹ã€‚è¯¥æœåŠ¡ä¸€èˆ¬ä¼šå°†å®ƒçš„ä¸»æœºIPåœ°å€ä»¥åŠç«¯å£å·è¿›è¡Œæ³¨å†Œï¼Œæœ‰æ—¶ä¹Ÿä¼šæœ‰æœåŠ¡è®¿é—®çš„è®¤è¯ä¿¡æ¯ï¼Œä½¿ç”¨åè®®ï¼Œç‰ˆæœ¬å·ï¼Œä»¥åŠå…³äºç¯å¢ƒçš„ä¸€äº›ç»†èŠ‚ä¿¡æ¯ã€‚è€ŒæœåŠ¡å‘ç°å¯ä»¥è®©ä¸€ä¸ªåº”ç”¨æˆ–è€…ç»„ä»¶å‘ç°å…¶è¿è¡Œç¯å¢ƒä»¥åŠå…¶å®ƒåº”ç”¨æˆ–ç»„ä»¶çš„ä¿¡æ¯ã€‚ç”¨æˆ·é…ç½®ä¸€ä¸ªæœåŠ¡å‘ç°å·¥å…·å°±å¯ä»¥å°†å®é™…å®¹å™¨è·Ÿè¿è¡Œé…ç½®åˆ†ç¦»å¼€ã€‚å¸¸è§é…ç½®ä¿¡æ¯åŒ…æ‹¬ï¼šipã€ç«¯å£å·ã€åç§°ç­‰ã€‚ åœ¨ä¼ ç»Ÿæƒ…å†µä¸‹ï¼Œå½“å‡ºç°æœåŠ¡å­˜åœ¨äºå¤šä¸ªä¸»æœºèŠ‚ç‚¹ä¸Šæ—¶ï¼Œéƒ½ä¼šä½¿ç”¨é™æ€é…ç½®çš„æ–¹æ³•æ¥å®ç°æœåŠ¡ä¿¡æ¯çš„æ³¨å†Œã€‚è€Œå½“åœ¨ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿé‡Œï¼Œéœ€è¦è¾ƒå¼ºçš„å¯æ‰©å±•æ€§æ—¶ï¼ŒæœåŠ¡è¢«é¢‘ç¹æ›¿æ¢æ—¶ï¼Œä¸ºé¿å…æœåŠ¡ä¸­æ–­ï¼ŒåŠ¨æ€çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°å°±å¾ˆé‡è¦ã€‚æœåŠ¡æ³¨å†Œä¸å‘ç°çš„ç»„ä»¶æœ‰å¾ˆå¤šï¼Œå¦‚Zookeeperã€Etcdç­‰ã€‚æ—¢å¯ç”¨äºæœåŠ¡é—´çš„åè°ƒï¼ŒåŒæ—¶åˆå¯ç”¨äºæœåŠ¡çš„æ³¨å†Œã€‚ 1.2 Consensus Protocol - Raft Consulä½¿ç”¨Consensusåè®®Raftæä¾›ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€‚æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»åœ¨consulä¸­çš„ä¸€è‡´æ€§ï¼Œåé¢ä¸“é—¨ä¸€ç¯‡å†™raftã€‚ é¦–å…ˆï¼ŒRaftæ˜¯ä¸€ç§åŸºäºPaxosçš„Consensusç®—æ³•ã€‚ç›¸æ¯”äºPaxosï¼ŒRaftè®¾è®¡é‡‡ç”¨äº†è¾ƒå°‘çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ˜¯ä¸€ç§æ›´ç®€å•ã€æ›´æ˜“äºç†è§£çš„ç®—æ³•ã€‚åªæœ‰ServerèŠ‚ç‚¹å‚ä¸Raftï¼Œä¸”æ˜¯peer setçš„ä¸€å‘˜ã€‚æ‰€æœ‰çš„ClientèŠ‚ç‚¹åªæ˜¯è½¬å‘è¯·æ±‚åˆ°Serverã€‚è¿™ç§è®¾è®¡çš„è€ƒè™‘æ˜¯ï¼Œå½“æ›´å¤šçš„æˆå‘˜åŠ å…¥åˆ°peer setä¸­æ—¶ï¼Œquorumçš„è§„æ¨¡ä¹Ÿä¼šå¢åŠ ã€‚å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜æ˜¯ç­‰å¾…quorumä¸ªèŠ‚ç‚¹log entryã€‚ å¯åŠ¨Consulæ—¶ï¼Œå•ä¸ªconsulèŠ‚ç‚¹éœ€è¦ä»¥bootstrapæ¨¡å¼è¿è¡Œï¼Œè¯¥æ¨¡å¼è¿è¡Œè‡ªæˆ‘é€‰ä¸¾ä¸ºleaderã€‚ä¸€æ—¦Leaderè¢«é€‰å‡ºæ¥ï¼Œå…¶ä»–Serverå¯ä»¥æ·»åŠ Peer setä¸­ï¼Œä¿æŒä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚æœ€ç»ˆä¸€äº›Serveræ·»åŠ åˆ°é›†ç¾¤ï¼Œbootstrapæ¨¡å¼éœ€è¦ç¦ç”¨ã€‚ å› ä¸ºæ‰€æœ‰Serveréƒ½æ˜¯Peer setä¸­çš„æˆå‘˜ï¼Œå®ƒä»¬éƒ½çŸ¥é“è°æ˜¯Leaderã€‚å½“ä¸€ä¸ªRPCè¯·æ±‚åˆ°è¾¾æŸä¸ªéLeader ServerèŠ‚ç‚¹ï¼Œè¯·æ±‚å°±ä¼šè¢«è½¬å‘åˆ°Leaderã€‚å¦‚æœRPCæ˜¯ä¸€ç§queryç±»å‹ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯åªè¯»çš„ï¼ŒLeaderä¼šåŸºäºFSMå½“å‰ç”Ÿæˆç›¸åº”çš„ç»“æœï¼Œå¦‚æœRPCæ˜¯ä¸€ç§transactionç±»å‹ï¼Œå³ä¿®æ”¹çŠ¶æ€ï¼ŒLeaderäº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®ï¼Œå¹¶åŸºäºRaftç®—æ³•è¿›è¡Œç®¡ç†ã€‚ä¸€æ—¦æ—¥å¿—æ¡ç›®åº”ç”¨äºæœ‰é™çŠ¶æ€æœºï¼Œtransactionå®Œæˆã€‚ ç”±äºRaftçš„replicationæ€§è´¨ï¼Œæ€§èƒ½å¯¹ç½‘ç»œå»¶è¿Ÿæ˜¯éå¸¸æ•æ„Ÿçš„ã€‚ä¸ºæ­¤ï¼Œæ¯ä¸ªæ•°æ®ä¸­å¿ƒé€‰æ‹©ç‹¬ç«‹çš„Leaderå’Œç»´æŠ¤ä¸€ä¸ªä¸å…³è”çš„peer setã€‚æ•°æ®æŒ‰ç…§æ•°æ®ä¸­å¿ƒè¿›è¡Œåˆ’åˆ†ï¼Œæ‰€ä»¥æ¯ä¸ªLeaderåªè´Ÿè´£åœ¨ç›¸åº”æ•°æ®ä¸­å¿ƒçš„æ•°æ®ã€‚å½“æ¥æ”¶åˆ°ä¸€ä¸ªè¿œç¨‹æ•°æ®ä¸­å¿ƒçš„è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ä¼šè¢«è½¬å‘åˆ°ç›¸åº”çš„Leaderã€‚è¿™ç§è®¾è®¡åœ¨ä¸ç‰ºç‰²ä¸€è‡´æ€§çš„æƒ…å†µå®ç°è¾ƒä½å»¶è¿Ÿäº¤æ˜“å’Œæ›´é«˜çš„å¯ç”¨æ€§ã€‚è™½ç„¶æ‰€æœ‰æ—¥å¿—å‰¯æœ¬çš„å†™å…¥éƒ½æ˜¯åŸºäºRaftï¼Œè¯»å–æ›´çµæ´»ã€‚ä½†ä¸ºäº†æ”¯æŒå¼€å‘äººå‘˜å¯èƒ½éœ€è¦çš„å„ç§æƒè¡¡ï¼ŒConsulæ”¯æŒ3ç§ä¸åŒçš„ä¸€è‡´æ€§æ¨¡å¼ã€‚ Defaultï¼ŒRafté‡‡ç”¨Leaderç§Ÿèµæ¨¡å¼ï¼Œæä¾›äº†ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œåœ¨è¯¥æ—¶é—´æ®µå†…ï¼ŒLeaderè§’è‰²æ˜¯ç¨³å®šçš„ã€‚ consistentï¼Œæ— æ¡ä»¶ä¸€è‡´æ€§ staleï¼Œè¿™ç§æ¨¡å¼å…è®¸åœ¨ä»»ä½•ServerèŠ‚ç‚¹æ‰§è¡Œè¯»å–æ“ä½œï¼Œæ— è®ºå®ƒæ˜¯ä¸æ˜¯Leaderã€‚ 1.3 Group Membership Protocol - GossipConsulä½¿ç”¨gossipåè®®ç®¡ç†æˆå‘˜å…³ç³»ã€å¹¿æ’­æ¶ˆæ¯åˆ°æ•´ä¸ªé›†ç¾¤ã€‚è¯¦æƒ…å¯å‚è€ƒSerf libraryã€‚ Consulåˆ©ç”¨ä¸¤ä¸ªä¸åŒçš„gossip poolã€‚å±€åŸŸç½‘(LAN Pool)å’Œå¹¿åŸŸç½‘(WAN Pool)ã€‚ æ¯ä¸ªConsulæ•°æ®ä¸­å¿ƒéƒ½æœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰æˆå‘˜ï¼ˆServerå’ŒClientï¼‰çš„LAN gossip poolã€‚LAN Poolæœ‰å¦‚ä¸‹å‡ ä¸ªç›®çš„ï¼š é¦–å…ˆï¼Œæˆå‘˜å…³ç³»å…è®¸Clientè‡ªåŠ¨å‘ç°ServerèŠ‚ç‚¹ï¼Œå‡å°‘æ‰€éœ€çš„é…ç½®é‡ã€‚ å…¶æ¬¡ï¼Œåˆ†å¸ƒå¼æ•…éšœæ£€æµ‹å…è®¸çš„æ•…éšœæ£€æµ‹çš„å·¥ä½œåœ¨æŸå‡ ä¸ªServerå‡ ç‚¹æ‰§è¡Œï¼Œè€Œä¸æ˜¯é›†ä¸­æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ä¸Šã€‚ æœ€åï¼Œgossipå…è®¸å¯é å’Œå¿«é€Ÿçš„äº‹ä»¶å¹¿æ’­ï¼Œå¦‚Leaderé€‰ä¸¾ã€‚ WAN Poolæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œæ— è®ºå±äºå“ªä¸€ä¸ªæ•°æ®ä¸­å¿ƒï¼Œæ‰€æœ‰Serveråº”è¯¥åŠ å…¥åˆ°WAN Poolã€‚ç”±WAN Poolæä¾›ä¼šå‘˜ä¿¡æ¯è®©Serverå¯èŠ‚ç”µæ‰§è¡Œè·¨æ•°æ®ä¸­å¿ƒçš„è¯·æ±‚ã€‚é›†æˆä¸­æ•…éšœæ£€æµ‹å…è®¸Consulå¦¥å–„å¤„ç†æ•´ä¸ªæ•°æ®ä¸­å¿ƒå¤±å»è¿æ¥ï¼Œæˆ–åœ¨è¿œç¨‹æ•°æ®ä¸­å¿ƒåªæ˜¯å•ä¸ªçš„ServerèŠ‚ç‚¹ã€‚æ‰€æœ‰è¿™äº›åŠŸèƒ½éƒ½æ˜¯é€šè¿‡åˆ©ç”¨Serfæä¾›ã€‚ä»ç”¨æˆ·è§’åº¦æ¥çœ‹ï¼Œå®ƒæ˜¯ä½œä¸ºä¸€ä¸ªåµŒå…¥å¼åº“æä¾›è¿™äº›åŠŸèƒ½ã€‚ä½†å…¶è¢«Consulå±è”½ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒã€‚ä½œä¸ºå¼€å‘äººå‘˜å¯ä»¥å»äº†è§£è¿™ä¸ªåº“æ˜¯å¦‚ä½•åˆ©ç”¨ã€‚ 1.4 Sessionä¼šè¯ä¸Šä¸€ç¯‡æ–‡ç« snowflakeå‡çº§ç‰ˆå…¨å±€idç”Ÿæˆä¸­ä½¿ç”¨åˆ°äº†consulçš„KVå­˜å‚¨ã€‚Consulæä¾›sessionä¼šè¯æœºåˆ¶ï¼Œå¯ä»¥ç”¨äºæ„å»ºåˆ†å¸ƒå¼é”ã€‚sessionå¯ä»¥ç»‘å®šåˆ°èŠ‚ç‚¹ã€å¥åº·æ£€æŸ¥ã€KVæ•°æ®ï¼Œç›®çš„æ˜¯æä¾›ç»†ç²’åº¦é”ã€‚KVå­˜å‚¨å’Œä¼šè¯çš„é›†æˆæ˜¯ä½¿ç”¨ä¼šè¯çš„ä¸»è¦åœºæ™¯ã€‚å¿…é¡»åœ¨ä½¿ç”¨ä¹‹å‰åˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œç„¶åä½¿ç”¨å®ƒçš„IDã€‚KV APIæ”¯æŒacquireå’Œreleaseæ“ä½œï¼Œacquireæ“ä½œç±»ä¼¼CASæ“ä½œï¼Œåªæœ‰å½“é”ç©ºé—²æ—¶æ‰ä¼šè¿”å›æˆåŠŸã€‚å½“æˆåŠŸæ—¶ï¼ŒæŸä¸ªnormalæ ‡è¯†ä¼šæ›´æ–°ï¼Œä¹Ÿä¼šé€’å¢LockIndexï¼Œå½“ç„¶ä¹Ÿä¼šæ›´æ–°sessionçš„ä¿¡æ¯ã€‚å¦‚æœåœ¨acquireæ“ä½œæ—¶ï¼Œä¸sessionç›¸å…³çš„é”å·²ç»æŒæœ‰ï¼Œé‚£ä¹ˆLockIndexå°±ä¸ä¼šé€’å¢ï¼Œä½†æ˜¯keyå€¼ä¼šæ›´æ–°ï¼Œè¿™å°±å…è®¸é”çš„å½“å‰æŒæœ‰è€…æ— éœ€é‡æ–°è·å¾—é”å°±å¯ä»¥æ›´æ–°keyçš„å†…å®¹ã€‚ ä¸€æ—¦è·å¾—é”ï¼Œæ‰€éœ€è¦ç»releaseæ“ä½œæ¥é‡Šæ”¾ï¼ˆä½¿ç”¨ç›¸åŒçš„sessionï¼‰ã€‚Releaseæ“ä½œä¹Ÿç±»ä¼¼äºCASæ“ä½œã€‚å¦‚æœç»™å®šçš„sessionæ— æ•ˆï¼Œé‚£ä¹ˆè¯·æ±‚ä¼šå¤±è´¥ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæ— éœ€ç»è¿‡sessionçš„åˆ›å»ºè€…ï¼Œlockä¹Ÿæ˜¯å¯ä»¥è¢«é‡Šæ”¾çš„ã€‚è¿™ç§è®¾è®¡æ˜¯å…è®¸æ“ä½œè€…å¹²é¢„æ¥ç»ˆæ­¢ä¼šè¯ï¼Œåœ¨éœ€è¦çš„æ—¶å€™ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œä¼šè¯æ— æ•ˆä¹Ÿå°†å¯¼è‡´æ‰€æœ‰è¢«æŒæœ‰çš„é”è¢«é‡Šæ”¾æˆ–åˆ é™¤ã€‚å½“é”è¢«é‡Šæ”¾æ—¶ï¼ŒLockIndexä¸ä¼šå˜åŒ–ï¼Œä½†æ˜¯sessionä¼šè¢«æ¸…ç©ºï¼Œå¹¶ä¸”ModifyIndexé€’å¢ã€‚è¿™äº›è¯­ä¹‰å…è®¸å…ƒç»„ï¼ˆKeyï¼ŒLockIndexï¼ŒSessionï¼‰ä½œä¸ºä¸€ä¸ªç‹¬ç‰¹çš„â€œåºåˆ—â€ã€‚è¿™ä¸ªåºåˆ—å¯ä»¥è¢«ä¼ é€’å’Œç”¨äºéªŒè¯è¯·æ±‚æ˜¯å¦å±äºå½“å‰çš„é”æŒæœ‰è€…ã€‚å› ä¸ºæ¯æ¬¡acquire éƒ½ä¼šå¯¼è‡´LockIndexé€’å¢ï¼Œå³ä½¿åŒä¸€ä¼šè¯ä¸­é‡æ–°è·å–é”ï¼Œè¯¥åºåˆ—èƒ½å¤Ÿæ£€æµ‹åˆ°é™ˆæ—§çš„è¯·æ±‚ã€‚åŒæ ·ï¼Œå¦‚æœä¼šè¯å¤±æ•ˆï¼Œç›¸åº”çš„LockIndexå°†ä¸ºç©ºã€‚è¦æ¸…æ¥šçš„æ˜¯ï¼Œè¿™ç§é”ç³»ç»Ÿæ˜¯çº¯ç²¹çš„å’¨è¯¢ã€‚å¹¶ä¸æ˜¯å¼ºåˆ¶Clientå¿…é¡»è·å–é”å†èƒ½æ‰§è¡Œæ“ä½œä½œã€‚ä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥åœ¨æœªè·å¾—é”çš„æƒ…å†µä¸‹è¯»å–ã€å†™å…¥å’Œåˆ é™¤Keyæ“ä½œã€‚å®ƒä¸æ˜¯Consulç”¨äºä¿æŠ¤ç³»ç»Ÿçš„æ–¹æ³•ã€‚ 2. consulæ¶æ„ä¸Šé¢ä»‹ç»äº†consulçš„æŠ€æœ¯å†…å¹•ã€‚ç°åœ¨æ¥è®²è®²consulçš„æ¶æ„ã€‚ æ‹†è§£å¼€è¿™ä¸ªä½“ç³»ï¼Œä»æ¯ä¸€ä¸ªç»„ä»¶å¼€å§‹äº†è§£ã€‚é¦–å…ˆï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒï¼Œåˆ†åˆ«æ ‡è®°ä¸ºâ€œoneâ€å’Œâ€œtwoâ€ã€‚Consulæ˜¯æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒä¸€æµï¼Œå¹¶ä¸”æ˜¯å¸¸ç”¨ä¸šåŠ¡åœºæ™¯ã€‚ æ¯ä¸ªæ•°æ®ä¸­å¿ƒéƒ½æ˜¯ç”±Serverå’Œclientç»„æˆã€‚å»ºè®®æœ‰3~5å°Serverï¼ŒåŸºäºæ•…éšœå¤„ç†å’Œæ€§èƒ½çš„å¹³è¡¡ä¹‹ç­–ã€‚å¦‚æœå¢åŠ è¶Šå¤šçš„æœºå™¨ï¼Œåˆ™Consensusä¼šè¶Šæ¥è¶Šæ…¢ã€‚å¯¹clientæ²¡æœ‰é™åˆ¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•åˆ°æˆåƒä¸Šä¸‡æˆ–æ•°ä¸‡ã€‚åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦åŠ å…¥Gossipåè®®ã€‚è¿™æ„å‘³ç€gossip poolåŒ…å«ç»™å®šæ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰èŠ‚ç‚¹ã€‚æœ‰ä»¥ä¸‹ç›®çš„ï¼šé¦–å…ˆï¼Œæ²¡æœ‰å¿…è¦ä¸ºclienté…ç½®æœåŠ¡å™¨åœ°å€å‚æ•°ï¼›å‘ç°æ˜¯è‡ªåŠ¨å®Œæˆçš„ã€‚ç¬¬äºŒï¼ŒèŠ‚ç‚¹æ•…éšœæ£€æµ‹çš„å·¥ä½œä¸æ˜¯æ”¾ç½®åœ¨æœåŠ¡å™¨ä¸Šï¼Œè€Œæ˜¯åˆ†å¸ƒå¼çš„ã€‚è¿™ä½¿æ•…éšœæ£€æµ‹æ¯”å¿ƒè·³æœºåˆ¶æ›´å¯æ‰©å±•æ€§ã€‚ç¬¬ä¸‰ï¼Œå¯ç”¨æ¥ä½œä¸ºæ¶ˆæ¯å±‚é€šçŸ¥é‡è¦çš„äº‹ä»¶ï¼Œå¦‚leaderé€‰ä¸¾ã€‚ æ¯ä¸ªæ•°æ®ä¸­å¿ƒçš„æœåŠ¡å™¨éƒ½æ˜¯å±äºä¸€ä¸ªRaft peerã€‚è¿™æ„å‘³ç€ï¼Œä»–ä»¬ä¸€èµ·å·¥ä½œï¼Œé€‰å‡ºä¸€ä¸ªçš„Leaderï¼ŒLeader serveræ˜¯æœ‰é¢å¤–çš„èŒè´£ã€‚è´Ÿè´£å¤„ç†æ‰€æœ‰çš„æŸ¥è¯¢å’Œäº‹åŠ¡ã€‚äº‹åŠ¡ä¹Ÿå¿…é¡»é€šè¿‡Consensusåè®®å¤åˆ¶åˆ°æ‰€æœ‰çš„ä¼™ä¼´ã€‚ç”±äºè¿™ä¸€è¦æ±‚ï¼Œå½“éLeader Serveræ¥æ”¶åˆ°ä¸€ä¸ªRPCè¯·æ±‚ï¼Œä¼šè½¬å‘åˆ°é›†ç¾¤çš„leaderã€‚ ServerèŠ‚ç‚¹ä¹Ÿæ˜¯ä½œä¸ºWAN gossip poolçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªpoolæ˜¯ä¸LAN gossip poolæ˜¯ä¸åŒçš„ï¼Œå®ƒä¸ºå…·æœ‰æ›´é«˜å»¶è¿Ÿçš„ç½‘ç»œå“åº”åšäº†ä¼˜åŒ–ï¼Œå¹¶ä¸”å¯èƒ½åŒ…æ‹¬å…¶ä»–consulé›†ç¾¤çš„serverèŠ‚ç‚¹ã€‚è®¾è®¡WANpoolçš„ç›®çš„æ˜¯è®©æ•°æ®ä¸­å¿ƒèƒ½å¤Ÿä»¥low-touchçš„æ–¹å¼å‘ç°å½¼æ­¤ã€‚å°†ä¸€ä¸ªæ–°çš„æ•°æ®ä¸­å¿ƒåŠ å…¥ç°æœ‰çš„WAN Gossipæ˜¯å¾ˆå®¹æ˜“çš„ã€‚å› ä¸ºæ± ä¸­çš„æ‰€æœ‰Serveréƒ½æ˜¯å¯æ§åˆ¶çš„ï¼Œè¿™ä¹Ÿä½¿è·¨æ•°æ®ä¸­å¿ƒçš„è¦æ±‚ã€‚å½“ä¸€ä¸ªSerferæ¥æ”¶åˆ°ä¸åŒçš„æ•°æ®ä¸­å¿ƒçš„è¦æ±‚æ—¶ï¼Œå®ƒæŠŠè¿™ä¸ªè¯·æ±‚è½¬å‘ç»™ç›¸åº”æ•°æ®ä¸­å¿ƒçš„ä»»ä¸€Serverã€‚ç„¶åï¼Œæ¥æ”¶åˆ°è¯·æ±‚çš„Serverå¯èƒ½ä¼šè½¬å‘ç»™Leaderã€‚å¤šä¸ªæ•°æ®ä¸­å¿ƒä¹‹é—´æ˜¯ä½è€¦åˆï¼Œä½†ç”±äºæ•…éšœæ£€æµ‹ã€è¿æ¥ç¼“å­˜å¤ç”¨ã€è·¨æ•°æ®ä¸­å¿ƒè¦æ±‚å¿«é€Ÿå’Œå¯é çš„å“åº”ã€‚ 3. consuléƒ¨ç½²3.1 dockerå®‰è£…dockerå®‰è£…å¾ˆç®€å•ï¼Œç¬”è€…è¿™è¾¹æ˜¯åŸºäºdocker-composeçš„é…ç½®æ–‡ä»¶ï¼Œåªéœ€è¦æœ¬åœ°å®‰è£…å¥½dockerå’Œdocker-composeï¼Œdocker-compose.ymlå¦‚ä¸‹ï¼š 12345678version: '3'services: consul: image: consul ports: - "8500:8500" - "8600:8600" - "8300:8300" æ‹‰å–consulå¾—æœ€æ–°imageï¼Œè¿›è¡Œç«¯å£æ˜ å°„ï¼Œæš´éœ²å¯¹å¤–çš„ç«¯å£8500ï¼Œ8300. 3.2 è½¯ä»¶å®‰è£… ä»å®˜ç½‘ä¸‹è½½ç½ªè¡Œçš„consulå®‰è£…åŒ…ï¼Œhttps://www.consul.io/downloads.htmlã€‚ è§£å‹consul_0.6.4_darwin_amd64.zipã€‚ å°†è§£å‹åçš„äºŒè¿›åˆ¶æ–‡ä»¶consulæ‹·è´åˆ°/usr/local/binä¸‹ã€‚ å†™é…ç½®æ–‡ä»¶ã€‚æœåŠ¡æ³¨å†Œçš„é…ç½®æ–‡ä»¶å¦‚ä¸‹: 12345678910111213141516&#123; &quot;service&quot;: &#123; &quot;name&quot;: &quot;redis&quot;, &quot;tags&quot;: [&quot;master&quot;], &quot;address&quot;: &quot;1192.168.1.100&quot;, &quot;port&quot;: 8000, &quot;enableTagOverride&quot;: false, &quot;check&quot;: &#123; &quot;id&quot;: &quot;redis&quot;, &quot;name&quot;: &quot;redis on port 8000&quot;, &quot;tcp&quot;: &quot;localhost:8000&quot;, &quot;interval&quot;: &quot;10s&quot;, &quot;timeout&quot;: &quot;1s&quot; &#125; &#125;&#125; å¦‚ä¸Šé…ç½®æ³¨å†Œäº†Redisçš„8000ç«¯å£ï¼Œå¹¶å¸¦æœ‰tcpçš„health checkã€‚ èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ï¼š 12345678910111213141516&#123; "datacenter": "east-cn", "data_dir": "/opt/consul", "log_level": "INFO", "node_name": "redis", "server": true, "addresses": &#123; "https": "192.168.1.100" &#125;, "ports": &#123; "https": 0 &#125;, "ui": true, "retry-join": []&#125; å½“åŠ è½½é…ç½®é€‰é¡¹æ—¶ï¼Œconsulæ˜¯æŒ‰ç…§è¯å…¸é¡ºåºä»æ‰€æœ‰é…ç½®æ–‡ä»¶æˆ–ç›®å½•ä¸­åŠ è½½ã€‚æ¯”å¦‚ï¼Œa.jsonä¼šå…ˆäºe.jsonå¤„ç†ã€‚åé¢è®¾å®šçš„é…ç½®é€‰é¡¹ä¼šåˆå¹¶åˆ°å‰é¢çš„é…ç½®é›†åˆä¸­ï¼Œå¦‚æœå­˜åœ¨é‡å¤çš„é…ç½®é€‰é¡¹åˆ™ä¼šè¦†ç›–ã€‚å½“ç„¶ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚äº‹ä»¶å¤„ç†ç¨‹åºï¼Œåé¢å¤„ç†ç¨‹åºä¼šè¿½åŠ åˆ°ç°æœ‰çš„é…ç½®é€‰é¡¹ä¸­ï¼Œå½¢æˆäº‹ä»¶å¤„ç†ç¨‹åºåˆ—è¡¨ã€‚ 3.3 å¯åŠ¨å…·ä½“å¯åŠ¨æ–‡æ¡£è§configurationã€‚å¦‚: consul agent -server -config-dir /etc/consul.d -bind=192.168.1.100 -config-dir /etc/consul.d config-diréœ€è¦åŠ è½½çš„é…ç½®æ–‡ä»¶ç›®å½•ï¼Œconsulå°†åŠ è½½ç›®å½•ä¸‹æ‰€æœ‰åç¼€ä¸ºâ€œ.jsonâ€çš„æ–‡ä»¶ï¼ŒåŠ è½½é¡ºåºä¸ºå­—æ¯é¡ºåºï¼Œæ–‡ä»¶ä¸­é…ç½®é€‰é¡¹åˆå¹¶æ–¹å¼å¦‚config-fileã€‚è¯¥å‚æ•°å¯ä»¥å¤šæ¬¡é…ç½®ã€‚ç›®å½•ä¸­çš„å­ç›®å½•æ˜¯ä¸ä¼šåŠ è½½çš„ã€‚ data-diræ­¤ç›®å½•æ˜¯ä¸ºAgentå­˜æ”¾stateæ•°æ®çš„ã€‚æ˜¯æ‰€æœ‰Agentéœ€è¦çš„ï¼Œè¯¥ç›®å½•åº”è¯¥å­˜æ”¾åœ¨æŒä¹…å­˜å‚¨ä¸­ï¼ˆrebootä¸ä¼šä¸¢å¤±ï¼‰ï¼Œå¯¹äºserverè§’è‰²çš„Agentæ˜¯å¾ˆå…³é”®çš„,éœ€è¦è®°å½•é›†ç¾¤çŠ¶æ€ã€‚å¹¶ä¸”è¯¥ç›®å½•æ˜¯æ”¯æŒæ–‡ä»¶é”ã€‚ serverè®¾ç½®Agentæ˜¯serveræ¨¡å¼è¿˜æ˜¯clientæ¨¡å¼ã€‚Consul agentæœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼šServerå’ŒClientã€‚è¿™é‡Œçš„Serverå’ŒClientåªæ˜¯Consulé›†ç¾¤å±‚é¢çš„åŒºåˆ†ï¼Œä¸æ­å»ºåœ¨Clusterä¹‹ä¸Š çš„åº”ç”¨æœåŠ¡æ— å…³ã€‚Consule Serveræ¨¡å¼agentèŠ‚ç‚¹ç”¨äºé‡‡ç”¨raftç®—æ³•ç»´æŠ¤Consulé›†ç¾¤çš„çŠ¶æ€ï¼Œå®˜æ–¹å»ºè®®æ¯ä¸ªConsul Clusterè‡³å°‘æœ‰3ä¸ªæˆ–ä»¥ä¸Šçš„è¿è¡Œåœ¨Server modeçš„Agentï¼ŒClientèŠ‚ç‚¹ä¸é™ã€‚ å…¶ä»–å¸¸ç”¨çš„è¿˜æœ‰ï¼š clientå°†ç»‘å®šåˆ°clientæ¥å£çš„åœ°å€ï¼Œå¯ä»¥æ˜¯HTTPã€DNSã€RPCæœåŠ¡å™¨ã€‚é»˜è®¤ä¸ºâ€œ127.0.0.1â€ï¼Œåªå…è®¸å›è·¯è¿æ¥ã€‚RPCåœ°å€ä¼šè¢«å…¶ä»–çš„consulå‘½ä»¤ä½¿ç”¨ï¼Œæ¯”å¦‚consul membersï¼ŒæŸ¥è¯¢agentåˆ—è¡¨ nodeèŠ‚ç‚¹åœ¨é›†ç¾¤çš„åå­—ï¼Œåœ¨é›†ç¾¤ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚é»˜è®¤ä¸ºèŠ‚ç‚¹çš„Hostnameã€‚ bootstrapè®¾ç½®æœåŠ¡æ˜¯å¦ä¸ºâ€œbootstrapâ€æ¨¡å¼ã€‚å¦‚æœæ•°æ®ä¸­å¿ƒåªæœ‰1ä¸ªserver agentï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½®è¯¥å‚æ•°ã€‚ä»æŠ€æœ¯ä¸Šæ¥è®²ï¼Œå¤„äºbootstrapæ¨¡å¼çš„æœåŠ¡å™¨æ˜¯å¯ä»¥é€‰æ‹©è‡ªå·±ä½œä¸ºRaft Leaderçš„ã€‚åœ¨consulé›†ç¾¤ä¸­ï¼Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥é…ç½®è¯¥å‚æ•°ï¼Œå¦‚æœæœ‰å¤šä¸ªå‚æ•°é…ç½®è¯¥å‚æ•°ï¼Œé‚£ä¹ˆéš¾ä»¥ä¿è¯ä¸€è‡´æ€§ã€‚ bindç”¨äºé›†ç¾¤å†…éƒ¨é€šä¿¡çš„IPåœ°å€ï¼Œä¸é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹äº’è¿å¯é€šã€‚é»˜è®¤ä¸ºâ€œ0.0.0.0â€ï¼Œconsulå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„ç§æœ‰IPv4åœ°å€ã€‚å¦‚æœæŒ‡å®šâ€œ[::]â€ï¼Œconsulå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„å…¬å…±IPv6åœ°å€ã€‚ä½¿ç”¨TCPå’ŒUDPé€šä¿¡ã€‚æ³¨æ„é˜²ç«å¢™ï¼Œé¿å…æ— æ³•é€šä¿¡ã€‚ 3.4 ç»“æœåœ¨å¼€å¯äº†&quot;ui&quot;: trueserverä¸»æœºä¸Šï¼Œå¦‚http://192.168.1.100:8500/uiæŸ¥çœ‹æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ã€‚demo uiå¦‚ä¸‹ï¼š 4. æ€»ç»“æœ¬æ–‡ä»‹ç»äº†consulçš„ä¸€äº›å†…å¹•åŠconsulé…ç½®ç›¸å…³ï¼Œå¹¶å¯¹é¡¹ç›®ä¸­çš„ä¸€äº›å®é™…é…ç½®è¿›è¡Œå±•ç¤ºã€‚å¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¤§å®¶å¯¹consulç›¸å…³çš„çŸ¥è¯†æœ‰æ‰€äº†è§£ï¼Œå¹¶å¯¹äºå…¥é—¨é…ç½®consulå’Œå®é™…åº”ç”¨æœ‰æ‰€çŸ¥é“ã€‚ä¸ªäººè®¤ä¸ºï¼ŒconsulåŸç†è¿˜æ˜¯ç®€å•æ˜“æ‡‚çš„ï¼Œé›†ç¾¤çš„é…ç½®ä¹Ÿä¸å¤æ‚ï¼Œå®‰åˆ©å¤§å®¶ä½¿ç”¨ã€‚åé¢ä¼šå†å†™ä¸€ç¯‡ä»‹ç»Spring cloudä¸­é›†æˆå’Œä½¿ç”¨consulç»„ä»¶ä½œä¸ºæ³¨å†Œä¸å‘ç°ä¸­å¿ƒã€‚ å‚è€ƒæ–‡çŒ®consulæ–‡æ¡£consulä¸­æ–‡ç¿»è¯‘]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>consul</tag>
        <tag>cluster</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[snowflakeå‡çº§ç‰ˆå…¨å±€idç”Ÿæˆ]]></title>
    <url>%2F2017%2F09%2F09%2Fsnowflake%2F</url>
    <content type="text"><![CDATA[1. èƒŒæ™¯åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è€…å¾®æœåŠ¡æ¶æ„åŸºæœ¬éƒ½é‡‡ç”¨äº†åˆ†åº“åˆ†è¡¨çš„è®¾è®¡ï¼Œå…¨å±€å”¯ä¸€idç”Ÿæˆçš„éœ€æ±‚å˜å¾—å¾ˆè¿«åˆ‡ã€‚ä¼ ç»Ÿçš„å•ä½“åº”ç”¨ï¼Œä½¿ç”¨å•åº“ï¼Œæ•°æ®åº“ä¸­è‡ªå¢idå¯ä»¥å¾ˆæ–¹ä¾¿å®ç°ã€‚åˆ†åº“ä¹‹åï¼Œé¦–å…ˆéœ€è¦åˆ†åº“é”®ï¼Œåˆ†åº“é”®å¿…ç„¶ä¸èƒ½é‡å¤ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„åšæ³•å¹¶ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚æ¦‚æ‹¬ä¸‹æ¥ï¼Œé‚£ä¸šåŠ¡ç³»ç»Ÿå¯¹IDå·çš„è¦æ±‚æœ‰å“ªäº›å‘¢ï¼Ÿ 1.å…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½å‡ºç°é‡å¤çš„IDå·ï¼Œæ—¢ç„¶æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚2.è¶‹åŠ¿é€’å¢ï¼šåœ¨MySQL InnoDBå¼•æ“ä¸­ä½¿ç”¨çš„æ˜¯èšé›†ç´¢å¼•ï¼Œç”±äºå¤šæ•°RDBMSä½¿ç”¨B-treeçš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œåœ¨ä¸»é”®çš„é€‰æ‹©ä¸Šé¢æˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æœ‰åºçš„ä¸»é”®ä¿è¯å†™å…¥æ€§èƒ½ã€‚3.å•è°ƒé€’å¢ï¼šä¿è¯ä¸‹ä¸€ä¸ªIDä¸€å®šå¤§äºä¸Šä¸€ä¸ªIDï¼Œä¾‹å¦‚äº‹åŠ¡ç‰ˆæœ¬å·ã€IMå¢é‡æ¶ˆæ¯ã€æ’åºç­‰ç‰¹æ®Šéœ€æ±‚ã€‚4.ä¿¡æ¯å®‰å…¨ï¼šå¦‚æœIDæ˜¯è¿ç»­çš„ï¼Œæ¶æ„ç”¨æˆ·çš„æ‰’å–å·¥ä½œå°±éå¸¸å®¹æ˜“åšäº†ï¼Œç›´æ¥æŒ‰ç…§é¡ºåºä¸‹è½½æŒ‡å®šURLå³å¯ï¼›å¦‚æœæ˜¯è®¢å•å·å°±æ›´å±é™©äº†ï¼Œç«å¯¹å¯ä»¥ç›´æ¥çŸ¥é“æˆ‘ä»¬ä¸€å¤©çš„å•é‡ã€‚æ‰€ä»¥åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸‹ï¼Œä¼šéœ€è¦IDæ— è§„åˆ™ã€ä¸è§„åˆ™ã€‚ å…¶ä¸­ç¬¬3å’Œç¬¬4ç‚¹æ˜¯äº’æ–¥çš„ã€‚é™¤äº†åŠŸèƒ½æ€§éœ€æ±‚ï¼Œè¿˜æœ‰æ€§èƒ½å’Œå¯é æ€§çš„éœ€æ±‚ï¼š å¹³å‡å»¶è¿Ÿå’ŒTP999å»¶è¿Ÿéƒ½è¦å°½å¯èƒ½ä½ï¼› å¯ç”¨æ€§5ä¸ª9ï¼› é«˜QPSã€‚ 2. è¿›é˜¶å†ç¨‹è‡ªä»é¡¹ç›®ä»å•ä½“åº”ç”¨æ‹†åˆ†æˆå¾®æœåŠ¡æ¶æ„åï¼Œå¯¹å…¨å±€idéƒ¨åˆ†åšäº†äº›æ‘¸ç´¢ã€‚ 2.1 uuidåˆšå¼€å§‹æ‹†åˆ†ä¸šåŠ¡ï¼Œidä¸»é”®éƒ½æ˜¯ä½¿ç”¨uuidå­—ç¬¦ä¸²ã€‚UUID(Universally Unique Identifier)çš„æ ‡å‡†å‹å¼åŒ…å«32ä¸ª16è¿›åˆ¶æ•°å­—ï¼Œä»¥è¿å­—å·åˆ†ä¸ºäº”æ®µï¼Œå½¢å¼ä¸º8-4-4-4-12çš„36ä¸ªå­—ç¬¦ã€‚ç±»ä¼¼è¿™æ ·çš„å­—ç¬¦ä¸²ï¼šdc5adf0a-d531-11e5-95aa-3c15c2d22392ã€‚128ä½ï¼Œæ ¹æœ¬ä¸ç”¨æ‹…å¿ƒä¸å¤Ÿç”¨ã€‚ç”Ÿæˆçš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼š 1UUID userId = UUID.randomUUID(); uuidå…¨çƒå”¯ä¸€ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰ç½‘ç»œæ¶ˆè€—ï¼Œäº§ç”Ÿçš„æ€§èƒ½ç»å¯¹å¯ä»¥æ»¡è¶³ã€‚å…¶ç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ¯”è¾ƒå åœ°æ–¹ï¼Œå’ŒINTç±»å‹ç›¸æ¯”ï¼Œå­˜å‚¨ä¸€ä¸ªUUIDè¦èŠ±è´¹æ›´å¤šçš„ç©ºé—´ã€‚ä½¿ç”¨UUIDåï¼ŒURLæ˜¾å¾—å†—é•¿ï¼Œä¸å¤Ÿå‹å¥½ã€‚IDä½œä¸ºä¸»é”®æ—¶åœ¨ç‰¹å®šçš„ç¯å¢ƒä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚åšDBä¸»é”®çš„åœºæ™¯ä¸‹ï¼ŒUUIDå°±éå¸¸ä¸é€‚ç”¨ï¼š MySQLå®˜æ–¹æœ‰æ˜ç¡®çš„å»ºè®®ä¸»é”®è¦å°½é‡è¶ŠçŸ­è¶Šå¥½ï¼Œ36ä¸ªå­—ç¬¦é•¿åº¦çš„UUIDä¸ç¬¦åˆè¦æ±‚ã€‚ å¯¹MySQLç´¢å¼•ä¸åˆ©ï¼šå¦‚æœä½œä¸ºæ•°æ®åº“ä¸»é”®ï¼Œåœ¨InnoDBå¼•æ“ä¸‹ï¼ŒUUIDçš„æ— åºæ€§å¯èƒ½ä¼šå¼•èµ·æ•°æ®ä½ç½®é¢‘ç¹å˜åŠ¨ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚ 2.2 æ•°æ®åº“ç”Ÿæˆä»¥MySQLä¸¾ä¾‹ï¼Œåˆ©ç”¨ç»™å­—æ®µè®¾ç½®auto_increment_incrementå’Œauto_increment_offsetæ¥ä¿è¯IDè‡ªå¢ï¼Œæ¯æ¬¡ä¸šåŠ¡ä½¿ç”¨ä¸‹åˆ—SQLè¯»å†™MySQLå¾—åˆ°IDå·ã€‚å‚è€ƒäº†Leafçš„å®ç°æ€æƒ³: id serveræ¯æ¬¡æ‰¹é‡ä»æ•°æ®åº“å–å·æ®µï¼Œæœ¬åœ°ç¼“å­˜è¿™ä¸ªå·æ®µï¼Œå¹¶ä¸”è®¾ç½®é˜ˆå€¼ï¼Œå½“è¾¾åˆ°0.8ï¼ˆå·²ç”¨ä¸å·æ®µå®¹é‡çš„æ¯”å€¼ï¼‰ï¼Œè‡ªåŠ¨å»è·å–ä¸€ä¸ªæ–°çš„å·æ®µï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜çš„å·æ®µã€‚ id clientï¼Œå³å…·ä½“çš„è°ƒç”¨æœåŠ¡å®ä¾‹ï¼Œåœ¨æœ¬åœ°ä¹Ÿåšä¸€ä¸ªç¼“å­˜ï¼Œå®ç°å’Œid serverçš„ç¼“å­˜å·®ä¸å¤šï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡è½»idæœåŠ¡ç«¯çš„å‹åŠ›ï¼ŒåŒæ—¶å‡å°‘äº†rpcè°ƒç”¨çš„ç½‘ç»œæ¶ˆè€—ã€‚ ä»¥ä¸Šæ–¹æ¡ˆï¼Œå…¶ç¼ºç‚¹æ˜¯ï¼š å·æ®µå­˜åœ¨æµªè´¹ï¼Œæ— è®ºå“ªä¸ªå®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯é‡å¯éƒ½ä¼šæµªè´¹å·æ®µã€‚ å·æ®µæ˜¯ç›´æ¥è‡ªå¢ï¼Œä¸å¤Ÿéšæœºï¼Œå¯¹å¤–æš´éœ²ä¿¡æ¯è¿‡å¤šã€‚ DBå®•æœºä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ã€‚è™½ç„¶åœ¨DBå®•æœºä¹‹åï¼Œåˆ©ç”¨ç¼“å­˜è¿˜èƒ½è¿›è¡ŒçŸ­æš‚ä¾›å·ï¼Œä½†æ˜¯æ•°æ®åº“çš„ä¾èµ–è¿˜æ˜¯å¾ˆé‡ã€‚Leafé‡‡ç”¨çš„ä¸€èˆ¬åšæ³•æ˜¯é«˜å¯ç”¨å®¹ç¾: é‡‡ç”¨ä¸€ä¸»ä¸¤ä»çš„æ–¹å¼ï¼ŒåŒæ—¶åˆ†æœºæˆ¿éƒ¨ç½²ï¼ŒMasterå’ŒSlaveä¹‹é—´é‡‡ç”¨åŠåŒæ­¥æ–¹å¼åŒæ­¥æ•°æ®ã€‚åŒæ—¶ä½¿ç”¨DBProxyåšä¸»ä»åˆ‡æ¢ã€‚å½“ç„¶è¿™ç§æ–¹æ¡ˆåœ¨ä¸€äº›æƒ…å†µä¼šé€€åŒ–æˆå¼‚æ­¥æ¨¡å¼ï¼Œç”šè‡³åœ¨éå¸¸æç«¯æƒ…å†µä¸‹ä»ç„¶ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†æ˜¯å‡ºç°çš„æ¦‚ç‡éå¸¸å°ã€‚ 3. snowflakeæ–¹æ¡ˆ3.1 ä»‹ç»è€ƒè™‘åˆ°ä¸Šè¿°æ–¹æ¡ˆçš„ç¼ºé™·ï¼Œç¬”è€…è°ƒæŸ¥äº†å…¶ä»–çš„ç”Ÿæˆæ–¹æ¡ˆï¼Œsnowflakeå°±æ˜¯å…¶ä¸­ä¸€ç§æ–¹æ¡ˆã€‚è¶‹åŠ¿é€’å¢å’Œä¸å¤Ÿéšæœºçš„é—®é¢˜ï¼Œåœ¨snowflakeå®Œå…¨å¯ä»¥è§£å†³ï¼ŒSnowflake IDæœ‰64bitsé•¿ï¼Œç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š ç¬¬ä¸€ä½ä¸º0ï¼Œä¸ç”¨ã€‚ timestampâ€”41bits,ç²¾ç¡®åˆ°msï¼Œé‚£å°±æ„å‘³ç€å…¶å¯ä»¥è¡¨ç¤ºé•¿è¾¾(2^41-1)/(1000360024*365)=139.5å¹´ï¼Œå¦å¤–ä½¿ç”¨è€…å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªå¼€å§‹çºªå…ƒï¼ˆepoch)ï¼Œç„¶åç”¨(å½“å‰æ—¶é—´-å¼€å§‹çºªå…ƒï¼‰ç®—å‡ºtimeï¼Œè¿™è¡¨ç¤ºåœ¨timeè¿™ä¸ªéƒ¨åˆ†åœ¨140å¹´çš„æ—¶é—´é‡Œæ˜¯ä¸ä¼šé‡å¤çš„ï¼Œå®˜æ–¹æ–‡æ¡£åœ¨è¿™é‡Œå†™æˆäº†41bitsï¼Œåº”è¯¥æ˜¯å†™é”™äº†ã€‚å¦å¤–ï¼Œè¿™é‡Œç”¨timeè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŸå› ï¼Œå°±æ˜¯å¯ä»¥ç›´æ¥æ›´å…·timeè¿›è¡Œæ’åºï¼Œå¯¹äºtwitterè¿™ç§æ›´æ–°é¢‘ç¹çš„åº”ç”¨ï¼Œæ—¶é—´æ’åºå°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚ machine idâ€”10bits,è¯¥éƒ¨åˆ†å…¶å®ç”±datacenterIdå’ŒworkerIdä¸¤éƒ¨åˆ†ç»„æˆï¼Œè¿™ä¸¤éƒ¨åˆ†æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡æ˜çš„ã€‚ datacenterIdï¼Œæ–¹ä¾¿æ­å»ºå¤šä¸ªç”Ÿæˆuidçš„serviceï¼Œå¹¶ä¿è¯uidä¸é‡å¤ï¼Œæ¯”å¦‚åœ¨datacenter0å°†æœºå™¨0ï¼Œ1ï¼Œ2ç»„æˆäº†ä¸€ä¸ªç”Ÿæˆuidçš„serviceï¼Œè€Œdatacenter1æ­¤æ—¶ä¹Ÿéœ€è¦ä¸€ä¸ªç”Ÿæˆuidçš„serviceï¼Œä»æœ¬ä¸­å¿ƒè·å–uidæ˜¾ç„¶æ˜¯æœ€å¿«æœ€æ–¹ä¾¿çš„ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥åœ¨è‡ªå·±ä¸­å¿ƒæ­å»ºï¼Œåªè¦ä¿è¯datacenterIdå”¯ä¸€ã€‚å¦‚æœæ²¡æœ‰datacenterIdï¼Œå³ç”¨10bitsï¼Œé‚£ä¹ˆåœ¨æ­å»ºä¸€ä¸ªæ–°çš„serviceå‰å¿…é¡»çŸ¥é“ç›®å‰å·²ç»åœ¨ç”¨çš„idï¼Œå¦åˆ™ä¸èƒ½ä¿è¯ç”Ÿæˆçš„idå”¯ä¸€ï¼Œæ¯”å¦‚æ­å»ºçš„ä¸¤ä¸ªuid serviceä¸­éƒ½æœ‰machine idä¸º100çš„æœºå™¨ï¼Œå¦‚æœå…¶serveræ—¶é—´ç›¸åŒï¼Œé‚£ä¹ˆäº§ç”Ÿç›¸åŒidçš„æƒ…å†µä¸å¯é¿å…ã€‚ workerIdæ˜¯å®é™…serveræœºå™¨çš„ä»£å·ï¼Œæœ€å¤§åˆ°32ï¼ŒåŒä¸€ä¸ªdatacenterä¸‹çš„workerIdæ˜¯ä¸èƒ½é‡å¤çš„ã€‚å®ƒä¼šè¢«æ³¨å†Œåˆ°consulä¸Šï¼Œç¡®ä¿workerIdæœªè¢«å…¶ä»–æœºå™¨å ç”¨ï¼Œå¹¶å°†host:portå€¼å­˜å…¥ï¼Œæ³¨å†ŒæˆåŠŸåå°±å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†ã€‚ sequence id â€”12bits,è¯¥idå¯ä»¥è¡¨ç¤º4096ä¸ªæ•°å­—ï¼Œå®ƒæ˜¯åœ¨timeç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé€’å¢è¯¥å€¼ç›´åˆ°ä¸º0ï¼Œå³ä¸€ä¸ªå¾ªç¯ç»“æŸï¼Œæ­¤æ—¶ä¾¿åªèƒ½ç­‰åˆ°ä¸‹ä¸€ä¸ªmsåˆ°æ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹4096/msçš„è¯·æ±‚æ˜¯ä¸å¤ªå¯èƒ½å‡ºç°çš„ï¼Œæ‰€ä»¥è¶³å¤Ÿä½¿ç”¨äº†ã€‚ 3.2 å®ç°æ€è·¯snowflakeæ–¹æ¡ˆï¼ŒidæœåŠ¡ç«¯ç”Ÿæˆï¼Œä¸ä¾èµ–DBï¼Œæ—¢èƒ½ä¿è¯æ€§èƒ½ï¼Œä¸”ç”Ÿæˆçš„idè¶³å¤Ÿéšæœºã€‚æ¯ä¸€æ¯«ç§’ï¼Œä¸€å°workerå¯ä»¥ç”Ÿæˆ4096ä¸ªidï¼Œå¦‚æœè¶…è¿‡ï¼Œä¼šé˜»å¡åˆ°ä¸‹ä¸€æ¯«ç§’ç”Ÿæˆã€‚å¯¹äºé‚£äº›å¹¶å‘é‡å¾ˆå¤§çš„ç³»ç»Ÿæ¥è¯´,æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„, é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±æ˜¯é€šè¿‡datacenterIdå’ŒworkerIdæ¥åšåŒºåˆ†,è¿™ä¸¤ä¸ªID,åˆ†åˆ«æ˜¯5bit,å…±10bit,æœ€å¤§å€¼æ˜¯1024(0-1023)ä¸ª, åœ¨è¿™ç§æƒ…å†µä¸‹,snowflakeä¸€æ¯«ç§’ç†è®ºä¸Šæœ€å¤§èƒ½å¤Ÿç”Ÿæˆçš„IDæ•°é‡æ˜¯çº¦42Wä¸ª,è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„åŸºæ•°äº†,ç†è®ºä¸Šèƒ½å¤Ÿæ»¡è¶³ç»å¤§å¤šæ•°ç³»ç»Ÿçš„å¹¶å‘é‡ã€‚ è¯¥æ–¹æ¡ˆä¾èµ–äºç³»ç»Ÿæ—¶é’Ÿï¼Œéœ€è¦è€ƒè™‘æ—¶é’Ÿå›æ‹¨çš„é—®é¢˜ã€‚æœ¬åœ°ç¼“å­˜ä¸Šä¸€æ¬¡è¯·æ±‚çš„lastTimestampï¼Œä¸€ä¸ªçº¿ç¨‹è¿‡æ¥è·å–idæ—¶ï¼Œé¦–å…ˆæ ¡éªŒå½“å‰æ—¶é—´æ˜¯å¦å°äºä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ã€‚å¦‚æœå°äºè¯´æ˜ç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹è¿‡ï¼Œå›é€€åœ¨ä¸Šä¸€æ¬¡IDç”Ÿæˆæ—¶é—´ä¹‹å‰åº”å½“æŠ›å‡ºå¼‚å¸¸ï¼å¦‚æ­¤å¯ä»¥è§£å†³è¿è¡Œä¸­ï¼Œç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹çš„é—®é¢˜ã€‚ å¦ä¸€ç§æƒ…å†µæ˜¯ï¼ŒserveræœåŠ¡å¯åŠ¨æ—¶ï¼Œç³»ç»Ÿçš„æ—¶é—´è¢«å›æ‹¨ï¼ˆè™½ç„¶æ¯”è¾ƒæç«¯ï¼Œè¿˜æ˜¯åˆ—åœ¨è€ƒè™‘ä¸­ï¼‰ï¼Œè¿™æ ·æœ‰å¯èƒ½ä¸ä¹‹å‰ç”Ÿæˆçš„idå†²çªï¼Œå…¨å±€ä¸å”¯ä¸€ã€‚è¿™è¾¹è§£å†³æ–¹æ³•æ˜¯åˆ©ç”¨é¡¹ç›®çš„æœåŠ¡å‘ç°ä¸æ³¨å†Œç»„ä»¶consulï¼Œåœ¨consulé›†ç¾¤å­˜å‚¨æœ€æ–°çš„lastTimestampï¼Œkeyä¸ºå¯¹åº”çš„machine-idã€‚consulçš„ä¸€è‡´æ€§åŸºäºraftç®—æ³•ï¼Œå¹¶åˆ©ç”¨Gossipåè®®ï¼š Consul uses a gossip protocol to manage membership and broadcast messages to the cluster. All of this is provided through the use of the Serf library. å…·ä½“çš„åè®®ç®—æ³•ï¼Œå¯ä»¥å‚è€ƒGossipã€‚æ¯æ¬¡serverå®ä¾‹å¯åŠ¨æ—¶ï¼Œå®ä¾‹åŒ–idç”Ÿæˆbeançš„æ—¶å€™ï¼Œä¼šé¦–å…ˆæ ¡éªŒå½“å‰æ—¶é—´ä¸consulé›†ç¾¤ä¸­è¯¥workerå¯¹åº”çš„lastTimestampå¤§å°ï¼Œå¦‚æœå½“å‰æ—¶é—´åå°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼ŒæœåŠ¡å¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚ ç¬”è€…é¡¹ç›®æš‚æ—¶æœªåˆ†data centerï¼Œæ‰€ä»¥machine-idéƒ¨åˆ†éƒ½æ˜¯ä»¥æœåŠ¡å®ä¾‹çš„workidä»£æ›¿ã€‚workidå¯ä»¥ä»é…ç½®ä¸­å¿ƒè·å–ï¼Œä¹Ÿå¯ä»¥æœ¬åœ°é…ç½®ã€‚ç®€åŒ–çš„ç³»ç»Ÿæ¶æ„éƒ¨ç½²å›¾å¦‚ä¸‹ï¼š consulé›†ç¾¤è¿™è¾¹ä½œä¸ºæä¾›naming serviceå’Œkvå­˜å‚¨çš„ç»„ä»¶ï¼Œæ¯ä¸ªæœåŠ¡éƒ¨ç½²åæ³¨å†Œåˆ°consulé›†ç¾¤ï¼Œè‡³äºconsulé›†ç¾¤ç›¸å…³çš„ä¿¡æ¯ï¼Œä»¥åŠconsulæˆå‘˜çš„ä¸€è‡´æ€§ç›¸å…³ï¼Œåé¢å•ç‹¬ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»ã€‚ è¯·æ±‚idç”Ÿæˆæµç¨‹å›¾å¦‚ä¸‹ï¼š æœåŠ¡å®ä¾‹å¯åŠ¨çš„æµç¨‹å›¾è§ä¸Šæ–‡ï¼Œæ­¤å¤„ä¸ç”»å‡ºäº†ã€‚è¿™è¾¹éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼ŒæœåŠ¡æ³¨å†Œä¸å‘ç°ç»„ä»¶consulã€‚éƒ¨ç½²æ—¶æ¯ä¸ªæœåŠ¡å®ä¾‹éƒ½ä¼šæ³¨å†Œåˆ°ä¸€ä¸ªconsul agentï¼ˆä¸€èˆ¬æ˜¯æœ¬æœºï¼‰ï¼Œconsul agentè¿æ¥åˆ°consulé›†ç¾¤ï¼Œé€šè¿‡gossipåè®®è¿›è¡Œå¹¿æ’­ä¿¡æ¯ï¼Œæ‰€ä»¥å¦‚æœè¿æ¥çš„consul agentè¿›ç¨‹ä¸å¹¸æŒ‚æ‰ï¼ˆå¤§å¤šä¸ºç³»ç»Ÿå®•æœºï¼‰ï¼Œåœ¨è¿›ç¨‹é‡å¯åï¼Œè¿˜æ˜¯èƒ½è¿…é€Ÿè·å–åˆ°é›†ç¾¤ä¸­å­˜å‚¨çš„è¯¥workidçš„lastTimestampï¼Œé’ˆå¯¹è¯¥workidï¼Œå¦‚æœç³»ç»Ÿæ—¶é—´å›æ‹¨å°äºlastTimestampï¼ŒGeneratorå¯åŠ¨æ—¶ä¼šæŠ¥è­¦ã€‚è€Œå¯¹äºå¤§äºlastTimestampçš„æƒ…å†µï¼Œå¯èƒ½ç³»ç»Ÿæ—¶é’Ÿè¿˜æ˜¯ç›¸å¯¹å›æ‹¨ï¼Œæˆ‘ä»¬å§‘ä¸”å¯ä»¥è®¤ä¸ºå¯¹å…¨å±€idæ²¡æœ‰å½±å“ã€‚ å®ä¾‹åŒ–æ—¶ï¼Œè¿›è¡Œæ ¡éªŒï¼š 123456789public IdServiceImpl(long workerId, ConsulClient consulClient) &#123; if (workerId &gt; idMeta.MAX_ID || workerId &lt; 0) &#123; throw new IllegalArgumentException(String.format("worker Id can't be greater than %d or less than 0", idMeta.MAX_ID)); &#125; this.workerId = workerId; this.consulClient = consulClient; validateStoredTimestamp(); log.info("worker starting. timestamp left shift &#123;&#125;, worker id bits &#123;&#125;, sequence bits &#123;&#125;, workerid &#123;&#125;", idMeta.TIMESTAMP_LEFT_SHIFT_BITS, idMeta.ID_BITS, idMeta.SEQUENCE_BITS, workerId);&#125; æ ¡éªŒå‡½æ•°ï¼š 123456789101112131415/** * checks for timestamp by workerId when server starts. * if server starts for the first time, just let it go and log warns. * if current timestamp is smaller than the value stored in consul server, throw exception. */private void validateStoredTimestamp() &#123; long current = timeGen(); Response&lt;GetValue&gt; keyValueResponse = consulClient.getKVValue(String.valueOf(workerId)); if (keyValueResponse.getValue() != null) &#123; lastTimestamp = Long.parseLong(keyValueResponse.getValue().getDecodedValue()); validateTimestamp(current, lastTimestamp, Periods.START); &#125; else &#123; log.warn(String.format("clock in consul is null. Generator works as for the 1st time.")); &#125;&#125; validateTimestamp: 123456789101112/** * å¦‚æœå½“å‰æ—¶é—´æˆ³å°äºä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ï¼Œè¯´æ˜ç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹è¿‡ï¼Œå›é€€åœ¨ä¸Šä¸€æ¬¡IDç”Ÿæˆæ—¶é—´ä¹‹å‰åº”å½“æŠ›å‡ºå¼‚å¸¸ï¼ï¼ï¼ * * @param lastTimestamp ä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ * @param timestamp å½“å‰æ—¶é—´æˆ³ */ private void validateTimestamp(long timestamp, long lastTimestamp, Periods period) &#123; if (timestamp &lt; lastTimestamp) &#123; log.error(String.format("clock is moving backwards. Rejecting requests until %d.", lastTimestamp)); throw new IllegalStateException(String.format("Clock moved backwards in %s. Refusing to generate id for %d milliseconds", period, lastTimestamp - timestamp)); &#125; &#125; è·å–idæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627/** * ç”ŸæˆIDï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ * * @return id */ public synchronized long genId() &#123; long timestamp = timeGen(); //å¦‚æœå½“å‰æ—¶é—´å°äºä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ï¼Œè¯´æ˜ç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹è¿‡ï¼Œå›é€€åœ¨ä¸Šä¸€æ¬¡IDç”Ÿæˆæ—¶é—´ä¹‹å‰åº”å½“æŠ›å‡ºå¼‚å¸¸ï¼ï¼ï¼ validateTimestamp(timestamp, lastTimestamp, Periods.RUNNING); //å¦‚æœæ˜¯åŒä¸€æ—¶é—´ç”Ÿæˆçš„ï¼Œåˆ™è¿›è¡Œæ¯«ç§’å†…sequenceç”Ÿæˆ if (lastTimestamp == timestamp) &#123; sequence = (sequence + 1) &amp; IdMeta.SEQUENCE_MASK; //æº¢å‡ºå¤„ç† if (sequence == 0) &#123;//é˜»å¡åˆ°ä¸‹ä¸€æ¯«ç§’,è·å¾—æ–°æ—¶é—´æˆ³ timestamp = tilNextMillis(lastTimestamp); &#125; &#125; else &#123;//æ—¶é—´æˆ³æ”¹å˜ï¼Œæ¯«ç§’å†…sequenceé‡ç½® sequence = 0L; &#125; //ä¸Šæ¬¡ç”ŸæˆIDæ—¶é—´æˆª lastTimestamp = timestamp; consulClient.setKVValue(String.valueOf(workerId), String.valueOf(lastTimestamp)); //ç§»ä½å¹¶é€šè¿‡æˆ–è¿ç®—ç»„æˆ64ä½ID return ((timestamp - idMeta.START_TIME) &lt;&lt; idMeta.TIMESTAMP_LEFT_SHIFT_BITS) | (workerId &lt;&lt; idMeta.ID_SHIFT_BITS) | sequence; &#125; 4. æ€»ç»“è¿™ç¯‡æ–‡ç« å’Œå¤§å®¶åˆ†äº«äº†ç¬”è€…é¡¹ç›®ä¸­å…¨å±€idç”ŸæˆæœåŠ¡çš„æ¼”è¿›è¿‡ç¨‹ã€‚å½“å‰çš„æ–¹æ¡ˆå¯ä»¥æ»¡è¶³ç¬”è€…å½“å‰é¡¹ç›®çš„éœ€æ±‚ï¼Œè‡³äºåˆ†data-centerï¼ˆåŒä¸€ä¸ªæœºæˆ¿ä¼˜å…ˆè°ƒç”¨ï¼‰ï¼Œéœ€è¦ç»“åˆrpcè°ƒç”¨è¿›ä¸€æ­¥åšå¤„ç†ï¼Œæ‰€ä»¥è¿™å—åç»­å¯ä»¥ç»§ç»­å®Œå–„ã€‚æ¬¢è¿å¤§å®¶æå‡ºå»ºè®®ã€‚ æœ¬æ–‡çš„æºç åœ°å€ï¼šGitHubï¼šhttps://github.com/keets2012/snowflake-id-generatorç äº‘ï¼š https://gitee.com/keets/snowflake-id-generator å‚è€ƒï¼š www.consul.io leaf Twitterçš„åˆ†å¸ƒå¼è‡ªå¢IDç®—æ³•snowflake (Javaç‰ˆ)]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
      </categories>
      <tags>
        <tag>spring boot</tag>
        <tag>snowflake</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ThreadLocal]]></title>
    <url>%2F2017%2F09%2F04%2FThreadLocal%2F</url>
    <content type="text"><![CDATA[ThreadLocalä¸»è¦æ˜¯æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹å†…éšæ—¶éšåœ°å¯å–ï¼Œéš”ç¦»å…¶ä»–çº¿ç¨‹ã€‚ 1. ThreadLocalæ¥å£1.1 ThreadLocalç±»æ¥å£å¾ˆç®€å•ï¼Œåªæœ‰4ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ï¼š void set(Object value)è®¾ç½®å½“å‰çº¿ç¨‹çš„çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ã€‚ public Object get()è¯¥æ–¹æ³•è¿”å›å½“å‰çº¿ç¨‹æ‰€å¯¹åº”çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ public void remove()å°†å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼åˆ é™¤ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜çš„å ç”¨ï¼Œè¯¥æ–¹æ³•æ˜¯JDK 5.0æ–°å¢çš„æ–¹æ³•ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œå½“çº¿ç¨‹ç»“æŸåï¼Œå¯¹åº”è¯¥çº¿ç¨‹çš„å±€éƒ¨å˜é‡å°†è‡ªåŠ¨è¢«åƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥æ˜¾å¼è°ƒç”¨è¯¥æ–¹æ³•æ¸…é™¤çº¿ç¨‹çš„å±€éƒ¨å˜é‡å¹¶ä¸æ˜¯å¿…é¡»çš„æ“ä½œï¼Œä½†å®ƒå¯ä»¥åŠ å¿«å†…å­˜å›æ”¶çš„é€Ÿåº¦ã€‚ protected Object initialValue()è¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªprotectedçš„æ–¹æ³•ï¼Œæ˜¾ç„¶æ˜¯ä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹ç¬¬1æ¬¡è°ƒç”¨get()æˆ–set(Object)æ—¶æ‰æ‰§è¡Œï¼Œå¹¶ä¸”ä»…æ‰§è¡Œ1æ¬¡ã€‚ThreadLocalä¸­çš„ç¼ºçœå®ç°ç›´æ¥è¿”å›ä¸€ä¸ªnullã€‚ åœ¨åŒæ­¥æœºåˆ¶ä¸­ï¼Œé€šè¿‡å¯¹è±¡çš„é”æœºåˆ¶ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å˜é‡ã€‚è¿™æ—¶è¯¥å˜é‡æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œä½¿ç”¨åŒæ­¥æœºåˆ¶è¦æ±‚ç¨‹åºæ…å¯†åœ°åˆ†æä»€ä¹ˆæ—¶å€™å¯¹å˜é‡è¿›è¡Œè¯»å†™ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦é”å®šæŸä¸ªå¯¹è±¡ï¼Œä»€ä¹ˆæ—¶å€™é‡Šæ”¾å¯¹è±¡é”ç­‰ç¹æ‚çš„é—®é¢˜ï¼Œç¨‹åºè®¾è®¡å’Œç¼–å†™éš¾åº¦ç›¸å¯¹è¾ƒå¤§ã€‚ è€ŒThreadLocalåˆ™ä»å¦ä¸€ä¸ªè§’åº¦æ¥è§£å†³å¤šçº¿ç¨‹çš„å¹¶å‘è®¿é—®ã€‚ThreadLocalä¼šä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œéš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„è®¿é—®å†²çªã€‚å› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œä»è€Œä¹Ÿå°±æ²¡æœ‰å¿…è¦å¯¹è¯¥å˜é‡è¿›è¡ŒåŒæ­¥äº†ã€‚ThreadLocalæä¾›äº†çº¿ç¨‹å®‰å…¨çš„å…±äº«å¯¹è±¡ï¼Œåœ¨ç¼–å†™å¤šçº¿ç¨‹ä»£ç æ—¶ï¼Œå¯ä»¥æŠŠä¸å®‰å…¨çš„å˜é‡å°è£…è¿›ThreadLocalã€‚å¦‚æœæƒ³åœ¨getä¹‹å‰ä¸éœ€è¦è°ƒç”¨setå°±èƒ½æ­£å¸¸è®¿é—®çš„è¯ï¼Œå¿…é¡»é‡å†™initialValue()æ–¹æ³•ã€‚æœ€å¸¸è§çš„ThreadLocalä½¿ç”¨åœºæ™¯ä¸º ç”¨æ¥è§£å†³ æ•°æ®åº“è¿æ¥ã€Sessionç®¡ç†ç­‰ã€‚ 1.2 ä½¿ç”¨ThreadLocal123456789101112131415161718192021222324252627282930313233343536373839404142434445public class ThreadTest &#123; ThreadLocal&lt;Long&gt; longLocal = new ThreadLocal&lt;Long&gt;()&#123; protected Long initialValue() &#123; return Thread.currentThread().getId(); &#125; &#125;; ThreadLocal&lt;String&gt; stringLocal = new ThreadLocal&lt;String&gt;()&#123;; protected String initialValue() &#123; return Thread.currentThread().getName(); &#125; &#125;; public void set() &#123; longLocal.set(Thread.currentThread().getId()); stringLocal.set(Thread.currentThread().getName()); &#125; public long getLong() &#123; return longLocal.get(); &#125; public String getString() &#123; return stringLocal.get(); &#125; public static void main(String[] args) throws InterruptedException &#123; final ThreadTest test = new ThreadTest(); //test.set(); System.out.println("main.getLong: " + test.getLong()); System.out.println("main.getString: " + test.getString()); Thread thread1 = new Thread() &#123; public void run() &#123; //test.set(); System.out.println("Thread.getLong: " + test.getLong()); System.out.println("Thread.getString: " + test.getString()); &#125; &#125;; thread1.start(); thread1.join(); &#125;&#125; ä»¥ä¸Šdemoè¦†å†™äº†initialValue()æ–¹æ³•ï¼Œæˆ–è€…è°ƒç”¨setæ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚åœ¨mainçº¿ç¨‹ä¸­å’Œthread1çº¿ç¨‹ä¸­ï¼ŒlongLocalä¿å­˜çš„å‰¯æœ¬å€¼å’ŒstringLocalä¿å­˜çš„å‰¯æœ¬å€¼éƒ½ä¸ä¸€æ ·ã€‚ 2. ThreadLocalMapThreadLocalMapçš„Entryç»§æ‰¿äº†WeakReferenceï¼Œå¹¶ä¸”ä½¿ç”¨ThreadLocalä½œä¸ºé”®å€¼ã€‚ 1. å®é™…çš„é€šè¿‡ThreadLocalåˆ›å»ºçš„å‰¯æœ¬æ˜¯å­˜å‚¨åœ¨æ¯ä¸ªçº¿ç¨‹è‡ªå·±çš„threadLocalsä¸­çš„ï¼› 2. ä¸ºä½•threadLocalsçš„ç±»å‹ThreadLocalMapçš„é”®å€¼ä¸ºThreadLocalå¯¹è±¡ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹ä¸­å¯æœ‰å¤šä¸ªthreadLocalå˜é‡ï¼Œå°±åƒä¸Šé¢ä»£ç ä¸­çš„longLocalå’ŒstringLocalï¼› 3. åœ¨è¿›è¡Œgetä¹‹å‰ï¼Œå¿…é¡»å…ˆsetï¼Œå¦åˆ™ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼› 2.1 æ–¹æ³•åˆ†æ1). JDK8çš„ThreadLocalçš„getæ–¹æ³•çš„æºç  123456789101112131415161718192021/** * Returns the value in the current thread's copy of this * thread-local variable. If the variable has no value for the * current thread, it is first initialized to the value returned * by an invocation of the &#123;@link #initialValue&#125; method. * * @return the current thread's value of this thread-local */public T get() &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) &#123; ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; @SuppressWarnings("unchecked") T result = (T)e.value; return result; &#125; &#125; return setInitialValue();&#125; 2). getMap 12345678910/** * Get the map associated with a ThreadLocal. Overridden in * InheritableThreadLocal. * * @param t the current thread * @return the map */ThreadLocalMap getMap(Thread t) &#123; return t.threadLocals;&#125; 3). setInitialValue 12345678910111213141516/** * Variant of set() to establish initialValue. Used instead * of set() in case user has overridden the set() method. * * @return the initial value */private T setInitialValue() &#123; T value = initialValue(); Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); return value;&#125; getæ–¹æ³•çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š 1.é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ 2.æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ªMap 3.å¦‚æœè·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™åœ¨Mapä¸­ä»¥ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyæ¥åœ¨Mapä¸­è·å–å¯¹åº”çš„value eï¼Œå¦åˆ™è½¬åˆ°5 4.å¦‚æœeä¸ä¸ºnullï¼Œåˆ™è¿”å›e.valueï¼Œå¦åˆ™è½¬åˆ°5 5.Mapä¸ºç©ºæˆ–è€…eä¸ºç©ºï¼Œåˆ™é€šè¿‡initialValueå‡½æ•°è·å–åˆå§‹å€¼valueï¼Œç„¶åç”¨ThreadLocalçš„å¼•ç”¨å’Œvalueä½œä¸ºfirstKeyå’ŒfirstValueåˆ›å»ºä¸€ä¸ªæ–°çš„Map æ¯ä¸ªThreadç»´æŠ¤ä¸€ä¸ªThreadLocalMapæ˜ å°„è¡¨ï¼Œè¿™ä¸ªæ˜ å°„è¡¨çš„keyæ˜¯ThreadLocalå®ä¾‹æœ¬èº«ï¼Œvalueæ˜¯çœŸæ­£éœ€è¦å­˜å‚¨çš„Objectã€‚ 3. WeakReferenceå…³äºå†…å­˜æ³„éœ²ï¼š ThreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æœä¸€ä¸ªThreadLocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨å¼•ç”¨ä»–ï¼Œé‚£ä¹ˆç³»ç»Ÿgcçš„æ—¶å€™ï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›æ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºç°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼šThreadLocal Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; value ä¸»è¦çœ‹ä¸‹getEntryAfterMisså‡½æ•°ï¼š 12345678910111213141516private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) &#123; Entry[] tab = table; int len = tab.length; while (e != null) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == key) return e; if (k == null) expungeStaleEntry(i); else i = nextIndex(i, len); e = tab[i]; &#125; return null; &#125; ThreadLocalMapçš„getEntryå‡½æ•°çš„æµç¨‹ï¼š é¦–å…ˆä»ThreadLocalçš„ç›´æ¥ç´¢å¼•ä½ç½®(é€šè¿‡ThreadLocal.threadLocalHashCode &amp; (len-1)è¿ç®—å¾—åˆ°)è·å–Entry eï¼Œå¦‚æœeä¸ä¸ºnullå¹¶ä¸”keyç›¸åŒåˆ™è¿”å›eï¼› å¦‚æœeä¸ºnullæˆ–è€…keyä¸ä¸€è‡´åˆ™å‘ä¸‹ä¸€ä¸ªä½ç½®æŸ¥è¯¢ï¼Œå¦‚æœä¸‹ä¸€ä¸ªä½ç½®çš„keyå’Œå½“å‰éœ€è¦æŸ¥è¯¢çš„keyç›¸ç­‰ï¼Œåˆ™è¿”å›å¯¹åº”çš„Entryï¼Œå¦åˆ™ï¼Œå¦‚æœkeyå€¼ä¸ºnullï¼Œåˆ™æ“¦é™¤è¯¥ä½ç½®çš„Entryï¼Œå¦åˆ™ç»§ç»­å‘ä¸‹ä¸€ä¸ªä½ç½®æŸ¥è¯¢ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é‡åˆ°çš„keyä¸ºnullçš„Entryéƒ½ä¼šè¢«æ“¦é™¤ï¼Œé‚£ä¹ˆEntryå†…çš„valueä¹Ÿå°±æ²¡æœ‰å¼ºå¼•ç”¨é“¾ï¼Œè‡ªç„¶ä¼šè¢«å›æ”¶ã€‚ä»”ç»†ç ”ç©¶ä»£ç å¯ä»¥å‘ç°ï¼Œsetæ“ä½œä¹Ÿæœ‰ç±»ä¼¼çš„æ€æƒ³ï¼Œå°†keyä¸ºnullçš„è¿™äº›Entryéƒ½åˆ é™¤ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚ ä½†æ˜¯å…‰è¿™æ ·è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œä¸Šé¢çš„è®¾è®¡æ€è·¯ä¾èµ–ä¸€ä¸ªå‰ææ¡ä»¶ï¼šè¦è°ƒç”¨ThreadLocalMapçš„genEntryå‡½æ•°æˆ–è€…setå‡½æ•°ã€‚è¿™å½“ç„¶æ˜¯ä¸å¯èƒ½ä»»ä½•æƒ…å†µéƒ½æˆç«‹çš„ï¼Œæ‰€ä»¥å¾ˆå¤šæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨è€…æ‰‹åŠ¨è°ƒç”¨ThreadLocalçš„removeå‡½æ•°ï¼Œæ‰‹åŠ¨åˆ é™¤ä¸å†éœ€è¦çš„ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚æ‰€ä»¥JDKå»ºè®®å°†ThreadLocalå˜é‡å®šä¹‰æˆprivate staticçš„ï¼Œè¿™æ ·çš„è¯ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸå°±æ›´é•¿ï¼Œç”±äºä¸€ç›´å­˜åœ¨ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œæ‰€ä»¥ThreadLocalä¹Ÿå°±ä¸ä¼šè¢«å›æ”¶ï¼Œä¹Ÿå°±èƒ½ä¿è¯ä»»ä½•æ—¶å€™éƒ½èƒ½æ ¹æ®ThreadLocalçš„å¼±å¼•ç”¨è®¿é—®åˆ°Entryçš„valueå€¼ï¼Œç„¶åremoveå®ƒï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚ å‚è€ƒï¼šThreadLocalå’Œsynchronizedçš„åŒºåˆ«Javaå¹¶å‘ç¼–ç¨‹ï¼šæ·±å…¥å‰–æThreadLocal]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>Thread</tag>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è‡ªåˆ¶Jersey-Swaggerçš„spring-boot-starter]]></title>
    <url>%2F2017%2F09%2F02%2Fspring-boot-starter-swaggerforjersey%2F</url>
    <content type="text"><![CDATA[Spring Bootçš„è‡ªåŠ¨åŒ–é…ç½®ç‰¹æ€§æ¥å®ç°å¿«é€Ÿçš„å°†swagger2å¼•å…¥spring bootåº”ç”¨æ¥ç”Ÿæˆjerseyçš„APIæ–‡æ¡£ï¼Œç®€åŒ–åŸç”Ÿä½¿ç”¨swagger2çš„æ•´åˆä»£ç ã€‚ ç‰ˆæœ¬åŸºç¡€ Spring Bootï¼š1.5.x swagger-jersey2-jaxrsï¼š2.7.x Jersey 2 å¦‚ä½•ä½¿ç”¨åœ¨è¯¥é¡¹ç›®çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬çš„Spring Bootå¯ä»¥è½»æ¾çš„å¼•å…¥swagger2ï¼Œä¸»éœ€è¦åšä¸‹é¢ä¸¤ä¸ªæ­¥éª¤ï¼š åœ¨pom.xmlä¸­å¼•å…¥ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;club.hacloud&lt;/groupId&gt; &lt;artifactId&gt;jersey-starter-swagger&lt;/artifactId&gt; &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;&lt;/dependency&gt; åœ¨åº”ç”¨ä¸»ç±»ä¸­å¢åŠ @EnableSwagger2Docæ³¨è§£ 123456789@EnableSwagger2Doc@SpringBootApplicationpublic class Bootstrap &#123; public static void main(String[] args) &#123; SpringApplication.run(Bootstrap.class, args); &#125;&#125; JerseyConfig ä¸­å¢åŠ 1234@PostConstructpublic void init() &#123; this.register(ApiListingResource.class, SwaggerSerializers.class);&#125; é»˜è®¤æƒ…å†µä¸‹å°±èƒ½äº§ç”Ÿæ‰€æœ‰å½“å‰jerseyåŠ è½½çš„è¯·æ±‚æ˜ å°„æ–‡æ¡£ã€‚ å‚æ•°é…ç½®æ›´ç»†è‡´çš„é…ç½®å†…å®¹å‚è€ƒå¦‚ä¸‹ï¼š é…ç½®ç¤ºä¾‹1234567891011swagger: enabled: true title: spring-boot-starter-swagger config-id: demo-mvc version: v2 license: Apache License, Version 2.0 licenseUrl: https://www.apache.org/licenses/LICENSE-2.0.html termsOfServiceUrl: http://git.oschina.net/keets/jersey-starter-swagger contact: keets base-path: /** resource-package: cn.keets.demo é…ç½®è¯´æ˜é»˜è®¤é…ç½®12345678910- swagger.enabled=æ˜¯å¦å¼€å¯ // todo å®ç°çº¿ä¸Šå…³é—­åŠŸèƒ½- swagger.title=æ ‡é¢˜- swagger.description=æè¿°- swagger.version=ç‰ˆæœ¬- swagger.license=è®¸å¯è¯- swagger.licenseUrl=è®¸å¯è¯URL- swagger.termsOfServiceUrl=æœåŠ¡æ¡æ¬¾URL- swagger.contact=ç»´æŠ¤äºº- swagger.resource-package=swaggeræ‰«æçš„åŸºç¡€åŒ…ï¼Œé»˜è®¤ï¼šå…¨æ‰«æ- swagger.base-path=éœ€è¦å¤„ç†çš„åŸºç¡€URLè§„åˆ™ï¼Œé»˜è®¤ï¼š/** swagger uiæœªåŒ…å«åœ¨é¡¹ç›®ä¸­ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±éƒ¨ç½²é™æ€æ–‡ä»¶ï¼Œé€šè¿‡é™æ€æ–‡ä»¶è§£æjson å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é¡¹ç›®gitåœ°å€ï¼šhttp://git.oschina.net/keets/jersey-starter-swaggerdemo gitåœ°å€ï¼šhttp://git.oschina.net/keets/spring-boot-samples/tree/master/demo-jersey-starter å‚è€ƒï¼šspring-boot-starter-swagger 1.3.0.RELEASEï¼šæ–°å¢å¯¹JSR-303çš„æ”¯æŒå’Œhostçš„é…ç½®]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
      </categories>
      <tags>
        <tag>Jersey</tag>
        <tag>Spring Boot</tag>
        <tag>starter</tag>
        <tag>swagger</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Restful Layer of SpringMVC vs Jersey]]></title>
    <url>%2F2017%2F08%2F30%2FJerseyvsspringmvc%2F</url>
    <content type="text"><![CDATA[ç¬”è€…é¡¹ç›®å®ç°å‰åç«¯å‰¥ç¦»ï¼ŒæœåŠ¡ç«¯å¯¹å¤–æä¾›restfulæ¥å£ã€‚RESTé€æ¸æˆä¸ºå½±å“Webæ¡†æ¶ã€Webåè®®ä¸Webåº”ç”¨è®¾è®¡çš„é‡è¦æ¦‚å¿µã€‚ç°åœ¨æœ‰è¶Šæ¥è¶Šå¤šçš„å…¬å¸å¸Œæœ›èƒ½ä»¥ç®€å•è€Œåˆè´´åˆWebæ¶æ„æœ¬èº«çš„æ–¹å¼å…¬å¼€Web APIï¼Œå› æ­¤RESTå˜å¾—è¶Šæ¥è¶Šé‡è¦ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚ä½¿ç”¨Ajaxè¿›è¡Œé€šä¿¡çš„å¯Œæµè§ˆå™¨ç«¯ä¹Ÿåœ¨æœè¿™ä¸ªç›®æ ‡ä¸æ–­è¿ˆè¿›ã€‚è¿™ä¸ªæ¶æ„åŸåˆ™æå‡äº†ä¸‡ç»´ç½‘çš„å¯ä¼¸ç¼©æ€§ï¼Œæ— è®ºä½•ç§åº”ç”¨éƒ½èƒ½ä»è¯¥åŸåˆ™ä¸­å—ç›Šæ— ç©·ã€‚SpringMVCå’ŒJerseyéƒ½å¯ä»¥ä¸ºä½ æä¾›restfulé£æ ¼çš„æ¥å£ã€‚æœ¬æ–‡å°†ä»‹ç»SpringMVCä¸­çš„RESTç‰¹æ€§å¹¶ä¸Jerseyè¿›è¡Œå¯¹æ¯”ã€‚ 1. RESTåŸºç¡€æ¦‚å¿µ åœ¨RESTä¸­çš„ä¸€åˆ‡éƒ½è¢«è®¤ä¸ºæ˜¯ä¸€ç§èµ„æºã€‚ æ¯ä¸ªèµ„æºç”±URIæ ‡è¯†ã€‚ ä½¿ç”¨ç»Ÿä¸€çš„æ¥å£ã€‚å¤„ç†èµ„æºä½¿ç”¨POSTï¼ŒGETï¼ŒPUTï¼ŒDELETEæ“ä½œç±»ä¼¼åˆ›å»ºï¼Œè¯»å–ï¼Œæ›´æ–°å’Œåˆ é™¤ï¼ˆCRUDï¼‰æ“ä½œã€‚ æ— çŠ¶æ€ã€‚æ¯ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¯·æ±‚ã€‚ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯ï¼Œä»¥ä¾¿äºç†è§£ã€‚ é€šä¿¡éƒ½æ˜¯é€šè¿‡å±•ç°ã€‚ä¾‹å¦‚XMLï¼ŒJSONã€‚ 2. Jerseyä¸SpringMVCJAX-RSï¼ˆJSR 311ï¼‰æŒ‡çš„æ˜¯Java API for RESTful Web Servicesï¼ŒRoy Fieldingä¹Ÿå‚ä¸äº†JAX-RSçš„åˆ¶è®¢ï¼Œä»–åœ¨è‡ªå·±çš„åšå£«è®ºæ–‡ä¸­å®šä¹‰äº†RESTã€‚å¯¹äºé‚£äº›æƒ³è¦æ„å»ºRESTful Web Servicesçš„å¼€å‘è€…æ¥è¯´ï¼ŒJAX-RSç»™å‡ºäº†ä¸åŒäºJAX-WSï¼ˆJSR-224ï¼‰çš„å¦ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚ç›®å‰å…±æœ‰4ç§JAX-RSå®ç°ï¼Œæ‰€æœ‰è¿™äº›å®ç°éƒ½æ”¯æŒSpringï¼ŒJerseyåˆ™æ˜¯JAX-RSçš„å‚è€ƒå®ç°ã€‚ æœ‰å¿…è¦æŒ‡å‡ºJAX-RSçš„ç›®æ ‡æ˜¯Web Serviceså¼€å‘ï¼ˆè¿™ä¸HTML Webåº”ç”¨ä¸åŒï¼‰è€ŒSpring MVCçš„ç›®æ ‡åˆ™æ˜¯Webåº”ç”¨å¼€å‘ã€‚Spring 3ä¸ºWebåº”ç”¨ä¸Web Serviceså¢åŠ äº†å¹¿æ³›çš„RESTæ”¯æŒï¼Œä½†æœ¬æ–‡åˆ™å…³æ³¨äºä¸Web Serviceså¼€å‘ç›¸å…³çš„ç‰¹æ€§ã€‚æˆ‘è§‰å¾—è¿™ç§æ–¹å¼æ›´æœ‰åŠ©äºåœ¨JAX-RSçš„ä¸Šä¸‹æ–‡ä¸­è®¨è®ºSpring MVCã€‚ è¦è¯´æ˜çš„ç¬¬äºŒç‚¹æ˜¯æˆ‘ä»¬å°†è¦è®¨è®ºçš„RESTç‰¹æ€§æ˜¯Spring Frameworkçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ç°æœ‰çš„Spring MVCç¼–ç¨‹æ¨¡å‹çš„å»¶ç»­ï¼Œå› æ­¤ï¼Œå¹¶æ²¡æœ‰æ‰€è°“çš„â€œSpring REST frameworkâ€è¿™ç§æ¦‚å¿µï¼Œæœ‰çš„åªæ˜¯Springå’ŒSpring MVCã€‚è¿™æ„å‘³ç€å¦‚æœä½ æœ‰ä¸€ä¸ªSpringåº”ç”¨çš„è¯ï¼Œä½ æ—¢å¯ä»¥ä½¿ç”¨Spring MVCåˆ›å»ºHTML Webå±‚ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºRESTful Web Serviceså±‚ã€‚]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
      </categories>
      <tags>
        <tag>REST</tag>
        <tag>Jersey</tag>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[macä¸‹å¿«é€Ÿè¿›å…¥å½“å‰ç›®å½•iterm2]]></title>
    <url>%2F2017%2F08%2F28%2Fmac%E5%BF%AB%E6%8D%B7%E9%94%AE%2F</url>
    <content type="text"><![CDATA[winç¯å¢ƒä¸‹ï¼Œæœ‰ç›´æ¥åœ¨æ–‡ä»¶æµè§ˆçš„åœ°å€ä¸Šï¼Œç›´æ¥è¾“å…¥cmdï¼Œå³å¯æ‰“å¼€cmdå‘½ä»¤æ¡†ã€‚ç¬”è€…åœ¨macOSä¸‹ï¼Œä¹Ÿæƒ³å®ç°è¿™æ ·çš„åŠŸèƒ½ï¼Œç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹ï¼Œå¯ä»¥æˆåŠŸå®è·µã€‚ 1. æ·»åŠ æœåŠ¡1git clone https://github.com/peterldowns/iterm2-finder-tools.git è¿›å…¥ iterm2-finder-toolsæ–‡ä»¶å¤¹ï¼Œè¿è¡ŒiTerm.workflowã€‚å®‰è£…æœåŠ¡æ ã€‚ 2. ä½¿ç”¨æœåŠ¡åœ¨å·¥ä½œæ–‡ä»¶å¤¹ä¸Šå³é”®ï¼Œå¼¹å‡ºçª—å£ä¸­æ‰¾åˆ°æœåŠ¡ä¸€æ ï¼Œå°†é¼ æ ‡æ”¾ç½®å…¶ä¸Šï¼Œåœ¨å¼¹å‡ºçª—å£ä¸­æ‰¾åˆ° Open iTermä¸€æ ï¼Œå•å‡»å³å¯ã€‚ 3. æ·»åŠ å¿«æ·é”®æœåŠ¡-&gt;åå¥½è®¾ç½®-&gt;å¿«æ·é”® ç¬”è€…è®¾ç½®äº†control+command+Lã€‚å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è¿›è¡Œè®¾ç½®å¿«æ·é”®ã€‚ å‚è€ƒï¼š Macåœ¨Finderä¸­å½“å‰ç›®å½•ä¸‹æ‰“å¼€iTerm2]]></content>
      <categories>
        <category>Utils</category>
      </categories>
      <tags>
        <tag>mac</tag>
        <tag>utils</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[HTTP 2å®é™…åº”ç”¨]]></title>
    <url>%2F2017%2F08%2F27%2Fhttp2%E5%BA%94%E7%94%A8%2F</url>
    <content type="text"><![CDATA[1. èƒŒæ™¯ä»‹ç»1.1 éœ€è¦è§£å†³çš„é—®é¢˜æœ¬æ–‡æ¥æºäºé¡¹ç›®éœ€è¦ï¼Œé¡¹ç›®æ‰€ä½¿ç”¨å¾®æœåŠ¡æ¡†æ¶ä¸ºSpring Cloudï¼Œå¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨åŸºäºHTTP 1.Xåè®®ï¼Œä¸Šä¸€ç¯‡æ–‡ç«  HTTPS vs HTTP 1.1 vs HTTP 2ï¼Œä»‹ç»äº†http2 å’Œhttp1.1çš„ç›¸å…³çŸ¥è¯†ï¼Œä¹Ÿåˆ—å‡ºäº†http1.1å±€é™æ€§ï¼Œé“¾è·¯ä¸èƒ½å¤ç”¨ã€æ•°æ®ä¸åŠ å¯†ã€å¤´ä¿¡æ¯è¿‡å¤šç­‰ç­‰ã€‚ä¸ºæ­¤ï¼Œç¬”è€…åœ¨æƒ³èƒ½ä¸èƒ½å°†feign clientçš„è°ƒç”¨åŸºäºhttp2åè®®ï¼Œåšäº†å¦‚ä¸‹è°ƒç ”ã€‚ HTTP/2 æºè‡ª SPDY/2ã€‚SPDY ç³»åˆ—åè®®ç”±è°·æ­Œå¼€å‘ï¼Œäº 2009 å¹´å…¬å¼€ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯é™ä½ 50% çš„é¡µé¢åŠ è½½æ—¶é—´ã€‚å½“ä¸‹å¾ˆå¤šè‘—åçš„äº’è”ç½‘å…¬å¸ï¼Œä¾‹å¦‚ç™¾åº¦ã€æ·˜å®ã€UPYUN éƒ½åœ¨è‡ªå·±çš„ç½‘ç«™æˆ– APP ä¸­é‡‡ç”¨äº† SPDY ç³»åˆ—åè®®ï¼ˆå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ SPDY/3.1ï¼‰ï¼Œå› ä¸ºå®ƒå¯¹æ€§èƒ½çš„æå‡æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ä¸»æµçš„æµè§ˆå™¨ï¼ˆè°·æ­Œã€ç«ç‹ã€Operaï¼‰ä¹Ÿéƒ½æ—©å·²ç»æ”¯æŒ SPDYï¼Œå®ƒå·²ç»æˆä¸ºäº†å·¥ä¸šæ ‡å‡†ï¼ŒHTTP Working-Group æœ€ç»ˆå†³å®šä»¥ SPDY/2 ä¸ºåŸºç¡€ï¼Œå¼€å‘ HTTP/2ã€‚2013å¹´8æœˆï¼Œè¿›è¡Œé¦–æ¬¡æµ‹è¯•ï¼Œè¯ç”Ÿçš„æ—¶é—´å¾ˆæ™šï¼Œç¬”è€…æœç´¢äº†ç½‘ä¸Šå…³äºhttp2å®è·µçš„ç›¸å…³ä¿¡æ¯ï¼Œå‘ç°å¹¶ä¸å¤šã€‚ 1.2 å…³äºé¡¹ç›®ä»‹ç»Spring Cloudæ˜¯ç¬”è€…é¡¹ç›®é‡‡ç”¨çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå…·ä½“ä»‹ç»è§Spring Cloudã€‚Spring Cloudæ˜¯åŸºäºSpring Bootå¼€å‘çš„ç»„åˆæ¡†æ¶ï¼ŒSpring Bootå†…ç½®çš„å®¹å™¨æ˜¯Tomcatï¼Œç¬”è€…çš„é¡¹ç›®ä¸€èˆ¬éƒ½ä¼šexclude Tomcatçš„å¼•ç”¨ï¼Œä½¿ç”¨çš„æ˜¯Jettyå®¹å™¨ã€‚æ‰€ä»¥æœç´¢çš„ä¸»é¢˜è¯å°±å˜æˆäº† jetty http2ã€‚ 2. è°ƒç ”ç»“æœå¤§éƒ¨åˆ†çš„äººä¹ æƒ¯äºå°†Tomcatè¿è¡Œåœ¨8080ç«¯å£ï¼Œå†ç”¨Apache serveråœ¨å‰é¢æä¾›httpsã€‚è¿™æ ·åšæ˜¯å› ä¸ºç®€å•ä¸”éªŒè¯è¿‡çš„æ–¹æ³•ã€‚ä½¿ç”¨http2 ï¼Œä½ å°†è¢«è¿«ä½¿ç”¨httpsï¼Œè¿™æ ·å°±ä¸ç”¨éƒ¨ç½²Apache (or nginx)ã€‚ 2.1 æœåŠ¡ç«¯ Currently Jetty and undertow are the only servers in Spring Boot that support HTTP/2.Jetty has booked some progress and this repository shows an excellent example. In my opinion itâ€™s still too much custom code, but theyâ€™re getting there.The next candidate is undertow. It seems almost too easy, but it works. Because we use AJP in our current configuration it even means this HTTP/2 solution has less lines of code! å½“å‰Spring Bootåªæœ‰Jetty å’Œ undertowæ”¯æŒHTTP/2ã€‚ æ ·ä¾‹repoæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„exampleã€‚æ€»å¾—åˆ†ä¸ºä¸‰æ­¥ï¼š update dependencies org.springframework.boot:spring-boot-starter-undertow org.mortbay.jetty.alpn:alpn-boot:8.1.8.v20160420 create a servlet container bean 1234567@Bean UndertowEmbeddedServletContainerFactory embeddedServletContainerFactory() &#123; UndertowEmbeddedServletContainerFactory factory = new UndertowEmbeddedServletContainerFactory(); factory.addBuilderCustomizers( builder -&gt; builder.setServerOption(UndertowOptions.ENABLE_HTTP2, true)); return factory; &#125; start your server with alpnä¸ºäº†å¯åŠ¨æœåŠ¡ï¼Œéœ€è¦å¸¦ä¸Š -Xbootclasspath å‚æ•°æ¥åŒ…æ‹¬alpn ã€‚å› ä¸ºalpn æœ‰å¯èƒ½åœ¨jdkä¸­æ²¡æœ‰ã€‚ 1-Xbootclasspath/p:/home/harrie/.m2/repository/org/mortbay/jetty/alpn/alpn-boot/8.1.8.v20160420/alpn-boot-8.1.8.v20160420.jar 2.2 å®¢æˆ·ç«¯ Currently Java HTTP/2 clients are scarce. According to this wiki Netty and OkHttp are the only two implementations supported by Spring. To switch HTTP-client in RestTemplate you have to call the constructor with a different ClientHttpRequestFactory (either Netty4ClientHttpRequestFactory or OkHttpClientHttpRequestFactory). å½“å‰Javaçš„http2çš„å®¢æˆ·ç«¯ä¹Ÿå¾ˆå°‘ï¼ŒSpringåªæœ‰Netty and OkHttpæ”¯æŒã€‚è¿™è¾¹æˆ‘ä»¬é€‰ç”¨äº†OkHttpï¼Œå› ä¸ºOkHttpæœ¬æ¥å°±æœ‰åœ¨feign clientä¸­å†…ç½®ã€‚ 1234567891011121314151617&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-web&lt;/artifactId&gt; &lt;version&gt;4.3.0.RC1&lt;/version&gt;&lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-core&lt;/artifactId&gt; &lt;version&gt;4.3.0.RC1&lt;/version&gt;&lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt; &lt;artifactId&gt;okhttp&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt;&lt;/dependency&gt; 2.3 æµè§ˆå™¨å¯¹äºHTTP/2çš„æ”¯æŒé€šè¿‡æµè§ˆå™¨æ”¯æŒhttp2æŸ¥çœ‹ã€‚ 2.4 okhttpç›®å‰, Http/1.1åœ¨å…¨ä¸–ç•Œå¤§èŒƒå›´çš„ä½¿ç”¨ä¸­, ç›´æ¥åºŸå¼ƒè·³åˆ°http/2è‚¯å®šä¸ç°å®. ä¸æ˜¯æ¯ä¸ªç”¨æˆ·çš„æµè§ˆå™¨éƒ½æ”¯æŒhttp/2çš„, ä¹Ÿä¸æ˜¯æ¯ä¸ªæœåŠ¡å™¨éƒ½æ‰“ç®—æ”¯æŒhttp/2çš„, å¦‚æœæˆ‘ä»¬ç›´æ¥å‘é€http/2æ ¼å¼çš„åè®®, æœåŠ¡å™¨åˆä¸æ”¯æŒ, é‚£ä¸æ˜¯æŒ‚æ‰äº†! æ€»ä¸èƒ½ç»´æŠ¤ä¸€ä¸ªå…¨ä¸–ç•Œçš„ç½‘ç«™åˆ—è¡¨, è¡¨ç¤ºå“ªäº›æ”¯æŒhttp/2, å“ªäº›ä¸æ”¯æŒ?ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, ä»ç¨é«˜å±‚æ¬¡ä¸Šæ¥è¯´, å°±æ˜¯ä¸ºäº†æ›´æ–¹ä¾¿åœ°éƒ¨ç½²æ–°åè®®, HTTP/1.1 å¼•å…¥äº† Upgrade æœºåˆ¶. è¿™ä¸ªæœºåˆ¶åœ¨ RFC7230 çš„ã€Œ6.7 Upgradeã€è¿™ä¸€èŠ‚ä¸­æœ‰è¯¦ç»†æè¿°.ç®€å•è¯´æ¥, å°±æ˜¯å…ˆé—®ä¸‹ä½ æ”¯æŒhttp/2ä¹ˆ? å¦‚æœä½ æ”¯æŒ, é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘å°±ç”¨http/2å’Œä½ èŠå¤©. å¦‚æœä½ ä¸æ”¯æŒ, é‚£ä¹ˆæˆ‘è¿˜æ˜¯ç”¨åŸæ¥çš„http/1.1å’Œä½ èŠå¤©. å®¢æˆ·ç«¯åœ¨è¯·æ±‚å¤´éƒ¨ä¸­æŒ‡å®šConnectionå’ŒUpgradeä¸¤ä¸ªå­—æ®µå‘èµ· HTTP/1.1 åè®®å‡çº§. HTTP/2 çš„åè®®åç§°æ˜¯ h2c, ä»£è¡¨ HTTP/2 ClearText. å¦‚æœæœåŠ¡ç«¯ä¸åŒæ„å‡çº§æˆ–è€…ä¸æ”¯æŒ Upgrade æ‰€åˆ—å‡ºçš„åè®®ï¼Œç›´æ¥å¿½ç•¥å³å¯ï¼ˆå½“æˆ HTTP/1.1 è¯·æ±‚ï¼Œä»¥ HTTP/1.1 å“åº”ï¼‰. å¦‚æœæœåŠ¡ç«¯åŒæ„å‡çº§ï¼Œé‚£ä¹ˆéœ€è¦è¿™æ ·å“åº” HTTP/1.1 101 Switching ProtocolsConnection: UpgradeUpgrade: h2c[ HTTP/2 connection â€¦ ] HTTP Upgrade å“åº”çš„çŠ¶æ€ç æ˜¯ 101ï¼Œå¹¶ä¸”å“åº”æ­£æ–‡å¯ä»¥ä½¿ç”¨æ–°åè®®å®šä¹‰çš„æ•°æ®æ ¼å¼ã€‚ è¿™æ ·å°±å¯ä»¥å®Œæˆä»http/1.1å‡çº§åˆ°http/2äº†. åŒæ ·ä¹Ÿå¯ä»¥ä»http/1.1å‡çº§åˆ°WebSocket.OkHttpä½¿ç”¨äº†è¯·æ±‚åè®®çš„åå•†å‡çº§, æ— è®ºæ˜¯1.1è¿˜æ˜¯2, éƒ½å…ˆåªä»¥1.1æ¥å‘é€, å¹¶åœ¨å‘é€çš„ä¿¡æ¯å¤´é‡ŒåŒ…å«åè®®å‡çº§å­—æ®µ. æ¥ä¸‹æ¥å°±çœ‹æœåŠ¡å™¨æ˜¯å¦æ”¯æŒåè®®å‡çº§äº†. OkHttpä½¿ç”¨çš„åè®®å‡çº§å­—æ®µæ˜¯ALPN, å¦‚æœæœ‰å…´è¶£, å¯ä»¥æ›´æ·±å…¥çš„æŸ¥é˜…ç›¸å…³èµ„æ–™. 3. æ€»ç»“æ€»ä½“çœ‹æ¥ï¼Œç°åœ¨Spring boot æ˜¯å¯ä»¥æ”¯æŒHTTP/2 serverå’Œclientã€‚ç°æœ‰é¡¹ç›®çš„apiæ¥å£é¢å‘ç§»åŠ¨ç«¯å’Œwebç«¯ï¼Œwebæµè§ˆå™¨å¯¹äºhttp2çš„æ”¯æŒåœ¨ä¸Šæ–‡å·²ç»è¯´æ˜ã€‚ å‚è€ƒèµ„æ–™ï¼šOkHttpä½¿ç”¨å®Œå…¨æ•™ç¨‹Spring Boot with HTTP/2 â€“ Start a server and make REST calls as a clientHTTPS ä¸ HTTP2 åè®®åˆ†æ]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>HTTP2</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[HTTPS vs HTTP 1.1 vs HTTP 2]]></title>
    <url>%2F2017%2F08%2F26%2FHTTP2%2F</url>
    <content type="text"><![CDATA[1. HTTPSåè®®åŸç†åˆ†æ1.1 éœ€è¦è§£å†³çš„é—®é¢˜ èº«ä»½éªŒè¯:ç¡®ä¿é€šä¿¡åŒæ–¹èº«ä»½çš„çœŸå®æ€§ã€‚ é€šä¿¡åŠ å¯†:é€šä¿¡çš„æœºå¯†æ€§ã€å®Œæ•´æ€§ä¾èµ–äºç®—æ³•ä¸å¯†é’¥ï¼Œé€šä¿¡åŒæ–¹æ˜¯å¦‚ä½•é€‰æ‹©ç®—æ³•ä¸å¯†é’¥çš„ã€‚ 1.2ç›¸å…³æ¦‚å¿µ æ•°å­—è¯ä¹¦ CAï¼ˆcertification authorityï¼‰:æ•°å­—è¯ä¹¦çš„ç­¾å‘æœºæ„ã€‚ HTTPSåè®®ã€SSLåè®®ã€TLSåè®®ã€æ¡æ‰‹åè®®çš„å…³ç³» HTTPSæ˜¯Hypertext Transfer Protocol over Secure Socket Layerçš„ç¼©å†™ï¼Œå³HTTP over SSLï¼Œå¯ç†è§£ä¸ºåŸºäºSSLçš„HTTPåè®®ã€‚ HTTPSåè®®å®‰å…¨æ˜¯ç”±SSLåè®®ï¼ˆç›®å‰å¸¸ç”¨çš„ï¼Œæœ¬æ–‡åŸºäºTLS 1.2è¿›è¡Œåˆ†æï¼‰å®ç°çš„ã€‚ SSLåè®®æ˜¯ä¸€ç§è®°å½•åè®®ï¼Œæ‰©å±•æ€§è‰¯å¥½ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ·»åŠ å­åè®®ï¼Œè€Œæ¡æ‰‹åè®®ä¾¿æ˜¯SSLåè®®çš„ä¸€ä¸ªå­åè®®ã€‚ TLSåè®®æ˜¯SSLåè®®çš„åç»­ç‰ˆæœ¬ï¼Œæœ¬æ–‡ä¸­æ¶‰åŠçš„SSLåè®®é»˜è®¤æ˜¯TLSåè®®1.2ç‰ˆæœ¬ã€‚ HTTPSåè®®çš„å®‰å…¨æ€§ç”±SSLåè®®å®ç°ï¼Œå½“å‰ä½¿ç”¨çš„TLSåè®®1.2ç‰ˆæœ¬åŒ…å«äº†å››ä¸ªæ ¸å¿ƒå­åè®®ï¼šæ¡æ‰‹åè®®ã€å¯†é’¥é…ç½®åˆ‡æ¢åè®®ã€åº”ç”¨æ•°æ®åè®®åŠæŠ¥è­¦åè®®ã€‚ 1.3 æ¡æ‰‹åè®®æ¡æ‰‹åè®®çš„ä½œç”¨ä¾¿æ˜¯é€šä¿¡åŒæ–¹è¿›è¡Œèº«ä»½ç¡®è®¤ã€åå•†å®‰å…¨è¿æ¥å„å‚æ•°ï¼ˆåŠ å¯†ç®—æ³•ã€å¯†é’¥ç­‰ï¼‰ï¼Œç¡®ä¿åŒæ–¹èº«ä»½çœŸå®å¹¶ä¸”åå•†çš„ç®—æ³•ä¸å¯†é’¥èƒ½å¤Ÿä¿è¯é€šä¿¡å®‰å…¨ã€‚åè®®äº¤äº’å›¾ï¼š ClientHelloæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†å®¢æˆ·ç«¯å¯ç”¨äºå»ºç«‹åŠ å¯†é€šé“çš„å‚æ•°é›†åˆï¼Œä¸€æ¬¡æ€§å‘é€ç»™æœåŠ¡ç«¯ã€‚ ServerHelloæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œåœ¨ClientHelloå‚æ•°é›†åˆä¸­é€‰æ‹©é€‚åˆçš„å‚æ•°ï¼Œå¹¶å°†æœåŠ¡ç«¯ç”¨äºå»ºç«‹åŠ å¯†é€šé“çš„å‚æ•°å‘é€ç»™å®¢æˆ·ç«¯ã€‚ Certificateæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†æœåŠ¡ç«¯è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä¾›å®¢æˆ·ç«¯è¿›è¡ŒæœåŠ¡ç«¯èº«ä»½æ ¡éªŒã€‚ ServerKeyExchangeæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†éœ€è¦æœåŠ¡ç«¯æä¾›çš„å¯†é’¥äº¤æ¢çš„é¢å¤–å‚æ•°ï¼Œä¼ ç»™å®¢æˆ·ç«¯ã€‚æœ‰çš„ç®—æ³•ä¸éœ€è¦é¢å¤–å‚æ•°ï¼Œåˆ™ServerKeyExchangeæ¶ˆæ¯å¯ä¸å‘é€ã€‚ ServerHelloDoneæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œé€šçŸ¥å®¢æˆ·ç«¯ServerHelloé˜¶æ®µçš„æ•°æ®å‡å·²å‘é€å®Œæ¯•ï¼Œç­‰å¾…å®¢æˆ·ç«¯ä¸‹ä¸€æ­¥æ¶ˆæ¯ã€‚ ClientKeyExchangeæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†å®¢æˆ·ç«¯éœ€è¦ä¸ºå¯†é’¥äº¤æ¢æä¾›çš„æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ã€‚ ChangeCipherSpecæ¶ˆæ¯çš„ä½œç”¨ï¼Œä¾¿æ˜¯å£°æ˜åç»­æ¶ˆæ¯å‡é‡‡ç”¨å¯†é’¥åŠ å¯†ã€‚åœ¨æ­¤æ¶ˆæ¯åï¼Œæˆ‘ä»¬åœ¨WireSharkä¸Šä¾¿çœ‹ä¸åˆ°æ˜æ–‡ä¿¡æ¯äº†ã€‚ Finishedæ¶ˆæ¯çš„ä½œç”¨ï¼Œæ˜¯å¯¹æ¡æ‰‹é˜¶æ®µæ‰€æœ‰æ¶ˆæ¯è®¡ç®—æ‘˜è¦ï¼Œå¹¶å‘é€ç»™å¯¹æ–¹æ ¡éªŒï¼Œé¿å…é€šä¿¡è¿‡ç¨‹ä¸­è¢«ä¸­é—´äººæ‰€ç¯¡æ”¹ã€‚ 1.4 æ€»ç»“HTTPSå¦‚ä½•ä¿è¯é€šä¿¡å®‰å…¨ï¼Œé€šè¿‡æ¡æ‰‹åè®®çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»æœ‰æ‰€äº†è§£ã€‚ä½†æ˜¯ï¼Œåœ¨å…¨é¢ä½¿ç”¨HTTPSå‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜â€”â€”HTTPSæ€§èƒ½ã€‚ç›¸å¯¹HTTPåè®®æ¥è¯´ï¼ŒHTTPSåè®®å»ºç«‹æ•°æ®é€šé“çš„æ›´åŠ è€—æ—¶ï¼Œè‹¥ç›´æ¥éƒ¨ç½²åˆ°Appä¸­ï¼ŒåŠ¿å¿…é™ä½æ•°æ®ä¼ é€’çš„æ•ˆç‡ï¼Œé—´æ¥å½±å“ç”¨æˆ·ä½“éªŒã€‚ 2. HTTP 22.1 HTTP1.xåè®®éšç€äº’è”ç½‘çš„å¿«é€Ÿå‘å±•ï¼ŒHTTP1.xåè®®å¾—åˆ°äº†è¿…çŒ›å‘å±•ï¼Œä½†å½“Appä¸€ä¸ªé¡µé¢åŒ…å«äº†æ•°åä¸ªè¯·æ±‚æ—¶ï¼ŒHTTP1.xåè®®çš„å±€é™æ€§ä¾¿æš´éœ²äº†å‡ºæ¥ï¼š æ¯ä¸ªè¯·æ±‚ä¸å“åº”éœ€è¦å•ç‹¬å»ºç«‹é“¾è·¯è¿›è¡Œè¯·æ±‚(Connectionå­—æ®µèƒ½å¤Ÿè§£å†³éƒ¨åˆ†é—®é¢˜)ï¼Œæµªè´¹èµ„æºã€‚ æ¯ä¸ªè¯·æ±‚ä¸å“åº”éƒ½éœ€è¦æ·»åŠ å®Œæ•´çš„å¤´ä¿¡æ¯ï¼Œåº”ç”¨æ•°æ®ä¼ è¾“æ•ˆç‡è¾ƒä½ã€‚ é»˜è®¤æ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼Œæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å®¹æ˜“è¢«ç›‘å¬ä¸ç¯¡æ”¹ã€‚ 2.2 HTTP 2ä»‹ç»HTTP2æ­£æ˜¯ä¸ºäº†è§£å†³HTTP1.xæš´éœ²å‡ºæ¥çš„é—®é¢˜è€Œè¯ç”Ÿçš„ã€‚ è¯´åˆ°HTTP2ä¸å¾—ä¸æspdyã€‚ç”±äºHTTP1.xæš´éœ²å‡ºæ¥çš„é—®é¢˜ï¼ŒGoogleè®¾è®¡äº†å…¨æ–°çš„åä¸ºspdyçš„æ–°åè®®ã€‚spdyåœ¨äº”å±‚åè®®æ ˆçš„TCPå±‚ä¸HTTPå±‚å¼•å…¥äº†ä¸€ä¸ªæ–°çš„é€»è¾‘å±‚ä»¥æé«˜æ•ˆç‡ã€‚spdyæ˜¯ä¸€ä¸ªä¸­é—´å±‚ï¼Œå¯¹TCPå±‚ä¸HTTPå±‚æœ‰å¾ˆå¥½çš„å…¼å®¹ï¼Œä¸éœ€è¦ä¿®æ”¹HTTPå±‚å³å¯æ”¹å–„åº”ç”¨æ•°æ®ä¼ è¾“é€Ÿåº¦ã€‚spdyé€šè¿‡å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œä½¿å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åªéœ€è¦ä¿æŒä¸€æ¡é“¾æ¥å³å¯å¹¶å‘å¤šæ¬¡æ•°æ®äº¤äº’ï¼Œæé«˜äº†é€šä¿¡æ•ˆç‡ã€‚è€ŒHTTP2ä¾¿å£«åŸºäºspdyçš„æ€è·¯å¼€å‘çš„ã€‚é€šè¿‡æµä¸å¸§æ¦‚å¿µçš„å¼•å…¥ï¼Œç»§æ‰¿äº†spdyçš„å¤šè·¯å¤ç”¨ï¼Œå¹¶å¢åŠ äº†ä¸€äº›å®ç”¨ç‰¹æ€§ã€‚ æ–°ç‰¹æ€§ï¼š å¤šè·¯å¤ç”¨ å‹ç¼©å¤´ä¿¡æ¯ å¯¹è¯·æ±‚åˆ’åˆ†ä¼˜å…ˆçº§ æ”¯æŒæœåŠ¡ç«¯Pushæ¶ˆæ¯åˆ°å®¢æˆ·ç«¯ HTTP2ç›®å‰åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œåªç”¨äºHTTPSåè®®åœºæ™¯ä¸‹ï¼Œé€šè¿‡æ¡æ‰‹é˜¶æ®µClientHelloä¸ServerHelloçš„extensionå­—æ®µåå•†è€Œæ¥ï¼Œæ‰€ä»¥ç›®å‰HTTP2çš„ä½¿ç”¨åœºæ™¯ï¼Œéƒ½æ˜¯é»˜è®¤å®‰å…¨åŠ å¯†çš„ã€‚ æŸ¥çœ‹äº†wikiå‘ç°ï¼š Netty and OkHttp are the only two implementations supported by Spring. 2.3 åè®®åå•†HTTP2åè®®çš„åå•†æ˜¯åœ¨æ¡æ‰‹é˜¶æ®µè¿›è¡Œçš„ã€‚ åå•†çš„æ–¹å¼æ˜¯é€šè¿‡æ¡æ‰‹åè®®extensionæ‰©å±•å­—æ®µè¿›è¡Œæ‰©å±•ï¼Œæ–°å¢Application Layer Protocol Negotiationå­—æ®µè¿›è¡Œåå•†ã€‚ åœ¨æ¡æ‰‹åè®®çš„ClientHelloé˜¶æ®µï¼Œå®¢æˆ·ç«¯å°†æ‰€æ”¯æŒçš„åè®®åˆ—è¡¨å¡«å…¥Application Layer Protocol Negotiationå­—æ®µï¼Œä¾›æœåŠ¡ç«¯è¿›è¡ŒæŒ‘é€‰ã€‚ 2.4 å¤šè·¯å¤ç”¨Multipexingåœ¨HTTP2ä¸­ï¼ŒåŒä¸€åŸŸåä¸‹çš„è¯·æ±‚ï¼Œå¯é€šè¿‡åŒä¸€æ¡TCPé“¾è·¯è¿›è¡Œä¼ è¾“ï¼Œä½¿å¤šä¸ªè¯·æ±‚ä¸å¿…å•ç‹¬å»ºç«‹é“¾è·¯ï¼ŒèŠ‚çœå»ºç«‹é“¾è·¯çš„å¼€é”€ã€‚ ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼ŒHTTP2æå‡ºäº†æµä¸å¸§çš„æ¦‚å¿µï¼Œæµä»£è¡¨è¯·æ±‚ä¸å“åº”ï¼Œè€Œè¯·æ±‚ä¸å“åº”å…·ä½“çš„æ•°æ®åˆ™åŒ…è£…ä¸ºå¸§ï¼Œå¯¹é“¾è·¯ä¸­ä¼ è¾“çš„æ•°æ®é€šè¿‡æµIDä¸å¸§ç±»å‹è¿›è¡ŒåŒºåˆ†å¤„ç†ã€‚ä¸‹å›¾æ˜¯å¤šè·¯å¤ç”¨çš„æŠ½è±¡å›¾ï¼Œæ¯ä¸ªå—ä»£è¡¨ä¸€å¸§ï¼Œè€Œç›¸åŒé¢œè‰²çš„å—åˆ™ä»£è¡¨æ˜¯åŒä¸€ä¸ªæµã€‚ å½’çº³ä¸‹okhttpçš„å¤šè·¯å¤ç”¨å®ç°æ€è·¯ï¼š é€šè¿‡è¯·æ±‚çš„Addressä¸è¿æ¥æ± ä¸­ç°æœ‰è¿æ¥Addressä¾æ¬¡åŒ¹é…ï¼Œé€‰å‡ºå¯ç”¨çš„Connectionã€‚ é€šè¿‡Http2xStreamåˆ›å»ºçš„FramedStreamåœ¨å‘é€äº†è¯·æ±‚åï¼Œå°†FramedStreamå¯¹è±¡ä¸StreamIDçš„æ˜ å°„å…³ç³»ç¼“å­˜åˆ°FramedConnectionä¸­ã€‚ æ”¶åˆ°æ¶ˆæ¯åï¼ŒFramedConnectionè§£æå¸§ä¿¡æ¯ï¼Œåœ¨Mapä¸­é€šè¿‡è§£æçš„StreamIDé€‰å‡ºç¼“å­˜çš„FramedStreamï¼Œå¹¶å”¤é†’FramedStreamè¿›è¡ŒResponseçš„å¤„ç†ã€‚ 2.5 å‹ç¼©å¤´ä¿¡æ¯HTTP2ä¸ºäº†è§£å†³HTTP1.xä¸­å¤´ä¿¡æ¯è¿‡å¤§å¯¼è‡´æ•ˆç‡ä½ä¸‹çš„é—®é¢˜ï¼Œæå‡ºçš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯å‹ç¼©å¤´éƒ¨ä¿¡æ¯ã€‚å…·ä½“çš„å‹ç¼©æ–¹å¼ï¼Œåˆ™å¼•å…¥äº†HPACKã€‚ HPACKå‹ç¼©ç®—æ³•æ˜¯ä¸“é—¨ä¸ºHTTP2å¤´éƒ¨å‹ç¼©æœåŠ¡çš„ã€‚ä¸ºäº†è¾¾åˆ°å‹ç¼©å¤´éƒ¨ä¿¡æ¯çš„ç›®çš„ï¼ŒHPACKå°†å¤´éƒ¨å­—æ®µç¼“å­˜ä¸ºç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•IDä»£è¡¨å¤´éƒ¨å­—æ®µã€‚å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ç»´æŠ¤ç´¢å¼•è¡¨ï¼Œé€šä¿¡è¿‡ç¨‹ä¸­å°½å¯èƒ½é‡‡ç”¨ç´¢å¼•è¿›è¡Œé€šä¿¡ï¼Œæ”¶åˆ°ç´¢å¼•åæŸ¥è¯¢ç´¢å¼•è¡¨ï¼Œæ‰èƒ½è§£æå‡ºçœŸæ­£çš„å¤´éƒ¨ä¿¡æ¯ã€‚ HPACKç´¢å¼•è¡¨åˆ’åˆ†ä¸ºåŠ¨æ€ç´¢å¼•è¡¨ä¸é™æ€ç´¢å¼•è¡¨ï¼ŒåŠ¨æ€ç´¢å¼•è¡¨æ˜¯HTTP2åè®®é€šä¿¡è¿‡ç¨‹ä¸­ä¸¤ç«¯åŠ¨æ€ç»´æŠ¤çš„ç´¢å¼•è¡¨ï¼Œè€Œé™æ€ç´¢å¼•è¡¨æ˜¯ç¡¬ç¼–ç è¿›åè®®ä¸­çš„ç´¢å¼•è¡¨ã€‚ ä½œä¸ºåˆ†æHPACKå‹ç¼©å¤´ä¿¡æ¯çš„åŸºç¡€ï¼Œéœ€è¦å…ˆä»‹ç»HPACKå¯¹ç´¢å¼•ä»¥åŠå¤´éƒ¨å­—ç¬¦ä¸²çš„è¡¨ç¤ºæ–¹å¼ã€‚ ç´¢å¼• ç´¢å¼•ä»¥æ•´å‹æ•°å­—è¡¨ç¤ºï¼Œç”±äºHPACKéœ€è¦è€ƒè™‘å‹ç¼©ä¸ç¼–è§£ç é—®é¢˜ï¼Œæ‰€ä»¥æ•´å‹æ•°å­—ç»“æ„å®šä¹‰ä¸‹å›¾æ‰€ç¤ºï¼š ç±»åˆ«æ ‡è¯†:é€šè¿‡ç±»åˆ«æ ‡è¯†è¿›è¡ŒHPACKç±»åˆ«åˆ†ç±»ï¼ŒæŒ‡å¯¼åç»­ç¼–è§£ç æ“ä½œï¼Œå¸¸è§çš„æœ‰1ï¼Œ01ï¼Œ01000000ç­‰å…«ä¸ªç±»åˆ«ã€‚ é¦–å­—èŠ‚ä½ä½æ•´å‹:é¦–å­—èŠ‚æ’é™¤ç±»åˆ«æ ‡è¯†çš„å‰©ä½™ä½ï¼Œç”¨äºè¡¨ç¤ºä½ä½æ•´å‹ã€‚è‹¥æ•°å€¼å¤§äºå‰©ä½™ä½æ‰€èƒ½è¡¨ç¤ºçš„å®¹é‡ï¼Œåˆ™éœ€è¦åç»­å­—èŠ‚è¡¨ç¤ºé«˜ä½æ•´å‹ã€‚ ç»“æŸæ ‡è¯†:è¡¨ç¤ºæ­¤å­—èŠ‚æ˜¯å¦ä¸ºæ•´å‹è§£æç»ˆæ­¢å­—èŠ‚ã€‚ é«˜ä½æ•´å‹:å­—èŠ‚ä½™ä¸‹7bitï¼Œç”¨äºå¡«å……æ•´å‹é«˜ä½ã€‚]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>HTTPS</tag>
        <tag>HTTP2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mongodb é›†ç¾¤åŸºç¡€]]></title>
    <url>%2F2017%2F08%2F10%2Fmongodb%E9%9B%86%E7%BE%A4%E5%9F%BA%E7%A1%80%2F</url>
    <content type="text"><![CDATA[1. MongoDBä»‹ç» MongoDB æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„é«˜æ€§èƒ½,å¼€æº,æ¨¡å¼è‡ªç”±,é¢å‘æ–‡æ¡£çš„æ•°æ®åº“ã€‚ å®ƒä½¿ç”¨ C++ç¼–å†™ã€‚MongoDB åŒ…å«ä¸€ä¸‹ç‰¹ç‚¹: é¢å‘é›†åˆçš„å­˜å‚¨:é€‚åˆå­˜å‚¨å¯¹è±¡åŠJSONå½¢å¼çš„æ•°æ®ã€‚ åŠ¨æ€æŸ¥è¯¢:Mongo æ”¯æŒä¸°å¯Œçš„æŸ¥è¯¢æ–¹å¼,æŸ¥è¯¢æŒ‡ä»¤ä½¿ç”¨ JSON å½¢å¼çš„æ ‡è®°,å¯è½»æ˜“æŸ¥è¯¢æ–‡æ¡£ä¸­å†…åµŒçš„å¯¹è±¡åŠæ•°ç»„ã€‚ å®Œæ•´çš„ç´¢å¼•æ”¯æŒ:åŒ…æ‹¬æ–‡æ¡£å†…åµŒå¯¹è±¡åŠæ•°ç»„ã€‚Mongo çš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šåˆ†ææŸ¥è¯¢è¡¨è¾¾å¼,å¹¶ç”Ÿæˆä¸€ä¸ªé«˜æ•ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚ æŸ¥è¯¢ç›‘è§†:MongoåŒ…å«ä¸€ä¸ªç›‘æ§å·¥å…·ç”¨äºåˆ†ææ•°æ®åº“æ“ä½œæ€§èƒ½ã€‚ å¤åˆ¶åŠè‡ªåŠ¨æ•…éšœè½¬ç§»:Mongo æ•°æ®åº“æ”¯æŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®å¤åˆ¶,æ”¯æŒä¸»-ä»æ¨¡å¼åŠæœåŠ¡å™¨ä¹‹é—´çš„ç›¸äº’å¤åˆ¶ã€‚å¤åˆ¶çš„ä¸»è¦ç›®çš„æ˜¯æä¾›å†—ä½™åŠè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚ é«˜æ•ˆçš„ä¼ ç»Ÿå­˜å‚¨æ–¹å¼:æ”¯æŒäºŒè¿›åˆ¶æ•°æ®åŠå¤§å‹å¯¹è±¡(å¦‚:ç…§ç‰‡æˆ–å›¾ç‰‡)ã€‚ è‡ªåŠ¨åˆ†ç‰‡ä»¥æ”¯æŒäº‘çº§åˆ«çš„ä¼¸ç¼©æ€§:è‡ªåŠ¨åˆ†ç‰‡åŠŸèƒ½æ”¯æŒæ°´å¹³çš„æ•°æ®åº“é›†ç¾¤,å¯åŠ¨æ€æ·»åŠ é¢å¤–çš„æœºå™¨ã€‚ 2.Replica Seté›†ç¾¤å½“ä¸­åŒ…å«äº†å¤šä»½æ•°æ®ï¼Œä¿è¯ä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œå¤‡èŠ‚ç‚¹èƒ½ç»§ç»­æä¾›æ•°æ®æœåŠ¡ï¼Œæä¾›çš„å‰æå°±æ˜¯æ•°æ®éœ€è¦å’Œä¸»èŠ‚ç‚¹ä¸€è‡´ã€‚ Mongodb(M)è¡¨ç¤ºä¸»èŠ‚ç‚¹ï¼ŒMongodb(S)è¡¨ç¤ºå¤‡èŠ‚ç‚¹ï¼ŒMongodb(A)è¡¨ç¤ºä»²è£èŠ‚ç‚¹ã€‚ä¸»å¤‡èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œä»²è£èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ã€‚å®¢æˆ·ç«¯åŒæ—¶è¿æ¥ä¸»èŠ‚ç‚¹ä¸å¤‡èŠ‚ç‚¹ï¼Œä¸è¿æ¥ä»²è£èŠ‚ç‚¹ã€‚ é»˜è®¤è®¾ç½®ä¸‹ï¼Œä¸»èŠ‚ç‚¹æä¾›æ‰€æœ‰å¢åˆ æŸ¥æ”¹æœåŠ¡ï¼Œå¤‡èŠ‚ç‚¹ä¸æä¾›ä»»ä½•æœåŠ¡ã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡è®¾ç½®ä½¿å¤‡èŠ‚ç‚¹æä¾›æŸ¥è¯¢æœåŠ¡ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸»èŠ‚ç‚¹çš„å‹åŠ›ï¼Œå½“å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®æŸ¥è¯¢æ—¶ï¼Œè¯·æ±‚è‡ªåŠ¨è½¬åˆ°å¤‡èŠ‚ç‚¹ä¸Šã€‚è¿™ä¸ªè®¾ç½®å«åšRead Preference Modesï¼ŒåŒæ—¶Javaå®¢æˆ·ç«¯æä¾›äº†ç®€å•çš„é…ç½®æ–¹å¼ï¼Œå¯ä»¥ä¸å¿…ç›´æ¥å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚ ä»²è£èŠ‚ç‚¹æ˜¯ä¸€ç§ç‰¹æ®Šçš„èŠ‚ç‚¹ï¼Œå®ƒæœ¬èº«å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯å†³å®šå“ªä¸€ä¸ªå¤‡èŠ‚ç‚¹åœ¨ä¸»èŠ‚ç‚¹æŒ‚æ‰ä¹‹åæå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä¸éœ€è¦è¿æ¥æ­¤èŠ‚ç‚¹ã€‚è¿™é‡Œè™½ç„¶åªæœ‰ä¸€ä¸ªå¤‡èŠ‚ç‚¹ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦ä¸€ä¸ªä»²è£èŠ‚ç‚¹æ¥æå‡å¤‡èŠ‚ç‚¹çº§åˆ«ã€‚æˆ‘å¼€å§‹ä¹Ÿä¸ç›¸ä¿¡å¿…é¡»è¦æœ‰ä»²è£èŠ‚ç‚¹ï¼Œä½†æ˜¯è‡ªå·±ä¹Ÿè¯•è¿‡æ²¡ä»²è£èŠ‚ç‚¹çš„è¯ï¼Œä¸»èŠ‚ç‚¹æŒ‚äº†å¤‡èŠ‚ç‚¹è¿˜æ˜¯å¤‡èŠ‚ç‚¹ï¼Œæ‰€ä»¥å’±ä»¬è¿˜æ˜¯éœ€è¦å®ƒçš„ã€‚ 3.Sharding å’ŒReplica Setç±»ä¼¼ï¼Œéƒ½éœ€è¦ä¸€ä¸ªä»²è£èŠ‚ç‚¹ï¼Œä½†æ˜¯Shardingè¿˜éœ€è¦é…ç½®èŠ‚ç‚¹å’Œè·¯ç”±èŠ‚ç‚¹ã€‚ é›†ç¾¤æ­å»ºæ–¹å¼é¦–é€‰Replica Setï¼Œåªæœ‰çœŸçš„æ˜¯å¤§æ•°æ®ï¼ŒShardingæ‰èƒ½æ˜¾ç°å¨åŠ›ï¼Œæ¯•ç«Ÿå¤‡èŠ‚ç‚¹åŒæ­¥æ•°æ®æ˜¯éœ€è¦æ—¶é—´çš„ã€‚Shardingå¯ä»¥å°†å¤šç‰‡æ•°æ®é›†ä¸­åˆ°è·¯ç”±èŠ‚ç‚¹ä¸Šè¿›è¡Œä¸€äº›å¯¹æ¯”ï¼Œç„¶åå°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯æ•ˆç‡è¿˜æ˜¯æ¯”è¾ƒä½çš„è¯´ã€‚ æˆ‘è‡ªå·±æœ‰æµ‹è¯•è¿‡ï¼Œä¸è¿‡å…·ä½“çš„æœºå™¨é…ç½®å·²ç»ä¸è®°å¾—äº†ã€‚Replica Setçš„ipsåœ¨æ•°æ®è¾¾åˆ°1400wæ¡æ—¶åŸºæœ¬èƒ½è¾¾åˆ°1000å·¦å³ï¼Œè€ŒShardingåœ¨300wæ—¶å·²ç»ä¸‹é™åˆ°500ipsäº†ï¼Œä¸¤è€…çš„å•ä½æ•°æ®å¤§å°å¤§æ¦‚æ˜¯10kbã€‚å¤§å®¶åœ¨åº”ç”¨çš„æ—¶å€™è¿˜æ˜¯å¤šå¤šåšä¸‹æ€§èƒ½æµ‹è¯•ï¼Œæ¯•ç«Ÿä¸åƒRedisæœ‰benchmarkã€‚ Mongodbç°åœ¨ç”¨çš„è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œä½†æ˜¯ä¸ªäººè§‰å¾—é…ç½®å¤ªå¤šäº†ã€‚æˆ‘çœ‹å®˜ç½‘éƒ½çœ‹äº†å¥½å¤šå¤©ï¼Œæ‰æŠŠé›†ç¾¤æ­å»ºçš„é…ç½®å’Œæ³¨æ„è¦ç‚¹å¼„æ˜ç™½ã€‚è€Œä¸”ç”¨è¿‡çš„äººåº”è¯¥çŸ¥é“mongodbåƒå†…å­˜çš„é—®é¢˜ï¼Œè§£å†³åŠæ³•åªèƒ½é€šè¿‡ulimitæ¥æ§åˆ¶å†…å­˜ä½¿ç”¨é‡ï¼Œä½†æ˜¯å¦‚æœæ§åˆ¶ä¸å¥½çš„è¯ï¼Œmongodbä¼šæŒ‚æ‰ PS: åé¢ç»§ç»­è¡¥å……ã€‚]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
        <tag>Cluster</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Cloud å…¥é—¨]]></title>
    <url>%2F2017%2F07%2F18%2Fspring-cloud%2F</url>
    <content type="text"><![CDATA[1. å¾®æœåŠ¡æ¶æ„å¾®æœåŠ¡æ¶æ„ï¼ˆMicro-Service Archetictureï¼‰æ˜¯å½“ä¸‹æµè¡Œçš„æ¶æ„é£æ ¼ï¼Œæ—¨åœ¨é€šè¿‡å°†åŠŸèƒ½æ¨¡å—åˆ†è§£åˆ°å„ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿä¸­ä»¥å®ç°è§£è€¦ï¼Œå®ƒå¹¶æ²¡æœ‰ä¸€æˆä¸å˜çš„è§„å®šï¼Œè€Œæ˜¯éœ€è¦æ ¹æ®ä¸šåŠ¡æ¥åšè®¾è®¡[æè´æ˜Š,2017]ã€‚å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¯ä¸ªå¾®æœåŠ¡æ¨¡å—åªæ˜¯å¯¹ç®€å•ã€ç‹¬ç«‹ã€æ˜ç¡®çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡REST APIè¿”å›å¤„ç†ç»“æœç»™å¤–éƒ¨ã€‚åœ¨å¾®æœåŠ¡æ¨å¹¿å®è·µè§’åº¦æ¥çœ‹ï¼Œå¾®æœåŠ¡å°†æ•´ä¸ªç³»ç»Ÿè¿›è¡Œæ‹†åˆ†ï¼Œæ‹†åˆ†æˆæ›´å°çš„ç²’åº¦ï¼Œä¿æŒè¿™äº›æœåŠ¡ç‹¬ç«‹è¿è¡Œï¼Œåº”ç”¨å®¹å™¨åŒ–æŠ€æœ¯å°†å¾®æœåŠ¡ç‹¬ç«‹è¿è¡Œåœ¨å®¹å™¨ä¸­ã€‚è¿‡å»è®¾è®¡æ¶æ„æ—¶ï¼Œæ˜¯åœ¨å†…å­˜ä¸­ä»¥å‚æ•°æˆ–å¯¹è±¡çš„æ–¹å¼å®ç°ç²’åº¦ç»†åŒ–ã€‚å¾®æœåŠ¡ä½¿ç”¨å„ä¸ªå­æœåŠ¡æ§åˆ¶æ¨¡å—çš„æ€æƒ³ä»£æ›¿æ€»çº¿ã€‚ä¸åŒçš„ä¸šåŠ¡è¦æ±‚ï¼ŒæœåŠ¡æ§åˆ¶æ¨¡å—è‡³å°‘åŒ…å«æœåŠ¡çš„å‘å¸ƒã€æ³¨å†Œã€è·¯ç”±ã€ä»£ç†åŠŸèƒ½ã€‚ 2. vs å•ä½“åº”ç”¨æ¶æ„å¾®æœåŠ¡æ¶æ„æ¨¡å¼ç›¸æ¯”äºå•ä½“åº”ç”¨æ¶æ„ï¼Œæœ‰å¾ˆå¤šä¼˜åŠ¿ã€‚ é¦–å…ˆï¼Œå·¨å¤§çš„å•ä½“å¼åº”ç”¨æ‹†åˆ†ä¸ºå¤šä¸ªå¾®æœåŠ¡ï¼Œé™ä½äº†å¤æ‚æ€§ã€‚åœ¨å…·æœ‰ä¹‹å‰å•ä½“åº”ç”¨åŠŸèƒ½çš„åŒæ—¶ï¼Œå•ä½“åº”ç”¨è¢«æ‹†åˆ†ä¸ºå¤šä¸ªå¯ç®¡ç†çš„å¾®æœåŠ¡ã€‚æ¯ä¸ªå¾®æœåŠ¡éƒ½å…·æœ‰å®šä¹‰æ¸…æ¥šçš„è¾¹ç•Œï¼Œä½¿ç”¨è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æˆ–è€…æ¶ˆæ¯é©±åŠ¨APIã€‚æ‹†åˆ†åçš„å¾®æœåŠ¡æ¨¡å—ï¼Œç²’åº¦å°ï¼Œå¾ˆå®¹æ˜“å¼€å‘å’Œç»´æŠ¤ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼é™ä½äº†å•ä½“å¼ç¼–ç çš„éš¾åº¦ï¼Œå¹¶ä¸”åŠŸèƒ½æä¾›äº†æ¨¡å—åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚ ç¬¬äºŒï¼Œå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œä¸“é—¨å¼€å‘å›¢é˜Ÿè´Ÿè´£å¼€å‘ä¸€ä¸ªå­æœåŠ¡ã€‚æ¯ä¸ªå¼€å‘å›¢é˜Ÿå¯ä»¥è‡ªä¸»é€‰æ‹©æŠ€æœ¯æ ˆï¼Œæä¾›APIæ¥å£ã€‚å½“ç„¶ï¼Œè®¸å¤šå…¬å¸å°†æŠ€æœ¯æ ˆç»Ÿä¸€ï¼Œåªæä¾›ç‰¹å®šé€‰æ‹©çš„æŠ€æœ¯ã€‚ç„¶åï¼Œè¿™ç§è‡ªç”±ä½¿å¾—å¼€å‘å›¢é˜Ÿä¸éœ€è¦è¢«è¿«ä½¿ç”¨ç‰¹å®šçš„é‚£äº›æŠ€æœ¯ï¼Œä»–ä»¬å¯ä»¥è‡ªç”±åœ°é€‰æ‹©é€‚åˆè¯¥å¾®æœåŠ¡çš„æŠ€æœ¯ã€‚ç”šè‡³äºï¼Œé‡æ„ä¹‹å‰çš„ä»£ç ä¹Ÿå˜å¾—å¾ˆä¾¿æ·ã€‚ ç¬¬ä¸‰ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„éƒ¨ç½²ã€‚å¼€å‘å›¢é˜Ÿä¸å†éœ€è¦åè°ƒå…¶å®ƒæœåŠ¡éƒ¨ç½²å¯¹æœ¬æœåŠ¡çš„å½±å“ã€‚è¿™æ ·çš„ç‰¹æ€§å¤§å¤§åŠ å¿«äº†éƒ¨ç½²é€Ÿåº¦ã€‚å¾®æœåŠ¡æ¶æ„æ¨¡å¼ä½¿å¾—æŒç»­åŒ–éƒ¨ç½²æˆä¸ºå¯èƒ½ã€‚ æœ€åï¼Œå¾®æœåŠ¡æ¶æ„æ¨¡å¼ä½¿å¾—æ¯ä¸ªå¾®æœåŠ¡åº”ç”¨éƒ½å¯ä»¥è¢«ç‹¬ç«‹æ‰©å±•ã€‚å•ä½“æ¶æ„åº”ç”¨ä¹Ÿå¯ä»¥æ¨ªå‘æ‰©å±•ï¼Œå³æ•´ä¸ªåº”ç”¨å®Œæ•´çš„å¤åˆ¶åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚å½“åº”ç”¨çš„ä¸åŒç»„ä»¶åœ¨æ‰©å±•éœ€æ±‚ä¸Šå­˜åœ¨å·®å¼‚æ—¶ï¼Œå¾®æœåŠ¡æ¶æ„ä¾¿ä½“ç°å‡ºå…¶ä¼˜è¶Šæ€§ã€‚é€šè¿‡åœ¨ä¸åŒçš„åŸºç¡€è®¾æ–½ä¹‹é—´å®ç°æ‰©å±•ï¼Œè¿™äº›æœåŠ¡èƒ½å¤Ÿæœ‰æ•ˆåœ°é™ä½é£é™©[é™ˆæ˜¥éœ, 2016]ã€‚ 3. Spring Cloudå¼€æºæ¡†æ¶Spring Cloudæ˜¯ä¸€ä¸ªåŸºäºSpring Bootå®ç°çš„äº‘åº”ç”¨å¼€å‘å·¥å…·ï¼Œå®ƒä¸ºåŸºäºJVMçš„äº‘åº”ç”¨å¼€å‘ä¸­çš„æœåŠ¡å‘ç°ä¸æ³¨å†Œã€ç†”æ–­æœºåˆ¶ã€è·¯ç”±ã€å…¨å±€é”ã€ä¸­å¿ƒé…ç½®ç®¡ç†ã€æ§åˆ¶æ€»çº¿ã€å†³ç­–ç«é€‰ã€åˆ†å¸ƒå¼ä¼šè¯å’Œé›†ç¾¤çŠ¶æ€ç®¡ç†ç­‰æ“ä½œæä¾›äº†ä¸€ç§ç®€å•çš„å¼€å‘æ–¹å¼[ç¿Ÿæ°¸è¶…,2016]ã€‚Spring Cloudæ•´ä½“æ¶æ„å›¾å¦‚å›¾1.1æ‰€ç¤ºã€‚ Spring Cloudæ•´ä½“æ¶æ„ä¸­å¦‚ä¸‹å‡ ä¸ªåŸºç¡€æœåŠ¡æ¨¡å—ï¼šå¾®æœåŠ¡é…ç½®ç®¡ç†ã€APIç½‘å…³æœåŠ¡ã€æœåŠ¡å‘ç°ä¸æ³¨å†Œå’Œæ¶ˆæ¯æ€»çº¿æ¨¡å—ã€‚ spring-cloud-configï¼Œå¾®æœåŠ¡é…ç½®ç®¡ç†ï¼Œå³ä¸ºä¸Šå›¾çš„config serviceæœåŠ¡æ¨¡å—ï¼Œä¸ºæœåŠ¡ç«¯æä¾›äº†åˆ†å¸ƒå¼ç¯å¢ƒçš„ä¸­å¤®é…ç½®æ”¯æŒã€‚é…ç½®æœåŠ¡å™¨ä¸ºå„åº”ç”¨çš„æ‰€æœ‰ç¯å¢ƒæä¾›äº†ä¸€ä¸ªä¸­å¿ƒåŒ–çš„å¤–éƒ¨é…ç½®ã€‚å®ƒå®Œæˆäº†å¯¹æœåŠ¡ç«¯Spring-Envå’Œé…ç½®æºæŠ½è±¡çš„æ˜ å°„ï¼Œæ‰€ä»¥configæœåŠ¡ä¸ä»…é€‚ç”¨äºSpringæ¡†æ¶æ„å»ºçš„åº”ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨å…¶ä»–è¯­è¨€çš„åº”ç”¨ç¨‹åºã€‚ä½œä¸ºä¸€ä¸ªåº”ç”¨ï¼Œå¯ä»¥é€šè¿‡éƒ¨ç½²ç®¡é“æ¥è¿›è¡Œæµ‹è¯•æˆ–è€…æŠ•å…¥ç”Ÿäº§ï¼Œåˆ†åˆ«ä¸ºè¿™äº›ç¯å¢ƒåˆ›å»ºé…ç½®ï¼Œå¹¶ä¸”åœ¨éœ€è¦è¿ç§»ç¯å¢ƒçš„æ—¶å€™è·å–å¯¹åº”çš„é…ç½®æ¥è¿è¡Œã€‚ APIç½‘å…³ï¼Œæœ¬ç³»ç»Ÿä½¿ç”¨netflixçš„zuulæ¡†æ¶ï¼Œä½œä¸ºç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œå…·æœ‰è´Ÿè½½å‡è¡¡ã€æœåŠ¡è·¯ç”±ã€æœåŠ¡è¿‡æ»¤ç­‰åŠŸèƒ½ã€‚ æœåŠ¡å‘ç°ä¸æ³¨å†Œæœ‰å¤šç§å¼€æºç»„ä»¶æ”¯æŒï¼Œæ¯”å¦‚zookeeperã€etcdã€netflixå…¬å¸çš„Eurekaï¼Œä»¥åŠæœ¬ç³»ç»Ÿä½¿ç”¨çš„Consulã€‚æœåŠ¡å‘ç°æ˜¯ä¸€ä¸ªæœåŠ¡å°†å…¶åœ°å€ä¿¡æ¯åœ¨ä¸­å¿ƒæ³¨å†ŒèŠ‚ç‚¹è¿›è¡Œæ³¨å†Œçš„è¿‡ç¨‹ã€‚è¯¥æœåŠ¡ä¸€èˆ¬ä¼šå°†å®ƒçš„ä¸»æœºIPåœ°å€ä»¥åŠç«¯å£å·è¿›è¡Œæ³¨å†Œï¼Œå…·ä½“è¿˜ä¼šåŒ…æ‹¬è®¤è¯ä¿¡æ¯ã€ä½¿ç”¨åè®®ã€ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ï¼Œä»¥åŠå…³äºåº”ç”¨æœåŠ¡ç¯å¢ƒçš„ç»†èŠ‚ä¿¡æ¯ã€‚ä¸€ä¸ªåº”ç”¨æœåŠ¡æˆ–è€…ç»„ä»¶é€šè¿‡æœåŠ¡å‘ç°å¯ä»¥æŒæ¡å…¶è¿è¡Œç¯å¢ƒä»¥åŠå…¶å®ƒåº”ç”¨æœåŠ¡æˆ–ç»„ä»¶çš„ä¿¡æ¯ã€‚ç”¨æˆ·é…ç½®ä¸€ä¸ªæœåŠ¡å‘ç°å·¥å…·ä¹‹åï¼Œå°±å¯ä»¥å°†å®é™…å®¹å™¨ä¸è¿è¡Œé…ç½®åˆ†ç¦»å¼€ã€‚]]></content>
      <categories>
        <category>å¾®æœåŠ¡</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…æRESTä¸HTTP]]></title>
    <url>%2F2017%2F07%2F10%2FREST%E4%B8%8EHTTP%2F</url>
    <content type="text"><![CDATA[å¹‚ç­‰æ€§Methods can also have the property of &quot;idempotence&quot; in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single request. å®‰å…¨æ“ä½œä¸å¹‚æŒ‡ç›¸ç­‰ç‰¹æ€§ï¼ˆSafety /Idempotenceï¼‰HTTP çš„ GETã€HEAD è¯·æ±‚æœ¬è´¨ä¸Šåº”è¯¥æ˜¯å®‰å…¨çš„è°ƒç”¨ï¼Œå³ï¼šGETã€HEAD è°ƒç”¨ä¸ä¼šæœ‰ä»»ä½•çš„å‰¯ä½œç”¨ï¼Œä¸ä¼šé€ æˆæœåŠ¡å™¨ç«¯çŠ¶æ€çš„æ”¹å˜ã€‚å¯¹äºæœåŠ¡å™¨æ¥è¯´ï¼Œå®¢æˆ·ç«¯å¯¹æŸä¸€ URI åš n æ¬¡çš„ GETã€HAED è°ƒç”¨ï¼Œå…¶çŠ¶æ€ä¸æ²¡æœ‰åšè°ƒç”¨æ˜¯ä¸€æ ·çš„ï¼Œä¸ä¼šå‘ç”Ÿä»»ä½•çš„æ”¹å˜ã€‚ HTTP çš„ PUTã€DELTE è°ƒç”¨ï¼Œå…·æœ‰å¹‚æŒ‡ç›¸ç­‰ç‰¹æ€§ , å³ï¼šå®¢æˆ·ç«¯å¯¹æŸä¸€ URI åš n æ¬¡çš„ PUTã€DELTE è°ƒç”¨ï¼Œå…¶æ•ˆæœä¸åšä¸€æ¬¡çš„è°ƒç”¨æ˜¯ä¸€æ ·çš„ã€‚HTTP çš„ GETã€HEAD æ–¹æ³•ä¹Ÿå…·æœ‰å¹‚æŒ‡ç›¸ç­‰ç‰¹æ€§ã€‚HTTP è¿™äº›æ ‡å‡†æ–¹æ³•åœ¨åŸåˆ™ä¸Šä¿è¯ä½ çš„åˆ†å¸ƒå¼ç³»ç»Ÿå…·æœ‰è¿™äº›ç‰¹æ€§ï¼Œä»¥å¸®åŠ©æ„å»ºæ›´åŠ å¥å£®çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚ å½“ç„¶ä½œä¸ºè®¾è®¡çš„åŸºç¡€ï¼Œå‡ ä¸ªå¿…é¡»çš„åŸåˆ™è¿˜æ˜¯è¦éµå®ˆçš„ï¼š å½“æ ‡å‡†åˆç†çš„æ—¶å€™éµå®ˆæ ‡å‡†ã€‚ APIåº”è¯¥å¯¹ç¨‹åºå‘˜å‹å¥½ï¼Œå¹¶ä¸”åœ¨æµè§ˆå™¨åœ°å€æ å®¹æ˜“è¾“å…¥ã€‚ APIåº”è¯¥ç®€å•ï¼Œç›´è§‚ï¼Œå®¹æ˜“ä½¿ç”¨çš„åŒæ—¶ä¼˜é›…ã€‚ APIåº”è¯¥å…·æœ‰è¶³å¤Ÿçš„çµæ´»æ€§æ¥æ”¯æŒä¸Šå±‚uiã€‚ APIè®¾è®¡æƒè¡¡ä¸Šè¿°å‡ ä¸ªåŸåˆ™ã€‚ HTTPhttpè¯·æ±‚ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šè¯·æ±‚è¡Œã€æ¶ˆæ¯æŠ¥å¤´ã€è¯·æ±‚æ­£æ–‡. http 1.1/2 http://www.blogjava.net/yongboy/archive/2015/03/23/423751.html HTTP/1.1ï¼ŒHTTPå®¢æˆ·ç«¯æ— æ³•é‡è¯•éå¹‚ç­‰è¯·æ±‚ï¼Œå°¤å…¶åœ¨é”™è¯¯å‘ç”Ÿçš„æ—¶å€™ï¼Œç”±äºæ— æ³•æ£€æµ‹é”™è¯¯æ€§è´¨è¿™ä¼šå¯¹é‡è¯•å¸¦æ¥ä¸åˆ©çš„å½±å“ã€‚ HTTP/2ä¸å…è®¸ä½¿ç”¨è¿æ¥ç‰¹å®šå¤´éƒ¨å­—æ®µ æ–°å¢çš„5ä¸ªå¤´éƒ¨ æ¨é€æœºåˆ¶çš„ä¸€äº›ç‰¹æ€§éœ€æ±‚ RST_STREAMç­‰å¸§æ ‡å¿—ä½çš„ä½¿ç”¨]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>REST</tag>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¾è®¡æ¨¡å¼ä¹‹å»ºé€ è€…æ¨¡å¼]]></title>
    <url>%2F2017%2F02%2F26%2Fdesignbuilder%2F</url>
    <content type="text"><![CDATA[1. åè¯è§£é‡Š å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚ æ¯”å¦‚ä¸€å°ç”µè„‘åŒ…æ‹¬ä¸»æœºã€æ˜¾ç¤ºå™¨ã€é”®ç›˜ç­‰å¤–è®¾ï¼Œè¿™äº›éƒ¨ä»¶ç»„æˆäº†å®Œæ•´çš„ä¸€å°ç”µè„‘ã€‚å¦‚ä½•å°†è¿™äº›éƒ¨ä»¶ç»„è£…æˆä¸€å°å®Œæ•´çš„ç”µè„‘å¹¶è¿”å›ç»™ç”¨æˆ·ï¼Œè¿™æ˜¯å»ºé€ è€…æ¨¡å¼éœ€è¦è§£å†³çš„é—®é¢˜ã€‚å»ºé€ è€…æ¨¡å¼ï¼ˆbuilderï¼‰åˆç§°ä¸ºç”Ÿæˆå™¨æ¨¡å¼ï¼Œä»åè¯å°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒæ˜¯ä¸€ç§è¾ƒä¸ºå¤æ‚ã€ä½¿ç”¨é¢‘ç‡ä¹Ÿç›¸å¯¹è¾ƒä½çš„åˆ›å»ºå‹æ¨¡å¼ã€‚å»ºé€ è€…æ¨¡å¼ä¸ºå®¢æˆ·ç«¯è¿”å›çš„ä¸æ˜¯ä¸€ä¸ªç®€å•çš„äº§å“ï¼Œè€Œæ˜¯ä¸€ä¸ªç”±å¤šä¸ªéƒ¨ä»¶ç»„æˆçš„å¤æ‚äº§å“ã€‚ 2. å»ºé€ è€…æ¨¡å¼UMLå›¾ ä¸Šå›¾ä¸­åŒ…å«äº†å»ºé€ è€…æ¨¡å¼çš„å››ä¸ªä¸»è¦è§’è‰²ï¼š Builderï¼ˆæŠ½è±¡å»ºé€ è€…ï¼‰ï¼šå®ƒä¸ºåˆ›å»ºä¸€ä¸ªäº§å“Productå¯¹è±¡çš„å„ä¸ªéƒ¨ä»¶æŒ‡å®šæŠ½è±¡æ–¹æ³•ï¼Œåœ¨è¯¥æ¥å£ä¸­ä¸€èˆ¬å£°æ˜ä¸¤ç±»æ–¹æ³•ï¼Œä¸€ç±»æ–¹æ³•æ˜¯buildPartX()ï¼Œå®ƒä»¬ç”¨äºåˆ›å»ºå¤æ‚å¯¹è±¡çš„å„ä¸ªéƒ¨ä»¶ï¼›å¦ä¸€ç±»æ–¹æ³•æ˜¯getResult()ï¼Œå®ƒä»¬ç”¨äºè¿”å›å¤æ‚å¯¹è±¡ã€‚Builderæ—¢å¯ä»¥æ˜¯æŠ½è±¡ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¥å£ã€‚ ConcreteBuilderï¼ˆå…·ä½“å»ºé€ è€…ï¼‰ï¼šå®ƒå®ç°äº†BuilderæŠ½è±¡æ–¹æ³•ï¼Œå®ç°å„ä¸ªéƒ¨ä»¶çš„å…·ä½“æ„é€ å’Œè£…é…æ–¹æ³•ï¼Œå®šä¹‰å¹¶æ˜ç¡®å®ƒæ‰€åˆ›å»ºçš„å¤æ‚å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªæ–¹æ³•è¿”å›åˆ›å»ºå¥½çš„å¤æ‚äº§å“å¯¹è±¡ã€‚ä¾èµ–äºProductã€‚ Productï¼ˆäº§å“è§’è‰²ï¼‰ï¼šå®ƒæ˜¯è¢«æ„å»ºçš„å¤æ‚å¯¹è±¡ï¼ŒåŒ…å«å¤šä¸ªç»„æˆéƒ¨ä»¶ï¼Œå…·ä½“å»ºé€ è€…åˆ›å»ºè¯¥äº§å“çš„å†…éƒ¨è¡¨ç¤ºå¹¶å®šä¹‰å®ƒçš„è£…é…è¿‡ç¨‹ã€‚ Directorï¼ˆæŒ‡æŒ¥è€…ï¼‰ï¼šæŒ‡æŒ¥è€…åˆç§°ä¸ºå¯¼æ¼”ç±»ï¼Œå®ƒè´Ÿè´£å®‰æ’å¤æ‚å¯¹è±¡çš„å»ºé€ æ¬¡åºï¼ŒæŒ‡æŒ¥è€…ä¸æŠ½è±¡å»ºé€ è€…ä¹‹é—´å­˜åœ¨å…³è”å…³ç³»ï¼Œå¯ä»¥åœ¨å…¶construct()å»ºé€ æ–¹æ³•ä¸­è°ƒç”¨å»ºé€ è€…å¯¹è±¡çš„éƒ¨ä»¶æ„é€ ä¸è£…é…æ–¹æ³•ï¼Œå®Œæˆå¤æ‚å¯¹è±¡çš„å»ºé€ ã€‚å®¢æˆ·ç«¯ä¸€èˆ¬åªéœ€è¦ä¸æŒ‡æŒ¥è€…è¿›è¡Œäº¤äº’ï¼Œåœ¨å®¢æˆ·ç«¯ç¡®å®šå…·ä½“å»ºé€ è€…çš„ç±»å‹ï¼Œå¹¶å®ä¾‹åŒ–å…·ä½“å»ºé€ è€…å¯¹è±¡ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å’Œåå°„æœºåˆ¶ï¼‰ï¼Œç„¶åé€šè¿‡æŒ‡æŒ¥è€…ç±»çš„æ„é€ å‡½æ•°æˆ–è€…Setteræ–¹æ³•å°†è¯¥å¯¹è±¡ä¼ å…¥æŒ‡æŒ¥è€…ç±»ä¸­ã€‚ 3. å»ºé€ è€…æ¨¡å¼å®ç°ä¸‹é¢ä»£ç åŸºäºJavaå®ç°çš„ä¸€ä¸ªå»ºé€ è€…æ¨¡å¼ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455@dataclass Product &#123; private String name; private String type; public void showProduct()&#123; System.out.println("åç§°ï¼š"+name); System.out.println("å‹å·ï¼š"+type); &#125; &#125; //æŠ½è±¡ç±»abstract class Builder &#123; public abstract void buildPart(String arg1, String arg2); public abstract Product getProduct(); &#125; //å…·ä½“å»ºé€ è€…class ConcreteBuilder extends Builder &#123; private Product product = new Product(); public Product getResult() &#123; return product; &#125; public void buildPart(String arg1, String arg2) &#123; product.setName(arg1); product.setType(arg2); &#125; &#125; // æŒ‡æŒ¥è€… public class Director &#123; private Builder builder; public Director(Builder builder) &#123; this.builder=builder; &#125; public void setBuilder(Builder builder) &#123; this.builder=builer; &#125; public Product construct()&#123; builder.buildPart("lenvono","Y470"); return builder.getResult(); &#125; &#125; //å®¢æˆ·ç«¯è°ƒç”¨public class Client &#123; public static void main(String[] args)&#123; Builder builder = new ConcreteBuilder(); Director director = new Director(builder); Product product = director.construct(); product1.showProduct(); &#125; &#125; å››ä¸ªè§’è‰²éƒ½åŒ…å«åœ¨ä¸Šé¢çš„å®ç°ä¸­ï¼Œå®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œåªéœ€å…³å¿ƒå…·ä½“çš„å»ºé€ è€…å³å¯ã€‚åœ¨æŒ‡æŒ¥è€…ç±»ä¸­å¯ä»¥æ³¨å…¥ä¸€ä¸ªæŠ½è±¡å»ºé€ è€…ç±»å‹çš„å¯¹è±¡ï¼Œå…¶æ ¸å¿ƒåœ¨äºæä¾›äº†ä¸€ä¸ªå»ºé€ æ–¹æ³•construct()ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†builderå¯¹è±¡çš„æ„é€ éƒ¨ä»¶çš„æ–¹æ³•ï¼Œæœ€åè¿”å›ä¸€ä¸ªäº§å“å¯¹è±¡ã€‚ 4. ä¸å·¥å‚æ¨¡å¼åŒºåˆ«å»ºé€ è€…æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯å°è£…æ€§å¥½ï¼Œä¸”æ˜“äºæ‰©å±•ã€‚ä¸Šé¢æåˆ°ï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œåªéœ€å…³å¿ƒå…·ä½“çš„å»ºé€ è€…å³å¯ã€‚ä½¿ç”¨å»ºé€ è€…æ¨¡å¼å¯ä»¥ä¼˜å…ˆçš„å°è£…å˜åŒ–ï¼Œproductå’Œbuilderæ¯”è¾ƒç¨³å®šï¼Œä¸»è¦çš„ä¸šåŠ¡é€»è¾‘å°è£…åœ¨æ§åˆ¶ç±»ä¸­å¯¹æ•´ä½“å¯å–å¾—æ¯”è¾ƒå¥½çš„ç¨³å®šæ€§ã€‚å¦‚éœ€æ‰©å±•ï¼Œåªéœ€è¦åŠ ä¸€ä¸ªæ–°çš„å»ºé€ è€…ï¼Œå¯¹ä¹‹å‰ä»£ç æ²¡æœ‰å½±å“ã€‚ ä¸å·¥å‚æ¨¡å¼ç›¸æ¯”ï¼Œå»ºé€ è€…æ¨¡å¼ä¸€èˆ¬ç”¨æ¥åˆ›å»ºæ›´ä¸ºå¤æ‚çš„å¯¹è±¡ï¼Œå› ä¸ºå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹æ›´ä¸ºå¤æ‚ï¼Œå› æ­¤å°†å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ç‹¬ç«‹å‡ºæ¥ç»„æˆä¸€ä¸ªæ–°çš„ç±»â€”â€”æŒ‡æŒ¥è€…ç±»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå·¥å‚æ¨¡å¼æ˜¯å°†å¯¹è±¡çš„å…¨éƒ¨åˆ›å»ºè¿‡ç¨‹å°è£…åœ¨å·¥å‚ç±»ä¸­ï¼Œç”±å·¥å‚ç±»å‘å®¢æˆ·ç«¯æä¾›æœ€ç»ˆçš„äº§å“ï¼›è€Œå»ºé€ è€…æ¨¡å¼ä¸­ï¼Œå»ºé€ è€…ç±»ä¸€èˆ¬åªæä¾›äº§å“ç±»ä¸­å„ä¸ªç»„ä»¶çš„å»ºé€ ï¼Œè€Œå°†å…·ä½“å»ºé€ è¿‡ç¨‹äº¤ä»˜ç»™æŒ‡æŒ¥è€…ç±»ã€‚ç”±æŒ‡æŒ¥è€…ç±»è´Ÿè´£å°†å„ä¸ªç»„ä»¶æŒ‰ç…§ç‰¹å®šçš„è§„åˆ™ç»„å»ºä¸ºäº§å“ï¼Œç„¶åå°†ç»„å»ºå¥½çš„äº§å“äº¤ä»˜ç»™å®¢æˆ·ç«¯ã€‚ 5. æ€»ç»“æœ¬æ–‡è®²è§£äº†è®¾è®¡æ¨¡å¼ä¸­çš„å»ºé€ è€…æ¨¡å¼ï¼Œå¤§çš„åˆ†ç±»å±äºåˆ›å»ºå‹æ¨¡å¼ã€‚é¦–å…ˆä»‹ç»äº†å»ºé€ è€…æ¨¡å¼çš„æ¦‚å¿µï¼›ç„¶åç»™å‡ºäº†å»ºé€ è€…æ¨¡å¼çš„ç±»å›¾ï¼Œå¹¶å¯¹å…¶ä¸­æ¶‰åŠåˆ°çš„å››ä¸ªè§’è‰²è¿›è¡Œäº†è§£é‡Šï¼›åˆç»™å‡ºäº†åŸºäºJavaå®ç°çš„ä»£ç ï¼›æœ€åç®€å•è¯´äº†ä¸‹å…¶ä¼˜ç‚¹ï¼Œä¸å·¥å‚æ¨¡å¼çš„åŒºåˆ«ã€‚å»ºé€ è€…æ¨¡å¼ä¸»è¦é€‚ç”¨äºåˆ›å»ºä¸€äº›å¤æ‚çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡çš„å†…éƒ¨ç»„æˆæ„ä»¶é—´çš„å»ºé€ é¡ºåºæ˜¯ç¨³å®šçš„ï¼Œä½†æ˜¯å¯¹è±¡çš„å†…éƒ¨ç»„æˆæ„ä»¶é¢ä¸´ç€å¤æ‚çš„å˜åŒ–ã€‚ å‚è€ƒ ã€Šjavaä¸æ¨¡å¼ã€‹é˜å® 23ç§è®¾è®¡æ¨¡å¼ï¼ˆ4ï¼‰ï¼šå»ºé€ è€…æ¨¡å¼]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼]]></title>
    <url>%2F2017%2F02%2F19%2Fdesignsingleton%2F</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡å†™äº†23ç§è®¾è®¡æ¨¡å¼æ€»è§ˆï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»åˆ›å»ºæ¨¡å¼ä¸­çš„å•ä¾‹æ¨¡å¼ï¼Œæ—¥å¸¸å·¥ä½œä¸­ä¹Ÿä¼šæœ‰ç»å¸¸ç”¨åˆ°ã€‚ 1. å®šä¹‰é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼ï¼Ÿå•ä¾‹æ¨¡å¼æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š ä»å­—é¢å°±å¯ä»¥ç†è§£ï¼Œå•ä¾‹ç±»åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚ å•ä¾‹ç±»å¿…é¡»è‡ªå·±åˆ›å»ºè‡ªå·±çš„å”¯ä¸€å®ä¾‹ã€‚ å•ä¾‹ç±»å¿…é¡»ç»™æ‰€æœ‰å…¶ä»–å¯¹è±¡æä¾›è¿™ä¸€å®ä¾‹ã€‚ å•ä¾‹æ¨¡å¼ç¡®ä¿æŸä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸”è‡ªè¡Œå®ä¾‹åŒ–å¹¶å‘æ•´ä¸ªç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹ã€‚é€‚ç”¨åœºåˆä¸€èˆ¬æ˜¯éœ€è¦é¢‘ç¹åœ°è¿›è¡Œåˆ›å»ºå’Œé”€æ¯çš„å¯¹è±¡ã€‚å¦‚åº”ç”¨ç¨‹åºä¸­çš„æ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± ç­‰ã€‚ç³»ç»Ÿå†…å­˜ä¸­è¯¥ç±»åªå­˜åœ¨ä¸€ä¸ªå¯¹è±¡ï¼ŒèŠ‚çœäº†ç³»ç»Ÿèµ„æºï¼Œå¯¹äºä¸€äº›éœ€è¦é¢‘ç¹åˆ›å»ºé”€æ¯çš„å¯¹è±¡ï¼Œä½¿ç”¨å•ä¾‹æ¨¡å¼å¯ä»¥æé«˜ç³»ç»Ÿæ€§èƒ½ã€‚ç”±äºå•ä¾‹æ¨¡å¼åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€ã€‚ å•ä¾‹æ¨¡å¼çš„å†™æ³•æœ‰å¥½å‡ ç§ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ä¸‰ç§ï¼šæ‡’æ±‰å¼å•ä¾‹ã€é¥¿æ±‰å¼å•ä¾‹ã€ç™»è®°å¼å•ä¾‹ã€‚ 2. å®ç°æ–¹æ³•ä¸‹é¢ä»¥javaå®ç°ä¸ºä¾‹ï¼Œå±•ç¤ºå‡ ç§å•ä¾‹æ¨¡å¼çš„å…·ä½“å®ç°ã€‚ 2.1 æ‡’æ±‰å¼å•ä¾‹12345678910111213//æ‡’æ±‰å¼å•ä¾‹ç±».åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™å®ä¾‹åŒ–è‡ªå·± public class Singleton &#123; private Singleton() &#123;&#125; private static Singleton single=null; //é™æ€å·¥å‚æ–¹æ³• public static Singleton getInstance() &#123; if (single == null) &#123; single = new Singleton(); &#125; return single; &#125; //... &#125; ä¸Šè¿°Singletonä»£ç é€šè¿‡å°†æ„é€ æ–¹æ³•é™å®šä¸ºprivateé¿å…äº†ç±»åœ¨å¤–éƒ¨è¢«å®ä¾‹åŒ–ï¼Œåœ¨åŒä¸€ä¸ªè™šæ‹ŸæœºèŒƒå›´å†…ï¼ŒSingletonçš„å”¯ä¸€å®ä¾‹åªèƒ½é€šè¿‡getInstance()æ–¹æ³•è®¿é—®ã€‚ï¼ˆäº‹å®ä¸Šï¼Œé€šè¿‡Javaåå°„æœºåˆ¶æ˜¯èƒ½å¤Ÿå®ä¾‹åŒ–æ„é€ æ–¹æ³•ä¸ºprivateçš„ç±»çš„ï¼Œé‚£åŸºæœ¬ä¸Šä¼šä½¿æ‰€æœ‰çš„Javaå•ä¾‹å®ç°å¤±æ•ˆã€‚æ­¤é—®é¢˜åœ¨æ­¤å¤„ä¸åšè®¨è®ºï¼Œå§‘ä¸”æ©è€³ç›—é“ƒåœ°è®¤ä¸ºåå°„æœºåˆ¶ä¸å­˜åœ¨ã€‚ï¼‰ ä½†æ˜¯ä»¥ä¸Šå®ç°æ²¡æœ‰è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚æ‰€è°“çº¿ç¨‹å®‰å…¨æ˜¯æŒ‡ï¼šå¦‚æœä½ çš„ä»£ç æ‰€åœ¨çš„è¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹åœ¨åŒæ—¶è¿è¡Œï¼Œè€Œè¿™äº›çº¿ç¨‹å¯èƒ½ä¼šåŒæ—¶è¿è¡Œè¿™æ®µä»£ç ã€‚å¦‚æœæ¯æ¬¡è¿è¡Œç»“æœå’Œå•çº¿ç¨‹è¿è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”å…¶ä»–çš„å˜é‡çš„å€¼ä¹Ÿå’Œé¢„æœŸçš„æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æˆ–è€…è¯´ï¼šä¸€ä¸ªç±»æˆ–è€…ç¨‹åºæ‰€æä¾›çš„æ¥å£å¯¹äºçº¿ç¨‹æ¥è¯´æ˜¯åŸå­æ“ä½œæˆ–è€…å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ä¸ä¼šå¯¼è‡´è¯¥æ¥å£çš„æ‰§è¡Œç»“æœå­˜åœ¨äºŒä¹‰æ€§,ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸ç”¨è€ƒè™‘åŒæ­¥çš„é—®é¢˜ã€‚æ˜¾ç„¶ä»¥ä¸Šå®ç°å¹¶ä¸æ»¡è¶³çº¿ç¨‹å®‰å…¨çš„è¦æ±‚ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹å¾ˆå¯èƒ½å‡ºç°å¤šä¸ªSingletonå®ä¾‹ã€‚ ä¸Šè¿°çš„å®ç°çš„æ–¹å¼ï¼Œå¦‚æœç°åœ¨å­˜åœ¨ç€çº¿ç¨‹Aå’ŒBï¼Œçº¿ç¨‹Aæ‰§è¡Œåˆ°äº†If(singleton == null);ï¼Œçº¿ç¨‹Bæ‰§è¡Œåˆ°äº†Singleton = new Singleton();çº¿ç¨‹Bè™½ç„¶å®ä¾‹åŒ–äº†ä¸€ä¸ªSingletonï¼Œä½†æ˜¯å¯¹äºçº¿ç¨‹Aæ¥è¯´åˆ¤æ–­singletonè¿˜æ˜¯æœ¨æœ‰åˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥çº¿ç¨‹Aè¿˜ä¼šå¯¹singletonè¿›è¡Œåˆå§‹åŒ–ã€‚ ï¼ˆ1ï¼‰åœ¨getInstanceæ–¹æ³•ä¸ŠåŠ åŒæ­¥ 123456public static synchronized Singleton getInstance() &#123; if (single == null) &#123; single = new Singleton(); &#125; return single; &#125; å½“çº¿ç¨‹Bè®¿é—®è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå…¶ä»–çš„ä»»ä½•è¦è®¿é—®è¯¥å‡½æ•°çš„ä»£ç ä¸èƒ½æ‰§è¡Œï¼Œç›´åˆ°çº¿ç¨‹Bæ‰§è¡Œå®Œè¯¥å‡½æ•°ï¼ˆè¿™æ˜¯åˆ©ç”¨é”å®ç°çš„ï¼‰ã€‚ (2) åŒé‡æ£€æŸ¥é”å®šDCL synchronizedä¼¼ä¹å·²ç»è§£å†³äº†å¤šçº¿ç¨‹ä¸‹çš„é—®é¢˜ï¼Œä½†å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œé‚£ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®è¿™ä¸ªå‡½æ•°ï¼Œæ•ˆç‡å¾ˆä½ã€‚ 12345678910public static Singleton getInstance() &#123; if (singleton == null) &#123; synchronized (Singleton.class) &#123; if (singleton == null) &#123; singleton = new Singleton(); &#125; &#125; &#125; return singleton; &#125; è¿™ç§æ–¹å¼å°†åœ¨æ–¹æ³•ä¸Šçš„å£°æ˜è½¬ç§»åˆ°äº†å†…éƒ¨çš„ä»£ç å—ä¸­ï¼Œåªæœ‰å½“singleton=nullæ—¶ï¼Œæ‰éœ€è¦é”æœºåˆ¶ï¼Œä½†æ˜¯å¦‚æœçº¿ç¨‹Aå’ŒBåŒæ—¶æ‰§è¡Œåˆ°äº†Synchronized(singleton.class)ï¼Œè™½ç„¶ä¹Ÿæ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œï¼Œå‡å¦‚çº¿ç¨‹Bå…ˆæ‰§è¡Œï¼Œçº¿ç¨‹Bè·å¾—é”ï¼Œçº¿ç¨‹Bæ‰§è¡Œå®Œä¹‹åï¼Œçº¿ç¨‹Aè·å¾—é”ï¼Œæ­¤æ—¶æ£€æŸ¥singletonæ˜¯å¦ä¸ºç©ºå†æ‰§è¡Œï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°ä¸¤ä¸ªsingletonå®ä¾‹çš„æƒ…å†µã€‚ (3) é™æ€å†…éƒ¨ç±» å…³äºå†…éƒ¨ç±»ï¼š å†…éƒ¨ç±»éƒ½æ˜¯åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šè¢«åŠ è½½ã€‚å¤–éƒ¨ç±»ä¸è°ƒç”¨ getInstanceï¼ˆï¼‰æ—¶å€™ å†…éƒ¨ç±»æ˜¯ä¸ä¼šåŠ è½½çš„ï¼Œæ‰€ä»¥è¾¾åˆ°äº†æ‡’æ±‰çš„æ•ˆæœã€‚ç„¶åè°ƒç”¨çš„æ—¶å€™ å†…éƒ¨ç±»è¢«åŠ è½½ï¼ŒåŠ è½½çš„æ—¶å€™å°±ä¼šåˆå§‹åŒ–å®ä¾‹ï¼›è¿™ä¸ªåŠ è½½çš„è¿‡ç¨‹æ˜¯ä¸ä¼šæœ‰å¤šçº¿ç¨‹çš„é—®é¢˜çš„ï¼ç±»åŠ è½½çš„æ—¶å€™æœ‰ä¸€ç§æœºåˆ¶å«åšï¼Œç¼“å­˜æœºåˆ¶ï¼›ç¬¬ä¸€æ¬¡åŠ è½½æˆåŠŸä¹‹åä¼šè¢«ç¼“å­˜èµ·æ¥ï¼›è€Œä¸”ä¸€èˆ¬ä¸€ä¸ªç±»ä¸ä¼šåŠ è½½å¤šæ¬¡ã€‚ 123456789public class Singleton &#123; private static class LazyHolder &#123; private static final Singleton INSTANCE = new Singleton(); &#125; private Singleton ()&#123;&#125; public static final Singleton getInstance() &#123; return LazyHolder.INSTANCE; &#125; &#125; DCLä¼˜ç‚¹æ˜¯èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡ŒgetInstanceæ—¶å•ä¾‹å¯¹è±¡æ‰è¢«å®ä¾‹åŒ–ï¼Œæ•ˆç‡é«˜ã€‚ç¼ºç‚¹æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ååº”ç¨æ…¢ä¸€äº›ï¼Œåœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ä¹Ÿæœ‰ä¸€å®šçš„ç¼ºé™·ã€‚é™æ€å†…éƒ¨ç±»å®ç°ï¼Œç¬¬ä¸€æ¬¡åŠ è½½Singletonç±»æ—¶å¹¶ä¸ä¼šåˆå§‹åŒ–sInstanceï¼Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨getInstanceæ–¹æ³•æ—¶è™šæ‹ŸæœºåŠ è½½SingletonHolder å¹¶åˆå§‹åŒ–sInstance ï¼Œè¿™æ ·ä¸ä»…èƒ½ç¡®ä¿çº¿ç¨‹å®‰å…¨ä¹Ÿèƒ½ä¿è¯Singletonç±»çš„å”¯ä¸€æ€§ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼ã€‚ ä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä¼šé‡æ–°åˆ›å»ºå¯¹è±¡ï¼Œå°†ä¸€ä¸ªå•ä¾‹å®ä¾‹å¯¹è±¡å†™åˆ°ç£ç›˜å†è¯»å›æ¥ï¼Œä»è€Œè·å¾—äº†ä¸€ä¸ªå®ä¾‹ã€‚ååºåˆ—åŒ–æ“ä½œæä¾›äº†readResolveæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥è®©å¼€å‘äººå‘˜æ§åˆ¶å¯¹è±¡çš„ååºåˆ—åŒ–ã€‚åœ¨ä¸Šè¿°çš„å‡ ä¸ªæ–¹æ³•ç¤ºä¾‹ä¸­å¦‚æœè¦æœç»å•ä¾‹å¯¹è±¡è¢«ååºåˆ—åŒ–æ˜¯é‡æ–°ç”Ÿæˆå¯¹è±¡ï¼Œå°±å¿…é¡»åŠ å…¥å¦‚ä¸‹æ–¹æ³•ï¼š 123private Object readResolve() throws ObjectStreamException&#123; return singleton;&#125; 2.2 é¥¿æ±‰å¼å•ä¾‹12345678public class Singleton &#123; private static Singleton instance = new Singleton(); private Singleton ()&#123; &#125; public static Singleton getInstance() &#123; return instance; &#125; &#125; åœ¨ç±»åŠ è½½æ—¶å°±å®Œæˆäº†åˆå§‹åŒ–ï¼Œæ‰€ä»¥ç±»åŠ è½½è¾ƒæ…¢ï¼Œä½†è·å–å¯¹è±¡çš„é€Ÿåº¦å¿«ã€‚ è¿™ç§æ–¹å¼åŸºäºç±»åŠ è½½æœºåˆ¶é¿å…äº†å¤šçº¿ç¨‹çš„åŒæ­¥é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½ç¡®å®šæœ‰å…¶ä»–çš„æ–¹å¼ï¼ˆæˆ–è€…å…¶ä»–çš„é™æ€æ–¹æ³•ï¼‰å¯¼è‡´ç±»è£…è½½ï¼Œè¿™æ—¶å€™åˆå§‹åŒ–instanceæ˜¾ç„¶æ²¡æœ‰è¾¾åˆ°æ‡’åŠ è½½çš„æ•ˆæœã€‚ 2.3 ç™»è®°å¼å•ä¾‹123456789101112131415 //ç™»è®°å¼å•ä¾‹ç±»ï¼Œåˆ©ç”¨å®¹å™¨å®ç° //ç±»ä¼¼Springé‡Œé¢çš„æ–¹æ³•ï¼Œå°†ç±»åæ³¨å†Œï¼Œä¸‹æ¬¡ä»é‡Œé¢ç›´æ¥è·å–ã€‚ public class SingletonManager &#123; private static Map&lt;String, Object&gt; objMap = new HashMap&lt;String,Object&gt;(); private Singleton() &#123; &#125; public static void registerService(String key, Objectinstance) &#123; if (!objMap.containsKey(key) ) &#123; objMap.put(key, instance) ; &#125; &#125; public static ObjectgetService(String key) &#123; return objMap.get(key) ; &#125;&#125; SingletonManagerå°†å¤šç§çš„å•ä¾‹ç±»ç»Ÿä¸€ç®¡ç†ï¼Œåœ¨ä½¿ç”¨æ—¶æ ¹æ®keyè·å–å¯¹è±¡å¯¹åº”ç±»å‹çš„å¯¹è±¡ã€‚è¿™ç§æ–¹å¼ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç®¡ç†å¤šç§ç±»å‹çš„å•ä¾‹ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨æ—¶å¯ä»¥é€šè¿‡ç»Ÿä¸€çš„æ¥å£è¿›è¡Œè·å–æ“ä½œï¼Œé™ä½äº†ç”¨æˆ·çš„ä½¿ç”¨æˆæœ¬ï¼Œä¹Ÿå¯¹ç”¨æˆ·éšè—äº†å…·ä½“å®ç°ï¼Œé™ä½äº†è€¦åˆåº¦ã€‚è¿™ç§ä¸å¸¸ç”¨ï¼Œå†…éƒ¨å®ç°è¿˜æ˜¯ç”¨çš„é¥¿æ±‰å¼å•ä¾‹ï¼Œå› ä¸ºå…¶ä¸­çš„staticæ–¹æ³•å—ï¼Œå®ƒçš„å•ä¾‹åœ¨ç±»è¢«è£…è½½çš„æ—¶å€™å°±è¢«å®ä¾‹åŒ–äº†ã€‚ 3. æ€»ç»“æœ¬æ–‡ä¸»è¦è®²äº†å•ä¾‹æ¨¡å¼çš„ä¸‰ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯æ‡’æ±‰å•ä¾‹ã€é¥¿æ±‰å•ä¾‹å’Œç™»è®°å¼å•ä¾‹ã€‚ ä¸»è¦çš„ä½¿ç”¨åœºæ™¯ï¼š éœ€è¦é¢‘ç¹çš„è¿›è¡Œåˆ›å»ºå’Œé”€æ¯çš„å¯¹è±¡ï¼› åˆ›å»ºå¯¹è±¡æ—¶è€—æ—¶è¿‡å¤šæˆ–è€—è´¹èµ„æºè¿‡å¤šï¼Œä½†åˆç»å¸¸ç”¨åˆ°çš„å¯¹è±¡ï¼› å·¥å…·ç±»å¯¹è±¡ï¼› é¢‘ç¹è®¿é—®æ•°æ®åº“æˆ–æ–‡ä»¶çš„å¯¹è±¡ã€‚ é¥¿æ±‰å•ä¾‹ï¼Œç±»ä¸€æ—¦åŠ è½½ï¼Œå°±æŠŠå•ä¾‹åˆå§‹åŒ–å®Œæˆï¼Œä¿è¯getInstanceçš„æ—¶å€™ï¼Œå•ä¾‹æ˜¯å·²ç»å­˜åœ¨çš„äº†ã€‚é¥¿æ±‰å¼å¤©ç”Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç›´æ¥ç”¨äºå¤šçº¿ç¨‹è€Œä¸ä¼šå‡ºç°é—®é¢˜ã€‚ é¥¿æ±‰å¼åœ¨ç±»åˆ›å»ºçš„åŒæ—¶å°±å®ä¾‹åŒ–ä¸€ä¸ªé™æ€å¯¹è±¡å‡ºæ¥ï¼Œå æ®ä¸€å®šçš„å†…å­˜ï¼Œä½†æ˜¯åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶é€Ÿåº¦ä¹Ÿä¼šæ›´å¿«ï¼Œå› ä¸ºå…¶èµ„æºå·²ç»åˆå§‹åŒ–å®Œæˆã€‚ æ‡’æ±‰å•ä¾‹ï¼Œåªæœ‰å½“è°ƒç”¨getInstanceçš„æ—¶å€™ï¼Œæ‰ä¼šå»åˆå§‹åŒ–è¿™ä¸ªå•ä¾‹ã€‚æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œåœ¨é¥¿æ±‰å•ä¾‹å®ç°çš„åŸºç¡€ä¸Šï¼Œæœ‰ä¸‰ç§æ–¹æ³•å¯¹å¤šçº¿ç¨‹å®‰å…¨è¿›è¡Œäº†å¤„ç†ã€‚æ‡’æ±‰å¼ä¼šå»¶è¿ŸåŠ è½½ï¼Œåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨è¯¥å•ä¾‹çš„æ—¶å€™æ‰ä¼šå®ä¾‹åŒ–å¯¹è±¡å‡ºæ¥ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è¦åšåˆå§‹åŒ–ï¼Œå¦‚æœè¦åšçš„å·¥ä½œæ¯”è¾ƒå¤šï¼Œæ€§èƒ½ä¸Šä¼šæœ‰äº›å»¶è¿Ÿï¼Œä¹‹åå°±å’Œé¥¿æ±‰å¼ä¸€æ ·äº†ã€‚ å‚è€ƒ JAVAè®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼ é«˜å¹¶å‘ä¸‹çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼ï¼ˆæœ€å…¨æœ€ç»å…¸ï¼‰]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[23ç§è®¾è®¡æ¨¡å¼æ€»è§ˆ]]></title>
    <url>%2F2017%2F01%2F12%2FdesignPattern1%2F</url>
    <content type="text"><![CDATA[1. è®¾è®¡æ¨¡å¼åˆ†ç±» åˆ›å»ºå‹æ¨¡å¼ï¼Œå…±äº”ç§ï¼šå·¥å‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼ã€åŸå‹æ¨¡å¼ã€‚ ç»“æ„å‹æ¨¡å¼ï¼Œå…±ä¸ƒç§ï¼šé€‚é…å™¨æ¨¡å¼ã€è£…é¥°å™¨æ¨¡å¼ã€ä»£ç†æ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€æ¡¥æ¥æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€äº«å…ƒæ¨¡å¼ã€‚ è¡Œä¸ºå‹æ¨¡å¼ï¼Œå…±åä¸€ç§ï¼šç­–ç•¥æ¨¡å¼ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€è¿­ä»£å­æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€å¤‡å¿˜å½•æ¨¡å¼ã€çŠ¶æ€æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼ã€ä¸­ä»‹è€…æ¨¡å¼ã€è§£é‡Šå™¨æ¨¡å¼ã€‚ å…¶ä»–ä¸¤ç±»ï¼šå¹¶å‘å‹æ¨¡å¼å’Œçº¿ç¨‹æ± æ¨¡å¼ã€‚ è¿™è¾¹å¼•ç”¨ä¸‹ç½‘ä¸Šçš„è®¾è®¡æ¨¡å¼å›¾ã€‚ 2. è®¾è®¡æ¨¡å¼çš„å…­å¤§åŸåˆ™2.1 æ€»åŸåˆ™æ€»åŸåˆ™ä¸ºå¼€é—­åŸåˆ™ã€‚å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ã€‚åœ¨ç¨‹åºéœ€è¦è¿›è¡Œæ‹“å±•çš„æ—¶å€™ï¼Œä¸ç”¨å»ä¿®æ”¹åŸæœ‰çš„ä»£ç ï¼Œè€Œæ˜¯æ‰©å±•åŸæœ‰ä»£ç ï¼Œå®ç°ä¸€ä¸ªçƒ­æ’æ‹”çš„æ•ˆæœã€‚æ‰€ä»¥ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯ï¼šä¸ºäº†ä½¿ç¨‹åºçš„æ‰©å±•æ€§å¥½ï¼Œæ˜“äºç»´æŠ¤å’Œå‡çº§ã€‚æƒ³è¦è¾¾åˆ°è¿™æ ·çš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ¥å£å’ŒæŠ½è±¡ç±»ç­‰ï¼Œåé¢çš„å…·ä½“è®¾è®¡ä¸­æˆ‘ä»¬ä¼šæåˆ°è¿™ç‚¹ã€‚ 2.2 å•ä¸€èŒè´£åŸåˆ™ä¸è¦å­˜åœ¨å¤šäºä¸€ä¸ªå¯¼è‡´ç±»å˜æ›´çš„åŸå› ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªç±»åº”è¯¥å®ç°å•ä¸€çš„èŒè´£ï¼Œå¦åˆ™å°±åº”è¯¥æŠŠç±»æ‹†åˆ†ã€‚ 2.3 é‡Œæ°æ›¿æ¢åŸåˆ™é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLiskov Substitution Principleï¼‰ï¼Œä»»ä½•åŸºç±»å¯ä»¥å‡ºç°çš„åœ°æ–¹ï¼Œå­ç±»ä¸€å®šå¯ä»¥å‡ºç°ã€‚é‡Œæ°æ›¿æ¢åŸåˆ™æ˜¯ç»§æ‰¿å¤ç”¨çš„åŸºçŸ³ï¼Œåªæœ‰å½“è¡ç”Ÿç±»å¯ä»¥æ›¿æ¢åŸºç±»ï¼Œè½¯ä»¶å•ä½çš„åŠŸèƒ½ä¸å—åˆ°å½±å“æ—¶ï¼ŒåŸºç±»æ‰èƒ½çœŸæ­£è¢«å¤ç”¨ï¼Œè€Œè¡ç”Ÿç±»ä¹Ÿèƒ½å¤Ÿåœ¨åŸºç±»çš„åŸºç¡€ä¸Šå¢åŠ æ–°çš„è¡Œä¸ºã€‚é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯å¯¹â€œå¼€-é—­â€åŸåˆ™çš„è¡¥å……ã€‚å®ç°â€œå¼€é—­â€åŸåˆ™çš„å…³é”®æ­¥éª¤å°±æ˜¯æŠ½è±¡åŒ–ã€‚è€ŒåŸºç±»ä¸å­ç±»çš„ç»§æ‰¿å…³ç³»å°±æ˜¯æŠ½è±¡åŒ–çš„å…·ä½“å®ç°ï¼Œæ‰€ä»¥é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯å¯¹å®ç°æŠ½è±¡åŒ–çš„å…·ä½“æ­¥éª¤çš„è§„èŒƒã€‚é‡Œæ°æ›¿æ¢åŸåˆ™ä¸­ï¼Œå­ç±»å¯¹çˆ¶ç±»çš„æ–¹æ³•å°½é‡ä¸è¦é‡å†™å’Œé‡è½½ã€‚å› ä¸ºçˆ¶ç±»ä»£è¡¨äº†å®šä¹‰å¥½çš„ç»“æ„ï¼Œé€šè¿‡è¿™ä¸ªè§„èŒƒçš„æ¥å£ä¸å¤–ç•Œäº¤äº’ï¼Œå­ç±»ä¸åº”è¯¥éšä¾¿ç ´åå®ƒã€‚ 2.4 ä¾èµ–å€’è½¬åŸåˆ™ä¾èµ–å€’è½¬åŸåˆ™ï¼ˆDependence Inversion Principleï¼‰ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼Œä¾èµ–äºæŠ½è±¡è€Œä¸ä¾èµ–äºå…·ä½“ã€‚å†™ä»£ç æ—¶ç”¨åˆ°å…·ä½“ç±»æ—¶ï¼Œä¸ä¸å…·ä½“ç±»äº¤äº’ï¼Œè€Œä¸å…·ä½“ç±»çš„ä¸Šå±‚æ¥å£äº¤äº’ã€‚ 2.5 æ¥å£éš”ç¦»åŸåˆ™æ¥å£éš”ç¦»åŸåˆ™ï¼ˆInterface Segregation Principleï¼‰ï¼Œæ¯ä¸ªæ¥å£ä¸­ä¸å­˜åœ¨å­ç±»ç”¨ä¸åˆ°å´å¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œå¦‚æœä¸ç„¶ï¼Œå°±è¦å°†æ¥å£æ‹†åˆ†ã€‚ä½¿ç”¨å¤šä¸ªéš”ç¦»çš„æ¥å£ï¼Œæ¯”ä½¿ç”¨å•ä¸ªæ¥å£ï¼ˆå¤šä¸ªæ¥å£æ–¹æ³•é›†åˆåˆ°ä¸€ä¸ªçš„æ¥å£ï¼‰è¦å¥½ã€‚ 2.6 è¿ªç±³ç‰¹æ³•åˆ™è¿ªç±³ç‰¹æ³•åˆ™ï¼Œæœ€å°‘çŸ¥é“åŸåˆ™ï¼ˆDemeter Principleï¼‰ï¼Œä¸€ä¸ªå®ä½“åº”å½“å°½é‡å°‘çš„ä¸å…¶ä»–å®ä½“ä¹‹é—´å‘ç”Ÿç›¸äº’ä½œç”¨ï¼Œä½¿å¾—ç³»ç»ŸåŠŸèƒ½æ¨¡å—ç›¸å¯¹ç‹¬ç«‹ã€‚æ— è®ºè¢«ä¾èµ–çš„ç±»å¤šä¹ˆå¤æ‚ï¼Œéƒ½åº”è¯¥å°†é€»è¾‘å°è£…åœ¨æ–¹æ³•çš„å†…éƒ¨ï¼Œé€šè¿‡publicæ–¹æ³•æä¾›ç»™å¤–éƒ¨ã€‚è¿™æ ·å½“è¢«ä¾èµ–çš„ç±»å˜åŒ–æ—¶ï¼Œæ‰èƒ½æœ€å°çš„å½±å“è¯¥ç±»ã€‚æœ€å°‘çŸ¥é“åŸåˆ™çš„å¦ä¸€ä¸ªè¡¨è¾¾æ–¹å¼æ˜¯ï¼šåªä¸ç›´æ¥çš„æœ‹å‹é€šä¿¡ã€‚ç±»ä¹‹é—´åªè¦æœ‰è€¦åˆå…³ç³»ï¼Œå°±å«æœ‹å‹å…³ç³»ã€‚è€¦åˆåˆ†ä¸ºä¾èµ–ã€å…³è”ã€èšåˆã€ç»„åˆç­‰ã€‚æˆ‘ä»¬ç§°å‡ºç°ä¸ºæˆå‘˜å˜é‡ã€æ–¹æ³•å‚æ•°ã€æ–¹æ³•è¿”å›å€¼ä¸­çš„ç±»ä¸ºç›´æ¥æœ‹å‹ã€‚å±€éƒ¨å˜é‡ã€ä¸´æ—¶å˜é‡åˆ™ä¸æ˜¯ç›´æ¥çš„æœ‹å‹ã€‚æˆ‘ä»¬è¦æ±‚é™Œç”Ÿçš„ç±»ä¸è¦ä½œä¸ºå±€éƒ¨å˜é‡å‡ºç°åœ¨ç±»ä¸­ã€‚ 2.7 åˆæˆå¤ç”¨åŸåˆ™åˆæˆå¤ç”¨åŸåˆ™ï¼ˆComposite Reuse Principleï¼‰ï¼Œå°½é‡é¦–å…ˆä½¿ç”¨åˆæˆ/èšåˆçš„æ–¹å¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç»§æ‰¿ã€‚ 3 æ€»ç»“æœ¬æ–‡ä¸»è¦å†™äº†è®¾è®¡æ¨¡å¼çš„æ€»è§ˆï¼Œå¯¹23ç§è®¾è®¡æ¨¡å¼è¿›è¡Œåˆ†ç±»ï¼ŒåŒ…æ‹¬åˆ›å»ºå‹æ¨¡å¼ã€ç»“æ„å‹æ¨¡å¼ã€è¡Œä¸ºå‹æ¨¡å¼ä»¥åŠä¸¤ç§å…¶ä»–æ¨¡å¼ã€‚å…¶æ¬¡ä»‹ç»äº†è®¾è®¡æ¨¡å¼çš„å…­å¤§åŸåˆ™ã€‚åé¢æ–‡ç« å°†æ‰©å±•ä»‹ç»æ¯ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚ å‚è€ƒ1.23ç§è®¾è®¡æ¨¡å¼å…¨è§£æ]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
</search>