<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[æ¶ˆæ¯ä¸­é—´ä»¶NSQæ·±å…¥ä¸Žå®žè·µ]]></title>
    <url>%2F2017%2F10%2F08%2Fnsq%2F</url>
    <content type="text"><![CDATA[1. ä»‹ç»æœ€è¿‘åœ¨ç ”ç©¶ä¸€äº›æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¸¸ç”¨çš„MQå¦‚RabbitMQ,ActiveMQ,Kafkaç­‰ã€‚NSQæ˜¯ä¸€ä¸ªåŸºäºŽGoè¯­è¨€çš„åˆ†å¸ƒå¼å®žæ—¶æ¶ˆæ¯å¹³å°ï¼Œå®ƒåŸºäºŽMITå¼€æºåè®®å‘å¸ƒï¼Œç”±bitlyå…¬å¸å¼€æºå‡ºæ¥çš„ä¸€æ¬¾ç®€å•æ˜“ç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶ã€‚å®˜æ–¹å’Œç¬¬ä¸‰æ–¹è¿˜ä¸ºNSQå¼€å‘äº†ä¼—å¤šå®¢æˆ·ç«¯åŠŸèƒ½åº“ï¼Œå¦‚å®˜æ–¹æä¾›çš„åŸºäºŽHTTPçš„nsqdã€Goå®¢æˆ·ç«¯go-nsqã€Pythonå®¢æˆ·ç«¯pynsqã€åŸºäºŽNode.jsçš„JavaScriptå®¢æˆ·ç«¯nsqjsã€å¼‚æ­¥Cå®¢æˆ·ç«¯libnsqã€Javaå®¢æˆ·ç«¯nsq-javaä»¥åŠåŸºäºŽå„ç§è¯­è¨€çš„ä¼—å¤šç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯åŠŸèƒ½åº“ã€‚ 1.1 Features1). DistributedNSQæä¾›äº†åˆ†å¸ƒå¼çš„ï¼ŒåŽ»ä¸­å¿ƒåŒ–ï¼Œä¸”æ²¡æœ‰å•ç‚¹æ•…éšœçš„æ‹“æ‰‘ç»“æž„ï¼Œç¨³å®šçš„æ¶ˆæ¯ä¼ è¾“å‘å¸ƒä¿éšœï¼Œèƒ½å¤Ÿå…·æœ‰é«˜å®¹é”™å’ŒHAï¼ˆé«˜å¯ç”¨ï¼‰ç‰¹æ€§ã€‚2). Scalableæ˜“äºŽæ‰©å±•NSQæ”¯æŒæ°´å¹³æ‰©å±•ï¼Œæ²¡æœ‰ä¸­å¿ƒåŒ–çš„brokersã€‚å†…ç½®çš„å‘çŽ°æœåŠ¡ç®€åŒ–äº†åœ¨é›†ç¾¤ä¸­å¢žåŠ èŠ‚ç‚¹ã€‚åŒæ—¶æ”¯æŒpub-subå’Œload-balanced çš„æ¶ˆæ¯åˆ†å‘ã€‚3). Ops FriendlyNSQéžå¸¸å®¹æ˜“é…ç½®å’Œéƒ¨ç½²ï¼Œç”Ÿæ¥å°±ç»‘å®šäº†ä¸€ä¸ªç®¡ç†ç•Œé¢ã€‚äºŒè¿›åˆ¶åŒ…æ²¡æœ‰è¿è¡Œæ—¶ä¾èµ–ã€‚å®˜æ–¹æœ‰Docker imageã€‚4.Integratedé«˜åº¦é›†æˆå®˜æ–¹çš„ Go å’Œ Pythonåº“éƒ½æœ‰æä¾›ã€‚è€Œä¸”ä¸ºå¤§å¤šæ•°è¯­è¨€æä¾›äº†åº“ã€‚ 1.2 ç»„ä»¶ Topic ï¼šä¸€ä¸ªtopicå°±æ˜¯ç¨‹åºå‘å¸ƒæ¶ˆæ¯çš„ä¸€ä¸ªé€»è¾‘é”®ï¼Œå½“ç¨‹åºç¬¬ä¸€æ¬¡å‘å¸ƒæ¶ˆæ¯æ—¶å°±ä¼šåˆ›å»ºtopicã€‚ Channels ï¼šchannelä¸Žæ¶ˆè´¹è€…ç›¸å…³ï¼Œæ˜¯æ¶ˆè´¹è€…ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ï¼Œchannelåœ¨æŸç§æ„ä¹‰ä¸Šæ¥è¯´æ˜¯ä¸€ä¸ªâ€œé˜Ÿåˆ—â€ã€‚æ¯å½“ä¸€ä¸ªå‘å¸ƒè€…å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°ä¸€ä¸ªtopicï¼Œæ¶ˆæ¯ä¼šè¢«å¤åˆ¶åˆ°æ‰€æœ‰æ¶ˆè´¹è€…è¿žæŽ¥çš„channelä¸Šï¼Œæ¶ˆè´¹è€…é€šè¿‡è¿™ä¸ªç‰¹æ®Šçš„channelè¯»å–æ¶ˆæ¯ï¼Œå®žé™…ä¸Šï¼Œåœ¨æ¶ˆè´¹è€…ç¬¬ä¸€æ¬¡è®¢é˜…æ—¶å°±ä¼šåˆ›å»ºchannelã€‚Channelä¼šå°†æ¶ˆæ¯è¿›è¡ŒæŽ’åˆ—ï¼Œå¦‚æžœæ²¡æœ‰æ¶ˆè´¹è€…è¯»å–æ¶ˆæ¯ï¼Œæ¶ˆæ¯é¦–å…ˆä¼šåœ¨å†…å­˜ä¸­æŽ’é˜Ÿï¼Œå½“é‡å¤ªå¤§æ—¶å°±ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚ Messagesï¼šæ¶ˆæ¯æž„æˆäº†æˆ‘ä»¬æ•°æ®æµçš„ä¸­åšåŠ›é‡ï¼Œæ¶ˆè´¹è€…å¯ä»¥é€‰æ‹©ç»“æŸæ¶ˆæ¯ï¼Œè¡¨æ˜Žå®ƒä»¬æ­£åœ¨è¢«æ­£å¸¸å¤„ç†ï¼Œæˆ–è€…é‡æ–°å°†ä»–ä»¬æŽ’é˜Ÿå¾…åˆ°åŽé¢å†è¿›è¡Œå¤„ç†ã€‚æ¯ä¸ªæ¶ˆæ¯åŒ…å«ä¼ é€’å°è¯•çš„æ¬¡æ•°ï¼Œå½“æ¶ˆæ¯ä¼ é€’è¶…è¿‡ä¸€å®šçš„é˜€å€¼æ¬¡æ•°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥æ”¾å¼ƒè¿™äº›æ¶ˆæ¯ï¼Œæˆ–è€…ä½œä¸ºé¢å¤–æ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚ nsqdï¼šnsqd æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£æŽ¥æ”¶ï¼ŒæŽ’é˜Ÿï¼ŒæŠ•é€’æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ã€‚å®ƒå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä¸è¿‡é€šå¸¸å®ƒæ˜¯ç”± nsqlookupd å®žä¾‹æ‰€åœ¨é›†ç¾¤é…ç½®çš„ï¼ˆå®ƒåœ¨è¿™èƒ½å£°æ˜Ž topics å’Œ channelsï¼Œä»¥ä¾¿å¤§å®¶èƒ½æ‰¾åˆ°ï¼‰ã€‚ nsqlookupdï¼šnsqlookupd æ˜¯å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ç®¡ç†æ‹“æ‰‘ä¿¡æ¯ã€‚å®¢æˆ·ç«¯é€šè¿‡æŸ¥è¯¢ nsqlookupd æ¥å‘çŽ°æŒ‡å®šè¯é¢˜ï¼ˆtopicï¼‰çš„ç”Ÿäº§è€…ï¼Œå¹¶ä¸” nsqd èŠ‚ç‚¹å¹¿æ’­è¯é¢˜ï¼ˆtopicï¼‰å’Œé€šé“ï¼ˆchannelï¼‰ä¿¡æ¯ã€‚æœ‰ä¸¤ä¸ªæŽ¥å£ï¼šTCP æŽ¥å£ï¼Œnsqd ç”¨å®ƒæ¥å¹¿æ’­ã€‚HTTP æŽ¥å£ï¼Œå®¢æˆ·ç«¯ç”¨å®ƒæ¥å‘çŽ°å’Œç®¡ç†ã€‚ nsqadminï¼šnsqadmin æ˜¯ä¸€å¥— WEB UIï¼Œç”¨æ¥æ±‡é›†é›†ç¾¤çš„å®žæ—¶ç»Ÿè®¡ï¼Œå¹¶æ‰§è¡Œä¸åŒçš„ç®¡ç†ä»»åŠ¡ã€‚ å¸¸ç”¨å·¥å…·ç±»ï¼š nsq_to _fileï¼šæ¶ˆè´¹æŒ‡å®šçš„è¯é¢˜ï¼ˆtopicï¼‰/é€šé“ï¼ˆchannelï¼‰ï¼Œå¹¶å†™åˆ°æ–‡ä»¶ä¸­ï¼Œæœ‰é€‰æ‹©çš„æ»šåŠ¨å’Œ/æˆ–åŽ‹ç¼©æ–‡ä»¶ã€‚ nsq_to _httpï¼šæ¶ˆè´¹æŒ‡å®šçš„è¯é¢˜ï¼ˆtopicï¼‰/é€šé“ï¼ˆchannelï¼‰å’Œæ‰§è¡Œ HTTP requests (GET/POST) åˆ°æŒ‡å®šçš„ç«¯ç‚¹ã€‚ nsq_to _nsqï¼šæ¶ˆè´¹è€…æŒ‡å®šçš„è¯é¢˜/é€šé“å’Œé‡å‘å¸ƒæ¶ˆæ¯åˆ°ç›®çš„åœ° nsqd é€šè¿‡ TCPã€‚ 1.3 æ‹“æ‰‘ç»“æž„NSQæŽ¨èé€šè¿‡ä»–ä»¬ç›¸åº”çš„nsqdå®žä¾‹ä½¿ç”¨ååŒå®šä½å‘å¸ƒè€…ï¼Œè¿™æ„å‘³ç€å³ä½¿é¢å¯¹ç½‘ç»œåˆ†åŒºï¼Œæ¶ˆæ¯ä¹Ÿä¼šè¢«ä¿å­˜åœ¨æœ¬åœ°ï¼Œç›´åˆ°å®ƒä»¬è¢«ä¸€ä¸ªæ¶ˆè´¹è€…è¯»å–ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå‘å¸ƒè€…ä¸å¿…åŽ»å‘çŽ°å…¶ä»–çš„nsqdèŠ‚ç‚¹ï¼Œä»–ä»¬æ€»æ˜¯å¯ä»¥å‘æœ¬åœ°å®žä¾‹å‘å¸ƒæ¶ˆæ¯ã€‚ é¦–å…ˆï¼Œä¸€ä¸ªå‘å¸ƒè€…å‘å®ƒçš„æœ¬åœ°nsqdå‘é€æ¶ˆæ¯ï¼Œè¦åšåˆ°è¿™ç‚¹ï¼Œé¦–å…ˆè¦å…ˆæ‰“å¼€ä¸€ä¸ªè¿žæŽ¥ï¼Œç„¶åŽå‘é€ä¸€ä¸ªåŒ…å«topicå’Œæ¶ˆæ¯ä¸»ä½“çš„å‘å¸ƒå‘½ä»¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ¶ˆæ¯å‘å¸ƒåˆ°äº‹ä»¶topicä¸Šä»¥åˆ†æ•£åˆ°æˆ‘ä»¬ä¸åŒçš„workerä¸­ã€‚äº‹ä»¶topicä¼šå¤åˆ¶è¿™äº›æ¶ˆæ¯å¹¶ä¸”åœ¨æ¯ä¸€ä¸ªè¿žæŽ¥topicçš„channelä¸Šè¿›è¡ŒæŽ’é˜Ÿï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªchannelï¼Œå®ƒä»¬å…¶ä¸­ä¹‹ä¸€ä½œä¸ºæ¡£æ¡ˆchannelã€‚æ¶ˆè´¹è€…ä¼šèŽ·å–è¿™äº›æ¶ˆæ¯å¹¶ä¸”ä¸Šä¼ åˆ°S3ã€‚ æ¯ä¸ªchannelçš„æ¶ˆæ¯éƒ½ä¼šè¿›è¡ŒæŽ’é˜Ÿï¼Œç›´åˆ°ä¸€ä¸ªworkeræŠŠä»–ä»¬æ¶ˆè´¹ï¼Œå¦‚æžœæ­¤é˜Ÿåˆ—è¶…å‡ºäº†å†…å­˜é™åˆ¶ï¼Œæ¶ˆæ¯å°†ä¼šè¢«å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚NsqdèŠ‚ç‚¹é¦–å…ˆä¼šå‘nsqlookupå¹¿æ’­ä»–ä»¬çš„ä½ç½®ä¿¡æ¯ï¼Œä¸€æ—¦å®ƒä»¬æ³¨å†ŒæˆåŠŸï¼Œworkerå°†ä¼šä»ŽnsqlookupæœåŠ¡å™¨èŠ‚ç‚¹ä¸Šå‘çŽ°æ‰€æœ‰åŒ…å«äº‹ä»¶topicçš„nsqdèŠ‚ç‚¹ã€‚ ç„¶åŽæ¯ä¸ªworkerå‘æ¯ä¸ªnsqdä¸»æœºè¿›è¡Œè®¢é˜…æ“ä½œï¼Œç”¨äºŽè¡¨æ˜Žworkerå·²ç»å‡†å¤‡å¥½æŽ¥å—æ¶ˆæ¯äº†ã€‚è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ä¸€ä¸ªå®Œæ•´çš„è¿žé€šå›¾ï¼Œä½†æˆ‘ä»¬å¿…é¡»è¦ä¿è¯æ¯ä¸ªå•ç‹¬çš„nsqdå®žä¾‹æ‹¥æœ‰è¶³å¤Ÿçš„æ¶ˆè´¹è€…åŽ»æ¶ˆè´¹å®ƒä»¬çš„æ¶ˆæ¯ï¼Œå¦åˆ™channelä¼šè¢«é˜Ÿåˆ—å †ç€ã€‚ 2. Internals2.1 æ¶ˆæ¯ä¼ é€’æ‹…ä¿NSQ ä¿è¯æ¶ˆæ¯å°†äº¤ä»˜è‡³å°‘ä¸€æ¬¡ï¼Œè™½ç„¶æ¶ˆæ¯å¯èƒ½æ˜¯é‡å¤çš„ã€‚æ¶ˆè´¹è€…åº”è¯¥å…³æ³¨åˆ°è¿™ä¸€ç‚¹ï¼Œåˆ é™¤é‡å¤æ•°æ®æˆ–æ‰§è¡Œidempotentç­‰æ“ä½œã€‚è¿™ä¸ªæ‹…ä¿æ˜¯ä½œä¸ºåè®®å’Œå·¥ä½œæµçš„ä¸€éƒ¨åˆ†ï¼Œå·¥ä½œåŽŸç†å¦‚ä¸‹ï¼ˆå‡è®¾å®¢æˆ·ç«¯æˆåŠŸè¿žæŽ¥å¹¶è®¢é˜…ä¸€ä¸ªè¯é¢˜ï¼‰ï¼š1ï¼‰å®¢æˆ·è¡¨ç¤ºå·²ç»å‡†å¤‡å¥½æŽ¥æ”¶æ¶ˆæ¯2ï¼‰NSQ å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå¹¶æš‚æ—¶å°†æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼ˆåœ¨ re-queue æˆ– timeoutï¼‰3ï¼‰å®¢æˆ·ç«¯å›žå¤ FINï¼ˆç»“æŸï¼‰æˆ– REQï¼ˆé‡æ–°æŽ’é˜Ÿï¼‰åˆ†åˆ«æŒ‡ç¤ºæˆåŠŸæˆ–å¤±è´¥ã€‚å¦‚æžœå®¢æˆ·ç«¯æ²¡æœ‰å›žå¤, NSQ ä¼šåœ¨è®¾å®šçš„æ—¶é—´è¶…æ—¶ï¼Œè‡ªåŠ¨é‡æ–°æŽ’é˜Ÿæ¶ˆæ¯è¿™ç¡®ä¿äº†æ¶ˆæ¯ä¸¢å¤±å”¯ä¸€å¯èƒ½çš„æƒ…å†µæ˜¯ä¸æ­£å¸¸ç»“æŸ nsqd è¿›ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¿™æ˜¯åœ¨å†…å­˜ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼ˆæˆ–ä»»ä½•ç¼“å†²æœªåˆ·æ–°åˆ°ç£ç›˜ï¼‰éƒ½å°†ä¸¢å¤±ã€‚å¦‚ä½•é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±æ˜¯æœ€é‡è¦çš„ï¼Œå³ä½¿æ˜¯è¿™ä¸ªæ„å¤–æƒ…å†µå¯ä»¥å¾—åˆ°ç¼“è§£ã€‚ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯æž„æˆå†—ä½™ nsqdå¯¹ï¼ˆåœ¨ä¸åŒçš„ä¸»æœºä¸Šï¼‰æŽ¥æ”¶æ¶ˆæ¯çš„ç›¸åŒéƒ¨åˆ†çš„å‰¯æœ¬ã€‚å› ä¸ºä½ å®žçŽ°çš„æ¶ˆè´¹è€…æ˜¯å¹‚ç­‰çš„ï¼Œä»¥ä¸¤å€æ—¶é—´å¤„ç†è¿™äº›æ¶ˆæ¯ä¸ä¼šå¯¹ä¸‹æ¸¸é€ æˆå½±å“ï¼Œå¹¶ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—ä»»ä½•å•ä¸€èŠ‚ç‚¹æ•…éšœè€Œä¸ä¼šä¸¢å¤±ä¿¡æ¯ã€‚ 2.2 ç®€åŒ–é…ç½®å’Œç®¡ç†å•ä¸ª nsqd å®žä¾‹è¢«è®¾è®¡æˆå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæ•°æ®æµã€‚æµè¢«ç§°ä¸ºâ€œè¯é¢˜â€å’Œè¯é¢˜æœ‰ 1 ä¸ªæˆ–å¤šä¸ªâ€œé€šé“â€ã€‚æ¯ä¸ªé€šé“éƒ½æŽ¥æ”¶åˆ°ä¸€ä¸ªè¯é¢˜ä¸­æ‰€æœ‰æ¶ˆæ¯çš„æ‹·è´ã€‚åœ¨å®žè·µä¸­ï¼Œä¸€ä¸ªé€šé“æ˜ å°„åˆ°ä¸‹è¡ŒæœåŠ¡æ¶ˆè´¹ä¸€ä¸ªè¯é¢˜ã€‚è¯é¢˜å’Œé€šé“éƒ½æ²¡æœ‰é¢„å…ˆé…ç½®ã€‚è¯é¢˜ç”±ç¬¬ä¸€æ¬¡å‘å¸ƒæ¶ˆæ¯åˆ°å‘½åçš„è¯é¢˜æˆ–ç¬¬ä¸€æ¬¡é€šè¿‡è®¢é˜…ä¸€ä¸ªå‘½åè¯é¢˜æ¥åˆ›å»ºã€‚é€šé“è¢«ç¬¬ä¸€æ¬¡è®¢é˜…åˆ°æŒ‡å®šçš„é€šé“åˆ›å»ºã€‚è¯é¢˜å’Œé€šé“çš„æ‰€æœ‰ç¼“å†²çš„æ•°æ®ç›¸äº’ç‹¬ç«‹ï¼Œé˜²æ­¢ç¼“æ…¢æ¶ˆè´¹è€…é€ æˆå¯¹å…¶ä»–é€šé“çš„ç§¯åŽ‹ï¼ˆåŒæ ·é€‚ç”¨äºŽè¯é¢˜çº§åˆ«ï¼‰ã€‚ä¸€ä¸ªé€šé“ä¸€èˆ¬ä¼šæœ‰å¤šä¸ªå®¢æˆ·ç«¯è¿žæŽ¥ã€‚å‡è®¾æ‰€æœ‰å·²è¿žæŽ¥çš„å®¢æˆ·ç«¯å¤„äºŽå‡†å¤‡æŽ¥æ”¶æ¶ˆæ¯çš„çŠ¶æ€ï¼Œæ¯ä¸ªæ¶ˆæ¯å°†è¢«ä¼ é€’åˆ°ä¸€ä¸ªéšæœºçš„å®¢æˆ·ç«¯ã€‚nsqlookupdï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç›®å½•æœåŠ¡ï¼Œæ¶ˆè´¹è€…å¯ä»¥æŸ¥æ‰¾åˆ°æä¾›ä»–ä»¬æ„Ÿå…´è¶£è®¢é˜…è¯é¢˜çš„ nsqd åœ°å€ ã€‚åœ¨é…ç½®æ–¹é¢ï¼ŒæŠŠæ¶ˆè´¹è€…ä¸Žç”Ÿäº§è€…è§£è€¦å¼€ï¼ˆå®ƒä»¬éƒ½åˆ†åˆ«åªéœ€è¦çŸ¥é“å“ªé‡ŒåŽ»è¿žæŽ¥ nsqlookupd çš„å…±åŒå®žä¾‹ï¼Œè€Œä¸æ˜¯å¯¹æ–¹ï¼‰ï¼Œé™ä½Žå¤æ‚æ€§å’Œç»´æŠ¤ã€‚åœ¨æ›´åº•çš„å±‚é¢ï¼Œæ¯ä¸ª nsqd æœ‰ä¸€ä¸ªä¸Ž nsqlookupd çš„é•¿æœŸ TCP è¿žæŽ¥ï¼Œå®šæœŸæŽ¨åŠ¨å…¶çŠ¶æ€ã€‚è¿™ä¸ªæ•°æ®è¢« nsqlookupd ç”¨äºŽç»™æ¶ˆè´¹è€…é€šçŸ¥ nsqd åœ°å€ã€‚å¯¹äºŽæ¶ˆè´¹è€…æ¥è¯´ï¼Œä¸€ä¸ªæš´éœ²çš„ HTTP /lookup æŽ¥å£ç”¨äºŽè½®è¯¢ã€‚ä¸ºè¯é¢˜å¼•å…¥ä¸€ä¸ªæ–°çš„æ¶ˆè´¹è€…ï¼Œåªéœ€å¯åŠ¨ä¸€ä¸ªé…ç½®äº† nsqlookup å®žä¾‹åœ°å€çš„ NSQ å®¢æˆ·ç«¯ã€‚æ— éœ€ä¸ºæ·»åŠ ä»»ä½•æ–°çš„æ¶ˆè´¹è€…æˆ–ç”Ÿäº§è€…æ›´æ”¹é…ç½®ï¼Œå¤§å¤§é™ä½Žäº†å¼€é”€å’Œå¤æ‚æ€§ã€‚ 2.3 æ¶ˆé™¤å•ç‚¹æ•…éšœNSQè¢«è®¾è®¡ä»¥åˆ†å¸ƒçš„æ–¹å¼è¢«ä½¿ç”¨ã€‚nsqd å®¢æˆ·ç«¯ï¼ˆé€šè¿‡ TCP ï¼‰è¿žæŽ¥åˆ°æŒ‡å®šè¯é¢˜çš„æ‰€æœ‰ç”Ÿäº§è€…å®žä¾‹ã€‚æ²¡æœ‰ä¸­é—´äººï¼Œæ²¡æœ‰æ¶ˆæ¯ä»£ç†ï¼Œä¹Ÿæ²¡æœ‰å•ç‚¹æ•…éšœã€‚è¿™ç§æ‹“æ‰‘ç»“æž„æ¶ˆé™¤å•é“¾ï¼Œèšåˆï¼Œåé¦ˆã€‚ç›¸åï¼Œä½ çš„æ¶ˆè´¹è€…ç›´æŽ¥è®¿é—®æ‰€æœ‰ç”Ÿäº§è€…ã€‚ä»ŽæŠ€æœ¯ä¸Šè®²ï¼Œå“ªä¸ªå®¢æˆ·ç«¯è¿žæŽ¥åˆ°å“ªä¸ª NSQ ä¸é‡è¦ï¼Œåªè¦æœ‰è¶³å¤Ÿçš„æ¶ˆè´¹è€…è¿žæŽ¥åˆ°æ‰€æœ‰ç”Ÿäº§è€…ï¼Œä»¥æ»¡è¶³å¤§é‡çš„æ¶ˆæ¯ï¼Œä¿è¯æ‰€æœ‰ä¸œè¥¿æœ€ç»ˆå°†è¢«å¤„ç†ã€‚å¯¹äºŽ nsqlookupdï¼Œé«˜å¯ç”¨æ€§æ˜¯é€šè¿‡è¿è¡Œå¤šä¸ªå®žä¾‹æ¥å®žçŽ°ã€‚ä»–ä»¬ä¸ç›´æŽ¥ç›¸äº’é€šä¿¡å’Œæ•°æ®è¢«è®¤ä¸ºæ˜¯æœ€ç»ˆä¸€è‡´ã€‚æ¶ˆè´¹è€…è½®è¯¢æ‰€æœ‰çš„é…ç½®çš„ nsqlookupd å®žä¾‹å’Œåˆå¹¶ responseã€‚å¤±è´¥çš„ï¼Œæ— æ³•è®¿é—®çš„ï¼Œæˆ–ä»¥å…¶ä»–æ–¹å¼æ•…éšœçš„èŠ‚ç‚¹ä¸ä¼šè®©ç³»ç»Ÿé™·äºŽåœé¡¿ã€‚ 2.4 æ•ˆçŽ‡å¯¹äºŽæ•°æ®çš„åè®®ï¼Œé€šè¿‡æŽ¨é€æ•°æ®åˆ°å®¢æˆ·ç«¯æœ€å¤§é™åº¦åœ°æé«˜æ€§èƒ½å’Œåžåé‡çš„ï¼Œè€Œä¸æ˜¯ç­‰å¾…å®¢æˆ·ç«¯æ‹‰æ•°æ®ã€‚è¿™ä¸ªæ¦‚å¿µï¼Œç§°ä¹‹ä¸º RDY çŠ¶æ€ï¼ŒåŸºæœ¬ä¸Šæ˜¯å®¢æˆ·ç«¯æµé‡æŽ§åˆ¶çš„ä¸€ç§å½¢å¼ã€‚å½“å®¢æˆ·ç«¯è¿žæŽ¥åˆ° nsqd å’Œå¹¶è®¢é˜…åˆ°ä¸€ä¸ªé€šé“æ—¶ï¼Œå®ƒè¢«æ”¾ç½®åœ¨ä¸€ä¸ª RDY ä¸º 0 çŠ¶æ€ã€‚è¿™æ„å‘³ç€ï¼Œè¿˜æ²¡æœ‰ä¿¡æ¯è¢«å‘é€åˆ°å®¢æˆ·ç«¯ã€‚å½“å®¢æˆ·ç«¯å·²å‡†å¤‡å¥½æŽ¥æ”¶æ¶ˆæ¯å‘é€ï¼Œæ›´æ–°å®ƒçš„å‘½ä»¤ RDY çŠ¶æ€åˆ°å®ƒå‡†å¤‡å¤„ç†çš„æ•°é‡ï¼Œæ¯”å¦‚ 100ã€‚æ— éœ€ä»»ä½•é¢å¤–çš„æŒ‡ä»¤ï¼Œå½“ 100 æ¡æ¶ˆæ¯å¯ç”¨æ—¶ï¼Œå°†è¢«ä¼ é€’åˆ°å®¢æˆ·ç«¯ï¼ˆæœåŠ¡å™¨ç«¯ä¸ºé‚£ä¸ªå®¢æˆ·ç«¯æ¯æ¬¡é€’å‡ RDY è®¡æ•°ï¼‰ã€‚å®¢æˆ·ç«¯åº“çš„è¢«è®¾è®¡æˆåœ¨ RDY æ•°è¾¾åˆ°é…ç½® max-in-flight çš„ 25% å‘é€ä¸€ä¸ªå‘½ä»¤æ¥æ›´æ–° RDY è®¡æ•°ï¼ˆå¹¶é€‚å½“è€ƒè™‘è¿žæŽ¥åˆ°å¤šä¸ª nsqd æƒ…å†µä¸‹ï¼Œé€‚å½“åœ°åˆ†é…ï¼‰ã€‚ 2.5 å¿ƒè·³å’Œè¶…æ—¶NSQ çš„ TCP åè®®æ˜¯é¢å‘ push çš„ã€‚åœ¨å»ºç«‹è¿žæŽ¥ï¼Œæ¡æ‰‹ï¼Œå’Œè®¢é˜…åŽï¼Œæ¶ˆè´¹è€…è¢«æ”¾ç½®åœ¨ä¸€ä¸ªä¸º 0 çš„ RDY çŠ¶æ€ã€‚å½“æ¶ˆè´¹è€…å‡†å¤‡å¥½æŽ¥æ”¶æ¶ˆæ¯ï¼Œå®ƒæ›´æ–°çš„ RDY çŠ¶æ€åˆ°å‡†å¤‡æŽ¥æ”¶æ¶ˆæ¯çš„æ•°é‡ã€‚NSQ å®¢æˆ·ç«¯åº“ä¸æ–­åœ¨å¹•åŽç®¡ç†ï¼Œæ¶ˆæ¯æŽ§åˆ¶æµçš„ç»“æžœã€‚æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œnsqd å°†å‘é€ä¸€ä¸ªå¿ƒè·³çº¿è¿žæŽ¥ã€‚å®¢æˆ·ç«¯å¯ä»¥é…ç½®å¿ƒè·³ä¹‹é—´çš„é—´éš”ï¼Œä½† nsqd ä¼šæœŸå¾…ä¸€ä¸ªå›žåº”åœ¨å®ƒå‘é€ä¸‹ä¸€ä¸ªå¿ƒæŽ‰ä¹‹å‰ã€‚ç»„åˆåº”ç”¨çº§åˆ«çš„å¿ƒè·³å’Œ RDY çŠ¶æ€ï¼Œé¿å…å¤´é˜»å¡žçŽ°è±¡ï¼Œä¹Ÿå¯èƒ½ä½¿å¿ƒè·³æ— ç”¨ï¼ˆå³ï¼Œå¦‚æžœæ¶ˆè´¹è€…æ˜¯åœ¨åŽé¢çš„å¤„ç†æ¶ˆæ¯æµçš„æŽ¥æ”¶ç¼“å†²åŒºä¸­ï¼Œæ“ä½œç³»ç»Ÿå°†è¢«å¡«æ»¡ï¼Œå µå¿ƒè·³ï¼‰ä¸ºäº†ä¿è¯è¿›åº¦ï¼Œæ‰€æœ‰çš„ç½‘ç»œ IO æ—¶é—´ä¸Šé™åŠ¿å¿…ä¸Žé…ç½®çš„å¿ƒè·³é—´éš”ç›¸å…³è”ã€‚è¿™æ„å‘³ç€ï¼Œä½ å¯ä»¥ä»Žå­—é¢ä¸Šæ‹”æŽ‰ä¹‹é—´çš„ç½‘ç»œè¿žæŽ¥ nsqd å’Œæ¶ˆè´¹è€…ï¼Œå®ƒä¼šæ£€æµ‹å¹¶æ­£ç¡®å¤„ç†é”™è¯¯ã€‚å½“æ£€æµ‹åˆ°ä¸€ä¸ªè‡´å‘½é”™è¯¯ï¼Œå®¢æˆ·ç«¯è¿žæŽ¥è¢«å¼ºåˆ¶å…³é—­ã€‚åœ¨ä¼ è¾“ä¸­çš„æ¶ˆæ¯ä¼šè¶…æ—¶è€Œé‡æ–°æŽ’é˜Ÿç­‰å¾…ä¼ é€’åˆ°å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚æœ€åŽï¼Œé”™è¯¯ä¼šè¢«è®°å½•å¹¶ç´¯è®¡åˆ°å„ç§å†…éƒ¨æŒ‡æ ‡ã€‚ 2.6 åˆ†å¸ƒå¼å› ä¸ºNSQæ²¡æœ‰åœ¨å®ˆæŠ¤ç¨‹åºä¹‹é—´å…±äº«ä¿¡æ¯ï¼Œæ‰€ä»¥å®ƒä»Žä¸€å¼€å§‹å°±æ˜¯ä¸ºäº†åˆ†å¸ƒå¼æ“ä½œè€Œç”Ÿã€‚ä¸ªåˆ«çš„æœºå™¨å¯ä»¥éšä¾¿å®•æœºéšä¾¿å¯åŠ¨è€Œä¸ä¼šå½±å“åˆ°ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†ï¼Œæ¶ˆæ¯å‘å¸ƒè€…å¯ä»¥åœ¨æœ¬åœ°å‘å¸ƒï¼Œå³ä½¿é¢å¯¹ç½‘ç»œåˆ†åŒºã€‚è¿™ç§â€œåˆ†å¸ƒå¼ä¼˜å…ˆâ€çš„è®¾è®¡ç†å¿µæ„å‘³ç€NSQåŸºæœ¬ä¸Šå¯ä»¥æ°¸è¿œä¸æ–­åœ°æ‰©å±•ï¼Œéœ€è¦æ›´é«˜çš„åžåé‡ï¼Ÿé‚£å°±æ·»åŠ æ›´å¤šçš„nsqdå§ã€‚å”¯ä¸€çš„å…±äº«çŠ¶æ€å°±æ˜¯ä¿å­˜åœ¨lookupèŠ‚ç‚¹ä¸Šï¼Œç”šè‡³å®ƒä»¬ä¸éœ€è¦å…¨å±€è§†å›¾ï¼Œé…ç½®æŸäº›nsqdæ³¨å†Œåˆ°æŸäº›lookupèŠ‚ç‚¹ä¸Šè¿™æ˜¯å¾ˆç®€å•çš„é…ç½®ï¼Œå”¯ä¸€å…³é”®çš„åœ°æ–¹å°±æ˜¯æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡lookupèŠ‚ç‚¹èŽ·å–æ‰€æœ‰å®Œæ•´çš„èŠ‚ç‚¹é›†ã€‚æ¸…æ™°çš„æ•…éšœäº‹ä»¶â€”â€”NSQåœ¨ç»„ä»¶å†…å»ºç«‹äº†ä¸€å¥—æ˜Žç¡®å…³äºŽå¯èƒ½å¯¼è‡´æ•…éšœçš„çš„æ•…éšœæƒè¡¡æœºåˆ¶ï¼Œè¿™å¯¹æ¶ˆæ¯ä¼ é€’å’Œæ¢å¤éƒ½æœ‰æ„ä¹‰ã€‚è™½ç„¶å®ƒä»¬å¯èƒ½ä¸åƒKafkaç³»ç»Ÿé‚£æ ·æä¾›ä¸¥æ ¼çš„ä¿è¯çº§åˆ«ï¼Œä½†NSQç®€å•çš„æ“ä½œä½¿æ•…éšœæƒ…å†µéžå¸¸æ˜Žæ˜¾ã€‚ 2.7 no replicationä¸åƒå…¶ä»–çš„é˜Ÿåˆ—ç»„ä»¶ï¼ŒNSQå¹¶æ²¡æœ‰æä¾›ä»»ä½•å½¢å¼çš„å¤åˆ¶å’Œé›†ç¾¤ï¼Œä¹Ÿæ­£æ˜¯è¿™ç‚¹è®©å®ƒèƒ½å¤Ÿå¦‚æ­¤ç®€å•åœ°è¿è¡Œï¼Œä½†å®ƒç¡®å®žå¯¹äºŽä¸€äº›é«˜ä¿è¯æ€§é«˜å¯é æ€§çš„æ¶ˆæ¯å‘å¸ƒæ²¡æœ‰è¶³å¤Ÿçš„ä¿è¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é™ä½Žæ–‡ä»¶åŒæ­¥çš„æ—¶é—´æ¥éƒ¨åˆ†é¿å…ï¼Œåªéœ€é€šè¿‡ä¸€ä¸ªæ ‡å¿—é…ç½®ï¼Œé€šè¿‡EBSæ”¯æŒæˆ‘ä»¬çš„é˜Ÿåˆ—ã€‚ä½†æ˜¯è¿™æ ·ä»ç„¶å­˜åœ¨ä¸€ä¸ªæ¶ˆæ¯è¢«å‘å¸ƒåŽé©¬ä¸Šæ­»äº¡ï¼Œä¸¢å¤±äº†æœ‰æ•ˆçš„å†™å…¥çš„æƒ…å†µã€‚ 2.8 æ²¡æœ‰ä¸¥æ ¼çš„é¡ºåºè™½ç„¶Kafkaç”±ä¸€ä¸ªæœ‰åºçš„æ—¥å¿—æž„æˆï¼Œä½†NSQä¸æ˜¯ã€‚æ¶ˆæ¯å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ä»¥ä»»ä½•é¡ºåºè¿›å…¥é˜Ÿåˆ—ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨çš„æ¡ˆä¾‹ä¸­ï¼Œè¿™é€šå¸¸æ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæ‰€æœ‰çš„æ•°æ®éƒ½è¢«åŠ ä¸Šäº†æ—¶é—´æˆ³ï¼Œä½†å®ƒå¹¶ä¸é€‚åˆéœ€è¦ä¸¥æ ¼é¡ºåºçš„æƒ…å†µã€‚ 2.9 æ— æ•°æ®é‡å¤åˆ é™¤åŠŸèƒ½NSQå¯¹äºŽè¶…æ—¶ç³»ç»Ÿï¼Œå®ƒä½¿ç”¨äº†å¿ƒè·³æ£€æµ‹æœºåˆ¶åŽ»æµ‹è¯•æ¶ˆè´¹è€…æ˜¯å¦å­˜æ´»è¿˜æ˜¯æ­»äº¡ã€‚å¾ˆå¤šåŽŸå› ä¼šå¯¼è‡´æˆ‘ä»¬çš„consumeræ— æ³•å®Œæˆå¿ƒè·³æ£€æµ‹ï¼Œæ‰€ä»¥åœ¨consumerä¸­å¿…é¡»æœ‰ä¸€ä¸ªå•ç‹¬çš„æ­¥éª¤ç¡®ä¿å¹‚ç­‰æ€§ã€‚ 3. å®žè·µå®‰è£…è¿‡ç¨‹æœ¬æ–‡å°†nsqé›†ç¾¤å…·ä½“çš„å®‰è£…è¿‡ç¨‹ç•¥åŽ»ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå‚è€ƒå®˜ç½‘ï¼Œæ¯”è¾ƒç®€å•ã€‚è¿™éƒ¨åˆ†ä»‹ç»ä¸‹ç¬”è€…å®žéªŒçš„æ‹“æ‰‘ï¼Œä»¥åŠnsqadminçš„ç›¸å…³ä¿¡æ¯ã€‚ 3.1 æ‹“æ‰‘ç»“æž„ å®žéªŒé‡‡ç”¨3å°NSQDæœåŠ¡ï¼Œ2å°LOOKUPDæœåŠ¡ã€‚é‡‡ç”¨å®˜æ–¹æŽ¨èçš„æ‹“æ‰‘ï¼Œæ¶ˆæ¯å‘å¸ƒçš„æœåŠ¡å’ŒNSQDåœ¨ä¸€å°ä¸»æœºã€‚ä¸€å…±5å°æœºå™¨ã€‚NSQåŸºæœ¬æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œé…ç½®é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå‚æ•°ã€‚ä¸»è¦å‘½ä»¤å¦‚ä¸‹:LOOKUPDå‘½ä»¤ 1bin/nsqlookupd NSQDå‘½ä»¤ 1bin/nsqd --lookupd-tcp-address=172.16.30.254:4160 -broadcast-address=172.16.30.254 1bin/nsqadmin --lookupd-http-address=172.16.30.254:4161 å·¥å…·ç±»ï¼Œæ¶ˆè´¹åŽå­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶ã€‚ 1bin/nsq_to_file --topic=newtest --channel=test --output-dir=/tmp --lookupd-http-address=172.16.30.254:4161 å‘å¸ƒä¸€æ¡æ¶ˆæ¯1curl -d 'hello world 5' 'http://172.16.30.254:4151/put?topic=test' 3.2 nsqadminå¯¹Streamsçš„è¯¦ç»†ä¿¡æ¯è¿›è¡ŒæŸ¥çœ‹ï¼ŒåŒ…æ‹¬NSQDèŠ‚ç‚¹ï¼Œå…·ä½“çš„channelï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°ï¼Œè¿žæŽ¥æ•°ç­‰ä¿¡æ¯ã€‚ åˆ—å‡ºæ‰€æœ‰çš„NSQDèŠ‚ç‚¹: æ¶ˆæ¯çš„ç»Ÿè®¡: lookupä¸»æœºçš„åˆ—è¡¨: 4. æ€»ç»“NSQåŸºæœ¬æ ¸å¿ƒå°±æ˜¯ç®€å•æ€§ï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ï¼Œè¿™æ„å‘³ç€å®ƒå¾ˆå®¹æ˜“è¿›è¡Œæ•…éšœæŽ¨ç†å’Œå¾ˆå®¹æ˜“å‘çŽ°bugã€‚æ¶ˆè´¹è€…å¯ä»¥è‡ªè¡Œå¤„ç†æ•…éšœäº‹ä»¶è€Œä¸ä¼šå½±å“ç³»ç»Ÿå‰©ä¸‹çš„å…¶ä½™éƒ¨åˆ†ã€‚ äº‹å®žä¸Šï¼Œç®€å•æ€§æ˜¯æˆ‘ä»¬å†³å®šä½¿ç”¨NSQçš„é¦–è¦å› ç´ ï¼Œè¿™æ–¹ä¾¿ä¸Žæˆ‘ä»¬çš„è®¸å¤šå…¶ä»–è½¯ä»¶ä¸€èµ·ç»´æŠ¤ï¼Œé€šè¿‡å¼•å…¥é˜Ÿåˆ—ä½¿æˆ‘ä»¬å¾—åˆ°äº†å ªç§°å®Œç¾Žçš„è¡¨çŽ°ï¼Œé€šè¿‡é˜Ÿåˆ—ç”šè‡³è®©æˆ‘ä»¬å¢žåŠ äº†å‡ ä¸ªæ•°é‡çº§çš„åžåé‡ã€‚è¶Šæ¥è¶Šå¤šçš„consumeréœ€è¦ä¸€å¥—ä¸¥æ ¼å¯é æ€§å’Œé¡ºåºæ€§ä¿éšœï¼Œè¿™å·²ç»è¶…è¿‡äº†NSQæä¾›çš„ç®€å•åŠŸèƒ½ã€‚ ç»“åˆæˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿæ¥çœ‹ï¼Œå¯¹äºŽæˆ‘ä»¬æ‰€éœ€è¦ä¼ è¾“çš„å‘ç¥¨æ¶ˆæ¯ï¼Œç›¸å¯¹æ¯”è¾ƒæ•æ„Ÿï¼Œæ— æ³•å®¹å¿æŸä¸ªnsqdå®•æœºï¼Œæˆ–è€…ç£ç›˜æ— æ³•ä½¿ç”¨çš„æƒ…å†µï¼Œè¯¥èŠ‚ç‚¹å †ç§¯çš„æ¶ˆæ¯æ— æ³•æ‰¾å›žã€‚è¿™æ˜¯æˆ‘ä»¬æ²¡æœ‰é€‰æ‹©è¯¥æ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸»è¦åŽŸå› ã€‚ç®€å•æ€§å’Œå¯é æ€§ä¼¼ä¹Žå¹¶ä¸èƒ½å®Œå…¨æ»¡è¶³ã€‚ç›¸æ¯”Kafkaï¼Œopsè‚©è´Ÿèµ·æ›´å¤šè´Ÿè´£çš„è¿è¥ã€‚å¦ä¸€æ–¹é¢ï¼Œå®ƒæ‹¥æœ‰ä¸€ä¸ªå¯å¤åˆ¶çš„ã€æœ‰åºçš„æ—¥å¿—å¯ä»¥æä¾›ç»™æˆ‘ä»¬æ›´å¥½çš„æœåŠ¡ã€‚ä½†å¯¹äºŽå…¶ä»–é€‚åˆNSQçš„consumerï¼Œå®ƒä¸ºæˆ‘ä»¬æœåŠ¡çš„ç›¸å½“å¥½ï¼Œæˆ‘ä»¬æœŸå¾…ç€ç»§ç»­å·©å›ºå®ƒçš„åšå®žçš„åŸºç¡€ã€‚ ps: æœ¬æ–‡é¦–å‘äºŽç¬”è€…çš„csdnåšå®¢ï¼Œæ­¤å¤„å°†å…¶åŠ å…¥ä¸ªäººçš„åšå®¢ã€‚ å‚è€ƒ NSQï¼šåˆ†å¸ƒå¼çš„å®žæ—¶æ¶ˆæ¯å¹³å° NSQ - NYC Golang Meetup NSQ Docs]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>Cluster</tag>
        <tag>mq</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Lombokä½¿ç”¨ä¸ŽåŽŸç†]]></title>
    <url>%2F2017%2F10%2F06%2Flombok%2F</url>
    <content type="text"><![CDATA[1. Lombokç®€ä»‹é¦–å…ˆLombokæ˜¯ä¸€æ¬¾Java IDEçš„åº”ç”¨å·¥å…·æ’ä»¶ï¼Œä¸€ä¸ªå¯ä»¥é€šè¿‡ç®€å•çš„æ³¨è§£å½¢å¼æ¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–æ¶ˆé™¤ä¸€äº›å¿…é¡»æœ‰ä½†æ˜¾å¾—å¾ˆè‡ƒè‚¿çš„Javaä»£ç çš„å·¥å…·ï¼Œæ¯”å¦‚å±žæ€§çš„æž„é€ å™¨ã€getterã€setterã€equalsã€hashcodeã€toStringæ–¹æ³•ã€‚ç»“åˆIDEï¼Œé€šè¿‡ä½¿ç”¨å¯¹åº”çš„æ³¨è§£ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æºç çš„æ—¶å€™ç”Ÿæˆå¯¹åº”çš„æ–¹æ³•ã€‚å®˜æ–¹åœ°å€ï¼šhttps://projectlombok.org/ã€‚ è™½ç„¶ä¸Šè¿°çš„é‚£äº›å¸¸ç”¨æ–¹æ³•IDEéƒ½èƒ½ç”Ÿæˆï¼Œä½†æ˜¯lombokæ›´åŠ ç®€æ´ä¸Žæ–¹ä¾¿ï¼Œèƒ½å¤Ÿè¾¾åˆ°çš„æ•ˆæžœå°±æ˜¯åœ¨æºç ä¸­ä¸éœ€è¦å†™ä¸€äº›é€šç”¨çš„æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ä¸­ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆè¿™äº›æ–¹æ³•ï¼Œè¿™å°±æ˜¯lombokçš„ç¥žå¥‡ä½œç”¨ã€‚ 2. å®‰è£…2.1 æ’ä»¶å®‰è£…ç¬”è€…ä¸»è¦ä½¿ç”¨çš„IDEæ˜¯Intellij ideaï¼Œç¼–è¯‘å™¨éœ€è¦åœ¨ 1preference-&gt;plugins-&gt;Browse repositories æœç´¢lombokï¼Œç„¶åŽå®‰è£…pluginsï¼Œéœ€è¦ç¨ç­‰ç‰‡åˆ»ã€‚ç¬”è€…æˆªå›¾å·²ç»å®‰è£…å¥½ã€‚ 2.2 æ·»åŠ jaråŒ…åœ¨é¡¹ç›®ä¸­æ·»åŠ lombokçš„jaråŒ…ï¼Œç¬”è€…ç”¨çš„æ˜¯mavenï¼Œæ‰€ä»¥åœ¨pomæ–‡ä»¶ä¸­æ·»åŠ äº†å¦‚ä¸‹çš„ä¾èµ–ã€‚gradleä½¿ç”¨è§å®˜ç½‘ã€‚ 123456&lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.16.16&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt;&lt;/dependency&gt; 3. ä½¿ç”¨lombokä¸»è¦é€šè¿‡æ³¨è§£èµ·ä½œç”¨ï¼Œè¯¦ç»†çš„æ³¨è§£è§Lombok featuresã€‚ With Lombok: 12345678910111213import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;import java.io.Serializable;@Data@AllArgsConstructorpublic class UserEntity implements Serializable &#123; private long userId; private String userName; private String sex;&#125; ç¼–è¯‘åŽï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697import java.beans.ConstructorProperties;import java.io.Serializable;public class UserEntity implements Serializable &#123; private long userId; private String userName; private String sex; public long getUserId() &#123; return this.userId; &#125; public String getUserName() &#123; return this.userName; &#125; public String getSex() &#123; return this.sex; &#125; public void setUserId(long userId) &#123; this.userId = userId; &#125; public void setUserName(String userName) &#123; this.userName = userName; &#125; public void setSex(String sex) &#123; this.sex = sex; &#125; public boolean equals(Object o) &#123; if(o == this) &#123; return true; &#125; else if(!(o instanceof UserEntity)) &#123; return false; &#125; else &#123; UserEntity other = (UserEntity)o; if(!other.canEqual(this)) &#123; return false; &#125; else if(this.getUserId() != other.getUserId()) &#123; return false; &#125; else &#123; Object this$userName = this.getUserName(); Object other$userName = other.getUserName(); if(this$userName == null) &#123; if(other$userName != null) &#123; return false; &#125; &#125; else if(!this$userName.equals(other$userName)) &#123; return false; &#125; Object this$sex = this.getSex(); Object other$sex = other.getSex(); if(this$sex == null) &#123; if(other$sex != null) &#123; return false; &#125; &#125; else if(!this$sex.equals(other$sex)) &#123; return false; &#125; return true; &#125; &#125; &#125; protected boolean canEqual(Object other) &#123; return other instanceof UserEntity; &#125; public int hashCode() &#123; int PRIME = true; int result = 1; long $userId = this.getUserId(); int result = result * 59 + (int)($userId &gt;&gt;&gt; 32 ^ $userId); Object $userName = this.getUserName(); result = result * 59 + ($userName == null?43:$userName.hashCode()); Object $sex = this.getSex(); result = result * 59 + ($sex == null?43:$sex.hashCode()); return result; &#125; public String toString() &#123; return "UserEntity(userId=" + this.getUserId() + ", userName=" + this.getUserName() + ", sex=" + this.getSex() + ")"; &#125; @ConstructorProperties(&#123;"userId", "userName", "sex"&#125;) public UserEntity(long userId, String userName, String sex) &#123; this.userId = userId; this.userName = userName; this.sex = sex; &#125;&#125; è¿™è¾¹ä»‹ç»ç¬”è€…ç»å¸¸ä½¿ç”¨åˆ°çš„æ³¨è§£ã€‚ valï¼Œç”¨åœ¨å±€éƒ¨å˜é‡å‰é¢ï¼Œç›¸å½“äºŽå°†å˜é‡å£°æ˜Žä¸ºfinal @Valueç”¨åœ¨ç±»ä¸Šï¼Œæ˜¯@Dataçš„ä¸å¯å˜å½¢å¼ï¼Œç›¸å½“äºŽä¸ºå±žæ€§æ·»åŠ finalå£°æ˜Žï¼Œåªæä¾›getteræ–¹æ³•ï¼Œè€Œä¸æä¾›setteræ–¹æ³• @Data@ToString, @EqualsAndHashCode, æ‰€æœ‰å±žæ€§çš„@Getter, æ‰€æœ‰non-finalå±žæ€§çš„@Setterå’Œ@RequiredArgsConstructorçš„ç»„åˆï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ³¨è§£å°±è¶³å¤Ÿäº†ã€‚ @NoArgsConstructoræ— å‚æž„é€ å™¨ @AllArgsConstructorå…¨å‚æž„é€ å™¨ @ToString ç”ŸæˆtoStringæ–¹æ³•ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¾“å‡ºç±»åã€æ‰€æœ‰å±žæ€§ï¼Œå±žæ€§ä¼šæŒ‰ç…§é¡ºåºè¾“å‡ºï¼Œä»¥é€—å·åˆ†å‰²ã€‚ @EqualsAndHashCodeé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨æ‰€æœ‰éžçž¬æ€(non-transient)å’Œéžé™æ€(non-static)å­—æ®µæ¥ç”Ÿæˆequalså’Œhascodeæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå…·ä½“ä½¿ç”¨å“ªäº›å±žæ€§ã€‚ @Getter / @Setterä¸Šé¢å·²ç»è¯´è¿‡ï¼Œä¸€èˆ¬ç”¨@dataå°±ä¸ç”¨é¢å¤–åŠ è¿™ä¸ªæ³¨è§£äº†ã€‚å¯ä»¥ä½œç”¨åœ¨ç±»ä¸Šå’Œå±žæ€§ä¸Šï¼Œæ”¾åœ¨ç±»ä¸Šï¼Œä¼šå¯¹æ‰€æœ‰çš„éžé™æ€(non-static)å±žæ€§ç”ŸæˆGetter/Setteræ–¹æ³•ï¼Œæ”¾åœ¨å±žæ€§ä¸Šï¼Œä¼šå¯¹è¯¥å±žæ€§ç”ŸæˆGetter/Setteræ–¹æ³•ã€‚å¹¶å¯ä»¥æŒ‡å®šGetter/Setteræ–¹æ³•çš„è®¿é—®çº§åˆ«ã€‚ @NonNullï¼Œç»™æ–¹æ³•å‚æ•°å¢žåŠ è¿™ä¸ªæ³¨è§£ä¼šè‡ªåŠ¨åœ¨æ–¹æ³•å†…å¯¹è¯¥å‚æ•°è¿›è¡Œæ˜¯å¦ä¸ºç©ºçš„æ ¡éªŒï¼Œå¦‚æžœä¸ºç©ºï¼Œåˆ™æŠ›å‡ºNPEï¼ˆNullPointerExceptionï¼‰ @Cleanupè‡ªåŠ¨ç®¡ç†èµ„æºï¼Œç”¨åœ¨å±€éƒ¨å˜é‡ä¹‹å‰ï¼Œåœ¨å½“å‰å˜é‡èŒƒå›´å†…å³å°†æ‰§è¡Œå®Œæ¯•é€€å‡ºä¹‹å‰ä¼šè‡ªåŠ¨æ¸…ç†èµ„æºï¼Œè‡ªåŠ¨ç”Ÿæˆtry-finallyè¿™æ ·çš„ä»£ç æ¥å…³é—­æµ @Logæ ¹æ®ä¸åŒçš„æ³¨è§£ç”Ÿæˆä¸åŒç±»åž‹çš„logå¯¹è±¡ï¼Œä½†æ˜¯å®žä¾‹åç§°éƒ½æ˜¯logï¼Œæœ‰7ç§å¯é€‰å®žçŽ°ç±»ï¼š 1). @Log4j 1private static final org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(LogExample.class); 2). @Log4j2 1private static final org.apache.logging.log4j.Logger log = org.apache.logging.log4j.LogManager.getLogger(LogExample.class); 3). @Slf4j 1private static final org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(LogExample.class); 4). @XSlf4j 1private static final org.slf4j.ext.XLogger log = org.slf4j.ext.XLoggerFactory.getXLogger(LogExample.class); 5). @CommonsLog 1private static final org.apache.commons.logging.Log log = org.apache.commons.logging.LogFactory.getLog(LogExample.class); 6). @JBossLog 1private static final org.jboss.logging.Logger log = org.jboss.logging.Logger.getLogger(LogExample.class); 7). @Log private static final java.util.logging.Logger log = java.util.logging.Logger.getLogger(LogExample.class.getName()); é»˜è®¤æƒ…å†µä¸‹ï¼Œloggerçš„åå­—å°†ä¼šæ˜¯è¢«@Logæ³¨è§£çš„é‚£ä¸ªç±»çš„åå­—ã€‚å½“ç„¶è¿™ä¹Ÿå¯ä»¥è¢«ä¸ªæ€§åŒ–å‘½åï¼Œé€šè¿‡topicå‚æ•°ï¼Œå¦‚@XSlf4j(topic=&quot;reporting&quot;)ã€‚ 4. åŽŸç†lombok ä¸»è¦é€šè¿‡æ³¨è§£ç”Ÿæ•ˆï¼Œè‡ªjdk5å¼•å…¥æ³¨è§£ï¼Œç”±ä¸¤ç§è§£æžæ–¹å¼ã€‚ç¬¬ä¸€ç§æ˜¯è¿è¡Œæ—¶è§£æžï¼Œ@Retention(RetentionPolicy.RUNTIME), å®šä¹‰æ³¨è§£çš„ä¿ç•™ç­–ç•¥ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°è¯¥æ³¨è§£ã€‚å¦ä¸€ç§æ˜¯ç¼–è¯‘æ—¶è§£æžï¼Œæœ‰ä¸¤ç§æœºåˆ¶ã€‚ Annotation Processing Toolï¼Œaptè‡ªJDK5äº§ç”Ÿï¼ŒJDK7å·²æ ‡è®°ä¸ºè¿‡æœŸï¼Œä¸æŽ¨èä½¿ç”¨ï¼ŒJDK8ä¸­å·²å½»åº•åˆ é™¤ï¼Œè‡ªJDK6å¼€å§‹ï¼Œå¯ä»¥ä½¿ç”¨Pluggable Annotation Processing APIæ¥æ›¿æ¢å®ƒï¼Œaptè¢«æ›¿æ¢ä¸»è¦æœ‰2ç‚¹åŽŸå› ã€‚apiéƒ½åœ¨com.sun.mirroréžæ ‡å‡†åŒ…ä¸‹ï¼Œè¿˜æœ‰å°±æ˜¯æ²¡æœ‰é›†æˆåˆ°javacä¸­ï¼Œéœ€è¦é¢å¤–è¿è¡Œã€‚ Pluggable Annotation Processing APIlombokä½¿ç”¨è¿™ç§æ–¹å¼å®žçŽ°ï¼ŒåŸºäºŽJSR 269ï¼Œè‡ªJDK6åŠ å…¥ï¼Œä½œä¸ºaptçš„æ›¿ä»£æ–¹æ¡ˆï¼Œå®ƒè§£å†³äº†aptçš„ä¸¤ä¸ªé—®é¢˜ï¼Œjavacåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè°ƒç”¨å®žçŽ°äº†è¯¥APIçš„ç¨‹åºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹ç¼–è¯‘å™¨åšä¸€äº›å¢žå¼ºï¼Œè¿™æ—¶javacæ‰§è¡Œçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š 5. æ€»ç»“è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£äº†lombokçš„å…¥é—¨ä¸Žä½¿ç”¨ã€‚ä»‹ç»äº†ä¸€äº›å¸¸ç”¨çš„lombokæ³¨è§£ï¼Œå¤§å¤§ç®€åŒ–äº†æˆ‘ä»¬çš„å¼€å‘å·¥ä½œå’Œä»£ç çš„ç®€æ´æ€§ã€‚å½“ç„¶ï¼Œlombokä¸æ”¯æŒå¤šç§å‚æ•°æž„é€ å™¨çš„é‡è½½ï¼Œå·¥å…·æ¯•ç«Ÿæ˜¯å·¥å…·ï¼Œæˆ‘æ„Ÿè§‰å¹¶ä¸ä¼šæœ‰éžå¸¸å®Œç¾Žé€‚åˆæ¯ä¸ªäººçš„å·¥å…·ã€‚æœ€åŽï¼Œæˆ‘ä¸ªäººè¿˜æ˜¯å¾ˆæŽ¨èè¿™æ¬¾æ’ä»¶çš„ï¼Œæ¯•ç«Ÿæˆ‘å¾ˆæ‡’ï¼ŒðŸ˜†ã€‚ å‚è€ƒ Lombok Docs Javaå¥‡æ·«å·§æŠ€ä¹‹Lombok]]></content>
      <categories>
        <category>Utils</category>
      </categories>
      <tags>
        <tag>Lombok</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redis Clusteræ·±å…¥ä¸Žå®žè·µ]]></title>
    <url>%2F2017%2F09%2F29%2Frediscluster%2F</url>
    <content type="text"><![CDATA[1. redisä»‹ç»www.redis.ioredisæ˜¯ä¸€ä¸ªåŸºäºŽå†…å­˜çš„K-Vå­˜å‚¨æ•°æ®åº“ã€‚æ”¯æŒå­˜å‚¨çš„ç±»åž‹æœ‰string,list,set,zset(sorted set),hashç­‰ã€‚è¿™äº›æ•°æ®ç±»åž‹éƒ½æ”¯æŒpush/popã€add/removeåŠå–äº¤é›†å¹¶é›†å’Œå·®é›†åŠæ›´ä¸°å¯Œçš„æ“ä½œï¼Œè€Œä¸”è¿™äº›æ“ä½œéƒ½æ˜¯åŽŸå­æ€§çš„ã€‚redisæ”¯æŒå„ç§ä¸åŒæ–¹å¼çš„æŽ’åºã€‚ä¿è¯æ•ˆçŽ‡çš„æƒ…å†µä¸‹ï¼Œæ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚åŒæ—¶redisæä¾›äº†æŒä¹…åŒ–ç­–ç•¥ï¼Œä¸åŒçš„ç­–ç•¥è§¦å‘åŒæ­¥åˆ°ç£ç›˜æˆ–è€…æŠŠä¿®æ”¹æ“ä½œå†™å…¥è¿½åŠ çš„è®°å½•æ–‡ä»¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå®žçŽ°äº†master-slaveã€‚ å®ƒæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å­˜å‚¨ç³»ç»Ÿï¼Œèƒ½æ”¯æŒè¶…è¿‡ 100K+ æ¯ç§’çš„è¯»å†™é¢‘çŽ‡ã€‚åŒæ—¶è¿˜æ”¯æŒæ¶ˆæ¯çš„å‘å¸ƒ/è®¢é˜…ï¼Œä»Žè€Œè®©ä½ åœ¨æž„å»ºé«˜æ€§èƒ½æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿæ—¶å¤šäº†å¦ä¸€ç§é€‰æ‹©ã€‚ Redisæ”¯æŒä¸»ä»ŽåŒæ­¥ã€‚æ•°æ®å¯ä»¥ä»Žä¸»æœåŠ¡å™¨å‘ä»»æ„æ•°é‡çš„ä»ŽæœåŠ¡å™¨ä¸ŠåŒæ­¥ï¼Œä»ŽæœåŠ¡å™¨å¯ä»¥æ˜¯å…³è”å…¶ä»–ä»ŽæœåŠ¡å™¨çš„ä¸»æœåŠ¡å™¨ã€‚è¿™ä½¿å¾—Rediså¯æ‰§è¡Œå•å±‚æ ‘å¤åˆ¶ã€‚å­˜ç›˜å¯ä»¥æœ‰æ„æ— æ„çš„å¯¹æ•°æ®è¿›è¡Œå†™æ“ä½œã€‚ç”±äºŽå®Œå…¨å®žçŽ°äº†å‘å¸ƒ/è®¢é˜…æœºåˆ¶ï¼Œä½¿å¾—ä»Žæ•°æ®åº“åœ¨ä»»ä½•åœ°æ–¹åŒæ­¥æ ‘æ—¶ï¼Œå¯è®¢é˜…ä¸€ä¸ªé¢‘é“å¹¶æŽ¥æ”¶ä¸»æœåŠ¡å™¨å®Œæ•´çš„æ¶ˆæ¯å‘å¸ƒè®°å½•ã€‚åŒæ­¥å¯¹è¯»å–æ“ä½œçš„å¯æ‰©å±•æ€§å’Œæ•°æ®å†—ä½™å¾ˆæœ‰å¸®åŠ©ã€‚ 2. ä¸»ä»Žredisæ”¯æŒmaster-slaveæ¨¡å¼ï¼Œä¸€ä¸»å¤šä»Žï¼Œredis serverå¯ä»¥è®¾ç½®å¦å¤–å¤šä¸ªredis serverä¸ºslaveï¼Œä»ŽæœºåŒæ­¥ä¸»æœºçš„æ•°æ®ã€‚é…ç½®åŽï¼Œè¯»å†™åˆ†ç¦»ï¼Œä¸»æœºè´Ÿè´£è¯»å†™æœåŠ¡ï¼Œä»Žæœºåªè´Ÿè´£è¯»ã€‚å‡è½»ä¸»æœºçš„åŽ‹åŠ›ã€‚rediså®žçŽ°çš„æ˜¯æœ€ç»ˆä¼šä¸€è‡´æ€§ï¼Œå…·ä½“é€‰æ‹©å¼ºä¸€è‡´æ€§è¿˜æ˜¯å¼±ä¸€è‡´æ€§ï¼Œå–å†³äºŽä¸šåŠ¡åœºæ™¯ã€‚redis ä¸»ä»ŽåŒæ­¥æœ‰ä¸¤ç§æ–¹å¼ï¼ˆæˆ–è€…æ‰€ä¸¤ä¸ªé˜¶æ®µï¼‰ï¼šå…¨åŒæ­¥å’Œéƒ¨åˆ†åŒæ­¥ã€‚ ä¸»ä»Žåˆšåˆšè¿žæŽ¥çš„æ—¶å€™ï¼Œè¿›è¡Œå…¨åŒæ­¥ï¼›å…¨åŒæ­¥ç»“æŸåŽï¼Œè¿›è¡Œéƒ¨åˆ†åŒæ­¥ã€‚å½“ç„¶ï¼Œå¦‚æžœæœ‰éœ€è¦ï¼Œslave åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥å‘èµ·å…¨åŒæ­¥ã€‚redis ç­–ç•¥æ˜¯ï¼Œæ— è®ºå¦‚ä½•ï¼Œé¦–å…ˆä¼šå°è¯•è¿›è¡Œéƒ¨åˆ†åŒæ­¥ï¼Œå¦‚ä¸æˆåŠŸï¼Œè¦æ±‚ä»Žæœºè¿›è¡Œå…¨åŒæ­¥ï¼Œå¹¶å¯åŠ¨ BGSAVEâ€¦â€¦BGSAVE ç»“æŸåŽï¼Œä¼ è¾“ RDB æ–‡ä»¶ï¼›å¦‚æžœæˆåŠŸï¼Œå…è®¸ä»Žæœºè¿›è¡Œéƒ¨åˆ†åŒæ­¥ï¼Œå¹¶ä¼ è¾“ç§¯åŽ‹ç©ºé—´ä¸­çš„æ•°æ®ã€‚ç®€å•æ¥è¯´ï¼Œä¸»ä»ŽåŒæ­¥å°±æ˜¯ RDB æ–‡ä»¶çš„ä¸Šä¼ ä¸‹è½½ï¼›ä¸»æœºæœ‰å°éƒ¨åˆ†çš„æ•°æ®ä¿®æ”¹ï¼Œå°±æŠŠä¿®æ”¹è®°å½•ä¼ æ’­ç»™æ¯ä¸ªä»Žæœºã€‚ 3. redisé›†ç¾¤ä¸»ä»Žæ¨¡å¼å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œmasterå®•æœºä¹‹åŽï¼Œä»Žæœºåªèƒ½è¯»ï¼Œä¸å¯å†™ï¼Œä¸èƒ½ä¿è¯é«˜å¯ç”¨ã€‚redisé›†ç¾¤æŠ€æœ¯æ˜¯æž„å»ºé«˜æ€§èƒ½ç½‘ç«™æž¶æž„çš„é‡è¦æ‰‹æ®µï¼Œè¯•æƒ³åœ¨ç½‘ç«™æ‰¿å—é«˜å¹¶å‘è®¿é—®åŽ‹åŠ›çš„åŒæ—¶ï¼Œè¿˜éœ€è¦ä»Žæµ·é‡æ•°æ®ä¸­æŸ¥è¯¢å‡ºæ»¡è¶³æ¡ä»¶çš„æ•°æ®ï¼Œå¹¶å¿«é€Ÿå“åº”ï¼Œæˆ‘ä»¬å¿…ç„¶æƒ³åˆ°çš„æ˜¯å°†æ•°æ®è¿›è¡Œåˆ‡ç‰‡ï¼ŒæŠŠæ•°æ®æ ¹æ®æŸç§è§„åˆ™æ”¾å…¥å¤šä¸ªä¸åŒçš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œæ¥é™ä½Žå•èŠ‚ç‚¹æœåŠ¡å™¨çš„åŽ‹åŠ›ã€‚ Redis Clusteré‡‡ç”¨æ— ä¸­å¿ƒç»“æž„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜æ•°æ®å’Œæ•´ä¸ªé›†ç¾¤çŠ¶æ€,æ¯ä¸ªèŠ‚ç‚¹éƒ½å’Œå…¶ä»–æ‰€æœ‰èŠ‚ç‚¹è¿žæŽ¥ã€‚èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨gossipåè®®ä¼ æ’­ä¿¡æ¯ä»¥åŠå‘çŽ°æ–°èŠ‚ç‚¹ã€‚ Redis é›†ç¾¤æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ï¼ˆdistributedï¼‰ã€å®¹é”™ï¼ˆfault-tolerantï¼‰çš„ Redis å®žçŽ°ï¼Œé›†ç¾¤å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½æ˜¯æ™®é€šå•æœº Redis æ‰€èƒ½ä½¿ç”¨çš„åŠŸèƒ½çš„ä¸€ä¸ªå­é›†ï¼ˆsubsetï¼‰ã€‚ Redis é›†ç¾¤ä¸­ä¸å­˜åœ¨ä¸­å¿ƒï¼ˆcentralï¼‰èŠ‚ç‚¹æˆ–è€…ä»£ç†ï¼ˆproxyï¼‰èŠ‚ç‚¹ï¼Œé›†ç¾¤çš„å…¶ä¸­ä¸€ä¸ªä¸»è¦è®¾è®¡ç›®æ ‡æ˜¯è¾¾åˆ°çº¿æ€§å¯æ‰©å±•æ€§ï¼ˆlinear scalabilityï¼‰ã€‚ Redis é›†ç¾¤ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰è€Œç‰ºç‰²äº†ä¸€éƒ¨åˆ†å®¹é”™æ€§ï¼šç³»ç»Ÿä¼šåœ¨ä¿è¯å¯¹ç½‘ç»œæ–­çº¿ï¼ˆnet splitï¼‰å’ŒèŠ‚ç‚¹å¤±æ•ˆï¼ˆnode failureï¼‰å…·æœ‰æœ‰é™ï¼ˆlimitedï¼‰æŠµæŠ—åŠ›çš„å‰æä¸‹ï¼Œå°½å¯èƒ½åœ°ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚ 4. å®‰è£…éƒ¨ç½²rediså®‰è£…è¾ƒä¸ºç®€å•ï¼Œå®˜ç½‘ä¸‹è½½åŽ‹ç¼©åŒ…è§£åŽ‹ã€‚é›†ç¾¤æ¨¡å¼éœ€è¦rubyçš„ç¼–è¯‘çŽ¯å¢ƒï¼Œé›†ç¾¤æœ€å°çš„é…ç½®ä¸º3å°masterï¼Œå°äºŽ3åˆ™å¯åŠ¨é›†ç¾¤æŠ¥é”™ã€‚redisç‰ˆæœ¬ï¼š3.2.4 4.1 ä¸»ä»Žæ¨¡å¼æ‹“æ‰‘å›¾ ä¸»ä»Žæ¨¡å¼é‡‡ç”¨ä¸€ä¸»ä¸‰ä»Žï¼Œä¸»ä»Žéƒ½é…ç½®authè®¤è¯ï¼Œè¯»å†™åˆ†ç¦»ã€‚ä¸»è¦å®žéªŒçš„åŠ¨ä½œï¼š1ï¼‰å¤šä¸ªapp åŒæ—¶å†™ï¼Œæµ‹å®šå†™é€ŸçŽ‡ï¼›2ï¼‰å¤šä¸ªapp åŒæ—¶å†™ï¼ŒåŒæ—¶æœ‰è¯»çš„è¿›ç¨‹ï¼Œæµ‹å®šè¯»å†™é€ŸçŽ‡ï¼›3ï¼‰masterä¸»æœºå®•æœºï¼Œappä¾ç„¶è¿›è¡Œè¯»å†™ã€‚ 4.2 clusteræ‹“æ‰‘å›¾å¦‚ä¸‹ é›†ç¾¤æ¨¡å¼é‡‡ç”¨å››ä¸»å››ä»Žï¼Œä¹Ÿæ˜¯é‡‡ç”¨è¯»å†™åˆ†ç¦»ã€‚ä¸»è¦å®žéªŒçš„åŠ¨ä½œï¼š1ï¼‰æœ‰ä¸€ä¸ªmasterå®•æœºï¼Œè§‚å¯Ÿæ—¥å¿—ï¼Œæ–°çš„slaveæˆä¸ºmasterï¼›2ï¼‰masterå®•æœºåŽï¼Œé‡æ–°å¯åŠ¨ï¼Œmasteræˆä¸ºslaveï¼›3ï¼‰é›†ç¾¤å…¨éƒ¨å®•æœºï¼Œredisä¸»æœºé‡å¯ï¼Œæ•°æ®æœªä¸¢å¤±ã€‚ 5. åŽŸç†5.1 ä¸€è‡´æ€§filesnapshot:é»˜è®¤redisæ˜¯ä¼šä»¥å¿«ç…§çš„å½¢å¼å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜,åœ¨é…ç½®æ–‡ä»¶ä¸­çš„æ ¼å¼æ˜¯ï¼šsave N Mè¡¨ç¤ºåœ¨Nç§’ä¹‹å†…ï¼Œredisè‡³å°‘å‘ç”ŸMæ¬¡ä¿®æ”¹åˆ™redisæŠ“å¿«ç…§åˆ°ç£ç›˜ã€‚ å·¥ä½œåŽŸç†ï¼šå½“rediséœ€è¦åšæŒä¹…åŒ–æ—¶ï¼Œredisä¼šforkä¸€ä¸ªå­è¿›ç¨‹ï¼›å­è¿›ç¨‹å°†æ•°æ®å†™åˆ°ç£ç›˜ä¸Šä¸€ä¸ªä¸´æ—¶RDBæ–‡ä»¶ä¸­ï¼›å½“å­è¿›ç¨‹å®Œæˆå†™ä¸´æ—¶æ–‡ä»¶åŽï¼Œå°†åŽŸæ¥çš„RDBæ›¿æ¢æŽ‰ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯å¯ä»¥copy-on-writeã€‚ Append-onlyï¼šfilesnapshottingæ–¹æ³•åœ¨rediså¼‚å¸¸æ­»æŽ‰æ—¶ï¼Œ æœ€è¿‘çš„æ•°æ®ä¼šä¸¢å¤±ï¼ˆä¸¢å¤±æ•°æ®çš„å¤šå°‘è§†ä½ saveç­–ç•¥çš„é…ç½®ï¼‰ï¼Œæ‰€ä»¥è¿™æ˜¯å®ƒæœ€å¤§çš„ç¼ºç‚¹ï¼Œå½“ä¸šåŠ¡é‡å¾ˆå¤§æ—¶ï¼Œä¸¢å¤±çš„æ•°æ®æ˜¯å¾ˆå¤šçš„ã€‚Append-onlyæ–¹æ³•å¯ ä»¥åšåˆ°å…¨éƒ¨æ•°æ®ä¸ä¸¢å¤±ï¼Œä½†redisçš„æ€§èƒ½å°±è¦å·®äº›ã€‚AOFå°±å¯ä»¥åšåˆ°å…¨ç¨‹æŒä¹…åŒ–ï¼Œåªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯ï¼ˆé»˜è®¤æ˜¯noï¼‰ï¼Œappendonly yeså¼€å¯AOFä¹‹åŽï¼Œredisæ¯æ‰§è¡Œä¸€ä¸ªä¿®æ”¹æ•°æ®çš„å‘½ä»¤ï¼Œéƒ½ä¼šæŠŠå®ƒæ·»åŠ åˆ°aofæ–‡ä»¶ä¸­ï¼Œå½“redisé‡å¯æ—¶ï¼Œå°†ä¼šè¯»å–AOFæ–‡ä»¶è¿›è¡Œâ€œé‡æ”¾â€ä»¥æ¢å¤åˆ° rediså…³é—­å‰çš„æœ€åŽæ—¶åˆ»ã€‚ AOFæ–‡ä»¶åˆ·æ–°çš„æ–¹å¼ï¼Œæœ‰ä¸‰ç§ï¼Œå‚è€ƒé…ç½®å‚æ•°appendfsync ï¼š appendfsync alwaysæ¯æäº¤ä¸€ä¸ªä¿®æ”¹å‘½ä»¤éƒ½è°ƒç”¨fsyncåˆ·æ–°åˆ°AOFæ–‡ä»¶ï¼Œéžå¸¸éžå¸¸æ…¢ï¼Œä½†ä¹Ÿéžå¸¸å®‰å…¨ï¼› appendfsync everysecæ¯ç§’é’Ÿéƒ½è°ƒç”¨fsyncåˆ·æ–°åˆ°AOFæ–‡ä»¶ï¼Œå¾ˆå¿«ï¼Œä½†å¯èƒ½ä¼šä¸¢å¤±ä¸€ç§’ä»¥å†…çš„æ•°æ®ï¼› appendfsync noä¾é OSè¿›è¡Œåˆ·æ–°ï¼Œredisä¸ä¸»åŠ¨åˆ·æ–°AOFï¼Œè¿™æ ·æœ€å¿«ï¼Œä½†å®‰å…¨æ€§å°±å·®ã€‚é»˜è®¤å¹¶æŽ¨èæ¯ç§’åˆ·æ–°ï¼Œè¿™æ ·åœ¨é€Ÿåº¦å’Œå®‰å…¨ä¸Šéƒ½åšåˆ°äº†å…¼é¡¾ã€‚ SlaveåŒæ ·å¯ä»¥æŽ¥å—å…¶å®ƒSlavesçš„è¿žæŽ¥å’ŒåŒæ­¥è¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆçš„åˆ†è½½Masterçš„åŒæ­¥åŽ‹åŠ›ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å°†Redisçš„Replicationæž¶æž„è§†ä¸ºå›¾ç»“æž„ã€‚ Master Serveræ˜¯ä»¥éžé˜»å¡žçš„æ–¹å¼ä¸ºSlavesæä¾›æœåŠ¡ã€‚æ‰€ä»¥åœ¨Master-SlaveåŒæ­¥æœŸé—´ï¼Œå®¢æˆ·ç«¯ä»ç„¶å¯ä»¥æäº¤æŸ¥è¯¢æˆ–ä¿®æ”¹è¯·æ±‚ã€‚ Slave ServeråŒæ ·æ˜¯ä»¥éžé˜»å¡žçš„æ–¹å¼å®Œæˆæ•°æ®åŒæ­¥ã€‚åœ¨åŒæ­¥æœŸé—´ï¼Œå¦‚æžœæœ‰å®¢æˆ·ç«¯æäº¤æŸ¥è¯¢è¯·æ±‚ï¼ŒRedisåˆ™è¿”å›žåŒæ­¥ä¹‹å‰çš„æ•°æ®ã€‚ ä¸ºäº†åˆ†è½½Masterçš„è¯»æ“ä½œåŽ‹åŠ›ï¼ŒSlaveæœåŠ¡å™¨å¯ä»¥ä¸ºå®¢æˆ·ç«¯æä¾›åªè¯»æ“ä½œçš„æœåŠ¡ï¼Œå†™æœåŠ¡ä»ç„¶å¿…é¡»ç”±Masteræ¥å®Œæˆã€‚å³ä¾¿å¦‚æ­¤ï¼Œç³»ç»Ÿçš„ä¼¸ç¼©æ€§è¿˜æ˜¯å¾—åˆ°äº†å¾ˆå¤§çš„æé«˜ã€‚ Masterå¯ä»¥å°†æ•°æ®ä¿å­˜æ“ä½œäº¤ç»™Slaveså®Œæˆï¼Œä»Žè€Œé¿å…äº†åœ¨Masterä¸­è¦æœ‰ç‹¬ç«‹çš„è¿›ç¨‹æ¥å®Œæˆæ­¤æ“ä½œã€‚Redisåœ¨masteræ˜¯éžé˜»å¡žæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨slaveæ‰§è¡Œæ•°æ®åŒæ­¥çš„æ—¶å€™ï¼Œmasteræ˜¯å¯ä»¥æŽ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚çš„ï¼Œå¹¶ä¸å½±å“åŒæ­¥æ•°æ®çš„ä¸€è‡´æ€§ï¼Œç„¶è€Œåœ¨slaveç«¯æ˜¯é˜»å¡žæ¨¡å¼çš„ï¼Œslaveåœ¨åŒæ­¥masteræ•°æ®æ—¶ï¼Œå¹¶ä¸èƒ½å¤Ÿå“åº”å®¢æˆ·ç«¯çš„æŸ¥è¯¢ã€‚ 5.2 Replicationçš„å·¥ä½œåŽŸç†(1)SlaveæœåŠ¡å™¨è¿žæŽ¥åˆ°MasteræœåŠ¡å™¨ã€‚(2)SlaveæœåŠ¡å™¨å‘é€SYCNå‘½ä»¤ã€‚(3)MasteræœåŠ¡å™¨å¤‡ä»½æ•°æ®åº“åˆ°.rdbæ–‡ä»¶ã€‚(4)MasteræœåŠ¡å™¨æŠŠ.rdbæ–‡ä»¶ä¼ è¾“ç»™SlaveæœåŠ¡å™¨ã€‚(5)SlaveæœåŠ¡å™¨æŠŠ.rdbæ–‡ä»¶æ•°æ®å¯¼å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ åœ¨Slaveå¯åŠ¨å¹¶è¿žæŽ¥åˆ°Masterä¹‹åŽï¼Œå®ƒå°†ä¸»åŠ¨å‘é€ä¸€ä¸ªSYNCå‘½ä»¤ã€‚æ­¤åŽMasterå°†å¯åŠ¨åŽå°å­˜ç›˜è¿›ç¨‹ï¼ŒåŒæ—¶æ”¶é›†æ‰€æœ‰æŽ¥æ”¶åˆ°çš„ç”¨äºŽä¿®æ”¹æ•°æ®é›† çš„å‘½ä»¤ï¼Œåœ¨åŽå°è¿›ç¨‹æ‰§è¡Œå®Œæ¯•åŽï¼ŒMasterå°†ä¼ é€æ•´ä¸ªæ•°æ®åº“æ–‡ä»¶åˆ°Slaveï¼Œä»¥å®Œæˆä¸€æ¬¡å®Œå…¨åŒæ­¥ã€‚è€ŒSlaveæœåŠ¡å™¨åœ¨æŽ¥æ”¶åˆ°æ•°æ®åº“æ–‡ä»¶æ•°æ®ä¹‹åŽå°†å…¶ å­˜ç›˜å¹¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æ­¤åŽï¼ŒMasterç»§ç»­å°†æ‰€æœ‰å·²ç»æ”¶é›†åˆ°çš„ä¿®æ”¹å‘½ä»¤ï¼Œå’Œæ–°çš„ä¿®æ”¹å‘½ä»¤ä¾æ¬¡ä¼ é€ç»™Slavesï¼ŒSlaveå°†åœ¨æœ¬æ¬¡æ‰§è¡Œè¿™äº›æ•°æ®ä¿®æ”¹å‘½ä»¤ï¼Œä»Žè€Œè¾¾åˆ°æœ€ç»ˆçš„æ•°æ®åŒæ­¥ã€‚å¦‚æžœMasterå’ŒSlaveä¹‹é—´çš„é“¾æŽ¥å‡ºçŽ°æ–­è¿žçŽ°è±¡ï¼ŒSlaveå¯ä»¥è‡ªåŠ¨é‡è¿žMasterï¼Œä½†æ˜¯åœ¨è¿žæŽ¥æˆåŠŸä¹‹åŽï¼Œä¸€æ¬¡å®Œå…¨åŒæ­¥å°†è¢«è‡ªåŠ¨æ‰§è¡Œã€‚ 5.3 ä¸€è‡´æ€§å“ˆå¸Œé›†ç¾¤è¦å®žçŽ°çš„ç›®çš„æ˜¯è¦å°†ä¸åŒçš„ key åˆ†æ•£æ”¾ç½®åˆ°ä¸åŒçš„ redis èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè§„åˆ™æˆ–è€…ç®—æ³•ï¼Œé€šå¸¸çš„åšæ³•æ˜¯èŽ·å– key çš„å“ˆå¸Œå€¼ï¼Œç„¶åŽæ ¹æ®èŠ‚ç‚¹æ•°æ¥æ±‚æ¨¡ï¼Œä½†è¿™ç§åšæ³•æœ‰å…¶æ˜Žæ˜¾çš„å¼Šç«¯ï¼Œå½“æˆ‘ä»¬éœ€è¦å¢žåŠ æˆ–å‡å°‘ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šé€ æˆå¤§é‡çš„ key æ— æ³•å‘½ä¸­ï¼Œè¿™ç§æ¯”ä¾‹æ˜¯ç›¸å½“é«˜çš„ï¼Œæ‰€ä»¥å°±æœ‰äººæå‡ºäº†ä¸€è‡´æ€§å“ˆå¸Œçš„æ¦‚å¿µã€‚ä¸€è‡´æ€§å“ˆå¸Œæœ‰å››ä¸ªé‡è¦ç‰¹å¾ï¼š å‡è¡¡æ€§ï¼šä¹Ÿæœ‰äººæŠŠå®ƒå®šä¹‰ä¸ºå¹³è¡¡æ€§ï¼Œæ˜¯æŒ‡å“ˆå¸Œçš„ç»“æžœèƒ½å¤Ÿå°½å¯èƒ½åˆ†å¸ƒåˆ°æ‰€æœ‰çš„èŠ‚ç‚¹ä¸­åŽ»ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆçš„åˆ©ç”¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„èµ„æºã€‚ å•è°ƒæ€§ï¼šå¯¹äºŽå•è°ƒæ€§æœ‰å¾ˆå¤šç¿»è¯‘è®©æˆ‘éžå¸¸çš„ä¸è§£ï¼Œè€Œæˆ‘æƒ³è¦çš„æ˜¯å½“èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶å“ˆå¸Œçš„ç»“æžœåº”å°½å¯èƒ½çš„ä¿æŠ¤å·²åˆ†é…çš„å†…å®¹ä¸ä¼šè¢«é‡æ–°åˆ†æ´¾åˆ°æ–°çš„èŠ‚ç‚¹ã€‚ åˆ†æ•£æ€§å’Œè´Ÿè½½ï¼šè¿™ä¸¤ä¸ªå…¶å®žæ˜¯å·®ä¸å¤šçš„æ„æ€ï¼Œå°±æ˜¯è¦æ±‚ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¯¹ key å“ˆå¸Œåº”å°½å¯èƒ½çš„é¿å…é‡å¤ã€‚ Redis é›†ç¾¤ä¸­å†…ç½®äº† 16384 ä¸ªå“ˆå¸Œæ§½ï¼Œå½“éœ€è¦åœ¨ Redis é›†ç¾¤ä¸­æ”¾ç½®ä¸€ä¸ª key-value æ—¶ï¼Œredis å…ˆå¯¹ key ä½¿ç”¨ crc16 ç®—æ³•ç®—å‡ºä¸€ä¸ªç»“æžœï¼Œç„¶åŽæŠŠç»“æžœå¯¹ 16384 æ±‚ä½™æ•°ï¼Œè¿™æ ·æ¯ä¸ª key éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç¼–å·åœ¨ 0-16383 ä¹‹é—´çš„å“ˆå¸Œæ§½ï¼Œredis ä¼šæ ¹æ®èŠ‚ç‚¹æ•°é‡å¤§è‡´å‡ç­‰çš„å°†å“ˆå¸Œæ§½æ˜ å°„åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚ ä½¿ç”¨å“ˆå¸Œæ§½çš„å¥½å¤„å°±åœ¨äºŽå¯ä»¥æ–¹ä¾¿çš„æ·»åŠ æˆ–ç§»é™¤èŠ‚ç‚¹ã€‚ å½“éœ€è¦å¢žåŠ èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠå…¶ä»–èŠ‚ç‚¹çš„æŸäº›å“ˆå¸Œæ§½æŒªåˆ°æ–°èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼› å½“éœ€è¦ç§»é™¤èŠ‚ç‚¹æ—¶ï¼Œåªéœ€è¦æŠŠç§»é™¤èŠ‚ç‚¹ä¸Šçš„å“ˆå¸Œæ§½æŒªåˆ°å…¶ä»–èŠ‚ç‚¹å°±è¡Œäº†ï¼› å½“è®¾ç½®äº†ä¸»ä»Žå…³ç³»åŽï¼Œslave åœ¨ç¬¬ä¸€æ¬¡è¿žæŽ¥æˆ–è€…é‡æ–°è¿žæŽ¥ master æ—¶ï¼Œslave éƒ½ä¼šå‘é€ä¸€æ¡åŒæ­¥æŒ‡ä»¤ç»™ masterï¼› master æŽ¥åˆ°æŒ‡ä»¤åŽï¼Œå¼€å§‹å¯åŠ¨åŽå°ä¿å­˜è¿›ç¨‹ä¿å­˜æ•°æ®ï¼ŒæŽ¥ç€æ”¶é›†æ‰€æœ‰çš„æ•°æ®ä¿®æ”¹æŒ‡ä»¤ã€‚åŽå°ä¿å­˜å®Œäº†ï¼Œmaster å°±æŠŠè¿™ä»½æ•°æ®å‘é€ç»™ slaveï¼Œslave å…ˆæŠŠæ•°æ®ä¿å­˜åˆ°ç£ç›˜ï¼Œç„¶åŽæŠŠå®ƒåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œmaster æŽ¥ç€å°±æŠŠæ”¶é›†çš„æ•°æ®ä¿®æ”¹æŒ‡ä»¤ä¸€è¡Œä¸€è¡Œçš„å‘ç»™ slaveï¼Œslave æŽ¥æ”¶åˆ°ä¹‹åŽé‡æ–°æ‰§è¡Œè¯¥æŒ‡ä»¤ï¼Œè¿™æ ·å°±å®žçŽ°äº†æ•°æ®åŒæ­¥ã€‚ slave åœ¨ä¸Ž master å¤±åŽ»è”ç³»åŽï¼Œè‡ªåŠ¨çš„é‡æ–°è¿žæŽ¥ã€‚å¦‚æžœ master æ”¶åˆ°äº†å¤šä¸ª slave çš„åŒæ­¥è¯·æ±‚ï¼Œå®ƒä¼šæ‰§è¡Œå•ä¸ªåŽå°ä¿å­˜æ¥ä¸ºæ‰€æœ‰çš„ slave æœåŠ¡ã€‚ 5.4 èŠ‚ç‚¹å¤±æ•ˆæ£€æµ‹ä»¥ä¸‹æ˜¯èŠ‚ç‚¹å¤±æ•ˆæ£€æŸ¥çš„å®žçŽ°æ–¹æ³•ï¼š å½“ä¸€ä¸ªèŠ‚ç‚¹å‘å¦ä¸€ä¸ªèŠ‚ç‚¹å‘é€ PING å‘½ä»¤ï¼Œä½†æ˜¯ç›®æ ‡èŠ‚ç‚¹æœªèƒ½åœ¨ç»™å®šçš„æ—¶é™å†…è¿”å›ž PING å‘½ä»¤çš„å›žå¤æ—¶ï¼Œé‚£ä¹ˆå‘é€å‘½ä»¤çš„èŠ‚ç‚¹ä¼šå°†ç›®æ ‡èŠ‚ç‚¹æ ‡è®°ä¸ºPFAIL ï¼ˆpossible failureï¼Œå¯èƒ½å·²å¤±æ•ˆï¼‰ã€‚ ç­‰å¾… PING å‘½ä»¤å›žå¤çš„æ—¶é™ç§°ä¸ºâ€œèŠ‚ç‚¹è¶…æ—¶æ—¶é™ï¼ˆnode timeoutï¼‰â€ï¼Œæ˜¯ä¸€ä¸ªèŠ‚ç‚¹é€‰é¡¹ï¼ˆnode-wise settingï¼‰ã€‚ æ¯æ¬¡å½“èŠ‚ç‚¹å¯¹å…¶ä»–èŠ‚ç‚¹å‘é€ PING å‘½ä»¤çš„æ—¶å€™ï¼Œå®ƒéƒ½ä¼šéšæœºåœ°å¹¿æ’­ä¸‰ä¸ªå®ƒæ‰€çŸ¥é“çš„èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é‡Œé¢çš„å…¶ä¸­ä¸€é¡¹å°±æ˜¯è¯´æ˜ŽèŠ‚ç‚¹æ˜¯å¦å·²ç»è¢«æ ‡è®°ä¸º PFAIL æˆ–è€… FAIL ã€‚ å½“èŠ‚ç‚¹æŽ¥æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„ä¿¡æ¯æ—¶ï¼Œå®ƒä¼šè®°ä¸‹é‚£äº›è¢«å…¶ä»–èŠ‚ç‚¹æ ‡è®°ä¸ºå¤±æ•ˆçš„èŠ‚ç‚¹ã€‚è¿™ç§°ä¸ºå¤±æ•ˆæŠ¥å‘Šï¼ˆfailure reportï¼‰ã€‚ å¦‚æžœèŠ‚ç‚¹å·²ç»å°†æŸä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º PFAIL ï¼Œå¹¶ä¸”æ ¹æ®èŠ‚ç‚¹æ‰€æ”¶åˆ°çš„å¤±æ•ˆæŠ¥å‘Šæ˜¾å¼ï¼Œé›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†å…¶ä»–ä¸»èŠ‚ç‚¹ä¹Ÿè®¤ä¸ºé‚£ä¸ªèŠ‚ç‚¹è¿›å…¥äº†å¤±æ•ˆçŠ¶æ€ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼šå°†é‚£ä¸ªå¤±æ•ˆèŠ‚ç‚¹çš„çŠ¶æ€æ ‡è®°ä¸º FAIL ã€‚ ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹è¢«æ ‡è®°ä¸º FAIL ï¼Œå…³äºŽè¿™ä¸ªèŠ‚ç‚¹å·²å¤±æ•ˆçš„ä¿¡æ¯å°±ä¼šè¢«å¹¿æ’­åˆ°æ•´ä¸ªé›†ç¾¤ï¼Œæ‰€æœ‰æŽ¥æ”¶åˆ°è¿™æ¡ä¿¡æ¯çš„èŠ‚ç‚¹éƒ½ä¼šå°†å¤±æ•ˆèŠ‚ç‚¹æ ‡è®°ä¸º FAIL ã€‚ ç®€å•æ¥è¯´ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¦å°†å¦ä¸€ä¸ªèŠ‚ç‚¹æ ‡è®°ä¸ºå¤±æ•ˆï¼Œå¿…é¡»å…ˆè¯¢é—®å…¶ä»–èŠ‚ç‚¹çš„æ„è§ï¼Œå¹¶ä¸”å¾—åˆ°å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹çš„åŒæ„æ‰è¡Œã€‚å› ä¸ºè¿‡æœŸçš„å¤±æ•ˆæŠ¥å‘Šä¼šè¢«ç§»é™¤ï¼Œæ‰€ä»¥ä¸»èŠ‚ç‚¹è¦å°†æŸä¸ªèŠ‚ç‚¹æ ‡è®°ä¸º FAIL çš„è¯ï¼Œå¿…é¡»ä»¥æœ€è¿‘æŽ¥æ”¶åˆ°çš„å¤±æ•ˆæŠ¥å‘Šä½œä¸ºæ ¹æ®ã€‚åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸­ï¼ŒèŠ‚ç‚¹çš„ FAIL çŠ¶æ€ä¼šè¢«ç§»é™¤ï¼š å¦‚æžœè¢«æ ‡è®°ä¸º FAIL çš„æ˜¯ä»ŽèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªèŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œ FAIL æ ‡è®°å°±ä¼šè¢«ç§»é™¤ã€‚ä¿æŒï¼ˆretaningï¼‰ä»ŽèŠ‚ç‚¹çš„ FAIL çŠ¶æ€æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå®ƒä¸å¤„ç†ä»»ä½•æ§½ï¼Œä¸€ä¸ªä»ŽèŠ‚ç‚¹æ˜¯å¦å¤„äºŽ FAIL çŠ¶æ€ï¼Œå†³å®šäº†è¿™ä¸ªä»ŽèŠ‚ç‚¹åœ¨æœ‰éœ€è¦æ—¶èƒ½å¦è¢«æå‡ä¸ºä¸»èŠ‚ç‚¹ã€‚ å¦‚æžœä¸€ä¸ªä¸»èŠ‚ç‚¹è¢«æ‰“ä¸Š FAIL æ ‡è®°ä¹‹åŽï¼Œç»è¿‡äº†èŠ‚ç‚¹è¶…æ—¶æ—¶é™çš„å››å€æ—¶é—´ï¼Œå†åŠ ä¸Šåç§’é’Ÿä¹‹åŽï¼Œé’ˆå¯¹è¿™ä¸ªä¸»èŠ‚ç‚¹çš„æ§½çš„æ•…éšœè½¬ç§»æ“ä½œä»æœªå®Œæˆï¼Œå¹¶ä¸”è¿™ä¸ªä¸»èŠ‚ç‚¹å·²ç»é‡æ–°ä¸Šçº¿çš„è¯ï¼Œé‚£ä¹ˆç§»é™¤å¯¹è¿™ä¸ªèŠ‚ç‚¹çš„ FAIL æ ‡è®°ã€‚ åœ¨ç¬¬äºŒç§æƒ…å†µä¸­ï¼Œå¦‚æžœæ•…éšœè½¬ç§»æœªèƒ½é¡ºåˆ©å®Œæˆï¼Œå¹¶ä¸”ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿ï¼Œé‚£ä¹ˆé›†ç¾¤å°±ç»§ç»­ä½¿ç”¨åŽŸæ¥çš„ä¸»èŠ‚ç‚¹ï¼Œä»Žè€Œå…åŽ»ç®¡ç†å‘˜ä»‹å…¥çš„å¿…è¦ã€‚ 5.5 ä»ŽèŠ‚ç‚¹é€‰ä¸¾ä¸€æ—¦æŸä¸ªä¸»èŠ‚ç‚¹è¿›å…¥ FAIL çŠ¶æ€ï¼Œå¦‚æžœè¿™ä¸ªä¸»èŠ‚ç‚¹æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä»ŽèŠ‚ç‚¹å­˜åœ¨ï¼Œé‚£ä¹ˆå…¶ä¸­ä¸€ä¸ªä»ŽèŠ‚ç‚¹ä¼šè¢«å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè€Œå…¶ä»–ä»ŽèŠ‚ç‚¹åˆ™ä¼šå¼€å§‹å¯¹è¿™ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ã€‚æ–°çš„ä¸»èŠ‚ç‚¹ç”±å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±žä¸‹çš„æ‰€æœ‰ä»ŽèŠ‚ç‚¹ä¸­è‡ªè¡Œé€‰ä¸¾äº§ç”Ÿï¼Œä»¥ä¸‹æ˜¯é€‰ä¸¾çš„æ¡ä»¶ï¼š è¿™ä¸ªèŠ‚ç‚¹æ˜¯å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„ä»ŽèŠ‚ç‚¹ã€‚ å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½æ•°é‡éžç©ºã€‚ ä»ŽèŠ‚ç‚¹çš„æ•°æ®è¢«è®¤ä¸ºæ˜¯å¯é çš„ï¼Œä¹Ÿå³æ˜¯ï¼Œä¸»ä»ŽèŠ‚ç‚¹ä¹‹é—´çš„å¤åˆ¶è¿žæŽ¥ï¼ˆreplication linkï¼‰çš„æ–­çº¿æ—¶é•¿ä¸èƒ½è¶…è¿‡èŠ‚ç‚¹è¶…æ—¶æ—¶é™ï¼ˆnode timeoutï¼‰ä¹˜ä»¥REDIS_CLUSTER_SLAVE_VALIDITY_MULT å¸¸é‡å¾—å‡ºçš„ç§¯ã€‚ å¦‚æžœä¸€ä¸ªä»ŽèŠ‚ç‚¹æ»¡è¶³äº†ä»¥ä¸Šçš„æ‰€æœ‰æ¡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªä»ŽèŠ‚ç‚¹å°†å‘é›†ç¾¤ä¸­çš„å…¶ä»–ä¸»èŠ‚ç‚¹å‘é€æŽˆæƒè¯·æ±‚ï¼Œè¯¢é—®å®ƒä»¬ï¼Œæ˜¯å¦å…è®¸è‡ªå·±ï¼ˆä»ŽèŠ‚ç‚¹ï¼‰å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚å¦‚æžœå‘é€æŽˆæƒè¯·æ±‚çš„ä»ŽèŠ‚ç‚¹æ»¡è¶³ä»¥ä¸‹å±žæ€§ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹å°†å‘ä»ŽèŠ‚ç‚¹è¿”å›ž FAILOVER_AUTH_GRANTED æŽˆæƒï¼ŒåŒæ„ä»ŽèŠ‚ç‚¹çš„å‡çº§è¦æ±‚ï¼š å‘é€æŽˆæƒè¯·æ±‚çš„æ˜¯ä¸€ä¸ªä»ŽèŠ‚ç‚¹ï¼Œå¹¶ä¸”å®ƒæ‰€å±žçš„ä¸»èŠ‚ç‚¹å¤„äºŽ FAIL çŠ¶æ€ã€‚ åœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰ä»ŽèŠ‚ç‚¹ä¸­ï¼Œè¿™ä¸ªä»ŽèŠ‚ç‚¹çš„èŠ‚ç‚¹ ID åœ¨æŽ’åºä¸­æ˜¯æœ€å°çš„ã€‚ ä»ŽèŠ‚ç‚¹å¤„äºŽæ­£å¸¸çš„è¿è¡ŒçŠ¶æ€ï¼šå®ƒæ²¡æœ‰è¢«æ ‡è®°ä¸º FAIL çŠ¶æ€ï¼Œä¹Ÿæ²¡æœ‰è¢«æ ‡è®°ä¸º PFAIL çŠ¶æ€ã€‚ ä¸€æ—¦æŸä¸ªä»ŽèŠ‚ç‚¹åœ¨ç»™å®šçš„æ—¶é™å†…å¾—åˆ°å¤§éƒ¨åˆ†ä¸»èŠ‚ç‚¹çš„æŽˆæƒï¼Œå®ƒå°±ä¼šå¼€å§‹æ‰§è¡Œä»¥ä¸‹æ•…éšœè½¬ç§»æ“ä½œï¼š é€šè¿‡ PONG æ•°æ®åŒ…ï¼ˆpacketï¼‰å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹çŽ°åœ¨æ˜¯ä¸»èŠ‚ç‚¹äº†ã€‚ é€šè¿‡ PONG æ•°æ®åŒ…å‘ŠçŸ¥å…¶ä»–èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªå·²å‡çº§çš„ä»ŽèŠ‚ç‚¹ï¼ˆpromoted slaveï¼‰ã€‚ æŽ¥ç®¡ï¼ˆclaimingï¼‰æ‰€æœ‰ç”±å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„å“ˆå¸Œæ§½ã€‚ æ˜¾å¼åœ°å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ä¸€ä¸ª PONG æ•°æ®åŒ…ï¼ŒåŠ é€Ÿå…¶ä»–èŠ‚ç‚¹è¯†åˆ«è¿™ä¸ªèŠ‚ç‚¹çš„è¿›åº¦ï¼Œè€Œä¸æ˜¯ç­‰å¾…å®šæ—¶çš„ PING / PONG æ•°æ®åŒ…ã€‚ æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹éƒ½ä¼šæ ¹æ®æ–°çš„ä¸»èŠ‚ç‚¹å¯¹é…ç½®è¿›è¡Œç›¸åº”çš„æ›´æ–°ï¼Œç‰¹åˆ«åœ°ï¼š a. æ‰€æœ‰è¢«æ–°çš„ä¸»èŠ‚ç‚¹æŽ¥ç®¡çš„æ§½ä¼šè¢«æ›´æ–°ã€‚ b. å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰ä»ŽèŠ‚ç‚¹ä¼šå¯Ÿè§‰åˆ° PROMOTED æ ‡å¿—ï¼Œå¹¶å¼€å§‹å¯¹æ–°çš„ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ã€‚ c.å¦‚æžœå·²ä¸‹çº¿çš„ä¸»èŠ‚ç‚¹é‡æ–°å›žåˆ°ä¸Šçº¿çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä¼šå¯Ÿè§‰åˆ° PROMOTED æ ‡å¿—ï¼Œå¹¶å°†è‡ªèº«è°ƒæ•´ä¸ºçŽ°ä»»ä¸»èŠ‚ç‚¹çš„ä»ŽèŠ‚ç‚¹ã€‚ åœ¨é›†ç¾¤çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¦‚æžœä¸€ä¸ªå¸¦æœ‰ PROMOTED æ ‡è¯†çš„ä¸»èŠ‚ç‚¹å› ä¸ºæŸäº›åŽŸå› è½¬å˜æˆäº†ä»ŽèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹å°†ä¸¢å¤±å®ƒæ‰€å¸¦æœ‰çš„ PROMOTED æ ‡è¯†ã€‚ 6. æ€»ç»“Redisé›†ç¾¤å…·æœ‰é«˜å¯ç”¨ï¼Œæ˜“äºŽè¿ç§»ï¼Œå­˜å–é€Ÿåº¦å¿«ç­‰ç‰¹ç‚¹ã€‚ä¹Ÿå¯ä»¥ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œæ”¯æŒpub/subæ¨¡å¼ï¼Œå…·ä½“ä¼˜ç¼ºç‚¹æ€»ç»“å¦‚ä¸‹ï¼šé¦–å…ˆä¼˜ç‚¹: redis åœ¨ä¸»èŠ‚ç‚¹ä¸‹çº¿åŽï¼Œä»ŽèŠ‚ç‚¹ä¼šè‡ªåŠ¨æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œæä¾›æœåŠ¡ redis å®•æœºèŠ‚ç‚¹æ¢å¤åŽï¼Œè‡ªåŠ¨ä¼šæ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œå˜æˆä»ŽèŠ‚ç‚¹ åŠ¨æ€æ‰©å±•å’Œåˆ é™¤èŠ‚ç‚¹ï¼Œrehash slotçš„åˆ†é…ï¼ŒåŸºäºŽæ¡¶çš„æ•°æ®åˆ†å¸ƒæ–¹å¼å¤§å¤§é™ä½Žäº†è¿ç§»æˆæœ¬ï¼Œåªéœ€å°†æ•°æ®æ¡¶ä»Žä¸€ä¸ªRedis Nodeè¿ç§»åˆ°å¦ä¸€ä¸ªRedis Nodeå³å¯å®Œæˆè¿ç§»ã€‚ Redis Clusterä½¿ç”¨å¼‚æ­¥å¤åˆ¶ã€‚ å…¶ç¼ºç‚¹ä¸º: ç”±äºŽredisçš„å¤åˆ¶ä½¿ç”¨å¼‚æ­¥æœºåˆ¶ï¼Œåœ¨è‡ªåŠ¨æ•…éšœè½¬ç§»çš„è¿‡ç¨‹ä¸­ï¼Œé›†ç¾¤å¯èƒ½ä¼šä¸¢å¤±å†™å‘½ä»¤ã€‚ç„¶è€Œ redis å‡ ä¹Žæ˜¯åŒæ—¶æ‰§è¡Œ(å°†å‘½ä»¤æ¢å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä»¥åŠå°†å‘½ä»¤å¤åˆ¶åˆ°ä»ŽèŠ‚ç‚¹)è¿™ä¸¤ä¸ªæ“ä½œï¼Œæ‰€ä»¥å®žé™…ä¸­ï¼Œå‘½ä»¤ä¸¢å¤±çš„çª—å£éžå¸¸å°ã€‚ æ™®é€šçš„ä¸»ä»Žæ¨¡å¼æ”¯æŒauthåŠ å¯†è®¤è¯ï¼Œè™½ç„¶æ¯”è¾ƒå¼±ï¼Œä½†å†™æˆ–è€…è¯»éƒ½è¦é€šè¿‡å¯†ç éªŒè¯ï¼Œclusterå¯¹å¯†ç æ”¯æŒä¸å¤ªå‹å¥½ï¼Œå¦‚æžœå¯¹é›†ç¾¤è®¾ç½®å¯†ç ï¼Œé‚£ä¹ˆrequirepasså’Œmasterauthéƒ½éœ€è¦è®¾ç½®ï¼Œå¦åˆ™å‘ç”Ÿä¸»ä»Žåˆ‡æ¢æ—¶ï¼Œå°±ä¼šé‡åˆ°æŽˆæƒé—®é¢˜ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¹¶è§‚å¯Ÿæ—¥å¿—ã€‚ å‚è€ƒèµ„æ–™ï¼š www.redis.io redis-clusterç ”ç©¶å’Œä½¿ç”¨ Redis Cluster 3.0æ­å»ºä¸Žä½¿ç”¨]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>redis</tag>
        <tag>mq</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç”±Consulè°ˆåˆ°Raft]]></title>
    <url>%2F2017%2F09%2F25%2Fraft%2F</url>
    <content type="text"><![CDATA[åœ¨å‰ä¸€ç¯‡æ–‡ç« consulé…ç½®ä¸Žå®žæˆ˜ä¸­ï¼Œä»‹ç»äº†consulçš„ä¸€äº›å†…å¹•åŠconsulé…ç½®ç›¸å…³ï¼Œå¹¶å¯¹é¡¹ç›®ä¸­çš„ä¸€äº›å®žé™…é…ç½®è¿›è¡Œå±•ç¤ºã€‚è¿™ç¯‡æ–‡ç« é‡ç‚¹ä»‹ç»consulä¸­æ‰€æ¶‰åŠåˆ°çš„ä¸€è‡´æ€§ç®—æ³•raftã€‚ 1. èƒŒæ™¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§æ˜¯ç›¸å½“é‡è¦çš„ï¼Œå³ä¸ºCAPç†è®ºä¸­çš„C(Consistency)ã€‚ä¸€è‡´æ€§åˆå¯ä»¥åˆ†ä¸ºå¼ºä¸€è‡´æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§ã€‚è¿™ç¯‡æ–‡ç« é‡ç‚¹è®¨è®ºå¼ºä¸€è‡´æ€§ç®—æ³•raftã€‚ Lamportå‘è¡¨Paxosä¸€è‡´æ€§ç®—æ³•ä»Ž90å¹´æå‡ºåˆ°çŽ°åœ¨å·²ç»æœ‰äºŒåå‡ å¹´äº†ï¼Œç›´åˆ°2006å¹´Googleçš„ä¸‰ç¯‡è®ºæ–‡åˆçŽ°â€œäº‘â€çš„ç«¯å€ªï¼Œå…¶ä¸­çš„Chubby LockæœåŠ¡ä½¿ç”¨Paxosä½œä¸ºChubby Cellä¸­çš„ä¸€è‡´æ€§ç®—æ³•ï¼ŒPaxosçš„äººæ°”ä»Žæ­¤ä¸€è·¯ç‹‚é£™ã€‚è€ŒPaxosæµç¨‹å¤ªè¿‡äºŽç¹æ‚å®žçŽ°èµ·æ¥ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œè™½ç„¶çŽ°åœ¨å¾ˆå¹¿æ³›ä½¿ç”¨çš„Zookeeperä¹Ÿæ˜¯åŸºäºŽPaxosç®—æ³•æ¥å®žçŽ°ï¼Œä½†æ˜¯Zookeeperä½¿ç”¨çš„ZABï¼ˆZookeeper Atomic Broadcastï¼‰åè®®å¯¹Paxosè¿›è¡Œäº†å¾ˆå¤šçš„æ”¹è¿›ä¸Žä¼˜åŒ–ï¼Œå¤æ‚æ€§æ˜¯åˆ¶çº¦ä»–å‘å±•çš„ä¸€ä¸ªé‡è¦åŽŸå› ã€‚Raftçš„è®¾è®¡åˆè¡·å°±æ˜¯æ˜“äºŽç†è§£æ€§ã€‚ Raftæ˜¯æ–¯å¦ç¦çš„Diego Ongaroã€John Ousterhoutä¸¤ä¸ªäººä»¥æ˜“æ‡‚ï¼ˆUnderstandabilityï¼‰ä¸ºç›®æ ‡è®¾è®¡çš„ä¸€è‡´æ€§ç®—æ³•ï¼Œåœ¨2013å¹´å‘å¸ƒäº†è®ºæ–‡ï¼šã€ŠIn Search of an Understandable Consensus Algorithmã€‹ ä»Ž2013å¹´å‘å¸ƒåˆ°çŽ°åœ¨ä¸è¿‡åªæœ‰ä¸¤å¹´ï¼Œåˆ°çŽ°åœ¨å·²ç»æœ‰äº†åå¤šç§è¯­è¨€çš„Raftç®—æ³•å®žçŽ°æ¡†æž¶ï¼Œè¾ƒä¸ºå‡ºåçš„æœ‰etcdã€‚ 2. Raftè¯¦è§£å¼ºè°ƒçš„æ˜¯æ˜“æ‡‚ï¼ˆUnderstandabilityï¼‰ï¼ŒRaftå’ŒPaxosä¸€æ ·åªè¦ä¿è¯n/2+1èŠ‚ç‚¹æ­£å¸¸å°±èƒ½å¤Ÿæä¾›æœåŠ¡ï¼›ä¼—æ‰€å‘¨çŸ¥ä½†é—®é¢˜è¾ƒä¸ºå¤æ‚æ—¶å¯ä»¥æŠŠé—®é¢˜åˆ†è§£ä¸ºå‡ ä¸ªå°é—®é¢˜æ¥å¤„ç†ï¼ŒRaftä¹Ÿä½¿ç”¨äº†åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³æŠŠç®—æ³•æµç¨‹åˆ†ä¸ºä¸‰ä¸ªå­é—®é¢˜ï¼šé€‰ä¸¾ï¼ˆLeader electionï¼‰ã€æ—¥å¿—å¤åˆ¶ï¼ˆLog replicationï¼‰ã€å®‰å…¨æ€§ï¼ˆSafetyï¼‰ä¸‰ä¸ªå­é—®é¢˜ã€‚ 2.1 raftåŸºæœ¬æ¦‚å¿µ states ä¸€ä¸ªrafté›†ç¾¤æ‹¥æœ‰å¤šä¸ªserverï¼Œé€šå¸¸ä¼šæœ‰5å°ï¼Œè¿™æ ·å¯ä»¥å…è®¸ç³»ç»Ÿä¸­ä¸¤å°serverå®•æœºã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„serveråªæœ‰å¦‚ä¸‹ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š Leaderï¼Œè´Ÿè´£Clientäº¤äº’å’Œlogå¤åˆ¶ï¼ŒåŒä¸€æ—¶åˆ»ç³»ç»Ÿä¸­æœ€å¤šå­˜åœ¨1ä¸ª Followerï¼Œè¢«åŠ¨å“åº”è¯·æ±‚RPCï¼Œä»Žä¸ä¸»åŠ¨å‘èµ·è¯·æ±‚RPC Candidateï¼Œç”±Followerå‘Leaderè½¬æ¢çš„ä¸­é—´çŠ¶æ€ åœ¨æ­£å¸¸çš„æ“ä½œæµç¨‹ä¸­ï¼Œé›†ç¾¤ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ªserverï¼Œå…¶ä»–æ‰€æœ‰çš„serveréƒ½æ˜¯followerã€‚followeræ˜¯è¢«åŠ¨çš„ï¼Œä»–ä»¬åªæ˜¯è¢«åŠ¨åœ°ç›¸åº”Candidateå’Œleaderçš„è¯·æ±‚ã€‚ã€‚leaderå¤„ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œfollowerè‡ªå·±ä¸å¤„ç†è€Œæ˜¯è½¬å‘ç»™leaderã€‚ç¬¬ä¸‰ç§çŠ¶æ€æ˜¯Candidateï¼Œç”¨æ¥é€‰ä¸¾ä¸€ä¸ªæ–°çš„leaderã€‚ Terms Raftå°†æ—¶é—´åˆ’åˆ†æˆä»»æ„çš„é•¿åº¦å‘¨æœŸã€‚Termså¯ä»¥ç†è§£ä¸ºé€»è¾‘å‘¨æœŸï¼Œç”¨è¿žç»­çš„æ•´æ•°è¡¨ç¤ºã€‚åœ¨åˆ†å¸ƒå¼çŽ¯å¢ƒä¸­ï¼Œæ—¶é—´åŒæ­¥å¾ˆé‡è¦ï¼ŒåŒæ—¶æ˜¯ä¸€ä¸ªéš¾é¢˜ã€‚åœ¨Raftä¸­ä½¿ç”¨äº†ä¸€ä¸ªå¯ä»¥ç†è§£ä¸ºå‘¨æœŸï¼ˆä»»æœŸï¼‰çš„æ¦‚å¿µï¼Œç”¨Termä½œä¸ºä¸€ä¸ªå‘¨æœŸï¼Œæ¯ä¸ªTerméƒ½æ˜¯ä¸€ä¸ªè¿žç»­é€’å¢žçš„ç¼–å·ï¼Œæ¯ä¸€è½®é€‰ä¸¾éƒ½æ˜¯ä¸€ä¸ªTermå‘¨æœŸï¼Œåœ¨ä¸€ä¸ªTermä¸­åªèƒ½äº§ç”Ÿä¸€ä¸ªLeaderã€‚ æ¯ä¸ªtermä¼´éšç€ä¸€æ¬¡electionï¼Œä¸€ä¸ªæˆ–å¤šä¸ªCandidateè¯•å›¾æˆä¸ºleaderï¼Œå¦‚ä¸Šå›¾çš„çŠ¶æ€è½¬æ¢ã€‚å¦‚æžœæŸä¸ªCandidateèµ¢å¾—äº†è¿™æ¬¡electionï¼Œå®ƒå°†å‡çº§ä¸ºå‰©ä½™serverçš„leaderã€‚åœ¨æŸäº›electionçš„æƒ…å½¢ä¸­ï¼Œä¼šäº§ç”Ÿè€—ç¥¨ï¼ˆSplit Votesï¼‰çš„ç»“æžœ ï¼Œå³æŠ•ç¥¨ç»“æžœæ— æ•ˆï¼ŒéšåŽä¸€æ¬¡æ–°çš„termå¼€å§‹ã€‚raftç¡®ä¿åœ¨æŸä¸ªtermè‡³å¤šæœ‰ä¸€ä¸ªleaderã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ—¶é—´è¢«åˆ’åˆ†æˆå¤šä¸ªtermsï¼Œæ¯ä¸ªterméšç€ä¸€æ¬¡electionã€‚electionå®ŒæˆåŽï¼Œä¸€ä¸ªleaderèŠ‚ç‚¹ç®¡ç†æ•´ä¸ªé›†ç¾¤ï¼Œç›´è‡³è¿™ä¸ªtermç»“æŸã€‚æœ‰äº›electionå¤±è´¥äº†ï¼Œæœªèƒ½äº§ç”Ÿä¸€ä¸ªleaderã€‚ 2.2 Leader electionæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ä»¥followerå¯åŠ¨ã€‚ä¸€ä¸ªæœ€å°çš„ Raft é›†ç¾¤éœ€è¦ä¸‰ä¸ªå‚ä¸Žè€…ï¼Œè¿™æ ·æ‰å¯èƒ½æŠ•å‡ºå¤šæ•°ç¥¨ã€‚åˆå§‹çŠ¶æ€ éƒ½æ˜¯ Followerï¼Œç„¶åŽå‘èµ·é€‰ä¸¾è¿™æ—¶æœ‰ä¸‰ç§å¯èƒ½æƒ…å½¢å‘ç”Ÿã€‚å¦‚æžœæ¯æ–¹éƒ½æŠ•ç»™äº†è‡ªå·±ï¼Œç»“æžœæ²¡æœ‰ä»»ä½•ä¸€æ–¹èŽ·å¾—å¤šæ•°ç¥¨ã€‚ä¹‹åŽæ¯ä¸ªå‚ä¸Žæ–¹éšæœºä¼‘æ¯ä¸€é˜µï¼ˆElection Timeoutï¼‰é‡æ–°å‘èµ·æŠ•ç¥¨ç›´åˆ°ä¸€æ–¹èŽ·å¾—å¤šæ•°ç¥¨ã€‚è¿™é‡Œçš„å…³é”®å°±æ˜¯éšæœº timeoutï¼Œæœ€å…ˆä»Žtimeoutä¸­æ¢å¤å‘èµ·æŠ•ç¥¨çš„ä¸€æ–¹å‘è¿˜åœ¨ timeout ä¸­çš„å¦å¤–ä¸¤æ–¹è¯·æ±‚æŠ•ç¥¨ï¼Œè¿™æ—¶å®ƒä»¬å°±åªèƒ½æŠ•ç»™å¯¹æ–¹äº†ï¼Œå¾ˆå¿«è¾¾æˆä¸€è‡´ã€‚Raftçš„é€‰ä¸¾ç”±å®šæ—¶å™¨æ¥è§¦å‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„é€‰ä¸¾å®šæ—¶å™¨æ—¶é—´éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¼€å§‹æ—¶çŠ¶æ€éƒ½ä¸ºFolloweræŸä¸ªèŠ‚ç‚¹å®šæ—¶å™¨è§¦å‘é€‰ä¸¾åŽTermé€’å¢žï¼ŒçŠ¶æ€ç”±Followerè½¬ä¸ºCandidateï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘èµ·RequestVote RPCè¯·æ±‚ï¼Œè¿™æ—¶å€™æœ‰ä¸‰ç§å¯èƒ½çš„æƒ…å†µå‘ç”Ÿï¼š 1.è¯¥RequestVoteè¯·æ±‚æŽ¥æ”¶åˆ°n/2+1ï¼ˆè¿‡åŠæ•°ï¼‰ä¸ªèŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œä»ŽCandidateè½¬ä¸ºLeaderï¼Œå‘å…¶ä»–èŠ‚ç‚¹å‘é€heartBeatä»¥ä¿æŒLeaderçš„æ­£å¸¸è¿è½¬ã€‚ 2.åœ¨æ­¤æœŸé—´å¦‚æžœæ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘é€è¿‡æ¥çš„AppendEntries RPCè¯·æ±‚ï¼Œå¦‚è¯¥èŠ‚ç‚¹çš„Termå¤§åˆ™å½“å‰èŠ‚ç‚¹è½¬ä¸ºFollowerï¼Œå¦åˆ™ä¿æŒCandidateæ‹’ç»è¯¥è¯·æ±‚ã€‚ 3.Election timeoutå‘ç”Ÿåˆ™Termé€’å¢žï¼Œé‡æ–°å‘èµ·é€‰ä¸¾ã€‚ åœ¨ä¸€ä¸ªTermæœŸé—´æ¯ä¸ªèŠ‚ç‚¹åªèƒ½æŠ•ç¥¨ä¸€æ¬¡ï¼Œæ‰€ä»¥å½“æœ‰å¤šä¸ªCandidateå­˜åœ¨æ—¶å°±ä¼šå‡ºçŽ°æ¯ä¸ªCandidateå‘èµ·çš„é€‰ä¸¾éƒ½å­˜åœ¨æŽ¥æ”¶åˆ°çš„æŠ•ç¥¨æ•°éƒ½ä¸è¿‡åŠçš„é—®é¢˜ï¼Œè¿™æ—¶æ¯ä¸ªCandidateéƒ½å°†Termé€’å¢žã€é‡å¯å®šæ—¶å™¨å¹¶é‡æ–°å‘èµ·é€‰ä¸¾ï¼Œç”±äºŽæ¯ä¸ªèŠ‚ç‚¹ä¸­å®šæ—¶å™¨çš„æ—¶é—´éƒ½æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å°±ä¸ä¼šå¤šæ¬¡å­˜åœ¨æœ‰å¤šä¸ªCandidateåŒæ—¶å‘èµ·æŠ•ç¥¨çš„é—®é¢˜ã€‚ å¼•ç”¨ä¸€å¼ ç½‘ä¸Šçš„å›¾ç‰‡ï¼Œæ¯”è¾ƒå½¢è±¡ï¼Œå¦‚ä¸‹å›¾ã€‚ 2.3 Log replicationæ—¥å¿—å¤åˆ¶ä¸»è¦æ˜¯ç”¨äºŽä¿è¯èŠ‚ç‚¹çš„ä¸€è‡´æ€§ï¼Œè¿™é˜¶æ®µæ‰€åšçš„æ“ä½œä¹Ÿæ˜¯ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ä¸Žé«˜å¯ç”¨æ€§ï¼›å½“Leaderé€‰ä¸¾å‡ºæ¥åŽä¾¿å¼€å§‹è´Ÿè´£å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ‰€æœ‰äº‹åŠ¡ï¼ˆæ›´æ–°æ“ä½œï¼‰è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡Leaderå¤„ç†ï¼Œè¿™äº›äº‹åŠ¡è¯·æ±‚æˆ–è¯´æˆå‘½ä»¤ä¹Ÿå°±æ˜¯è¿™é‡Œè¯´çš„æ—¥å¿—ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“è¦ä¿è¯èŠ‚ç‚¹çš„ä¸€è‡´æ€§å°±è¦ä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æŒ‰é¡ºåºæ‰§è¡Œç›¸åŒçš„æ“ä½œåºåˆ—ï¼Œæ—¥å¿—å¤åˆ¶ï¼ˆLog Replicationï¼‰å°±æ˜¯ä¸ºäº†ä¿è¯æ‰§è¡Œç›¸åŒçš„æ“ä½œåºåˆ—æ‰€åšçš„å·¥ä½œï¼›åœ¨Raftä¸­å½“æŽ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ—¥å¿—ï¼ˆäº‹åŠ¡è¯·æ±‚ï¼‰åŽå…ˆæŠŠè¯¥æ—¥å¿—è¿½åŠ åˆ°æœ¬åœ°çš„Logä¸­ï¼Œç„¶åŽé€šè¿‡heartbeatæŠŠè¯¥EntryåŒæ­¥ç»™å…¶ä»–Followerï¼ŒFolloweræŽ¥æ”¶åˆ°æ—¥å¿—åŽè®°å½•æ—¥å¿—ç„¶åŽå‘Leaderå‘é€ACKï¼Œå½“Leaderæ”¶åˆ°å¤§å¤šæ•°ï¼ˆn/2+1ï¼‰Followerçš„ACKä¿¡æ¯åŽå°†è¯¥æ—¥å¿—è®¾ç½®ä¸ºå·²æäº¤å¹¶è¿½åŠ åˆ°æœ¬åœ°ç£ç›˜ä¸­ï¼Œé€šçŸ¥å®¢æˆ·ç«¯å¹¶åœ¨ä¸‹ä¸ªheartbeatä¸­Leaderå°†é€šçŸ¥æ‰€æœ‰çš„Followerå°†è¯¥æ—¥å¿—å­˜å‚¨åœ¨è‡ªå·±çš„æœ¬åœ°ç£ç›˜ä¸­ã€‚ ä¸Šå›¾ä¸­ï¼Œå½“leaderé€‰å‡ºæ¥ä¹‹åŽï¼Œfollowerçš„logsåœºæ™¯å¾ˆå¯èƒ½å‡ºçŽ°åœ¨ä¸Šå›¾ä¸­ã€‚followeræœ‰å¯èƒ½ä¸¢å¤±entriesã€æœ‰æœªæäº¤çš„entriesã€æœ‰é¢å¤–çš„entriesç­‰ç­‰åœºæ™¯ã€‚Raftä¸­ï¼Œleaderé€šè¿‡å¼ºåˆ¶followerså¤åˆ¶è‡ªå·±çš„logsæ¥å¤„ç†ä¸ä¸€è‡´ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨followerä¸­logså†²çªçš„entrieså°†ä¼šè¢«leader logsä¸­çš„è¦†å†™ã€‚ 2.4 Safetyå®‰å…¨æ€§æ˜¯ç”¨äºŽä¿è¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æ‰§è¡Œç›¸åŒåºåˆ—çš„å®‰å…¨æœºåˆ¶ï¼Œå¦‚å½“æŸä¸ªFolloweråœ¨å½“å‰Leader commit Logæ—¶å˜å¾—ä¸å¯ç”¨äº†ï¼Œç¨åŽå¯èƒ½è¯¥Followeråˆä¼šå€é€‰ä¸¾ä¸ºLeaderï¼Œè¿™æ—¶æ–°Leaderå¯èƒ½ä¼šç”¨æ–°çš„Logè¦†ç›–å…ˆå‰å·²committedçš„Logï¼Œè¿™å°±æ˜¯å¯¼è‡´èŠ‚ç‚¹æ‰§è¡Œä¸åŒåºåˆ—ï¼›Safetyå°±æ˜¯ç”¨äºŽä¿è¯é€‰ä¸¾å‡ºæ¥çš„Leaderä¸€å®šåŒ…å«å…ˆå‰ commited Logçš„æœºåˆ¶ï¼› Election Safetyæ¯ä¸ªTermåªèƒ½é€‰ä¸¾å‡ºä¸€ä¸ªLeaderï¼Œå‡è®¾æŸä¸ªTermåŒæ—¶é€‰ä¸¾äº§ç”Ÿä¸¤ä¸ªLeaderAå’ŒLeaderBï¼Œæ ¹æ®é€‰ä¸¾è¿‡ç¨‹å®šä¹‰ï¼ŒAå’ŒBå¿…é¡»åŒæ—¶èŽ·å¾—è¶…è¿‡åŠæ•°èŠ‚ç‚¹çš„æŠ•ç¥¨ï¼Œè‡³å°‘å­˜åœ¨èŠ‚ç‚¹NåŒæ—¶ç»™äºˆAå’ŒBæŠ•ç¥¨ï¼Œå› æ­¤çŸ›ç›¾ã€‚ Leader Completenessè¿™é‡Œæ‰€è¯´çš„å®Œæ•´æ€§æ˜¯æŒ‡Leaderæ—¥å¿—çš„å®Œæ•´æ€§ï¼Œå½“Logåœ¨Term1è¢«CommitåŽï¼Œé‚£ä¹ˆä»¥åŽTerm2ã€Term3â€¦ç­‰çš„Leaderå¿…é¡»åŒ…å«è¯¥Logï¼›Raftåœ¨é€‰ä¸¾é˜¶æ®µå°±ä½¿ç”¨Termçš„åˆ¤æ–­ç”¨äºŽä¿è¯å®Œæ•´æ€§ï¼šå½“è¯·æ±‚æŠ•ç¥¨çš„è¯¥Candidateçš„Termè¾ƒå¤§æˆ–Termç›¸åŒIndexæ›´å¤§åˆ™æŠ•ç¥¨ï¼Œå¦åˆ™æ‹’ç»è¯¥è¯·æ±‚ï¼› Leader Append-OnlyLeaderä»Žä¸â€œé‡å†™â€æˆ–è€…â€œåˆ é™¤â€æœ¬åœ°Logï¼Œä»…ä»…â€œè¿½åŠ â€æœ¬åœ°Logã€‚Raftç®—æ³•ä¸­Leaderæƒå¨è‡³é«˜æ— ä¸Šï¼Œå½“Followerå’ŒLeaderäº§ç”Ÿåˆ†æ­§çš„æ—¶å€™ï¼Œæ°¸è¿œæ˜¯LeaderåŽ»è¦†ç›–ä¿®æ­£Followerã€‚ Log Matchingå¦‚æžœä¸¤ä¸ªèŠ‚ç‚¹ä¸Šçš„æ—¥å¿—é¡¹æ‹¥æœ‰ç›¸åŒçš„Indexå’ŒTermï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªèŠ‚ç‚¹[0, Index]èŒƒå›´å†…çš„Logå®Œå…¨ä¸€è‡´ã€‚ State Machine Safetyä¸€æ—¦æŸä¸ªserverå°†æŸä¸ªæ—¥å¿—é¡¹åº”ç”¨äºŽæœ¬åœ°çŠ¶æ€æœºï¼Œä»¥åŽæ‰€æœ‰serverå¯¹äºŽè¯¥åç§»éƒ½å°†åº”ç”¨ç›¸åŒæ—¥å¿—é¡¹ã€‚ 3. æ€»ç»“æœ¬æ–‡ä¸»è¦è®²è§£äº†Raftç®—æ³•çš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠç®—æ³•ä¸­æ¶‰åŠåˆ°çš„leaderé€‰ä¸¾ï¼Œæ—¥å¿—åŒæ­¥ï¼Œå®‰å…¨æ€§ã€‚Raftæ˜¯ä»¥æ˜“ç†è§£æ€§ä½œä¸ºå…¶è®¾è®¡çš„ä¸€ä¸ªç›®æ ‡ï¼Œå¯¹äºŽä¸€ä¸ªå­¦ä¹ çš„æ–°æ‰‹æ¥è¯´ï¼Œç¡®å®žæ¯”Paxosæ˜“äºŽç†è§£å¾ˆå¤šã€‚è™½ç„¶ Raft çš„è®ºæ–‡æ¯” Paxos ç®€å•ç‰ˆè®ºæ–‡å®¹æ˜“è¯»ï¼Œè®ºæ–‡ä¾ç„¶æœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦æ·±åˆ»ä½“ä¼šä¸Žç†è§£ï¼Œç¬”è€…ä¹Ÿè¿˜æ˜¯æžäº†å¥½å‡ å¤©ã€‚ å‚è€ƒ Raft Animate Demo Raft Paper Raft Website Raft ä¸ºä»€ä¹ˆæ˜¯æ›´æ˜“ç†è§£çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³• Raftä¸€è‡´æ€§ç®—æ³•]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>consul</tag>
        <tag>Cluster</tag>
        <tag>Consensus</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[consulé…ç½®ä¸Žå®žæˆ˜]]></title>
    <url>%2F2017%2F09%2F16%2Fconsul%2F</url>
    <content type="text"><![CDATA[ä¸Šä¸€ç¯‡æåˆ°ï¼Œé¡¹ç›®ç”¨çš„åˆ†å¸ƒå¼æœåŠ¡å‘çŽ°ä¸Žæ³¨å†Œç»„ä»¶æ˜¯consulï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ¥è®²ä¸‹consulç»„ä»¶åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨ä»¥åŠç›¸å…³ä»‹ç»ã€‚æœ¬æ–‡ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºä¸»è¦å‚è€ƒconsulæ–‡æ¡£ã€‚ 1. consulä»‹ç»consulæ˜¯ä¸€ä¸ªæœåŠ¡ç®¡ç†è½¯ä»¶ï¼Œä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒä¸‹ï¼Œåˆ†å¸ƒå¼é«˜å¯ç”¨çš„ï¼ŒæœåŠ¡å‘çŽ°å’Œé…ç½®å…±äº«ã€‚ consulæ”¯æŒå¥åº·æ£€æŸ¥ï¼Œå…è®¸å­˜å‚¨é”®å€¼å¯¹ã€‚ ä¸€è‡´æ€§åè®®é‡‡ç”¨Raftç®—æ³•,ç”¨æ¥ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ã€‚ æˆå‘˜ç®¡ç†å’Œæ¶ˆæ¯å¹¿æ’­é‡‡ç”¨GOSSIPåè®®ï¼Œæ”¯æŒACLè®¿é—®æŽ§åˆ¶ã€‚ 1.1 æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°æœåŠ¡æ³¨å†Œæ˜¯ä¸€ä¸ªæœåŠ¡å°†å…¶ä½ç½®ä¿¡æ¯åœ¨â€œä¸­å¿ƒæ³¨å†ŒèŠ‚ç‚¹â€æ³¨å†Œçš„è¿‡ç¨‹ã€‚è¯¥æœåŠ¡ä¸€èˆ¬ä¼šå°†å®ƒçš„ä¸»æœºIPåœ°å€ä»¥åŠç«¯å£å·è¿›è¡Œæ³¨å†Œï¼Œæœ‰æ—¶ä¹Ÿä¼šæœ‰æœåŠ¡è®¿é—®çš„è®¤è¯ä¿¡æ¯ï¼Œä½¿ç”¨åè®®ï¼Œç‰ˆæœ¬å·ï¼Œä»¥åŠå…³äºŽçŽ¯å¢ƒçš„ä¸€äº›ç»†èŠ‚ä¿¡æ¯ã€‚è€ŒæœåŠ¡å‘çŽ°å¯ä»¥è®©ä¸€ä¸ªåº”ç”¨æˆ–è€…ç»„ä»¶å‘çŽ°å…¶è¿è¡ŒçŽ¯å¢ƒä»¥åŠå…¶å®ƒåº”ç”¨æˆ–ç»„ä»¶çš„ä¿¡æ¯ã€‚ç”¨æˆ·é…ç½®ä¸€ä¸ªæœåŠ¡å‘çŽ°å·¥å…·å°±å¯ä»¥å°†å®žé™…å®¹å™¨è·Ÿè¿è¡Œé…ç½®åˆ†ç¦»å¼€ã€‚å¸¸è§é…ç½®ä¿¡æ¯åŒ…æ‹¬ï¼šipã€ç«¯å£å·ã€åç§°ç­‰ã€‚ åœ¨ä¼ ç»Ÿæƒ…å†µä¸‹ï¼Œå½“å‡ºçŽ°æœåŠ¡å­˜åœ¨äºŽå¤šä¸ªä¸»æœºèŠ‚ç‚¹ä¸Šæ—¶ï¼Œéƒ½ä¼šä½¿ç”¨é™æ€é…ç½®çš„æ–¹æ³•æ¥å®žçŽ°æœåŠ¡ä¿¡æ¯çš„æ³¨å†Œã€‚è€Œå½“åœ¨ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿé‡Œï¼Œéœ€è¦è¾ƒå¼ºçš„å¯æ‰©å±•æ€§æ—¶ï¼ŒæœåŠ¡è¢«é¢‘ç¹æ›¿æ¢æ—¶ï¼Œä¸ºé¿å…æœåŠ¡ä¸­æ–­ï¼ŒåŠ¨æ€çš„æœåŠ¡æ³¨å†Œå’Œå‘çŽ°å°±å¾ˆé‡è¦ã€‚æœåŠ¡æ³¨å†Œä¸Žå‘çŽ°çš„ç»„ä»¶æœ‰å¾ˆå¤šï¼Œå¦‚Zookeeperã€Etcdç­‰ã€‚æ—¢å¯ç”¨äºŽæœåŠ¡é—´çš„åè°ƒï¼ŒåŒæ—¶åˆå¯ç”¨äºŽæœåŠ¡çš„æ³¨å†Œã€‚ 1.2 Consensus Protocol - Raft Consulä½¿ç”¨Consensusåè®®Raftæä¾›ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€‚æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»åœ¨consulä¸­çš„ä¸€è‡´æ€§ï¼ŒåŽé¢ä¸“é—¨ä¸€ç¯‡å†™raftã€‚ é¦–å…ˆï¼ŒRaftæ˜¯ä¸€ç§åŸºäºŽPaxosçš„Consensusç®—æ³•ã€‚ç›¸æ¯”äºŽPaxosï¼ŒRaftè®¾è®¡é‡‡ç”¨äº†è¾ƒå°‘çš„çŠ¶æ€ï¼Œå¹¶ä¸”æ˜¯ä¸€ç§æ›´ç®€å•ã€æ›´æ˜“äºŽç†è§£çš„ç®—æ³•ã€‚åªæœ‰ServerèŠ‚ç‚¹å‚ä¸ŽRaftï¼Œä¸”æ˜¯peer setçš„ä¸€å‘˜ã€‚æ‰€æœ‰çš„ClientèŠ‚ç‚¹åªæ˜¯è½¬å‘è¯·æ±‚åˆ°Serverã€‚è¿™ç§è®¾è®¡çš„è€ƒè™‘æ˜¯ï¼Œå½“æ›´å¤šçš„æˆå‘˜åŠ å…¥åˆ°peer setä¸­æ—¶ï¼Œquorumçš„è§„æ¨¡ä¹Ÿä¼šå¢žåŠ ã€‚å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜æ˜¯ç­‰å¾…quorumä¸ªèŠ‚ç‚¹log entryã€‚ å¯åŠ¨Consulæ—¶ï¼Œå•ä¸ªconsulèŠ‚ç‚¹éœ€è¦ä»¥bootstrapæ¨¡å¼è¿è¡Œï¼Œè¯¥æ¨¡å¼è¿è¡Œè‡ªæˆ‘é€‰ä¸¾ä¸ºleaderã€‚ä¸€æ—¦Leaderè¢«é€‰å‡ºæ¥ï¼Œå…¶ä»–Serverå¯ä»¥æ·»åŠ Peer setä¸­ï¼Œä¿æŒä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚æœ€ç»ˆä¸€äº›Serveræ·»åŠ åˆ°é›†ç¾¤ï¼Œbootstrapæ¨¡å¼éœ€è¦ç¦ç”¨ã€‚ å› ä¸ºæ‰€æœ‰Serveréƒ½æ˜¯Peer setä¸­çš„æˆå‘˜ï¼Œå®ƒä»¬éƒ½çŸ¥é“è°æ˜¯Leaderã€‚å½“ä¸€ä¸ªRPCè¯·æ±‚åˆ°è¾¾æŸä¸ªéžLeader ServerèŠ‚ç‚¹ï¼Œè¯·æ±‚å°±ä¼šè¢«è½¬å‘åˆ°Leaderã€‚å¦‚æžœRPCæ˜¯ä¸€ç§queryç±»åž‹ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯åªè¯»çš„ï¼ŒLeaderä¼šåŸºäºŽFSMå½“å‰ç”Ÿæˆç›¸åº”çš„ç»“æžœï¼Œå¦‚æžœRPCæ˜¯ä¸€ç§transactionç±»åž‹ï¼Œå³ä¿®æ”¹çŠ¶æ€ï¼ŒLeaderäº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥å¿—æ¡ç›®ï¼Œå¹¶åŸºäºŽRaftç®—æ³•è¿›è¡Œç®¡ç†ã€‚ä¸€æ—¦æ—¥å¿—æ¡ç›®åº”ç”¨äºŽæœ‰é™çŠ¶æ€æœºï¼Œtransactionå®Œæˆã€‚ ç”±äºŽRaftçš„replicationæ€§è´¨ï¼Œæ€§èƒ½å¯¹ç½‘ç»œå»¶è¿Ÿæ˜¯éžå¸¸æ•æ„Ÿçš„ã€‚ä¸ºæ­¤ï¼Œæ¯ä¸ªæ•°æ®ä¸­å¿ƒé€‰æ‹©ç‹¬ç«‹çš„Leaderå’Œç»´æŠ¤ä¸€ä¸ªä¸å…³è”çš„peer setã€‚æ•°æ®æŒ‰ç…§æ•°æ®ä¸­å¿ƒè¿›è¡Œåˆ’åˆ†ï¼Œæ‰€ä»¥æ¯ä¸ªLeaderåªè´Ÿè´£åœ¨ç›¸åº”æ•°æ®ä¸­å¿ƒçš„æ•°æ®ã€‚å½“æŽ¥æ”¶åˆ°ä¸€ä¸ªè¿œç¨‹æ•°æ®ä¸­å¿ƒçš„è¯·æ±‚æ—¶ï¼Œè¯·æ±‚ä¼šè¢«è½¬å‘åˆ°ç›¸åº”çš„Leaderã€‚è¿™ç§è®¾è®¡åœ¨ä¸ç‰ºç‰²ä¸€è‡´æ€§çš„æƒ…å†µå®žçŽ°è¾ƒä½Žå»¶è¿Ÿäº¤æ˜“å’Œæ›´é«˜çš„å¯ç”¨æ€§ã€‚è™½ç„¶æ‰€æœ‰æ—¥å¿—å‰¯æœ¬çš„å†™å…¥éƒ½æ˜¯åŸºäºŽRaftï¼Œè¯»å–æ›´çµæ´»ã€‚ä½†ä¸ºäº†æ”¯æŒå¼€å‘äººå‘˜å¯èƒ½éœ€è¦çš„å„ç§æƒè¡¡ï¼ŒConsulæ”¯æŒ3ç§ä¸åŒçš„ä¸€è‡´æ€§æ¨¡å¼ã€‚ Defaultï¼ŒRafté‡‡ç”¨Leaderç§Ÿèµæ¨¡å¼ï¼Œæä¾›äº†ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œåœ¨è¯¥æ—¶é—´æ®µå†…ï¼ŒLeaderè§’è‰²æ˜¯ç¨³å®šçš„ã€‚ consistentï¼Œæ— æ¡ä»¶ä¸€è‡´æ€§ staleï¼Œè¿™ç§æ¨¡å¼å…è®¸åœ¨ä»»ä½•ServerèŠ‚ç‚¹æ‰§è¡Œè¯»å–æ“ä½œï¼Œæ— è®ºå®ƒæ˜¯ä¸æ˜¯Leaderã€‚ 1.3 Group Membership Protocol - GossipConsulä½¿ç”¨gossipåè®®ç®¡ç†æˆå‘˜å…³ç³»ã€å¹¿æ’­æ¶ˆæ¯åˆ°æ•´ä¸ªé›†ç¾¤ã€‚è¯¦æƒ…å¯å‚è€ƒSerf libraryã€‚ Consulåˆ©ç”¨ä¸¤ä¸ªä¸åŒçš„gossip poolã€‚å±€åŸŸç½‘(LAN Pool)å’Œå¹¿åŸŸç½‘(WAN Pool)ã€‚ æ¯ä¸ªConsulæ•°æ®ä¸­å¿ƒéƒ½æœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰æˆå‘˜ï¼ˆServerå’ŒClientï¼‰çš„LAN gossip poolã€‚LAN Poolæœ‰å¦‚ä¸‹å‡ ä¸ªç›®çš„ï¼š é¦–å…ˆï¼Œæˆå‘˜å…³ç³»å…è®¸Clientè‡ªåŠ¨å‘çŽ°ServerèŠ‚ç‚¹ï¼Œå‡å°‘æ‰€éœ€çš„é…ç½®é‡ã€‚ å…¶æ¬¡ï¼Œåˆ†å¸ƒå¼æ•…éšœæ£€æµ‹å…è®¸çš„æ•…éšœæ£€æµ‹çš„å·¥ä½œåœ¨æŸå‡ ä¸ªServerå‡ ç‚¹æ‰§è¡Œï¼Œè€Œä¸æ˜¯é›†ä¸­æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ä¸Šã€‚ æœ€åŽï¼Œgossipå…è®¸å¯é å’Œå¿«é€Ÿçš„äº‹ä»¶å¹¿æ’­ï¼Œå¦‚Leaderé€‰ä¸¾ã€‚ WAN Poolæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œæ— è®ºå±žäºŽå“ªä¸€ä¸ªæ•°æ®ä¸­å¿ƒï¼Œæ‰€æœ‰Serveråº”è¯¥åŠ å…¥åˆ°WAN Poolã€‚ç”±WAN Poolæä¾›ä¼šå‘˜ä¿¡æ¯è®©Serverå¯èŠ‚ç”µæ‰§è¡Œè·¨æ•°æ®ä¸­å¿ƒçš„è¯·æ±‚ã€‚é›†æˆä¸­æ•…éšœæ£€æµ‹å…è®¸Consulå¦¥å–„å¤„ç†æ•´ä¸ªæ•°æ®ä¸­å¿ƒå¤±åŽ»è¿žæŽ¥ï¼Œæˆ–åœ¨è¿œç¨‹æ•°æ®ä¸­å¿ƒåªæ˜¯å•ä¸ªçš„ServerèŠ‚ç‚¹ã€‚æ‰€æœ‰è¿™äº›åŠŸèƒ½éƒ½æ˜¯é€šè¿‡åˆ©ç”¨Serfæä¾›ã€‚ä»Žç”¨æˆ·è§’åº¦æ¥çœ‹ï¼Œå®ƒæ˜¯ä½œä¸ºä¸€ä¸ªåµŒå…¥å¼åº“æä¾›è¿™äº›åŠŸèƒ½ã€‚ä½†å…¶è¢«Consulå±è”½ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒã€‚ä½œä¸ºå¼€å‘äººå‘˜å¯ä»¥åŽ»äº†è§£è¿™ä¸ªåº“æ˜¯å¦‚ä½•åˆ©ç”¨ã€‚ 1.4 Sessionä¼šè¯ä¸Šä¸€ç¯‡æ–‡ç« snowflakeå‡çº§ç‰ˆå…¨å±€idç”Ÿæˆä¸­ä½¿ç”¨åˆ°äº†consulçš„KVå­˜å‚¨ã€‚Consulæä¾›sessionä¼šè¯æœºåˆ¶ï¼Œå¯ä»¥ç”¨äºŽæž„å»ºåˆ†å¸ƒå¼é”ã€‚sessionå¯ä»¥ç»‘å®šåˆ°èŠ‚ç‚¹ã€å¥åº·æ£€æŸ¥ã€KVæ•°æ®ï¼Œç›®çš„æ˜¯æä¾›ç»†ç²’åº¦é”ã€‚KVå­˜å‚¨å’Œä¼šè¯çš„é›†æˆæ˜¯ä½¿ç”¨ä¼šè¯çš„ä¸»è¦åœºæ™¯ã€‚å¿…é¡»åœ¨ä½¿ç”¨ä¹‹å‰åˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œç„¶åŽä½¿ç”¨å®ƒçš„IDã€‚KV APIæ”¯æŒacquireå’Œreleaseæ“ä½œï¼Œacquireæ“ä½œç±»ä¼¼CASæ“ä½œï¼Œåªæœ‰å½“é”ç©ºé—²æ—¶æ‰ä¼šè¿”å›žæˆåŠŸã€‚å½“æˆåŠŸæ—¶ï¼ŒæŸä¸ªnormalæ ‡è¯†ä¼šæ›´æ–°ï¼Œä¹Ÿä¼šé€’å¢žLockIndexï¼Œå½“ç„¶ä¹Ÿä¼šæ›´æ–°sessionçš„ä¿¡æ¯ã€‚å¦‚æžœåœ¨acquireæ“ä½œæ—¶ï¼Œä¸Žsessionç›¸å…³çš„é”å·²ç»æŒæœ‰ï¼Œé‚£ä¹ˆLockIndexå°±ä¸ä¼šé€’å¢žï¼Œä½†æ˜¯keyå€¼ä¼šæ›´æ–°ï¼Œè¿™å°±å…è®¸é”çš„å½“å‰æŒæœ‰è€…æ— éœ€é‡æ–°èŽ·å¾—é”å°±å¯ä»¥æ›´æ–°keyçš„å†…å®¹ã€‚ ä¸€æ—¦èŽ·å¾—é”ï¼Œæ‰€éœ€è¦ç»releaseæ“ä½œæ¥é‡Šæ”¾ï¼ˆä½¿ç”¨ç›¸åŒçš„sessionï¼‰ã€‚Releaseæ“ä½œä¹Ÿç±»ä¼¼äºŽCASæ“ä½œã€‚å¦‚æžœç»™å®šçš„sessionæ— æ•ˆï¼Œé‚£ä¹ˆè¯·æ±‚ä¼šå¤±è´¥ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæ— éœ€ç»è¿‡sessionçš„åˆ›å»ºè€…ï¼Œlockä¹Ÿæ˜¯å¯ä»¥è¢«é‡Šæ”¾çš„ã€‚è¿™ç§è®¾è®¡æ˜¯å…è®¸æ“ä½œè€…å¹²é¢„æ¥ç»ˆæ­¢ä¼šè¯ï¼Œåœ¨éœ€è¦çš„æ—¶å€™ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œä¼šè¯æ— æ•ˆä¹Ÿå°†å¯¼è‡´æ‰€æœ‰è¢«æŒæœ‰çš„é”è¢«é‡Šæ”¾æˆ–åˆ é™¤ã€‚å½“é”è¢«é‡Šæ”¾æ—¶ï¼ŒLockIndexä¸ä¼šå˜åŒ–ï¼Œä½†æ˜¯sessionä¼šè¢«æ¸…ç©ºï¼Œå¹¶ä¸”ModifyIndexé€’å¢žã€‚è¿™äº›è¯­ä¹‰å…è®¸å…ƒç»„ï¼ˆKeyï¼ŒLockIndexï¼ŒSessionï¼‰ä½œä¸ºä¸€ä¸ªç‹¬ç‰¹çš„â€œåºåˆ—â€ã€‚è¿™ä¸ªåºåˆ—å¯ä»¥è¢«ä¼ é€’å’Œç”¨äºŽéªŒè¯è¯·æ±‚æ˜¯å¦å±žäºŽå½“å‰çš„é”æŒæœ‰è€…ã€‚å› ä¸ºæ¯æ¬¡acquire éƒ½ä¼šå¯¼è‡´LockIndexé€’å¢žï¼Œå³ä½¿åŒä¸€ä¼šè¯ä¸­é‡æ–°èŽ·å–é”ï¼Œè¯¥åºåˆ—èƒ½å¤Ÿæ£€æµ‹åˆ°é™ˆæ—§çš„è¯·æ±‚ã€‚åŒæ ·ï¼Œå¦‚æžœä¼šè¯å¤±æ•ˆï¼Œç›¸åº”çš„LockIndexå°†ä¸ºç©ºã€‚è¦æ¸…æ¥šçš„æ˜¯ï¼Œè¿™ç§é”ç³»ç»Ÿæ˜¯çº¯ç²¹çš„å’¨è¯¢ã€‚å¹¶ä¸æ˜¯å¼ºåˆ¶Clientå¿…é¡»èŽ·å–é”å†èƒ½æ‰§è¡Œæ“ä½œä½œã€‚ä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥åœ¨æœªèŽ·å¾—é”çš„æƒ…å†µä¸‹è¯»å–ã€å†™å…¥å’Œåˆ é™¤Keyæ“ä½œã€‚å®ƒä¸æ˜¯Consulç”¨äºŽä¿æŠ¤ç³»ç»Ÿçš„æ–¹æ³•ã€‚ 2. consulæž¶æž„ä¸Šé¢ä»‹ç»äº†consulçš„æŠ€æœ¯å†…å¹•ã€‚çŽ°åœ¨æ¥è®²è®²consulçš„æž¶æž„ã€‚ æ‹†è§£å¼€è¿™ä¸ªä½“ç³»ï¼Œä»Žæ¯ä¸€ä¸ªç»„ä»¶å¼€å§‹äº†è§£ã€‚é¦–å…ˆï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒï¼Œåˆ†åˆ«æ ‡è®°ä¸ºâ€œoneâ€å’Œâ€œtwoâ€ã€‚Consulæ˜¯æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒä¸€æµï¼Œå¹¶ä¸”æ˜¯å¸¸ç”¨ä¸šåŠ¡åœºæ™¯ã€‚ æ¯ä¸ªæ•°æ®ä¸­å¿ƒéƒ½æ˜¯ç”±Serverå’Œclientç»„æˆã€‚å»ºè®®æœ‰3~5å°Serverï¼ŒåŸºäºŽæ•…éšœå¤„ç†å’Œæ€§èƒ½çš„å¹³è¡¡ä¹‹ç­–ã€‚å¦‚æžœå¢žåŠ è¶Šå¤šçš„æœºå™¨ï¼Œåˆ™Consensusä¼šè¶Šæ¥è¶Šæ…¢ã€‚å¯¹clientæ²¡æœ‰é™åˆ¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°æ‰©å±•åˆ°æˆåƒä¸Šä¸‡æˆ–æ•°ä¸‡ã€‚åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦åŠ å…¥Gossipåè®®ã€‚è¿™æ„å‘³ç€gossip poolåŒ…å«ç»™å®šæ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰èŠ‚ç‚¹ã€‚æœ‰ä»¥ä¸‹ç›®çš„ï¼šé¦–å…ˆï¼Œæ²¡æœ‰å¿…è¦ä¸ºclienté…ç½®æœåŠ¡å™¨åœ°å€å‚æ•°ï¼›å‘çŽ°æ˜¯è‡ªåŠ¨å®Œæˆçš„ã€‚ç¬¬äºŒï¼ŒèŠ‚ç‚¹æ•…éšœæ£€æµ‹çš„å·¥ä½œä¸æ˜¯æ”¾ç½®åœ¨æœåŠ¡å™¨ä¸Šï¼Œè€Œæ˜¯åˆ†å¸ƒå¼çš„ã€‚è¿™ä½¿æ•…éšœæ£€æµ‹æ¯”å¿ƒè·³æœºåˆ¶æ›´å¯æ‰©å±•æ€§ã€‚ç¬¬ä¸‰ï¼Œå¯ç”¨æ¥ä½œä¸ºæ¶ˆæ¯å±‚é€šçŸ¥é‡è¦çš„äº‹ä»¶ï¼Œå¦‚leaderé€‰ä¸¾ã€‚ æ¯ä¸ªæ•°æ®ä¸­å¿ƒçš„æœåŠ¡å™¨éƒ½æ˜¯å±žäºŽä¸€ä¸ªRaft peerã€‚è¿™æ„å‘³ç€ï¼Œä»–ä»¬ä¸€èµ·å·¥ä½œï¼Œé€‰å‡ºä¸€ä¸ªçš„Leaderï¼ŒLeader serveræ˜¯æœ‰é¢å¤–çš„èŒè´£ã€‚è´Ÿè´£å¤„ç†æ‰€æœ‰çš„æŸ¥è¯¢å’Œäº‹åŠ¡ã€‚äº‹åŠ¡ä¹Ÿå¿…é¡»é€šè¿‡Consensusåè®®å¤åˆ¶åˆ°æ‰€æœ‰çš„ä¼™ä¼´ã€‚ç”±äºŽè¿™ä¸€è¦æ±‚ï¼Œå½“éžLeader ServeræŽ¥æ”¶åˆ°ä¸€ä¸ªRPCè¯·æ±‚ï¼Œä¼šè½¬å‘åˆ°é›†ç¾¤çš„leaderã€‚ ServerèŠ‚ç‚¹ä¹Ÿæ˜¯ä½œä¸ºWAN gossip poolçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªpoolæ˜¯ä¸ŽLAN gossip poolæ˜¯ä¸åŒçš„ï¼Œå®ƒä¸ºå…·æœ‰æ›´é«˜å»¶è¿Ÿçš„ç½‘ç»œå“åº”åšäº†ä¼˜åŒ–ï¼Œå¹¶ä¸”å¯èƒ½åŒ…æ‹¬å…¶ä»–consulé›†ç¾¤çš„serverèŠ‚ç‚¹ã€‚è®¾è®¡WANpoolçš„ç›®çš„æ˜¯è®©æ•°æ®ä¸­å¿ƒèƒ½å¤Ÿä»¥low-touchçš„æ–¹å¼å‘çŽ°å½¼æ­¤ã€‚å°†ä¸€ä¸ªæ–°çš„æ•°æ®ä¸­å¿ƒåŠ å…¥çŽ°æœ‰çš„WAN Gossipæ˜¯å¾ˆå®¹æ˜“çš„ã€‚å› ä¸ºæ± ä¸­çš„æ‰€æœ‰Serveréƒ½æ˜¯å¯æŽ§åˆ¶çš„ï¼Œè¿™ä¹Ÿä½¿è·¨æ•°æ®ä¸­å¿ƒçš„è¦æ±‚ã€‚å½“ä¸€ä¸ªSerferæŽ¥æ”¶åˆ°ä¸åŒçš„æ•°æ®ä¸­å¿ƒçš„è¦æ±‚æ—¶ï¼Œå®ƒæŠŠè¿™ä¸ªè¯·æ±‚è½¬å‘ç»™ç›¸åº”æ•°æ®ä¸­å¿ƒçš„ä»»ä¸€Serverã€‚ç„¶åŽï¼ŒæŽ¥æ”¶åˆ°è¯·æ±‚çš„Serverå¯èƒ½ä¼šè½¬å‘ç»™Leaderã€‚å¤šä¸ªæ•°æ®ä¸­å¿ƒä¹‹é—´æ˜¯ä½Žè€¦åˆï¼Œä½†ç”±äºŽæ•…éšœæ£€æµ‹ã€è¿žæŽ¥ç¼“å­˜å¤ç”¨ã€è·¨æ•°æ®ä¸­å¿ƒè¦æ±‚å¿«é€Ÿå’Œå¯é çš„å“åº”ã€‚ 3. consuléƒ¨ç½²3.1 dockerå®‰è£…dockerå®‰è£…å¾ˆç®€å•ï¼Œç¬”è€…è¿™è¾¹æ˜¯åŸºäºŽdocker-composeçš„é…ç½®æ–‡ä»¶ï¼Œåªéœ€è¦æœ¬åœ°å®‰è£…å¥½dockerå’Œdocker-composeï¼Œdocker-compose.ymlå¦‚ä¸‹ï¼š 12345678version: '3'services: consul: image: consul ports: - "8500:8500" - "8600:8600" - "8300:8300" æ‹‰å–consulå¾—æœ€æ–°imageï¼Œè¿›è¡Œç«¯å£æ˜ å°„ï¼Œæš´éœ²å¯¹å¤–çš„ç«¯å£8500ï¼Œ8300. 3.2 è½¯ä»¶å®‰è£… ä»Žå®˜ç½‘ä¸‹è½½ç½ªè¡Œçš„consulå®‰è£…åŒ…ï¼Œhttps://www.consul.io/downloads.htmlã€‚ è§£åŽ‹consul_0.6.4_darwin_amd64.zipã€‚ å°†è§£åŽ‹åŽçš„äºŒè¿›åˆ¶æ–‡ä»¶consulæ‹·è´åˆ°/usr/local/binä¸‹ã€‚ å†™é…ç½®æ–‡ä»¶ã€‚æœåŠ¡æ³¨å†Œçš„é…ç½®æ–‡ä»¶å¦‚ä¸‹: 12345678910111213141516&#123; &quot;service&quot;: &#123; &quot;name&quot;: &quot;redis&quot;, &quot;tags&quot;: [&quot;master&quot;], &quot;address&quot;: &quot;1192.168.1.100&quot;, &quot;port&quot;: 8000, &quot;enableTagOverride&quot;: false, &quot;check&quot;: &#123; &quot;id&quot;: &quot;redis&quot;, &quot;name&quot;: &quot;redis on port 8000&quot;, &quot;tcp&quot;: &quot;localhost:8000&quot;, &quot;interval&quot;: &quot;10s&quot;, &quot;timeout&quot;: &quot;1s&quot; &#125; &#125;&#125; å¦‚ä¸Šé…ç½®æ³¨å†Œäº†Redisçš„8000ç«¯å£ï¼Œå¹¶å¸¦æœ‰tcpçš„health checkã€‚ èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ï¼š 12345678910111213141516&#123; "datacenter": "east-cn", "data_dir": "/opt/consul", "log_level": "INFO", "node_name": "redis", "server": true, "addresses": &#123; "https": "192.168.1.100" &#125;, "ports": &#123; "https": 0 &#125;, "ui": true, "retry-join": []&#125; å½“åŠ è½½é…ç½®é€‰é¡¹æ—¶ï¼Œconsulæ˜¯æŒ‰ç…§è¯å…¸é¡ºåºä»Žæ‰€æœ‰é…ç½®æ–‡ä»¶æˆ–ç›®å½•ä¸­åŠ è½½ã€‚æ¯”å¦‚ï¼Œa.jsonä¼šå…ˆäºŽe.jsonå¤„ç†ã€‚åŽé¢è®¾å®šçš„é…ç½®é€‰é¡¹ä¼šåˆå¹¶åˆ°å‰é¢çš„é…ç½®é›†åˆä¸­ï¼Œå¦‚æžœå­˜åœ¨é‡å¤çš„é…ç½®é€‰é¡¹åˆ™ä¼šè¦†ç›–ã€‚å½“ç„¶ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚äº‹ä»¶å¤„ç†ç¨‹åºï¼ŒåŽé¢å¤„ç†ç¨‹åºä¼šè¿½åŠ åˆ°çŽ°æœ‰çš„é…ç½®é€‰é¡¹ä¸­ï¼Œå½¢æˆäº‹ä»¶å¤„ç†ç¨‹åºåˆ—è¡¨ã€‚ 3.3 å¯åŠ¨å…·ä½“å¯åŠ¨æ–‡æ¡£è§configurationã€‚å¦‚: consul agent -server -config-dir /etc/consul.d -bind=192.168.1.100 -config-dir /etc/consul.d config-diréœ€è¦åŠ è½½çš„é…ç½®æ–‡ä»¶ç›®å½•ï¼Œconsulå°†åŠ è½½ç›®å½•ä¸‹æ‰€æœ‰åŽç¼€ä¸ºâ€œ.jsonâ€çš„æ–‡ä»¶ï¼ŒåŠ è½½é¡ºåºä¸ºå­—æ¯é¡ºåºï¼Œæ–‡ä»¶ä¸­é…ç½®é€‰é¡¹åˆå¹¶æ–¹å¼å¦‚config-fileã€‚è¯¥å‚æ•°å¯ä»¥å¤šæ¬¡é…ç½®ã€‚ç›®å½•ä¸­çš„å­ç›®å½•æ˜¯ä¸ä¼šåŠ è½½çš„ã€‚ data-diræ­¤ç›®å½•æ˜¯ä¸ºAgentå­˜æ”¾stateæ•°æ®çš„ã€‚æ˜¯æ‰€æœ‰Agentéœ€è¦çš„ï¼Œè¯¥ç›®å½•åº”è¯¥å­˜æ”¾åœ¨æŒä¹…å­˜å‚¨ä¸­ï¼ˆrebootä¸ä¼šä¸¢å¤±ï¼‰ï¼Œå¯¹äºŽserverè§’è‰²çš„Agentæ˜¯å¾ˆå…³é”®çš„,éœ€è¦è®°å½•é›†ç¾¤çŠ¶æ€ã€‚å¹¶ä¸”è¯¥ç›®å½•æ˜¯æ”¯æŒæ–‡ä»¶é”ã€‚ serverè®¾ç½®Agentæ˜¯serveræ¨¡å¼è¿˜æ˜¯clientæ¨¡å¼ã€‚Consul agentæœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼šServerå’ŒClientã€‚è¿™é‡Œçš„Serverå’ŒClientåªæ˜¯Consulé›†ç¾¤å±‚é¢çš„åŒºåˆ†ï¼Œä¸Žæ­å»ºåœ¨Clusterä¹‹ä¸Š çš„åº”ç”¨æœåŠ¡æ— å…³ã€‚Consule Serveræ¨¡å¼agentèŠ‚ç‚¹ç”¨äºŽé‡‡ç”¨raftç®—æ³•ç»´æŠ¤Consulé›†ç¾¤çš„çŠ¶æ€ï¼Œå®˜æ–¹å»ºè®®æ¯ä¸ªConsul Clusterè‡³å°‘æœ‰3ä¸ªæˆ–ä»¥ä¸Šçš„è¿è¡Œåœ¨Server modeçš„Agentï¼ŒClientèŠ‚ç‚¹ä¸é™ã€‚ å…¶ä»–å¸¸ç”¨çš„è¿˜æœ‰ï¼š clientå°†ç»‘å®šåˆ°clientæŽ¥å£çš„åœ°å€ï¼Œå¯ä»¥æ˜¯HTTPã€DNSã€RPCæœåŠ¡å™¨ã€‚é»˜è®¤ä¸ºâ€œ127.0.0.1â€ï¼Œåªå…è®¸å›žè·¯è¿žæŽ¥ã€‚RPCåœ°å€ä¼šè¢«å…¶ä»–çš„consulå‘½ä»¤ä½¿ç”¨ï¼Œæ¯”å¦‚consul membersï¼ŒæŸ¥è¯¢agentåˆ—è¡¨ nodeèŠ‚ç‚¹åœ¨é›†ç¾¤çš„åå­—ï¼Œåœ¨é›†ç¾¤ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚é»˜è®¤ä¸ºèŠ‚ç‚¹çš„Hostnameã€‚ bootstrapè®¾ç½®æœåŠ¡æ˜¯å¦ä¸ºâ€œbootstrapâ€æ¨¡å¼ã€‚å¦‚æžœæ•°æ®ä¸­å¿ƒåªæœ‰1ä¸ªserver agentï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½®è¯¥å‚æ•°ã€‚ä»ŽæŠ€æœ¯ä¸Šæ¥è®²ï¼Œå¤„äºŽbootstrapæ¨¡å¼çš„æœåŠ¡å™¨æ˜¯å¯ä»¥é€‰æ‹©è‡ªå·±ä½œä¸ºRaft Leaderçš„ã€‚åœ¨consulé›†ç¾¤ä¸­ï¼Œåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥é…ç½®è¯¥å‚æ•°ï¼Œå¦‚æžœæœ‰å¤šä¸ªå‚æ•°é…ç½®è¯¥å‚æ•°ï¼Œé‚£ä¹ˆéš¾ä»¥ä¿è¯ä¸€è‡´æ€§ã€‚ bindç”¨äºŽé›†ç¾¤å†…éƒ¨é€šä¿¡çš„IPåœ°å€ï¼Œä¸Žé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹äº’è¿žå¯é€šã€‚é»˜è®¤ä¸ºâ€œ0.0.0.0â€ï¼Œconsulå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„ç§æœ‰IPv4åœ°å€ã€‚å¦‚æžœæŒ‡å®šâ€œ[::]â€ï¼Œconsulå°†ä½¿ç”¨ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„å…¬å…±IPv6åœ°å€ã€‚ä½¿ç”¨TCPå’ŒUDPé€šä¿¡ã€‚æ³¨æ„é˜²ç«å¢™ï¼Œé¿å…æ— æ³•é€šä¿¡ã€‚ 3.4 ç»“æžœåœ¨å¼€å¯äº†&quot;ui&quot;: trueserverä¸»æœºä¸Šï¼Œå¦‚http://192.168.1.100:8500/uiæŸ¥çœ‹æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ã€‚demo uiå¦‚ä¸‹ï¼š 4. æ€»ç»“æœ¬æ–‡ä»‹ç»äº†consulçš„ä¸€äº›å†…å¹•åŠconsulé…ç½®ç›¸å…³ï¼Œå¹¶å¯¹é¡¹ç›®ä¸­çš„ä¸€äº›å®žé™…é…ç½®è¿›è¡Œå±•ç¤ºã€‚å¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¤§å®¶å¯¹consulç›¸å…³çš„çŸ¥è¯†æœ‰æ‰€äº†è§£ï¼Œå¹¶å¯¹äºŽå…¥é—¨é…ç½®consulå’Œå®žé™…åº”ç”¨æœ‰æ‰€çŸ¥é“ã€‚ä¸ªäººè®¤ä¸ºï¼ŒconsulåŽŸç†è¿˜æ˜¯ç®€å•æ˜“æ‡‚çš„ï¼Œé›†ç¾¤çš„é…ç½®ä¹Ÿä¸å¤æ‚ï¼Œå®‰åˆ©å¤§å®¶ä½¿ç”¨ã€‚åŽé¢ä¼šå†å†™ä¸€ç¯‡ä»‹ç»Spring cloudä¸­é›†æˆå’Œä½¿ç”¨consulç»„ä»¶ä½œä¸ºæ³¨å†Œä¸Žå‘çŽ°ä¸­å¿ƒã€‚ å‚è€ƒæ–‡çŒ®consulæ–‡æ¡£consulä¸­æ–‡ç¿»è¯‘]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>consul</tag>
        <tag>cluster</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[snowflakeå‡çº§ç‰ˆå…¨å±€idç”Ÿæˆ]]></title>
    <url>%2F2017%2F09%2F09%2Fsnowflake%2F</url>
    <content type="text"><![CDATA[1. èƒŒæ™¯åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è€…å¾®æœåŠ¡æž¶æž„åŸºæœ¬éƒ½é‡‡ç”¨äº†åˆ†åº“åˆ†è¡¨çš„è®¾è®¡ï¼Œå…¨å±€å”¯ä¸€idç”Ÿæˆçš„éœ€æ±‚å˜å¾—å¾ˆè¿«åˆ‡ã€‚ä¼ ç»Ÿçš„å•ä½“åº”ç”¨ï¼Œä½¿ç”¨å•åº“ï¼Œæ•°æ®åº“ä¸­è‡ªå¢židå¯ä»¥å¾ˆæ–¹ä¾¿å®žçŽ°ã€‚åˆ†åº“ä¹‹åŽï¼Œé¦–å…ˆéœ€è¦åˆ†åº“é”®ï¼Œåˆ†åº“é”®å¿…ç„¶ä¸èƒ½é‡å¤ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„åšæ³•å¹¶ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚æ¦‚æ‹¬ä¸‹æ¥ï¼Œé‚£ä¸šåŠ¡ç³»ç»Ÿå¯¹IDå·çš„è¦æ±‚æœ‰å“ªäº›å‘¢ï¼Ÿ 1.å…¨å±€å”¯ä¸€æ€§ï¼šä¸èƒ½å‡ºçŽ°é‡å¤çš„IDå·ï¼Œæ—¢ç„¶æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚2.è¶‹åŠ¿é€’å¢žï¼šåœ¨MySQL InnoDBå¼•æ“Žä¸­ä½¿ç”¨çš„æ˜¯èšé›†ç´¢å¼•ï¼Œç”±äºŽå¤šæ•°RDBMSä½¿ç”¨B-treeçš„æ•°æ®ç»“æž„æ¥å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œåœ¨ä¸»é”®çš„é€‰æ‹©ä¸Šé¢æˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æœ‰åºçš„ä¸»é”®ä¿è¯å†™å…¥æ€§èƒ½ã€‚3.å•è°ƒé€’å¢žï¼šä¿è¯ä¸‹ä¸€ä¸ªIDä¸€å®šå¤§äºŽä¸Šä¸€ä¸ªIDï¼Œä¾‹å¦‚äº‹åŠ¡ç‰ˆæœ¬å·ã€IMå¢žé‡æ¶ˆæ¯ã€æŽ’åºç­‰ç‰¹æ®Šéœ€æ±‚ã€‚4.ä¿¡æ¯å®‰å…¨ï¼šå¦‚æžœIDæ˜¯è¿žç»­çš„ï¼Œæ¶æ„ç”¨æˆ·çš„æ‰’å–å·¥ä½œå°±éžå¸¸å®¹æ˜“åšäº†ï¼Œç›´æŽ¥æŒ‰ç…§é¡ºåºä¸‹è½½æŒ‡å®šURLå³å¯ï¼›å¦‚æžœæ˜¯è®¢å•å·å°±æ›´å±é™©äº†ï¼Œç«žå¯¹å¯ä»¥ç›´æŽ¥çŸ¥é“æˆ‘ä»¬ä¸€å¤©çš„å•é‡ã€‚æ‰€ä»¥åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸‹ï¼Œä¼šéœ€è¦IDæ— è§„åˆ™ã€ä¸è§„åˆ™ã€‚ å…¶ä¸­ç¬¬3å’Œç¬¬4ç‚¹æ˜¯äº’æ–¥çš„ã€‚é™¤äº†åŠŸèƒ½æ€§éœ€æ±‚ï¼Œè¿˜æœ‰æ€§èƒ½å’Œå¯é æ€§çš„éœ€æ±‚ï¼š å¹³å‡å»¶è¿Ÿå’ŒTP999å»¶è¿Ÿéƒ½è¦å°½å¯èƒ½ä½Žï¼› å¯ç”¨æ€§5ä¸ª9ï¼› é«˜QPSã€‚ 2. è¿›é˜¶åŽ†ç¨‹è‡ªä»Žé¡¹ç›®ä»Žå•ä½“åº”ç”¨æ‹†åˆ†æˆå¾®æœåŠ¡æž¶æž„åŽï¼Œå¯¹å…¨å±€idéƒ¨åˆ†åšäº†äº›æ‘¸ç´¢ã€‚ 2.1 uuidåˆšå¼€å§‹æ‹†åˆ†ä¸šåŠ¡ï¼Œidä¸»é”®éƒ½æ˜¯ä½¿ç”¨uuidå­—ç¬¦ä¸²ã€‚UUID(Universally Unique Identifier)çš„æ ‡å‡†åž‹å¼åŒ…å«32ä¸ª16è¿›åˆ¶æ•°å­—ï¼Œä»¥è¿žå­—å·åˆ†ä¸ºäº”æ®µï¼Œå½¢å¼ä¸º8-4-4-4-12çš„36ä¸ªå­—ç¬¦ã€‚ç±»ä¼¼è¿™æ ·çš„å­—ç¬¦ä¸²ï¼šdc5adf0a-d531-11e5-95aa-3c15c2d22392ã€‚128ä½ï¼Œæ ¹æœ¬ä¸ç”¨æ‹…å¿ƒä¸å¤Ÿç”¨ã€‚ç”Ÿæˆçš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼š 1UUID userId = UUID.randomUUID(); uuidå…¨çƒå”¯ä¸€ï¼Œæœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰ç½‘ç»œæ¶ˆè€—ï¼Œäº§ç”Ÿçš„æ€§èƒ½ç»å¯¹å¯ä»¥æ»¡è¶³ã€‚å…¶ç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ¯”è¾ƒå åœ°æ–¹ï¼Œå’ŒINTç±»åž‹ç›¸æ¯”ï¼Œå­˜å‚¨ä¸€ä¸ªUUIDè¦èŠ±è´¹æ›´å¤šçš„ç©ºé—´ã€‚ä½¿ç”¨UUIDåŽï¼ŒURLæ˜¾å¾—å†—é•¿ï¼Œä¸å¤Ÿå‹å¥½ã€‚IDä½œä¸ºä¸»é”®æ—¶åœ¨ç‰¹å®šçš„çŽ¯å¢ƒä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚åšDBä¸»é”®çš„åœºæ™¯ä¸‹ï¼ŒUUIDå°±éžå¸¸ä¸é€‚ç”¨ï¼š MySQLå®˜æ–¹æœ‰æ˜Žç¡®çš„å»ºè®®ä¸»é”®è¦å°½é‡è¶ŠçŸ­è¶Šå¥½ï¼Œ36ä¸ªå­—ç¬¦é•¿åº¦çš„UUIDä¸ç¬¦åˆè¦æ±‚ã€‚ å¯¹MySQLç´¢å¼•ä¸åˆ©ï¼šå¦‚æžœä½œä¸ºæ•°æ®åº“ä¸»é”®ï¼Œåœ¨InnoDBå¼•æ“Žä¸‹ï¼ŒUUIDçš„æ— åºæ€§å¯èƒ½ä¼šå¼•èµ·æ•°æ®ä½ç½®é¢‘ç¹å˜åŠ¨ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚ 2.2 æ•°æ®åº“ç”Ÿæˆä»¥MySQLä¸¾ä¾‹ï¼Œåˆ©ç”¨ç»™å­—æ®µè®¾ç½®auto_increment_incrementå’Œauto_increment_offsetæ¥ä¿è¯IDè‡ªå¢žï¼Œæ¯æ¬¡ä¸šåŠ¡ä½¿ç”¨ä¸‹åˆ—SQLè¯»å†™MySQLå¾—åˆ°IDå·ã€‚å‚è€ƒäº†Leafçš„å®žçŽ°æ€æƒ³: id serveræ¯æ¬¡æ‰¹é‡ä»Žæ•°æ®åº“å–å·æ®µï¼Œæœ¬åœ°ç¼“å­˜è¿™ä¸ªå·æ®µï¼Œå¹¶ä¸”è®¾ç½®é˜ˆå€¼ï¼Œå½“è¾¾åˆ°0.8ï¼ˆå·²ç”¨ä¸Žå·æ®µå®¹é‡çš„æ¯”å€¼ï¼‰ï¼Œè‡ªåŠ¨åŽ»èŽ·å–ä¸€ä¸ªæ–°çš„å·æ®µï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜çš„å·æ®µã€‚ id clientï¼Œå³å…·ä½“çš„è°ƒç”¨æœåŠ¡å®žä¾‹ï¼Œåœ¨æœ¬åœ°ä¹Ÿåšä¸€ä¸ªç¼“å­˜ï¼Œå®žçŽ°å’Œid serverçš„ç¼“å­˜å·®ä¸å¤šï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å‡è½»idæœåŠ¡ç«¯çš„åŽ‹åŠ›ï¼ŒåŒæ—¶å‡å°‘äº†rpcè°ƒç”¨çš„ç½‘ç»œæ¶ˆè€—ã€‚ ä»¥ä¸Šæ–¹æ¡ˆï¼Œå…¶ç¼ºç‚¹æ˜¯ï¼š å·æ®µå­˜åœ¨æµªè´¹ï¼Œæ— è®ºå“ªä¸ªå®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯é‡å¯éƒ½ä¼šæµªè´¹å·æ®µã€‚ å·æ®µæ˜¯ç›´æŽ¥è‡ªå¢žï¼Œä¸å¤Ÿéšæœºï¼Œå¯¹å¤–æš´éœ²ä¿¡æ¯è¿‡å¤šã€‚ DBå®•æœºä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ã€‚è™½ç„¶åœ¨DBå®•æœºä¹‹åŽï¼Œåˆ©ç”¨ç¼“å­˜è¿˜èƒ½è¿›è¡ŒçŸ­æš‚ä¾›å·ï¼Œä½†æ˜¯æ•°æ®åº“çš„ä¾èµ–è¿˜æ˜¯å¾ˆé‡ã€‚Leafé‡‡ç”¨çš„ä¸€èˆ¬åšæ³•æ˜¯é«˜å¯ç”¨å®¹ç¾: é‡‡ç”¨ä¸€ä¸»ä¸¤ä»Žçš„æ–¹å¼ï¼ŒåŒæ—¶åˆ†æœºæˆ¿éƒ¨ç½²ï¼ŒMasterå’ŒSlaveä¹‹é—´é‡‡ç”¨åŠåŒæ­¥æ–¹å¼åŒæ­¥æ•°æ®ã€‚åŒæ—¶ä½¿ç”¨DBProxyåšä¸»ä»Žåˆ‡æ¢ã€‚å½“ç„¶è¿™ç§æ–¹æ¡ˆåœ¨ä¸€äº›æƒ…å†µä¼šé€€åŒ–æˆå¼‚æ­¥æ¨¡å¼ï¼Œç”šè‡³åœ¨éžå¸¸æžç«¯æƒ…å†µä¸‹ä»ç„¶ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†æ˜¯å‡ºçŽ°çš„æ¦‚çŽ‡éžå¸¸å°ã€‚ 3. snowflakeæ–¹æ¡ˆ3.1 ä»‹ç»è€ƒè™‘åˆ°ä¸Šè¿°æ–¹æ¡ˆçš„ç¼ºé™·ï¼Œç¬”è€…è°ƒæŸ¥äº†å…¶ä»–çš„ç”Ÿæˆæ–¹æ¡ˆï¼Œsnowflakeå°±æ˜¯å…¶ä¸­ä¸€ç§æ–¹æ¡ˆã€‚è¶‹åŠ¿é€’å¢žå’Œä¸å¤Ÿéšæœºçš„é—®é¢˜ï¼Œåœ¨snowflakeå®Œå…¨å¯ä»¥è§£å†³ï¼ŒSnowflake IDæœ‰64bitsé•¿ï¼Œç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š ç¬¬ä¸€ä½ä¸º0ï¼Œä¸ç”¨ã€‚ timestampâ€”41bits,ç²¾ç¡®åˆ°msï¼Œé‚£å°±æ„å‘³ç€å…¶å¯ä»¥è¡¨ç¤ºé•¿è¾¾(2^41-1)/(1000360024*365)=139.5å¹´ï¼Œå¦å¤–ä½¿ç”¨è€…å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªå¼€å§‹çºªå…ƒï¼ˆepoch)ï¼Œç„¶åŽç”¨(å½“å‰æ—¶é—´-å¼€å§‹çºªå…ƒï¼‰ç®—å‡ºtimeï¼Œè¿™è¡¨ç¤ºåœ¨timeè¿™ä¸ªéƒ¨åˆ†åœ¨140å¹´çš„æ—¶é—´é‡Œæ˜¯ä¸ä¼šé‡å¤çš„ï¼Œå®˜æ–¹æ–‡æ¡£åœ¨è¿™é‡Œå†™æˆäº†41bitsï¼Œåº”è¯¥æ˜¯å†™é”™äº†ã€‚å¦å¤–ï¼Œè¿™é‡Œç”¨timeè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åŽŸå› ï¼Œå°±æ˜¯å¯ä»¥ç›´æŽ¥æ›´å…·timeè¿›è¡ŒæŽ’åºï¼Œå¯¹äºŽtwitterè¿™ç§æ›´æ–°é¢‘ç¹çš„åº”ç”¨ï¼Œæ—¶é—´æŽ’åºå°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚ machine idâ€”10bits,è¯¥éƒ¨åˆ†å…¶å®žç”±datacenterIdå’ŒworkerIdä¸¤éƒ¨åˆ†ç»„æˆï¼Œè¿™ä¸¤éƒ¨åˆ†æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡æ˜Žçš„ã€‚ datacenterIdï¼Œæ–¹ä¾¿æ­å»ºå¤šä¸ªç”Ÿæˆuidçš„serviceï¼Œå¹¶ä¿è¯uidä¸é‡å¤ï¼Œæ¯”å¦‚åœ¨datacenter0å°†æœºå™¨0ï¼Œ1ï¼Œ2ç»„æˆäº†ä¸€ä¸ªç”Ÿæˆuidçš„serviceï¼Œè€Œdatacenter1æ­¤æ—¶ä¹Ÿéœ€è¦ä¸€ä¸ªç”Ÿæˆuidçš„serviceï¼Œä»Žæœ¬ä¸­å¿ƒèŽ·å–uidæ˜¾ç„¶æ˜¯æœ€å¿«æœ€æ–¹ä¾¿çš„ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥åœ¨è‡ªå·±ä¸­å¿ƒæ­å»ºï¼Œåªè¦ä¿è¯datacenterIdå”¯ä¸€ã€‚å¦‚æžœæ²¡æœ‰datacenterIdï¼Œå³ç”¨10bitsï¼Œé‚£ä¹ˆåœ¨æ­å»ºä¸€ä¸ªæ–°çš„serviceå‰å¿…é¡»çŸ¥é“ç›®å‰å·²ç»åœ¨ç”¨çš„idï¼Œå¦åˆ™ä¸èƒ½ä¿è¯ç”Ÿæˆçš„idå”¯ä¸€ï¼Œæ¯”å¦‚æ­å»ºçš„ä¸¤ä¸ªuid serviceä¸­éƒ½æœ‰machine idä¸º100çš„æœºå™¨ï¼Œå¦‚æžœå…¶serveræ—¶é—´ç›¸åŒï¼Œé‚£ä¹ˆäº§ç”Ÿç›¸åŒidçš„æƒ…å†µä¸å¯é¿å…ã€‚ workerIdæ˜¯å®žé™…serveræœºå™¨çš„ä»£å·ï¼Œæœ€å¤§åˆ°32ï¼ŒåŒä¸€ä¸ªdatacenterä¸‹çš„workerIdæ˜¯ä¸èƒ½é‡å¤çš„ã€‚å®ƒä¼šè¢«æ³¨å†Œåˆ°consulä¸Šï¼Œç¡®ä¿workerIdæœªè¢«å…¶ä»–æœºå™¨å ç”¨ï¼Œå¹¶å°†host:portå€¼å­˜å…¥ï¼Œæ³¨å†ŒæˆåŠŸåŽå°±å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡äº†ã€‚ sequence id â€”12bits,è¯¥idå¯ä»¥è¡¨ç¤º4096ä¸ªæ•°å­—ï¼Œå®ƒæ˜¯åœ¨timeç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé€’å¢žè¯¥å€¼ç›´åˆ°ä¸º0ï¼Œå³ä¸€ä¸ªå¾ªçŽ¯ç»“æŸï¼Œæ­¤æ—¶ä¾¿åªèƒ½ç­‰åˆ°ä¸‹ä¸€ä¸ªmsåˆ°æ¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹4096/msçš„è¯·æ±‚æ˜¯ä¸å¤ªå¯èƒ½å‡ºçŽ°çš„ï¼Œæ‰€ä»¥è¶³å¤Ÿä½¿ç”¨äº†ã€‚ 3.2 å®žçŽ°æ€è·¯snowflakeæ–¹æ¡ˆï¼ŒidæœåŠ¡ç«¯ç”Ÿæˆï¼Œä¸ä¾èµ–DBï¼Œæ—¢èƒ½ä¿è¯æ€§èƒ½ï¼Œä¸”ç”Ÿæˆçš„idè¶³å¤Ÿéšæœºã€‚æ¯ä¸€æ¯«ç§’ï¼Œä¸€å°workerå¯ä»¥ç”Ÿæˆ4096ä¸ªidï¼Œå¦‚æžœè¶…è¿‡ï¼Œä¼šé˜»å¡žåˆ°ä¸‹ä¸€æ¯«ç§’ç”Ÿæˆã€‚å¯¹äºŽé‚£äº›å¹¶å‘é‡å¾ˆå¤§çš„ç³»ç»Ÿæ¥è¯´,æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„, é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±æ˜¯é€šè¿‡datacenterIdå’ŒworkerIdæ¥åšåŒºåˆ†,è¿™ä¸¤ä¸ªID,åˆ†åˆ«æ˜¯5bit,å…±10bit,æœ€å¤§å€¼æ˜¯1024(0-1023)ä¸ª, åœ¨è¿™ç§æƒ…å†µä¸‹,snowflakeä¸€æ¯«ç§’ç†è®ºä¸Šæœ€å¤§èƒ½å¤Ÿç”Ÿæˆçš„IDæ•°é‡æ˜¯çº¦42Wä¸ª,è¿™æ˜¯ä¸€ä¸ªéžå¸¸å¤§çš„åŸºæ•°äº†,ç†è®ºä¸Šèƒ½å¤Ÿæ»¡è¶³ç»å¤§å¤šæ•°ç³»ç»Ÿçš„å¹¶å‘é‡ã€‚ è¯¥æ–¹æ¡ˆä¾èµ–äºŽç³»ç»Ÿæ—¶é’Ÿï¼Œéœ€è¦è€ƒè™‘æ—¶é’Ÿå›žæ‹¨çš„é—®é¢˜ã€‚æœ¬åœ°ç¼“å­˜ä¸Šä¸€æ¬¡è¯·æ±‚çš„lastTimestampï¼Œä¸€ä¸ªçº¿ç¨‹è¿‡æ¥èŽ·å–idæ—¶ï¼Œé¦–å…ˆæ ¡éªŒå½“å‰æ—¶é—´æ˜¯å¦å°äºŽä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ã€‚å¦‚æžœå°äºŽè¯´æ˜Žç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹è¿‡ï¼Œå›žé€€åœ¨ä¸Šä¸€æ¬¡IDç”Ÿæˆæ—¶é—´ä¹‹å‰åº”å½“æŠ›å‡ºå¼‚å¸¸ï¼å¦‚æ­¤å¯ä»¥è§£å†³è¿è¡Œä¸­ï¼Œç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹çš„é—®é¢˜ã€‚ å¦ä¸€ç§æƒ…å†µæ˜¯ï¼ŒserveræœåŠ¡å¯åŠ¨æ—¶ï¼Œç³»ç»Ÿçš„æ—¶é—´è¢«å›žæ‹¨ï¼ˆè™½ç„¶æ¯”è¾ƒæžç«¯ï¼Œè¿˜æ˜¯åˆ—åœ¨è€ƒè™‘ä¸­ï¼‰ï¼Œè¿™æ ·æœ‰å¯èƒ½ä¸Žä¹‹å‰ç”Ÿæˆçš„idå†²çªï¼Œå…¨å±€ä¸å”¯ä¸€ã€‚è¿™è¾¹è§£å†³æ–¹æ³•æ˜¯åˆ©ç”¨é¡¹ç›®çš„æœåŠ¡å‘çŽ°ä¸Žæ³¨å†Œç»„ä»¶consulï¼Œåœ¨consulé›†ç¾¤å­˜å‚¨æœ€æ–°çš„lastTimestampï¼Œkeyä¸ºå¯¹åº”çš„machine-idã€‚consulçš„ä¸€è‡´æ€§åŸºäºŽraftç®—æ³•ï¼Œå¹¶åˆ©ç”¨Gossipåè®®ï¼š Consul uses a gossip protocol to manage membership and broadcast messages to the cluster. All of this is provided through the use of the Serf library. å…·ä½“çš„åè®®ç®—æ³•ï¼Œå¯ä»¥å‚è€ƒGossipã€‚æ¯æ¬¡serverå®žä¾‹å¯åŠ¨æ—¶ï¼Œå®žä¾‹åŒ–idç”Ÿæˆbeançš„æ—¶å€™ï¼Œä¼šé¦–å…ˆæ ¡éªŒå½“å‰æ—¶é—´ä¸Žconsulé›†ç¾¤ä¸­è¯¥workerå¯¹åº”çš„lastTimestampå¤§å°ï¼Œå¦‚æžœå½“å‰æ—¶é—´åå°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼ŒæœåŠ¡å¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚ ç¬”è€…é¡¹ç›®æš‚æ—¶æœªåˆ†data centerï¼Œæ‰€ä»¥machine-idéƒ¨åˆ†éƒ½æ˜¯ä»¥æœåŠ¡å®žä¾‹çš„workidä»£æ›¿ã€‚workidå¯ä»¥ä»Žé…ç½®ä¸­å¿ƒèŽ·å–ï¼Œä¹Ÿå¯ä»¥æœ¬åœ°é…ç½®ã€‚ç®€åŒ–çš„ç³»ç»Ÿæž¶æž„éƒ¨ç½²å›¾å¦‚ä¸‹ï¼š consulé›†ç¾¤è¿™è¾¹ä½œä¸ºæä¾›naming serviceå’Œkvå­˜å‚¨çš„ç»„ä»¶ï¼Œæ¯ä¸ªæœåŠ¡éƒ¨ç½²åŽæ³¨å†Œåˆ°consulé›†ç¾¤ï¼Œè‡³äºŽconsulé›†ç¾¤ç›¸å…³çš„ä¿¡æ¯ï¼Œä»¥åŠconsulæˆå‘˜çš„ä¸€è‡´æ€§ç›¸å…³ï¼ŒåŽé¢å•ç‹¬ä¸€ç¯‡æ–‡ç« è¯¦ç»†ä»‹ç»ã€‚ è¯·æ±‚idç”Ÿæˆæµç¨‹å›¾å¦‚ä¸‹ï¼š æœåŠ¡å®žä¾‹å¯åŠ¨çš„æµç¨‹å›¾è§ä¸Šæ–‡ï¼Œæ­¤å¤„ä¸ç”»å‡ºäº†ã€‚è¿™è¾¹éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼ŒæœåŠ¡æ³¨å†Œä¸Žå‘çŽ°ç»„ä»¶consulã€‚éƒ¨ç½²æ—¶æ¯ä¸ªæœåŠ¡å®žä¾‹éƒ½ä¼šæ³¨å†Œåˆ°ä¸€ä¸ªconsul agentï¼ˆä¸€èˆ¬æ˜¯æœ¬æœºï¼‰ï¼Œconsul agentè¿žæŽ¥åˆ°consulé›†ç¾¤ï¼Œé€šè¿‡gossipåè®®è¿›è¡Œå¹¿æ’­ä¿¡æ¯ï¼Œæ‰€ä»¥å¦‚æžœè¿žæŽ¥çš„consul agentè¿›ç¨‹ä¸å¹¸æŒ‚æŽ‰ï¼ˆå¤§å¤šä¸ºç³»ç»Ÿå®•æœºï¼‰ï¼Œåœ¨è¿›ç¨‹é‡å¯åŽï¼Œè¿˜æ˜¯èƒ½è¿…é€ŸèŽ·å–åˆ°é›†ç¾¤ä¸­å­˜å‚¨çš„è¯¥workidçš„lastTimestampï¼Œé’ˆå¯¹è¯¥workidï¼Œå¦‚æžœç³»ç»Ÿæ—¶é—´å›žæ‹¨å°äºŽlastTimestampï¼ŒGeneratorå¯åŠ¨æ—¶ä¼šæŠ¥è­¦ã€‚è€Œå¯¹äºŽå¤§äºŽlastTimestampçš„æƒ…å†µï¼Œå¯èƒ½ç³»ç»Ÿæ—¶é’Ÿè¿˜æ˜¯ç›¸å¯¹å›žæ‹¨ï¼Œæˆ‘ä»¬å§‘ä¸”å¯ä»¥è®¤ä¸ºå¯¹å…¨å±€idæ²¡æœ‰å½±å“ã€‚ å®žä¾‹åŒ–æ—¶ï¼Œè¿›è¡Œæ ¡éªŒï¼š 123456789public IdServiceImpl(long workerId, ConsulClient consulClient) &#123; if (workerId &gt; idMeta.MAX_ID || workerId &lt; 0) &#123; throw new IllegalArgumentException(String.format("worker Id can't be greater than %d or less than 0", idMeta.MAX_ID)); &#125; this.workerId = workerId; this.consulClient = consulClient; validateStoredTimestamp(); log.info("worker starting. timestamp left shift &#123;&#125;, worker id bits &#123;&#125;, sequence bits &#123;&#125;, workerid &#123;&#125;", idMeta.TIMESTAMP_LEFT_SHIFT_BITS, idMeta.ID_BITS, idMeta.SEQUENCE_BITS, workerId);&#125; æ ¡éªŒå‡½æ•°ï¼š 123456789101112131415/** * checks for timestamp by workerId when server starts. * if server starts for the first time, just let it go and log warns. * if current timestamp is smaller than the value stored in consul server, throw exception. */private void validateStoredTimestamp() &#123; long current = timeGen(); Response&lt;GetValue&gt; keyValueResponse = consulClient.getKVValue(String.valueOf(workerId)); if (keyValueResponse.getValue() != null) &#123; lastTimestamp = Long.parseLong(keyValueResponse.getValue().getDecodedValue()); validateTimestamp(current, lastTimestamp, Periods.START); &#125; else &#123; log.warn(String.format("clock in consul is null. Generator works as for the 1st time.")); &#125;&#125; validateTimestamp: 123456789101112/** * å¦‚æžœå½“å‰æ—¶é—´æˆ³å°äºŽä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ï¼Œè¯´æ˜Žç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹è¿‡ï¼Œå›žé€€åœ¨ä¸Šä¸€æ¬¡IDç”Ÿæˆæ—¶é—´ä¹‹å‰åº”å½“æŠ›å‡ºå¼‚å¸¸ï¼ï¼ï¼ * * @param lastTimestamp ä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ * @param timestamp å½“å‰æ—¶é—´æˆ³ */ private void validateTimestamp(long timestamp, long lastTimestamp, Periods period) &#123; if (timestamp &lt; lastTimestamp) &#123; log.error(String.format("clock is moving backwards. Rejecting requests until %d.", lastTimestamp)); throw new IllegalStateException(String.format("Clock moved backwards in %s. Refusing to generate id for %d milliseconds", period, lastTimestamp - timestamp)); &#125; &#125; èŽ·å–idæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627/** * ç”ŸæˆIDï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ * * @return id */ public synchronized long genId() &#123; long timestamp = timeGen(); //å¦‚æžœå½“å‰æ—¶é—´å°äºŽä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ï¼Œè¯´æ˜Žç³»ç»Ÿæ—¶é’Ÿè¢«ä¿®æ”¹è¿‡ï¼Œå›žé€€åœ¨ä¸Šä¸€æ¬¡IDç”Ÿæˆæ—¶é—´ä¹‹å‰åº”å½“æŠ›å‡ºå¼‚å¸¸ï¼ï¼ï¼ validateTimestamp(timestamp, lastTimestamp, Periods.RUNNING); //å¦‚æžœæ˜¯åŒä¸€æ—¶é—´ç”Ÿæˆçš„ï¼Œåˆ™è¿›è¡Œæ¯«ç§’å†…sequenceç”Ÿæˆ if (lastTimestamp == timestamp) &#123; sequence = (sequence + 1) &amp; IdMeta.SEQUENCE_MASK; //æº¢å‡ºå¤„ç† if (sequence == 0) &#123;//é˜»å¡žåˆ°ä¸‹ä¸€æ¯«ç§’,èŽ·å¾—æ–°æ—¶é—´æˆ³ timestamp = tilNextMillis(lastTimestamp); &#125; &#125; else &#123;//æ—¶é—´æˆ³æ”¹å˜ï¼Œæ¯«ç§’å†…sequenceé‡ç½® sequence = 0L; &#125; //ä¸Šæ¬¡ç”ŸæˆIDæ—¶é—´æˆª lastTimestamp = timestamp; consulClient.setKVValue(String.valueOf(workerId), String.valueOf(lastTimestamp)); //ç§»ä½å¹¶é€šè¿‡æˆ–è¿ç®—ç»„æˆ64ä½ID return ((timestamp - idMeta.START_TIME) &lt;&lt; idMeta.TIMESTAMP_LEFT_SHIFT_BITS) | (workerId &lt;&lt; idMeta.ID_SHIFT_BITS) | sequence; &#125; 4. æ€»ç»“è¿™ç¯‡æ–‡ç« å’Œå¤§å®¶åˆ†äº«äº†ç¬”è€…é¡¹ç›®ä¸­å…¨å±€idç”ŸæˆæœåŠ¡çš„æ¼”è¿›è¿‡ç¨‹ã€‚å½“å‰çš„æ–¹æ¡ˆå¯ä»¥æ»¡è¶³ç¬”è€…å½“å‰é¡¹ç›®çš„éœ€æ±‚ï¼Œè‡³äºŽåˆ†data-centerï¼ˆåŒä¸€ä¸ªæœºæˆ¿ä¼˜å…ˆè°ƒç”¨ï¼‰ï¼Œéœ€è¦ç»“åˆrpcè°ƒç”¨è¿›ä¸€æ­¥åšå¤„ç†ï¼Œæ‰€ä»¥è¿™å—åŽç»­å¯ä»¥ç»§ç»­å®Œå–„ã€‚æ¬¢è¿Žå¤§å®¶æå‡ºå»ºè®®ã€‚ å‚è€ƒï¼š www.consul.io leaf Twitterçš„åˆ†å¸ƒå¼è‡ªå¢žIDç®—æ³•snowflake (Javaç‰ˆ)]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>id</tag>
        <tag>spring boot</tag>
        <tag>snowflake</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ThreadLocal]]></title>
    <url>%2F2017%2F09%2F04%2FThreadLocal%2F</url>
    <content type="text"><![CDATA[ThreadLocalä¸»è¦æ˜¯æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œåœ¨æ¯ä¸ªçº¿ç¨‹å†…éšæ—¶éšåœ°å¯å–ï¼Œéš”ç¦»å…¶ä»–çº¿ç¨‹ã€‚ 1. ThreadLocalæŽ¥å£1.1 ThreadLocalç±»æŽ¥å£å¾ˆç®€å•ï¼Œåªæœ‰4ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ï¼š void set(Object value)è®¾ç½®å½“å‰çº¿ç¨‹çš„çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ã€‚ public Object get()è¯¥æ–¹æ³•è¿”å›žå½“å‰çº¿ç¨‹æ‰€å¯¹åº”çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ public void remove()å°†å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼åˆ é™¤ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜çš„å ç”¨ï¼Œè¯¥æ–¹æ³•æ˜¯JDK 5.0æ–°å¢žçš„æ–¹æ³•ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œå½“çº¿ç¨‹ç»“æŸåŽï¼Œå¯¹åº”è¯¥çº¿ç¨‹çš„å±€éƒ¨å˜é‡å°†è‡ªåŠ¨è¢«åžƒåœ¾å›žæ”¶ï¼Œæ‰€ä»¥æ˜¾å¼è°ƒç”¨è¯¥æ–¹æ³•æ¸…é™¤çº¿ç¨‹çš„å±€éƒ¨å˜é‡å¹¶ä¸æ˜¯å¿…é¡»çš„æ“ä½œï¼Œä½†å®ƒå¯ä»¥åŠ å¿«å†…å­˜å›žæ”¶çš„é€Ÿåº¦ã€‚ protected Object initialValue()è¿”å›žè¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªprotectedçš„æ–¹æ³•ï¼Œæ˜¾ç„¶æ˜¯ä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹ç¬¬1æ¬¡è°ƒç”¨get()æˆ–set(Object)æ—¶æ‰æ‰§è¡Œï¼Œå¹¶ä¸”ä»…æ‰§è¡Œ1æ¬¡ã€‚ThreadLocalä¸­çš„ç¼ºçœå®žçŽ°ç›´æŽ¥è¿”å›žä¸€ä¸ªnullã€‚ åœ¨åŒæ­¥æœºåˆ¶ä¸­ï¼Œé€šè¿‡å¯¹è±¡çš„é”æœºåˆ¶ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å˜é‡ã€‚è¿™æ—¶è¯¥å˜é‡æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œä½¿ç”¨åŒæ­¥æœºåˆ¶è¦æ±‚ç¨‹åºæ…Žå¯†åœ°åˆ†æžä»€ä¹ˆæ—¶å€™å¯¹å˜é‡è¿›è¡Œè¯»å†™ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦é”å®šæŸä¸ªå¯¹è±¡ï¼Œä»€ä¹ˆæ—¶å€™é‡Šæ”¾å¯¹è±¡é”ç­‰ç¹æ‚çš„é—®é¢˜ï¼Œç¨‹åºè®¾è®¡å’Œç¼–å†™éš¾åº¦ç›¸å¯¹è¾ƒå¤§ã€‚ è€ŒThreadLocalåˆ™ä»Žå¦ä¸€ä¸ªè§’åº¦æ¥è§£å†³å¤šçº¿ç¨‹çš„å¹¶å‘è®¿é—®ã€‚ThreadLocalä¼šä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œä»Žè€Œéš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„è®¿é—®å†²çªã€‚å› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„å˜é‡å‰¯æœ¬ï¼Œä»Žè€Œä¹Ÿå°±æ²¡æœ‰å¿…è¦å¯¹è¯¥å˜é‡è¿›è¡ŒåŒæ­¥äº†ã€‚ThreadLocalæä¾›äº†çº¿ç¨‹å®‰å…¨çš„å…±äº«å¯¹è±¡ï¼Œåœ¨ç¼–å†™å¤šçº¿ç¨‹ä»£ç æ—¶ï¼Œå¯ä»¥æŠŠä¸å®‰å…¨çš„å˜é‡å°è£…è¿›ThreadLocalã€‚å¦‚æžœæƒ³åœ¨getä¹‹å‰ä¸éœ€è¦è°ƒç”¨setå°±èƒ½æ­£å¸¸è®¿é—®çš„è¯ï¼Œå¿…é¡»é‡å†™initialValue()æ–¹æ³•ã€‚æœ€å¸¸è§çš„ThreadLocalä½¿ç”¨åœºæ™¯ä¸º ç”¨æ¥è§£å†³ æ•°æ®åº“è¿žæŽ¥ã€Sessionç®¡ç†ç­‰ã€‚ 1.2 ä½¿ç”¨ThreadLocal123456789101112131415161718192021222324252627282930313233343536373839404142434445public class ThreadTest &#123; ThreadLocal&lt;Long&gt; longLocal = new ThreadLocal&lt;Long&gt;()&#123; protected Long initialValue() &#123; return Thread.currentThread().getId(); &#125; &#125;; ThreadLocal&lt;String&gt; stringLocal = new ThreadLocal&lt;String&gt;()&#123;; protected String initialValue() &#123; return Thread.currentThread().getName(); &#125; &#125;; public void set() &#123; longLocal.set(Thread.currentThread().getId()); stringLocal.set(Thread.currentThread().getName()); &#125; public long getLong() &#123; return longLocal.get(); &#125; public String getString() &#123; return stringLocal.get(); &#125; public static void main(String[] args) throws InterruptedException &#123; final ThreadTest test = new ThreadTest(); //test.set(); System.out.println("main.getLong: " + test.getLong()); System.out.println("main.getString: " + test.getString()); Thread thread1 = new Thread() &#123; public void run() &#123; //test.set(); System.out.println("Thread.getLong: " + test.getLong()); System.out.println("Thread.getString: " + test.getString()); &#125; &#125;; thread1.start(); thread1.join(); &#125;&#125; ä»¥ä¸Šdemoè¦†å†™äº†initialValue()æ–¹æ³•ï¼Œæˆ–è€…è°ƒç”¨setæ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚åœ¨mainçº¿ç¨‹ä¸­å’Œthread1çº¿ç¨‹ä¸­ï¼ŒlongLocalä¿å­˜çš„å‰¯æœ¬å€¼å’ŒstringLocalä¿å­˜çš„å‰¯æœ¬å€¼éƒ½ä¸ä¸€æ ·ã€‚ 2. ThreadLocalMapThreadLocalMapçš„Entryç»§æ‰¿äº†WeakReferenceï¼Œå¹¶ä¸”ä½¿ç”¨ThreadLocalä½œä¸ºé”®å€¼ã€‚ 1. å®žé™…çš„é€šè¿‡ThreadLocalåˆ›å»ºçš„å‰¯æœ¬æ˜¯å­˜å‚¨åœ¨æ¯ä¸ªçº¿ç¨‹è‡ªå·±çš„threadLocalsä¸­çš„ï¼› 2. ä¸ºä½•threadLocalsçš„ç±»åž‹ThreadLocalMapçš„é”®å€¼ä¸ºThreadLocalå¯¹è±¡ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹ä¸­å¯æœ‰å¤šä¸ªthreadLocalå˜é‡ï¼Œå°±åƒä¸Šé¢ä»£ç ä¸­çš„longLocalå’ŒstringLocalï¼› 3. åœ¨è¿›è¡Œgetä¹‹å‰ï¼Œå¿…é¡»å…ˆsetï¼Œå¦åˆ™ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼› 2.1 æ–¹æ³•åˆ†æž1). JDK8çš„ThreadLocalçš„getæ–¹æ³•çš„æºç  123456789101112131415161718192021/** * Returns the value in the current thread's copy of this * thread-local variable. If the variable has no value for the * current thread, it is first initialized to the value returned * by an invocation of the &#123;@link #initialValue&#125; method. * * @return the current thread's value of this thread-local */public T get() &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) &#123; ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; @SuppressWarnings("unchecked") T result = (T)e.value; return result; &#125; &#125; return setInitialValue();&#125; 2). getMap 12345678910/** * Get the map associated with a ThreadLocal. Overridden in * InheritableThreadLocal. * * @param t the current thread * @return the map */ThreadLocalMap getMap(Thread t) &#123; return t.threadLocals;&#125; 3). setInitialValue 12345678910111213141516/** * Variant of set() to establish initialValue. Used instead * of set() in case user has overridden the set() method. * * @return the initial value */private T setInitialValue() &#123; T value = initialValue(); Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value); return value;&#125; getæ–¹æ³•çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š 1.é¦–å…ˆèŽ·å–å½“å‰çº¿ç¨‹ 2.æ ¹æ®å½“å‰çº¿ç¨‹èŽ·å–ä¸€ä¸ªMap 3.å¦‚æžœèŽ·å–çš„Mapä¸ä¸ºç©ºï¼Œåˆ™åœ¨Mapä¸­ä»¥ThreadLocalçš„å¼•ç”¨ä½œä¸ºkeyæ¥åœ¨Mapä¸­èŽ·å–å¯¹åº”çš„value eï¼Œå¦åˆ™è½¬åˆ°5 4.å¦‚æžœeä¸ä¸ºnullï¼Œåˆ™è¿”å›že.valueï¼Œå¦åˆ™è½¬åˆ°5 5.Mapä¸ºç©ºæˆ–è€…eä¸ºç©ºï¼Œåˆ™é€šè¿‡initialValueå‡½æ•°èŽ·å–åˆå§‹å€¼valueï¼Œç„¶åŽç”¨ThreadLocalçš„å¼•ç”¨å’Œvalueä½œä¸ºfirstKeyå’ŒfirstValueåˆ›å»ºä¸€ä¸ªæ–°çš„Map æ¯ä¸ªThreadç»´æŠ¤ä¸€ä¸ªThreadLocalMapæ˜ å°„è¡¨ï¼Œè¿™ä¸ªæ˜ å°„è¡¨çš„keyæ˜¯ThreadLocalå®žä¾‹æœ¬èº«ï¼Œvalueæ˜¯çœŸæ­£éœ€è¦å­˜å‚¨çš„Objectã€‚ 3. WeakReferenceå…³äºŽå†…å­˜æ³„éœ²ï¼š ThreadLocalMapä½¿ç”¨ThreadLocalçš„å¼±å¼•ç”¨ä½œä¸ºkeyï¼Œå¦‚æžœä¸€ä¸ªThreadLocalæ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨å¼•ç”¨ä»–ï¼Œé‚£ä¹ˆç³»ç»Ÿgcçš„æ—¶å€™ï¼Œè¿™ä¸ªThreadLocalåŠ¿å¿…ä¼šè¢«å›žæ”¶ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMapä¸­å°±ä¼šå‡ºçŽ°keyä¸ºnullçš„Entryï¼Œå°±æ²¡æœ‰åŠžæ³•è®¿é—®è¿™äº›keyä¸ºnullçš„Entryçš„valueï¼Œå¦‚æžœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº›keyä¸ºnullçš„Entryçš„valueå°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼šThreadLocal Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; value ä¸»è¦çœ‹ä¸‹getEntryAfterMisså‡½æ•°ï¼š 12345678910111213141516private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) &#123; Entry[] tab = table; int len = tab.length; while (e != null) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == key) return e; if (k == null) expungeStaleEntry(i); else i = nextIndex(i, len); e = tab[i]; &#125; return null; &#125; ThreadLocalMapçš„getEntryå‡½æ•°çš„æµç¨‹ï¼š é¦–å…ˆä»ŽThreadLocalçš„ç›´æŽ¥ç´¢å¼•ä½ç½®(é€šè¿‡ThreadLocal.threadLocalHashCode &amp; (len-1)è¿ç®—å¾—åˆ°)èŽ·å–Entry eï¼Œå¦‚æžœeä¸ä¸ºnullå¹¶ä¸”keyç›¸åŒåˆ™è¿”å›žeï¼› å¦‚æžœeä¸ºnullæˆ–è€…keyä¸ä¸€è‡´åˆ™å‘ä¸‹ä¸€ä¸ªä½ç½®æŸ¥è¯¢ï¼Œå¦‚æžœä¸‹ä¸€ä¸ªä½ç½®çš„keyå’Œå½“å‰éœ€è¦æŸ¥è¯¢çš„keyç›¸ç­‰ï¼Œåˆ™è¿”å›žå¯¹åº”çš„Entryï¼Œå¦åˆ™ï¼Œå¦‚æžœkeyå€¼ä¸ºnullï¼Œåˆ™æ“¦é™¤è¯¥ä½ç½®çš„Entryï¼Œå¦åˆ™ç»§ç»­å‘ä¸‹ä¸€ä¸ªä½ç½®æŸ¥è¯¢ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é‡åˆ°çš„keyä¸ºnullçš„Entryéƒ½ä¼šè¢«æ“¦é™¤ï¼Œé‚£ä¹ˆEntryå†…çš„valueä¹Ÿå°±æ²¡æœ‰å¼ºå¼•ç”¨é“¾ï¼Œè‡ªç„¶ä¼šè¢«å›žæ”¶ã€‚ä»”ç»†ç ”ç©¶ä»£ç å¯ä»¥å‘çŽ°ï¼Œsetæ“ä½œä¹Ÿæœ‰ç±»ä¼¼çš„æ€æƒ³ï¼Œå°†keyä¸ºnullçš„è¿™äº›Entryéƒ½åˆ é™¤ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚ ä½†æ˜¯å…‰è¿™æ ·è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œä¸Šé¢çš„è®¾è®¡æ€è·¯ä¾èµ–ä¸€ä¸ªå‰ææ¡ä»¶ï¼šè¦è°ƒç”¨ThreadLocalMapçš„genEntryå‡½æ•°æˆ–è€…setå‡½æ•°ã€‚è¿™å½“ç„¶æ˜¯ä¸å¯èƒ½ä»»ä½•æƒ…å†µéƒ½æˆç«‹çš„ï¼Œæ‰€ä»¥å¾ˆå¤šæƒ…å†µä¸‹éœ€è¦ä½¿ç”¨è€…æ‰‹åŠ¨è°ƒç”¨ThreadLocalçš„removeå‡½æ•°ï¼Œæ‰‹åŠ¨åˆ é™¤ä¸å†éœ€è¦çš„ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚æ‰€ä»¥JDKå»ºè®®å°†ThreadLocalå˜é‡å®šä¹‰æˆprivate staticçš„ï¼Œè¿™æ ·çš„è¯ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸå°±æ›´é•¿ï¼Œç”±äºŽä¸€ç›´å­˜åœ¨ThreadLocalçš„å¼ºå¼•ç”¨ï¼Œæ‰€ä»¥ThreadLocalä¹Ÿå°±ä¸ä¼šè¢«å›žæ”¶ï¼Œä¹Ÿå°±èƒ½ä¿è¯ä»»ä½•æ—¶å€™éƒ½èƒ½æ ¹æ®ThreadLocalçš„å¼±å¼•ç”¨è®¿é—®åˆ°Entryçš„valueå€¼ï¼Œç„¶åŽremoveå®ƒï¼Œé˜²æ­¢å†…å­˜æ³„éœ²ã€‚ å‚è€ƒï¼šThreadLocalå’Œsynchronizedçš„åŒºåˆ«Javaå¹¶å‘ç¼–ç¨‹ï¼šæ·±å…¥å‰–æžThreadLocal]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>Thread</tag>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è‡ªåˆ¶Jersey-Swaggerçš„spring-boot-starter]]></title>
    <url>%2F2017%2F09%2F02%2Fspring-boot-starter-swaggerforjersey%2F</url>
    <content type="text"><![CDATA[Spring Bootçš„è‡ªåŠ¨åŒ–é…ç½®ç‰¹æ€§æ¥å®žçŽ°å¿«é€Ÿçš„å°†swagger2å¼•å…¥spring bootåº”ç”¨æ¥ç”Ÿæˆjerseyçš„APIæ–‡æ¡£ï¼Œç®€åŒ–åŽŸç”Ÿä½¿ç”¨swagger2çš„æ•´åˆä»£ç ã€‚ æ¬¢è¿Žä½¿ç”¨å’ŒStaræ”¯æŒï¼Œå¦‚ä½¿ç”¨è¿‡ç¨‹ä¸­ç¢°åˆ°é—®é¢˜ï¼Œå¯ä»¥æå‡ºIssueï¼Œæˆ‘ä¼šå°½åŠ›å®Œå–„è¯¥Starter ç‰ˆæœ¬åŸºç¡€ Spring Bootï¼š1.5.x swagger-jersey2-jaxrsï¼š2.7.x Jersey 2 å¦‚ä½•ä½¿ç”¨åœ¨è¯¥é¡¹ç›®çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘ä»¬çš„Spring Bootå¯ä»¥è½»æ¾çš„å¼•å…¥swagger2ï¼Œä¸»éœ€è¦åšä¸‹é¢ä¸¤ä¸ªæ­¥éª¤ï¼š åœ¨pom.xmlä¸­å¼•å…¥ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;club.hacloud&lt;/groupId&gt; &lt;artifactId&gt;jersey-starter-swagger&lt;/artifactId&gt; &lt;version&gt;1.0.0.RELEASE&lt;/version&gt;&lt;/dependency&gt; åœ¨åº”ç”¨ä¸»ç±»ä¸­å¢žåŠ @EnableSwagger2Docæ³¨è§£ 123456789@EnableSwagger2Doc@SpringBootApplicationpublic class Bootstrap &#123; public static void main(String[] args) &#123; SpringApplication.run(Bootstrap.class, args); &#125;&#125; JerseyConfig ä¸­å¢žåŠ 1234@PostConstructpublic void init() &#123; this.register(ApiListingResource.class, SwaggerSerializers.class);&#125; é»˜è®¤æƒ…å†µä¸‹å°±èƒ½äº§ç”Ÿæ‰€æœ‰å½“å‰jerseyåŠ è½½çš„è¯·æ±‚æ˜ å°„æ–‡æ¡£ã€‚ å‚æ•°é…ç½®æ›´ç»†è‡´çš„é…ç½®å†…å®¹å‚è€ƒå¦‚ä¸‹ï¼š é…ç½®ç¤ºä¾‹1234567891011swagger: enabled: true title: spring-boot-starter-swagger config-id: demo-mvc version: v2 license: Apache License, Version 2.0 licenseUrl: https://www.apache.org/licenses/LICENSE-2.0.html termsOfServiceUrl: http://git.oschina.net/keets/jersey-starter-swagger contact: keets base-path: /** resource-package: cn.keets.demo é…ç½®è¯´æ˜Žé»˜è®¤é…ç½®12345678910- swagger.enabled=æ˜¯å¦å¼€å¯ // todo å®žçŽ°çº¿ä¸Šå…³é—­åŠŸèƒ½- swagger.title=æ ‡é¢˜- swagger.description=æè¿°- swagger.version=ç‰ˆæœ¬- swagger.license=è®¸å¯è¯- swagger.licenseUrl=è®¸å¯è¯URL- swagger.termsOfServiceUrl=æœåŠ¡æ¡æ¬¾URL- swagger.contact=ç»´æŠ¤äºº- swagger.resource-package=swaggeræ‰«æçš„åŸºç¡€åŒ…ï¼Œé»˜è®¤ï¼šå…¨æ‰«æ- swagger.base-path=éœ€è¦å¤„ç†çš„åŸºç¡€URLè§„åˆ™ï¼Œé»˜è®¤ï¼š/** swagger uiæœªåŒ…å«åœ¨é¡¹ç›®ä¸­ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±éƒ¨ç½²é™æ€æ–‡ä»¶ï¼Œé€šè¿‡é™æ€æ–‡ä»¶è§£æžjson å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š é¡¹ç›®gitåœ°å€ï¼šhttp://git.oschina.net/keets/jersey-starter-swaggerdemo gitåœ°å€ï¼šhttp://git.oschina.net/keets/spring-boot-samples/tree/master/demo-jersey-starter å‚è€ƒï¼šspring-boot-starter-swagger 1.3.0.RELEASEï¼šæ–°å¢žå¯¹JSR-303çš„æ”¯æŒå’Œhostçš„é…ç½®]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>starter</tag>
        <tag>spring-boot</tag>
        <tag>swagger</tag>
        <tag>jersey</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Restful Layer of SpringMVC vs Jersey]]></title>
    <url>%2F2017%2F08%2F30%2FJerseyvsspringmvc%2F</url>
    <content type="text"><![CDATA[ç¬”è€…é¡¹ç›®å®žçŽ°å‰åŽç«¯å‰¥ç¦»ï¼ŒæœåŠ¡ç«¯å¯¹å¤–æä¾›restfulæŽ¥å£ã€‚RESTé€æ¸æˆä¸ºå½±å“Webæ¡†æž¶ã€Webåè®®ä¸ŽWebåº”ç”¨è®¾è®¡çš„é‡è¦æ¦‚å¿µã€‚çŽ°åœ¨æœ‰è¶Šæ¥è¶Šå¤šçš„å…¬å¸å¸Œæœ›èƒ½ä»¥ç®€å•è€Œåˆè´´åˆWebæž¶æž„æœ¬èº«çš„æ–¹å¼å…¬å¼€Web APIï¼Œå› æ­¤RESTå˜å¾—è¶Šæ¥è¶Šé‡è¦ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡äº†ã€‚ä½¿ç”¨Ajaxè¿›è¡Œé€šä¿¡çš„å¯Œæµè§ˆå™¨ç«¯ä¹Ÿåœ¨æœè¿™ä¸ªç›®æ ‡ä¸æ–­è¿ˆè¿›ã€‚è¿™ä¸ªæž¶æž„åŽŸåˆ™æå‡äº†ä¸‡ç»´ç½‘çš„å¯ä¼¸ç¼©æ€§ï¼Œæ— è®ºä½•ç§åº”ç”¨éƒ½èƒ½ä»Žè¯¥åŽŸåˆ™ä¸­å—ç›Šæ— ç©·ã€‚SpringMVCå’ŒJerseyéƒ½å¯ä»¥ä¸ºä½ æä¾›restfulé£Žæ ¼çš„æŽ¥å£ã€‚æœ¬æ–‡å°†ä»‹ç»SpringMVCä¸­çš„RESTç‰¹æ€§å¹¶ä¸ŽJerseyè¿›è¡Œå¯¹æ¯”ã€‚ 1. RESTåŸºç¡€æ¦‚å¿µ åœ¨RESTä¸­çš„ä¸€åˆ‡éƒ½è¢«è®¤ä¸ºæ˜¯ä¸€ç§èµ„æºã€‚ æ¯ä¸ªèµ„æºç”±URIæ ‡è¯†ã€‚ ä½¿ç”¨ç»Ÿä¸€çš„æŽ¥å£ã€‚å¤„ç†èµ„æºä½¿ç”¨POSTï¼ŒGETï¼ŒPUTï¼ŒDELETEæ“ä½œç±»ä¼¼åˆ›å»ºï¼Œè¯»å–ï¼Œæ›´æ–°å’Œåˆ é™¤ï¼ˆCRUDï¼‰æ“ä½œã€‚ æ— çŠ¶æ€ã€‚æ¯ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¯·æ±‚ã€‚ä»Žå®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»åŒ…å«æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯ï¼Œä»¥ä¾¿äºŽç†è§£ã€‚ é€šä¿¡éƒ½æ˜¯é€šè¿‡å±•çŽ°ã€‚ä¾‹å¦‚XMLï¼ŒJSONã€‚ 2. Jerseyä¸ŽSpringMVCJAX-RSï¼ˆJSR 311ï¼‰æŒ‡çš„æ˜¯Java API for RESTful Web Servicesï¼ŒRoy Fieldingä¹Ÿå‚ä¸Žäº†JAX-RSçš„åˆ¶è®¢ï¼Œä»–åœ¨è‡ªå·±çš„åšå£«è®ºæ–‡ä¸­å®šä¹‰äº†RESTã€‚å¯¹äºŽé‚£äº›æƒ³è¦æž„å»ºRESTful Web Servicesçš„å¼€å‘è€…æ¥è¯´ï¼ŒJAX-RSç»™å‡ºäº†ä¸åŒäºŽJAX-WSï¼ˆJSR-224ï¼‰çš„å¦ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚ç›®å‰å…±æœ‰4ç§JAX-RSå®žçŽ°ï¼Œæ‰€æœ‰è¿™äº›å®žçŽ°éƒ½æ”¯æŒSpringï¼ŒJerseyåˆ™æ˜¯JAX-RSçš„å‚è€ƒå®žçŽ°ã€‚ æœ‰å¿…è¦æŒ‡å‡ºJAX-RSçš„ç›®æ ‡æ˜¯Web Serviceså¼€å‘ï¼ˆè¿™ä¸ŽHTML Webåº”ç”¨ä¸åŒï¼‰è€ŒSpring MVCçš„ç›®æ ‡åˆ™æ˜¯Webåº”ç”¨å¼€å‘ã€‚Spring 3ä¸ºWebåº”ç”¨ä¸ŽWeb Serviceså¢žåŠ äº†å¹¿æ³›çš„RESTæ”¯æŒï¼Œä½†æœ¬æ–‡åˆ™å…³æ³¨äºŽä¸ŽWeb Serviceså¼€å‘ç›¸å…³çš„ç‰¹æ€§ã€‚æˆ‘è§‰å¾—è¿™ç§æ–¹å¼æ›´æœ‰åŠ©äºŽåœ¨JAX-RSçš„ä¸Šä¸‹æ–‡ä¸­è®¨è®ºSpring MVCã€‚ è¦è¯´æ˜Žçš„ç¬¬äºŒç‚¹æ˜¯æˆ‘ä»¬å°†è¦è®¨è®ºçš„RESTç‰¹æ€§æ˜¯Spring Frameworkçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯çŽ°æœ‰çš„Spring MVCç¼–ç¨‹æ¨¡åž‹çš„å»¶ç»­ï¼Œå› æ­¤ï¼Œå¹¶æ²¡æœ‰æ‰€è°“çš„â€œSpring REST frameworkâ€è¿™ç§æ¦‚å¿µï¼Œæœ‰çš„åªæ˜¯Springå’ŒSpring MVCã€‚è¿™æ„å‘³ç€å¦‚æžœä½ æœ‰ä¸€ä¸ªSpringåº”ç”¨çš„è¯ï¼Œä½ æ—¢å¯ä»¥ä½¿ç”¨Spring MVCåˆ›å»ºHTML Webå±‚ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºRESTful Web Serviceså±‚ã€‚]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>REST</tag>
        <tag>Jersey</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[macä¸‹å¿«é€Ÿè¿›å…¥å½“å‰ç›®å½•iterm2]]></title>
    <url>%2F2017%2F08%2F28%2Fmac%E5%BF%AB%E6%8D%B7%E9%94%AE%2F</url>
    <content type="text"><![CDATA[winçŽ¯å¢ƒä¸‹ï¼Œæœ‰ç›´æŽ¥åœ¨æ–‡ä»¶æµè§ˆçš„åœ°å€ä¸Šï¼Œç›´æŽ¥è¾“å…¥cmdï¼Œå³å¯æ‰“å¼€cmdå‘½ä»¤æ¡†ã€‚ç¬”è€…åœ¨macOSä¸‹ï¼Œä¹Ÿæƒ³å®žçŽ°è¿™æ ·çš„åŠŸèƒ½ï¼Œç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹ï¼Œå¯ä»¥æˆåŠŸå®žè·µã€‚ 1. æ·»åŠ æœåŠ¡1git clone https://github.com/peterldowns/iterm2-finder-tools.git è¿›å…¥ iterm2-finder-toolsæ–‡ä»¶å¤¹ï¼Œè¿è¡ŒiTerm.workflowã€‚å®‰è£…æœåŠ¡æ ã€‚ 2. ä½¿ç”¨æœåŠ¡åœ¨å·¥ä½œæ–‡ä»¶å¤¹ä¸Šå³é”®ï¼Œå¼¹å‡ºçª—å£ä¸­æ‰¾åˆ°æœåŠ¡ä¸€æ ï¼Œå°†é¼ æ ‡æ”¾ç½®å…¶ä¸Šï¼Œåœ¨å¼¹å‡ºçª—å£ä¸­æ‰¾åˆ° Open iTermä¸€æ ï¼Œå•å‡»å³å¯ã€‚ 3. æ·»åŠ å¿«æ·é”®æœåŠ¡-&gt;åå¥½è®¾ç½®-&gt;å¿«æ·é”® ç¬”è€…è®¾ç½®äº†control+command+Lã€‚å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è¿›è¡Œè®¾ç½®å¿«æ·é”®ã€‚ å‚è€ƒï¼š Macåœ¨Finderä¸­å½“å‰ç›®å½•ä¸‹æ‰“å¼€iTerm2]]></content>
      <categories>
        <category>Utils</category>
      </categories>
      <tags>
        <tag>mac</tag>
        <tag>utils</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[HTTP 2å®žé™…åº”ç”¨]]></title>
    <url>%2F2017%2F08%2F27%2Fhttp2%E5%BA%94%E7%94%A8%2F</url>
    <content type="text"><![CDATA[1. èƒŒæ™¯ä»‹ç»1.1 éœ€è¦è§£å†³çš„é—®é¢˜æœ¬æ–‡æ¥æºäºŽé¡¹ç›®éœ€è¦ï¼Œé¡¹ç›®æ‰€ä½¿ç”¨å¾®æœåŠ¡æ¡†æž¶ä¸ºSpring Cloudï¼Œå¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨åŸºäºŽHTTP 1.Xåè®®ï¼Œä¸Šä¸€ç¯‡æ–‡ç«  HTTPS vs HTTP 1.1 vs HTTP 2ï¼Œä»‹ç»äº†http2 å’Œhttp1.1çš„ç›¸å…³çŸ¥è¯†ï¼Œä¹Ÿåˆ—å‡ºäº†http1.1å±€é™æ€§ï¼Œé“¾è·¯ä¸èƒ½å¤ç”¨ã€æ•°æ®ä¸åŠ å¯†ã€å¤´ä¿¡æ¯è¿‡å¤šç­‰ç­‰ã€‚ä¸ºæ­¤ï¼Œç¬”è€…åœ¨æƒ³èƒ½ä¸èƒ½å°†feign clientçš„è°ƒç”¨åŸºäºŽhttp2åè®®ï¼Œåšäº†å¦‚ä¸‹è°ƒç ”ã€‚ HTTP/2 æºè‡ª SPDY/2ã€‚SPDY ç³»åˆ—åè®®ç”±è°·æ­Œå¼€å‘ï¼ŒäºŽ 2009 å¹´å…¬å¼€ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯é™ä½Ž 50% çš„é¡µé¢åŠ è½½æ—¶é—´ã€‚å½“ä¸‹å¾ˆå¤šè‘—åçš„äº’è”ç½‘å…¬å¸ï¼Œä¾‹å¦‚ç™¾åº¦ã€æ·˜å®ã€UPYUN éƒ½åœ¨è‡ªå·±çš„ç½‘ç«™æˆ– APP ä¸­é‡‡ç”¨äº† SPDY ç³»åˆ—åè®®ï¼ˆå½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ SPDY/3.1ï¼‰ï¼Œå› ä¸ºå®ƒå¯¹æ€§èƒ½çš„æå‡æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚ä¸»æµçš„æµè§ˆå™¨ï¼ˆè°·æ­Œã€ç«ç‹ã€Operaï¼‰ä¹Ÿéƒ½æ—©å·²ç»æ”¯æŒ SPDYï¼Œå®ƒå·²ç»æˆä¸ºäº†å·¥ä¸šæ ‡å‡†ï¼ŒHTTP Working-Group æœ€ç»ˆå†³å®šä»¥ SPDY/2 ä¸ºåŸºç¡€ï¼Œå¼€å‘ HTTP/2ã€‚2013å¹´8æœˆï¼Œè¿›è¡Œé¦–æ¬¡æµ‹è¯•ï¼Œè¯žç”Ÿçš„æ—¶é—´å¾ˆæ™šï¼Œç¬”è€…æœç´¢äº†ç½‘ä¸Šå…³äºŽhttp2å®žè·µçš„ç›¸å…³ä¿¡æ¯ï¼Œå‘çŽ°å¹¶ä¸å¤šã€‚ 1.2 å…³äºŽé¡¹ç›®ä»‹ç»Spring Cloudæ˜¯ç¬”è€…é¡¹ç›®é‡‡ç”¨çš„å¾®æœåŠ¡æ¡†æž¶ï¼Œå…·ä½“ä»‹ç»è§Spring Cloudã€‚Spring Cloudæ˜¯åŸºäºŽSpring Bootå¼€å‘çš„ç»„åˆæ¡†æž¶ï¼ŒSpring Bootå†…ç½®çš„å®¹å™¨æ˜¯Tomcatï¼Œç¬”è€…çš„é¡¹ç›®ä¸€èˆ¬éƒ½ä¼šexclude Tomcatçš„å¼•ç”¨ï¼Œä½¿ç”¨çš„æ˜¯Jettyå®¹å™¨ã€‚æ‰€ä»¥æœç´¢çš„ä¸»é¢˜è¯å°±å˜æˆäº† jetty http2ã€‚ 2. è°ƒç ”ç»“æžœå¤§éƒ¨åˆ†çš„äººä¹ æƒ¯äºŽå°†Tomcatè¿è¡Œåœ¨8080ç«¯å£ï¼Œå†ç”¨Apache serveråœ¨å‰é¢æä¾›httpsã€‚è¿™æ ·åšæ˜¯å› ä¸ºç®€å•ä¸”éªŒè¯è¿‡çš„æ–¹æ³•ã€‚ä½¿ç”¨http2 ï¼Œä½ å°†è¢«è¿«ä½¿ç”¨httpsï¼Œè¿™æ ·å°±ä¸ç”¨éƒ¨ç½²Apache (or nginx)ã€‚ 2.1 æœåŠ¡ç«¯ Currently Jetty and undertow are the only servers in Spring Boot that support HTTP/2.Jetty has booked some progress and this repository shows an excellent example. In my opinion itâ€™s still too much custom code, but theyâ€™re getting there.The next candidate is undertow. It seems almost too easy, but it works. Because we use AJP in our current configuration it even means this HTTP/2 solution has less lines of code! å½“å‰Spring Bootåªæœ‰Jetty å’Œ undertowæ”¯æŒHTTP/2ã€‚ æ ·ä¾‹repoæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„exampleã€‚æ€»å¾—åˆ†ä¸ºä¸‰æ­¥ï¼š update dependencies org.springframework.boot:spring-boot-starter-undertow org.mortbay.jetty.alpn:alpn-boot:8.1.8.v20160420 create a servlet container bean 1234567@Bean UndertowEmbeddedServletContainerFactory embeddedServletContainerFactory() &#123; UndertowEmbeddedServletContainerFactory factory = new UndertowEmbeddedServletContainerFactory(); factory.addBuilderCustomizers( builder -&gt; builder.setServerOption(UndertowOptions.ENABLE_HTTP2, true)); return factory; &#125; start your server with alpnä¸ºäº†å¯åŠ¨æœåŠ¡ï¼Œéœ€è¦å¸¦ä¸Š -Xbootclasspath å‚æ•°æ¥åŒ…æ‹¬alpn ã€‚å› ä¸ºalpn æœ‰å¯èƒ½åœ¨jdkä¸­æ²¡æœ‰ã€‚ 1-Xbootclasspath/p:/home/harrie/.m2/repository/org/mortbay/jetty/alpn/alpn-boot/8.1.8.v20160420/alpn-boot-8.1.8.v20160420.jar 2.2 å®¢æˆ·ç«¯ Currently Java HTTP/2 clients are scarce. According to this wiki Netty and OkHttp are the only two implementations supported by Spring. To switch HTTP-client in RestTemplate you have to call the constructor with a different ClientHttpRequestFactory (either Netty4ClientHttpRequestFactory or OkHttpClientHttpRequestFactory). å½“å‰Javaçš„http2çš„å®¢æˆ·ç«¯ä¹Ÿå¾ˆå°‘ï¼ŒSpringåªæœ‰Netty and OkHttpæ”¯æŒã€‚è¿™è¾¹æˆ‘ä»¬é€‰ç”¨äº†OkHttpï¼Œå› ä¸ºOkHttpæœ¬æ¥å°±æœ‰åœ¨feign clientä¸­å†…ç½®ã€‚ 1234567891011121314151617&lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-web&lt;/artifactId&gt; &lt;version&gt;4.3.0.RC1&lt;/version&gt;&lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-core&lt;/artifactId&gt; &lt;version&gt;4.3.0.RC1&lt;/version&gt;&lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt; &lt;artifactId&gt;okhttp&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt;&lt;/dependency&gt; 2.3 æµè§ˆå™¨å¯¹äºŽHTTP/2çš„æ”¯æŒé€šè¿‡æµè§ˆå™¨æ”¯æŒhttp2æŸ¥çœ‹ã€‚ 2.4 okhttpç›®å‰, Http/1.1åœ¨å…¨ä¸–ç•Œå¤§èŒƒå›´çš„ä½¿ç”¨ä¸­, ç›´æŽ¥åºŸå¼ƒè·³åˆ°http/2è‚¯å®šä¸çŽ°å®ž. ä¸æ˜¯æ¯ä¸ªç”¨æˆ·çš„æµè§ˆå™¨éƒ½æ”¯æŒhttp/2çš„, ä¹Ÿä¸æ˜¯æ¯ä¸ªæœåŠ¡å™¨éƒ½æ‰“ç®—æ”¯æŒhttp/2çš„, å¦‚æžœæˆ‘ä»¬ç›´æŽ¥å‘é€http/2æ ¼å¼çš„åè®®, æœåŠ¡å™¨åˆä¸æ”¯æŒ, é‚£ä¸æ˜¯æŒ‚æŽ‰äº†! æ€»ä¸èƒ½ç»´æŠ¤ä¸€ä¸ªå…¨ä¸–ç•Œçš„ç½‘ç«™åˆ—è¡¨, è¡¨ç¤ºå“ªäº›æ”¯æŒhttp/2, å“ªäº›ä¸æ”¯æŒ?ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, ä»Žç¨é«˜å±‚æ¬¡ä¸Šæ¥è¯´, å°±æ˜¯ä¸ºäº†æ›´æ–¹ä¾¿åœ°éƒ¨ç½²æ–°åè®®, HTTP/1.1 å¼•å…¥äº† Upgrade æœºåˆ¶. è¿™ä¸ªæœºåˆ¶åœ¨ RFC7230 çš„ã€Œ6.7 Upgradeã€è¿™ä¸€èŠ‚ä¸­æœ‰è¯¦ç»†æè¿°.ç®€å•è¯´æ¥, å°±æ˜¯å…ˆé—®ä¸‹ä½ æ”¯æŒhttp/2ä¹ˆ? å¦‚æžœä½ æ”¯æŒ, é‚£ä¹ˆæŽ¥ä¸‹æ¥æˆ‘å°±ç”¨http/2å’Œä½ èŠå¤©. å¦‚æžœä½ ä¸æ”¯æŒ, é‚£ä¹ˆæˆ‘è¿˜æ˜¯ç”¨åŽŸæ¥çš„http/1.1å’Œä½ èŠå¤©. å®¢æˆ·ç«¯åœ¨è¯·æ±‚å¤´éƒ¨ä¸­æŒ‡å®šConnectionå’ŒUpgradeä¸¤ä¸ªå­—æ®µå‘èµ· HTTP/1.1 åè®®å‡çº§. HTTP/2 çš„åè®®åç§°æ˜¯ h2c, ä»£è¡¨ HTTP/2 ClearText. å¦‚æžœæœåŠ¡ç«¯ä¸åŒæ„å‡çº§æˆ–è€…ä¸æ”¯æŒ Upgrade æ‰€åˆ—å‡ºçš„åè®®ï¼Œç›´æŽ¥å¿½ç•¥å³å¯ï¼ˆå½“æˆ HTTP/1.1 è¯·æ±‚ï¼Œä»¥ HTTP/1.1 å“åº”ï¼‰. å¦‚æžœæœåŠ¡ç«¯åŒæ„å‡çº§ï¼Œé‚£ä¹ˆéœ€è¦è¿™æ ·å“åº” HTTP/1.1 101 Switching ProtocolsConnection: UpgradeUpgrade: h2c[ HTTP/2 connection â€¦ ] HTTP Upgrade å“åº”çš„çŠ¶æ€ç æ˜¯ 101ï¼Œå¹¶ä¸”å“åº”æ­£æ–‡å¯ä»¥ä½¿ç”¨æ–°åè®®å®šä¹‰çš„æ•°æ®æ ¼å¼ã€‚ è¿™æ ·å°±å¯ä»¥å®Œæˆä»Žhttp/1.1å‡çº§åˆ°http/2äº†. åŒæ ·ä¹Ÿå¯ä»¥ä»Žhttp/1.1å‡çº§åˆ°WebSocket.OkHttpä½¿ç”¨äº†è¯·æ±‚åè®®çš„åå•†å‡çº§, æ— è®ºæ˜¯1.1è¿˜æ˜¯2, éƒ½å…ˆåªä»¥1.1æ¥å‘é€, å¹¶åœ¨å‘é€çš„ä¿¡æ¯å¤´é‡ŒåŒ…å«åè®®å‡çº§å­—æ®µ. æŽ¥ä¸‹æ¥å°±çœ‹æœåŠ¡å™¨æ˜¯å¦æ”¯æŒåè®®å‡çº§äº†. OkHttpä½¿ç”¨çš„åè®®å‡çº§å­—æ®µæ˜¯ALPN, å¦‚æžœæœ‰å…´è¶£, å¯ä»¥æ›´æ·±å…¥çš„æŸ¥é˜…ç›¸å…³èµ„æ–™. 3. æ€»ç»“æ€»ä½“çœ‹æ¥ï¼ŒçŽ°åœ¨Spring boot æ˜¯å¯ä»¥æ”¯æŒHTTP/2 serverå’Œclientã€‚çŽ°æœ‰é¡¹ç›®çš„apiæŽ¥å£é¢å‘ç§»åŠ¨ç«¯å’Œwebç«¯ï¼Œwebæµè§ˆå™¨å¯¹äºŽhttp2çš„æ”¯æŒåœ¨ä¸Šæ–‡å·²ç»è¯´æ˜Žã€‚ å‚è€ƒèµ„æ–™ï¼šOkHttpä½¿ç”¨å®Œå…¨æ•™ç¨‹Spring Boot with HTTP/2 â€“ Start a server and make REST calls as a clientHTTPS ä¸Ž HTTP2 åè®®åˆ†æž]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>HTTP2</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[HTTPS vs HTTP 1.1 vs HTTP 2]]></title>
    <url>%2F2017%2F08%2F26%2FHTTP2%2F</url>
    <content type="text"><![CDATA[1. HTTPSåè®®åŽŸç†åˆ†æž1.1 éœ€è¦è§£å†³çš„é—®é¢˜ èº«ä»½éªŒè¯:ç¡®ä¿é€šä¿¡åŒæ–¹èº«ä»½çš„çœŸå®žæ€§ã€‚ é€šä¿¡åŠ å¯†:é€šä¿¡çš„æœºå¯†æ€§ã€å®Œæ•´æ€§ä¾èµ–äºŽç®—æ³•ä¸Žå¯†é’¥ï¼Œé€šä¿¡åŒæ–¹æ˜¯å¦‚ä½•é€‰æ‹©ç®—æ³•ä¸Žå¯†é’¥çš„ã€‚ 1.2ç›¸å…³æ¦‚å¿µ æ•°å­—è¯ä¹¦ CAï¼ˆcertification authorityï¼‰:æ•°å­—è¯ä¹¦çš„ç­¾å‘æœºæž„ã€‚ HTTPSåè®®ã€SSLåè®®ã€TLSåè®®ã€æ¡æ‰‹åè®®çš„å…³ç³» HTTPSæ˜¯Hypertext Transfer Protocol over Secure Socket Layerçš„ç¼©å†™ï¼Œå³HTTP over SSLï¼Œå¯ç†è§£ä¸ºåŸºäºŽSSLçš„HTTPåè®®ã€‚ HTTPSåè®®å®‰å…¨æ˜¯ç”±SSLåè®®ï¼ˆç›®å‰å¸¸ç”¨çš„ï¼Œæœ¬æ–‡åŸºäºŽTLS 1.2è¿›è¡Œåˆ†æžï¼‰å®žçŽ°çš„ã€‚ SSLåè®®æ˜¯ä¸€ç§è®°å½•åè®®ï¼Œæ‰©å±•æ€§è‰¯å¥½ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ·»åŠ å­åè®®ï¼Œè€Œæ¡æ‰‹åè®®ä¾¿æ˜¯SSLåè®®çš„ä¸€ä¸ªå­åè®®ã€‚ TLSåè®®æ˜¯SSLåè®®çš„åŽç»­ç‰ˆæœ¬ï¼Œæœ¬æ–‡ä¸­æ¶‰åŠçš„SSLåè®®é»˜è®¤æ˜¯TLSåè®®1.2ç‰ˆæœ¬ã€‚ HTTPSåè®®çš„å®‰å…¨æ€§ç”±SSLåè®®å®žçŽ°ï¼Œå½“å‰ä½¿ç”¨çš„TLSåè®®1.2ç‰ˆæœ¬åŒ…å«äº†å››ä¸ªæ ¸å¿ƒå­åè®®ï¼šæ¡æ‰‹åè®®ã€å¯†é’¥é…ç½®åˆ‡æ¢åè®®ã€åº”ç”¨æ•°æ®åè®®åŠæŠ¥è­¦åè®®ã€‚ 1.3 æ¡æ‰‹åè®®æ¡æ‰‹åè®®çš„ä½œç”¨ä¾¿æ˜¯é€šä¿¡åŒæ–¹è¿›è¡Œèº«ä»½ç¡®è®¤ã€åå•†å®‰å…¨è¿žæŽ¥å„å‚æ•°ï¼ˆåŠ å¯†ç®—æ³•ã€å¯†é’¥ç­‰ï¼‰ï¼Œç¡®ä¿åŒæ–¹èº«ä»½çœŸå®žå¹¶ä¸”åå•†çš„ç®—æ³•ä¸Žå¯†é’¥èƒ½å¤Ÿä¿è¯é€šä¿¡å®‰å…¨ã€‚åè®®äº¤äº’å›¾ï¼š ClientHelloæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†å®¢æˆ·ç«¯å¯ç”¨äºŽå»ºç«‹åŠ å¯†é€šé“çš„å‚æ•°é›†åˆï¼Œä¸€æ¬¡æ€§å‘é€ç»™æœåŠ¡ç«¯ã€‚ ServerHelloæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œåœ¨ClientHelloå‚æ•°é›†åˆä¸­é€‰æ‹©é€‚åˆçš„å‚æ•°ï¼Œå¹¶å°†æœåŠ¡ç«¯ç”¨äºŽå»ºç«‹åŠ å¯†é€šé“çš„å‚æ•°å‘é€ç»™å®¢æˆ·ç«¯ã€‚ Certificateæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†æœåŠ¡ç«¯è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯ï¼Œä¾›å®¢æˆ·ç«¯è¿›è¡ŒæœåŠ¡ç«¯èº«ä»½æ ¡éªŒã€‚ ServerKeyExchangeæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†éœ€è¦æœåŠ¡ç«¯æä¾›çš„å¯†é’¥äº¤æ¢çš„é¢å¤–å‚æ•°ï¼Œä¼ ç»™å®¢æˆ·ç«¯ã€‚æœ‰çš„ç®—æ³•ä¸éœ€è¦é¢å¤–å‚æ•°ï¼Œåˆ™ServerKeyExchangeæ¶ˆæ¯å¯ä¸å‘é€ã€‚ ServerHelloDoneæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œé€šçŸ¥å®¢æˆ·ç«¯ServerHelloé˜¶æ®µçš„æ•°æ®å‡å·²å‘é€å®Œæ¯•ï¼Œç­‰å¾…å®¢æˆ·ç«¯ä¸‹ä¸€æ­¥æ¶ˆæ¯ã€‚ ClientKeyExchangeæ¶ˆæ¯çš„ä½œç”¨æ˜¯ï¼Œå°†å®¢æˆ·ç«¯éœ€è¦ä¸ºå¯†é’¥äº¤æ¢æä¾›çš„æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ã€‚ ChangeCipherSpecæ¶ˆæ¯çš„ä½œç”¨ï¼Œä¾¿æ˜¯å£°æ˜ŽåŽç»­æ¶ˆæ¯å‡é‡‡ç”¨å¯†é’¥åŠ å¯†ã€‚åœ¨æ­¤æ¶ˆæ¯åŽï¼Œæˆ‘ä»¬åœ¨WireSharkä¸Šä¾¿çœ‹ä¸åˆ°æ˜Žæ–‡ä¿¡æ¯äº†ã€‚ Finishedæ¶ˆæ¯çš„ä½œç”¨ï¼Œæ˜¯å¯¹æ¡æ‰‹é˜¶æ®µæ‰€æœ‰æ¶ˆæ¯è®¡ç®—æ‘˜è¦ï¼Œå¹¶å‘é€ç»™å¯¹æ–¹æ ¡éªŒï¼Œé¿å…é€šä¿¡è¿‡ç¨‹ä¸­è¢«ä¸­é—´äººæ‰€ç¯¡æ”¹ã€‚ 1.4 æ€»ç»“HTTPSå¦‚ä½•ä¿è¯é€šä¿¡å®‰å…¨ï¼Œé€šè¿‡æ¡æ‰‹åè®®çš„ä»‹ç»ï¼Œæˆ‘ä»¬å·²ç»æœ‰æ‰€äº†è§£ã€‚ä½†æ˜¯ï¼Œåœ¨å…¨é¢ä½¿ç”¨HTTPSå‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ä¸€ä¸ªä¼—æ‰€å‘¨çŸ¥çš„é—®é¢˜â€”â€”HTTPSæ€§èƒ½ã€‚ç›¸å¯¹HTTPåè®®æ¥è¯´ï¼ŒHTTPSåè®®å»ºç«‹æ•°æ®é€šé“çš„æ›´åŠ è€—æ—¶ï¼Œè‹¥ç›´æŽ¥éƒ¨ç½²åˆ°Appä¸­ï¼ŒåŠ¿å¿…é™ä½Žæ•°æ®ä¼ é€’çš„æ•ˆçŽ‡ï¼Œé—´æŽ¥å½±å“ç”¨æˆ·ä½“éªŒã€‚ 2. HTTP 22.1 HTTP1.xåè®®éšç€äº’è”ç½‘çš„å¿«é€Ÿå‘å±•ï¼ŒHTTP1.xåè®®å¾—åˆ°äº†è¿…çŒ›å‘å±•ï¼Œä½†å½“Appä¸€ä¸ªé¡µé¢åŒ…å«äº†æ•°åä¸ªè¯·æ±‚æ—¶ï¼ŒHTTP1.xåè®®çš„å±€é™æ€§ä¾¿æš´éœ²äº†å‡ºæ¥ï¼š æ¯ä¸ªè¯·æ±‚ä¸Žå“åº”éœ€è¦å•ç‹¬å»ºç«‹é“¾è·¯è¿›è¡Œè¯·æ±‚(Connectionå­—æ®µèƒ½å¤Ÿè§£å†³éƒ¨åˆ†é—®é¢˜)ï¼Œæµªè´¹èµ„æºã€‚ æ¯ä¸ªè¯·æ±‚ä¸Žå“åº”éƒ½éœ€è¦æ·»åŠ å®Œæ•´çš„å¤´ä¿¡æ¯ï¼Œåº”ç”¨æ•°æ®ä¼ è¾“æ•ˆçŽ‡è¾ƒä½Žã€‚ é»˜è®¤æ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼Œæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å®¹æ˜“è¢«ç›‘å¬ä¸Žç¯¡æ”¹ã€‚ 2.2 HTTP 2ä»‹ç»HTTP2æ­£æ˜¯ä¸ºäº†è§£å†³HTTP1.xæš´éœ²å‡ºæ¥çš„é—®é¢˜è€Œè¯žç”Ÿçš„ã€‚ è¯´åˆ°HTTP2ä¸å¾—ä¸æspdyã€‚ç”±äºŽHTTP1.xæš´éœ²å‡ºæ¥çš„é—®é¢˜ï¼ŒGoogleè®¾è®¡äº†å…¨æ–°çš„åä¸ºspdyçš„æ–°åè®®ã€‚spdyåœ¨äº”å±‚åè®®æ ˆçš„TCPå±‚ä¸ŽHTTPå±‚å¼•å…¥äº†ä¸€ä¸ªæ–°çš„é€»è¾‘å±‚ä»¥æé«˜æ•ˆçŽ‡ã€‚spdyæ˜¯ä¸€ä¸ªä¸­é—´å±‚ï¼Œå¯¹TCPå±‚ä¸ŽHTTPå±‚æœ‰å¾ˆå¥½çš„å…¼å®¹ï¼Œä¸éœ€è¦ä¿®æ”¹HTTPå±‚å³å¯æ”¹å–„åº”ç”¨æ•°æ®ä¼ è¾“é€Ÿåº¦ã€‚spdyé€šè¿‡å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œä½¿å®¢æˆ·ç«¯ä¸ŽæœåŠ¡å™¨åªéœ€è¦ä¿æŒä¸€æ¡é“¾æŽ¥å³å¯å¹¶å‘å¤šæ¬¡æ•°æ®äº¤äº’ï¼Œæé«˜äº†é€šä¿¡æ•ˆçŽ‡ã€‚è€ŒHTTP2ä¾¿å£«åŸºäºŽspdyçš„æ€è·¯å¼€å‘çš„ã€‚é€šè¿‡æµä¸Žå¸§æ¦‚å¿µçš„å¼•å…¥ï¼Œç»§æ‰¿äº†spdyçš„å¤šè·¯å¤ç”¨ï¼Œå¹¶å¢žåŠ äº†ä¸€äº›å®žç”¨ç‰¹æ€§ã€‚ æ–°ç‰¹æ€§ï¼š å¤šè·¯å¤ç”¨ åŽ‹ç¼©å¤´ä¿¡æ¯ å¯¹è¯·æ±‚åˆ’åˆ†ä¼˜å…ˆçº§ æ”¯æŒæœåŠ¡ç«¯Pushæ¶ˆæ¯åˆ°å®¢æˆ·ç«¯ HTTP2ç›®å‰åœ¨å®žé™…ä½¿ç”¨ä¸­ï¼Œåªç”¨äºŽHTTPSåè®®åœºæ™¯ä¸‹ï¼Œé€šè¿‡æ¡æ‰‹é˜¶æ®µClientHelloä¸ŽServerHelloçš„extensionå­—æ®µåå•†è€Œæ¥ï¼Œæ‰€ä»¥ç›®å‰HTTP2çš„ä½¿ç”¨åœºæ™¯ï¼Œéƒ½æ˜¯é»˜è®¤å®‰å…¨åŠ å¯†çš„ã€‚ æŸ¥çœ‹äº†wikiå‘çŽ°ï¼š Netty and OkHttp are the only two implementations supported by Spring. 2.3 åè®®åå•†HTTP2åè®®çš„åå•†æ˜¯åœ¨æ¡æ‰‹é˜¶æ®µè¿›è¡Œçš„ã€‚ åå•†çš„æ–¹å¼æ˜¯é€šè¿‡æ¡æ‰‹åè®®extensionæ‰©å±•å­—æ®µè¿›è¡Œæ‰©å±•ï¼Œæ–°å¢žApplication Layer Protocol Negotiationå­—æ®µè¿›è¡Œåå•†ã€‚ åœ¨æ¡æ‰‹åè®®çš„ClientHelloé˜¶æ®µï¼Œå®¢æˆ·ç«¯å°†æ‰€æ”¯æŒçš„åè®®åˆ—è¡¨å¡«å…¥Application Layer Protocol Negotiationå­—æ®µï¼Œä¾›æœåŠ¡ç«¯è¿›è¡ŒæŒ‘é€‰ã€‚ 2.4 å¤šè·¯å¤ç”¨Multipexingåœ¨HTTP2ä¸­ï¼ŒåŒä¸€åŸŸåä¸‹çš„è¯·æ±‚ï¼Œå¯é€šè¿‡åŒä¸€æ¡TCPé“¾è·¯è¿›è¡Œä¼ è¾“ï¼Œä½¿å¤šä¸ªè¯·æ±‚ä¸å¿…å•ç‹¬å»ºç«‹é“¾è·¯ï¼ŒèŠ‚çœå»ºç«‹é“¾è·¯çš„å¼€é”€ã€‚ ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼ŒHTTP2æå‡ºäº†æµä¸Žå¸§çš„æ¦‚å¿µï¼Œæµä»£è¡¨è¯·æ±‚ä¸Žå“åº”ï¼Œè€Œè¯·æ±‚ä¸Žå“åº”å…·ä½“çš„æ•°æ®åˆ™åŒ…è£…ä¸ºå¸§ï¼Œå¯¹é“¾è·¯ä¸­ä¼ è¾“çš„æ•°æ®é€šè¿‡æµIDä¸Žå¸§ç±»åž‹è¿›è¡ŒåŒºåˆ†å¤„ç†ã€‚ä¸‹å›¾æ˜¯å¤šè·¯å¤ç”¨çš„æŠ½è±¡å›¾ï¼Œæ¯ä¸ªå—ä»£è¡¨ä¸€å¸§ï¼Œè€Œç›¸åŒé¢œè‰²çš„å—åˆ™ä»£è¡¨æ˜¯åŒä¸€ä¸ªæµã€‚ å½’çº³ä¸‹okhttpçš„å¤šè·¯å¤ç”¨å®žçŽ°æ€è·¯ï¼š é€šè¿‡è¯·æ±‚çš„Addressä¸Žè¿žæŽ¥æ± ä¸­çŽ°æœ‰è¿žæŽ¥Addressä¾æ¬¡åŒ¹é…ï¼Œé€‰å‡ºå¯ç”¨çš„Connectionã€‚ é€šè¿‡Http2xStreamåˆ›å»ºçš„FramedStreamåœ¨å‘é€äº†è¯·æ±‚åŽï¼Œå°†FramedStreamå¯¹è±¡ä¸ŽStreamIDçš„æ˜ å°„å…³ç³»ç¼“å­˜åˆ°FramedConnectionä¸­ã€‚ æ”¶åˆ°æ¶ˆæ¯åŽï¼ŒFramedConnectionè§£æžå¸§ä¿¡æ¯ï¼Œåœ¨Mapä¸­é€šè¿‡è§£æžçš„StreamIDé€‰å‡ºç¼“å­˜çš„FramedStreamï¼Œå¹¶å”¤é†’FramedStreamè¿›è¡ŒResponseçš„å¤„ç†ã€‚ 2.5 åŽ‹ç¼©å¤´ä¿¡æ¯HTTP2ä¸ºäº†è§£å†³HTTP1.xä¸­å¤´ä¿¡æ¯è¿‡å¤§å¯¼è‡´æ•ˆçŽ‡ä½Žä¸‹çš„é—®é¢˜ï¼Œæå‡ºçš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯åŽ‹ç¼©å¤´éƒ¨ä¿¡æ¯ã€‚å…·ä½“çš„åŽ‹ç¼©æ–¹å¼ï¼Œåˆ™å¼•å…¥äº†HPACKã€‚ HPACKåŽ‹ç¼©ç®—æ³•æ˜¯ä¸“é—¨ä¸ºHTTP2å¤´éƒ¨åŽ‹ç¼©æœåŠ¡çš„ã€‚ä¸ºäº†è¾¾åˆ°åŽ‹ç¼©å¤´éƒ¨ä¿¡æ¯çš„ç›®çš„ï¼ŒHPACKå°†å¤´éƒ¨å­—æ®µç¼“å­˜ä¸ºç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•IDä»£è¡¨å¤´éƒ¨å­—æ®µã€‚å®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯ç»´æŠ¤ç´¢å¼•è¡¨ï¼Œé€šä¿¡è¿‡ç¨‹ä¸­å°½å¯èƒ½é‡‡ç”¨ç´¢å¼•è¿›è¡Œé€šä¿¡ï¼Œæ”¶åˆ°ç´¢å¼•åŽæŸ¥è¯¢ç´¢å¼•è¡¨ï¼Œæ‰èƒ½è§£æžå‡ºçœŸæ­£çš„å¤´éƒ¨ä¿¡æ¯ã€‚ HPACKç´¢å¼•è¡¨åˆ’åˆ†ä¸ºåŠ¨æ€ç´¢å¼•è¡¨ä¸Žé™æ€ç´¢å¼•è¡¨ï¼ŒåŠ¨æ€ç´¢å¼•è¡¨æ˜¯HTTP2åè®®é€šä¿¡è¿‡ç¨‹ä¸­ä¸¤ç«¯åŠ¨æ€ç»´æŠ¤çš„ç´¢å¼•è¡¨ï¼Œè€Œé™æ€ç´¢å¼•è¡¨æ˜¯ç¡¬ç¼–ç è¿›åè®®ä¸­çš„ç´¢å¼•è¡¨ã€‚ ä½œä¸ºåˆ†æžHPACKåŽ‹ç¼©å¤´ä¿¡æ¯çš„åŸºç¡€ï¼Œéœ€è¦å…ˆä»‹ç»HPACKå¯¹ç´¢å¼•ä»¥åŠå¤´éƒ¨å­—ç¬¦ä¸²çš„è¡¨ç¤ºæ–¹å¼ã€‚ ç´¢å¼• ç´¢å¼•ä»¥æ•´åž‹æ•°å­—è¡¨ç¤ºï¼Œç”±äºŽHPACKéœ€è¦è€ƒè™‘åŽ‹ç¼©ä¸Žç¼–è§£ç é—®é¢˜ï¼Œæ‰€ä»¥æ•´åž‹æ•°å­—ç»“æž„å®šä¹‰ä¸‹å›¾æ‰€ç¤ºï¼š ç±»åˆ«æ ‡è¯†:é€šè¿‡ç±»åˆ«æ ‡è¯†è¿›è¡ŒHPACKç±»åˆ«åˆ†ç±»ï¼ŒæŒ‡å¯¼åŽç»­ç¼–è§£ç æ“ä½œï¼Œå¸¸è§çš„æœ‰1ï¼Œ01ï¼Œ01000000ç­‰å…«ä¸ªç±»åˆ«ã€‚ é¦–å­—èŠ‚ä½Žä½æ•´åž‹:é¦–å­—èŠ‚æŽ’é™¤ç±»åˆ«æ ‡è¯†çš„å‰©ä½™ä½ï¼Œç”¨äºŽè¡¨ç¤ºä½Žä½æ•´åž‹ã€‚è‹¥æ•°å€¼å¤§äºŽå‰©ä½™ä½æ‰€èƒ½è¡¨ç¤ºçš„å®¹é‡ï¼Œåˆ™éœ€è¦åŽç»­å­—èŠ‚è¡¨ç¤ºé«˜ä½æ•´åž‹ã€‚ ç»“æŸæ ‡è¯†:è¡¨ç¤ºæ­¤å­—èŠ‚æ˜¯å¦ä¸ºæ•´åž‹è§£æžç»ˆæ­¢å­—èŠ‚ã€‚ é«˜ä½æ•´åž‹:å­—èŠ‚ä½™ä¸‹7bitï¼Œç”¨äºŽå¡«å……æ•´åž‹é«˜ä½ã€‚]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>HTTPS</tag>
        <tag>HTTP2</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mongodb é›†ç¾¤åŸºç¡€]]></title>
    <url>%2F2017%2F08%2F10%2Fmongodb%E9%9B%86%E7%BE%A4%E5%9F%BA%E7%A1%80%2F</url>
    <content type="text"><![CDATA[1. MongoDBä»‹ç» MongoDB æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„é«˜æ€§èƒ½,å¼€æº,æ¨¡å¼è‡ªç”±,é¢å‘æ–‡æ¡£çš„æ•°æ®åº“ã€‚ å®ƒä½¿ç”¨ C++ç¼–å†™ã€‚MongoDB åŒ…å«ä¸€ä¸‹ç‰¹ç‚¹: é¢å‘é›†åˆçš„å­˜å‚¨:é€‚åˆå­˜å‚¨å¯¹è±¡åŠJSONå½¢å¼çš„æ•°æ®ã€‚ åŠ¨æ€æŸ¥è¯¢:Mongo æ”¯æŒä¸°å¯Œçš„æŸ¥è¯¢æ–¹å¼,æŸ¥è¯¢æŒ‡ä»¤ä½¿ç”¨ JSON å½¢å¼çš„æ ‡è®°,å¯è½»æ˜“æŸ¥è¯¢æ–‡æ¡£ä¸­å†…åµŒçš„å¯¹è±¡åŠæ•°ç»„ã€‚ å®Œæ•´çš„ç´¢å¼•æ”¯æŒ:åŒ…æ‹¬æ–‡æ¡£å†…åµŒå¯¹è±¡åŠæ•°ç»„ã€‚Mongo çš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šåˆ†æžæŸ¥è¯¢è¡¨è¾¾å¼,å¹¶ç”Ÿæˆä¸€ä¸ªé«˜æ•ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚ æŸ¥è¯¢ç›‘è§†:MongoåŒ…å«ä¸€ä¸ªç›‘æŽ§å·¥å…·ç”¨äºŽåˆ†æžæ•°æ®åº“æ“ä½œæ€§èƒ½ã€‚ å¤åˆ¶åŠè‡ªåŠ¨æ•…éšœè½¬ç§»:Mongo æ•°æ®åº“æ”¯æŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®å¤åˆ¶,æ”¯æŒä¸»-ä»Žæ¨¡å¼åŠæœåŠ¡å™¨ä¹‹é—´çš„ç›¸äº’å¤åˆ¶ã€‚å¤åˆ¶çš„ä¸»è¦ç›®çš„æ˜¯æä¾›å†—ä½™åŠè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚ é«˜æ•ˆçš„ä¼ ç»Ÿå­˜å‚¨æ–¹å¼:æ”¯æŒäºŒè¿›åˆ¶æ•°æ®åŠå¤§åž‹å¯¹è±¡(å¦‚:ç…§ç‰‡æˆ–å›¾ç‰‡)ã€‚ è‡ªåŠ¨åˆ†ç‰‡ä»¥æ”¯æŒäº‘çº§åˆ«çš„ä¼¸ç¼©æ€§:è‡ªåŠ¨åˆ†ç‰‡åŠŸèƒ½æ”¯æŒæ°´å¹³çš„æ•°æ®åº“é›†ç¾¤,å¯åŠ¨æ€æ·»åŠ é¢å¤–çš„æœºå™¨ã€‚ 2.Replica Seté›†ç¾¤å½“ä¸­åŒ…å«äº†å¤šä»½æ•°æ®ï¼Œä¿è¯ä¸»èŠ‚ç‚¹æŒ‚æŽ‰äº†ï¼Œå¤‡èŠ‚ç‚¹èƒ½ç»§ç»­æä¾›æ•°æ®æœåŠ¡ï¼Œæä¾›çš„å‰æå°±æ˜¯æ•°æ®éœ€è¦å’Œä¸»èŠ‚ç‚¹ä¸€è‡´ã€‚ Mongodb(M)è¡¨ç¤ºä¸»èŠ‚ç‚¹ï¼ŒMongodb(S)è¡¨ç¤ºå¤‡èŠ‚ç‚¹ï¼ŒMongodb(A)è¡¨ç¤ºä»²è£èŠ‚ç‚¹ã€‚ä¸»å¤‡èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œä»²è£èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ã€‚å®¢æˆ·ç«¯åŒæ—¶è¿žæŽ¥ä¸»èŠ‚ç‚¹ä¸Žå¤‡èŠ‚ç‚¹ï¼Œä¸è¿žæŽ¥ä»²è£èŠ‚ç‚¹ã€‚ é»˜è®¤è®¾ç½®ä¸‹ï¼Œä¸»èŠ‚ç‚¹æä¾›æ‰€æœ‰å¢žåˆ æŸ¥æ”¹æœåŠ¡ï¼Œå¤‡èŠ‚ç‚¹ä¸æä¾›ä»»ä½•æœåŠ¡ã€‚ä½†æ˜¯å¯ä»¥é€šè¿‡è®¾ç½®ä½¿å¤‡èŠ‚ç‚¹æä¾›æŸ¥è¯¢æœåŠ¡ï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ä¸»èŠ‚ç‚¹çš„åŽ‹åŠ›ï¼Œå½“å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®æŸ¥è¯¢æ—¶ï¼Œè¯·æ±‚è‡ªåŠ¨è½¬åˆ°å¤‡èŠ‚ç‚¹ä¸Šã€‚è¿™ä¸ªè®¾ç½®å«åšRead Preference Modesï¼ŒåŒæ—¶Javaå®¢æˆ·ç«¯æä¾›äº†ç®€å•çš„é…ç½®æ–¹å¼ï¼Œå¯ä»¥ä¸å¿…ç›´æŽ¥å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œã€‚ ä»²è£èŠ‚ç‚¹æ˜¯ä¸€ç§ç‰¹æ®Šçš„èŠ‚ç‚¹ï¼Œå®ƒæœ¬èº«å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œä¸»è¦çš„ä½œç”¨æ˜¯å†³å®šå“ªä¸€ä¸ªå¤‡èŠ‚ç‚¹åœ¨ä¸»èŠ‚ç‚¹æŒ‚æŽ‰ä¹‹åŽæå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä¸éœ€è¦è¿žæŽ¥æ­¤èŠ‚ç‚¹ã€‚è¿™é‡Œè™½ç„¶åªæœ‰ä¸€ä¸ªå¤‡èŠ‚ç‚¹ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦ä¸€ä¸ªä»²è£èŠ‚ç‚¹æ¥æå‡å¤‡èŠ‚ç‚¹çº§åˆ«ã€‚æˆ‘å¼€å§‹ä¹Ÿä¸ç›¸ä¿¡å¿…é¡»è¦æœ‰ä»²è£èŠ‚ç‚¹ï¼Œä½†æ˜¯è‡ªå·±ä¹Ÿè¯•è¿‡æ²¡ä»²è£èŠ‚ç‚¹çš„è¯ï¼Œä¸»èŠ‚ç‚¹æŒ‚äº†å¤‡èŠ‚ç‚¹è¿˜æ˜¯å¤‡èŠ‚ç‚¹ï¼Œæ‰€ä»¥å’±ä»¬è¿˜æ˜¯éœ€è¦å®ƒçš„ã€‚ 3.Sharding å’ŒReplica Setç±»ä¼¼ï¼Œéƒ½éœ€è¦ä¸€ä¸ªä»²è£èŠ‚ç‚¹ï¼Œä½†æ˜¯Shardingè¿˜éœ€è¦é…ç½®èŠ‚ç‚¹å’Œè·¯ç”±èŠ‚ç‚¹ã€‚ é›†ç¾¤æ­å»ºæ–¹å¼é¦–é€‰Replica Setï¼Œåªæœ‰çœŸçš„æ˜¯å¤§æ•°æ®ï¼ŒShardingæ‰èƒ½æ˜¾çŽ°å¨åŠ›ï¼Œæ¯•ç«Ÿå¤‡èŠ‚ç‚¹åŒæ­¥æ•°æ®æ˜¯éœ€è¦æ—¶é—´çš„ã€‚Shardingå¯ä»¥å°†å¤šç‰‡æ•°æ®é›†ä¸­åˆ°è·¯ç”±èŠ‚ç‚¹ä¸Šè¿›è¡Œä¸€äº›å¯¹æ¯”ï¼Œç„¶åŽå°†æ•°æ®è¿”å›žç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯æ•ˆçŽ‡è¿˜æ˜¯æ¯”è¾ƒä½Žçš„è¯´ã€‚ æˆ‘è‡ªå·±æœ‰æµ‹è¯•è¿‡ï¼Œä¸è¿‡å…·ä½“çš„æœºå™¨é…ç½®å·²ç»ä¸è®°å¾—äº†ã€‚Replica Setçš„ipsåœ¨æ•°æ®è¾¾åˆ°1400wæ¡æ—¶åŸºæœ¬èƒ½è¾¾åˆ°1000å·¦å³ï¼Œè€ŒShardingåœ¨300wæ—¶å·²ç»ä¸‹é™åˆ°500ipsäº†ï¼Œä¸¤è€…çš„å•ä½æ•°æ®å¤§å°å¤§æ¦‚æ˜¯10kbã€‚å¤§å®¶åœ¨åº”ç”¨çš„æ—¶å€™è¿˜æ˜¯å¤šå¤šåšä¸‹æ€§èƒ½æµ‹è¯•ï¼Œæ¯•ç«Ÿä¸åƒRedisæœ‰benchmarkã€‚ MongodbçŽ°åœ¨ç”¨çš„è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œä½†æ˜¯ä¸ªäººè§‰å¾—é…ç½®å¤ªå¤šäº†ã€‚æˆ‘çœ‹å®˜ç½‘éƒ½çœ‹äº†å¥½å¤šå¤©ï¼Œæ‰æŠŠé›†ç¾¤æ­å»ºçš„é…ç½®å’Œæ³¨æ„è¦ç‚¹å¼„æ˜Žç™½ã€‚è€Œä¸”ç”¨è¿‡çš„äººåº”è¯¥çŸ¥é“mongodbåƒå†…å­˜çš„é—®é¢˜ï¼Œè§£å†³åŠžæ³•åªèƒ½é€šè¿‡ulimitæ¥æŽ§åˆ¶å†…å­˜ä½¿ç”¨é‡ï¼Œä½†æ˜¯å¦‚æžœæŽ§åˆ¶ä¸å¥½çš„è¯ï¼Œmongodbä¼šæŒ‚æŽ‰ PS: åŽé¢ç»§ç»­è¡¥å……ã€‚]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
        <tag>Cluster</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Spring Cloud å…¥é—¨]]></title>
    <url>%2F2017%2F07%2F18%2Fspring-cloud%2F</url>
    <content type="text"><![CDATA[1. å¾®æœåŠ¡æž¶æž„å¾®æœåŠ¡æž¶æž„ï¼ˆMicro-Service Archetictureï¼‰æ˜¯å½“ä¸‹æµè¡Œçš„æž¶æž„é£Žæ ¼ï¼Œæ—¨åœ¨é€šè¿‡å°†åŠŸèƒ½æ¨¡å—åˆ†è§£åˆ°å„ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿä¸­ä»¥å®žçŽ°è§£è€¦ï¼Œå®ƒå¹¶æ²¡æœ‰ä¸€æˆä¸å˜çš„è§„å®šï¼Œè€Œæ˜¯éœ€è¦æ ¹æ®ä¸šåŠ¡æ¥åšè®¾è®¡[æŽè´žæ˜Š,2017]ã€‚å¾®æœåŠ¡æž¶æž„ä¸­ï¼Œæ¯ä¸ªå¾®æœåŠ¡æ¨¡å—åªæ˜¯å¯¹ç®€å•ã€ç‹¬ç«‹ã€æ˜Žç¡®çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡REST APIè¿”å›žå¤„ç†ç»“æžœç»™å¤–éƒ¨ã€‚åœ¨å¾®æœåŠ¡æŽ¨å¹¿å®žè·µè§’åº¦æ¥çœ‹ï¼Œå¾®æœåŠ¡å°†æ•´ä¸ªç³»ç»Ÿè¿›è¡Œæ‹†åˆ†ï¼Œæ‹†åˆ†æˆæ›´å°çš„ç²’åº¦ï¼Œä¿æŒè¿™äº›æœåŠ¡ç‹¬ç«‹è¿è¡Œï¼Œåº”ç”¨å®¹å™¨åŒ–æŠ€æœ¯å°†å¾®æœåŠ¡ç‹¬ç«‹è¿è¡Œåœ¨å®¹å™¨ä¸­ã€‚è¿‡åŽ»è®¾è®¡æž¶æž„æ—¶ï¼Œæ˜¯åœ¨å†…å­˜ä¸­ä»¥å‚æ•°æˆ–å¯¹è±¡çš„æ–¹å¼å®žçŽ°ç²’åº¦ç»†åŒ–ã€‚å¾®æœåŠ¡ä½¿ç”¨å„ä¸ªå­æœåŠ¡æŽ§åˆ¶æ¨¡å—çš„æ€æƒ³ä»£æ›¿æ€»çº¿ã€‚ä¸åŒçš„ä¸šåŠ¡è¦æ±‚ï¼ŒæœåŠ¡æŽ§åˆ¶æ¨¡å—è‡³å°‘åŒ…å«æœåŠ¡çš„å‘å¸ƒã€æ³¨å†Œã€è·¯ç”±ã€ä»£ç†åŠŸèƒ½ã€‚ 2. vs å•ä½“åº”ç”¨æž¶æž„å¾®æœåŠ¡æž¶æž„æ¨¡å¼ç›¸æ¯”äºŽå•ä½“åº”ç”¨æž¶æž„ï¼Œæœ‰å¾ˆå¤šä¼˜åŠ¿ã€‚ é¦–å…ˆï¼Œå·¨å¤§çš„å•ä½“å¼åº”ç”¨æ‹†åˆ†ä¸ºå¤šä¸ªå¾®æœåŠ¡ï¼Œé™ä½Žäº†å¤æ‚æ€§ã€‚åœ¨å…·æœ‰ä¹‹å‰å•ä½“åº”ç”¨åŠŸèƒ½çš„åŒæ—¶ï¼Œå•ä½“åº”ç”¨è¢«æ‹†åˆ†ä¸ºå¤šä¸ªå¯ç®¡ç†çš„å¾®æœåŠ¡ã€‚æ¯ä¸ªå¾®æœåŠ¡éƒ½å…·æœ‰å®šä¹‰æ¸…æ¥šçš„è¾¹ç•Œï¼Œä½¿ç”¨è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æˆ–è€…æ¶ˆæ¯é©±åŠ¨APIã€‚æ‹†åˆ†åŽçš„å¾®æœåŠ¡æ¨¡å—ï¼Œç²’åº¦å°ï¼Œå¾ˆå®¹æ˜“å¼€å‘å’Œç»´æŠ¤ã€‚å¾®æœåŠ¡æž¶æž„æ¨¡å¼é™ä½Žäº†å•ä½“å¼ç¼–ç çš„éš¾åº¦ï¼Œå¹¶ä¸”åŠŸèƒ½æä¾›äº†æ¨¡å—åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚ ç¬¬äºŒï¼Œå¾®æœåŠ¡æž¶æž„ä¸‹ï¼Œä¸“é—¨å¼€å‘å›¢é˜Ÿè´Ÿè´£å¼€å‘ä¸€ä¸ªå­æœåŠ¡ã€‚æ¯ä¸ªå¼€å‘å›¢é˜Ÿå¯ä»¥è‡ªä¸»é€‰æ‹©æŠ€æœ¯æ ˆï¼Œæä¾›APIæŽ¥å£ã€‚å½“ç„¶ï¼Œè®¸å¤šå…¬å¸å°†æŠ€æœ¯æ ˆç»Ÿä¸€ï¼Œåªæä¾›ç‰¹å®šé€‰æ‹©çš„æŠ€æœ¯ã€‚ç„¶åŽï¼Œè¿™ç§è‡ªç”±ä½¿å¾—å¼€å‘å›¢é˜Ÿä¸éœ€è¦è¢«è¿«ä½¿ç”¨ç‰¹å®šçš„é‚£äº›æŠ€æœ¯ï¼Œä»–ä»¬å¯ä»¥è‡ªç”±åœ°é€‰æ‹©é€‚åˆè¯¥å¾®æœåŠ¡çš„æŠ€æœ¯ã€‚ç”šè‡³äºŽï¼Œé‡æž„ä¹‹å‰çš„ä»£ç ä¹Ÿå˜å¾—å¾ˆä¾¿æ·ã€‚ ç¬¬ä¸‰ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„éƒ¨ç½²ã€‚å¼€å‘å›¢é˜Ÿä¸å†éœ€è¦åè°ƒå…¶å®ƒæœåŠ¡éƒ¨ç½²å¯¹æœ¬æœåŠ¡çš„å½±å“ã€‚è¿™æ ·çš„ç‰¹æ€§å¤§å¤§åŠ å¿«äº†éƒ¨ç½²é€Ÿåº¦ã€‚å¾®æœåŠ¡æž¶æž„æ¨¡å¼ä½¿å¾—æŒç»­åŒ–éƒ¨ç½²æˆä¸ºå¯èƒ½ã€‚ æœ€åŽï¼Œå¾®æœåŠ¡æž¶æž„æ¨¡å¼ä½¿å¾—æ¯ä¸ªå¾®æœåŠ¡åº”ç”¨éƒ½å¯ä»¥è¢«ç‹¬ç«‹æ‰©å±•ã€‚å•ä½“æž¶æž„åº”ç”¨ä¹Ÿå¯ä»¥æ¨ªå‘æ‰©å±•ï¼Œå³æ•´ä¸ªåº”ç”¨å®Œæ•´çš„å¤åˆ¶åˆ°ä¸åŒçš„èŠ‚ç‚¹ã€‚å½“åº”ç”¨çš„ä¸åŒç»„ä»¶åœ¨æ‰©å±•éœ€æ±‚ä¸Šå­˜åœ¨å·®å¼‚æ—¶ï¼Œå¾®æœåŠ¡æž¶æž„ä¾¿ä½“çŽ°å‡ºå…¶ä¼˜è¶Šæ€§ã€‚é€šè¿‡åœ¨ä¸åŒçš„åŸºç¡€è®¾æ–½ä¹‹é—´å®žçŽ°æ‰©å±•ï¼Œè¿™äº›æœåŠ¡èƒ½å¤Ÿæœ‰æ•ˆåœ°é™ä½Žé£Žé™©[é™ˆæ˜¥éœž, 2016]ã€‚ 3. Spring Cloudå¼€æºæ¡†æž¶Spring Cloudæ˜¯ä¸€ä¸ªåŸºäºŽSpring Bootå®žçŽ°çš„äº‘åº”ç”¨å¼€å‘å·¥å…·ï¼Œå®ƒä¸ºåŸºäºŽJVMçš„äº‘åº”ç”¨å¼€å‘ä¸­çš„æœåŠ¡å‘çŽ°ä¸Žæ³¨å†Œã€ç†”æ–­æœºåˆ¶ã€è·¯ç”±ã€å…¨å±€é”ã€ä¸­å¿ƒé…ç½®ç®¡ç†ã€æŽ§åˆ¶æ€»çº¿ã€å†³ç­–ç«žé€‰ã€åˆ†å¸ƒå¼ä¼šè¯å’Œé›†ç¾¤çŠ¶æ€ç®¡ç†ç­‰æ“ä½œæä¾›äº†ä¸€ç§ç®€å•çš„å¼€å‘æ–¹å¼[ç¿Ÿæ°¸è¶…,2016]ã€‚Spring Cloudæ•´ä½“æž¶æž„å›¾å¦‚å›¾1.1æ‰€ç¤ºã€‚ Spring Cloudæ•´ä½“æž¶æž„ä¸­å¦‚ä¸‹å‡ ä¸ªåŸºç¡€æœåŠ¡æ¨¡å—ï¼šå¾®æœåŠ¡é…ç½®ç®¡ç†ã€APIç½‘å…³æœåŠ¡ã€æœåŠ¡å‘çŽ°ä¸Žæ³¨å†Œå’Œæ¶ˆæ¯æ€»çº¿æ¨¡å—ã€‚ spring-cloud-configï¼Œå¾®æœåŠ¡é…ç½®ç®¡ç†ï¼Œå³ä¸ºä¸Šå›¾çš„config serviceæœåŠ¡æ¨¡å—ï¼Œä¸ºæœåŠ¡ç«¯æä¾›äº†åˆ†å¸ƒå¼çŽ¯å¢ƒçš„ä¸­å¤®é…ç½®æ”¯æŒã€‚é…ç½®æœåŠ¡å™¨ä¸ºå„åº”ç”¨çš„æ‰€æœ‰çŽ¯å¢ƒæä¾›äº†ä¸€ä¸ªä¸­å¿ƒåŒ–çš„å¤–éƒ¨é…ç½®ã€‚å®ƒå®Œæˆäº†å¯¹æœåŠ¡ç«¯Spring-Envå’Œé…ç½®æºæŠ½è±¡çš„æ˜ å°„ï¼Œæ‰€ä»¥configæœåŠ¡ä¸ä»…é€‚ç”¨äºŽSpringæ¡†æž¶æž„å»ºçš„åº”ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨å…¶ä»–è¯­è¨€çš„åº”ç”¨ç¨‹åºã€‚ä½œä¸ºä¸€ä¸ªåº”ç”¨ï¼Œå¯ä»¥é€šè¿‡éƒ¨ç½²ç®¡é“æ¥è¿›è¡Œæµ‹è¯•æˆ–è€…æŠ•å…¥ç”Ÿäº§ï¼Œåˆ†åˆ«ä¸ºè¿™äº›çŽ¯å¢ƒåˆ›å»ºé…ç½®ï¼Œå¹¶ä¸”åœ¨éœ€è¦è¿ç§»çŽ¯å¢ƒçš„æ—¶å€™èŽ·å–å¯¹åº”çš„é…ç½®æ¥è¿è¡Œã€‚ APIç½‘å…³ï¼Œæœ¬ç³»ç»Ÿä½¿ç”¨netflixçš„zuulæ¡†æž¶ï¼Œä½œä¸ºç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œå…·æœ‰è´Ÿè½½å‡è¡¡ã€æœåŠ¡è·¯ç”±ã€æœåŠ¡è¿‡æ»¤ç­‰åŠŸèƒ½ã€‚ æœåŠ¡å‘çŽ°ä¸Žæ³¨å†Œæœ‰å¤šç§å¼€æºç»„ä»¶æ”¯æŒï¼Œæ¯”å¦‚zookeeperã€etcdã€netflixå…¬å¸çš„Eurekaï¼Œä»¥åŠæœ¬ç³»ç»Ÿä½¿ç”¨çš„Consulã€‚æœåŠ¡å‘çŽ°æ˜¯ä¸€ä¸ªæœåŠ¡å°†å…¶åœ°å€ä¿¡æ¯åœ¨ä¸­å¿ƒæ³¨å†ŒèŠ‚ç‚¹è¿›è¡Œæ³¨å†Œçš„è¿‡ç¨‹ã€‚è¯¥æœåŠ¡ä¸€èˆ¬ä¼šå°†å®ƒçš„ä¸»æœºIPåœ°å€ä»¥åŠç«¯å£å·è¿›è¡Œæ³¨å†Œï¼Œå…·ä½“è¿˜ä¼šåŒ…æ‹¬è®¤è¯ä¿¡æ¯ã€ä½¿ç”¨åè®®ã€ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ï¼Œä»¥åŠå…³äºŽåº”ç”¨æœåŠ¡çŽ¯å¢ƒçš„ç»†èŠ‚ä¿¡æ¯ã€‚ä¸€ä¸ªåº”ç”¨æœåŠ¡æˆ–è€…ç»„ä»¶é€šè¿‡æœåŠ¡å‘çŽ°å¯ä»¥æŽŒæ¡å…¶è¿è¡ŒçŽ¯å¢ƒä»¥åŠå…¶å®ƒåº”ç”¨æœåŠ¡æˆ–ç»„ä»¶çš„ä¿¡æ¯ã€‚ç”¨æˆ·é…ç½®ä¸€ä¸ªæœåŠ¡å‘çŽ°å·¥å…·ä¹‹åŽï¼Œå°±å¯ä»¥å°†å®žé™…å®¹å™¨ä¸Žè¿è¡Œé…ç½®åˆ†ç¦»å¼€ã€‚]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…æžRESTä¸ŽHTTP]]></title>
    <url>%2F2017%2F07%2F10%2FREST%E4%B8%8EHTTP%2F</url>
    <content type="text"><![CDATA[å¹‚ç­‰æ€§Methods can also have the property of &quot;idempotence&quot; in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single request. å®‰å…¨æ“ä½œä¸Žå¹‚æŒ‡ç›¸ç­‰ç‰¹æ€§ï¼ˆSafety /Idempotenceï¼‰HTTP çš„ GETã€HEAD è¯·æ±‚æœ¬è´¨ä¸Šåº”è¯¥æ˜¯å®‰å…¨çš„è°ƒç”¨ï¼Œå³ï¼šGETã€HEAD è°ƒç”¨ä¸ä¼šæœ‰ä»»ä½•çš„å‰¯ä½œç”¨ï¼Œä¸ä¼šé€ æˆæœåŠ¡å™¨ç«¯çŠ¶æ€çš„æ”¹å˜ã€‚å¯¹äºŽæœåŠ¡å™¨æ¥è¯´ï¼Œå®¢æˆ·ç«¯å¯¹æŸä¸€ URI åš n æ¬¡çš„ GETã€HAED è°ƒç”¨ï¼Œå…¶çŠ¶æ€ä¸Žæ²¡æœ‰åšè°ƒç”¨æ˜¯ä¸€æ ·çš„ï¼Œä¸ä¼šå‘ç”Ÿä»»ä½•çš„æ”¹å˜ã€‚ HTTP çš„ PUTã€DELTE è°ƒç”¨ï¼Œå…·æœ‰å¹‚æŒ‡ç›¸ç­‰ç‰¹æ€§ , å³ï¼šå®¢æˆ·ç«¯å¯¹æŸä¸€ URI åš n æ¬¡çš„ PUTã€DELTE è°ƒç”¨ï¼Œå…¶æ•ˆæžœä¸Žåšä¸€æ¬¡çš„è°ƒç”¨æ˜¯ä¸€æ ·çš„ã€‚HTTP çš„ GETã€HEAD æ–¹æ³•ä¹Ÿå…·æœ‰å¹‚æŒ‡ç›¸ç­‰ç‰¹æ€§ã€‚HTTP è¿™äº›æ ‡å‡†æ–¹æ³•åœ¨åŽŸåˆ™ä¸Šä¿è¯ä½ çš„åˆ†å¸ƒå¼ç³»ç»Ÿå…·æœ‰è¿™äº›ç‰¹æ€§ï¼Œä»¥å¸®åŠ©æž„å»ºæ›´åŠ å¥å£®çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚ å½“ç„¶ä½œä¸ºè®¾è®¡çš„åŸºç¡€ï¼Œå‡ ä¸ªå¿…é¡»çš„åŽŸåˆ™è¿˜æ˜¯è¦éµå®ˆçš„ï¼š å½“æ ‡å‡†åˆç†çš„æ—¶å€™éµå®ˆæ ‡å‡†ã€‚ APIåº”è¯¥å¯¹ç¨‹åºå‘˜å‹å¥½ï¼Œå¹¶ä¸”åœ¨æµè§ˆå™¨åœ°å€æ å®¹æ˜“è¾“å…¥ã€‚ APIåº”è¯¥ç®€å•ï¼Œç›´è§‚ï¼Œå®¹æ˜“ä½¿ç”¨çš„åŒæ—¶ä¼˜é›…ã€‚ APIåº”è¯¥å…·æœ‰è¶³å¤Ÿçš„çµæ´»æ€§æ¥æ”¯æŒä¸Šå±‚uiã€‚ APIè®¾è®¡æƒè¡¡ä¸Šè¿°å‡ ä¸ªåŽŸåˆ™ã€‚ HTTPhttpè¯·æ±‚ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šè¯·æ±‚è¡Œã€æ¶ˆæ¯æŠ¥å¤´ã€è¯·æ±‚æ­£æ–‡. http 1.1/2 http://www.blogjava.net/yongboy/archive/2015/03/23/423751.html HTTP/1.1ï¼ŒHTTPå®¢æˆ·ç«¯æ— æ³•é‡è¯•éžå¹‚ç­‰è¯·æ±‚ï¼Œå°¤å…¶åœ¨é”™è¯¯å‘ç”Ÿçš„æ—¶å€™ï¼Œç”±äºŽæ— æ³•æ£€æµ‹é”™è¯¯æ€§è´¨è¿™ä¼šå¯¹é‡è¯•å¸¦æ¥ä¸åˆ©çš„å½±å“ã€‚ HTTP/2ä¸å…è®¸ä½¿ç”¨è¿žæŽ¥ç‰¹å®šå¤´éƒ¨å­—æ®µ æ–°å¢žçš„5ä¸ªå¤´éƒ¨ æŽ¨é€æœºåˆ¶çš„ä¸€äº›ç‰¹æ€§éœ€æ±‚ RST_STREAMç­‰å¸§æ ‡å¿—ä½çš„ä½¿ç”¨]]></content>
      <categories>
        <category>Note</category>
      </categories>
      <tags>
        <tag>REST</tag>
        <tag>HTTP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®¾è®¡æ¨¡å¼åˆ†ç±»]]></title>
    <url>%2F2017%2F01%2F12%2FdesignPattern1%2F</url>
    <content type="text"><![CDATA[1. è®¾è®¡æ¨¡å¼åˆ†ç±» åˆ›å»ºåž‹æ¨¡å¼ï¼Œå…±äº”ç§ï¼šå·¥åŽ‚æ–¹æ³•æ¨¡å¼ã€æŠ½è±¡å·¥åŽ‚æ¨¡å¼ã€å•ä¾‹æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼ã€åŽŸåž‹æ¨¡å¼ã€‚ ç»“æž„åž‹æ¨¡å¼ï¼Œå…±ä¸ƒç§ï¼šé€‚é…å™¨æ¨¡å¼ã€è£…é¥°å™¨æ¨¡å¼ã€ä»£ç†æ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€æ¡¥æŽ¥æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€äº«å…ƒæ¨¡å¼ã€‚ è¡Œä¸ºåž‹æ¨¡å¼ï¼Œå…±åä¸€ç§ï¼šç­–ç•¥æ¨¡å¼ã€æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€è¿­ä»£å­æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€å¤‡å¿˜å½•æ¨¡å¼ã€çŠ¶æ€æ¨¡å¼ã€è®¿é—®è€…æ¨¡å¼ã€ä¸­ä»‹è€…æ¨¡å¼ã€è§£é‡Šå™¨æ¨¡å¼ã€‚ å…¶ä»–ä¸¤ç±»ï¼šå¹¶å‘åž‹æ¨¡å¼å’Œçº¿ç¨‹æ± æ¨¡å¼ã€‚ è¿™è¾¹å¼•ç”¨ä¸‹ç½‘ä¸Šçš„è®¾è®¡æ¨¡å¼å›¾ã€‚ 2. è®¾è®¡æ¨¡å¼çš„å…­å¤§åŽŸåˆ™2.1 æ€»åŽŸåˆ™æ€»åŽŸåˆ™ä¸ºå¼€é—­åŽŸåˆ™ã€‚å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ã€‚åœ¨ç¨‹åºéœ€è¦è¿›è¡Œæ‹“å±•çš„æ—¶å€™ï¼Œä¸ç”¨åŽ»ä¿®æ”¹åŽŸæœ‰çš„ä»£ç ï¼Œè€Œæ˜¯æ‰©å±•åŽŸæœ‰ä»£ç ï¼Œå®žçŽ°ä¸€ä¸ªçƒ­æ’æ‹”çš„æ•ˆæžœã€‚æ‰€ä»¥ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯ï¼šä¸ºäº†ä½¿ç¨‹åºçš„æ‰©å±•æ€§å¥½ï¼Œæ˜“äºŽç»´æŠ¤å’Œå‡çº§ã€‚æƒ³è¦è¾¾åˆ°è¿™æ ·çš„æ•ˆæžœï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æŽ¥å£å’ŒæŠ½è±¡ç±»ç­‰ï¼ŒåŽé¢çš„å…·ä½“è®¾è®¡ä¸­æˆ‘ä»¬ä¼šæåˆ°è¿™ç‚¹ã€‚ 2.2 å•ä¸€èŒè´£åŽŸåˆ™ä¸è¦å­˜åœ¨å¤šäºŽä¸€ä¸ªå¯¼è‡´ç±»å˜æ›´çš„åŽŸå› ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªç±»åº”è¯¥å®žçŽ°å•ä¸€çš„èŒè´£ï¼Œå¦åˆ™å°±åº”è¯¥æŠŠç±»æ‹†åˆ†ã€‚ 2.3 é‡Œæ°æ›¿æ¢åŽŸåˆ™é‡Œæ°æ›¿æ¢åŽŸåˆ™ï¼ˆLiskov Substitution Principleï¼‰ï¼Œä»»ä½•åŸºç±»å¯ä»¥å‡ºçŽ°çš„åœ°æ–¹ï¼Œå­ç±»ä¸€å®šå¯ä»¥å‡ºçŽ°ã€‚é‡Œæ°æ›¿æ¢åŽŸåˆ™æ˜¯ç»§æ‰¿å¤ç”¨çš„åŸºçŸ³ï¼Œåªæœ‰å½“è¡ç”Ÿç±»å¯ä»¥æ›¿æ¢åŸºç±»ï¼Œè½¯ä»¶å•ä½çš„åŠŸèƒ½ä¸å—åˆ°å½±å“æ—¶ï¼ŒåŸºç±»æ‰èƒ½çœŸæ­£è¢«å¤ç”¨ï¼Œè€Œè¡ç”Ÿç±»ä¹Ÿèƒ½å¤Ÿåœ¨åŸºç±»çš„åŸºç¡€ä¸Šå¢žåŠ æ–°çš„è¡Œä¸ºã€‚é‡Œæ°ä»£æ¢åŽŸåˆ™æ˜¯å¯¹â€œå¼€-é—­â€åŽŸåˆ™çš„è¡¥å……ã€‚å®žçŽ°â€œå¼€é—­â€åŽŸåˆ™çš„å…³é”®æ­¥éª¤å°±æ˜¯æŠ½è±¡åŒ–ã€‚è€ŒåŸºç±»ä¸Žå­ç±»çš„ç»§æ‰¿å…³ç³»å°±æ˜¯æŠ½è±¡åŒ–çš„å…·ä½“å®žçŽ°ï¼Œæ‰€ä»¥é‡Œæ°ä»£æ¢åŽŸåˆ™æ˜¯å¯¹å®žçŽ°æŠ½è±¡åŒ–çš„å…·ä½“æ­¥éª¤çš„è§„èŒƒã€‚é‡Œæ°æ›¿æ¢åŽŸåˆ™ä¸­ï¼Œå­ç±»å¯¹çˆ¶ç±»çš„æ–¹æ³•å°½é‡ä¸è¦é‡å†™å’Œé‡è½½ã€‚å› ä¸ºçˆ¶ç±»ä»£è¡¨äº†å®šä¹‰å¥½çš„ç»“æž„ï¼Œé€šè¿‡è¿™ä¸ªè§„èŒƒçš„æŽ¥å£ä¸Žå¤–ç•Œäº¤äº’ï¼Œå­ç±»ä¸åº”è¯¥éšä¾¿ç ´åå®ƒã€‚ 2.4 ä¾èµ–å€’è½¬åŽŸåˆ™ä¾èµ–å€’è½¬åŽŸåˆ™ï¼ˆDependence Inversion Principleï¼‰ï¼Œé¢å‘æŽ¥å£ç¼–ç¨‹ï¼Œä¾èµ–äºŽæŠ½è±¡è€Œä¸ä¾èµ–äºŽå…·ä½“ã€‚å†™ä»£ç æ—¶ç”¨åˆ°å…·ä½“ç±»æ—¶ï¼Œä¸ä¸Žå…·ä½“ç±»äº¤äº’ï¼Œè€Œä¸Žå…·ä½“ç±»çš„ä¸Šå±‚æŽ¥å£äº¤äº’ã€‚ 2.5 æŽ¥å£éš”ç¦»åŽŸåˆ™æŽ¥å£éš”ç¦»åŽŸåˆ™ï¼ˆInterface Segregation Principleï¼‰ï¼Œæ¯ä¸ªæŽ¥å£ä¸­ä¸å­˜åœ¨å­ç±»ç”¨ä¸åˆ°å´å¿…é¡»å®žçŽ°çš„æ–¹æ³•ï¼Œå¦‚æžœä¸ç„¶ï¼Œå°±è¦å°†æŽ¥å£æ‹†åˆ†ã€‚ä½¿ç”¨å¤šä¸ªéš”ç¦»çš„æŽ¥å£ï¼Œæ¯”ä½¿ç”¨å•ä¸ªæŽ¥å£ï¼ˆå¤šä¸ªæŽ¥å£æ–¹æ³•é›†åˆåˆ°ä¸€ä¸ªçš„æŽ¥å£ï¼‰è¦å¥½ã€‚ 2.6 è¿ªç±³ç‰¹æ³•åˆ™è¿ªç±³ç‰¹æ³•åˆ™ï¼Œæœ€å°‘çŸ¥é“åŽŸåˆ™ï¼ˆDemeter Principleï¼‰ï¼Œä¸€ä¸ªå®žä½“åº”å½“å°½é‡å°‘çš„ä¸Žå…¶ä»–å®žä½“ä¹‹é—´å‘ç”Ÿç›¸äº’ä½œç”¨ï¼Œä½¿å¾—ç³»ç»ŸåŠŸèƒ½æ¨¡å—ç›¸å¯¹ç‹¬ç«‹ã€‚æ— è®ºè¢«ä¾èµ–çš„ç±»å¤šä¹ˆå¤æ‚ï¼Œéƒ½åº”è¯¥å°†é€»è¾‘å°è£…åœ¨æ–¹æ³•çš„å†…éƒ¨ï¼Œé€šè¿‡publicæ–¹æ³•æä¾›ç»™å¤–éƒ¨ã€‚è¿™æ ·å½“è¢«ä¾èµ–çš„ç±»å˜åŒ–æ—¶ï¼Œæ‰èƒ½æœ€å°çš„å½±å“è¯¥ç±»ã€‚æœ€å°‘çŸ¥é“åŽŸåˆ™çš„å¦ä¸€ä¸ªè¡¨è¾¾æ–¹å¼æ˜¯ï¼šåªä¸Žç›´æŽ¥çš„æœ‹å‹é€šä¿¡ã€‚ç±»ä¹‹é—´åªè¦æœ‰è€¦åˆå…³ç³»ï¼Œå°±å«æœ‹å‹å…³ç³»ã€‚è€¦åˆåˆ†ä¸ºä¾èµ–ã€å…³è”ã€èšåˆã€ç»„åˆç­‰ã€‚æˆ‘ä»¬ç§°å‡ºçŽ°ä¸ºæˆå‘˜å˜é‡ã€æ–¹æ³•å‚æ•°ã€æ–¹æ³•è¿”å›žå€¼ä¸­çš„ç±»ä¸ºç›´æŽ¥æœ‹å‹ã€‚å±€éƒ¨å˜é‡ã€ä¸´æ—¶å˜é‡åˆ™ä¸æ˜¯ç›´æŽ¥çš„æœ‹å‹ã€‚æˆ‘ä»¬è¦æ±‚é™Œç”Ÿçš„ç±»ä¸è¦ä½œä¸ºå±€éƒ¨å˜é‡å‡ºçŽ°åœ¨ç±»ä¸­ã€‚ 2.7 åˆæˆå¤ç”¨åŽŸåˆ™åˆæˆå¤ç”¨åŽŸåˆ™ï¼ˆComposite Reuse Principleï¼‰ï¼Œå°½é‡é¦–å…ˆä½¿ç”¨åˆæˆ/èšåˆçš„æ–¹å¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç»§æ‰¿ã€‚ 3 æ€»ç»“æœ¬æ–‡ä¸»è¦å†™äº†è®¾è®¡æ¨¡å¼çš„æ€»è§ˆï¼Œå¯¹23ç§è®¾è®¡æ¨¡å¼è¿›è¡Œåˆ†ç±»ï¼ŒåŒ…æ‹¬åˆ›å»ºåž‹æ¨¡å¼ã€ç»“æž„åž‹æ¨¡å¼ã€è¡Œä¸ºåž‹æ¨¡å¼ä»¥åŠä¸¤ç§å…¶ä»–æ¨¡å¼ã€‚å…¶æ¬¡ä»‹ç»äº†è®¾è®¡æ¨¡å¼çš„å…­å¤§åŽŸåˆ™ã€‚åŽé¢æ–‡ç« å°†æ‰©å±•ä»‹ç»æ¯ä¸€ç§è®¾è®¡æ¨¡å¼ã€‚ ###å‚è€ƒ23ç§è®¾è®¡æ¨¡å¼å…¨è§£æž]]></content>
      <categories>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
</search>