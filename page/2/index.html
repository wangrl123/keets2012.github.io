<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Aoho&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="聚沙成塔！">
<meta property="og:type" content="website">
<meta property="og:title" content="Aoho&#39;s Blog">
<meta property="og:url" content="http://blueskykong.com/page/2/index.html">
<meta property="og:site_name" content="Aoho&#39;s Blog">
<meta property="og:description" content="聚沙成塔！">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Aoho&#39;s Blog">
<meta name="twitter:description" content="聚沙成塔！">
    

    
        <link rel="alternate" href="/" title="Aoho&#39;s Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Aoho&#39;s Blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/uploads/avatar.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/uploads/avatar.jpg" />
            <h2 id="name">aoho</h2>
            <h3 id="title">Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>China</span>
            <a id="follow" target="_blank" href="https://github.com/keets2012">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                32
                <span>posts</span>
            </div>
            <div class="article-info-block">
                37
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-security4" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/26/security4/">认证鉴权与API权限控制在微服务架构中的设计与实现（四）</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/26/security4/">
            <time datetime="2017-10-25T16:00:00.000Z" itemprop="datePublished">2017-10-26</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Security/">Security</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OAuth2/">OAuth2</a>, <a class="tag-link" href="/tags/Spring-Security/">Spring Security</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>引言： 本文系《认证鉴权与API权限控制在微服务架构中的设计与实现》系列的完结篇，前面三篇已经将认证鉴权与API权限控制的流程和主要细节讲解完。本文比较长，对这个系列进行收尾，主要内容包括对授权和鉴权流程之外的endpoint以及<code>Spring Security</code>过滤器部分踩坑的经历。欢迎阅读本系列文章。</p>
<h2 id="1-前文回顾"><a href="#1-前文回顾" class="headerlink" title="1. 前文回顾"></a>1. 前文回顾</h2><p>首先还是照例对前文进行回顾。在第一篇 <a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现（一）</a>介绍了该项目的背景以及技术调研与最后选型。第二篇<a href="http://blueskykong.com/2017/10/22/security2/">认证鉴权与API权限控制在微服务架构中的设计与实现（二）</a>画出了简要的登录和校验的流程图，并重点讲解了用户身份的认证与token发放的具体实现。第三篇<a href="http://blueskykong.com/2017/10/24/security3/">认证鉴权与API权限控制在微服务架构中的设计与实现（三）</a>先介绍了资源服务器配置，以及其中涉及的配置类，后面重点讲解了token以及API级别的鉴权。   </p>
<p>本文将会讲解剩余的两个内置端点：注销和刷新token。注销token端点的处理与<code>Spring Security</code>默认提供的有些’/logout’有些区别，不仅清空SpringSecurityContextHolder中的信息，还要增加对存储token的清空。另一个刷新token端点其实和之前的请求授权是一样的API，只是参数中的grant_type不一样。   </p>
<p>除了以上两个内置端点，后面将会重点讲下几种<code>Spring Security</code>过滤器。API级别的操作权限校验本来设想是通过<code>Spring Security</code>的过滤器实现，特地把这边学习了一遍，踩了一遍坑。 </p>
<p>最后是本系列的总结，并对于存在的不足和后续工作进行论述。</p>
<h2 id="2-其他端点"><a href="#2-其他端点" class="headerlink" title="2. 其他端点"></a>2. 其他端点</h2><h3 id="2-1-注销端点"><a href="#2-1-注销端点" class="headerlink" title="2.1 注销端点"></a>2.1 注销端点</h3><p>在第一篇中提到了Auth系统内置的注销端点 <code>/logout</code>，如果还记得第三篇资源服务器的配置，下面的关于<code>/logout</code>配置一定不陌生。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//...</span></div><div class="line">	.and().logout()</div><div class="line">             .logoutUrl(<span class="string">"/logout"</span>)</div><div class="line">             .clearAuthentication(<span class="keyword">true</span>)</div><div class="line">             .logoutSuccessHandler(<span class="keyword">new</span> HttpStatusReturningLogoutSuccessHandler())</div><div class="line">             .addLogoutHandler(customLogoutHandler());</div></pre></td></tr></table></figure>
<p>上面配置的主要作用是：   </p>
<ul>
<li>设置注销的URL   </li>
<li>清空Authentication信息   </li>
<li>设置注销成功的处理方式   </li>
<li>设置自定义的注销处理方式   </li>
</ul>
<p>当然在<code>LogoutConfigurer</code>中还有更多的设置选项，笔者此处列出项目所需要的配置项。这些配置项围绕着<code>LogoutFilter</code>过滤器。顺带讲一下<code>Spring Security</code>的过滤器。其使用了<code>springSecurityFillterChian</code>作为了安全过滤的入口，各种过滤器按顺序具体如下：</p>
<ul>
<li>SecurityContextPersistenceFilter：与SecurityContext安全上下文信息有关</li>
<li>HeaderWriterFilter：给http响应添加一些Header</li>
<li>CsrfFilter：防止csrf攻击，默认开启</li>
<li>LogoutFilter：处理注销的过滤器</li>
<li>UsernamePasswordAuthenticationFilter：表单认证过滤器</li>
<li>RequestCacheAwareFilter：缓存request请求</li>
<li>SecurityContextHolderAwareRequestFilter：此过滤器对ServletRequest进行了一次包装，使得request具有更加丰富的API</li>
<li>AnonymousAuthenticationFilter：匿名身份过滤器</li>
<li>SessionManagementFilter：session相关的过滤器，常用来防止session-fixation protection attack，以及限制同一用户开启多个会话的数量</li>
<li>ExceptionTranslationFilter：异常处理过滤器</li>
<li>FilterSecurityInterceptor：web应用安全的关键Filter</li>
</ul>
<p>各种过滤器简单标注了作用，在下一节重点讲其中的几个过滤器。注销过滤器排在靠前的位置，我们一起看下<code>LogoutFilter</code>的UML类图。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/logout.png" alt="logoutFilter" title="logoutFilter类图"></p>
<p>类图和我们之前配置时的思路是一致的，<code>HttpSecurity</code>创建了<code>LogoutConfigurer</code>，我们在这边配置了<code>LogoutConfigurer</code>的一些属性。同时<code>LogoutConfigurer</code>根据这些属性创建了<code>LogoutFilter</code>。</p>
<p><code>LogoutConfigurer</code>的配置，第一和第二点就不用再详细解释了，一个是设置端点，另一个是清空认证信息。<br>对于第三点，配置注销成功的处理方式。由于项目是前后端分离，客户端只需要知道执行成功该API接口的状态，并不用返回具体的页面或者继续向下传递请求。因此，这边配置了默认的<code>HttpStatusReturningLogoutSuccessHandler</code>，成功直接返回状态码200。<br>对于第四点配置，自定义注销处理的方法。这边需要借助<code>TokenStore</code>，对token进行操作。<code>TokenStore</code>在之前文章的配置中已经讲过，使用的是JdbcTokenStore。首先校验请求的合法性，如果合法则对其进行操作，先后移除<code>refreshToken</code>和<code>existingAccessToken</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomLogoutHandler</span> <span class="keyword">implements</span> <span class="title">LogoutHandler</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> </span>&#123;</div><div class="line">    	<span class="comment">//确定注入了tokenStore</span></div><div class="line">        Assert.notNull(tokenStore, <span class="string">"tokenStore must be set"</span>);</div><div class="line">       <span class="comment">//获取头部的认证信息</span></div><div class="line">        String token = request.getHeader(<span class="string">"Authorization"</span>);</div><div class="line">        Assert.hasText(token, <span class="string">"token must be set"</span>);</div><div class="line">        <span class="comment">//校验token是否符合JwtBearer格式</span></div><div class="line">        <span class="keyword">if</span> (isJwtBearerToken(token)) &#123;</div><div class="line">            token = token.substring(<span class="number">6</span>);</div><div class="line">            OAuth2AccessToken existingAccessToken = tokenStore.readAccessToken(token);</div><div class="line">            OAuth2RefreshToken refreshToken;</div><div class="line">            <span class="keyword">if</span> (existingAccessToken != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (existingAccessToken.getRefreshToken() != <span class="keyword">null</span>) &#123;</div><div class="line">                    LOGGER.info(<span class="string">"remove refreshToken!"</span>, existingAccessToken.getRefreshToken());</div><div class="line">                    refreshToken = existingAccessToken.getRefreshToken();</div><div class="line">                    tokenStore.removeRefreshToken(refreshToken);</div><div class="line">                &#125;</div><div class="line">                LOGGER.info(<span class="string">"remove existingAccessToken!"</span>, existingAccessToken);</div><div class="line">                tokenStore.removeAccessToken(existingAccessToken);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadClientCredentialsException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行如下请求： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">method: get</div><div class="line">url: http://localhost:9000/logout</div><div class="line">header:</div><div class="line">&#123;</div><div class="line">	Authorization: Basic ZnJvbnRlbmQ6ZnJvbnRlbmQ=</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注销成功则会返回200，将token和SecurityContextHolder进行清空。</p>
<h3 id="2-2-刷新端点"><a href="#2-2-刷新端点" class="headerlink" title="2.2 刷新端点"></a>2.2 刷新端点</h3><p>在第一篇就已经讲过，由于token的时效一般不会很长，而refresh<em> token一般周期会很长，为了不影响用户的体验，可以使用refresh</em> token去动态的刷新token。刷新token主要与<code>RefreshTokenGranter</code>有关，<code>CompositeTokenGranter</code>管理一个List列表，每一种grantType对应一个具体的真正授权者，refresh_ token对应的granter就是<code>RefreshTokenGranter</code>，而granter内部则是通过grantType来区分是否是各自的授权类型。执行如下请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">method: post </div><div class="line">url: http://localhost:12000/oauth/token?grant_type=refresh_token&amp;refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJYLUtFRVRTLVVzZXJJZCI6ImQ2NDQ4YzI0LTNjNGMtNGI4MC04MzcyLWMyZDYxODY4ZjhjNiIsInVzZXJfbmFtZSI6ImtlZXRzIiwic2NvcGUiOlsiYWxsIl0sImF0aSI6ImJhZDcyYjE5LWQ5ZjMtNDkwMi1hZmZhLTA0MzBlN2RiNzllZCIsImV4cCI6MTUxMDk5NjU1NiwianRpIjoiYWE0MWY1MjctODE3YS00N2UyLWFhOTgtZjNlMDZmNmY0NTZlIiwiY2xpZW50X2lkIjoiZnJvbnRlbmQifQ.mICT1-lxOAqOU9M-Ud7wZBb4tTux6OQWouQJ2nn1DeE</div><div class="line">header:</div><div class="line">&#123;</div><div class="line">	Authorization: Basic ZnJvbnRlbmQ6ZnJvbnRlbmQ=</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在refresh_ token正确的情况下，其返回的response和/oauth/token得到正常的响应是一样的。具体的代码可以参阅第二篇的讲解。</p>
<h2 id="3-Spring-Security过滤器"><a href="#3-Spring-Security过滤器" class="headerlink" title="3. Spring Security过滤器"></a>3. <code>Spring Security</code>过滤器</h2><p>在上一节我们介绍了内置的两个端点的实现细节，还提到了<code>HttpSecurity</code>过滤器，因为注销端点的实现就是通过过滤器的作用。核心的过滤器主要有：</p>
<ul>
<li>FilterSecurityInterceptor</li>
<li>UsernamePasswordAuthenticationFilter</li>
<li>SecurityContextPersistenceFilter</li>
<li>ExceptionTranslationFilter</li>
</ul>
<p>这一节将重点介绍其中的<code>UsernamePasswordAuthenticationFilter</code>和<code>FilterSecurityInterceptor</code>。   </p>
<h3 id="3-1-UsernamePasswordAuthenticationFilter"><a href="#3-1-UsernamePasswordAuthenticationFilter" class="headerlink" title="3.1 UsernamePasswordAuthenticationFilter"></a>3.1 <code>UsernamePasswordAuthenticationFilter</code></h3><p>笔者在刚开始看关于过滤器的文章，对于<code>UsernamePasswordAuthenticationFilter</code>有不少的文章介绍。如果只是引入Spring-Security，必然会与<code>/login</code>端点熟悉。SpringSecurity强制要求我们的表单登录页面必须是以POST方式向/login URL提交请求，而且要求用户名和密码的参数名必须是username和password。如果不符合，则不能正常工作。原因在于，当我们调用了HttpSecurity对象的formLogin方法时，其最终会给我们注册一个过滤器<code>UsernamePasswordAuthenticationFilter</code>。看一下该过滤器的源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsernamePasswordAuthenticationFilter</span> <span class="keyword">extends</span></span></div><div class="line">		<span class="title">AbstractAuthenticationProcessingFilter</span> &#123;</div><div class="line">	<span class="comment">//用户名、密码</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_SECURITY_FORM_USERNAME_KEY = <span class="string">"username"</span>;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_SECURITY_FORM_PASSWORD_KEY = <span class="string">"password"</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> String usernameParameter = SPRING_SECURITY_FORM_USERNAME_KEY;</div><div class="line">	<span class="keyword">private</span> String passwordParameter = SPRING_SECURITY_FORM_PASSWORD_KEY;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> postOnly = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">	<span class="comment">//post请求/login</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">UsernamePasswordAuthenticationFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">"/login"</span>, <span class="string">"POST"</span>));</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//实现抽象类AbstractAuthenticationProcessingFilter的抽象方法，尝试验证</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">			HttpServletResponse response) <span class="keyword">throws</span> AuthenticationException &#123;</div><div class="line">		<span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">"POST"</span>)) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(</div><div class="line">					<span class="string">"Authentication method not supported: "</span> + request.getMethod());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		String username = obtainUsername(request);</div><div class="line">		String password = obtainPassword(request);</div><div class="line">		</div><div class="line">		<span class="comment">//···</span></div><div class="line"></div><div class="line">		username = username.trim();</div><div class="line"></div><div class="line">		UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</div><div class="line">				username, password);</div><div class="line">		<span class="comment">//···</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAuthenticationProcessingFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilterBean</span></span></div><div class="line">		<span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">MessageSourceAware</span> &#123;</div><div class="line">	<span class="comment">//...</span></div><div class="line">	</div><div class="line">	<span class="comment">//调用requiresAuthentication，判断请求是否需要authentication，如果需要则调用attemptAuthentication</span></div><div class="line">	<span class="comment">//有三种结果可能返回：</span></div><div class="line">	<span class="comment">//1.Authentication对象</span></div><div class="line">	<span class="comment">//2. AuthenticationException</span></div><div class="line">	<span class="comment">//3. Authentication对象为空</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">		HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">		HttpServletResponse response = (HttpServletResponse) res;</div><div class="line">		<span class="comment">//不需要校验，继续传递</span></div><div class="line">		<span class="keyword">if</span> (!requiresAuthentication(request, response)) &#123;</div><div class="line">			chain.doFilter(request, response);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		Authentication authResult;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			authResult = attemptAuthentication(request, response);</div><div class="line">			<span class="keyword">if</span> (authResult == <span class="keyword">null</span>) &#123;</div><div class="line">				<span class="comment">// return immediately as subclass has indicated that it hasn't completed authentication</span></div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			sessionStrategy.onAuthentication(authResult, request, response);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//...</span></div><div class="line">		<span class="keyword">catch</span> (AuthenticationException failed) &#123;</div><div class="line">			<span class="comment">// Authentication failed</span></div><div class="line">			unsuccessfulAuthentication(request, response, failed);</div><div class="line"></div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Authentication success</span></div><div class="line">		<span class="keyword">if</span> (continueChainBeforeSuccessfulAuthentication) &#123;</div><div class="line">			chain.doFilter(request, response);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		successfulAuthentication(request, response, chain, authResult);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//实际执行的authentication，继承类必须实现该抽象方法</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">			HttpServletResponse response) <span class="keyword">throws</span> AuthenticationException, IOException,</div><div class="line">			ServletException;</div><div class="line">	<span class="comment">//成功authentication的默认行为</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">successfulAuthentication</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">			HttpServletResponse response, FilterChain chain, Authentication authResult)</div><div class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">		<span class="comment">//...</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">//失败authentication的默认行为</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">unsuccessfulAuthentication</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">			HttpServletResponse response, AuthenticationException failed)</div><div class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">	<span class="comment">//...			</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	...</div><div class="line">	<span class="comment">//设置AuthenticationManager</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthenticationManager</span><span class="params">(AuthenticationManager authenticationManager)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.authenticationManager = authenticationManager;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>UsernamePasswordAuthenticationFilter</code>因为继承了<code>AbstractAuthenticationProcessingFilter</code>才拥有过滤器的功能。<code>AbstractAuthenticationProcessingFilter</code>要求设置一个authenticationManager，authenticationManager的实现类将实际处理请求的认证。<code>AbstractAuthenticationProcessingFilter</code>将拦截符合过滤规则的request，并试图执行认证。子类必须实现 attemptAuthentication 方法，这个方法执行具体的认证。<br>认证之后的处理和上注销的差不多。如果认证成功，将会把返回的Authentication对象存放在SecurityContext，并调用SuccessHandler，也可以设置指定的URL和指定自定义的处SuccessHandler。如果认证失败，默认会返回401代码给客户端，也可以设置URL，指定自定义的处理FailureHandler。   </p>
<p>基于<code>UsernamePasswordAuthenticationFilter</code>自定义的<code>AuthenticationFilte</code>还是挺多案例的，这边推荐一篇博文<a href="https://www.cnkirito.moe/2017/10/01/spring-security-5/" target="_blank" rel="external">Spring Security(五)–动手实现一个IP_Login</a>，写得比较详细。</p>
<h3 id="3-2-FilterSecurityInterceptor"><a href="#3-2-FilterSecurityInterceptor" class="headerlink" title="3.2 FilterSecurityInterceptor"></a>3.2 <code>FilterSecurityInterceptor</code></h3><p><code>FilterSecurityInterceptor</code>是filterchain中比较复杂，也是比较核心的过滤器，主要负责web应用安全授权的工作。首先看下对于自定义的<code>FilterSecurityInterceptor</code>配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">	</div><div class="line">	...</div><div class="line">	<span class="comment">//添加CustomSecurityFilter，过滤器的顺序放在FilterSecurityInterceptor</span></div><div class="line">       http.antMatcher(<span class="string">"/oauth/check_token"</span>).addFilterAt(customSecurityFilter(), FilterSecurityInterceptor.class);</div><div class="line"></div><div class="line">   &#125;</div><div class="line">   <span class="comment">//提供实例化的自定义过滤器</span></div><div class="line">   <span class="meta">@Bean</span></div><div class="line">   <span class="function"><span class="keyword">public</span> CustomSecurityFilter <span class="title">customSecurityFilter</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> CustomSecurityFilter();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>从上述配置可以看到，在<code>FilterSecurityInterceptor</code>的位置注册了<code>CustomSecurityFilter</code>，对于匹配到<code>/oauth/check_token</code>，则会调用该进入该过滤器。下图为<code>FilterSecurityInterceptor</code>的类图，在其中还添加了<code>CustomSecurityFilter</code>和相关实现的接口的类，方便读者对比着看。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/filterSecurity.png" alt="FilterSecurityInterceptor" title="FilterSecurityInterceptor类图"></p>
<p><code>CustomSecurityFilter</code>是模仿<code>FilterSecurityInterceptor</code>实现，继承<code>AbstractSecurityInterceptor</code>和实现<code>Filter</code>接口。整个过程需要依赖<code>AuthenticationManager</code>、<code>AccessDecisionManager</code>和<code>FilterInvocationSecurityMetadataSource</code>。<br><code>AuthenticationManager</code>是认证管理器，实现用户认证的入口；<code>AccessDecisionManager</code>是访问决策器，决定某个用户具有的角色，是否有足够的权限去访问某个资源；<code>FilterInvocationSecurityMetadataSource</code>是资源源数据定义，即定义某一资源可以被哪些角色访问。<br>从上面的类图中可以看到自定义的<code>CustomSecurityFilter</code>同时又实现了<br><code>AccessDecisionManager</code>和<code>FilterInvocationSecurityMetadataSource</code>。分别为<code>SecureResourceFilterInvocationDefinitionSource</code>和<code>SecurityAccessDecisionManager</code>。下面分析下主要的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//通过一个实现的filter，对HTTP资源进行安全处理</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilterSecurityInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractSecurityInterceptor</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line">	<span class="comment">//被filter chain真实调用的方法，通过invoke代理</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></div><div class="line">			FilterChain chain) <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">		FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</div><div class="line">		invoke(fi);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//代理的方法</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(FilterInvocation fi)</span> <span class="keyword">throws</span> IOException, ServletException 	</span>&#123;</div><div class="line">		<span class="comment">//...省略</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码是<code>FilterSecurityInterceptor</code>中的实现，具体实现细节就没列出了，我们这边重点在于对自定义的实现进行讲解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomSecurityFilter</span> <span class="keyword">extends</span> <span class="title">AbstractSecurityInterceptor</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line">   </div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    SecureResourceFilterInvocationDefinitionSource invocationSource;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> SecurityAccessDecisionManager decisionManager;</div><div class="line"></div><div class="line">	<span class="comment">//设置父类中的属性</span></div><div class="line">    <span class="meta">@PostConstruct</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.setAccessDecisionManager(decisionManager);</div><div class="line">        <span class="keyword">super</span>.setAuthenticationManager(authenticationManager);</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//主要的过滤方法，与原来的一致</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        <span class="comment">//logger.info("doFilter in Security ");</span></div><div class="line">        <span class="comment">//构造一个FilterInvocation，封装request, response, chain</span></div><div class="line">        FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(servletRequest, servletResponse, filterChain);</div><div class="line">        <span class="comment">//beforeInvocation会调用SecureResourceDataSource中的逻辑，类似于aop中的before </span></div><div class="line">        InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">        	<span class="comment">//执行下一个拦截器</span></div><div class="line">            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());            </div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        	<span class="comment">//完成后续工作，类似于aop中的after </span></div><div class="line">            <span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">    </div><div class="line">    <span class="comment">//资源源数据定义，设置为自定义的SecureResourceFilterInvocationDefinitionSource</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SecurityMetadataSource <span class="title">obtainSecurityMetadataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> invocationSource;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面自定义的<code>CustomSecurityFilter</code>，与我们之前的讲解是一样的流程。主要依赖的三个接口都有在实现中实例化注入。看下父类的beforeInvocation方法，其中省略了一些不重要的代码片段。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> InterceptorStatusToken <span class="title">beforeInvocation</span><span class="params">(Object object)</span> </span>&#123;  </div><div class="line">    <span class="comment">//根据SecurityMetadataSource获取配置的权限属性  </span></div><div class="line">    Collection&lt;ConfigAttribute&gt; attributes = <span class="keyword">this</span>.obtainSecurityMetadataSource().getAttributes(object);  </div><div class="line">    <span class="comment">//...  </span></div><div class="line">    <span class="comment">//判断是否需要对认证实体重新认证，默认为否  </span></div><div class="line">    Authentication authenticated = authenticateIfRequired();  </div><div class="line">  </div><div class="line">    <span class="comment">// Attempt authorization  </span></div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        <span class="comment">//决策管理器开始决定是否授权，如果授权失败，直接抛出AccessDeniedException  </span></div><div class="line">        <span class="keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">catch</span> (AccessDeniedException accessDeniedException) &#123;  </div><div class="line">        publishEvent(<span class="keyword">new</span> AuthorizationFailureEvent(object, attributes, authenticated,  </div><div class="line">                accessDeniedException));  </div><div class="line">  </div><div class="line">        <span class="keyword">throw</span> accessDeniedException;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码可以看出，第一步是根据SecurityMetadataSource获取配置的权限属性，accessDecisionManager会用到权限列表信息。然后判断是否需要对认证实体重新认证，默认为否。第二步是接着决策管理器开始决定是否授权，如果授权失败，直接抛出AccessDeniedException。</p>
<p>(1). 获取配置的权限属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecureResourceFilterInvocationDefinitionSource</span> <span class="keyword">implements</span> <span class="title">FilterInvocationSecurityMetadataSource</span>, <span class="title">InitializingBean</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> PathMatcher matcher;</div><div class="line">	<span class="comment">//map保存配置的URL对应的权限集</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Collection&lt;ConfigAttribute&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">	<span class="comment">//根据传入的对象URL进行循环</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object o)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</div><div class="line">        logger.info(<span class="string">"getAttributes"</span>);</div><div class="line">        <span class="comment">//应该做instanceof</span></div><div class="line">        FilterInvocation filterInvocation = (FilterInvocation) o;</div><div class="line">        <span class="comment">//String method = filterInvocation.getHttpRequest().getMethod();</span></div><div class="line">        String requestURI = filterInvocation.getRequestUrl();</div><div class="line">        <span class="comment">//循环资源路径，当访问的Url和资源路径url匹配时，返回该Url所需要的权限</span></div><div class="line">        <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;String, Collection&lt;ConfigAttribute&gt;&gt;&gt; iterator = map.entrySet().iterator(); iter.hasNext(); ) &#123;</div><div class="line">            Map.Entry&lt;String, Collection&lt;ConfigAttribute&gt;&gt; entry = iterator.next();</div><div class="line">            String url = entry.getKey();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (matcher.match(url, requestURI)) &#123;</div><div class="line">                <span class="keyword">return</span> map.get(requestURI);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	<span class="comment">//... </span></div><div class="line">	</div><div class="line">	<span class="comment">//设置权限集，即上述的map</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        logger.info(<span class="string">"afterPropertiesSet"</span>);</div><div class="line">        <span class="comment">//用来匹配访问资源路径</span></div><div class="line">        <span class="keyword">this</span>.matcher = <span class="keyword">new</span> AntPathMatcher();</div><div class="line">        <span class="comment">//可以有多个权限</span></div><div class="line">        Collection&lt;ConfigAttribute&gt; atts = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        ConfigAttribute c1 = <span class="keyword">new</span> SecurityConfig(<span class="string">"ROLE_ADMIN"</span>);</div><div class="line">        atts.add(c1);</div><div class="line">        map.put(<span class="string">"/oauth/check_token"</span>, atts);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面是getAttributes()实现的具体细节，将请求的URL取出进行匹配事先设定的受限资源，最后返回需要的权限、角色。系统在启动的时候就会读取到配置的map集合，对于拦截到请求进行匹配。代码中注释比较详细，这边不多说。</p>
<p>(2). 决策管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityAccessDecisionManager</span> <span class="keyword">implements</span> <span class="title">AccessDecisionManager</span> </span>&#123;</div><div class="line">	<span class="comment">//...</span></div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object o, Collection&lt;ConfigAttribute&gt; collection)</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException </span>&#123;</div><div class="line">        logger.info(<span class="string">"decide url and permission"</span>);</div><div class="line">        <span class="comment">//集合为空</span></div><div class="line">        <span class="keyword">if</span> (collection == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Iterator&lt;ConfigAttribute&gt; ite = collection.iterator();</div><div class="line">        <span class="comment">//判断用户所拥有的权限，是否符合对应的Url权限，如果实现了UserDetailsService，则用户权限是loadUserByUsername返回用户所对应的权限</span></div><div class="line">        <span class="keyword">while</span> (ite.hasNext()) &#123;</div><div class="line">            ConfigAttribute ca = ite.next();</div><div class="line">            String needRole = ca.getAttribute();</div><div class="line">            <span class="keyword">for</span> (GrantedAuthority ga : authentication.getAuthorities()) &#123;</div><div class="line">                logger.info(<span class="string">"GrantedAuthority: &#123;&#125;"</span>, ga);</div><div class="line">                <span class="keyword">if</span> (needRole.equals(ga.getAuthority())) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        logger.error(<span class="string">"AccessDecisionManager: no right!"</span>);</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AccessDeniedException(<span class="string">"no right!"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	<span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码是决策管理器的实现，其逻辑也比较简单，将请求所具有的权限与设定的受限资源所需的进行匹配，如果具有则返回，否则抛出没有正确的权限异常。默认提供的决策管理器有三种，分别为AffirmativeBased、ConsensusBased、UnanimousBased，篇幅有限，我们这边不再扩展了。   </p>
<p>补充一下，所具有的权限是通过之前配置的认证方式，有password认证和client认证两种。我们之前在授权服务器中配置了<code>withClientDetails</code>，所以用frontend身份验证获得的权限是我们预先配置在数据库中的authorities。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>Auth系统主要功能是授权认证和鉴权。项目微服务化后，原有的单体应用基于HttpSession认证鉴权不能满足微服务架构下的需求。每个微服务都需要对访问进行鉴权，每个微应用都需要明确当前访问用户以及其权限，尤其当有多个客户端，包括web端、移动端等等，单体应用架构下的鉴权方式就不是特别合适了。权限服务作为基础的公共服务，也需要微服务化。</p>
<p>笔者的设计中，Auth服务一方面进行授权认证，另一方面是基于token进行身份合法性和API级别的权限校验。对于某个服务的请求，经过网关会调用Auth服务，对token合法性进行验证。同时笔者根据当前项目的整体情况，存在部分遗留服务，这些遗留服务又没有足够的时间和人力立马进行微服务改造，而且还需要继续运行。为了适配当前新的架构，采取的方案就是对这些遗留服务的操作API，在Auth服务进行API级别的操作权限鉴定。API级别的操作权限校验需要的上下文信息需要结合业务，与客户端进行商定，应该在token能取到相应信息，传递给Auth服务，不过应尽量减少在header取上下文校验的信息。</p>
<p>笔者将本次开发Auth系统所涉及的大部分代码及源码进行了解析，至于没有讲到的一些内容和细节，读者可以自行扩展。</p>
<h2 id="5-不足与后续工作"><a href="#5-不足与后续工作" class="headerlink" title="5. 不足与后续工作"></a>5. 不足与后续工作</h2><h3 id="5-1-存在的不足"><a href="#5-1-存在的不足" class="headerlink" title="5.1 存在的不足"></a>5.1 存在的不足</h3><ul>
<li><p>API级别操作权限校验的通用性   </p>
<p>  (1). 对于API级别操作权限校验，需要在网关处调用时构造相应的上下文信息。上下文信息基本依赖于    token中的payload，如果信息太多引起token太长，导致每次客户端的请求头部长度变长。  </p>
<p>  (2). 并不是所有的操作接口都能覆盖到，这个问题是比较严重的，根据上下文集合很可能出现好多接口    的权限没法鉴定，最后的结果就是API级别操作权限校验失败的是绝对没有权限访问该接口，而通过不一定能访问，因为该接口涉及到的上下文根本没法完全得到。我们的项目在现阶段，定义的最小上下文集合能勉强覆盖到，但是对于后面扩增的服务接口真的是不乐观。   </p>
<p>  (3). 每个服务的每个接口都在Auth服务注册其所需要的权限，太过麻烦，Auth服务需要额外维护这样的信息。</p>
</li>
<li><p>网关处调用Auth服务带来的系统吞吐量瓶颈   </p>
<p>  (1). 这个其实很容易理解，Auth服务作为公共的基础服务，大多数服务接口都会需要鉴权，Auth服务需要经过复杂。   </p>
<p>  (2). 网关调用Auth服务，阻塞调用，只有等Auth服务返回校验结果，才会做进一步处理。虽说Auth服务可以多实例部署，但是并发量大了之后，其瓶颈明显可见，严重可能会造成整个系统的不可用。</p>
</li>
</ul>
<h3 id="5-2-后续工作"><a href="#5-2-后续工作" class="headerlink" title="5.2 后续工作"></a>5.2 后续工作</h3><ul>
<li>从整个系统设计角度来讲，API级别操作权限后期将会分散在各个服务的接口上，由各个接口负责其所需要的权限、身份等。Spring Security对于接口级别的权限校验也是支持的，之所以采用这样的做法，也是为了兼容新服务和遗留的服务，主要是针对遗留服务，新的服务采用的是分散在各个接口之上。</li>
<li>将API级别操作权限分散到各个服务接口之后，相应的能提升Auth服务的响应。网关能够及时的对请求进行转发或者拒绝。</li>
<li>API级别操作权限所需要的上下文信息对各个接口真的设计的很复杂，这边我们确实花了时间，同时管理移动服务的好几百操作接口所对应的权限，非常烦。！</li>
</ul>
<p><strong>本文的源码地址：<br>GitHub：<a href="https://github.com/keets2012/Auth-service" target="_blank" rel="external">https://github.com/keets2012/Auth-service</a><br>码云： <a href="https://gitee.com/keets/Auth-Service" target="_blank" rel="external">https://gitee.com/keets/Auth-Service</a></strong></p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://www.tianshouzhi.com/api/tutorials/spring_security_4/265" target="_blank" rel="external">配置表单登录</a></li>
<li><a href="http://dead-knight.iteye.com/blog/1513913" target="_blank" rel="external">Spring Security3源码分析-FilterSecurityInterceptor分析</a></li>
<li><a href="https://docs.spring.io/spring-security/site/docs/3.0.x/reference/core-web-filters.html" target="_blank" rel="external">Core Security Filters</a></li>
<li><a href="https://www.cnkirito.moe/2017/09/30/spring-security-4/" target="_blank" rel="external">Spring Security(四)–核心过滤器源码分析</a></li>
</ol>
<h3 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h3><p><a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现（一）</a><br><a href="http://blueskykong.com/2017/10/22/security2/">认证鉴权与API权限控制在微服务架构中的设计与实现（二）</a><br><a href="http://blueskykong.com/2017/10/24/security3/">认证鉴权与API权限控制在微服务架构中的设计与实现（三）</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/10/26/security4/" data-id="cja25cxiy001qff6q3nxl7p0q" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-security3" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/24/security3/">认证鉴权与API权限控制在微服务架构中的设计与实现（三）</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/24/security3/">
            <time datetime="2017-10-23T16:00:00.000Z" itemprop="datePublished">2017-10-24</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Security/">Security</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OAuth2/">OAuth2</a>, <a class="tag-link" href="/tags/Spring-Security/">Spring Security</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>引言： 本文系《认证鉴权与API权限控制在微服务架构中的设计与实现》系列的第三篇，本文重点讲解token以及API级别的鉴权。本文对涉及到的大部分代码进行了分析，欢迎订阅本系列文章。</p>
<h2 id="1-前文回顾"><a href="#1-前文回顾" class="headerlink" title="1. 前文回顾"></a>1. 前文回顾</h2><p>在开始讲解这一篇文章之前，先对之前两篇文章进行回忆下。在第一篇 <a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现（一）</a>介绍了该项目的背景以及技术调研与最后选型。第二篇<a href="http://blueskykong.com/2017/10/22/security2/">认证鉴权与API权限控制在微服务架构中的设计与实现（二）</a>画出了简要的登录和校验的流程图，并重点讲解了用户身份的认证与token发放的具体实现。   </p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/check.png" alt="check" title="身份及API权限校验的流程图"></p>
<p>本文重点讲解鉴权，包括两个方面：token合法性以及API级别的操作权限。首先token合法性很容易理解，第二篇文章讲解了获取授权token的一系列流程，token是否是认证服务器颁发的，必然是需要验证的。其次对于API级别的操作权限，将上下文信息不具备操作权限的请求直接拒绝，当然此处是设计token合法性校验在先，其次再对操作权限进行验证，如果前一个验证直接拒绝，通过则进入操作权限验证。</p>
<h2 id="2-资源服务器配置"><a href="#2-资源服务器配置" class="headerlink" title="2.资源服务器配置"></a>2.资源服务器配置</h2><p><code>ResourceServer</code>配置在第一篇就列出了，在进入鉴权之前，把这边的配置搞清，即使有些配置在本项目中没有用到，大家在自己的项目有可能用到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableResourceServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//http安全配置</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    	<span class="comment">//禁掉csrf，设置session策略</span></div><div class="line">        http.csrf().disable()</div><div class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</div><div class="line">                .and()<span class="comment">//默认允许访问</span></div><div class="line">                .requestMatchers().antMatchers(<span class="string">"/**"</span>)</div><div class="line">                .and().authorizeRequests()</div><div class="line">                .antMatchers(<span class="string">"/**"</span>).permitAll()</div><div class="line">                .anyRequest().authenticated()</div><div class="line">                .and().logout() <span class="comment">//logout注销端点配置</span></div><div class="line">                .logoutUrl(<span class="string">"/logout"</span>)</div><div class="line">                .clearAuthentication(<span class="keyword">true</span>)</div><div class="line">                .logoutSuccessHandler(<span class="keyword">new</span> HttpStatusReturningLogoutSuccessHandler())</div><div class="line">                .addLogoutHandler(customLogoutHandler());</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//添加自定义的CustomLogoutHandler</span></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> CustomLogoutHandler <span class="title">customLogoutHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomLogoutHandler();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//资源安全配置相关</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">super</span>.configure(resources);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(1). <code>@EnableResourceServer</code>这个注解很重要，OAuth2资源服务器的简便注解。其使得Spring Security filter通过请求中的OAuth2 token来验证请求。通常与<code>EnableWebSecurity</code>配合使用，该注解还创建了硬编码的<code>@Order(3) WebSecurityConfigurerAdapter</code>，由于当前spring的技术，order的顺序不易修改，所以在项目中避免还有其他order=3的配置。</p>
<p>(2). 关联的<code>HttpSecurity</code>，与之前的 Spring Security XML中的 “http”元素配置类似，它允许配置基于web安全以针对特定http请求。默认是应用到所有的请求，通过<code>requestMatcher</code>可以限定具体URL范围。HttpSecurity类图如下。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/httpsecurity.png" alt="HttpSecurity" title="HttpSecurity类图"></p>
<p>总的来说：HttpSecurity是SecurityBuilder接口的一个实现类，从名字上我们就可以看出这是一个HTTP安全相关的构建器。当然我们在构建的时候可能需要一些配置，当我们调用HttpSecurity对象的方法时，实际上就是在进行配置。   </p>
<p>authorizeRequests()，formLogin()、httpBasic()这三个方法返回的分别是<code>ExpressionUrlAuthorizationConfigurer</code>、<code>FormLoginConfigurer</code>、<code>HttpBasicConfigurer</code>，他们都是SecurityConfigurer接口的实现类，分别代表的是不同类型的安全配置器。<br>因此，从总的流程上来说，当我们在进行配置的时候，需要一个安全构建器SecurityBuilder(例如我们这里的HttpSecurity)，SecurityBuilder实例的创建需要有若干安全配置器SecurityConfigurer实例的配合。</p>
<p>(3).关联的<code>ResourceServerSecurityConfigurer</code>，为资源服务器添加特殊的配置，默认的适用于很多应用，但是这边的修改至少以resourceId为单位。类图如下。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/resource.png" alt="ResourceServerSecurityConfigurer" title="ResourceServerSecurityConfigurer类图"></p>
<p><code>ResourceServerSecurityConfigurer</code>创建了OAuth2核心过滤器<code>OAuth2AuthenticationProcessingFilter</code>，并为其提供固定了<code>OAuth2AuthenticationManager</code>。只有被<code>OAuth2AuthenticationProcessingFilter</code>拦截到的oauth2相关请求才被特殊的身份认证器处理。同时设置了TokenExtractor、异常处理实现。</p>
<p><code>OAuth2AuthenticationProcessingFilter</code>是OAuth2保护资源的预先认证过滤器。配合<code>OAuth2AuthenticationManager</code>使用，根据请求获取到OAuth2 token，之后就会使用<code>OAuth2Authentication</code>来填充Spring Security上下文。<br><code>OAuth2AuthenticationManager</code>在前面的文章给出的<code>AuthenticationManager</code>类图就出现了，与token认证相关。这边略过贴出源码进行讲解，读者可以自行阅读。</p>
<h2 id="3-鉴权endpoint"><a href="#3-鉴权endpoint" class="headerlink" title="3. 鉴权endpoint"></a>3. 鉴权endpoint</h2><p>鉴权主要是使用内置的endpoint <code>/oauth/check_token</code>，笔者将对端点的分析放在前面，因为这是鉴权的唯一入口。下面我们来看下该API接口中的主要代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/oauth/check_token"</span>)</div><div class="line">   <span class="meta">@ResponseBody</span></div><div class="line">   <span class="keyword">public</span> Map&lt;String, ?&gt; checkToken(CheckTokenEntity checkTokenEntity) &#123;</div><div class="line">	<span class="comment">//CheckTokenEntity为自定义的dto</span></div><div class="line">       Assert.notNull(checkTokenEntity, <span class="string">"invalid token entity!"</span>);</div><div class="line">       <span class="comment">//识别token</span></div><div class="line">       OAuth2AccessToken token = resourceServerTokenServices.readAccessToken(checkTokenEntity.getToken());</div><div class="line">	<span class="comment">//判断token是否为空</span></div><div class="line">       <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> InvalidTokenException(<span class="string">"Token was not recognised"</span>);</div><div class="line">       &#125;</div><div class="line">	<span class="comment">//未过期</span></div><div class="line">       <span class="keyword">if</span> (token.isExpired()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> InvalidTokenException(<span class="string">"Token has expired"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//加载OAuth2Authentication</span></div><div class="line">       OAuth2Authentication authentication = resourceServerTokenServices.loadAuthentication(token.getValue());</div><div class="line">	<span class="comment">//获取response，token合法性验证完毕</span></div><div class="line">       Map&lt;String, Object&gt; response = (Map&lt;String, Object&gt;) accessTokenConverter.convertAccessToken(token, authentication);</div><div class="line"></div><div class="line">       <span class="comment">//check for api permission</span></div><div class="line">       <span class="keyword">if</span> (response.containsKey(<span class="string">"jti"</span>)) &#123;</div><div class="line">       	<span class="comment">//上下文操作权限校验</span></div><div class="line">           Assert.isTrue(checkPermissions.checkPermission(checkTokenEntity));</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       response.put(<span class="string">"active"</span>, <span class="keyword">true</span>);    <span class="comment">// Always true if token exists and not expired</span></div><div class="line"></div><div class="line">       <span class="keyword">return</span> response;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>看过security-oauth源码的同学可能立马就看出上述代码与源码不同，熟悉<code>/oauth/check_token</code>校验流程的也会看出来，这边笔者对<code>security-oauth</code> jar进行了重新编译，修改了部分源码用于该项目需求的场景。主要是加入了前置的API级别的权限校验。</p>
<h2 id="4-token-合法性验证"><a href="#4-token-合法性验证" class="headerlink" title="4. token 合法性验证"></a>4. token 合法性验证</h2><p>从上面的<code>CheckTokenEndpoint</code>中可以看出，对于token合法性验证首先是识别请求体中的token。用到的主要方法是<code>ResourceServerTokenServices</code>提供的<code>readAccessToken()</code>方法。该接口的实现类为<code>DefaultTokenServices</code>，在之前的配置中有讲过这边配置了jdbc的TokenStore。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTokenStore</span> <span class="keyword">implements</span> <span class="title">TokenStore</span> </span>&#123;</div><div class="line">	...</div><div class="line">	<span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">readAccessToken</span><span class="params">(String tokenValue)</span> </span>&#123;</div><div class="line">		OAuth2AccessToken accessToken = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//使用selectAccessTokenSql语句，调用了私有的extractTokenKey()方法</span></div><div class="line">			accessToken = jdbcTemplate.queryForObject(selectAccessTokenSql, <span class="keyword">new</span> RowMapper&lt;OAuth2AccessToken&gt;() &#123;</div><div class="line">				<span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">mapRow</span><span class="params">(ResultSet rs, <span class="keyword">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">					<span class="keyword">return</span> deserializeAccessToken(rs.getBytes(<span class="number">2</span>));</div><div class="line">				&#125;</div><div class="line">			&#125;, extractTokenKey(tokenValue));</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//异常情况</span></div><div class="line">		<span class="keyword">catch</span> (EmptyResultDataAccessException e) &#123;</div><div class="line">			<span class="keyword">if</span> (LOG.isInfoEnabled()) &#123;</div><div class="line">				LOG.info(<span class="string">"Failed to find access token for token "</span> + tokenValue);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">			LOG.warn(<span class="string">"Failed to deserialize access token for "</span> + tokenValue, e);</div><div class="line">			<span class="comment">//不合法则移除</span></div><div class="line">			removeAccessToken(tokenValue);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> accessToken;</div><div class="line">	&#125;</div><div class="line">	...</div><div class="line">	<span class="comment">//提取TokenKey方法</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> String <span class="title">extractTokenKey</span><span class="params">(String value)</span> </span>&#123;</div><div class="line">		<span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		MessageDigest digest;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//MD5</span></div><div class="line">			digest = MessageDigest.getInstance(<span class="string">"MD5"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"MD5 algorithm not available.  Fatal (should be in the JDK)."</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">byte</span>[] bytes = digest.digest(value.getBytes(<span class="string">"UTF-8"</span>));</div><div class="line">			<span class="keyword">return</span> String.format(<span class="string">"%032x"</span>, <span class="keyword">new</span> BigInteger(<span class="number">1</span>, bytes));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"UTF-8 encoding not available.  Fatal (should be in the JDK)."</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>readAccessToken()</code>检索出该token值的完整信息。上述代码比较简单，涉及到的逻辑也不复杂，此处简单讲解。下图为debug token校验的变量信息，读者可以自己动手操作下，截图仅供参考。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/checktoken.png" alt="token" title="debug token校验"></p>
<p>至于后面的步骤，<code>loadAuthentication()</code>为特定的access token 加载credentials。得到的credentials 与token作为<code>convertAccessToken()</code>参数，得到校验token的response。</p>
<h2 id="5-API级别权限校验"><a href="#5-API级别权限校验" class="headerlink" title="5. API级别权限校验"></a>5. API级别权限校验</h2><p>笔者项目目前都是基于Web的权限验证，之前遗留的一个巨大的单体应用系统正在逐渐拆分，然而当前又不能完全拆分完善。为了同时兼容新旧服务，尽量减少对业务系统的入侵，实现微服务的统一性和独立性。笔者根据业务业务场景，尝试在Auth处做操作权限校验。<br>首先想到的是资源服务器配置ResourceServer，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http.authorizeRequests()</div><div class="line">.antMatchers(&quot;/order/**&quot;).access(&quot;#oauth2.hasScope(&apos;select&apos;) and hasRole(&apos;ROLE_USER&apos;)&quot;)</div></pre></td></tr></table></figure>
<p>这样做需要将每个操作接口的API权限控制放在各个不同的业务服务，每个服务在接收到请求后，需要先从Auth服务取出该token 对应的role和scope等权限信息。这个方法肯定是可行的，但是由于项目鉴权的粒度更细，而且暂时不想大动原有系统，在加上之前网关设计，网关调用Auth服务校验token合法性，所以最后决定在Auth系统调用中，把这些校验一起解决完。   </p>
<p>文章开头资源服务器的配置代码可以看出，对于所有的资源并没有做拦截，因为网关处是调用Auth系统的相关endpoint，并不是所有的请求url都会经过一遍Auth系统，所以对于所有的资源，在Auth系统中，定义需要鉴权接口所需要的API权限，然后根据上下文进行匹配。这是采用的第二种方式，也是笔者目前采用的方法。当然这种方式的弊端也很明显，一旦并发量大，网关还要耗时在调用Auth系统的鉴权上，TPS势必要下降很多，对于一些不需要鉴权的服务接口也会引起不可用。另外一点是，对于某些特殊权限的接口，需要的上下文信息很多，可能并不能完全覆盖，对于此，笔者的解决是分两方面：一是尽量将这些特殊情况进行分类，某一类的情况统一解决；二是将严苛的校验降低，对于上下文校验失败的直接拒绝，而通过的，对于某些接口，在接口内进行操作之前，对特殊的地方还要再次进行校验。</p>
<p>上面在讲endpoint有提到这边对源码进行了改写。<code>CheckTokenEntity</code>是自定义的DTO，这这个类中定义了鉴权需要的上下文，这里是指能校验操作权限的最小集合，如URI、roleId、affairId等等。另外定义了<code>CheckPermissions</code>接口，其方法<code>checkPermission(CheckTokenEntity checkTokenEntity)</code>返回了check的结果。而其具体实现类则定义在Auth系统中。笔者项目中调用的实例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomCheckPermission</span> <span class="keyword">implements</span> <span class="title">CheckPermissions</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> PermissionService permissionService;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPermission</span><span class="params">(CheckTokenEntity checkTokenEntity)</span> </span>&#123;</div><div class="line">        String url = checkTokenEntity.getUri();</div><div class="line">        Long affairId = checkTokenEntity.getAffairId();</div><div class="line">        Long roleId = checkTokenEntity.getRoleId();</div><div class="line">        <span class="comment">//校验</span></div><div class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(url) || affairId &lt;= <span class="number">0</span> || roleId &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> permissionService.checkPermission(url, affairId, roleId);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于jar包<code>spring-cloud-starter-oauth2</code>中的具体修改内容，大家可以看下文末笔者的GitHub项目。通过自定义<code>CustomCheckPermission</code>，覆写<code>checkPermission()</code>方法，大家也可以对自己业务的操作权限进行校验，非常灵活。这边涉及到具体业务，笔者在项目中只提供接口，具体的实现需要读者自行完成。</p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>本文相对来说比较简单，主要讲解了token以及API级别的鉴权。token的合法性认证很常规，Auth系统对于API级别的鉴权是结合自身业务需要和现状进行的设计。这两块的校验都前置到Auth系统中，优缺点在上面的小节也有讲述。最后，架构设计根据自己的需求和现状，笔者的解决思路仅供参考。</p>
<p><strong>本文的源码地址：<br>GitHub：<a href="https://github.com/keets2012/Auth-service" target="_blank" rel="external">https://github.com/keets2012/Auth-service</a><br>码云： <a href="https://gitee.com/keets/Auth-Service" target="_blank" rel="external">https://gitee.com/keets/Auth-Service</a></strong></p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://blog.csdn.net/OmniStack/article/details/77881185?locationNum=10&amp;fps=1" target="_blank" rel="external">微服务API级权限的技术架构</a></li>
<li><a href="http://projects.spring.io/spring-security-oauth/docs/oauth2.html" target="_blank" rel="external">spring-security-oauth</a></li>
<li><a href="http://projects.spring.io/spring-security/" target="_blank" rel="external">Spring-Security Docs</a></li>
</ol>
<h3 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h3><p><a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现（一）</a><br><a href="http://blueskykong.com/2017/10/22/security2/">认证鉴权与API权限控制在微服务架构中的设计与实现（二）</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/10/24/security3/" data-id="cja25cxit001eff6qwyi9pb9v" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-security2" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/22/security2/">认证鉴权与API权限控制在微服务架构中的设计与实现（二）</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/22/security2/">
            <time datetime="2017-10-21T16:00:00.000Z" itemprop="datePublished">2017-10-22</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Security/">Security</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OAuth2/">OAuth2</a>, <a class="tag-link" href="/tags/Spring-Security/">Spring Security</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><p>引言： 本文系《认证鉴权与API权限控制在微服务架构中的设计与实现》系列的第二篇，本文重点讲解用户身份的认证与token发放的具体实现。本文篇幅较长，对涉及到的大部分代码进行了分析，可收藏于闲暇时间阅读，欢迎订阅本系列文章。<br></p>
            <p class="article-more-link">
                <a href="/2017/10/22/security2/#more">Read More</a>
            </p>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/10/22/security2/" data-id="cja25cxio0019ff6q71fuv4op" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-nsq" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/08/nsq/">消息中间件NSQ深入与实践</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/08/nsq/">
            <time datetime="2017-10-07T16:00:00.000Z" itemprop="datePublished">2017-10-08</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/中间件/">中间件</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Cluster/">Cluster</a>, <a class="tag-link" href="/tags/mq/">mq</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><p>最近在研究一些消息中间件，常用的MQ如RabbitMQ,ActiveMQ,Kafka等。NSQ是一个基于Go语言的分布式实时消息平台，它基于MIT开源协议发布，由bitly公司开源出来的一款简单易用的消息中间件。<br>官方和第三方还为NSQ开发了众多客户端功能库，如官方提供的基于HTTP的nsqd、Go客户端go-nsq、Python客户端pynsq、基于Node.js的JavaScript客户端nsqjs、异步C客户端libnsq、Java客户端nsq-java以及基于各种语言的众多第三方客户端功能库。</p>
<h3 id="1-1-Features"><a href="#1-1-Features" class="headerlink" title="1.1 Features"></a>1.1 Features</h3><p>1). Distributed<br>NSQ提供了分布式的，去中心化，且没有单点故障的拓扑结构，稳定的消息传输发布保障，能够具有高容错和HA（高可用）特性。<br>2). Scalable易于扩展<br>NSQ支持水平扩展，没有中心化的brokers。内置的发现服务简化了在集群中增加节点。同时支持pub-sub和load-balanced 的消息分发。<br>3). Ops Friendly<br>NSQ非常容易配置和部署，生来就绑定了一个管理界面。二进制包没有运行时依赖。官方有Docker image。<br>4.Integrated高度集成<br>官方的 Go 和 Python库都有提供。而且为大多数语言提供了库。</p>
<h3 id="1-2-组件"><a href="#1-2-组件" class="headerlink" title="1.2 组件"></a>1.2 组件</h3><ul>
<li>Topic ：一个topic就是程序发布消息的一个逻辑键，当程序第一次发布消息时就会创建topic。</li>
<li>Channels ：channel与消费者相关，是消费者之间的负载均衡，channel在某种意义上来说是一个“队列”。每当一个发布者发送一条消息到一个topic，消息会被复制到所有消费者连接的channel上，消费者通过这个特殊的channel读取消息，实际上，在消费者第一次订阅时就会创建channel。Channel会将消息进行排列，如果没有消费者读取消息，消息首先会在内存中排队，当量太大时就会被保存到磁盘中。</li>
<li>Messages：消息构成了我们数据流的中坚力量，消费者可以选择结束消息，表明它们正在被正常处理，或者重新将他们排队待到后面再进行处理。每个消息包含传递尝试的次数，当消息传递超过一定的阀值次数时，我们应该放弃这些消息，或者作为额外消息进行处理。</li>
<li>nsqd：nsqd 是一个守护进程，负责接收，排队，投递消息给客户端。它可以独立运行，不过通常它是由 nsqlookupd 实例所在集群配置的（它在这能声明 topics 和 channels，以便大家能找到）。</li>
<li>nsqlookupd：nsqlookupd 是守护进程负责管理拓扑信息。客户端通过查询 nsqlookupd 来发现指定话题（topic）的生产者，并且 nsqd 节点广播话题（topic）和通道（channel）信息。有两个接口：TCP 接口，nsqd 用它来广播。HTTP 接口，客户端用它来发现和管理。</li>
<li>nsqadmin：nsqadmin 是一套 WEB UI，用来汇集集群的实时统计，并执行不同的管理任务。   </li>
</ul>
<p>常用工具类：   </p>
<ul>
<li>nsq_to _file：消费指定的话题（topic）/通道（channel），并写到文件中，有选择的滚动和/或压缩文件。</li>
<li>nsq_to _http：消费指定的话题（topic）/通道（channel）和执行 HTTP requests (GET/POST) 到指定的端点。</li>
<li>nsq_to _nsq：消费者指定的话题/通道和重发布消息到目的地 nsqd 通过 TCP。</li>
</ul>
<h3 id="1-3-拓扑结构"><a href="#1-3-拓扑结构" class="headerlink" title="1.3 拓扑结构"></a>1.3 拓扑结构</h3><p>NSQ推荐通过他们相应的nsqd实例使用协同定位发布者，这意味着即使面对网络分区，消息也会被保存在本地，直到它们被一个消费者读取。更重要的是，发布者不必去发现其他的nsqd节点，他们总是可以向本地实例发布消息。</p>
<p><img src="http://img.blog.csdn.net/20160826111341466?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="NSQ" title="NSQ架构图"></p>
<p>首先，一个发布者向它的本地nsqd发送消息，要做到这点，首先要先打开一个连接，然后发送一个包含topic和消息主体的发布命令，在这种情况下，我们将消息发布到事件topic上以分散到我们不同的worker中。<br>事件topic会复制这些消息并且在每一个连接topic的channel上进行排队，在我们的案例中，有三个channel，它们其中之一作为档案channel。消费者会获取这些消息并且上传到S3。<br><img src="http://img.blog.csdn.net/20160826111352576?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="nsqd" title="nsqd"></p>
<p>每个channel的消息都会进行排队，直到一个worker把他们消费，如果此队列超出了内存限制，消息将会被写入到磁盘中。Nsqd节点首先会向nsqlookup广播他们的位置信息，一旦它们注册成功，worker将会从nsqlookup服务器节点上发现所有包含事件topic的nsqd节点。</p>
<p><img src="http://img.blog.csdn.net/20160826111503569?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="nsqlookupd" title="nsqlookupd"></p>
<p>然后每个worker向每个nsqd主机进行订阅操作，用于表明worker已经准备好接受消息了。这里我们不需要一个完整的连通图，但我们必须要保证每个单独的nsqd实例拥有足够的消费者去消费它们的消息，否则channel会被队列堆着。</p>
<h2 id="2-Internals"><a href="#2-Internals" class="headerlink" title="2. Internals"></a>2. Internals</h2><h3 id="2-1-消息传递担保"><a href="#2-1-消息传递担保" class="headerlink" title="2.1 消息传递担保"></a>2.1 消息传递担保</h3><p>NSQ 保证消息将交付至少一次，虽然消息可能是重复的。消费者应该关注到这一点，删除重复数据或执行idempotent等操作。<br>这个担保是作为协议和工作流的一部分，工作原理如下（假设客户端成功连接并订阅一个话题）：<br>1）客户表示已经准备好接收消息<br>2）NSQ 发送一条消息，并暂时将数据存储在本地（在 re-queue 或 timeout）<br>3）客户端回复 FIN（结束）或 REQ（重新排队）分别指示成功或失败。如果客户端没有回复, NSQ 会在设定的时间超时，自动重新排队消息<br>这确保了消息丢失唯一可能的情况是不正常结束 nsqd 进程。在这种情况下，这是在内存中的任何信息（或任何缓冲未刷新到磁盘）都将丢失。<br>如何防止消息丢失是最重要的，即使是这个意外情况可以得到缓解。一种解决方案是构成冗余 nsqd对（在不同的主机上）接收消息的相同部分的副本。因为你实现的消费者是幂等的，以两倍时间处理这些消息不会对下游造成影响，并使得系统能够承受任何单一节点故障而不会丢失信息。</p>
<h3 id="2-2-简化配置和管理"><a href="#2-2-简化配置和管理" class="headerlink" title="2.2 简化配置和管理"></a>2.2 简化配置和管理</h3><p>单个 nsqd 实例被设计成可以同时处理多个数据流。流被称为“话题”和话题有 1 个或多个“通道”。每个通道都接收到一个话题中所有消息的拷贝。在实践中，一个通道映射到下行服务消费一个话题。<br>话题和通道都没有预先配置。话题由第一次发布消息到命名的话题或第一次通过订阅一个命名话题来创建。通道被第一次订阅到指定的通道创建。话题和通道的所有缓冲的数据相互独立，防止缓慢消费者造成对其他通道的积压（同样适用于话题级别）。<br>一个通道一般会有多个客户端连接。假设所有已连接的客户端处于准备接收消息的状态，每个消息将被传递到一个随机的客户端。nsqlookupd，它提供了一个目录服务，消费者可以查找到提供他们感兴趣订阅话题的 nsqd 地址 。在配置方面，把消费者与生产者解耦开（它们都分别只需要知道哪里去连接 nsqlookupd 的共同实例，而不是对方），降低复杂性和维护。<br>在更底的层面，每个 nsqd 有一个与 nsqlookupd 的长期 TCP 连接，定期推动其状态。这个数据被 nsqlookupd 用于给消费者通知 nsqd 地址。对于消费者来说，一个暴露的 HTTP /lookup 接口用于轮询。为话题引入一个新的消费者，只需启动一个配置了 nsqlookup 实例地址的 NSQ 客户端。无需为添加任何新的消费者或生产者更改配置，大大降低了开销和复杂性。</p>
<h3 id="2-3-消除单点故障"><a href="#2-3-消除单点故障" class="headerlink" title="2.3 消除单点故障"></a>2.3 消除单点故障</h3><p>NSQ被设计以分布的方式被使用。nsqd 客户端（通过 TCP ）连接到指定话题的所有生产者实例。没有中间人，没有消息代理，也没有单点故障。<br>这种拓扑结构消除单链，聚合，反馈。相反，你的消费者直接访问所有生产者。从技术上讲，哪个客户端连接到哪个 NSQ 不重要，只要有足够的消费者连接到所有生产者，以满足大量的消息，保证所有东西最终将被处理。对于 nsqlookupd，高可用性是通过运行多个实例来实现。他们不直接相互通信和数据被认为是最终一致。消费者轮询所有的配置的 nsqlookupd 实例和合并 response。失败的，无法访问的，或以其他方式故障的节点不会让系统陷于停顿。</p>
<h3 id="2-4-效率"><a href="#2-4-效率" class="headerlink" title="2.4 效率"></a>2.4 效率</h3><p>对于数据的协议，通过推送数据到客户端最大限度地提高性能和吞吐量的，而不是等待客户端拉数据。这个概念，称之为 RDY 状态，基本上是客户端流量控制的一种形式。<br>当客户端连接到 nsqd 和并订阅到一个通道时，它被放置在一个 RDY 为 0 状态。这意味着，还没有信息被发送到客户端。当客户端已准备好接收消息发送，更新它的命令 RDY 状态到它准备处理的数量，比如 100。无需任何额外的指令，当 100 条消息可用时，将被传递到客户端（服务器端为那个客户端每次递减 RDY 计数）。客户端库的被设计成在 RDY 数达到配置 max-in-flight<br> 的 25% 发送一个命令来更新 RDY 计数（并适当考虑连接到多个 nsqd 情况下，适当地分配）。<br> <img src="http://img.blog.csdn.net/20160826111400116?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="efficiency" title="efficiency"></p>
<h3 id="2-5-心跳和超时"><a href="#2-5-心跳和超时" class="headerlink" title="2.5 心跳和超时"></a>2.5 心跳和超时</h3><p>NSQ 的 TCP 协议是面向 push 的。在建立连接，握手，和订阅后，消费者被放置在一个为 0 的 RDY 状态。当消费者准备好接收消息，它更新的 RDY 状态到准备接收消息的数量。NSQ 客户端库不断在幕后管理，消息控制流的结果。每隔一段时间，nsqd 将发送一个心跳线连接。客户端可以配置心跳之间的间隔，但 nsqd 会期待一个回应在它发送下一个心掉之前。<br>组合应用级别的心跳和 RDY 状态，避免头阻塞现象，也可能使心跳无用（即，如果消费者是在后面的处理消息流的接收缓冲区中，操作系统将被填满，堵心跳）为了保证进度，所有的网络 IO 时间上限势必与配置的心跳间隔相关联。这意味着，你可以从字面上拔掉之间的网络连接 nsqd 和消费者，它会检测并正确处理错误。当检测到一个致命错误，客户端连接被强制关闭。在传输中的消息会超时而重新排队等待传递到另一个消费者。最后，错误会被记录并累计到各种内部指标。</p>
<h3 id="2-6-分布式"><a href="#2-6-分布式" class="headerlink" title="2.6 分布式"></a>2.6 分布式</h3><p>因为NSQ没有在守护程序之间共享信息，所以它从一开始就是为了分布式操作而生。个别的机器可以随便宕机随便启动而不会影响到系统的其余部分，消息发布者可以在本地发布，即使面对网络分区。<br>这种“分布式优先”的设计理念意味着NSQ基本上可以永远不断地扩展，需要更高的吞吐量？那就添加更多的nsqd吧。唯一的共享状态就是保存在lookup节点上，甚至它们不需要全局视图，配置某些nsqd注册到某些lookup节点上这是很简单的配置，唯一关键的地方就是消费者可以通过lookup节点获取所有完整的节点集。清晰的故障事件——NSQ在组件内建立了一套明确关于可能导致故障的的故障权衡机制，这对消息传递和恢复都有意义。虽然它们可能不像Kafka系统那样提供严格的保证级别，但NSQ简单的操作使故障情况非常明显。</p>
<h3 id="2-7-no-replication"><a href="#2-7-no-replication" class="headerlink" title="2.7 no replication"></a>2.7 no replication</h3><p>不像其他的队列组件，NSQ并没有提供任何形式的复制和集群，也正是这点让它能够如此简单地运行，但它确实对于一些高保证性高可靠性的消息发布没有足够的保证。我们可以通过降低文件同步的时间来部分避免，只需通过一个标志配置，通过EBS支持我们的队列。但是这样仍然存在一个消息被发布后马上死亡，丢失了有效的写入的情况。</p>
<h3 id="2-8-没有严格的顺序"><a href="#2-8-没有严格的顺序" class="headerlink" title="2.8 没有严格的顺序"></a>2.8 没有严格的顺序</h3><p>虽然Kafka由一个有序的日志构成，但NSQ不是。消息可以在任何时间以任何顺序进入队列。在我们使用的案例中，这通常没有关系，因为所有的数据都被加上了时间戳，但它并不适合需要严格顺序的情况。</p>
<h3 id="2-9-无数据重复删除功能"><a href="#2-9-无数据重复删除功能" class="headerlink" title="2.9 无数据重复删除功能"></a>2.9 无数据重复删除功能</h3><p>NSQ对于超时系统，它使用了心跳检测机制去测试消费者是否存活还是死亡。很多原因会导致我们的consumer无法完成心跳检测，所以在consumer中必须有一个单独的步骤确保幂等性。</p>
<h2 id="3-实践安装过程"><a href="#3-实践安装过程" class="headerlink" title="3. 实践安装过程"></a>3. 实践安装过程</h2><p>本文将nsq集群具体的安装过程略去，大家可以自行参考官网，比较简单。这部分介绍下笔者实验的拓扑，以及nsqadmin的相关信息。</p>
<h3 id="3-1-拓扑结构"><a href="#3-1-拓扑结构" class="headerlink" title="3.1 拓扑结构"></a>3.1 拓扑结构</h3><p><img src="http://img.blog.csdn.net/20160826111454156?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="topology" title="topology"></p>
<p>实验采用3台NSQD服务，2台LOOKUPD服务。<br>采用官方推荐的拓扑，消息发布的服务和NSQD在一台主机。一共5台机器。<br>NSQ基本没有配置文件，配置通过命令行指定参数。<br>主要命令如下:<br>LOOKUPD命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/nsqlookupd</div></pre></td></tr></table></figure>
<p>NSQD命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/nsqd --lookupd-tcp-address=172.16.30.254:4160 -broadcast-address=172.16.30.254</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/nsqadmin --lookupd-http-address=172.16.30.254:4161</div></pre></td></tr></table></figure>
<p>工具类，消费后存储到本地文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/nsq_to_file --topic=newtest --channel=<span class="built_in">test</span> --output-dir=/tmp --lookupd-http-address=172.16.30.254:4161</div></pre></td></tr></table></figure>
<p>发布一条消息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -d <span class="string">'hello world 5'</span> <span class="string">'http://172.16.30.254:4151/put?topic=test'</span></div></pre></td></tr></table></figure></p>
<h3 id="3-2-nsqadmin"><a href="#3-2-nsqadmin" class="headerlink" title="3.2 nsqadmin"></a>3.2 nsqadmin</h3><p>对Streams的详细信息进行查看，包括NSQD节点，具体的channel，队列中的消息数，连接数等信息。<br><img src="http://img.blog.csdn.net/20160826111409561?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="nsqadmin" title="nsqadmin"> </p>
<p><img src="http://img.blog.csdn.net/20160826111419178?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="channel" title="nsqadmin channel"></p>
<p>列出所有的NSQD节点:<br><img src="http://img.blog.csdn.net/20160826111429053?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="nodes" title="nodes"></p>
<p>消息的统计:<br><img src="http://img.blog.csdn.net/20160826111437210?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="msgs" title="msgs"></p>
<p>lookup主机的列表:<br><img src="http://img.blog.csdn.net/20160826111444499?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="hosts" title="hosts"></p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>NSQ基本核心就是简单性，是一个简单的队列，这意味着它很容易进行故障推理和很容易发现bug。消费者可以自行处理故障事件而不会影响系统剩下的其余部分。   </p>
<p>事实上，简单性是我们决定使用NSQ的首要因素，这方便与我们的许多其他软件一起维护，通过引入队列使我们得到了堪称完美的表现，通过队列甚至让我们增加了几个数量级的吞吐量。越来越多的consumer需要一套严格可靠性和顺序性保障，这已经超过了NSQ提供的简单功能。 </p>
<p>结合我们的业务系统来看，对于我们所需要传输的发票消息，相对比较敏感，无法容忍某个nsqd宕机，或者磁盘无法使用的情况，该节点堆积的消息无法找回。这是我们没有选择该消息中间件的主要原因。简单性和可靠性似乎并不能完全满足。相比Kafka，ops肩负起更多负责的运营。另一方面，它拥有一个可复制的、有序的日志可以提供给我们更好的服务。但对于其他适合NSQ的consumer，它为我们服务的相当好，我们期待着继续巩固它的坚实的基础。   </p>
<hr>
<p>ps: 本文首发于笔者的csdn博客，此处将其加入个人的博客。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://www.infoq.com/cn/news/2015/02/nsq-distributed-message-platform/" target="_blank" rel="external">NSQ：分布式的实时消息平台</a></li>
<li><a href="https://speakerdeck.com/snakes/nsq-nyc-golang-meetup" target="_blank" rel="external">NSQ - NYC Golang Meetup</a></li>
<li><a href="http://nsq.io/" target="_blank" rel="external">NSQ Docs</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/10/08/nsq/" data-id="cja25cxil0011ff6q83lq9hrt" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-lombok" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/06/lombok/">Lombok使用与原理</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/06/lombok/">
            <time datetime="2017-10-05T16:00:00.000Z" itemprop="datePublished">2017-10-06</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Utils/">Utils</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Lombok/">Lombok</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-Lombok简介"><a href="#1-Lombok简介" class="headerlink" title="1. Lombok简介"></a>1. Lombok简介</h2><p>首先<code>Lombok</code>是一款Java IDE的应用工具插件，一个可以通过简单的注解形式来帮助我们简化消除一些必须有但显得很臃肿的Java代码的工具，比如属性的构造器、getter、setter、equals、hashcode、toString方法。结合IDE，通过使用对应的注解，可以在编译源码的时候生成对应的方法。官方地址：<code>https://projectlombok.org/</code>。    </p>
<p>虽然上述的那些常用方法IDE都能生成，但是lombok更加简洁与方便，能够达到的效果就是在源码中不需要写一些通用的方法，但是在编译生成的字节码文件中会帮我们生成这些方法，这就是lombok的神奇作用。</p>
<h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h2><h3 id="2-1-插件安装"><a href="#2-1-插件安装" class="headerlink" title="2.1 插件安装"></a>2.1 插件安装</h3><p>笔者主要使用的IDE是Intellij idea，编译器需要在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">preference-&gt;plugins-&gt;Browse repositories</div></pre></td></tr></table></figure>
<p>搜索lombok，然后安装plugins，需要稍等片刻。笔者截图已经安装好。<br><img src="http://ovcjgn2x0.bkt.clouddn.com/lombok.png" alt="lombok" title="lombok插件"></p>
<h3 id="2-2-添加jar包"><a href="#2-2-添加jar包" class="headerlink" title="2.2 添加jar包"></a>2.2 添加jar包</h3><p>在项目中添加lombok的jar包，笔者用的是maven，所以在pom文件中添加了如下的依赖。gradle使用见官网。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;lombok&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;1.16.16&lt;/version&gt;</div><div class="line">    &lt;scope&gt;provided&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h2><p>lombok主要通过注解起作用，详细的注解见<a href="https://projectlombok.org/features/all" target="_blank" rel="external">Lombok features</a>。   </p>
<p>With Lombok:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</div><div class="line"><span class="keyword">import</span> lombok.Data;</div><div class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.Serializable;</div><div class="line"></div><div class="line"><span class="meta">@Data</span></div><div class="line"><span class="meta">@AllArgsConstructor</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userId;</div><div class="line">    <span class="keyword">private</span> String userName;</div><div class="line">    <span class="keyword">private</span> String sex;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译后：   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.beans.ConstructorProperties;</div><div class="line"><span class="keyword">import</span> java.io.Serializable;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> userId;</div><div class="line">    <span class="keyword">private</span> String userName;</div><div class="line">    <span class="keyword">private</span> String sex;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUserId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sex;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserId</span><span class="params">(<span class="keyword">long</span> userId)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.userId = userId;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.userName = userName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.sex = sex;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(o == <span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!(o <span class="keyword">instanceof</span> UserEntity)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            UserEntity other = (UserEntity)o;</div><div class="line">            <span class="keyword">if</span>(!other.canEqual(<span class="keyword">this</span>)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.getUserId() != other.getUserId()) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Object <span class="keyword">this</span>$userName = <span class="keyword">this</span>.getUserName();</div><div class="line">                Object other$userName = other.getUserName();</div><div class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>$userName == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span>(other$userName != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">this</span>$userName.equals(other$userName)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Object <span class="keyword">this</span>$sex = <span class="keyword">this</span>.getSex();</div><div class="line">                Object other$sex = other.getSex();</div><div class="line">                <span class="keyword">if</span>(<span class="keyword">this</span>$sex == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span>(other$sex != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">this</span>$sex.equals(other$sex)) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">canEqual</span><span class="params">(Object other)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> other <span class="keyword">instanceof</span> UserEntity;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> PRIME = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">int</span> result = <span class="number">1</span>;</div><div class="line">        <span class="keyword">long</span> $userId = <span class="keyword">this</span>.getUserId();</div><div class="line">        <span class="keyword">int</span> result = result * <span class="number">59</span> + (<span class="keyword">int</span>)($userId &gt;&gt;&gt; <span class="number">32</span> ^ $userId);</div><div class="line">        Object $userName = <span class="keyword">this</span>.getUserName();</div><div class="line">        result = result * <span class="number">59</span> + ($userName == <span class="keyword">null</span>?<span class="number">43</span>:$userName.hashCode());</div><div class="line">        Object $sex = <span class="keyword">this</span>.getSex();</div><div class="line">        result = result * <span class="number">59</span> + ($sex == <span class="keyword">null</span>?<span class="number">43</span>:$sex.hashCode());</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"UserEntity(userId="</span> + <span class="keyword">this</span>.getUserId() + <span class="string">", userName="</span> + <span class="keyword">this</span>.getUserName() + <span class="string">", sex="</span> + <span class="keyword">this</span>.getSex() + <span class="string">")"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@ConstructorProperties</span>(&#123;<span class="string">"userId"</span>, <span class="string">"userName"</span>, <span class="string">"sex"</span>&#125;)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserEntity</span><span class="params">(<span class="keyword">long</span> userId, String userName, String sex)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.userId = userId;</div><div class="line">        <span class="keyword">this</span>.userName = userName;</div><div class="line">        <span class="keyword">this</span>.sex = sex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这边介绍笔者经常使用到的注解。</p>
<ul>
<li><p>val，用在局部变量前面，相当于将变量声明为final</p>
</li>
<li><p>@Value<br>用在类上，是@Data的不可变形式，相当于为属性添加final声明，只提供getter方法，而不提供setter方法</p>
</li>
<li><p>@Data<br>@ToString, @EqualsAndHashCode, 所有属性的@Getter, 所有non-final属性的@Setter和@RequiredArgsConstructor的组合，通常情况下，我们使用这个注解就足够了。</p>
</li>
</ul>
<ul>
<li><p>@NoArgsConstructor无参构造器</p>
</li>
<li><p>@AllArgsConstructor全参构造器</p>
</li>
<li><p>@ToString<br> 生成toString方法，默认情况下，会输出类名、所有属性，属性会按照顺序输出，以逗号分割。
 </p>
</li>
<li><p>@EqualsAndHashCode<br>默认情况下，会使用所有非瞬态(non-transient)和非静态(non-static)字段来生成equals和hascode方法，也可以指定具体使用哪些属性。</p>
</li>
<li><p>@Getter / @Setter<br>上面已经说过，一般用@data就不用额外加这个注解了。可以作用在类上和属性上，放在类上，会对所有的非静态(non-static)属性生成Getter/Setter方法，放在属性上，会对该属性生成Getter/Setter方法。并可以指定Getter/Setter方法的访问级别。</p>
</li>
<li><p>@NonNull，给方法参数增加这个注解会自动在方法内对该参数进行是否为空的校验，如果为空，则抛出NPE（NullPointerException）</p>
</li>
<li><p>@Cleanup<br>自动管理资源，用在局部变量之前，在当前变量范围内即将执行完毕退出之前会自动清理资源，自动生成try-finally这样的代码来关闭流</p>
</li>
<li><p>@Log<br>根据不同的注解生成不同类型的log对象，但是实例名称都是log，有7种可选实现类：   </p>
<p>  1). @Log4j</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.log4j.Logger log = org.apache.log4j.Logger.getLogger(LogExample.class);</div></pre></td></tr></table></figure>
<p>  2). @Log4j2</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.logging.log4j.Logger log = org.apache.logging.log4j.LogManager.getLogger(LogExample.class);</div></pre></td></tr></table></figure>
<p>  3). @Slf4j</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(LogExample.class);</div></pre></td></tr></table></figure>
<p>  4). @XSlf4j</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.ext.XLogger log = org.slf4j.ext.XLoggerFactory.getXLogger(LogExample.class);</div></pre></td></tr></table></figure>
<p>  5). @CommonsLog</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.apache.commons.logging.Log log = org.apache.commons.logging.LogFactory.getLog(LogExample.class);</div></pre></td></tr></table></figure>
<p>  6). @JBossLog</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.jboss.logging.Logger log = org.jboss.logging.Logger.getLogger(LogExample.class);</div></pre></td></tr></table></figure>
<p>  7). @Log</p>
<pre><code class="java"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.util.logging.Logger log = java.util.logging.Logger.getLogger(LogExample.class.getName());
</code></pre>
<p>  默认情况下，logger的名字将会是被@Log注解的那个类的名字。当然这也可以被个性化命名，通过topic参数，如<code>@XSlf4j(topic=&quot;reporting&quot;)</code>。</p>
</li>
</ul>
<h2 id="4-原理"><a href="#4-原理" class="headerlink" title="4. 原理"></a>4. 原理</h2><p>lombok 主要通过注解生效，自jdk5引入注解，由两种解析方式。<br>第一种是运行时解析，<code>@Retention(RetentionPolicy.RUNTIME)</code>, 定义注解的保留策略，这样可以通过反射拿到该注解。<br>另一种是编译时解析，有两种机制。</p>
<ul>
<li><p>Annotation Processing Tool，apt自JDK5产生，JDK7已标记为过期，不推荐使用，JDK8中已彻底删除，自JDK6开始，可以使用Pluggable Annotation Processing API来替换它，apt被替换主要有2点原因。api都在com.sun.mirror非标准包下，还有就是没有集成到javac中，需要额外运行。</p>
</li>
<li><p>Pluggable Annotation Processing API<br>lombok使用这种方式实现，基于JSR 269，自JDK6加入，作为apt的替代方案，它解决了apt的两个问题，javac在执行的时候会调用实现了该API的程序，这样我们就可以对编译器做一些增强，这时javac执行的过程如下：</p>
</li>
</ul>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/pap.png" alt="pap" title="javac执行流程"></p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>这篇文章主要讲解了lombok的入门与使用。介绍了一些常用的lombok注解，大大简化了我们的开发工作和代码的简洁性。当然，lombok不支持多种参数构造器的重载，工具毕竟是工具，我感觉并不会有非常完美适合每个人的工具。最后，我个人还是很推荐这款插件的，毕竟我很懒，😆。</p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://projectlombok.org/features/all" target="_blank" rel="external">Lombok Docs</a></li>
<li><a href="http://blog.csdn.net/ghsau/article/details/52334762" target="_blank" rel="external">Java奇淫巧技之Lombok</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/10/06/lombok/" data-id="cja25cxig000tff6qj7rb06pc" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-rediscluster" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/29/rediscluster/">Redis Cluster深入与实践</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/29/rediscluster/">
            <time datetime="2017-09-28T16:00:00.000Z" itemprop="datePublished">2017-09-29</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/中间件/">中间件</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/mq/">mq</a>, <a class="tag-link" href="/tags/redis/">redis</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-redis介绍"><a href="#1-redis介绍" class="headerlink" title="1. redis介绍"></a>1. redis介绍</h2><p><a href="www.redis.io">www.redis.io</a><br>redis是一个基于内存的K-V存储数据库。支持存储的类型有string,list,set,zset(sorted set),hash等。这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。redis支持各种不同方式的排序。保证效率的情况下，数据缓存在内存中。同时redis提供了持久化策略，不同的策略触发同步到磁盘或者把修改操作写入追加的记录文件，在此基础上实现了master-slave。   </p>
<p>它是一个高性能的存储系统，能支持超过 100K+ 每秒的读写频率。同时还支持消息的发布/订阅，从而让你在构建高性能消息队列系统时多了另一种选择。   </p>
<p>Redis支持主从同步。数据可以从主服务器向任意数量的从服务器上同步，从服务器可以是关联其他从服务器的主服务器。这使得Redis可执行单层树复制。存盘可以有意无意的对数据进行写操作。由于完全实现了发布/订阅机制，使得从数据库在任何地方同步树时，可订阅一个频道并接收主服务器完整的消息发布记录。同步对读取操作的可扩展性和数据冗余很有帮助。</p>
<h2 id="2-主从"><a href="#2-主从" class="headerlink" title="2. 主从"></a>2. 主从</h2><p>redis支持master-slave模式，一主多从，redis server可以设置另外多个redis server为slave，从机同步主机的数据。配置后，读写分离，主机负责读写服务，从机只负责读。减轻主机的压力。redis实现的是最终会一致性，具体选择强一致性还是弱一致性，取决于业务场景。<br>redis 主从同步有两种方式（或者所两个阶段）：全同步和部分同步。   </p>
<p>主从刚刚连接的时候，进行全同步；全同步结束后，进行部分同步。当然，如果有需要，slave 在任何时候都可以发起全同步。redis 策略是，无论如何，首先会尝试进行部分同步，如不成功，要求从机进行全同步，并启动 BGSAVE……BGSAVE 结束后，传输 RDB 文件；如果成功，允许从机进行部分同步，并传输积压空间中的数据。简单来说，主从同步就是 RDB 文件的上传下载；主机有小部分的数据修改，就把修改记录传播给每个从机。   </p>
<h2 id="3-redis集群"><a href="#3-redis集群" class="headerlink" title="3. redis集群"></a>3. redis集群</h2><p>主从模式存在的问题是，master宕机之后，从机只能读，不可写，不能保证高可用。redis集群技术是构建高性能网站架构的重要手段，试想在网站承受高并发访问压力的同时，还需要从海量数据中查询出满足条件的数据，并快速响应，我们必然想到的是将数据进行切片，把数据根据某种规则放入多个不同的服务器节点，来降低单节点服务器的压力。   </p>
<p>Redis Cluster采用无中心结构，每个节点保存数据和整个集群状态,每个节点都和其他所有节点连接。节点之间使用gossip协议传播信息以及发现新节点。  </p>
<p>Redis 集群是一个分布式（distributed）、容错（fault-tolerant）的 Redis 实现，集群可以使用的功能是普通单机 Redis 所能使用的功能的一个子集（subset）。  </p>
<p>Redis 集群中不存在中心（central）节点或者代理（proxy）节点，集群的其中一个主要设计目标是达到线性可扩展性（linear scalability）。   </p>
<p>Redis 集群为了保证一致性（consistency）而牺牲了一部分容错性：系统会在保证对网络断线（net split）和节点失效（node failure）具有有限（limited）抵抗力的前提下，尽可能地保持数据的一致性。   </p>
<h2 id="4-安装部署"><a href="#4-安装部署" class="headerlink" title="4. 安装部署"></a>4. 安装部署</h2><p>redis安装较为简单，官网下载压缩包解压。集群模式需要ruby的编译环境，集群最小的配置为3台master，小于3则启动集群报错。<br>redis版本：3.2.4   </p>
<h3 id="4-1-主从模式拓扑图"><a href="#4-1-主从模式拓扑图" class="headerlink" title="4.1 主从模式拓扑图"></a>4.1 主从模式拓扑图</h3><p><img src="http://img.blog.csdn.net/20161009145624869?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="主从模式拓扑图" title="主从模式拓扑图"></p>
<p>主从模式采用一主三从，主从都配置auth认证，读写分离。<br>主要实验的动作：<br>1）多个app 同时写，测定写速率；<br>2）多个app 同时写，同时有读的进程，测定读写速率；<br>3）master主机宕机，app依然进行读写。</p>
<h3 id="4-2-cluster拓扑图如下"><a href="#4-2-cluster拓扑图如下" class="headerlink" title="4.2 cluster拓扑图如下"></a>4.2 cluster拓扑图如下</h3><p><img src="http://img.blog.csdn.net/20161009145654179?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="cluster" title="cluster"></p>
<p>集群模式采用四主四从，也是采用读写分离。<br>主要实验的动作：<br>1）有一个master宕机，观察日志，新的slave成为master；<br>2）master宕机后，重新启动，master成为slave；<br>3）集群全部宕机，redis主机重启，数据未丢失。</p>
<h2 id="5-原理"><a href="#5-原理" class="headerlink" title="5. 原理"></a>5. 原理</h2><h3 id="5-1-一致性"><a href="#5-1-一致性" class="headerlink" title="5.1 一致性"></a>5.1 一致性</h3><p>filesnapshot:默认redis是会以快照的形式将数据持久化到磁盘,在配置文件中的格式是：save N M表示在N秒之内，redis至少发生M次修改则redis抓快照到磁盘。  </p>
<p>工作原理：当redis需要做持久化时，redis会fork一个子进程；子进程将数据写到磁盘上一个临时RDB文件中；当子进程完成写临时文件后，将原来的RDB替换掉，这样的好处就是可以copy-on-write。   </p>
<p>Append-only：filesnapshotting方法在redis异常死掉时， 最近的数据会丢失（丢失数据的多少视你save策略的配置），所以这是它最大的缺点，当业务量很大时，丢失的数据是很多的。Append-only方法可 以做到全部数据不丢失，但redis的性能就要差些。AOF就可以做到全程持久化，只需要在配置文件中开启（默认是no），appendonly yes开启AOF之后，redis每执行一个修改数据的命令，都会把它添加到aof文件中，当redis重启时，将会读取AOF文件进行“重放”以恢复到 redis关闭前的最后时刻。   </p>
<p>AOF文件刷新的方式，有三种，参考配置参数appendfsync ：</p>
<ul>
<li>appendfsync always每提交一个修改命令都调用fsync刷新到AOF文件，非常非常慢，但也非常安全；   </li>
<li>appendfsync everysec每秒钟都调用fsync刷新到AOF文件，很快，但可能会丢失一秒以内的数据；</li>
<li>appendfsync no依靠OS进行刷新，redis不主动刷新AOF，这样最快，但安全性就差。默认并推荐每秒刷新，这样在速度和安全上都做到了兼顾。   </li>
</ul>
<p>Slave同样可以接受其它Slaves的连接和同步请求，这样可以有效的分载Master的同步压力。因此我们可以将Redis的Replication架构视为图结构。   </p>
<p>Master Server是以非阻塞的方式为Slaves提供服务。所以在Master-Slave同步期间，客户端仍然可以提交查询或修改请求。  </p>
<p>Slave Server同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，Redis则返回同步之前的数据。   </p>
<p>为了分载Master的读操作压力，Slave服务器可以为客户端提供只读操作的服务，写服务仍然必须由Master来完成。即便如此，系统的伸缩性还是得到了很大的提高。   </p>
<p>Master可以将数据保存操作交给Slaves完成，从而避免了在Master中要有独立的进程来完成此操作。<br>Redis在master是非阻塞模式，也就是说在slave执行数据同步的时候，master是可以接受客户端的请求的，并不影响同步数据的一致性，然而在slave端是阻塞模式的，slave在同步master数据时，并不能够响应客户端的查询。   </p>
<h3 id="5-2-Replication的工作原理"><a href="#5-2-Replication的工作原理" class="headerlink" title="5.2 Replication的工作原理"></a>5.2 Replication的工作原理</h3><p>(1)Slave服务器连接到Master服务器。<br>(2)Slave服务器发送SYCN命令。<br>(3)Master服务器备份数据库到.rdb文件。<br>(4)Master服务器把.rdb文件传输给Slave服务器。<br>(5)Slave服务器把.rdb文件数据导入到数据库中。 </p>
<p>在Slave启动并连接到Master之后，它将主动发送一个SYNC命令。此后Master将启动后台存盘进程，同时收集所有接收到的用于修改数据集 的命令，在后台进程执行完毕后，Master将传送整个数据库文件到Slave，以完成一次完全同步。而Slave服务器在接收到数据库文件数据之后将其 存盘并加载到内存中。此后，Master继续将所有已经收集到的修改命令，和新的修改命令依次传送给Slaves，Slave将在本次执行这些数据修改命令，从而达到最终的数据同步。如果Master和Slave之间的链接出现断连现象，Slave可以自动重连Master，但是在连接成功之后，一次完全同步将被自动执行。   </p>
<h3 id="5-3-一致性哈希"><a href="#5-3-一致性哈希" class="headerlink" title="5.3 一致性哈希"></a>5.3 一致性哈希</h3><p>集群要实现的目的是要将不同的 key 分散放置到不同的 redis 节点，这里我们需要一个规则或者算法，通常的做法是获取 key 的哈希值，然后根据节点数来求模，但这种做法有其明显的弊端，当我们需要增加或减少一个节点时，会造成大量的 key 无法命中，这种比例是相当高的，所以就有人提出了一致性哈希的概念。<br>一致性哈希有四个重要特征：</p>
<ul>
<li>均衡性：也有人把它定义为平衡性，是指哈希的结果能够尽可能分布到所有的节点中去，这样可以有效的利用每个节点上的资源。</li>
<li>单调性：对于单调性有很多翻译让我非常的不解，而我想要的是当节点数量变化时哈希的结果应尽可能的保护已分配的内容不会被重新分派到新的节点。</li>
<li>分散性和负载：这两个其实是差不多的意思，就是要求一致性哈希算法对 key 哈希应尽可能的避免重复。</li>
</ul>
<p>Redis 集群中内置了 16384 个哈希槽，当需要在 Redis 集群中放置一个 key-value 时，redis 先对 key 使用 crc16 算法算出一个结果，然后把结果对 16384 求余数，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。   </p>
<p>使用哈希槽的好处就在于可以方便的添加或移除节点。</p>
<ol>
<li>当需要增加节点时，只需要把其他节点的某些哈希槽挪到新节点就可以了；</li>
<li>当需要移除节点时，只需要把移除节点上的哈希槽挪到其他节点就行了；</li>
<li>当设置了主从关系后，slave 在第一次连接或者重新连接 master 时，slave 都会发送一条同步指令给 master；   </li>
<li>master 接到指令后，开始启动后台保存进程保存数据，接着收集所有的数据修改指令。后台保存完了，master 就把这份数据发送给 slave，slave 先把数据保存到磁盘，然后把它加载到内存中，master 接着就把收集的数据修改指令一行一行的发给 slave，slave 接收到之后重新执行该指令，这样就实现了数据同步。   </li>
<li>slave 在与 master 失去联系后，自动的重新连接。如果 master 收到了多个 slave 的同步请求，它会执行单个后台保存来为所有的 slave 服务。</li>
</ol>
<h3 id="5-4-节点失效检测"><a href="#5-4-节点失效检测" class="headerlink" title="5.4 节点失效检测"></a>5.4 节点失效检测</h3><p>以下是节点失效检查的实现方法：</p>
<ol>
<li>当一个节点向另一个节点发送 PING 命令，但是目标节点未能在给定的时限内返回 PING 命令的回复时，那么发送命令的节点会将目标节点标记为PFAIL （possible failure，可能已失效）。</li>
<li>等待 PING 命令回复的时限称为“节点超时时限（node timeout）”，是一个节点选项（node-wise setting）。</li>
<li>每次当节点对其他节点发送 PING 命令的时候，它都会随机地广播三个它所知道的节点的信息，这些信息里面的其中一项就是说明节点是否已经被标记为 PFAIL 或者 FAIL 。</li>
<li>当节点接收到其他节点发来的信息时，它会记下那些被其他节点标记为失效的节点。这称为失效报告（failure report）。</li>
<li>如果节点已经将某个节点标记为 PFAIL ，并且根据节点所收到的失效报告显式，集群中的大部分其他主节点也认为那个节点进入了失效状态，那么节点会将那个失效节点的状态标记为 FAIL 。</li>
<li>一旦某个节点被标记为 FAIL ，关于这个节点已失效的信息就会被广播到整个集群，所有接收到这条信息的节点都会将失效节点标记为 FAIL 。</li>
</ol>
<p>简单来说，一个节点要将另一个节点标记为失效，必须先询问其他节点的意见，并且得到大部分主节点的同意才行。因为过期的失效报告会被移除，所以主节点要将某个节点标记为 FAIL 的话，必须以最近接收到的失效报告作为根据。<br>在以下两种情况中，节点的 FAIL 状态会被移除：</p>
<ol>
<li>如果被标记为 FAIL 的是从节点，那么当这个节点重新上线时， FAIL 标记就会被移除。保持（retaning）从节点的 FAIL 状态是没有意义的，因为它不处理任何槽，一个从节点是否处于 FAIL 状态，决定了这个从节点在有需要时能否被提升为主节点。</li>
<li>如果一个主节点被打上 FAIL 标记之后，经过了节点超时时限的四倍时间，再加上十秒钟之后，针对这个主节点的槽的故障转移操作仍未完成，并且这个主节点已经重新上线的话，那么移除对这个节点的 FAIL 标记。   </li>
<li>在第二种情况中，如果故障转移未能顺利完成，并且主节点重新上线，那么集群就继续使用原来的主节点，从而免去管理员介入的必要。</li>
</ol>
<h3 id="5-5-从节点选举"><a href="#5-5-从节点选举" class="headerlink" title="5.5 从节点选举"></a>5.5 从节点选举</h3><p>一旦某个主节点进入 FAIL 状态，如果这个主节点有一个或多个从节点存在，那么其中一个从节点会被升级为新的主节点，而其他从节点则会开始对这个新的主节点进行复制。<br>新的主节点由已下线主节点属下的所有从节点中自行选举产生，以下是选举的条件：</p>
<ol>
<li>这个节点是已下线主节点的从节点。</li>
<li>已下线主节点负责处理的槽数量非空。</li>
<li>从节点的数据被认为是可靠的，也即是，主从节点之间的复制连接（replication link）的断线时长不能超过节点超时时限（node timeout）乘以REDIS_CLUSTER_SLAVE_VALIDITY_MULT 常量得出的积。     </li>
</ol>
<p>如果一个从节点满足了以上的所有条件，那么这个从节点将向集群中的其他主节点发送授权请求，询问它们，是否允许自己（从节点）升级为新的主节点。<br>如果发送授权请求的从节点满足以下属性，那么主节点将向从节点返回 FAILOVER_AUTH_GRANTED 授权，同意从节点的升级要求：</p>
<ol>
<li>发送授权请求的是一个从节点，并且它所属的主节点处于 FAIL 状态。</li>
<li>在已下线主节点的所有从节点中，这个从节点的节点 ID 在排序中是最小的。</li>
<li>从节点处于正常的运行状态：它没有被标记为 FAIL 状态，也没有被标记为 PFAIL 状态。   </li>
</ol>
<p>一旦某个从节点在给定的时限内得到大部分主节点的授权，它就会开始执行以下故障转移操作：</p>
<ol>
<li>通过 PONG 数据包（packet）告知其他节点，这个节点现在是主节点了。</li>
<li>通过 PONG 数据包告知其他节点，这个节点是一个已升级的从节点（promoted slave）。</li>
<li>接管（claiming）所有由已下线主节点负责处理的哈希槽。</li>
<li>显式地向所有节点广播一个 PONG 数据包，加速其他节点识别这个节点的进度，而不是等待定时的 PING / PONG 数据包。</li>
<li>所有其他节点都会根据新的主节点对配置进行相应的更新，特别地：<br> a. 所有被新的主节点接管的槽会被更新。<br> b. 已下线主节点的所有从节点会察觉到 PROMOTED 标志，并开始对新的主节点进行复制。<br> c.如果已下线的主节点重新回到上线状态，那么它会察觉到 PROMOTED 标志，并将自身调整为现任主节点的从节点。   </li>
</ol>
<p>在集群的生命周期中，如果一个带有 PROMOTED 标识的主节点因为某些原因转变成了从节点，那么该节点将丢失它所带有的 PROMOTED 标识。</p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>Redis集群具有高可用，易于迁移，存取速度快等特点。也可以作为消息队列使用，支持pub/sub模式，具体优缺点总结如下：<br>首先优点:</p>
<ol>
<li>redis 在主节点下线后，从节点会自动提升为主节点，提供服务</li>
<li>redis 宕机节点恢复后，自动会添加到集群中，变成从节点</li>
<li>动态扩展和删除节点，rehash slot的分配，基于桶的数据分布方式大大降低了迁移成本，只需将数据桶从一个Redis Node迁移到另一个Redis Node即可完成迁移。</li>
<li>Redis Cluster使用异步复制。   </li>
</ol>
<p>其缺点为:</p>
<ol>
<li>由于redis的复制使用异步机制，在自动故障转移的过程中，集群可能会丢失写命令。然而 redis 几乎是同时执行(将命令恢复发送给客户端，以及将命令复制到从节点)这两个操作，所以实际中，命令丢失的窗口非常小。</li>
<li>普通的主从模式支持auth加密认证，虽然比较弱，但写或者读都要通过密码验证，cluster对密码支持不太友好，如果对集群设置密码，那么requirepass和masterauth都需要设置，否则发生主从切换时，就会遇到授权问题，可以模拟并观察日志。</li>
</ol>
<hr>
<h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><ol>
<li><a href="www.redis.io">www.redis.io</a>  </li>
<li><a href="http://hot66hot.iteye.com/blog/2050676" target="_blank" rel="external">redis-cluster研究和使用</a></li>
<li><a href="http://www.cnblogs.com/gomysql/p/4395504.html" target="_blank" rel="external">Redis Cluster 3.0搭建与使用</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/09/29/rediscluster/" data-id="cja25cxim0015ff6qh2b1ond7" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-raft" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/25/raft/">由Consul谈到Raft</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/25/raft/">
            <time datetime="2017-09-25T08:06:59.000Z" itemprop="datePublished">2017-09-25</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/算法/">算法</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Cluster/">Cluster</a>, <a class="tag-link" href="/tags/Consensus/">Consensus</a>, <a class="tag-link" href="/tags/consul/">consul</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>在前一篇文章<a href="http://blueskykong.com/2017/09/16/consul/">consul配置与实战</a>中，介绍了consul的一些内幕及consul配置相关，并对项目中的一些实际配置进行展示。这篇文章重点介绍consul中所涉及到的一致性算法raft。</p>
<h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h2><p>分布式系统的一致性是相当重要的，即为CAP理论中的C(Consistency)。一致性又可以分为强一致性和最终一致性。这篇文章重点讨论强一致性算法raft。   </p>
<p>Lamport发表Paxos一致性算法从90年提出到现在已经有二十几年了，直到2006年Google的三篇论文初现“云”的端倪，其中的Chubby Lock服务使用Paxos作为Chubby Cell中的一致性算法，Paxos的人气从此一路狂飙。而Paxos流程太过于繁杂实现起来也比较复杂，虽然现在很广泛使用的Zookeeper也是基于Paxos算法来实现，但是Zookeeper使用的ZAB（Zookeeper Atomic Broadcast）协议对Paxos进行了很多的改进与优化，复杂性是制约他发展的一个重要原因。Raft的设计初衷就是易于理解性。</p>
<blockquote>
<p>Raft是斯坦福的Diego Ongaro、John Ousterhout两个人以易懂（Understandability）为目标设计的一致性算法，在2013年发布了论文：《In Search of an Understandable Consensus Algorithm》</p>
</blockquote>
<p>从2013年发布到现在不过只有两年，到现在已经有了十多种语言的Raft算法实现框架，较为出名的有etcd。</p>
<h2 id="2-Raft详解"><a href="#2-Raft详解" class="headerlink" title="2. Raft详解"></a>2. Raft详解</h2><p>强调的是易懂（Understandability），Raft和Paxos一样只要保证n/2+1节点正常就能够提供服务；众所周知但问题较为复杂时可以把问题分解为几个小问题来处理，Raft也使用了分而治之的思想把算法流程分为三个子问题：选举（Leader election）、日志复制（Log replication）、安全性（Safety）三个子问题。</p>
<h3 id="2-1-raft基本概念"><a href="#2-1-raft基本概念" class="headerlink" title="2.1 raft基本概念"></a>2.1 raft基本概念</h3><ol>
<li><p>states<br> 一个raft集群拥有多个server，通常会有5台，这样可以允许系统中两台server宕机。在任何情况下，所有的server只有如下三种状态之一：</p>
<ul>
<li>Leader，负责Client交互和log复制，同一时刻系统中最多存在1个</li>
<li>Follower，被动响应请求RPC，从不主动发起请求RPC</li>
<li><p>Candidate，由Follower向Leader转换的中间状态</p>
<p>在正常的操作流程中，集群中有且只有一个server，其他所有的server都是follower。follower是被动的，他们只是被动地相应Candidate和leader的请求。。leader处理所有的客户端请求，follower自己不处理而是转发给leader。第三种状态是Candidate，用来选举一个新的leader。</p>
</li>
</ul>
<p><img src="http://ovci9bs39.bkt.clouddn.com/Raft%E8%BD%AC%E6%8D%A2%E5%9B%BE%E7%8A%B6%E6%80%81.jpg" alt="角色转换" title="state转换图"></p>
</li>
<li><p>Terms<br>  Raft将时间划分成任意的长度周期。Terms可以理解为逻辑周期，用连续的整数表示。在分布式环境中，时间同步很重要，同时是一个难题。在Raft中使用了一个可以理解为周期（任期）的概念，用Term作为一个周期，每个Term都是一个连续递增的编号，每一轮选举都是一个Term周期，在一个Term中只能产生一个Leader。<br>  每个term伴随着一次election，一个或多个Candidate试图成为leader，如上图的状态转换。如果某个Candidate赢得了这次election，它将升级为剩余server的leader。在某些election的情形中，会产生耗票（Split Votes）的结果 ，即投票结果无效，随后一次新的term开始。raft确保在某个term至多有一个leader。<br>  <img src="http://ovci9bs39.bkt.clouddn.com/terms-raft.jpg" alt="terms" title="terms"><br>如上图所示，时间被划分成多个terms，每个term随着一次election。election完成后，一个leader节点管理整个集群，直至这个term结束。有些election失败了，未能产生一个leader。</p>
</li>
</ol>
<h3 id="2-2-Leader-election"><a href="#2-2-Leader-election" class="headerlink" title="2.2 Leader election"></a>2.2 Leader election</h3><p>所有节点都是以follower启动。一个最小的 Raft 集群需要三个参与者，这样才可能投出多数票。初始状态 都是 Follower，然后发起选举这时有三种可能情形发生。如果每方都投给了自己，结果没有任何一方获得多数票。之后每个参与方随机休息一阵（Election Timeout）重新发起投票直到一方获得多数票。这里的关键就是随机 timeout，最先从timeout中恢复发起投票的一方向还在 timeout 中的另外两方请求投票，这时它们就只能投给对方了，很快达成一致。<br>Raft的选举由定时器来触发，每个节点的选举定时器时间都是不一样的，开始时状态都为Follower某个节点定时器触发选举后Term递增，状态由Follower转为Candidate，向其他节点发起RequestVote RPC请求，这时候有三种可能的情况发生：<br>　　1.该RequestVote请求接收到n/2+1（过半数）个节点的投票，从Candidate转为Leader，向其他节点发送heartBeat以保持Leader的正常运转。<br>　　2.在此期间如果收到其他节点发送过来的AppendEntries RPC请求，如该节点的Term大则当前节点转为Follower，否则保持Candidate拒绝该请求。<br>　　3.Election timeout发生则Term递增，重新发起选举。<br>　　在一个Term期间每个节点只能投票一次，所以当有多个Candidate存在时就会出现每个Candidate发起的选举都存在接收到的投票数都不过半的问题，这时每个Candidate都将Term递增、重启定时器并重新发起选举，由于每个节点中定时器的时间都是随机的，所以就不会多次存在有多个Candidate同时发起投票的问题。</p>
<p>引用一张网上的图片，比较形象，如下图。<br><img src="http://ovci9bs39.bkt.clouddn.com/voterequest.png" alt="vote" title="vote"></p>
<h3 id="2-3-Log-replication"><a href="#2-3-Log-replication" class="headerlink" title="2.3 Log replication"></a>2.3 Log replication</h3><p>日志复制主要是用于保证节点的一致性，这阶段所做的操作也是为了保证一致性与高可用性；当Leader选举出来后便开始负责客户端的请求，所有事务（更新操作）请求都必须先经过Leader处理，这些事务请求或说成命令也就是这里说的日志，我们都知道要保证节点的一致性就要保证每个节点都按顺序执行相同的操作序列，日志复制（Log Replication）就是为了保证执行相同的操作序列所做的工作；在Raft中当接收到客户端的日志（事务请求）后先把该日志追加到本地的Log中，然后通过heartbeat把该Entry同步给其他Follower，Follower接收到日志后记录日志然后向Leader发送ACK，当Leader收到大多数（n/2+1）Follower的ACK信息后将该日志设置为已提交并追加到本地磁盘中，通知客户端并在下个heartbeat中Leader将通知所有的Follower将该日志存储在自己的本地磁盘中。</p>
<p><img src="http://ovci9bs39.bkt.clouddn.com/log-replication.png" alt="log" title="log"></p>
<p>上图中，当leader选出来之后，follower的logs场景很可能出现在上图中。follower有可能丢失entries、有未提交的entries、有额外的entries等等场景。Raft中，leader通过强制followers复制自己的logs来处理不一致。这意味着，在follower中logs冲突的entries将会被leader logs中的覆写。</p>
<h3 id="2-4-Safety"><a href="#2-4-Safety" class="headerlink" title="2.4 Safety"></a>2.4 Safety</h3><p>安全性是用于保证每个节点都执行相同序列的安全机制，如当某个Follower在当前Leader commit Log时变得不可用了，稍后可能该Follower又会倍选举为Leader，这时新Leader可能会用新的Log覆盖先前已committed的Log，这就是导致节点执行不同序列；Safety就是用于保证选举出来的Leader一定包含先前 commited Log的机制；</p>
<ul>
<li>Election Safety<br>每个Term只能选举出一个Leader，假设某个Term同时选举产生两个LeaderA和LeaderB，根据选举过程定义，A和B必须同时获得超过半数节点的投票，至少存在节点N同时给予A和B投票，因此矛盾。</li>
<li>Leader Completeness<br>这里所说的完整性是指Leader日志的完整性，当Log在Term1被Commit后，那么以后Term2、Term3…等的Leader必须包含该Log；Raft在选举阶段就使用Term的判断用于保证完整性：当请求投票的该Candidate的Term较大或Term相同Index更大则投票，否则拒绝该请求；</li>
<li>Leader Append-Only<br>Leader从不“重写”或者“删除”本地Log，仅仅“追加”本地Log。Raft算法中Leader权威至高无上，当Follower和Leader产生分歧的时候，永远是Leader去覆盖修正Follower。</li>
<li>Log Matching<br>如果两个节点上的日志项拥有相同的Index和Term，那么这两个节点[0, Index]范围内的Log完全一致。</li>
<li>State Machine Safety<br>一旦某个server将某个日志项应用于本地状态机，以后所有server对于该偏移都将应用相同日志项。</li>
</ul>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h2><p>本文主要讲解了Raft算法的基本概念，以及算法中涉及到的leader选举，日志同步，安全性。Raft是以易理解性作为其设计的一个目标，对于一个学习的新手来说，确实比Paxos易于理解很多。虽然 Raft 的论文比 Paxos 简单版论文容易读，论文依然有很多地方需要深刻体会与理解，笔者也还是搞了好几天。</p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="external">Raft Animate Demo</a>   </li>
<li><a href="https://ramcloud.stanford.edu/raft.pdf" target="_blank" rel="external">Raft Paper</a></li>
<li><a href="https://raft.github.io/#implementations" target="_blank" rel="external">Raft Website</a></li>
<li><a href="http://www.cnblogs.com/mindwind/p/5231986.html" target="_blank" rel="external">Raft 为什么是更易理解的分布式一致性算法</a>   </li>
<li><a href="http://blog.csdn.net/cszhouwei/article/details/38374603" target="_blank" rel="external">Raft一致性算法</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/09/25/raft/" data-id="cja25cxis001bff6qwu91ypy1" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-consul" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/16/consul/">consul配置与实战</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/16/consul/">
            <time datetime="2017-09-15T16:00:00.000Z" itemprop="datePublished">2017-09-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/中间件/">中间件</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/cluster/">cluster</a>, <a class="tag-link" href="/tags/consul/">consul</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>上一篇提到，项目用的分布式服务发现与注册组件是consul，这篇文章主要来讲下consul组件在项目中的应用以及相关介绍。本文以官方文档为主要参考<a href="https://www.consul.io/docs/internals/" target="_blank" rel="external">consul文档</a>。</p>
<h2 id="1-consul介绍"><a href="#1-consul介绍" class="headerlink" title="1. consul介绍"></a>1. consul介绍</h2><p>consul是一个服务管理软件，主要功能如下：</p>
<ol>
<li>支持多数据中心下，分布式高可用的，服务发现和配置共享。</li>
<li>consul支持健康检查，允许存储键值对。</li>
<li>一致性协议采用<code>Raft</code>算法,用来保证服务的高可用。</li>
<li>成员管理和消息广播采用<code>GOSSIP</code>协议，支持ACL访问控制。</li>
</ol>
<h3 id="1-1-服务注册与发现"><a href="#1-1-服务注册与发现" class="headerlink" title="1.1 服务注册与发现"></a>1.1 服务注册与发现</h3><p>服务注册是一个服务将其位置信息在“中心注册节点”注册的过程。该服务一般会将它的主机IP地址以及端口号进行注册，有时也会有服务访问的认证信息，使用协议，版本号，以及关于环境的一些细节信息。<br>而服务发现可以让一个应用或者组件发现其运行环境以及其它应用或组件的信息。用户配置一个服务发现工具就可以将实际容器跟运行配置分离开。常见配置信息包括：ip、端口号、名称等。   </p>
<p>在传统情况下，当出现服务存在于多个主机节点上时，都会使用静态配置的方法来实现服务信息的注册。<br>而当在一个复杂的系统里，需要较强的可扩展性时，服务被频繁替换时，为避免服务中断，动态的服务注册和发现就很重要。<br>服务注册与发现的组件有很多，如Zookeeper、Etcd等。既可用于服务间的协调，同时又可用于服务的注册。</p>
<h3 id="1-2-Consensus-Protocol-Raft"><a href="#1-2-Consensus-Protocol-Raft" class="headerlink" title="1.2 Consensus Protocol - Raft"></a>1.2 Consensus Protocol - Raft</h3><p> Consul使用Consensus协议Raft提供一致性（Consistency）。本文只是简单介绍在consul中的一致性，后面专门一篇写raft。</p>
<p> <img src="http://ovci9bs39.bkt.clouddn.com/raft%E7%AE%97%E6%B3%95.png" alt="raft算法" title="raft算法"></p>
<p> 首先，Raft是一种基于Paxos的Consensus算法。相比于Paxos，Raft设计采用了较少的状态，并且是一种更简单、更易于理解的算法。<br>只有Server节点参与Raft，且是peer set的一员。所有的Client节点只是转发请求到Server。这种设计的考虑是，当更多的成员加入到peer set中时，quorum的规模也会增加。可能会导致性能问题是等待quorum个节点log entry。<br> 启动Consul时，单个consul节点需要以bootstrap模式运行，该模式运行自我选举为leader。一旦Leader被选出来，其他Server可以添加Peer set中，保持一致性和安全性。最终一些Server添加到集群，bootstrap模式需要禁用。<br> 因为所有Server都是Peer set中的成员，它们都知道谁是Leader。当一个RPC请求到达某个非Leader Server节点，请求就会被转发到Leader。如果RPC是一种query类型，这意味着它是只读的，Leader会基于FSM当前生成相应的结果，如果RPC是一种transaction类型，即修改状态，Leader产生一个新的日志条目，并基于Raft算法进行管理。一旦日志条目应用于有限状态机，transaction完成。<br> 由于Raft的replication性质，性能对网络延迟是非常敏感的。为此，每个数据中心选择独立的Leader和维护一个不关联的peer set。数据按照数据中心进行划分，所以每个Leader只负责在相应数据中心的数据。当接收到一个远程数据中心的请求时，请求会被转发到相应的Leader。这种设计在不牺牲一致性的情况实现较低延迟交易和更高的可用性。<br>虽然所有日志副本的写入都是基于Raft，读取更灵活。但为了支持开发人员可能需要的各种权衡，Consul支持3种不同的一致性模式。</p>
<ul>
<li>Default，Raft采用Leader租赁模式，提供了一个时间窗口，在该时间段内，Leader角色是稳定的。</li>
<li>consistent，无条件一致性</li>
<li>stale，这种模式允许在任何Server节点执行读取操作，无论它是不是Leader。</li>
</ul>
<h3 id="1-3-Group-Membership-Protocol-Gossip"><a href="#1-3-Group-Membership-Protocol-Gossip" class="headerlink" title="1.3 Group Membership Protocol - Gossip"></a>1.3 Group Membership Protocol - Gossip</h3><p>Consul使用gossip协议管理成员关系、广播消息到整个集群。详情可参考<a href="https://www.serf.io/" target="_blank" rel="external">Serf library</a>。<br> Consul利用两个不同的gossip pool。局域网(LAN Pool)和广域网(WAN Pool)。<br> 每个Consul数据中心都有一个包含所有成员（Server和Client）的LAN gossip pool。LAN Pool有如下几个目的：</p>
<ul>
<li>首先，成员关系允许Client自动发现Server节点，减少所需的配置量。</li>
<li>其次，分布式故障检测允许的故障检测的工作在某几个Server几点执行，而不是集中整个集群所有节点上。</li>
<li>最后，gossip允许可靠和快速的事件广播，如Leader选举。</li>
</ul>
<p>WAN Pool是全局唯一的，无论属于哪一个数据中心，所有Server应该加入到WAN Pool。由WAN Pool提供会员信息让Server可节电执行跨数据中心的请求。集成中故障检测允许Consul妥善处理整个数据中心失去连接，或在远程数据中心只是单个的Server节点。<br>所有这些功能都是通过利用Serf提供。从用户角度来看，它是作为一个嵌入式库提供这些功能。但其被Consul屏蔽，用户无需关心。作为开发人员可以去了解这个库是如何利用。</p>
<h3 id="1-4-Session会话"><a href="#1-4-Session会话" class="headerlink" title="1.4 Session会话"></a>1.4 Session会话</h3><p>上一篇文章<a href="http://hacloud.club/2017/09/09/snowflake/" target="_blank" rel="external">snowflake升级版全局id生成</a>中使用到了consul的KV存储。<br>Consul提供session会话机制，可以用于构建分布式锁。session可以绑定到节点、健康检查、KV数据，目的是提供细粒度锁。<br>KV存储和会话的集成是使用会话的主要场景。必须在使用之前创建一个会话，然后使用它的ID。KV API支持acquire和release操作，acquire操作类似CAS操作，只有当锁空闲时才会返回成功。当成功时，某个normal标识会更新，也会递增LockIndex，当然也会更新session的信息。<br>如果在acquire操作时，与session相关的锁已经持有，那么LockIndex就不会递增，但是key值会更新，这就允许锁的当前持有者无需重新获得锁就可以更新key的内容。<br> 一旦获得锁，所需要经release操作来释放（使用相同的session）。Release操作也类似于CAS操作。如果给定的session无效，那么请求会失败。需要特别注意的是，无需经过session的创建者，lock也是可以被释放的。这种设计是允许操作者干预来终止会话，在需要的时候。如上所述，会话无效也将导致所有被持有的锁被释放或删除。当锁被释放时，LockIndex不会变化，但是session会被清空，并且ModifyIndex递增。这些语义允许元组（Key，LockIndex，Session）作为一个独特的“序列”。这个序列可以被传递和用于验证请求是否属于当前的锁持有者。因为每次acquire 都会导致LockIndex递增，即使同一会话中重新获取锁，该序列能够检测到陈旧的请求。同样，如果会话失效，相应的LockIndex将为空。<br>要清楚的是，这种锁系统是纯粹的咨询。并不是强制Client必须获取锁再能执行操作作。任何客户端都可以在未获得锁的情况下读取、写入和删除Key操作。它不是Consul用于保护系统的方法。</p>
<h2 id="2-consul架构"><a href="#2-consul架构" class="headerlink" title="2. consul架构"></a>2. consul架构</h2><p>上面介绍了consul的技术内幕。现在来讲讲consul的架构。</p>
<p><img src="http://ovci9bs39.bkt.clouddn.com/consul.png" alt="consul" title="consul"></p>
<p>拆解开这个体系，从每一个组件开始了解。首先，可以看到有两个数据中心，分别标记为“one”和“two”。Consul是支持多数据中心一流，并且是常用业务场景。   </p>
<p>每个数据中心都是由Server和client组成。建议有3~5台Server，基于故障处理和性能的平衡之策。如果增加越多的机器，则Consensus会越来越慢。对client没有限制，可以很容易地扩展到成千上万或数万。<br>同一个数据中心的所有节点都要加入Gossip协议。这意味着gossip pool包含给定数据中心的所有节点。有以下目的：首先，没有必要为client配置服务器地址参数；发现是自动完成的。第二，节点故障检测的工作不是放置在服务器上，而是分布式的。这使故障检测比心跳机制更可扩展性。第三，可用来作为消息层通知重要的事件，如leader选举。  </p>
<p>每个数据中心的服务器都是属于一个Raft peer。这意味着，他们一起工作，选出一个的Leader，Leader server是有额外的职责。负责处理所有的查询和事务。事务也必须通过Consensus协议复制到所有的伙伴。由于这一要求，当非Leader Server接收到一个RPC请求，会转发到集群的leader。   </p>
<p>Server节点也是作为WAN gossip pool的一部分。这个pool是与LAN gossip pool是不同的，它为具有更高延迟的网络响应做了优化，并且可能包括其他consul集群的server节点。设计WANpool的目的是让数据中心能够以low-touch的方式发现彼此。将一个新的数据中心加入现有的WAN Gossip是很容易的。因为池中的所有Server都是可控制的，这也使跨数据中心的要求。当一个Serfer接收到不同的数据中心的要求时，它把这个请求转发给相应数据中心的任一Server。然后，接收到请求的Server可能会转发给Leader。<br>多个数据中心之间是低耦合，但由于故障检测、连接缓存复用、跨数据中心要求快速和可靠的响应。</p>
<h2 id="3-consul部署"><a href="#3-consul部署" class="headerlink" title="3. consul部署"></a>3. consul部署</h2><h3 id="3-1-docker安装"><a href="#3-1-docker安装" class="headerlink" title="3.1 docker安装"></a>3.1 docker安装</h3><p><code>docker</code>安装很简单，笔者这边是基于docker-compose的配置文件，只需要本地安装好docker和docker-compose，docker-compose.yml如下：   </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">version:</span> <span class="string">'3'</span></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  consul:</span></div><div class="line"><span class="attr">    image:</span> <span class="string">consul</span></div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">     -</span> <span class="string">"8500:8500"</span></div><div class="line"><span class="bullet">     -</span> <span class="string">"8600:8600"</span></div><div class="line"><span class="bullet">     -</span> <span class="string">"8300:8300"</span></div></pre></td></tr></table></figure>
<p>拉取consul得最新image，进行端口映射，暴露对外的端口8500，8300.</p>
<h3 id="3-2-软件安装"><a href="#3-2-软件安装" class="headerlink" title="3.2 软件安装"></a>3.2 软件安装</h3><ol>
<li>从官网下载罪行的consul安装包，<a href="https://www.consul.io/downloads.html。" target="_blank" rel="external">https://www.consul.io/downloads.html。</a></li>
<li>解压consul_0.6.4_darwin_amd64.zip。</li>
<li>将解压后的二进制文件consul拷贝到/usr/local/bin下。</li>
<li>写配置文件。<br>服务注册的配置文件如下:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;service&quot;: &#123;</div><div class="line">    &quot;name&quot;: &quot;redis&quot;,</div><div class="line">    &quot;tags&quot;: [&quot;master&quot;],</div><div class="line">    &quot;address&quot;: &quot;1192.168.1.100&quot;,</div><div class="line">    &quot;port&quot;: 8000,</div><div class="line">    &quot;enableTagOverride&quot;: false,</div><div class="line">    &quot;check&quot;: &#123;  </div><div class="line">    	&quot;id&quot;: &quot;redis&quot;,  </div><div class="line">   	 	&quot;name&quot;: &quot;redis on port 8000&quot;,  </div><div class="line">    	&quot;tcp&quot;: &quot;localhost:8000&quot;,  </div><div class="line">    	&quot;interval&quot;: &quot;10s&quot;,  </div><div class="line">    	&quot;timeout&quot;: &quot;1s&quot;  </div><div class="line">  &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如上配置注册了Redis的8000端口，并带有tcp的health check。</p>
<p>节点的配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="attr">  "datacenter":</span> <span class="string">"east-cn"</span><span class="string">,</span></div><div class="line"><span class="attr">  "data_dir":</span> <span class="string">"/opt/consul"</span><span class="string">,</span></div><div class="line"><span class="attr">  "log_level":</span> <span class="string">"INFO"</span><span class="string">,</span></div><div class="line"><span class="attr">  "node_name":</span> <span class="string">"redis"</span><span class="string">,</span></div><div class="line"><span class="attr">  "server":</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">  "addresses":</span> <span class="string">&#123;</span></div><div class="line"><span class="attr">    "https":</span> <span class="string">"192.168.1.100"</span></div><div class="line">  <span class="string">&#125;,</span></div><div class="line"><span class="attr">  "ports":</span> <span class="string">&#123;</span></div><div class="line"><span class="attr">    "https":</span> <span class="number">0</span></div><div class="line">  <span class="string">&#125;,</span></div><div class="line"><span class="attr">  "ui":</span> <span class="literal">true</span><span class="string">,</span></div><div class="line"><span class="attr">  "retry-join":</span> <span class="string">[</span></div><div class="line"><span class="string">]</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
<p>当加载配置选项时，consul是按照词典顺序从所有配置文件或目录中加载。比如，<code>a.json</code>会先于<code>e.json</code>处理。后面设定的配置选项会合并到前面的配置集合中，如果存在重复的配置选项则会覆盖。当然，在某些情况下，比如事件处理程序，后面处理程序会追加到现有的配置选项中，形成事件处理程序列表。</p>
<h3 id="3-3-启动"><a href="#3-3-启动" class="headerlink" title="3.3 启动"></a>3.3 启动</h3><p>具体启动文档见<a href="https://www.consul.io/docs/agent/options.html#configuration_files" target="_blank" rel="external">configuration</a>。<br>如:</p>
<pre><code class="bash">consul agent -server -config-dir /etc/consul.d -<span class="built_in">bind</span>=192.168.1.100
    -config-dir /etc/consul.d
</code></pre>
<ul>
<li><p>config-dir<br>需要加载的配置文件目录，consul将加载目录下所有后缀为“.json”的文件，加载顺序为字母顺序，文件中配置选项合并方式如config-file。该参数可以多次配置。目录中的子目录是不会加载的。</p>
</li>
<li><p>data-dir<br>此目录是为Agent存放state数据的。是所有Agent需要的，该目录应该存放在持久存储中（reboot不会丢失），对于server角色的Agent是很关键的,需要记录集群状态。并且该目录是支持文件锁。</p>
</li>
<li><p>server<br>设置Agent是server模式还是client模式。Consul agent有两种运行模式：Server和Client。这里的Server和Client只是Consul集群层面的区分，与搭建在Cluster之上 的应用服务无关。Consule Server模式agent节点用于采用raft算法维护Consul集群的状态，官方建议每个Consul Cluster至少有3个或以上的运行在Server mode的Agent，Client节点不限。</p>
</li>
</ul>
<p>其他常用的还有：</p>
<ul>
<li><p>client<br>将绑定到client接口的地址，可以是HTTP、DNS、RPC服务器。默认为“127.0.0.1”，只允许回路连接。RPC地址会被其他的consul命令使用，比如consul members，查询agent列表</p>
</li>
<li><p>node<br>节点在集群的名字，在集群中必须是唯一的。默认为节点的Hostname。</p>
</li>
<li><p>bootstrap<br>设置服务是否为“bootstrap”模式。如果数据中心只有1个server agent，那么需要设置该参数。从技术上来讲，处于bootstrap模式的服务器是可以选择自己作为Raft Leader的。在consul集群中，只有一个节点可以配置该参数，如果有多个参数配置该参数，那么难以保证一致性。</p>
</li>
<li><p>bind<br>用于集群内部通信的IP地址，与集群中其他节点互连可通。默认为“0.0.0.0”，consul将使用第一个有效的私有IPv4地址。如果指定“[::]”，consul将使用第一个有效的公共IPv6地址。使用TCP和UDP通信。注意防火墙，避免无法通信。</p>
</li>
</ul>
<h3 id="3-4-结果"><a href="#3-4-结果" class="headerlink" title="3.4 结果"></a>3.4 结果</h3><p>在开启了<code>&quot;ui&quot;: true</code>server主机上，如<a href="http://192.168.1.100:8500/ui查看注册中心的服务。" target="_blank" rel="external">http://192.168.1.100:8500/ui查看注册中心的服务。</a><br>demo ui如下：</p>
<p><img src="http://ovci9bs39.bkt.clouddn.com/demoui.png" alt="consului" title="consul demo UI"></p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文介绍了consul的一些内幕及consul配置相关，并对项目中的一些实际配置进行展示。希望能够帮助大家对consul相关的知识有所了解，并对于入门配置consul和实际应用有所知道。个人认为，consul原理还是简单易懂的，集群的配置也不复杂，安利大家使用。后面会再写一篇介绍Spring cloud中集成和使用consul组件作为注册与发现中心。</p>
<hr>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a href="https://www.consul.io/docs/internals/" target="_blank" rel="external">consul文档</a><br><a href="http://blog.csdn.net/younger_china/article/details/52243700" target="_blank" rel="external">consul中文翻译</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/09/16/consul/" data-id="cja25cxi9000hff6qh4a0ae3q" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-snowflake" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/09/snowflake/">snowflake升级版全局id生成</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/09/snowflake/">
            <time datetime="2017-09-08T16:00:00.000Z" itemprop="datePublished">2017-09-09</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/微服务/">微服务</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/snowflake/">snowflake</a>, <a class="tag-link" href="/tags/spring-boot/">spring boot</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h2><p>分布式系统或者微服务架构基本都采用了分库分表的设计，全局唯一id生成的需求变得很迫切。<br>传统的单体应用，使用单库，数据库中自增id可以很方便实现。分库之后，首先需要分库键，分库键必然不能重复，所以传统的做法并不能满足需求。概括下来，那业务系统对ID号的要求有哪些呢？</p>
<blockquote>
<p>1.全局唯一性：不能出现重复的ID号，既然是唯一标识，这是最基本的要求。<br>2.趋势递增：在MySQL InnoDB引擎中使用的是聚集索引，由于多数RDBMS使用B-tree的数据结构来存储索引数据，在主键的选择上面我们应该尽量使用有序的主键保证写入性能。<br>3.单调递增：保证下一个ID一定大于上一个ID，例如事务版本号、IM增量消息、排序等特殊需求。<br>4.信息安全：如果ID是连续的，恶意用户的扒取工作就非常容易做了，直接按照顺序下载指定URL即可；如果是订单号就更危险了，竞对可以直接知道我们一天的单量。所以在一些应用场景下，会需要ID无规则、不规则。   </p>
</blockquote>
<p>其中第3和第4点是互斥的。除了功能性需求，还有性能和可靠性的需求：</p>
<blockquote>
<ul>
<li>平均延迟和TP999延迟都要尽可能低；  </li>
<li>可用性5个9；  </li>
<li>高QPS。</li>
</ul>
</blockquote>
<h2 id="2-进阶历程"><a href="#2-进阶历程" class="headerlink" title="2. 进阶历程"></a>2. 进阶历程</h2><p>自从项目从单体应用拆分成微服务架构后，对全局id部分做了些摸索。</p>
<h3 id="2-1-uuid"><a href="#2-1-uuid" class="headerlink" title="2.1 uuid"></a>2.1 uuid</h3><p>刚开始拆分业务，id主键都是使用uuid字符串。<br>UUID(Universally Unique Identifier)的标准型式包含32个16进制数字，以连字号分为五段，形式为8-4-4-4-12的36个字符。类似这样的字符串：<code>dc5adf0a-d531-11e5-95aa-3c15c2d22392</code>。128位，根本不用担心不够用。生成的方法也很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UUID userId = UUID.randomUUID();</div></pre></td></tr></table></figure>
<p>uuid全球唯一，本地生成，没有网络消耗，产生的性能绝对可以满足。<br>其缺点也是显而易见的，比较占地方，和INT类型相比，存储一个UUID要花费更多的空间。<br>使用UUID后，URL显得冗长，不够友好。ID作为主键时在特定的环境会存在一些问题，比如做DB主键的场景下，UUID就非常不适用：</p>
<ul>
<li>MySQL官方有明确的建议主键要尽量越短越好，36个字符长度的UUID不符合要求。</li>
<li>对MySQL索引不利：如果作为数据库主键，在InnoDB引擎下，UUID的无序性可能会引起数据位置频繁变动，严重影响性能。</li>
</ul>
<h3 id="2-2-数据库生成"><a href="#2-2-数据库生成" class="headerlink" title="2.2 数据库生成"></a>2.2 数据库生成</h3><p>以MySQL举例，利用给字段设置<code>auto_increment_increment</code>和<code>auto_increment_offset</code>来保证ID自增，每次业务使用下列SQL读写MySQL得到ID号。<br>参考了<a href="https://tech.meituan.com/MT_Leaf.html" target="_blank" rel="external">Leaf</a>的实现思想:</p>
<ul>
<li>id server每次批量从数据库取号段，本地缓存这个号段，并且设置阈值，当达到0.8（已用与号段容量的比值），自动去获取一个新的号段，更新本地缓存的号段。</li>
<li>id client，即具体的调用服务实例，在本地也做一个缓存，实现和id server的缓存差不多，这样做的目的是为了减轻id服务端的压力，同时减少了rpc调用的网络消耗。</li>
</ul>
<p>以上方案，其缺点是：</p>
<ol>
<li>号段存在浪费，无论哪个客户端还是服务端重启都会浪费号段。</li>
<li>号段是直接自增，不够随机，对外暴露信息过多。</li>
<li>DB宕机会造成整个系统不可用。虽然在DB宕机之后，利用缓存还能进行短暂供号，但是数据库的依赖还是很重。Leaf采用的一般做法是高可用容灾:</li>
</ol>
<blockquote>
<p>采用一主两从的方式，同时分机房部署，Master和Slave之间采用半同步方式同步数据。同时使用DBProxy做主从切换。当然这种方案在一些情况会退化成异步模式，甚至在非常极端情况下仍然会造成数据不一致的情况，但是出现的概率非常小。</p>
</blockquote>
<p><img src="http://ovci9bs39.bkt.clouddn.com/master-slave.png" alt="主从" title="主从方式"></p>
<h2 id="3-snowflake方案"><a href="#3-snowflake方案" class="headerlink" title="3. snowflake方案"></a>3. snowflake方案</h2><h3 id="3-1-介绍"><a href="#3-1-介绍" class="headerlink" title="3.1 介绍"></a>3.1 介绍</h3><p>考虑到上述方案的缺陷，笔者调查了其他的生成方案，snowflake就是其中一种方案。<br>趋势递增和不够随机的问题，在snowflake完全可以解决，Snowflake ID有64bits长，由以下三部分组成：</p>
<p><img src="http://ovci9bs39.bkt.clouddn.com/snowflake-64bit.jpg" alt="snowflake" title="snowflake"></p>
<ol>
<li>第一位为0，不用。</li>
<li><p>timestamp—41bits,精确到ms，那就意味着其可以表示长达(2^41-1)/(1000360024*365)=139.5年，另外使用者可以自己定义一个开始纪元（epoch)，然后用(当前时间-开始纪元）算出time，这表示在time这个部分在140年的时间里是不会重复的，官方文档在这里写成了41bits，应该是写错了。另外，这里用time还有一个很重要的原因，就是可以直接更具time进行排序，对于twitter这种更新频繁的应用，时间排序就显得尤为重要了。</p>
</li>
<li><p>machine id—10bits,该部分其实由datacenterId和workerId两部分组成，这两部分是在配置文件中指明的。  </p>
<ul>
<li>datacenterId，方便搭建多个生成uid的service，并保证uid不重复，比如在datacenter0将机器0，1，2组成了一个生成uid的service，而datacenter1此时也需要一个生成uid的service，从本中心获取uid显然是最快最方便的，那么它可以在自己中心搭建，只要保证datacenterId唯一。如果没有datacenterId，即用10bits，那么在搭建一个新的service前必须知道目前已经在用的id，否则不能保证生成的id唯一，比如搭建的两个uid service中都有machine id为100的机器，如果其server时间相同，那么产生相同id的情况不可避免。</li>
<li>workerId是实际server机器的代号，最大到32，同一个datacenter下的workerId是不能重复的。它会被注册到consul上，确保workerId未被其他机器占用，并将host:port值存入，注册成功后就可以对外提供服务了。</li>
</ul>
</li>
<li><p>sequence id —12bits,该id可以表示4096个数字，它是在time相同的情况下，递增该值直到为0，即一个循环结束，此时便只能等到下一个ms到来，一般情况下4096/ms的请求是不太可能出现的，所以足够使用了。</p>
</li>
</ol>
<h3 id="3-2-实现思路"><a href="#3-2-实现思路" class="headerlink" title="3.2 实现思路"></a>3.2 实现思路</h3><p>snowflake方案，id服务端生成，不依赖DB，既能保证性能，且生成的id足够随机。每一毫秒，一台worker可以生成4096个id，如果超过，会阻塞到下一毫秒生成。<br>对于那些并发量很大的系统来说,显然是不够的, 那么这个时候就是通过datacenterId和workerId来做区分,这两个ID,分别是5bit,共10bit,最大值是1024(0-1023)个, 在这种情况下,snowflake一毫秒理论上最大能够生成的ID数量是约42W个,这是一个非常大的基数了,理论上能够满足绝大多数系统的并发量。</p>
<p>该方案依赖于系统时钟，需要考虑时钟回拨的问题。本地缓存上一次请求的lastTimestamp，一个线程过来获取id时，首先校验当前时间是否小于上一次ID生成的时间戳。如果小于说明系统时钟被修改过，回退在上一次ID生成时间之前应当抛出异常！如此可以解决运行中，系统时钟被修改的问题。</p>
<p>另一种情况是，server服务启动时，系统的时间被回拨（虽然比较极端，还是列在考虑中），这样有可能与之前生成的id冲突，全局不唯一。这边解决方法是利用项目的服务发现与注册组件consul，在consul集群存储最新的lastTimestamp，key为对应的machine-id。consul的一致性基于raft算法，并利用Gossip协议：</p>
<blockquote>
<p>Consul uses a gossip protocol to manage membership and broadcast messages to the cluster. All of this is provided through the use of the Serf library.</p>
</blockquote>
<p>具体的协议算法，可以参考<a href="https://www.consul.io/docs/internals/gossip.html" target="_blank" rel="external">Gossip</a>。<br>每次server实例启动时，实例化id生成bean的时候，会首先校验当前时间与consul集群中该worker对应的lastTimestamp大小，如果当前时间偏小，则抛出异常，服务启动失败并报警。</p>
<p>笔者项目暂时未分data center，所以machine-id部分都是以服务实例的workid代替。workid可以从配置中心获取，也可以本地配置。<br>简化的系统架构部署图如下：</p>
<p><img src="http://ovci9bs39.bkt.clouddn.com/data-center.png" alt="部署图" title="服务部署图"></p>
<p>consul集群这边作为提供naming service和kv存储的组件，每个服务部署后注册到consul集群，至于consul集群相关的信息，以及consul成员的一致性相关，后面单独一篇文章详细介绍。</p>
<p>请求id生成流程图如下：</p>
<p><img src="http://ovci9bs39.bkt.clouddn.com/id%20generator.jpg" alt="flow" title="工作流程图"></p>
<p>服务实例启动的流程图见上文，此处不画出了。这边需要强调的是，服务注册与发现组件consul。部署时每个服务实例都会注册到一个consul agent（一般是本机），consul agent连接到consul集群，通过gossip协议进行广播信息，所以如果连接的consul agent进程不幸挂掉（大多为系统宕机），在进程重启后，还是能迅速获取到集群中存储的该workid的lastTimestamp，针对该workid，如果系统时间回拨小于lastTimestamp，Generator启动时会报警。而对于大于lastTimestamp的情况，可能系统时钟还是相对回拨，我们姑且可以认为对全局id没有影响。</p>
<p>实例化时，进行校验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">IdServiceImpl</span><span class="params">(<span class="keyword">long</span> workerId, ConsulClient consulClient)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (workerId &gt; idMeta.MAX_ID || workerId &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"worker Id can't be greater than %d or less than 0"</span>, idMeta.MAX_ID));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.workerId = workerId;</div><div class="line">    <span class="keyword">this</span>.consulClient = consulClient;</div><div class="line">    validateStoredTimestamp();</div><div class="line">    log.info(<span class="string">"worker starting. timestamp left shift &#123;&#125;,  worker id bits &#123;&#125;, sequence bits &#123;&#125;, workerid &#123;&#125;"</span>, idMeta.TIMESTAMP_LEFT_SHIFT_BITS, idMeta.ID_BITS, idMeta.SEQUENCE_BITS, workerId);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>校验函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * checks for timestamp by workerId when server starts.</div><div class="line"> * if server starts for the first time, just let it go and log warns.</div><div class="line"> * if current timestamp is smaller than the value stored in consul server, throw exception.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateStoredTimestamp</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> current = timeGen();</div><div class="line">    Response&lt;GetValue&gt; keyValueResponse = consulClient.getKVValue(String.valueOf(workerId));</div><div class="line">    <span class="keyword">if</span> (keyValueResponse.getValue() != <span class="keyword">null</span>) &#123;</div><div class="line">        lastTimestamp = Long.parseLong(keyValueResponse.getValue().getDecodedValue());</div><div class="line">        validateTimestamp(current, lastTimestamp, Periods.START);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        log.warn(String.format(<span class="string">"clock in consul is null.  Generator works as for the 1st time."</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>validateTimestamp: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * 如果当前时间戳小于上一次ID生成的时间戳，说明系统时钟被修改过，回退在上一次ID生成时间之前应当抛出异常！！！</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lastTimestamp 上一次ID生成的时间戳</div><div class="line">     * <span class="doctag">@param</span> timestamp     当前时间戳</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateTimestamp</span><span class="params">(<span class="keyword">long</span> timestamp, <span class="keyword">long</span> lastTimestamp, Periods period)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</div><div class="line">            log.error(String.format(<span class="string">"clock is moving backwards.  Rejecting requests until %d."</span>, lastTimestamp));</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"Clock moved backwards in %s.  Refusing to generate id for %d milliseconds"</span>, period, lastTimestamp - timestamp));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>获取id方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * 生成ID（线程安全）</div><div class="line">  *</div><div class="line">  * <span class="doctag">@return</span> id</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">genId</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">long</span> timestamp = timeGen();</div><div class="line"></div><div class="line">     <span class="comment">//如果当前时间小于上一次ID生成的时间戳，说明系统时钟被修改过，回退在上一次ID生成时间之前应当抛出异常！！！</span></div><div class="line">     validateTimestamp(timestamp, lastTimestamp, Periods.RUNNING);</div><div class="line"></div><div class="line">     <span class="comment">//如果是同一时间生成的，则进行毫秒内sequence生成</span></div><div class="line">     <span class="keyword">if</span> (lastTimestamp == timestamp) &#123;</div><div class="line">         sequence = (sequence + <span class="number">1</span>) &amp; IdMeta.SEQUENCE_MASK;</div><div class="line">         <span class="comment">//溢出处理</span></div><div class="line">         <span class="keyword">if</span> (sequence == <span class="number">0</span>) &#123;<span class="comment">//阻塞到下一毫秒,获得新时间戳</span></div><div class="line">             timestamp = tilNextMillis(lastTimestamp);</div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;<span class="comment">//时间戳改变，毫秒内sequence重置</span></div><div class="line">         sequence = <span class="number">0L</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="comment">//上次生成ID时间截</span></div><div class="line">     lastTimestamp = timestamp;</div><div class="line">     consulClient.setKVValue(String.valueOf(workerId), String.valueOf(lastTimestamp));</div><div class="line">     <span class="comment">//移位并通过或运算组成64位ID</span></div><div class="line">     <span class="keyword">return</span> ((timestamp - idMeta.START_TIME) &lt;&lt; idMeta.TIMESTAMP_LEFT_SHIFT_BITS) | (workerId &lt;&lt; idMeta.ID_SHIFT_BITS) | sequence;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>这篇文章和大家分享了笔者项目中全局id生成服务的演进过程。当前的方案可以满足笔者当前项目的需求，至于分data-center（同一个机房优先调用），需要结合rpc调用进一步做处理，所以这块后续可以继续完善。欢迎大家提出建议。</p>
<p><strong>本文的源码地址：<br>GitHub：<a href="https://github.com/keets2012/snowflake-id-generator" target="_blank" rel="external">https://github.com/keets2012/snowflake-id-generator</a><br>码云： <a href="https://gitee.com/keets/snowflake-id-generator" target="_blank" rel="external">https://gitee.com/keets/snowflake-id-generator</a></strong></p>
<hr>
<p>参考：   </p>
<ol>
<li><a href="https://www.consul.io/docs" target="_blank" rel="external">www.consul.io</a></li>
<li><a href="https://tech.meituan.com/MT_Leaf.html" target="_blank" rel="external">leaf</a></li>
<li><a href="http://www.cnblogs.com/relucent/p/4955340.html" target="_blank" rel="external">Twitter的分布式自增ID算法snowflake (Java版)</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/09/09/snowflake/" data-id="cja25cxj3001xff6q1o43t2nq" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-ThreadLocal" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/09/04/ThreadLocal/">深入ThreadLocal</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/09/04/ThreadLocal/">
            <time datetime="2017-09-03T16:00:00.000Z" itemprop="datePublished">2017-09-04</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/java/">java</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Thread/">Thread</a>, <a class="tag-link" href="/tags/java/">java</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>ThreadLocal主要是提供线程内部的局部变量，在<code>每个</code>线程内随时随地可取，隔离其他线程。   </p>
<h2 id="1-ThreadLocal接口"><a href="#1-ThreadLocal接口" class="headerlink" title="1. ThreadLocal接口"></a>1. ThreadLocal接口</h2><h3 id="1-1-ThreadLocal类接口很简单，只有4个方法，我们先来了解一下："><a href="#1-1-ThreadLocal类接口很简单，只有4个方法，我们先来了解一下：" class="headerlink" title="1.1 ThreadLocal类接口很简单，只有4个方法，我们先来了解一下："></a>1.1 ThreadLocal类接口很简单，只有4个方法，我们先来了解一下：</h3><ul>
<li><code>void set(Object value)</code>设置当前线程的线程局部变量的值。</li>
<li><code>public Object get()</code>该方法返回当前线程所对应的线程局部变量。</li>
<li><code>public void remove()</code>将当前线程局部变量的值删除，目的是为了减少内存的占用，该方法是JDK 5.0新增的方法。需要指出的是，当线程结束后，对应该线程的局部变量将自动被垃圾回收，所以显式调用该方法清除线程的局部变量并不是必须的操作，但它可以加快内存回收的速度。</li>
<li><code>protected Object initialValue()</code>返回该线程局部变量的初始值，该方法是一个protected的方法，显然是为了让子类覆盖而设计的。这个方法是一个延迟调用方法，在线程第1次调用get()或set(Object)时才执行，并且仅执行1次。ThreadLocal中的缺省实现直接返回一个null。</li>
</ul>
<p>在同步机制中，通过对象的锁机制保证同一时间只有一个线程访问变量。这时该变量是多个线程共享的，使用同步机制要求程序慎密地分析什么时候对变量进行读写，什么时候需要锁定某个对象，什么时候释放对象锁等繁杂的问题，程序设计和编写难度相对较大。   </p>
<p>而ThreadLocal则从另一个角度来解决多线程的并发访问。ThreadLocal会为每一个线程提供一个独立的变量副本，从而隔离了多个线程对数据的访问冲突。因为每一个线程都拥有自己的变量副本，从而也就没有必要对该变量进行同步了。ThreadLocal提供了线程安全的共享对象，在编写多线程代码时，可以把不安全的变量封装进ThreadLocal。<br>如果想在get之前不需要调用set就能正常访问的话，必须重写initialValue()方法。最常见的ThreadLocal使用场景为 用来解决 数据库连接、Session管理等。</p>
<h3 id="1-2-使用ThreadLocal"><a href="#1-2-使用ThreadLocal" class="headerlink" title="1.2 使用ThreadLocal"></a>1.2 使用ThreadLocal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</div><div class="line">    ThreadLocal&lt;Long&gt; longLocal = <span class="keyword">new</span> ThreadLocal&lt;Long&gt;()&#123;</div><div class="line">        <span class="function"><span class="keyword">protected</span> Long <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Thread.currentThread().getId();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    ThreadLocal&lt;String&gt; stringLocal = <span class="keyword">new</span> ThreadLocal&lt;String&gt;()&#123;;</div><div class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Thread.currentThread().getName();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">()</span> </span>&#123;</div><div class="line">        longLocal.set(Thread.currentThread().getId());</div><div class="line">        stringLocal.set(Thread.currentThread().getName());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLong</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> longLocal.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> stringLocal.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">final</span> ThreadTest test = <span class="keyword">new</span> ThreadTest();</div><div class="line"></div><div class="line"></div><div class="line">        <span class="comment">//test.set();</span></div><div class="line">        System.out.println(<span class="string">"main.getLong: "</span> + test.getLong());</div><div class="line">        System.out.println(<span class="string">"main.getString: "</span> + test.getString());</div><div class="line"></div><div class="line"></div><div class="line">        Thread thread1 = <span class="keyword">new</span> Thread() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="comment">//test.set();</span></div><div class="line">                System.out.println(<span class="string">"Thread.getLong: "</span> + test.getLong());</div><div class="line">                System.out.println(<span class="string">"Thread.getString: "</span> + test.getString());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        thread1.start();</div><div class="line">        thread1.join();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上demo覆写了initialValue()方法，或者调用set方法，否则会报空指针异常。在main线程中和thread1线程中，longLocal保存的副本值和stringLocal保存的副本值都不一样。</p>
<h2 id="2-ThreadLocalMap"><a href="#2-ThreadLocalMap" class="headerlink" title="2. ThreadLocalMap"></a>2. ThreadLocalMap</h2><p>ThreadLocalMap的Entry继承了WeakReference，并且使用ThreadLocal作为键值。<br>　　1. 实际的通过ThreadLocal创建的副本是存储在每个线程自己的threadLocals中的；<br>　　2. 为何threadLocals的类型ThreadLocalMap的键值为ThreadLocal对象，因为每个线程中可有多个threadLocal变量，就像上面代码中的longLocal和stringLocal；<br>　　3. 在进行get之前，必须先set，否则会报空指针异常；
　</p>
<h3 id="2-1-方法分析"><a href="#2-1-方法分析" class="headerlink" title="2.1 方法分析"></a>2.1 方法分析</h3><p>1). JDK8的ThreadLocal的get方法的源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Returns the value in the current thread's copy of this</div><div class="line"> * thread-local variable.  If the variable has no value for the</div><div class="line"> * current thread, it is first initialized to the value returned</div><div class="line"> * by an invocation of the &#123;<span class="doctag">@link</span> #initialValue&#125; method.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the current thread's value of this thread-local</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">    Thread t = Thread.currentThread();</div><div class="line">    ThreadLocalMap map = getMap(t);</div><div class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">            T result = (T)e.value;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> setInitialValue();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2). getMap </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the map associated with a ThreadLocal. Overridden in</div><div class="line"> * InheritableThreadLocal.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span>  t the current thread</div><div class="line"> * <span class="doctag">@return</span> the map</div><div class="line"> */</div><div class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> t.threadLocals;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3). setInitialValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Variant of set() to establish initialValue. Used instead</div><div class="line"> * of set() in case user has overridden the set() method.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the initial value</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</div><div class="line">    T value = initialValue();</div><div class="line">    Thread t = Thread.currentThread();</div><div class="line">    ThreadLocalMap map = getMap(t);</div><div class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</div><div class="line">        map.set(<span class="keyword">this</span>, value);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        createMap(t, value);</div><div class="line">    <span class="keyword">return</span> value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>get方法的流程是这样的：</p>
<ul>
<li>1.首先获取当前线程</li>
<li>2.根据当前线程获取一个Map</li>
<li>3.如果获取的Map不为空，则在Map中以ThreadLocal的引用作为key来在Map中获取对应的value e，否则转到5</li>
<li>4.如果e不为null，则返回e.value，否则转到5</li>
<li>5.Map为空或者e为空，则通过initialValue函数获取初始值value，然后用ThreadLocal的引用和value作为firstKey和firstValue创建一个新的Map</li>
</ul>
<p>每个Thread维护一个ThreadLocalMap映射表，这个映射表的key是ThreadLocal实例本身，value是真正需要存储的Object。</p>
<h2 id="3-WeakReference"><a href="#3-WeakReference" class="headerlink" title="3. WeakReference"></a>3. WeakReference</h2><p>关于内存泄露：</p>
<blockquote>
<p>ThreadLocalMap使用ThreadLocal的弱引用作为key，如果一个ThreadLocal没有外部强引用引用他，那么系统gc的时候，这个ThreadLocal势必会被回收，这样一来，ThreadLocalMap中就会出现key为null的Entry，就没有办法访问这些key为null的Entry的value，如果当前线程再迟迟不结束的话，这些key为null的Entry的value就会一直存在一条强引用链：<br><code>ThreadLocal Ref -&gt; Thread -&gt; ThreaLocalMap -&gt; Entry -&gt; value</code></p>
</blockquote>
<p>主要看下getEntryAfterMiss函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</div><div class="line">            Entry[] tab = table;</div><div class="line">            <span class="keyword">int</span> len = tab.length;</div><div class="line"></div><div class="line">            <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">                ThreadLocal&lt;?&gt; k = e.get();</div><div class="line">                <span class="keyword">if</span> (k == key)</div><div class="line">                    <span class="keyword">return</span> e;</div><div class="line">                <span class="keyword">if</span> (k == <span class="keyword">null</span>)</div><div class="line">                    expungeStaleEntry(i);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    i = nextIndex(i, len);</div><div class="line">                e = tab[i];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>ThreadLocalMap的getEntry函数的流程：</p>
<ol>
<li>首先从ThreadLocal的直接索引位置(通过ThreadLocal.threadLocalHashCode &amp; (len-1)运算得到)获取Entry e，如果e不为null并且key相同则返回e；</li>
<li>如果e为null或者key不一致则向下一个位置查询，如果下一个位置的key和当前需要查询的key相等，则返回对应的Entry，否则，如果key值为null，则擦除该位置的Entry，否则继续向下一个位置查询</li>
</ol>
<p><strong>在这个过程中遇到的key为null的Entry都会被擦除，那么Entry内的value也就没有强引用链，自然会被回收。仔细研究代码可以发现，set操作也有类似的思想，将key为null的这些Entry都删除，防止内存泄露。 但是光这样还是不够的，上面的设计思路依赖一个前提条件：要调用ThreadLocalMap的genEntry函数或者set函数。这当然是不可能任何情况都成立的，所以很多情况下需要使用者手动调用ThreadLocal的remove函数，手动删除不再需要的ThreadLocal，防止内存泄露。所以JDK建议将ThreadLocal变量定义成private static的，这样的话ThreadLocal的生命周期就更长，由于一直存在ThreadLocal的强引用，所以ThreadLocal也就不会被回收，也就能保证任何时候都能根据ThreadLocal的弱引用访问到Entry的value值，然后remove它，防止内存泄露。</strong></p>
<hr>
<p>参考：<br><a href="https://www.zhihu.com/question/23089780" target="_blank" rel="external">ThreadLocal和synchronized的区别</a><br><a href="http://www.cnblogs.com/dolphin0520/p/3920407.html" target="_blank" rel="external">Java并发编程：深入剖析ThreadLocal</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/09/04/ThreadLocal/" data-id="cja25cxi00008ff6q2k78tmzy" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/14/aop/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/java/">java</a></p>
                            <p class="item-title"><a href="/2017/12/14/aop/" class="title">深入理解Spring AOP的动态代理</a></p>
                            <p class="item-date"><time datetime="2017-12-13T16:00:00.000Z" itemprop="datePublished">2017-12-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/10/integration/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/微服务/">微服务</a></p>
                            <p class="item-title"><a href="/2017/12/10/integration/" class="title">微服务架构中整合网关、权限服务</a></p>
                            <p class="item-date"><time datetime="2017-12-09T16:00:00.000Z" itemprop="datePublished">2017-12-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/05/apm2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Ops/">Ops</a></p>
                            <p class="item-title"><a href="/2017/12/05/apm2/" class="title">几种分布式调用链监控组件的实践与比较（二）比较</a></p>
                            <p class="item-date"><time datetime="2017-12-04T16:00:00.000Z" itemprop="datePublished">2017-12-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/11/20/config-server1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/微服务/">微服务</a></p>
                            <p class="item-title"><a href="/2017/11/20/config-server1/" class="title">微服务之分布式配置中心Cloud Config</a></p>
                            <p class="item-date"><time datetime="2017-11-19T16:00:00.000Z" itemprop="datePublished">2017-11-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/11/18/first-timeout/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/微服务/">微服务</a></p>
                            <p class="item-title"><a href="/2017/11/18/first-timeout/" class="title">Spring Cloud 服务第一次请求超时的优化</a></p>
                            <p class="item-date"><time datetime="2017-11-17T16:00:00.000Z" itemprop="datePublished">2017-11-18</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Note/">Note</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ops/">Ops</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Utils/">Utils</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/中间件/">中间件</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">4</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/APM/" style="font-size: 12.5px;">APM</a> <a href="/tags/Cluster/" style="font-size: 15px;">Cluster</a> <a href="/tags/Consensus/" style="font-size: 10px;">Consensus</a> <a href="/tags/Docker/" style="font-size: 12.5px;">Docker</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/HTTP2/" style="font-size: 12.5px;">HTTP2</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jersey/" style="font-size: 12.5px;">Jersey</a> <a href="/tags/Lombok/" style="font-size: 10px;">Lombok</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/OAuth2/" style="font-size: 20px;">OAuth2</a> <a href="/tags/Ops/" style="font-size: 12.5px;">Ops</a> <a href="/tags/REST/" style="font-size: 12.5px;">REST</a> <a href="/tags/Ribbon/" style="font-size: 10px;">Ribbon</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/Spring-Cloud/" style="font-size: 17.5px;">Spring Cloud</a> <a href="/tags/Spring-Security/" style="font-size: 20px;">Spring Security</a> <a href="/tags/Thread/" style="font-size: 10px;">Thread</a> <a href="/tags/cluster/" style="font-size: 10px;">cluster</a> <a href="/tags/consul/" style="font-size: 12.5px;">consul</a> <a href="/tags/gateway/" style="font-size: 12.5px;">gateway</a> <a href="/tags/java/" style="font-size: 12.5px;">java</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/micro-service/" style="font-size: 12.5px;">micro-service</a> <a href="/tags/mq/" style="font-size: 12.5px;">mq</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/snowflake/" style="font-size: 10px;">snowflake</a> <a href="/tags/spring-boot/" style="font-size: 10px;">spring boot</a> <a href="/tags/starter/" style="font-size: 10px;">starter</a> <a href="/tags/swagger/" style="font-size: 10px;">swagger</a> <a href="/tags/utils/" style="font-size: 10px;">utils</a> <a href="/tags/zipkin/" style="font-size: 12.5px;">zipkin</a> <a href="/tags/zuul/" style="font-size: 12.5px;">zuul</a> <a href="/tags/设计模式/" style="font-size: 17.5px;">设计模式</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 aoho<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>