<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Aoho&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="聚沙成塔！">
<meta property="og:type" content="website">
<meta property="og:title" content="Aoho&#39;s Blog">
<meta property="og:url" content="http://blueskykong.com/index.html">
<meta property="og:site_name" content="Aoho&#39;s Blog">
<meta property="og:description" content="聚沙成塔！">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Aoho&#39;s Blog">
<meta name="twitter:description" content="聚沙成塔！">
    

    
        <link rel="alternate" href="/" title="Aoho&#39;s Blog" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Aoho&#39;s Blog</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/uploads/avatar.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/uploads/avatar.jpg" />
            <h2 id="name">aoho</h2>
            <h3 id="title">Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>China</span>
            <a id="follow" target="_blank" href="https://github.com/keets2012">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                32
                <span>posts</span>
            </div>
            <div class="article-info-block">
                37
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-security1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现（一）</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/10/19/security1/">
            <time datetime="2017-10-18T16:00:00.000Z" itemprop="datePublished">2017-10-19</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Security/">Security</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OAuth2/">OAuth2</a>, <a class="tag-link" href="/tags/Spring-Security/">Spring Security</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            <p><p>引言： 本文系《认证鉴权与API权限控制在微服务架构中的设计与实现》系列的第一篇，本系列预计四篇文章讲解微服务下的认证鉴权与API权限控制的实现。</p>
<h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h2><p>最近在做权限相关服务的开发，在系统微服务化后，原有的单体应用是基于session的安全权限方式，不能满足现有的微服务架构的认证与鉴权需求。微服务架构下，一个应用会被拆分成若干个微应用，每个微应用都需要对访问进行鉴权，每个微应用都需要明确当前访问用户以及其权限。尤其当访问来源不只是浏览器，还包括其他服务的调用时，单体应用架构下的鉴权方式就不是特别合适了。在微服务架构下，要考虑外部应用接入的场景、用户–服务的鉴权、服务–服务的鉴权等多种鉴权场景。<br>比如用户A访问User Service，A如果未登录，则首先需要登录，请求获取授权token。获取token之后，A将携带着token去请求访问某个文件，这样就需要对A的身份进行校验，并且A可以访问该文件。<br>为了适应架构的变化、需求的变化，auth权限模块被单独出来作为一个基础的微服务系统，为其他业务service提供服务。<br></p>
            <p class="article-more-link">
                <a href="/2017/10/19/security1/#more">Read More</a>
            </p>
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/10/19/security1/" data-id="cja25cxix001mff6qnhb4nrhp" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-aop" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/14/aop/">深入理解Spring AOP的动态代理</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/14/aop/">
            <time datetime="2017-12-13T16:00:00.000Z" itemprop="datePublished">2017-12-14</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/java/">java</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/AOP/">AOP</a>, <a class="tag-link" href="/tags/java/">java</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-Spring-AOP"><a href="#1-Spring-AOP" class="headerlink" title="1. Spring AOP"></a>1. Spring AOP</h2><p>Spring是一个轻型容器，Spring整个系列的最最核心的概念当属IoC、AOP。可见AOP是Spring框架中的核心之一，在应用中具有非常重要的作用，也是Spring其他组件的基础。AOP（Aspect Oriented Programming），即面向切面编程，可以说是OOP（Object Oriented Programming，面向对象编程）的补充和完善。OOP引入封装、继承、多态等概念来建立一种对象层次结构，用于模拟公共行为的一个集合。不过OOP允许开发者定义纵向的关系，但并不适合定义横向的关系，例如日志功能。</p>
<p>关于AOP的基础知识，并不是本文的重点，我们主要来看下AOP的核心功能的底层实现机制：动态代理的实现原理。AOP的拦截功能是由java中的动态代理来实现的。在目标类的基础上增加切面逻辑，生成增强的目标类（该切面逻辑或者在目标类函数执行之前，或者目标类函数执行之后，或者在目标类函数抛出异常时候执行。不同的切入时机对应不同的Interceptor的种类，如BeforeAdviseInterceptor，AfterAdviseInterceptor以及ThrowsAdviseInterceptor等）。</p>
<p>那么动态代理是如何实现将切面逻辑（advise）织入到目标类方法中去的呢？下面我们就来详细介绍并实现AOP中用到的两种动态代理。</p>
<p>AOP的源码中用到了两种动态代理来实现拦截切入功能：jdk动态代理和cglib动态代理。两种方法同时存在，各有优劣。jdk动态代理是由java内部的反射机制来实现的，cglib动态代理底层则是借助asm来实现的。总的来说，反射机制在生成类的过程中比较高效，而asm在生成类之后的相关执行过程中比较高效（可以通过将asm生成的类进行缓存，这样解决asm生成类过程低效问题）。</p>
<p>下面我们分别来示例实现这两种方法。</p>
<h2 id="2-JDK动态代理"><a href="#2-JDK动态代理" class="headerlink" title="2. JDK动态代理"></a>2. JDK动态代理</h2><h3 id="2-1-定义接口与实现类"><a href="#2-1-定义接口与实现类" class="headerlink" title="2.1 定义接口与实现类"></a>2.1 定义接口与实现类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(UUID orderId, String name)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(UUID orderId, String name)</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getByName</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码定义了一个被拦截对象接口，即横切关注点。下面代码实现被拦截对象接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String user = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderServiceImpl</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderServiceImpl</span><span class="params">(String user)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setUser(user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(UUID orderId, String name)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"call save()方法,save:"</span> + name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(UUID orderId, String name)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"call update()方法"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getByName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"call getByName()方法"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"aoho"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-JDK动态代理类"><a href="#2-2-JDK动态代理类" class="headerlink" title="2.2 JDK动态代理类"></a>2.2 JDK动态代理类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDKProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">	<span class="comment">//需要代理的目标对象</span></div><div class="line">    <span class="keyword">private</span> Object targetObject;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">createProxyInstance</span><span class="params">(Object targetObject)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.targetObject = targetObject;</div><div class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(<span class="keyword">this</span>.targetObject.getClass().getClassLoader(),</div><div class="line">                <span class="keyword">this</span>.targetObject.getClass().getInterfaces(), <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    	<span class="comment">//被代理对象</span></div><div class="line">        OrderServiceImpl bean = (OrderServiceImpl) <span class="keyword">this</span>.targetObject;</div><div class="line">        Object result = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">//切面逻辑（advise），此处是在目标类代码执行之前</span></div><div class="line">        System.out.println(<span class="string">"---before invoke----"</span>);</div><div class="line">        <span class="keyword">if</span> (bean.getUser() != <span class="keyword">null</span>) &#123;</div><div class="line">            result = method.invoke(targetObject, args);</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"---after invoke----"</span>);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码实现了动态代理类JDKProxy，实现InvocationHandler接口，并且实现接口中的invoke方法。当客户端调用代理对象的业务方法时，代理对象执行invoke方法，invoke方法把调用委派给targetObject，相当于调用目标对象的方法，在invoke方法委派前判断权限，实现方法的拦截。</p>
<h3 id="2-3-测试"><a href="#2-3-测试" class="headerlink" title="2.3 测试"></a>2.3 测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOPTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        JDKProxy factory = <span class="keyword">new</span> JDKProxy();</div><div class="line">        <span class="comment">//Proxy为InvocationHandler实现类动态创建一个符合某一接口的代理实例  </span></div><div class="line">        OrderService orderService = (OrderService) factory.createProxyInstance(<span class="keyword">new</span> OrderServiceImpl(<span class="string">"aoho"</span>));</div><div class="line">		<span class="comment">//由动态生成的代理对象来orderService 代理执行程序</span></div><div class="line">        orderService.save(UUID.randomUUID(), <span class="string">"aoho"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">---before invoke----</div><div class="line">call save()方法,save:aoho</div><div class="line">---after invoke----</div></pre></td></tr></table></figure>
<h2 id="3-CGLIB字节码生成"><a href="#3-CGLIB字节码生成" class="headerlink" title="3. CGLIB字节码生成"></a>3. CGLIB字节码生成</h2><h3 id="3-1-要代理的类"><a href="#3-1-要代理的类" class="headerlink" title="3.1 要代理的类"></a>3.1 要代理的类</h3><p>CGLIB既可以对接口的类生成代理，也可以针对类生成代理。示例中，实现对类的代理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderManager</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String user = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OrderManager</span><span class="params">(String user)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.setUser(user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(UUID orderId, String name)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"call save()方法,save:"</span> + name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(UUID orderId, String name)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"call update()方法"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getByName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"call getByName()方法"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"aoho"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该类的实现和上面的接口实现一样，为了保持统一。</p>
<h3 id="3-2-CGLIB动态代理类"><a href="#3-2-CGLIB动态代理类" class="headerlink" title="3.2 CGLIB动态代理类"></a>3.2 CGLIB动态代理类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CGLibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line">    	<span class="comment">// CGLib需要代理的目标对象</span></div><div class="line">    	<span class="keyword">private</span> Object targetObject;</div><div class="line"></div><div class="line">       <span class="function"><span class="keyword">public</span> Object <span class="title">createProxyObject</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.targetObject = obj;</div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setSuperclass(obj.getClass());</div><div class="line">        <span class="comment">//回调方法的参数为代理类对象CglibProxy，最后增强目标类调用的是代理类对象CglibProxy中的intercept方法 </span></div><div class="line">        enhancer.setCallback(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">//增强后的目标类</span></div><div class="line">        Object proxyObj = enhancer.create();</div><div class="line">        <span class="comment">// 返回代理对象</span></div><div class="line">        <span class="keyword">return</span> proxyObj;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object proxy, Method method, Object[] args,</span></span></div><div class="line">                            MethodProxy methodProxy) <span class="keyword">throws</span> Throwable &#123;</div><div class="line">        Object obj = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">//切面逻辑（advise），此处是在目标类代码执行之前</span></div><div class="line">        System.out.println(<span class="string">"---before intercept----"</span>);</div><div class="line">        obj = method.invoke(targetObject, args);</div><div class="line">        System.out.println(<span class="string">"---after intercept----"</span>);</div><div class="line">        <span class="keyword">return</span> obj;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述实现了创建子类的方法与代理的方法。getProxy(SuperClass.class)方法通过入参即父类的字节码，扩展父类的class来创建代理对象。intercept()方法拦截所有目标类方法的调用，obj表示目标类的实例，method为目标类方法的反射对象，args为方法的动态入参，methodProxy为代理类实例。method.invoke(targetObject, args)通过代理类调用父类中的方法。</p>
<h3 id="3-3-测试"><a href="#3-3-测试" class="headerlink" title="3.3 测试"></a>3.3 测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOPTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        OrderManager order = (OrderManager) <span class="keyword">new</span> CGLibProxy().createProxyObject(<span class="keyword">new</span> OrderManager(<span class="string">"aoho"</span>));</div><div class="line">        order.save(UUID.randomUUID(), <span class="string">"aoho"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">---before intercept----</div><div class="line">call save()方法,save:aoho</div><div class="line">---after intercept----</div></pre></td></tr></table></figure>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文主要讲了Spring Aop动态代理实现的两种方式，并分别介绍了其优缺点。jdk动态代理的应用前提是目标类基于统一的接口。如果没有该前提，jdk动态代理不能应用。由此可以看出，jdk动态代理有一定的局限性，cglib这种第三方类库实现的动态代理应用更加广泛，且在效率上更有优势。</p>
<p>JDK动态代理机制是委托机制，不需要以来第三方的库，只要要JDK环境就可以进行代理，动态实现接口类，在动态生成的实现类里面委托为hanlder去调用原始实现类方法；CGLib 必须依赖于CGLib的类库，使用的是继承机制，是被代理类和代理类继承的关系，所以代理类是可以赋值给被代理类的，如果被代理类有接口，那么代理类也可以赋值给接口。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://ifeve.com/jdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%BB%A3%E7%90%86%E4%B8%8Ecglib%E4%BB%A3%E7%90%86%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/" target="_blank" rel="external">jdk动态代理代理与cglib代理原理探究</a></li>
<li><a href="http://blog.csdn.net/dreamrealised/article/details/12885739" target="_blank" rel="external">AOP的底层实现-CGLIB动态代理和JDK动态代理</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/12/14/aop/" data-id="cjb6jtuxr0000906q8sgd16i6" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-integration" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/10/integration/">微服务架构中整合网关、权限服务</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/10/integration/">
            <time datetime="2017-12-09T16:00:00.000Z" itemprop="datePublished">2017-12-10</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/微服务/">微服务</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/OAuth2/">OAuth2</a>, <a class="tag-link" href="/tags/Spring-Security/">Spring Security</a>, <a class="tag-link" href="/tags/gateway/">gateway</a>, <a class="tag-link" href="/tags/zuul/">zuul</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>前言：之前的文章有讲过微服务的权限系列和网关实现，都是孤立存在，本文将整合后端服务与网关、权限系统。安全权限部分的实现还讲解了基于前置验证的方式实现，但是由于与业务联系比较紧密，没有具体的示例。业务权限与业务联系非常密切，本次的整合项目将会把这部分的操作权限校验实现基于具体的业务服务。</p>
<h2 id="1-前文回顾与整合设计"><a href="#1-前文回顾与整合设计" class="headerlink" title="1. 前文回顾与整合设计"></a>1. 前文回顾与整合设计</h2><p>在<a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现</a>系列文章中，讲解了在微服务架构中Auth系统的授权认证和鉴权。在<a href="http://blueskykong.com/2017/11/13/gateway/">微服务网关</a>中，讲解了基于netflix-zuul组件实现的微服务网关。下面我们看一下这次整合的架构图。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E6%9D%83%E9%99%90%20%281%29.png" alt="ms" title="微服务架构权限"></p>
<p>整个流程分为两类：</p>
<ul>
<li>用户尚未登录。客户端（web和移动端）发起登录请求，网关对于登录请求直接转发到auth服务，auth服务对用户身份信息进行校验（整合项目省略用户系统，读者可自行实现，直接硬编码返回用户信息），最终将身份合法的token返回给客户端。</li>
<li>用户已登录，请求其他服务。这种情况，客户端的请求到达网关，网关会调用auth系统进行请求身份合法性的验证，验证不通则直接拒绝，并返回401；如果通过验证，则转发到具体服务，服务经过过滤器，根据请求头部中的userId，获取该user的安全权限信息。利用切面，对该接口需要的权限进行校验，通过则proceed，否则返回403。</li>
</ul>
<p>第一类其实比较简单，在讲解<a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现</a>就基本实现，现在要做的是与网关进行结合；第二类中，我们新建了一个后端服务，与网关、auth系统整合。</p>
<p>下面对整合项目涉及到的三个服务分别介绍。网关和auth服务的实现已经讲过，本文主要讲下这两个服务进行整合需要的改动，还有就是对于后端服务的主要实现进行讲解。</p>
<h2 id="2-gateway实现"><a href="#2-gateway实现" class="headerlink" title="2. gateway实现"></a>2. gateway实现</h2><p><a href="http://blueskykong.com/2017/11/13/gateway/">微服务网关</a>已经基本介绍完了网关的实现，包括服务路由、几种过滤方式等。这一节将重点介绍实际应用时的整合。对于需要修改增强的地方如下：</p>
<ul>
<li>区分暴露接口（即对外直接访问）和需要合法身份登录之后才能访问的接口</li>
<li>暴露接口直接放行，转发到具体服务，如登录、刷新token等</li>
<li>需要合法身份登录之后才能访问的接口，根据传入的Access token进行构造头部，头部主要包括userId等信息，可根据自己的实际业务在auth服务中进行设置。</li>
<li>最后，比较重要的一点，引入Spring Security的资源服务器配置，对于暴露接口设置permitAll()，其余接口进入身份合法性校验的流程，调用auth服务，如果通过则正常继续转发，否则抛出异常，返回401。</li>
</ul>
<p>绘制的流程图如下：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/gwflow.jpg" alt="gwflow" title="网关路由流程图"></p>
<h3 id="2-1-permitAll实现"><a href="#2-1-permitAll实现" class="headerlink" title="2.1 permitAll实现"></a>2.1 permitAll实现</h3><p>对外暴露的接口可以直接访问，这可以依赖配置文件，而配置文件又可以通过配置中心进行动态更新，所以不用担心有hard-code的问题。<br>在配置文件中定义需要permitall的路径。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">auth:</span></div><div class="line"><span class="attr">  permitall:</span></div><div class="line"><span class="bullet">    -</span></div><div class="line"><span class="attr">      pattern:</span> <span class="string">/login/**</span></div><div class="line"><span class="bullet">    -</span></div><div class="line"><span class="attr">      pattern:</span> <span class="string">/web/public/**</span></div></pre></td></tr></table></figure>
<p>服务启动时，读入相应的Configuration，下面的配置属性读取以auth开头的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"auth"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> PermitAllUrlProperties <span class="title">getPermitAllUrlProperties</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PermitAllUrlProperties();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然还需要有PermitAllUrlProperties对应的实体类，比较简单，不列出来了。</p>
<h3 id="2-2-加强头部"><a href="#2-2-加强头部" class="headerlink" title="2.2 加强头部"></a>2.2 加强头部</h3><p>Filter过滤器，它是Servlet技术中最实用的技术，Web开发人员通过Filter技术，对web服务器管理的所有web资源进行拦截。这边使用Filter进行头部增强，解析请求中的token，构造统一的头部信息，到了具体服务，可以利用头部中的userId进行操作权限获取与判断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderEnhanceFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> PermitAllUrlProperties permitAllUrlProperties;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//主要的过滤方法</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        String authorization = ((HttpServletRequest) servletRequest).getHeader(<span class="string">"Authorization"</span>);</div><div class="line">        String requestURI = ((HttpServletRequest) servletRequest).getRequestURI();</div><div class="line">        <span class="comment">// test if request url is permit all , then remove authorization from header</span></div><div class="line">        LOGGER.info(String.format(<span class="string">"Enhance request URI : %s."</span>, requestURI));</div><div class="line">        <span class="comment">//将isPermitAllUrl的请求进行传递</span></div><div class="line">        <span class="keyword">if</span>(isPermitAllUrl(requestURI) &amp;&amp; isNotOAuthEndpoint(requestURI)) &#123;</div><div class="line">        	<span class="comment">//移除头部，但不包括登录端点的头部</span></div><div class="line">            HttpServletRequest resetRequest = removeValueFromRequestHeader((HttpServletRequest) servletRequest);</div><div class="line">            filterChain.doFilter(resetRequest, servletResponse);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//判断是不是符合规范的头部</span></div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(authorization)) &#123;</div><div class="line">            <span class="keyword">if</span> (isJwtBearerToken(authorization)) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    authorization = StringUtils.substringBetween(authorization, <span class="string">"."</span>);</div><div class="line">                    String decoded = <span class="keyword">new</span> String(Base64.decodeBase64(authorization));</div><div class="line"></div><div class="line">                    Map properties = <span class="keyword">new</span> ObjectMapper().readValue(decoded, Map.class);</div><div class="line">					<span class="comment">//解析authorization中的token，构造USER_ID_IN_HEADER</span></div><div class="line">                    String userId = (String) properties.get(SecurityConstants.USER_ID_IN_HEADER);</div><div class="line"></div><div class="line">                    RequestContext.getCurrentContext().addZuulRequestHeader(SecurityConstants.USER_ID_IN_HEADER, userId);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    LOGGER.error(<span class="string">"Failed to customize header for the request"</span>, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//为了适配，设置匿名头部</span></div><div class="line">            RequestContext.getCurrentContext().addZuulRequestHeader(SecurityConstants.USER_ID_IN_HEADER, ANONYMOUS_USER_ID);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        filterChain.doFilter(servletRequest, servletResponse);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//...</span></div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码列出了头部增强的基本处理流程，将isPermitAllUrl的请求进行直接传递，否则判断是不是符合规范的头部，然后解析authorization中的token，构造USER_ID_IN_HEADER。最后为了适配，设置匿名头部。<br>需要注意的是，HeaderEnhanceFilter也要进行注册。Spring 提供了FilterRegistrationBean类，此类提供setOrder方法，可以为filter设置排序值，让spring在注册web filter之前排序后再依次注册。</p>
<h3 id="2-3-资源服务器配置"><a href="#2-3-资源服务器配置" class="headerlink" title="2.3 资源服务器配置"></a>2.3 资源服务器配置</h3><p>利用资源服务器的配置，控制哪些是暴露端点不需要进行身份合法性的校验，直接路由转发，哪些是需要进行身份loadAuthentication，调用auth服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@EnableResourceServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//... </span></div><div class="line">	<span class="comment">//配置permitAll的请求pattern，依赖于permitAllUrlProperties对象</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        http.csrf().disable()</div><div class="line">                .requestMatchers().antMatchers(<span class="string">"/**"</span>)</div><div class="line">                .and()</div><div class="line">                .authorizeRequests()</div><div class="line">                .antMatchers(permitAllUrlProperties.getPermitallPatterns()).permitAll()</div><div class="line">                .anyRequest().authenticated();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//通过自定义的CustomRemoteTokenServices，植入身份合法性的相关验证</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        CustomRemoteTokenServices resourceServerTokenServices = <span class="keyword">new</span> CustomRemoteTokenServices();</div><div class="line">        <span class="comment">//...</span></div><div class="line">        resources.tokenServices(resourceServerTokenServices);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>资源服务器的配置大家看了笔者之前的文章应该很熟悉，此处不过多重复讲了。关于<code>ResourceServerSecurityConfigurer</code>配置类，之前的安全系列文章已经讲过，<code>ResourceServerTokenServices</code>接口，当时我们也用到了，只不过用的是默认的<code>DefaultTokenServices</code>。这边通过自定义的<code>CustomRemoteTokenServices</code>，植入身份合法性的相关验证。</p>
<p>当然这个配置还要引入Spring Cloud Security oauth2的相应依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="2-4-自定义RemoteTokenServices实现"><a href="#2-4-自定义RemoteTokenServices实现" class="headerlink" title="2.4 自定义RemoteTokenServices实现"></a>2.4 自定义RemoteTokenServices实现</h3><p><code>ResourceServerTokenServices</code>接口其中的一个实现是<code>RemoteTokenServices</code>。</p>
<blockquote>
<p> Queries the /check_token endpoint to obtain the contents of an access token.<br>If the endpoint returns a 400 response, this indicates that the token is invalid.</p>
</blockquote>
<p><code>RemoteTokenServices</code>主要是查询auth服务的<code>/check_token</code>端点以获取一个token的校验结果。如果有错误，则说明token是不合法的。笔者这边的的<code>CustomRemoteTokenServices</code>实现就是沿用该思路。需要注意的是，笔者的项目基于Spring cloud，auth服务是多实例的，所以这边使用了Netflix Ribbon获取auth服务进行负载均衡。Spring Cloud Security添加如下默认配置，对应auth服务中的相应端点。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attr">security:</span></div><div class="line"><span class="attr">  oauth2:</span></div><div class="line"><span class="attr">    client:</span></div><div class="line"><span class="attr">      accessTokenUri:</span> <span class="string">/oauth/token</span></div><div class="line"><span class="attr">      clientId:</span> <span class="string">gateway</span></div><div class="line"><span class="attr">      clientSecret:</span> <span class="string">gateway</span></div><div class="line"><span class="attr">    resource:</span></div><div class="line"><span class="attr">      userInfoUri:</span> <span class="string">/user</span></div><div class="line"><span class="attr">      token-info-uri:</span> <span class="string">/oauth/check_token</span></div></pre></td></tr></table></figure>
<p>至于具体的<code>CustomRemoteTokenServices</code>实现，可以参考上面讲的思路以及<code>RemoteTokenServices</code>，很简单，此处略去。</p>
<p>至此，网关服务的增强完成，下面看一下我们对auth服务和后端backend服务的实现。<br><strong>强调一下，为什么头部传递的userId等信息需要在网关构造？读者可以自己思考一下，结合安全等方面，😆笔者暂时不给出答案。</strong></p>
<h2 id="3-auth整合"><a href="#3-auth整合" class="headerlink" title="3. auth整合"></a>3. auth整合</h2><p>auth服务的整合修改，其实没那么多，之前对于user、role以及permission之间的定义和关系没有给出实现，这部分的sql语句已经在auth.sql中。所以为了能给出一个完整的实例，笔者把这部分实现给补充了，主要就是user-role，role、role-permission的相应接口定义与实现，实现增删改查。   </p>
<p>读者要是想参考整合项目进行实际应用，这部分完全可以根据自己的业务进行增强，包括token的创建，其自定义的信息还可以在网关中进行统一处理，构造好之后传递给后端服务。</p>
<p>这边的接口只是列出了需要的几个，其他接口没写（因为懒。。）</p>
<p>这两个接口也是给backend项目用来获取相应的userId权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//根据userId获取用户对应的权限</span></div><div class="line"> <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/api/userPermissions?userId=&#123;userId&#125;"</span>,</div><div class="line">            consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class="line">    <span class="function">List&lt;Permission&gt; <span class="title">getUserPermissions</span><span class="params">(@RequestParam(<span class="string">"userId"</span>)</span> String userId)</span>;</div><div class="line"></div><div class="line"><span class="comment">//根据userId获取用户对应的accessLevel（好像暂时没用到。。）</span></div><div class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET, value = <span class="string">"/api/userAccesses?userId=&#123;userId&#125;"</span>,</div><div class="line">            consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)</div><div class="line">    <span class="function">List&lt;UserAccess&gt; <span class="title">getUserAccessList</span><span class="params">(@RequestParam(<span class="string">"userId"</span>)</span> String userId)</span>;</div></pre></td></tr></table></figure>
<p>好了，这边的实现已经讲完了，具体见项目中的实现。</p>
<h2 id="4-backend项目实现"><a href="#4-backend项目实现" class="headerlink" title="4. backend项目实现"></a>4. backend项目实现</h2><p>本节是进行实现一个backend的实例，后端项目主要实现哪些功能呢？我们考虑一下，之前网关服务和auth服务所做的准备：</p>
<ul>
<li>网关构造的头部userId（可能还有其他信息，这边只是示例），可以在backend获得</li>
<li>转发到backend服务的请求，都是经过身份合法性校验，或者是直接对外暴露的接口</li>
<li>auth服务，提供根据userId进行获取相应的权限的接口</li>
</ul>
<p>根据这些，笔者绘制了一个backend的通用流程图：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/backend%E6%B5%81%E7%A8%8B.png" alt="bf" title="backend流程图"></p>
<p>上面的流程图其实已经非常清晰了，首先经过filter过滤器，填充<code>SecurityContextHolder</code>的上下文。其次，通过切面来实现注解，是否需要进入切面表达式处理。不需要的话，直接执行接口内的方法；否则解析注解中需要的权限，判断是否有权限执行，有的话继续执行，否则返回403 forbidden。</p>
<h3 id="4-1-filter过滤器"><a href="#4-1-filter过滤器" class="headerlink" title="4.1 filter过滤器"></a>4.1 filter过滤器</h3><p>Filter过滤器，和上面网关使用一样，拦截客户的HttpServletRequest。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> FeignAuthClient feignAuthClient;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</div><div class="line">        logger.info(<span class="string">"过滤器正在执行..."</span>);</div><div class="line">        <span class="comment">// pass the request along the filter chain</span></div><div class="line">        String userId = ((HttpServletRequest) servletRequest).getHeader(SecurityConstants.USER_ID_IN_HEADER);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(userId)) &#123;</div><div class="line">            UserContext userContext = <span class="keyword">new</span> UserContext(UUID.fromString(userId));</div><div class="line">            userContext.setAccessType(AccessType.ACCESS_TYPE_NORMAL);</div><div class="line"></div><div class="line">            List&lt;Permission&gt; permissionList = feignAuthClient.getUserPermissions(userId);</div><div class="line">            List&lt;SimpleGrantedAuthority&gt; authorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            <span class="keyword">for</span> (Permission permission : permissionList) &#123;</div><div class="line">                SimpleGrantedAuthority authority = <span class="keyword">new</span> SimpleGrantedAuthority();</div><div class="line">                authority.setAuthority(permission.getPermission());</div><div class="line">                authorityList.add(authority);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            CustomAuthentication userAuth  = <span class="keyword">new</span> CustomAuthentication();</div><div class="line">            userAuth.setAuthorities(authorityList);</div><div class="line">            userContext.setAuthorities(authorityList);</div><div class="line">            userContext.setAuthentication(userAuth);</div><div class="line">            SecurityContextHolder.setContext(userContext);</div><div class="line">        &#125;</div><div class="line">        filterChain.doFilter(servletRequest, servletResponse);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	<span class="comment">//...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码主要实现了，根据请求头中的userId，利用feign client获取auth服务中的该user所具有的权限集合。之后构造了一个UserContext，UserContext是自定义的，实现了Spring Security的<code>UserDetails, SecurityContext</code>接口。</p>
<h3 id="4-2-通过切面来实现-PreAuth注解"><a href="#4-2-通过切面来实现-PreAuth注解" class="headerlink" title="4.2 通过切面来实现@PreAuth注解"></a>4.2 通过切面来实现@PreAuth注解</h3><p>基于Spring的项目，使用Spring的AOP切面实现注解是比较方便的一件事，这边我们使用了自定义的注解<code>@PreAuth</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PreAuth &#123;</div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Target用于描述注解的使用范围，超出范围时编译失败,可以用在方法或者类上面。在运行时生效。不了解注解相关知识的，可以自行Google。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthAspect</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.blueskykong.auth.demo.annotation.PreAuth)"</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 定制一个环绕通知，当想获得注解里面的属性，可以直接注入该注解</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> joinPoint</div><div class="line">     * <span class="doctag">@param</span> preAuth</div><div class="line">     */</div><div class="line">    <span class="meta">@Around</span>(<span class="string">"cut()&amp;&amp;@annotation(preAuth)"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">record</span><span class="params">(ProceedingJoinPoint joinPoint, PreAuth preAuth)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		<span class="comment">//取出注解中的表达式</span></div><div class="line">        String value = preAuth.value();</div><div class="line">        <span class="comment">//Spring EL 对value进行解析</span></div><div class="line">        SecurityExpressionOperations operations = <span class="keyword">new</span> CustomerSecurityExpressionRoot(SecurityContextHolder.getContext().getAuthentication());</div><div class="line">        StandardEvaluationContext operationContext = <span class="keyword">new</span> StandardEvaluationContext(operations);</div><div class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</div><div class="line">        Expression expression = parser.parseExpression(value);</div><div class="line">        <span class="comment">//获取表达式判断的结果</span></div><div class="line">        <span class="keyword">boolean</span> result = expression.getValue(operationContext, <span class="keyword">boolean</span>.class);</div><div class="line">        <span class="keyword">if</span> (result) &#123;</div><div class="line">        	<span class="comment">//继续执行接口内的方法</span></div><div class="line">            <span class="keyword">return</span> joinPoint.proceed();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Forbidden"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为Aspect作用在bean上，所以先用Component把这个类添加到容器中。<code>@Pointcut</code>定义要拦截的注解。<code>@Around</code>定制一个环绕通知，当想获得注解里面的属性，可以直接注入该注解。切面表达式内主要实现了，利用Spring EL对value进行解析，将<code>SecurityContextHolder.getContext()</code>转换成标准的操作上下文，然后解析注解中的表达式，最后获取对表达式判断的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerSecurityExpressionRoot</span> <span class="keyword">extends</span> <span class="title">SecurityExpressionRoot</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomerSecurityExpressionRoot</span><span class="params">(Authentication authentication)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(authentication);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>CustomerSecurityExpressionRoot</code>继承的是抽象类<code>SecurityExpressionRoot</code>，而我们用到的实际表达式是定义在<code>SecurityExpressionOperations</code>接口，<code>SecurityExpressionRoot</code>又实现了<code>SecurityExpressionOperations</code>接口。不过这里面的具体判断实现，Spring Security 调用的也是Spring EL。</p>
<h3 id="4-3-controller接口"><a href="#4-3-controller接口" class="headerlink" title="4.3 controller接口"></a>4.3 controller接口</h3><p>下面我们看看最终接口是怎么用上面实现的注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/test"</span>, method = RequestMethod.GET)</div><div class="line"><span class="meta">@PreAuth</span>(<span class="string">"hasAuthority('CREATE_COMPANY')"</span>) <span class="comment">// 还可以定义很多表达式，如hasRole('Admin')</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"ok"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@PreAuth</code>中，可以定义的表达式很多，可以看<code>SecurityExpressionOperations</code>接口中的方法。目前笔者只是实现了<code>hasAuthority()</code>表达式，如果你想支持其他所有表达式，只需要构造相应的<code>SecurityContextHolder</code>即可。</p>
<h3 id="4-4-为什么这样设计？"><a href="#4-4-为什么这样设计？" class="headerlink" title="4.4 为什么这样设计？"></a>4.4 为什么这样设计？</h3><p>有些读者看了上面的设计，既然好多用到了Spring Security的工具类，肯定会问，为什么要引入这么复杂的工具类？   </p>
<p>其实很简单，首先因为<code>SecurityExpressionOperations</code>接口中定义的表达式足够多，且较为合理，能够覆盖我们在平时用到的大部分场景；其次，笔者之前的设计是直接在注解中指定所需权限，没有扩展性，且可读性差；最后，Spring Security 4 确实引入了<code>@PreAuthorize,@PostAuthorize</code>等注解，本来想用来着，自己尝试了一下，发现对于微服务架构这样的接口级别的操作权限校验不是很适合，十多个过滤器太过复杂，而且还涉及到的Principal、Credentials等信息，这些已经在auth系统实现了身份合法性校验。笔者认为这边的功能实现并不是很复杂，需要很轻量的实现，读者有兴趣可以试着这部分的实现封装成jar包或者Spring Boot的starter。</p>
<h3 id="4-5-后期优化"><a href="#4-5-后期优化" class="headerlink" title="4.5 后期优化"></a>4.5 后期优化</h3><p>优化的地方主要有两点：</p>
<ul>
<li>现在的设计是，每次请求过来都会去调用auth服务获取该user相应的权限信息。而后端微服务数量有很多，没必要每个服务，或者说一个服务的多个服务实例，每次都去调用auth服务，笔者认为完全可以引入redis集群的缓存机制，在请求到达一个服务的某个实例时，首先去查询对应的user的缓存中的权限，如果没有再调用auth服务，最后写入redis缓存。当然，如果权限更新了，在auth服务肯定要delete相应的user权限缓存。</li>
<li>关于被拒绝的请求，在切面表达式中，直接返回了对象，笔者认为可以和response status 403进行绑定，定制返回对象的内容，返回的response更加友好。</li>
</ul>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>如上，首先讲了整合的设计思路，主要包含三个服务：gateway、auth和backend demo。整合的项目，总体比较复杂，其中gateway服务扩充了好多内容，对于暴露的接口进行路由转发，这边引入了Spring Security 的starter，配置资源服务器对暴露的路径进行放行；对于其他接口需要调用auth服务进行身份合法性校验，保证到达backend的请求都是合法的或者公开的接口；auth服务在之前的基础上，补充了role、permission、user相应的接口，供外部调用；backend demo是新起的服务，实现了接口级别的操作权限的校验，主要用到了自定义注解和Spring AOP切面。</p>
<p>由于实现的细节实在有点多，本文限于篇幅，只对部分重要的实现进行列出与讲解。如果读者有兴趣实际的应用，可以根据实际的业务进行扩增一些信息，如auth授权的token、网关拦截请求构造的头部信息、注解支持的表达式等等。</p>
<p>可以优化的地方当然还有很多，整合项目中设计不合理的地方，各位同学可以多多提意见。</p>
<h4 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h4><ol>
<li><a href="http://blueskykong.com/2017/11/13/gateway/">微服务网关netflix-zuul</a></li>
<li><a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现（一）</a></li>
<li><a href="http://blueskykong.com/2017/10/22/security2/">认证鉴权与API权限控制在微服务架构中的设计与实现（二）</a></li>
<li><a href="http://blueskykong.com/2017/10/24/security3/">认证鉴权与API权限控制在微服务架构中的设计与实现（三）</a></li>
<li><a href="http://blueskykong.com/2017/10/26/security4/">认证鉴权与API权限控制在微服务架构中的设计与实现（四）</a></li>
</ol>
<h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p><strong>网关、auth权限服务和backend服务的整合项目地址为：<br>GitHub：<a href="https://github.com/keets2012/microservice-integration" target="_blank" rel="external">https://github.com/keets2012/microservice-integration</a><br>或者 码云：<a href="https://gitee.com/keets/microservice-integration" target="_blank" rel="external">https://gitee.com/keets/microservice-integration</a></strong></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/12/10/integration/" data-id="cjb0vlzu80000v66q8wbetfnp" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-apm2" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/12/05/apm2/">几种分布式调用链监控组件的实践与比较（二）比较</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/12/05/apm2/">
            <time datetime="2017-12-04T16:00:00.000Z" itemprop="datePublished">2017-12-05</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Ops/">Ops</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/APM/">APM</a>, <a class="tag-link" href="/tags/micro-service/">micro-service</a>, <a class="tag-link" href="/tags/zipkin/">zipkin</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>引言：最近在调研与选型分布式调用链监控组件。选了主要的三种APM组件进行了实践与比较。本来打算一篇文章写完的，篇幅太长，打算分两篇。距离<a href="http://blueskykong.com/2017/11/10/apm1/">第一篇</a>已经有近一个月时间了，主要最近工作比较忙，更新很慢。本文将会讲下几种APM选型的比较与性能测试。</p>
<h2 id="1-前文回顾"><a href="#1-前文回顾" class="headerlink" title="1. 前文回顾"></a>1. 前文回顾</h2><p>上一篇文章主要讲了三种分布式调用链监控组件的实践。问题的背景由微服务架构展开，微服务的好处已经不用多说，而微服务的多了之后，千头万绪，下面这张图经常被用到。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/complextreace.png" alt="mcd" title="微服务调用链"></p>
<p>系统的复杂度因此提升。系统越复杂，越难解决问题，例如系统失败或者性能问题。在三层架构中找到解决方案还不是太难，仅仅需要分析3个组件比如web服务器，应用服务器和数据库，而服务器数量也不多。但是，如果问题发生在n层架构中，就需要调查大量的组件和服务器。另一个问题是仅仅分析单个组件很难看到大局;当发生一个低可见度的问题时，系统复杂度越高，就需要更长的时间来查找原因。最糟糕的是，某些情况下我们甚至可能无法查找出来。   </p>
<p>上面其实已经提到存在的故障定位问题，基于微服务体系之下构建的业务系统存在的问题基本上分为三类：</p>
<ul>
<li>故障定位难，一个简单操作，其背后可能是由十几个微服务共同完成的，这些微服务也由不同的团队去负责。一旦出现问题，最坏情况下我们也许需要这十几个团队一起来解决问题。</li>
<li>链路梳理难，应用没有形成应用拓扑，不知道自己的服务下游会影响其他哪些人。</li>
<li>资源浪费多，容量预估难。对于一些服务，其消耗的cpm和memory可能连10%不到，远远没有充分利用物理机。这其实和容量预估关联，过大或者过小估算峰值的机器容量，都是浪费。</li>
</ul>
<p>APM主要的目的就是解决上面所说的这四个问题，主要的手段是通过收集、存储、分析、分布式系统中的调用事件数据，协助开发运营人员进行故障诊断、容量预估、性能瓶颈定位以及调用链路梳理。第一篇其实已经讲过链路监控组件的需求：</p>
<ul>
<li>代码的侵入性</li>
<li>探针的性能消耗</li>
<li>全面的调用链路数据分析</li>
<li>可扩展性 </li>
</ul>
<p>这边列一下pinpoint在其wiki中提到的几点：</p>
<ul>
<li>分布式事务跟踪，跟踪跨分布式应用的消息</li>
<li>自动检测应用拓扑，帮助你搞清楚应用的架构</li>
<li>水平扩展以便支持大规模服务器集群</li>
<li>提供代码级别的可见性以便轻松定位失败点和瓶颈</li>
<li>使用字节码增强技术，添加新功能而无需修改代码</li>
</ul>
<p>下面我们沿着这些需求，看一下这几种分布式调用链监控组件。</p>
<h2 id="2-AMP比较"><a href="#2-AMP比较" class="headerlink" title="2. AMP比较"></a>2. AMP比较</h2><p>上面列了需求，但是不够通用，笔者将需要对比的项提炼出来：</p>
<ol>
<li>探针的性能<br> 主要是agent对服务的吞吐量、CPU和内存的影响。微服务的规模和动态性使得数据收集的成本大幅度提高。</li>
<li>collector的可扩展性<br> 能够水平扩展以便支持大规模服务器集群。</li>
<li>全面的调用链路数据分析<br> 提供代码级别的可见性以便轻松定位失败点和瓶颈。</li>
<li>对于开发透明，容易开关<br> 添加新功能而无需修改代码，容易启用或者禁用。</li>
<li>完整的调用链应用拓扑<br> 自动检测应用拓扑，帮助你搞清楚应用的架构</li>
</ol>
<p>笔者根据主要的需求，提炼出如上五点。</p>
<h3 id="2-1-探针的性能"><a href="#2-1-探针的性能" class="headerlink" title="2.1 探针的性能"></a>2.1 探针的性能</h3><p>笔者其实也是比较关注探针的性能，毕竟APM定位还是工具，如果启用了链路监控组建后，直接导致吞吐量降低过半，那也是不能接受的。笔者对skywalking、zipkin、pinpoint进行了压测，并与基线（未使用探针）的情况进行了对比。 </p>
<p>选用了一个常见的基于Spring的应用程序，他包含Spring Boot, Spring MVC，redis客户端，mysql。 监控这个应用程序，每个trace，探针会抓取5个span(1 Tomcat, 1 SpringMVC, 2 Jedis, 1 Mysql)。这边基本和<a href="https://skywalkingtest.github.io/Agent-Benchmarks/README_zh.html" target="_blank" rel="external">skywalkingtest</a>的测试应用差不多。</p>
<p>模拟了三种并发用户：500，750，1000。使用jmeter测试，每个线程发送30个请求，设置思考时间为10ms。使用的采样率为1，即100%，这边与产线可能有差别。pinpoint默认的采样率为20，即50%，通过设置agent的配置文件改为100%。zipkin默认也是1。组合起来，一共有12种。下面看下汇总表。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/apm-compare.jpg" alt="ac" title="性能对比"></p>
<p>从上表可以看出，在三种链路监控组件中，skywalking的探针对吞吐量的影响最小，zipkin的吞吐量居中。pinpoint的探针对吞吐量的影响较为明显，在500并发用户时，测试服务的吞吐量从1385降低到774，影响很大。然后再看下CPU和memory的影响，笔者是在内部服务器进行的压测，对CPU和memory的影响都差不多在10%之内。</p>
<h3 id="2-2-collector的可扩展性"><a href="#2-2-collector的可扩展性" class="headerlink" title="2.2 collector的可扩展性"></a>2.2 collector的可扩展性</h3><p>collector的可扩展性，使得能够水平扩展以便支持大规模服务器集群。</p>
<ul>
<li>zipkin<br>在前一篇文章中，我们开发了zipkin-Server（其实就是提供的开箱即用包），zipkin-agent与zipkin-Server通过http或者mq进行通信，http通信会对正常的访问造成影响，所以还是推荐基于mq异步方式通信，zipkin-Server通过订阅具体的topic进行消费。这个当然是可以扩展的，多个zipkin-Server实例进行异步消费mq中的监控信息。</li>
</ul>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/td7.jpg" alt="zk" title="zipkin"></p>
<ul>
<li>skywalking<br>skywalking的collector支持两种部署方式：单机和集群模式。collector与agent之间的通信使用了gRPC。</li>
<li>pinpoint<br>同样，pinpoint也是支持集群和单机部署的。pinpoint agent通过thrift通信框架，发送链路信息到collector。</li>
</ul>
<h3 id="2-3-全面的调用链路数据分析"><a href="#2-3-全面的调用链路数据分析" class="headerlink" title="2.3 全面的调用链路数据分析"></a>2.3 全面的调用链路数据分析</h3><p>全面的调用链路数据分析，提供代码级别的可见性以便轻松定位失败点和瓶颈。</p>
<ul>
<li>zipkin</li>
</ul>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/zipkin-info.jpg" alt="zipkininfo" title="zipkin链路调用分析"><br>zipkin的链路监控粒度相对没有那么细，从上图可以看到调用链中具体到接口级别，再进一步的调用信息并未涉及。</p>
<ul>
<li>skywalking</li>
</ul>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/sw-info.jpg" alt="swinfo" title="skywalking链路调用分析"></p>
<p>skywalking 还支持20+的中间件、框架、类库，比如主流的dubbo、Okhttp，还有DB和消息中间件。上图skywalking链路调用分析截取的比较简单，网关调用user服务，由于支持众多的中间件，所以skywalking链路调用分析比zipkin完备些。</p>
<ul>
<li>pinpoint</li>
</ul>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/pp-info.jpg" alt="ppinfo" title="pinpoint链路调用分析"></p>
<p>pinpoint应该是这三种APM组件中，数据分析最为完备的组件。提供代码级别的可见性以便轻松定位失败点和瓶颈，上图可以看到对于执行的sql语句，都进行了记录。还可以配置报警规则等，设置每个应用对应的负责人，根据配置的规则报警，支持的中间件和框架也比较完备。</p>
<h3 id="2-4-对于开发透明，容易开关"><a href="#2-4-对于开发透明，容易开关" class="headerlink" title="2.4 对于开发透明，容易开关"></a>2.4 对于开发透明，容易开关</h3><p>对于开发透明，容易开关，添加新功能而无需修改代码，容易启用或者禁用。我们期望功能可以不修改代码就工作并希望得到代码级别的可见性。  </p>
<p>对于这一点，Zipkin 使用修改过的类库和它自己的容器(Finagle)来提供分布式事务跟踪的功能。但是，它要求在需要时修改代码。skywalking和pinpoint都是基于字节码增强的方式，开发人员不需要修改代码，并且可以收集到更多精确的数据因为有字节码中的更多信息。</p>
<h3 id="2-5-完整的调用链应用拓扑"><a href="#2-5-完整的调用链应用拓扑" class="headerlink" title="2.5 完整的调用链应用拓扑"></a>2.5 完整的调用链应用拓扑</h3><p>自动检测应用拓扑，帮助你搞清楚应用的架构。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/ppreal.jpg" alt="ppreal" title="pinpoint链路拓扑"></p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/skreal.jpg" alt="skyreal" title="skywalking链路拓扑"></p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/zipdependency1.jpg" alt="zipkinreal" title="zipkin dependency"></p>
<p>上面三幅图，分别展示了APM组件各自的调用拓扑，都能实现完整的调用链应用拓扑。相对来说，pinpoint界面显示的更加丰富，具体到调用的DB名，zipkin的拓扑局限于服务于服务之间。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h2><p>本文讲了三种分布式调用链监控组件的比较，主要从五方面着手，笔者对每一项都进了对比。至于具体选用哪款组件，大家可以根据实际的业务需求和场景进行选型，上面比较的数据仅供参考。这三款都是开源项目，一般公司都对针对实际情况进行一些二次开发，比如增加一些组件的支持、对接现存的大数据平台等等。</p>
<p>最后，看了eagleEye的相关介绍，想提下监控系统如何从被动报警转化为主动发现，其实和AIOps很密切。链路监控数据量很大，尽管可以通过压缩比来降低传输的数据量，但是我们真的需要存储每一条链路吗？是不是只需要识别每一个链路当中出现异常的情况。时序指标当中的异常点，那个时间点我们要识别出来。识别完了之后，对异常进行关联，定位出最后的问题。当然这个涉及到业务和应用系统层面，很复杂，但笔者认为是后面AIOps的大趋势。</p>
<h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p><a href="http://blueskykong.com/2017/11/10/apm1/">几种分布式调用链监控组件的实践与比较（一）实践</a></p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://github.com/naver/pinpoint/wiki/Technical-Overview-Of-Pinpoint" target="_blank" rel="external">Technical Overview Of Pinpoint</a></li>
<li><a href="http://www.10tiao.com/html/516/201710/2651103505/1.html" target="_blank" rel="external">阿里微服务之殇及分布式链路追踪技术原理</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/12/05/apm2/" data-id="cjatqzxm80000dt6qydbu570y" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-config-server1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/20/config-server1/">微服务之分布式配置中心Cloud Config</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/20/config-server1/">
            <time datetime="2017-11-19T16:00:00.000Z" itemprop="datePublished">2017-11-20</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/微服务/">微服务</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Spring-Cloud/">Spring Cloud</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-分布式配置中心"><a href="#1-分布式配置中心" class="headerlink" title="1. 分布式配置中心"></a>1. 分布式配置中心</h2><p>分布式系统中，服务数量剧增，其配置文件需要实现统一管理并且能够实时更新，分布式配置中心组件必然是需要的。Spring Cloud提供了配置中心组件Spring Cloud Config ，它支持配置服务放在远程Git仓库和本地文件中。默认采用git来存储配置信息，笔者示例也是采用默认的git repository，这样通过git客户端工具来方便的管理和访问配置内容。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B7%A5%E4%BD%9C%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg" alt="配置服务器工作示意图" title="配置服务器工作示意图"></p>
<p>在Spring Cloud Config 组件中，有两个角色，一是Config Server配置服务器，为其他服务提供配置文件信息；另一个是Config Client即其他服务，启动时从Config Server拉取配置。<br>下面分别介绍下Config Server和Config Client的搭建实现方法。</p>
<h2 id="2-配置服务器Config-Server"><a href="#2-配置服务器Config-Server" class="headerlink" title="2. 配置服务器Config Server"></a>2. 配置服务器Config Server</h2><h3 id="2-1-pom中的jars"><a href="#2-1-pom中的jars" class="headerlink" title="2.1 pom中的jars"></a>2.1 pom中的jars</h3><p>只需要添加如下两个jar包的引用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsr311-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.ws.rs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>因为Spring Cloud Config服务器为客户端提供配置是要通过服务发现，所以这边引入consul的starter，配置服务器和客户端都注册到consul集群中。</p>
<h3 id="2-2-入口类"><a href="#2-2-入口类" class="headerlink" title="2.2 入口类"></a>2.2 入口类</h3><p>简单，因为Spring Cloud 提供了很多开箱即用的功能，通过spring-cloud-config-server的注解激活配置服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableDiscoveryClient</span></div><div class="line"><span class="meta">@EnableConfigServer</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerApplication</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(ConfigServerApplication.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@EnableConfigServer</code>注解很重要，将该服务标注为配置服务器；<code>@EnableDiscoveryClient</code>注册服务，供其他服务发现调用。</p>
<h3 id="2-3-bootstrap-yml"><a href="#2-3-bootstrap-yml" class="headerlink" title="2.3 bootstrap.yml"></a>2.3 bootstrap.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8888</span></div><div class="line"></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">config-server</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">      consul:</span></div><div class="line"><span class="attr">        discovery:</span></div><div class="line"><span class="attr">          preferIpAddress:</span> <span class="literal">true</span></div><div class="line"><span class="attr">          enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">          register:</span> <span class="literal">true</span></div><div class="line"><span class="attr">          service-name:</span> <span class="string">config-service</span></div><div class="line">          <span class="string">//...</span></div><div class="line"><span class="attr">        host:</span> <span class="string">localhost</span></div><div class="line"><span class="attr">        port:</span> <span class="number">8500</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    config:</span></div><div class="line"><span class="attr">      server:</span></div><div class="line"><span class="attr">        git:</span></div><div class="line"><span class="attr">          uri:</span> <span class="attr">https://gitee.com/keets/Config-Repo.git</span></div><div class="line"><span class="attr">          searchPaths:</span> <span class="string">$&#123;APP_LOCATE:dev&#125;</span></div><div class="line"><span class="attr">          username:</span> <span class="string">user</span></div><div class="line"><span class="attr">          password:</span> <span class="string">pwd</span></div></pre></td></tr></table></figure>
<p>配置第一段指定了服务的端口；第二段是服务发现相关的配置；第三段是配置服务器的信息，这里将配置文件存储在码云上，默认的搜索文件路径为dev文件夹，可以通过环境变量指定，再下面是用户名和密码，公开的项目不需要设置用户名和密码。</p>
<p>至此配置服务器已经搭建完成，是不是很简单？</p>
<h2 id="3-配置的git仓库"><a href="#3-配置的git仓库" class="headerlink" title="3. 配置的git仓库"></a>3. 配置的git仓库</h2><p>配置服务器配置的仓库是<code>https://gitee.com/keets/Config-Repo.git</code>。笔者在这个仓库中建了两个文件夹：dev和prod。并且在dev文件夹中新建了文件configclient-dev.yml。为什么这样命名，能随便命名吗？答案是不可以，下面我们看下config文件的命名规则。</p>
<p>URL与配置文件的映射关系如下：</p>
<ul>
<li>/{application}/{profile}[/{label}]</li>
<li>/{application}-{profile}.yml</li>
<li>/{label}/{application}-{profile}.yml</li>
<li>/{application}-{profile}.properties</li>
<li>/{label}/{application}-{profile}.properties<br>上面的url会映射{application}-{profile}.yml对应的配置文件，{label}对应git上不同的分支，默认为master<br>比如Config Client，{application}对应<code>spring.application：configclient</code>，exp对应{profile}，{label}不指定则默认为master。</li>
</ul>
<p>新建的configclient-dev.yml如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">dev</span></div><div class="line"></div><div class="line"><span class="attr">cloud:</span></div><div class="line"><span class="attr">  version:</span> <span class="string">Dalston.SR4</span></div></pre></td></tr></table></figure>
<h2 id="4-配置客户端Config-Client"><a href="#4-配置客户端Config-Client" class="headerlink" title="4. 配置客户端Config Client"></a>4. 配置客户端Config Client</h2><h3 id="4-1-pom中的jars"><a href="#4-1-pom中的jars" class="headerlink" title="4.1 pom中的jars"></a>4.1 pom中的jars</h3><p>只需要添加如下两个jar包的引用。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsr311-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.ws.rs<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>新增spring-boot-starter-actuator监控模块，为了配置信息是动态刷新，其中包含了/refresh刷新API。其他和配置服务器中添加的相同，没啥可说。</p>
<h3 id="4-2-入口类"><a href="#4-2-入口类" class="headerlink" title="4.2 入口类"></a>4.2 入口类</h3><p>简单，因为Spring Cloud 提供了很多开箱即用的功能，通过spring-cloud-config-server的注解激活配置服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableDiscoveryClient</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServerApplication</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(ConfigServerApplication.class, args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>配置客户端不需要<code>@EnableConfigServer</code>注解。</p>
<h3 id="4-3-bootstrap-yml"><a href="#4-3-bootstrap-yml" class="headerlink" title="4.3 bootstrap.yml"></a>4.3 bootstrap.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9901</span></div><div class="line"><span class="attr">cloud:</span></div><div class="line"><span class="attr">  version:</span> <span class="string">Brixton</span> <span class="string">SR7</span></div><div class="line"></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    consul:</span></div><div class="line"><span class="attr">      discovery:</span></div><div class="line"><span class="attr">        preferIpAddress:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        register:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        service-name:</span> <span class="string">config-client</span></div><div class="line">      <span class="string">//...</span></div><div class="line"><span class="attr">      host:</span> <span class="string">localhost</span></div><div class="line"><span class="attr">      port:</span> <span class="number">8500</span></div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">dev</span></div><div class="line"><span class="attr">  application:</span></div><div class="line">  	<span class="comment">#app名称</span></div><div class="line"><span class="attr">    name:</span> <span class="string">configclient</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    config:</span></div><div class="line">      <span class="comment">#指定profile</span></div><div class="line"><span class="attr">      profile:</span> <span class="string">dev</span></div><div class="line"><span class="attr">      label:</span> <span class="string">master</span></div><div class="line"><span class="attr">      discovery:</span></div><div class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></div><div class="line">        <span class="comment">#server名</span></div><div class="line"><span class="attr">        service-id:</span> <span class="string">config-service</span></div><div class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">      fail-fast:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">default</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">configclient</span></div></pre></td></tr></table></figure>
<p>从上面配置可以看出我们所激活的profile是dev，配置的配置服务名为<code>config-service</code>，指定从master分支拉取配置。所以configclient启动时会去配置服务器中拉取对应的configclient-dev的配置文件信息。</p>
<h3 id="4-4-TestResource"><a href="#4-4-TestResource" class="headerlink" title="4.4 TestResource"></a>4.4 TestResource</h3><p>笔者新建了一个TestResource，对应的API端点为/api/test。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;cloud.version&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String version;</div><div class="line"></div><div class="line"><span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">from</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> version;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>cloud.version</code>可以在上面的配置文件看到默认指定的是Brixton SR7，而笔者在配置中心设置的值为Dalston.SR4。</p>
<h2 id="5-测试结果"><a href="#5-测试结果" class="headerlink" title="5. 测试结果"></a>5. 测试结果</h2><h3 id="5-1-获取配置"><a href="#5-1-获取配置" class="headerlink" title="5.1 获取配置"></a>5.1 获取配置</h3><p>首先看一下配置客户端启动时的日志信息，是不是真的按照我们配置的，从配置服务器拉取configclient-dev信息。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/configstartupload.jpg" alt="ccstart" title="Config Client启动"></p>
<p>从日志看来，是符合的上面的配置猜想的。我们再从配置客户端提供的API接口进一步验证。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/realconfig.jpg" alt="pj" title="配置结果"></p>
<p>可以看到确实是Dalston.SR4，配置服务能够正常运行。</p>
<h3 id="5-2-动态刷新配置"><a href="#5-2-动态刷新配置" class="headerlink" title="5.2 动态刷新配置"></a>5.2 动态刷新配置</h3><p>Spring Cloud Config还可以实现动态更新配置的功能。下面我们修改下Config Repo中的cloud.version配置为Camden SR7，并通过刷新config client的/refresh端点来应用配置。<br>从下图可以看到结果是预期所想。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/refrestresult.jpg" alt="rr" title="刷新配置"></p>
<p>这边配置的刷新是通过手工完成了，还可以利用githook进行触发。当本地提交代码到git后，调用了下图设置的url。有两个端点可以使用：</p>
<ul>
<li>refresh：以post方式执行/refresh 会刷新env中的配置</li>
<li>restart：如果配置信息已经注入到bean中，由于bean是单例的，不会去加载修改后的配置<br>需要通过post方式去执行/restart, 还需要配置endpoints.restart.enabled: true。</li>
</ul>
<p>第二种情况比较耗时，<code>@RefreshScope</code>是spring cloud提供的注解，在执行refresh时会刷新bean中变量值。</p>
<blockquote>
<p>Convenience annotation to put a @Bean definition in RefreshScope.<br> Beans annotated this way can be refreshed at runtime and any components that are using them will get a new instance on the next method call, fully initialized and injected with all dependencies.</p>
</blockquote>
<p>上面说了RefreshScope是一个方便的bean注解，加上这个注解可以在运行态刷新bean。其他使用该bean的components下次调用时会获取一个已经被初始化好和注入的新实例对象。</p>
<p>githook设置页面如下。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/webhooks.jpg" alt="githook" title="githook设置"></p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>本文主要讲了配置服务器和配置客户端的搭建过程，最后通过配置客户端的日志和端点信息验证是否能成功使用配置服务中心。总体来说，非常简单。文中的部分配置没有写完整，读者需要可以看文末的git项目。   </p>
<p>不过关于配置中心，本文的讲解并不完整，下一篇文章将会讲解配置服务器与消息总线的结合使用，实现对配置客户端的自动更新及灰度发布等功能。</p>
<p><strong>本文源码<br>github: <a href="https://github.com/keets2012/Spring-Boot-Samples/" target="_blank" rel="external">https://github.com/keets2012/Spring-Boot-Samples/</a><br>gitee: <a href="https://gitee.com/keets/spring-boot-samples/" target="_blank" rel="external">https://gitee.com/keets/spring-boot-samples/</a></strong></p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://cloud.spring.io/spring-cloud-static/Dalston.SR4/single/spring-cloud.html" target="_blank" rel="external">Spring Cloud Config</a></li>
<li><a href="http://m.blog.csdn.net/forezp/article/details/70037291" target="_blank" rel="external">分布式配置中心</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/11/20/config-server1/" data-id="cja887zj30000a76qsck5ek3r" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-first-timeout" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/18/first-timeout/">Spring Cloud 服务第一次请求超时的优化</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/18/first-timeout/">
            <time datetime="2017-11-17T16:00:00.000Z" itemprop="datePublished">2017-11-18</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/微服务/">微服务</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Ribbon/">Ribbon</a>, <a class="tag-link" href="/tags/Spring-Cloud/">Spring Cloud</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-问题背景"><a href="#1-问题背景" class="headerlink" title="1. 问题背景"></a>1. 问题背景</h2><p>使用Spring Cloud组件构建的服务集群，在第一次请求时经常会出现timeout的情况，然而第二次就正常了。Spring Cloud版本为Dalston.SR4。</p>
<p>启动涉及到的相关服务：</p>
<ul>
<li>gateway(zuul网关)</li>
<li>auth-Service（鉴权服务）</li>
<li>user-Service（用户服务）</li>
</ul>
<p>测试的端点接口为：http:/login/oauth/token。服务之间的调用顺序为：gateway-&gt;auth-Service-&gt;user-Service。网关收到客户端的请求，转发请求到鉴权服务，鉴权服务对用户身份的核验是通过调用用户服，用户服务给鉴权服务返回身份校验的结果，鉴权服务将身份授权信息返回给gateway，gateway将最终的结果response返回给客户端。<br>三个服务启动后，通过zipkin监控调用链路信息，可以看到第一次和第二次调用情况如下图所示：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/gw-not-eager.jpg" alt="not-eager-1st" title="首次调用端点"></p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/gw-second.jpg" alt="second" title="第二次调用信息"></p>
<p>通过上面两次的链路监控信息截图，可以看到第一次的耗时是第二次的10多倍。遇到某些情况，很可能会出现第一次请求的超时。去官网看了下，主要原因是zuul网关和各个调用服务之间的Ribbon进行客户端负载均衡的Client懒加载，导致第一次的请求调用包括了创建Ribbon Client的时间。通过启动日志信息就可以发现：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/lazy-load.jpg" alt="lazy-load" title="Ribbon 客户端懒加载"></p>
<p>下面分两部分解决这个问题，一是服务之间调用Ribbon的饥饿加载，对应上面的测试为auth-Service调用user-Service；二是zuul网关的饥饿加载。</p>
<h2 id="2-ribbon的饥饿加载"><a href="#2-ribbon的饥饿加载" class="headerlink" title="2. ribbon的饥饿加载"></a>2. ribbon的饥饿加载</h2><p>经过调查发现，造成第一次auth-Service调用user-Service耗时长的原因主要是，Ribbon进行客户端负载均衡的服务实例并不是在服务启动的时候就初始化好的，而是在调用的时候才会去创建相应的服务实例。所以第一次调用user-Service耗时不仅仅包含发送HTTP请求的时间，还包含了创建Ribbon Client的时间，这样一来如果创建时间速度较慢，同时设置的请求超时又比较短的话，很容易就会出现耗时很长甚至超时的情况。<br>在官网可以看到如下的配置说明：</p>
<blockquote>
<p>Each Ribbon named client has a corresponding child Application Context that Spring Cloud maintains, this application context is lazily loaded up on the first request to the named client. This lazy loading behavior can be changed to instead eagerly load up these child Application contexts at startup by specifying the names of the Ribbon clients.</p>
</blockquote>
<p>意为Spring Cloud为每个Ribbon客户端维护了一个相对的子应用环境的上下文，应用的上下文在第一次请求到指定客户端的时候懒加载。不过可以通过如下配置进行修改：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">ribbon:</span></div><div class="line"><span class="attr">  eager-load:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    clients:</span> <span class="string">client1,</span> <span class="string">client2,</span> <span class="string">client3</span></div></pre></td></tr></table></figure>
<p>按照如上的配置之后，发现鉴权服务启动时就将user服务的Ribbon客户端进行了加载。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/eager-load.jpg" alt="el" title="user服务eager load"></p>
<h2 id="3-zuul网关的饥饿加载"><a href="#3-zuul网关的饥饿加载" class="headerlink" title="3. zuul网关的饥饿加载"></a>3. zuul网关的饥饿加载</h2><p>上面小节解决了auth-Service调用user-Service的Ribbon客户端启动时饥饿加载。网关作为对外请求的入口，zuul内部使用Ribbon调用其他服务，Spring Cloud默认在第一次调用时懒加载Ribbon客户端。zuul同样需要维护一个相对的子应用环境的上下文，所以也需要启动时饥饿加载。</p>
<blockquote>
<p>Zuul internally uses Ribbon for calling the remote url’s and Ribbon clients are by default lazily loaded up by Spring Cloud on first call. This behavior can be changed for Zuul using the following configuration and will result in the child Ribbon related Application contexts being eagerly loaded up at application startup time.</p>
</blockquote>
<p>具体配置如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">zuul:</span></div><div class="line"><span class="attr">  ribbon:</span></div><div class="line"><span class="attr">    eager-load:</span></div><div class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>至此，优化完成，再次重启服务进行第一次请求，发现情况已经好多了，大家可以自己动手尝试改进一下。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文主要介绍了Spring Cloud的服务第一次请求超时的优化方法。首先介绍了问题的背景，并排查了问题造成的原因，主要是Ribbon客户端的懒加载；然后分别针对zuul网关和服务之间调用的Ribbon客户端进行配置，使其启动时便加载Ribbon客户端的相关上下文信息。最后想说的是，http调用毕竟还是性能远低于RPC。。🙂</p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://cloud.spring.io/spring-cloud-static/Dalston.SR4/single/spring-cloud.html" target="_blank" rel="external">spring-cloud Dalston.SR4</a></li>
<li><a href="http://blog.didispace.com/spring-cloud-tips-ribbon-eager/" target="_blank" rel="external">Spring Cloud实战小贴士：Ribbon的饥饿加载(eager-load)模式</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/11/18/first-timeout/" data-id="cja6jpurl0000ud6qlt9iakcb" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-profile" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/16/profile/">微服务之配置服务器切换profile</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/16/profile/">
            <time datetime="2017-11-15T16:00:00.000Z" itemprop="datePublished">2017-11-16</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Ops/">Ops</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Docker/">Docker</a>, <a class="tag-link" href="/tags/Maven/">Maven</a>, <a class="tag-link" href="/tags/Ops/">Ops</a>, <a class="tag-link" href="/tags/Spring-Boot/">Spring Boot</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>最近遇到Spring-boot的多个profile切换问题，需求是这样的：微服务中引入了Spring Cloud Config，服务启动的时候，从Config Server中读取该实例对应的配置信息。本地开发环境可能使用的profile是default，到了集成测试环境就需要切换到jenkins，到了预发布环境又变成了prod。多个profile需要之间可以切换。</p>
<p>这边设置的时候还走了点弯路，先是探索了一遍pom的profile，后来才到Spring-boot的配置文件。</p>
<p>这两部分实现的功能不太一样，本文将会具体讲下这两部分。</p>
<h2 id="1-profile之Maven"><a href="#1-profile之Maven" class="headerlink" title="1. profile之Maven"></a>1. profile之Maven</h2><p> maven切换profile的命令很简单，加上<code>-P</code>参数指定你的profile，如指定prod：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean package -P prod</div></pre></td></tr></table></figure>
<p> maven使用名字为prod的profile来打包，即所有的配置文件都使用生产环境。<br> 下面看下pom中的profiles：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">activation</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">profileActive</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">profileActive</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="tag">&lt;<span class="name">profile</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">profileActive</span>&gt;</span>prod<span class="tag">&lt;/<span class="name">profileActive</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></div></pre></td></tr></table></figure>
<p> 对于resources的配置如下：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></div><div class="line">              <span class="comment">&lt;!-- 过滤掉所有配置文件--&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>application-dev.yml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>application-prod.yml<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">              <span class="comment">&lt;!--根据profile中的变量profileActive指定对应的配置文件--&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">includes</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">include</span>&gt;</span>application-$&#123;profileActive&#125;.yml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></div><div class="line">          <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></div></pre></td></tr></table></figure>
<p> 上面的两段pom配置相结合，当指定profile为prod时，环境变量profileActive的属性值变为prod。指定打包时，包含application-prod.yml。</p>
<p> 所以当你有多套配置文件，可以动态根据mvn命令的参数-P动态指定你所需要加载的配置文件。</p>
<h2 id="2-profile之Spring-boot"><a href="#2-profile之Spring-boot" class="headerlink" title="2. profile之Spring boot"></a>2. profile之Spring boot</h2><p>Profile是Spring boot用来针对不同环境对不同配置提供支持的,全局Profile配置使用。<br>application-{profile}.yml 如:application-yml。</p>
<p>spring通过配置spring.profiles.active指定激活某个具体的profile。除了spring.profiles.active来激活一个或者多个profile之外，还可以用spring.profiles.include来叠加profile。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">spring.profiles.include:</span> <span class="string">prod,dev</span></div></pre></td></tr></table></figure>
<p>下面看一下我们的application.yml中包含的配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">dev</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="comment">#开发环境配置</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">dev</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8080</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="comment">#测试环境配置</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">test</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8081</span></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="comment">#生产环境配置</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">prod</span></div><div class="line"></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8082</span></div></pre></td></tr></table></figure>
<p>application.yml文件分为四部分，使用一组(—)来作为分隔符。第一部分，通用配置部分，表示三个环境都通用的属性，默认激活了dev的profile；后面三部分分别表示不同的环境，指定了不同的port。</p>
<p>部署到服务器的话，正常会打成jar包，加上参数<br><code>--spring.profiles.active=test</code>指定加载哪个环境的配置。</p>
<p>在IDE中也可以直接配置激活的profile。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/profile%E5%85%A5%E5%8F%A3.jpg" alt="entry" title="idea配置"></p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/configprofiles.jpg" alt="profile" title="idea配置profile"></p>
<h2 id="3-config-server的配置"><a href="#3-config-server的配置" class="headerlink" title="3. config server的配置"></a>3. config server的配置</h2><p>这节讲下与Spring cloud config的结合使用。既然使用了config server，动态配置这块基本就由配置服务器完成了。配置服务器中对该服务指定多个profile。config Server中的配置优先于本地配置，当服务启动时，根据激活的profile，去配置服务器拉取其对应的配置。</p>
<p>既然知道了上面的主要流程，就可以明白我们的需求其实是要在服务启动时指定激活的profile。所以上面一节关于Spring boot的profile动态配置，我们的问题就能解决了。但上面讲到的是jar包启动时指定<code>--spring.profiles.active</code>，实际都是微服务的容器化部署，服务通过容器直接启动jar包，这样就需要容器启动的时候能够动态指定active profile，所以上面的配置改一下，如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  profiles:</span></div><div class="line"><span class="attr">    active:</span> <span class="string">$&#123;ACTIVE_PROFILE:dev&#125;</span></div></pre></td></tr></table></figure>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/configstartup.jpg" alt="startup" title="容器启动截图"></p>
<p>从容器的启动截图来看，指定了<code>docker run -d -e  ACTIVE_PROFILE=exp ...</code>后，active profile 变味了exp，并且从config server中拉取对应的是gatewayserver的exp配置。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文主要写了Spring-boot配置服务器切换profile。首先描述了需求背景，然后是对maven pom中profile进行了探索与讲解，其次是讲解了Spring-boot中的profile切换，最后结合config server实现容器部署微服务的profile。笔者最开始一直认为通过pom的profile切换就可以设置服务启动的profile，经过一番探索，发现与配置服务器结合好像并不需要pom的profile这么繁琐，结合配置服务器可以更方便的使用Spring boot的profile。</p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://www.jb51.net/article/115673.htm" target="_blank" rel="external">详解Spring Boot Profiles 配置和使用</a></li>
<li><a href="http://blog.csdn.net/lihe2008125/article/details/50443491" target="_blank" rel="external">[Spring Boot 系列] 集成maven和Spring boot的profile功能</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/11/16/profile/" data-id="cja25cxik000zff6qd1dhd0zx" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-gateway" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/13/gateway/">微服务网关netflix-zuul</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/13/gateway/">
            <time datetime="2017-11-12T16:00:00.000Z" itemprop="datePublished">2017-11-13</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/微服务/">微服务</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/gateway/">gateway</a>, <a class="tag-link" href="/tags/zuul/">zuul</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>引言：前面一个系列文章介绍了<a href="http://blueskykong.com/2017/10/19/security1/">认证鉴权与API权限控制在微服务架构中的设计与实现</a> ，好多同学询问有没有完整的demo项目，笔者回答肯定有的。由于之前系列文章侧重讲解了权限前置，所以近期补上完整的后置项目，但是这最好有一个完整的微服务调用。本文主要讲下API网关的设计与实现。netflix-zuul是由netflix开源的API网关，在微服务架构下，网关作为对外的门户，实现动态路由、监控、授权、安全、调度等功能。</p>
<h2 id="1-网关介绍"><a href="#1-网关介绍" class="headerlink" title="1. 网关介绍"></a>1. 网关介绍</h2><p>当使用单体应用程序架构时，客户端（web和移动端）通过向后端应用程序发起一次REST调用来获取数据。负载均衡器将请求路由给N个相同的应用程序实例中的一个。然后应用程序会查询各种数据库表，并将响应返回给客户端。微服务架构下，单体应用被切割成多个微服务，如果将所有的微服务直接对外暴露，势必会出现安全方面的各种问题。<br>客户端可以直接向每个微服务发送请求，其问题主要如下：</p>
<ul>
<li>客户端需求和每个微服务暴露的细粒度API不匹配。</li>
<li>部分服务使用的协议不是Web友好协议。可能使用Thrift二进制RPC，也可能使用AMQP消息传递协议。</li>
<li>微服务难以重构。如果合并两个服务，或者将一个服务拆分成两个或更多服务，这类重构就非常困难了。</li>
</ul>
<p>如上问题，解决的方法是使用API网关。API网关是一个服务，是系统的唯一入口。从面向对象设计的角度看，它与外观模式类似。API网关封装了系统内部架构，为每个客户端提供一个定制的API。它可能还具有其它职责，如身份验证、监控、负载均衡、限流、降级与应用检测。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/zuul-use1-1000x550.jpg" alt="zu" title="zuul"></p>
<h2 id="2-zuul网关"><a href="#2-zuul网关" class="headerlink" title="2. zuul网关"></a>2. zuul网关</h2><p>API Gateway，常见的选型有基于 Openresty 的 Kong和基于 JVM 的 Zuul，其他还有基于Go的Tyk。技术选型上，之前稍微调研了Kong，性能还可以。考虑到快速应用和二次开发，netflix-zuul也在Spring Cloud的全家桶中，和其他组件配合使用还挺方便，后期可能还会对网关的功能进行扩增，最后选了Zuul。   </p>
<h3 id="2-1-pom配置"><a href="#2-1-pom配置" class="headerlink" title="2.1 pom配置"></a>2.1 pom配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在Spring Cloud的项目中，引入zuul的starter，consul-discovery是为了服务的动态路由，这边没有用eureka，是通过注册到consul上的服务实例进行路由。</p>
<h3 id="2-2-入口类"><a href="#2-2-入口类" class="headerlink" title="2.2 入口类"></a>2.2 入口类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableZuulProxy</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayApplication</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(GatewayApplication.class, args);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Spring boot的入口类需要加上<code>@EnableZuulProxy</code>，下面看下这个注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@EnableCircuitBreaker</span></div><div class="line"><span class="meta">@EnableDiscoveryClient</span></div><div class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Import</span>(&#123;ZuulProxyConfiguration.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableZuulProxy &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到该注解还包含了<code>@EnableCircuitBreaker 和 @EnableDiscoveryClient</code>。<code>@EnableDiscoveryClient</code>注解在服务启动的时候，可以触发服务注册的过程，向配置文件中指定的服务注册中心；<code>@EnableCircuitBreaker</code>则开启了Hystrix的断路器。</p>
<h3 id="2-3-bootstrap-yml"><a href="#2-3-bootstrap-yml" class="headerlink" title="2.3 bootstrap.yml"></a>2.3 bootstrap.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">10101</span></div><div class="line">    </div><div class="line"><span class="comment">#spring config</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">gateway-server</span></div><div class="line"><span class="attr">  cloud:</span></div><div class="line"><span class="attr">    consul:</span></div><div class="line"><span class="attr">      discovery:</span></div><div class="line"><span class="attr">        preferIpAddress:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        register:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        service-name:</span> <span class="string">api-getway</span></div><div class="line"><span class="attr">        ip-address:</span> <span class="string">localhost</span></div><div class="line"><span class="attr">        port:</span> <span class="string">$&#123;server.port&#125;</span></div><div class="line"><span class="attr">        lifecycle:</span></div><div class="line"><span class="attr">          enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">        scheme:</span> <span class="string">http</span></div><div class="line"><span class="attr">        prefer-agent-address:</span> <span class="literal">false</span></div><div class="line"><span class="attr">      host:</span> <span class="string">localhost</span></div><div class="line"><span class="attr">      port:</span> <span class="number">8500</span></div><div class="line"></div><div class="line"><span class="comment">#zuul config and routes</span></div><div class="line"><span class="attr">zuul:</span></div><div class="line"><span class="attr">  host:</span></div><div class="line"><span class="attr">    maxTotalConnections:</span> <span class="number">500</span></div><div class="line"><span class="attr">    maxPerRouteConnections:</span> <span class="number">50</span></div><div class="line"><span class="attr">  routes:</span></div><div class="line"><span class="attr">    user:</span></div><div class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></div><div class="line"><span class="attr">      ignoredPatterns:</span> <span class="string">/consul</span></div><div class="line"><span class="attr">      serviceId:</span> <span class="string">user</span></div><div class="line"><span class="attr">      sensitiveHeaders:</span> <span class="string">Cookie,Set-Cookie</span></div></pre></td></tr></table></figure>
<p>配置主要包括三块，服务端口，Spring Cloud服务注册，最后是zuul的路由配置。</p>
<p>默认情况下，Zuul在请求路由时，会过滤HTTP请求头信息中的一些敏感信息，默认的敏感头信息通过zuul.sensitiveHeaders定义，包括Cookie、Set-Cookie、Authorization。</p>
<p>zuul.host.maxTotalConnections配置了每个服务的http客户端连接池最大连接，默认值是200。maxPerRouteConnections每个route可用的最大连接数，默认值是20。</p>
<h3 id="2-3-支持https"><a href="#2-3-支持https" class="headerlink" title="2.3 支持https"></a>2.3 支持https</h3><p>上线的项目一般域名都会改为https协议，顺手写下https的配置。</p>
<ul>
<li><p>首先申请https的数字证书<br>在阿里云生成的针对tomcat服务器CA证书在申请成功后， 下载相应的tomcat证书文件。 包含如下：<br>1): <em>.pfx为keystore文件，服务器用的就是这个文件<br>2): pfx-password.txt里包含有keystore所用到的密码<br>3): </em>.key里面包含的是私钥，暂时没用到此文件<br>4): *.pem里面包含的是公钥，主要给客户端   </p>
</li>
<li><p>bootstrap.yml增加如下配置</p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># https</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">5443</span></div><div class="line"><span class="attr">  http:</span> <span class="number">10101</span></div><div class="line"><span class="attr">  ssl:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></div><div class="line"><span class="attr">    key-store:</span> <span class="attr">classpath:214329585620980.pfx</span></div><div class="line"><span class="attr">    key-store-password:</span> <span class="string">password</span></div><div class="line"><span class="attr">    keyStoreType:</span> <span class="string">PKCS12</span></div></pre></td></tr></table></figure>
<ul>
<li>同时支持http和https</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EmbeddedServletContainerFactory <span class="title">servletContainer</span><span class="params">()</span> </span>&#123;</div><div class="line">        TomcatEmbeddedServletContainerFactory tomcat = <span class="keyword">new</span> TomcatEmbeddedServletContainerFactory() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessContext</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">                SecurityConstraint constraint = <span class="keyword">new</span> SecurityConstraint();</div><div class="line">                constraint.setUserConstraint(<span class="string">"CONFIDENTIAL"</span>);</div><div class="line">                SecurityCollection collection = <span class="keyword">new</span> SecurityCollection();</div><div class="line">                collection.addPattern(<span class="string">""</span>);</div><div class="line">                constraint.addCollection(collection);</div><div class="line">                context.addConstraint(constraint);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        tomcat.addAdditionalTomcatConnectors(httpConnector());</div><div class="line">        <span class="keyword">return</span> tomcat;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Connector <span class="title">httpConnector</span><span class="params">()</span> </span>&#123;</div><div class="line">        Connector connector = <span class="keyword">new</span> Connector(<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>);</div><div class="line">        connector.setScheme(<span class="string">"http"</span>);</div><div class="line">        <span class="comment">//Connector监听的http的端口号</span></div><div class="line">        connector.setPort(httpPort);</div><div class="line">        connector.setSecure(<span class="keyword">false</span>);</div><div class="line">        <span class="comment">//监听到http的端口号后转向到的https的端口号</span></div><div class="line">        connector.setRedirectPort(securePort);</div><div class="line">        <span class="keyword">return</span> connector;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><code>servletContainer()</code>把<code>EmbeddedServletContainerFactory</code>注入到web容器中，用<code>postProcessContext</code>拦截所有的/*请求，并把其关联到下面的httpConnector中。最后，在httpConnector()中，把http设为10101端口，并把http的请求跳转到5443的https端口，这边是读取的配置文件。</p>
<p>至此，至此同时支持https和http的API网关完成，将匹配到/user的请求，路由到user服务，是不是很简单？下面一起深入了解下Zuul。</p>
<h2 id="3-一些internals"><a href="#3-一些internals" class="headerlink" title="3. 一些internals"></a>3. 一些internals</h2><p>internals可以理解为内幕。</p>
<h3 id="3-1-过滤器"><a href="#3-1-过滤器" class="headerlink" title="3.1 过滤器"></a>3.1 过滤器</h3><p>filter是Zuul的核心，用来实现对外服务的控制。filter的生命周期有4个，分别是pre、route、post、error，整个生命周期可以用下图来表示。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/filterzuul.png" alt="filter" title="zuul过滤器"></p>
<p>一个请求会先按顺序通过所有的前置过滤器，之后在路由过滤器中转发给后端应用，得到响应后又会通过所有的后置过滤器，最后响应给客户端。error可以在所有阶段捕获异常后执行。</p>
<p>一般来说，如果需要在请求到达后端应用前就进行处理的话，会选择前置过滤器，例如鉴权、请求转发、增加请求参数等行为。后面衔接auth系统部分给出具体实现，也是基于pre过滤。</p>
<p>在请求完成后需要处理的操作放在后置过滤器中完成，例如统计返回值和调用时间、记录日志、增加跨域头等行为。路由过滤器一般只需要选择 Zuul 中内置的即可。</p>
<p>错误过滤器一般只需要一个，这样可以在 Gateway 遇到错误逻辑时直接抛出异常中断流程，并直接统一处理返回结果。</p>
<h3 id="3-2-配置管理"><a href="#3-2-配置管理" class="headerlink" title="3.2 配置管理"></a>3.2 配置管理</h3><p>后端服务 API可能根据情况，有些不需要登录校验了，这个配置信息怎么动态加载到网关配置当中？笔者认为有两种方式：一是配置信息存到库中，定期实现对网关服务的配置刷新；另一种就是基于配置中心服务，当配置提交到配置中心时，触发网关服务的热更新。</p>
<p>后端应用无关的配置，有些是自动化的，例如恶意请求拦截，Gateway 会将所有请求的信息通过消息队列发送给一些实时数据分析的应用，这些应用会对请求分析，发现恶意请求的特征，并通过 Gateway 提供的接口将这些特征上报给 Gateway，Gateway 就可以实时的对这些恶意请求进行拦截。</p>
<h3 id="3-3-隔离机制"><a href="#3-3-隔离机制" class="headerlink" title="3.3 隔离机制"></a>3.3 隔离机制</h3><p>在微服务的模式下，应用之间的联系变得没那么强烈，理想中任何一个应用超过负载或是挂掉了，都不应该去影响到其他应用。但是在 Gateway 这个层面，有没有可能出现一个应用负载过重，导致将整个 Gateway 都压垮了，已致所有应用的流量入口都被切断？</p>
<p>这当然是有可能的，想象一个每秒会接受很多请求的应用，在正常情况下这些请求可能在 10 毫秒之内就能正常响应，但是如果有一天它出了问题，所有请求都会 Block 到 30 秒超时才会断开（例如频繁 Full GC 无法有效释放内存）。那么在这个时候，Gateway 中也会有大量的线程在等待请求的响应，最终会吃光所有线程，导致其他正常应用的请求也受到影响。</p>
<p>在 Zuul 中，每一个后端应用都称为一个 Route，为了避免一个 Route 抢占了太多资源影响到其他 Route 的情况出现，Zuul 使用 Hystrix 对每一个 Route 都做了隔离和限流。</p>
<p>Hystrix 的隔离策略有两种，基于线程或是基于信号量。Zuul 默认的是基于线程的隔离机制，之前章节的配置可以回顾下，这意味着每一个 Route 的请求都会在一个固定大小且独立的线程池中执行，这样即使其中一个 Route 出现了问题，也只会是某一个线程池发生了阻塞，其他 Route 不会受到影响。</p>
<p>一般使用 Hystrix 时，只有调用量巨大会受到线程开销影响时才会使用信号量进行隔离策略，对于 Zuul 这种网络请求的用途使用线程隔离更加稳妥。</p>
<h3 id="3-4-重试机制"><a href="#3-4-重试机制" class="headerlink" title="3.4 重试机制"></a>3.4 重试机制</h3><p>一般来说，后端应用的健康状态是不稳定的，应用列表随时会有修改，所以 Gateway 必须有足够好的容错机制，能够减少后端应用变更时造成的影响。</p>
<p>简单介绍下 Ribbon 支持哪些容错配置。重试的场景分为三种：</p>
<ul>
<li>okToRetryOnConnectErrors：只重试网络错误</li>
<li>okToRetryOnAllErrors：重试所有错误</li>
<li>OkToRetryOnAllOperations：重试所有操作</li>
</ul>
<p>重试的次数有两种：</p>
<ul>
<li>MaxAutoRetries：每个节点的最大重试次数</li>
<li>MaxAutoRetriesNextServer：更换节点重试的最大次数</li>
</ul>
<p>一般来说我们希望只在网络连接失败时进行重试、或是对 5XX 的 GET 请求进行重试（不推荐对 POST 请求进行重试，无法保证幂等性会造成数据不一致）。单台的重试次数可以尽量小一些，重试的节点数尽量多一些，整体效果会更好。</p>
<p>如果有更加复杂的重试场景，例如需要对特定的某些 API、特定的返回值进行重试，那么也可以通过实现 RequestSpecificRetryHandler 定制逻辑（不建议直接使用 RetryHandler，因为这个子类可以使用很多已有的功能）。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>本文首先介绍了API网关的相关知识；其次介绍了zuul网关的配置实现，同时支持https；最后介绍了zuul网关的一些内幕原理，这边大部分参考了网上的文章。网关作为内网与外网之间的门户，所有访问内网的请求都会经过网关，网关处进行反向代理。在整个Spring Cloud微服务框架里，Zuul扮演着”智能网关“的角色。</p>
<p><strong>github: <a href="https://github.com/keets2012/Spring-Boot-Samples/tree/master/api-gateway" target="_blank" rel="external">https://github.com/keets2012/Spring-Boot-Samples/tree/master/api-gateway</a><br>gitee: <a href="https://gitee.com/keets/spring-boot-samples/tree/master/api-gateway" target="_blank" rel="external">https://gitee.com/keets/spring-boot-samples/tree/master/api-gateway</a></strong></p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://www.scienjus.com/api-gateway-and-netflix-zuul/" target="_blank" rel="external">聊聊 API Gateway 和 Netflix Zuul
</a></li>
<li><a href="http://tech.lede.com/2017/05/16/rd/server/SpringCloudZuul/" target="_blank" rel="external">Spring Cloud技术分析（4）- spring cloud zuul
</a></li>
<li><a href="http://cloud.spring.io/spring-cloud-static/spring-cloud-netflix/1.3.5.RELEASE/single/spring-cloud-netflix.html#_router_and_filter_zuul" target="_blank" rel="external">netflix-zuul</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/11/13/gateway/" data-id="cja25cxii000vff6qycev5aqw" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-apm1" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/10/apm1/">几种分布式调用链监控组件的实践与比较（一）实践</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/10/apm1/">
            <time datetime="2017-11-09T16:00:00.000Z" itemprop="datePublished">2017-11-10</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Ops/">Ops</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/APM/">APM</a>, <a class="tag-link" href="/tags/micro-service/">micro-service</a>, <a class="tag-link" href="/tags/zipkin/">zipkin</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>引言：最近在调研与选型分布式调用链监控组件。选了主要的三种APM组件进行了实践与比较。本来打算一篇文章写完的，篇幅太长，打算分两篇。本文主要讲下链路traceing的基本概念和几种APM组件的实践，实践部分也没给出特别详细的步骤，因为本文重点不在具体的步骤。第二篇将会讲下几种APM选型的比较与性能测试。</p>
<h2 id="1-问题背景"><a href="#1-问题背景" class="headerlink" title="1. 问题背景"></a>1. 问题背景</h2><p>微服务架构下，服务按照不同的维度进行拆分，一次请求请求往往需要涉及到多个服务。互联网应用构建在不同的软件模块集上，这些软件模块，有可能是由不同的团队开发、可能使用不同的编程语言来实现、有可能布在了几千台服务器，横跨多个不同的数据中心。因此，就需要一些可以帮助理解系统行为、用于分析性能问题的工具，以便发生故障的时候，能够快速定位和解决问题。</p>
<p>分布式调用链监控组件在这样的环境下产生了。最出名的是谷歌公开的论文提到的<code>Dapper</code>。开发Dapper是为了收集更多的复杂分布式系统的行为信息，然后呈现给Google的开发者们。这样的分布式系统有一个特殊的好处，因为那些大规模的低端服务器，作为互联网服务的载体，是一个特殊的经济划算的平台。想要在这个上下文中理解分布式系统的行为，就需要监控那些横跨了不同的应用、不同的服务器之间的关联动作。</p>
<p>市面上的APM（Application Performance Management）理论模型大多都是借鉴（borrow）<code>Google Dapper</code>论文，本文重点关注以下几种APM组件：</p>
<ul>
<li>Zipkin<br>  由Twitter公司开源，开放源代码分布式的跟踪系统，用于收集服务的定时数据，以解决微服务架构中的延迟问题，包括数据的收集、存储、查找和展现。</li>
<li>Pinpoint<br>Pinpoint是一款对Java编写的大规模分布式系统的APM工具，由韩国人开源的分布式跟踪组件。</li>
<li>Skywalking<br>国产的优秀APM组件，是一个对JAVA分布式应用程序集群的业务运行情况进行追踪、告警和分析的系统。</li>
</ul>
<p>其他类似的组件还有美团点评的CAT，淘宝的鹰眼EgleEye。</p>
<p>如上所述，那么我们选择链路监控组件有哪些要求呢？Dapper中也提到了，笔者总结如下：</p>
<ul>
<li><p>探针的性能消耗。<br>APM组件服务的影响应该做到足够小。在一些高度优化过的服务，即使一点点损耗也会很容易察觉到，而且有可能迫使在线服务的部署团队不得不将跟踪系统关停。</p>
</li>
<li><p>代码的侵入性<br>对于应用的程序员来说，是不需要知道有跟踪系统这回事的。如果一个跟踪系统想生效，就必须需要依赖应用的开发者主动配合，那么这个跟踪系统也太脆弱了，往往由于跟踪系统在应用中植入代码的bug或疏忽导致应用出问题，这样才是无法满足对跟踪系统“无所不在的部署”这个需求。</p>
</li>
<li><p>可扩展性<br>能够支持的组件越多当然越好。或者提供便捷的插件开发API，对于一些没有监控到的组件，应用开发者也可以自行扩展。</p>
</li>
<li><p>数据的分析<br>数据的分析要快 ，分析的维度尽可能多。跟踪系统能提供足够快的信息反馈，就可以对生产环境下的异常状况做出快速反应。分析的全面，能够避免二次开发。</p>
</li>
</ul>
<h2 id="2-基础概念"><a href="#2-基础概念" class="headerlink" title="2. 基础概念"></a>2. 基础概念</h2><p>上面列出的几种组件，其中Zipkin是严格按照<code>Google Dapper</code>论文实现的，下面介绍下其中涉及的基本概念。</p>
<ul>
<li><p>Span<br>基本工作单元，一次链路调用(可以是RPC，DB等没有特定的限制)创建一个span，通过一个64位ID标识它，uuid较为方便，span中还有其他的数据，例如描述信息，时间戳，key-value对的(Annotation)tag信息，parent-id等,其中parent-id可以表示span调用链路来源。</p>
</li>
<li><p>Trace:类似于树结构的Span集合，表示一条调用链路，存在唯一标识。比如你运行的分布式大数据存储一次Trace就由你的一次请求组成。</p>
</li>
<li><p>Annotation: 注解,用来记录请求特定事件相关信息(例如时间)，通常包含四个注解信息：<br>  (1) cs：Client Start,表示客户端发起请求</p>
<p> (2) sr：Server Receive,表示服务端收到请求</p>
<p> (3) ss：Server Send,表示服务端完成处理，并将结果发送给客户端</p>
<p> (4) cr：Client Received,表示客户端获取到服务端返回信息</p>
</li>
</ul>
<h3 id="2-1-Trace"><a href="#2-1-Trace" class="headerlink" title="2.1 Trace"></a>2.1 Trace</h3><p>下面看一下，在系统中Trace是什么样子。 </p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/trace-id.png" alt="trace" title="trace"></p>
<p>每种颜色的note标注了一个span，一条链路通过TraceId唯一标识，Span标识发起的请求信息。树节点是整个架构的基本单元，而每一个节点又是对span的引用。节点之间的连线表示的span和它的父span直接的关系。虽然span在日志文件中只是简单的代表span的开始和结束时间，他们在整个树形结构中却是相对独立的。</p>
<h3 id="2-2-Span"><a href="#2-2-Span" class="headerlink" title="2.2 Span"></a>2.2 Span</h3><p><img src="http://ovcjgn2x0.bkt.clouddn.com/span.png" alt="sp" title="span"></p>
<p>上图说明了span在一次大的跟踪过程中是什么样的。Dapper记录了span名称，以及每个span的ID和父ID，以重建在一次追踪过程中不同span之间的关系。如果一个span没有父ID被称为root span。所有span都挂在一个特定的跟踪上，也共用一个跟踪id。</p>
<h3 id="2-3-Annotation"><a href="#2-3-Annotation" class="headerlink" title="2.3 Annotation"></a>2.3 Annotation</h3><p>自动的探针，不需要修改应用程序源代码，对应用开发者近乎零浸入的成本对分布式控制路径进行跟踪，几乎完全依赖于基于少量通用组件库的改造。Dapper还允许应用程序开发人员在Dapper跟踪的过程中添加额外的信息，以监控更高级别的系统行为，或帮助调试问题。</p>
<p>下面章节将会介绍下上述三种APM组件的使用与实践。</p>
<h2 id="3-zipkin"><a href="#3-zipkin" class="headerlink" title="3. zipkin"></a>3. zipkin</h2><p>zipkin主要涉及几个组件：<code>collector</code>收集agent的数据，<code>storage</code>存储，<code>web UI</code>图形化界面，<code>search</code>查询Storage中存储的数据,提供简单的JSON API获取数据。<br><img src="http://ovcjgn2x0.bkt.clouddn.com/architecture-1.png" alt="" title="zipkin组件"> </p>
<p>我们的项目基于微服务框架spring cloud构建微服务。spring cloud也提供了spring-cloud-sleuth来方便集成zipkin实现。所以笔者就在项目中试了下spring-cloud-sleuth-zipkin。</p>
<p>起了三个服务：<br>zipkin-server、zipkin-client-backend、zipkin-client。<br>其中server服务负责收集以及信息展示。client-backend调用client，产生调用链路信息。</p>
<h3 id="3-1-zipkin-server实现"><a href="#3-1-zipkin-server实现" class="headerlink" title="3.1 zipkin-server实现"></a>3.1 zipkin-server实现</h3><p>zipkin-server实现主要有两点需要注意，其一是收集到数据的存储，方式包括内存、数据库、ES等；其二是通信方式，包括http通信和mq异步方式通信，http通信会对正常的访问造成影响，所以还是推荐基于mq异步方式通信。</p>
<p>本文使用mysql作为存储，使用MQ通信，MQ通信基于Spring-cloud-Stream。本文重点不在zipkin-server的具体几种实现方式，其他方式，读者可以自己去官网查看。</p>
<p>（1）pom需要添加的引用如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!--zipkin依赖--&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-sleuth-zipkin-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.zipkin.java<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zipkin-autoconfigure-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!--保存到数据库需要如下依赖--&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>（2）启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 使用Stream方式启动ZipkinServer</span></div><div class="line"><span class="meta">@EnableZipkinStreamServer</span></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipkinStreamServerApplication</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        SpringApplication.run(ZipkinStreamServerApplication.class,args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@EnableZipkinStreamServer</code>注解引入了<code>@EnableZipkinServer</code>注解，同时还创建了一个rabbit-mq的SleuthSink消息队列监听器。</p>
<p>（3）配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9411</span></div><div class="line"></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  datasource:</span></div><div class="line"><span class="attr">    username:</span> <span class="string">root</span></div><div class="line"><span class="attr">    password:</span> <span class="string">root123</span></div><div class="line">    <span class="string">schema[0]:</span> <span class="attr">classpath:/zipkin.sql</span></div><div class="line"></div><div class="line"><span class="attr">zipkin:</span></div><div class="line"><span class="attr">  storage:</span></div><div class="line"><span class="attr">    type:</span> <span class="string">mysql</span></div><div class="line"></div><div class="line"><span class="meta">---</span></div><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">microservice-zipkin-stream-server</span></div><div class="line"><span class="attr">  rabbitmq:</span></div><div class="line"><span class="attr">    host:</span> <span class="string">$&#123;RABBIT_ADDR:localhost&#125;</span></div><div class="line"><span class="attr">    port:</span> <span class="string">$&#123;RABBIT_PORT:5672&#125;</span></div><div class="line"><span class="attr">    username:</span> <span class="string">guest</span></div><div class="line"><span class="attr">    password:</span> <span class="string">guest</span></div><div class="line"><span class="attr">  sleuth:</span></div><div class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  profiles:</span> <span class="string">default</span></div><div class="line"><span class="attr">  datasource:</span></div><div class="line"><span class="attr">    url:</span>  <span class="attr">jdbc:mysql://localhost:3307/zipkin?autoReconnect=true&amp;useSSL=false</span></div></pre></td></tr></table></figure>
<p>zipkin.sql可以去官网获取，设置了zipkin-server的端口号为9411。</p>
<h3 id="3-2-zipkin-client"><a href="#3-2-zipkin-client" class="headerlink" title="3.2 zipkin-client"></a>3.2 zipkin-client</h3><p>两个zipkin-client的配置一样，所以放在一起。</p>
<p>（1）pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-sleuth-zipkin-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"></div><div class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>(2) 配置文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  rabbitmq:</span></div><div class="line"><span class="attr">    host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line">    <span class="string">port</span> <span class="string">:</span> <span class="number">5672</span></div><div class="line"><span class="attr">    username:</span> <span class="string">guest</span></div><div class="line"><span class="attr">    password:</span> <span class="string">guest</span></div></pre></td></tr></table></figure>
<h3 id="3-3-结果"><a href="#3-3-结果" class="headerlink" title="3.3 结果"></a>3.3 结果</h3><p>服务之间的调用关系如下：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/zipdependency1.jpg" alt="" title="zipdependency.jpg"></p>
<p>可以看到客户端的请求经过gateway，调用内网中的各个服务，部分还涉及到调用notice服务。从图中可以清楚的看出客户端请求所经过的服务。<br>下面看下demo2-default服务实例中的http path：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/zipkintrace.jpg" alt="" title="zipkintrace"></p>
<p>上图中demo2-default服务的几个http path按照时长排序，显示了trace调用时长和span数量。点进去可以看到：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/trace-demo2.jpg" alt="" title="demo2"></p>
<p>图中列出了从父span开始，每一个span的耗时。本次trace中，涉及到两个服务demo1和demo2。demo2调用demo1，从597ms开始调用demo1，完成最终的请求总共耗时1265ms。</p>
<h2 id="4-pinpoint"><a href="#4-pinpoint" class="headerlink" title="4. pinpoint"></a>4. pinpoint</h2><p>对代码零侵入，运用JavaAgent字节码增强技术，只需要加启动参数即可。<br>pinpoint的几个组件部分和zipkin差不多，架构图如下：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/pinpoint-architecture.png" alt="" title="pinpoint"></p>
<p>Pinpoint-Collector收集各种性能数据、Pinpoint-Agent和自己运行的应用关联起来的探针、Pinpoint-Web将收集到的数据显示成WEB网页形式、HBase Storage收集到的数据存到HBase中。</p>
<h3 id="4-1-pinpoint安装"><a href="#4-1-pinpoint安装" class="headerlink" title="4.1 pinpoint安装"></a>4.1 pinpoint安装</h3><p>主要涉及以下软件的安装：</p>
<ul>
<li><p>jdk 1.8<br>Java环境必须的，没啥好解释。</p>
</li>
<li><p>Hbase<br>pinpoint收集来的测试数据，主要是存在Hbase数据库的。所以它可以收集大量的数据，可以进行更加详细的分析。Hbase安装完成后，需要初始化Hbase的pinpoint库，由pinpoint提供。Hbase内置了zookeeper。</p>
</li>
<li><p>pinpoint-collector<br>collector收集agent的数据，将数据存到hbase集群，对外暴露collector的tcp和udp的监听端口9994，9995，9996。</p>
</li>
<li><p>pinpoint-web<br>页面展示，配置文件中设置环境变量HBASE_HOST、HBASE_PORT等。</p>
</li>
<li><p>pinpoint-agent</p>
</li>
</ul>
<p>到<a href="https://github.com/naver/pinpoint/wiki" target="_blank" rel="external">官网</a>release页面下载pinpoint-agent-x-SNAPSHOT.tar.gz，配置pinpoint.config中相关collector的信息。</p>
<p><strong>安装确实还比较麻烦，本文篇幅太长了，具体步骤后面再单独写文章讲解。</strong></p>
<h3 id="4-2-运行pinpoint-agent"><a href="#4-2-运行pinpoint-agent" class="headerlink" title="4.2 运行pinpoint-agent"></a>4.2 运行pinpoint-agent</h3><p>笔者使用的是spring-boot项目，所以只需要在启动jar包的命令中加入-javaagent参数，并指定pinpoint-bootstrap包的绝对路径。实例代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -javaagent:/aoho/auth_compose/pinpoint-bootstrap-1.6.0.jar -Dpinpoint.agentId=aoho-consumer -Dpinpoint.applicationName=aoho-consumer -jar id_generator/snowflake-id-generate-1.0-SNAPSHOT.jar</div></pre></td></tr></table></figure>
<p>起的id生成器服务比较简单，没有用到数据库等存储介质。服务注册到consul上，本地客户端请求了id-server获取id。其调用链如下：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/Jietu20171106-215536.jpg" alt="call tree" title="pinpoint 调用链"></p>
<p>pinpoint提供的功能比较丰富，下图是调用/api/id接口的详细信息。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/Jietu20171106-215606.jpg" alt="api" title="接口信息"></p>
<p>可以看到，pinpoint记录了客户端的相应时间、IP地址等，调用树在下面也有详细列出，每个方法的耗时等。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/Jietu20171106-215642.jpg" alt="serverMap" title="serverMap"></p>
<p>serverMap中还展示了服务器的堆、永久代、CPU等信息，非常强大。</p>
<h2 id="5-Skywalking"><a href="#5-Skywalking" class="headerlink" title="5. Skywalking"></a>5. Skywalking</h2><p>Skywalking是国内开源的APM监控组件，官网<a href="https://github.com/OpenSkywalking/" target="_blank" rel="external">OpenSkywalking</a>，根据官网介绍，其着力于性能和实时性两方面。<br>网上找到的Skywalking的架构图。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/skyarche.png" alt=""></p>
<p>可以看到Skywalking也是四部分组成，collector、agent、web、storage。支持集群部署，集群之间还引入了grpc通信。存储支持内置的h2和elasticsearch存储。</p>
<h3 id="5-1-安装"><a href="#5-1-安装" class="headerlink" title="5.1 安装"></a>5.1 安装</h3><p>具体安装可见<a href="https://github.com/OpenSkywalking/skywalking/wiki/3.2.3-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2Collector" target="_blank" rel="external">官网</a>。</p>
<ul>
<li>collector安装<br>此处笔者使用单机版的collector，在release页面下载好压缩包，解压后，单机版的collector默认使用h2数据库，所以配置文件可以不需要修改，即可以运行<code>bin/startup.sh</code>。 </li>
</ul>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/collectorsky.jpg" alt=""></p>
<p>目录结构如上，logs文件夹中，有启动的日志，可以查看启动情况。</p>
<ul>
<li><p>web<br>解压好skywalking-ui，设置server的config/collector_config.properties、log4j2以及监听端口等相关信息，</p>
</li>
<li><p>agent<br>拷贝skywalking-agent目录到所需位置，探针包含整个目录，设置/config/agent.config中的collector信息。</p>
</li>
</ul>
<h3 id="5-2-运行agent"><a href="#5-2-运行agent" class="headerlink" title="5.2 运行agent"></a>5.2 运行agent</h3><p>Spring boot的项目，启动和上面pinpoint agent启动方式相同。增加JVM启动参数，<code>-javaagent:/path/to/skywalking-agent/skywalking-agent.jar</code>。</p>
<p>这次起了user服务，涉及到mysql、redis、consul等组件。可以看到其调用链路图如下：</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/skydependency.jpg" alt=""></p>
<p>当访问<code>/api/external/register-code</code>和<code>/api/external/validate-code</code>接口时，形成了上图中的调用链。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/skytree1.jpg" alt=""></p>
<p>上图TraceId为    2.59.15103021777910001的请求<code>/api/external/register-code</code>。这次trace中，每个涉及的span的耗时都有在图中统计。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/serversky.jpg" alt=""></p>
<p>上面这张图，是对userService中的Entry Service List接口进行了统计，包括调用数、成功率等信息。（因为内置的h2，这边在UI响应很久）</p>
<p>还有个对instance的统计，统计jvm的相关信息，API响应也很慢，可能与我用的存储有关吧，就不截图了。</p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>本文主要写了链路监控组件的实践。首先介绍了链路监控组件产生与应用的背景，以及选择的要求；其次介绍了opentracing中涉及的基本概念；最后大篇幅介绍了三种APM组件的安装与使用，并展示了每种APM的UI截图。本文比较简单，下一篇文章主要介绍几种APM选型的比较与性能测试。</p>
<p><strong>zipkin-server-stream的源码<br>github:  <a href="https://github.com/keets2012/Spring-Boot-Samples/" target="_blank" rel="external">https://github.com/keets2012/Spring-Boot-Samples/</a><br>oschina:  <a href="https://gitee.com/keets/spring-boot-samples" target="_blank" rel="external">https://gitee.com/keets/spring-boot-samples</a></strong></p>
<hr>
<h3 id="参考-疯狂找资料"><a href="#参考-疯狂找资料" class="headerlink" title="参考(疯狂找资料)"></a>参考(疯狂找资料)</h3><ol>
<li><a href="https://github.com/opentracing-contrib/opentracing-specification-zh" target="_blank" rel="external">OpenTracing官方标准-中文版</a></li>
<li><a href="https://github.com/wu-sheng/sky-walking" target="_blank" rel="external">Skywalking</a></li>
<li><a href="http://zipkin.io/" target="_blank" rel="external">Zipkin</a></li>
<li><a href="https://github.com/naver/pinpoint" target="_blank" rel="external">PinPoint</a></li>
<li><a href="http://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/1.2.5.RELEASE/single/spring-cloud-sleuth.html#" target="_blank" rel="external">Spring Cloud Sleuth</a></li>
<li><a href="http://bigbully.github.io/Dapper-translation/" target="_blank" rel="external">Dapper</a></li>
<li><a href="http://www.cnblogs.com/yyhh/p/6106472.html" target="_blank" rel="external">pinpoint 安装部署</a></li>
<li><a href="https://segmentfault.com/a/1190000006817114" target="_blank" rel="external">java开源APM概要</a></li>
<li><a href="http://blog.csdn.net/john1337/article/details/71127056" target="_blank" rel="external">分布式系统监控系统zipkin入门</a></li>
<li><a href="http://www.jianshu.com/p/17a015848dc1" target="_blank" rel="external">跟着小程学微服务-自己动手扩展分布式调用链</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/11/10/apm1/" data-id="cja25cxi6000eff6qpsz6lifa" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-dockermaven" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/2017/11/02/dockermaven/">微服务部署之Maven插件构建Docker镜像</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2017/11/02/dockermaven/">
            <time datetime="2017-11-01T16:00:00.000Z" itemprop="datePublished">2017-11-02</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Ops/">Ops</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Docker/">Docker</a>, <a class="tag-link" href="/tags/Ops/">Ops</a>, <a class="tag-link" href="/tags/Spring-Cloud/">Spring Cloud</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h2><p>微服务架构下，微服务在带来良好的设计和架构理念的同时，也带来了运维上的额外复杂性，尤其是在服务部署和服务监控上。单体应用是集中式的，就一个单体跑在一起，部署和管理的时候非常简单，而微服务是一个网状分布的，有很多服务需要维护和管理，对它进行部署和维护的时候则比较复杂。  </p>
<p>下面从Dev的角度来看一下Ops的工作。从Dev提交代码，到完成集成测试的一系列步骤如下：</p>
<ul>
<li>首先是开发人员把程序代码更新后上传到Git，然后其他的事情都将由Jenkins自动完成。</li>
<li>然后Git在接收到用户更新的代码后，会把消息和任务传递给Jenkins，然后Jenkins会自动构建一个任务，下载Maven相关的软件包。下载完成后，就开始利用Maven Build新的项目包，然后重建Maven容器，构建新的Image并Push到Docker私有库中。</li>
<li>最后删除正在运行的Docker容器，再基于新的镜像重新把Docker容器启动，自动完成集成测试。</li>
</ul>
<p>整个过程都是自动的，这样就简化了原本复杂的集成工作，一天可以集成一次，甚至是多次。</p>
<p><img src="http://img.blog.csdn.net/20160830130543156" alt="Ops" title="DevOps流程图"></p>
<p>本文主要关注的第二步，作为Dev使用Maven插件构建Docker镜像。</p>
<h2 id="2-过程步骤"><a href="#2-过程步骤" class="headerlink" title="2. 过程步骤"></a>2. 过程步骤</h2><h3 id="2-1-环境"><a href="#2-1-环境" class="headerlink" title="2.1 环境"></a>2.1 环境</h3><p>笔者的电脑系统是MacOS，在进行下面的步骤之前，先具备一下条件：</p>
<ul>
<li>Docker Registry</li>
<li>Maven（3.5.0）</li>
<li>JDK(1.8.0_131)</li>
<li>Docker for Mac (17.09.0-ce-mac35)</li>
</ul>
<p>Maven 和JDK 就不用过多多了，必须具有的。Docker Registry是私有的hub，mac上装好docker之后，配置一下Docker Registry的地址，配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"debug"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="attr">"experimental"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="attr">"insecure-registries"</span> : [</div><div class="line">    <span class="string">"192.168.1.202"</span></div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/docker%20%E9%85%8D%E7%BD%AE.jpg" alt="config" title="docker 配置"></p>
<p>配置好registry地址之后，本地pull镜像，还需要命令行login到registry：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker login 192.168.1.202 --username admin --password 123456</div></pre></td></tr></table></figure>
<h3 id="2-2-pom文件"><a href="#2-2-pom文件" class="headerlink" title="2.2 pom文件"></a>2.2 pom文件</h3><p>pom文件中需要引入相应的插件。docker-maven-plugin有三款：spotify、fabric8io和bibryam。其中第一款最为流行，资料也多，所以毫不犹豫选择第一款。<br>插件有两种使用方式，一种是在直接在pom配置中指定baseImage和entryPoint。另一种适合于复杂的构建，使用dockerfile，只需要在配置中指定dockerfile的位置。前一种比较简单，此处略过，主要讲下第二种的配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.spotify<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>docker-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;maven.docker.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">             <span class="comment">&lt;!--插件绑定到phase--&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">executions</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">execution</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">phase</span>&gt;</span>install<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">goals</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">goal</span>&gt;</span>build<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></div><div class="line">             <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></div><div class="line">             <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">             <span class="comment">&lt;!--配置变量，包括是否build、imageName、imageTag，非常灵活--&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">skipDocker</span>&gt;</span>$&#123;docker.skip.build&#125;<span class="tag">&lt;/<span class="name">skipDocker</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">imageName</span>&gt;</span>$&#123;docker.image.prefix&#125;/$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">imageName</span>&gt;</span></div><div class="line">                 <span class="comment">&lt;!--最后镜像产生了两个tag，版本和和最新的--&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">imageTags</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">imageTag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">imageTag</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">imageTag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">imageTag</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;/<span class="name">imageTags</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">forceTags</span>&gt;</span>true<span class="tag">&lt;/<span class="name">forceTags</span>&gt;</span>                 </div><div class="line">                 <span class="tag">&lt;<span class="name">env</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">TZ</span>&gt;</span>Asia/Shanghai<span class="tag">&lt;/<span class="name">TZ</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;/<span class="name">env</span>&gt;</span></div><div class="line">                 <span class="comment">&lt;!--时区配置--&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">runs</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">run</span>&gt;</span>ln -snf /usr/share/zoneinfo/$TZ /etc/localtime<span class="tag">&lt;/<span class="name">run</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">run</span>&gt;</span>echo $TZ &gt; /etc/timezone<span class="tag">&lt;/<span class="name">run</span>&gt;</span>                      </div><div class="line">                 <span class="tag">&lt;/<span class="name">runs</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">dockerDirectory</span>&gt;</span>$&#123;project.basedir&#125;<span class="tag">&lt;/<span class="name">dockerDirectory</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>/<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.build.directory&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></div><div class="line">                         <span class="tag">&lt;<span class="name">include</span>&gt;</span>$&#123;project.build.finalName&#125;.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">                 <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div><div class="line">                 <span class="comment">&lt;!--push到私有的hub--&gt;</span></div><div class="line">                 <span class="tag">&lt;<span class="name">serverId</span>&gt;</span>docker-registry<span class="tag">&lt;/<span class="name">serverId</span>&gt;</span></div><div class="line">             <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div></pre></td></tr></table></figure>
<p>${maven.docker.version}、${docker.skip.build}、${docker.image.prefix}都是可配置的变量。${project.basedir}、${project.build.directory}、${project.build.finalName}、${project.version}分别对应项目根目录、构建目录、打包后生成的结果名称、项目版本号。<br>上面的pom插件配置，指定了dockerfile的位置和镜像的命名规则。并将docker的build目标，绑定在install这个phase上。</p>
<h3 id="2-3-dockerfile"><a href="#2-3-dockerfile" class="headerlink" title="2.3 dockerfile"></a>2.3 dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">FROM 192.168.1.202/library/basejava</div><div class="line">VOLUME /tmp</div><div class="line">ADD ./target/cloud-api-gateway-1.2.0.RELEASE.jar app.jar</div><div class="line">RUN bash -c <span class="string">'touch /app.jar'</span></div><div class="line">ENTRYPOINT [<span class="string">"java"</span>,<span class="string">"-Djava.security.egd=file:/dev/./urandom"</span>,<span class="string">"-jar"</span>,<span class="string">"/app.jar"</span>]</div></pre></td></tr></table></figure>
<p>dockerfile 写的很简单，将jar包ADD进去，提供ENTRYPOINT。</p>
<h3 id="2-4-setting-xml"><a href="#2-4-setting-xml" class="headerlink" title="2.4 setting.xml"></a>2.4 setting.xml</h3><p>在pom插件中，还有一个serverId的配置。这个配置是必要的，对于需要将image上传到私有hub上，在如上配置之后，只需要加上<code>-DpushImage</code>即可实现。serverId是与maven的配置文件setting.xml相对应，setting.xml中增加的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>docker-registry<span class="tag">&lt;/<span class="name">id</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">username</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">password</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">password</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">email</span>&gt;</span>邮箱<span class="tag">&lt;/<span class="name">email</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="2-5-结果"><a href="#2-5-结果" class="headerlink" title="2.5 结果"></a>2.5 结果</h3><p><img src="http://ovcjgn2x0.bkt.clouddn.com/resultdocker.jpg" alt="res" title="执行结果"></p>
<p>上图是执行<code>mvn clean install -DpushImage</code>成功的结果。mvn首先是打包，将生产的文件拷贝到target下的docker目录，然后执行dockerfile中的步骤，将打成的镜像进行tag，最后上传到私有hub上。</p>
<p><img src="http://ovcjgn2x0.bkt.clouddn.com/harbor.jpg" alt="har" title="成功上传镜像"></p>
<p>上图是VMware Harbor中的截图，可以看到，我们已经成功将镜像上传，其tag有两个：1.2.0.RELEASE和latest。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h2><p>本文属于工程实践类文章，比较简单。开头由背景介绍了Dev到继承测试的一系列步骤，本文主要关注的是第二步，作为Dev使用Maven插件构建Docker镜像。正文部分主要讲了实践的环境，然后讲了docker-maven-plugin插件的使用方式，重点介绍了使用dockerfile的方式，对于涉及到的配置进行了解释。</p>
<p><strong>本文的源码地址：<br>GitHub：<a href="https://github.com/keets2012/snowflake-id-generator" target="_blank" rel="external">https://github.com/keets2012/snowflake-id-generator</a><br>码云： <a href="https://gitee.com/keets/snowflake-id-generator" target="_blank" rel="external">https://gitee.com/keets/snowflake-id-generator</a></strong></p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="http://geek.csdn.net/news/detail/98271" target="_blank" rel="external">从运维的角度看微服务和容器</a></li>
<li><a href="http://blog.csdn.net/qq_22841811/article/details/67369530#reply" target="_blank" rel="external">Docker与微服务-使用Maven插件构建Docker镜像</a></li>
</ol>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blueskykong.com/2017/11/02/dockermaven/" data-id="cja25cxib000jff6qzlmm6upe" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <nav id="page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/14/aop/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/java/">java</a></p>
                            <p class="item-title"><a href="/2017/12/14/aop/" class="title">深入理解Spring AOP的动态代理</a></p>
                            <p class="item-date"><time datetime="2017-12-13T16:00:00.000Z" itemprop="datePublished">2017-12-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/10/integration/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/微服务/">微服务</a></p>
                            <p class="item-title"><a href="/2017/12/10/integration/" class="title">微服务架构中整合网关、权限服务</a></p>
                            <p class="item-date"><time datetime="2017-12-09T16:00:00.000Z" itemprop="datePublished">2017-12-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/12/05/apm2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Ops/">Ops</a></p>
                            <p class="item-title"><a href="/2017/12/05/apm2/" class="title">几种分布式调用链监控组件的实践与比较（二）比较</a></p>
                            <p class="item-date"><time datetime="2017-12-04T16:00:00.000Z" itemprop="datePublished">2017-12-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/11/20/config-server1/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/微服务/">微服务</a></p>
                            <p class="item-title"><a href="/2017/11/20/config-server1/" class="title">微服务之分布式配置中心Cloud Config</a></p>
                            <p class="item-date"><time datetime="2017-11-19T16:00:00.000Z" itemprop="datePublished">2017-11-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/11/18/first-timeout/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/微服务/">微服务</a></p>
                            <p class="item-title"><a href="/2017/11/18/first-timeout/" class="title">Spring Cloud 服务第一次请求超时的优化</a></p>
                            <p class="item-date"><time datetime="2017-11-17T16:00:00.000Z" itemprop="datePublished">2017-11-18</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Note/">Note</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Ops/">Ops</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Utils/">Utils</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/中间件/">中间件</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">4</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/AOP/" style="font-size: 10px;">AOP</a> <a href="/tags/APM/" style="font-size: 12.5px;">APM</a> <a href="/tags/Cluster/" style="font-size: 15px;">Cluster</a> <a href="/tags/Consensus/" style="font-size: 10px;">Consensus</a> <a href="/tags/Docker/" style="font-size: 12.5px;">Docker</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/HTTP2/" style="font-size: 12.5px;">HTTP2</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Jersey/" style="font-size: 12.5px;">Jersey</a> <a href="/tags/Lombok/" style="font-size: 10px;">Lombok</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/OAuth2/" style="font-size: 20px;">OAuth2</a> <a href="/tags/Ops/" style="font-size: 12.5px;">Ops</a> <a href="/tags/REST/" style="font-size: 12.5px;">REST</a> <a href="/tags/Ribbon/" style="font-size: 10px;">Ribbon</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/Spring-Cloud/" style="font-size: 17.5px;">Spring Cloud</a> <a href="/tags/Spring-Security/" style="font-size: 20px;">Spring Security</a> <a href="/tags/Thread/" style="font-size: 10px;">Thread</a> <a href="/tags/cluster/" style="font-size: 10px;">cluster</a> <a href="/tags/consul/" style="font-size: 12.5px;">consul</a> <a href="/tags/gateway/" style="font-size: 12.5px;">gateway</a> <a href="/tags/java/" style="font-size: 12.5px;">java</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/micro-service/" style="font-size: 12.5px;">micro-service</a> <a href="/tags/mq/" style="font-size: 12.5px;">mq</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/snowflake/" style="font-size: 10px;">snowflake</a> <a href="/tags/spring-boot/" style="font-size: 10px;">spring boot</a> <a href="/tags/starter/" style="font-size: 10px;">starter</a> <a href="/tags/swagger/" style="font-size: 10px;">swagger</a> <a href="/tags/utils/" style="font-size: 10px;">utils</a> <a href="/tags/zipkin/" style="font-size: 12.5px;">zipkin</a> <a href="/tags/zuul/" style="font-size: 12.5px;">zuul</a> <a href="/tags/设计模式/" style="font-size: 17.5px;">设计模式</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 aoho<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>